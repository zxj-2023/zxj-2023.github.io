<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-bounce.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="zxj Blogs">
<meta property="og:type" content="website">
<meta property="og:title" content="Zhang XiJun">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Zhang XiJun">
<meta property="og:description" content="zxj Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="å¼ ç†™æµš">
<meta property="article:tag" content="zxj">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zhang XiJun</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zhang XiJun</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">BLOGS</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="å¼ ç†™æµš"
      src="/images/zxjavatar.gif">
  <p class="site-author-name" itemprop="name">å¼ ç†™æµš</p>
  <div class="site-description" itemprop="description">zxj Blogs</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zxj-2023" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;zxj-2023" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://wpa.qq.com/msgrd?v=3&uin=2902065320&site=qq&menu=yes" title="QQ â†’ http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;2902065320&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener me" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          é“¾æ¥
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://zxj-2023.github.io/" title="https:&#x2F;&#x2F;zxj-2023.github.io" rel="noopener" target="_blank">Zhang XiJun</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://theme-next.js.org/" title="https:&#x2F;&#x2F;theme-next.js.org" rel="noopener" target="_blank">NexT</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/pgsql%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/pgsql%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/" class="post-title-link" itemprop="url">pgsqlå®ç°æŒä¹…åŒ–</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-06 09:50:53" itemprop="dateModified" datetime="2025-08-06T09:50:53+08:00">2025-08-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/agent%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">agentå®æˆ˜</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å¸¸ä½¿ç”¨pgsqlä¸redisé…åˆlanggraphçš„checkpointä¸storeè¿›è¡ŒæŒä¹…åŒ–å‚¨å­˜ï¼Œå®Œæˆé•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†çš„å®ç°</p>
<h3 id="pgsqlå®ç°æŒä¹…åŒ–"><a href="#pgsqlå®ç°æŒä¹…åŒ–" class="headerlink" title="pgsqlå®ç°æŒä¹…åŒ–"></a>pgsqlå®ç°æŒä¹…åŒ–</h3><h4 id="ä»€ä¹ˆæ˜¯pgsql"><a href="#ä»€ä¹ˆæ˜¯pgsql" class="headerlink" title="ä»€ä¹ˆæ˜¯pgsql"></a>ä»€ä¹ˆæ˜¯pgsql</h4><p>PostgreSQLï¼ˆå¸¸ç®€ç§°pgsqlæˆ–Postgresï¼‰æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¼€æºå¯¹è±¡-å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆORDBMSï¼‰ï¼Œä»¥å…¶ç¨³å®šæ€§ã€æ‰©å±•æ€§å’Œç¬¦åˆSQLæ ‡å‡†è‘—ç§°ã€‚</p>
<h4 id="dockeræ‹‰å–"><a href="#dockeræ‹‰å–" class="headerlink" title="dockeræ‹‰å–"></a>dockeræ‹‰å–</h4><p>docker-compose</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  postgres:</span><br><span class="line">    image: postgres:15        # æŒ‡å®šå…·ä½“ç‰ˆæœ¬</span><br><span class="line">    container_name: postgres_db</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_USER: postgres</span><br><span class="line">      POSTGRES_PASSWORD: postgres</span><br><span class="line">      POSTGRES_DB: postgres</span><br><span class="line">      TZ: Asia/Shanghai       # è®¾ç½®æ—¶åŒº</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5432:5432&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - pgdata:/var/lib/postgresql/data</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:             # å¥åº·æ£€æŸ¥</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;pg_isready&quot;, &quot;-U&quot;, &quot;nange&quot;]</span><br><span class="line">      interval: 10s</span><br><span class="line">      timeout: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">    command: [&quot;postgres&quot;, &quot;-c&quot;, &quot;max_connections=200&quot;]  # è‡ªå®šä¹‰é…ç½®</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  pgdata:</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Docker Compose</strong> æ˜¯ä¸€ä¸ª <strong>å®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨</strong> çš„ <strong>å£°æ˜å¼å·¥å…·</strong>ã€‚<br>å®ƒé€šè¿‡ä¸€ä¸ª <strong>YAML æ–‡ä»¶ï¼ˆé€šå¸¸å« <code>docker-compose.yml</code>ï¼‰</strong> æè¿°æ•´ä¸ªåº”ç”¨çš„æœåŠ¡ã€ç½‘ç»œã€å­˜å‚¨ç­‰é…ç½®ï¼Œç„¶åç”¨ä¸€æ¡å‘½ä»¤å³å¯ <strong>å¯åŠ¨/åœæ­¢/ç®¡ç†</strong> æ‰€æœ‰å®¹å™¨ï¼Œæ— éœ€æ‰‹åŠ¨é€ä¸ª <code>docker run</code>ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ‹‰å–å¹¶è¿è¡Œ</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<h4 id="åœ¨pgsqslå®‰è£…ä¾èµ–"><a href="#åœ¨pgsqslå®‰è£…ä¾èµ–" class="headerlink" title="åœ¨pgsqslå®‰è£…ä¾èµ–"></a>åœ¨pgsqslå®‰è£…ä¾èµ–</h4><p>å› ä¸ºLangGraphçš„PostgresStoreéœ€è¦ä½¿ç”¨åˆ°pgvectorï¼Œå› æ­¤éœ€è¦åœ¨å®¹å™¨ä¸­æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼Œç›´æ¥ä½¿ç”¨Docker Desktopè½¯ä»¶ä¸­è¿›è¡Œæ“ä½œ </p>
<blockquote>
<ul>
<li>ä¸ºä»€ä¹ˆéœ€è¦ <code>pgvector</code>ï¼Ÿ</li>
<li><code>PostgresStore</code> æ”¯æŒå°† <strong>å‘é‡åµŒå…¥ï¼ˆembeddingï¼‰</strong> å­˜å‚¨åœ¨ PostgreSQL ä¸­ï¼Œå¹¶åŸºäºå®ƒä»¬è¿›è¡Œ <strong>è¯­ä¹‰æœç´¢</strong>ã€‚</li>
<li>è¯¥åŠŸèƒ½ä¾èµ– <code>pgvector</code> æ‰©å±•æä¾›çš„ <code>vector</code> ç±»å‹å’Œç´¢å¼•æœºåˆ¶ï¼ˆå¦‚ HNSWï¼‰ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å®‰è£…ä¾èµ–           </span><br><span class="line">apt update    #åˆ·æ–°æœ¬åœ°è½¯ä»¶åŒ…ç´¢å¼•           </span><br><span class="line">apt install -y git build-essential postgresql-server-dev-15                          </span><br></pre></td></tr></table></figure>
<blockquote>
<p>apt install -y git build-essential postgresql-server-dev-15ä¸€æ¬¡æ€§å®‰è£… 3 ç±»ä¾èµ–ã€‚</p>
<ul>
<li><code>git</code> â€”â€” ç”¨æ¥å…‹éš† pgvector æºç ã€‚</li>
<li><code>build-essential</code> â€”â€” Debian/Ubuntu çš„â€œç¼–è¯‘å·¥å…·é“¾â€å…ƒåŒ…ï¼ŒåŒ…å« gccã€make ç­‰ã€‚</li>
<li><code>postgresql-server-dev-15</code> â€”â€” ä¸å½“å‰ Postgres <strong>ä¸»ç‰ˆæœ¬ä¸€è‡´</strong> çš„å¼€å‘å¤´æ–‡ä»¶å’Œ <code>pg_config</code>ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ç¼–è¯‘å¹¶å®‰è£… pgvector      </span><br><span class="line">#æŠŠ pgvector çš„ v0.7.0 ç¨³å®šç‰ˆ æºç å…‹éš†åˆ°æœ¬åœ°ç›®å½• ./pgvectorã€‚</span><br><span class="line">git clone --branch v0.7.0 https://github.com/pgvector/pgvector.git                </span><br><span class="line">cd pgvector  </span><br><span class="line">#è°ƒç”¨ Makefile æ ¹æ®å½“å‰æ“ä½œç³»ç»Ÿ + PostgreSQL ç‰ˆæœ¬ç¼–è¯‘å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ.so å…±äº«åº“ï¼‰ã€‚</span><br><span class="line">make          </span><br><span class="line">#æŠŠåˆšåˆšç¼–å¥½çš„ .so æ–‡ä»¶å’Œ .sql/.control æ–‡ä»¶å¤åˆ¶åˆ° PostgreSQL çš„æ‰©å±•ç›®å½•</span><br><span class="line">make install                </span><br><span class="line">éªŒè¯å®‰è£…ï¼Œæ£€æŸ¥æ‰©å±•æ–‡ä»¶æ˜¯å¦å®‰è£…æˆåŠŸ                    </span><br><span class="line">ls -l /usr/share/postgresql/15/extension/vector* </span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/pgvector/pgvector">pgvector/pgvector: Open-source vector similarity search for Postgres</a></p>
<p>æ¥ä¸‹æ¥ï¼Œè‹¥è¦åœ¨è„šæœ¬ä¸­è¿›è¡Œä½¿ç”¨ï¼Œé¦–å…ˆåœ¨ç³»ç»Ÿç¯å¢ƒä¸­éœ€è¦å®‰è£…PostgreSQL çš„å¼€å‘åº“ï¼ˆlibpqï¼‰ï¼Œå› ä¸º psycopg éœ€è¦å®ƒæ¥ç¼–è¯‘æˆ–è¿è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install libpq-dev postgresql-server-dev-all</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>psycopgï¼ˆPython æ“ä½œ PostgreSQL çš„åº“ï¼‰</strong> åœ¨ <strong>Linux/macOS</strong> ä¸Šè¿è¡Œæ—¶ï¼Œåº•å±‚ä¾èµ–äº <strong>PostgreSQL çš„ C è¯­è¨€å¼€å‘åº“ libpq</strong>ã€‚<br>å¦‚æœç³»ç»Ÿé‡Œ <strong>æ²¡æœ‰ libpq</strong>ï¼Œpsycopg ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§é—®é¢˜ï¼š</p>
<ol>
<li><p><strong>ç¼–è¯‘å®‰è£…å¤±è´¥</strong>ï¼ˆæºç /æ—§ç‰ˆæœ¬ï¼‰<br>å½“ <code>pip install psycopg2</code> éœ€è¦ç°åœºç¼–è¯‘æ—¶ï¼Œä¼šæ‰¾ä¸åˆ°å¤´æ–‡ä»¶ <code>libpq-fe.h</code> æˆ–åŠ¨æ€åº“ <code>libpq.so</code>ï¼Œå¯¼è‡´æŠ¥é”™ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: libpq-fe.h: No such file or directory</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¿è¡Œæ—¶å´©æºƒ</strong><br>å³ä½¿é€šè¿‡é¢„ç¼–è¯‘çš„ wheel åŒ…å®‰è£…æˆåŠŸï¼Œè¿è¡Œæ—¶ä¹Ÿå¯èƒ½æç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImportError: libpq.so.5: cannot open shared object file</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<p>æœ€åï¼Œå†å®‰è£…ç›¸å…³ä¾èµ–åŒ…  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install langgraph-checkpoint-postgres                    </span><br><span class="line">pip install psycopg psycopg-pool </span><br></pre></td></tr></table></figure>
<p>psycopgå®˜æ–¹ PostgreSQL é©±åŠ¨ï¼Œåœ¨ <code>psycopg</code> ä¹‹ä¸Šå†åŒ…ä¸€å±‚â€œ<strong>è¿æ¥æ± </strong>â€ï¼Œè®©å¹¶å‘è®¿é—®æ›´å¿«ã€æ›´ç¨³å®šã€‚</p>
<h4 id="è¿æ¥pgsql"><a href="#è¿æ¥pgsql" class="headerlink" title="è¿æ¥pgsql"></a>è¿æ¥pgsql</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.store.postgres import PostgresStore</span><br><span class="line">from langgraph.checkpoint.postgres import PostgresSaver</span><br><span class="line">from psycopg_pool import ConnectionPool</span><br><span class="line"># 1) è¿æ¥å­—ç¬¦ä¸²ï¼ˆURI è¯­æ³•ï¼‰</span><br><span class="line">DB_URI = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line">#   åè®®://      ç”¨æˆ·   : å¯†ç    @ ä¸»æœº:ç«¯å£ / æ•°æ®åº“å  ? é¢å¤–å‚æ•°</span><br><span class="line"></span><br><span class="line"># 2) è¿æ¥çº§å‚æ•°</span><br><span class="line">connection_kwargs = &#123;</span><br><span class="line">    &quot;autocommit&quot;: True,     # æ¯æ¡ SQL æ‰§è¡Œå®Œç«‹å³æäº¤ï¼Œæ— éœ€æ‰‹åŠ¨ commit</span><br><span class="line">    &quot;prepare_threshold&quot;: 0, # ç¦ç”¨æœåŠ¡å™¨ç«¯ prepared statementï¼Œå¯å‡å°‘ä¸€æ¬¡å¾€è¿”</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 3) åˆ›å»ºæ± </span><br><span class="line">connection_pool = ConnectionPool(</span><br><span class="line">    conninfo=DB_URI,</span><br><span class="line">    max_size=20,            # æœ€å¤š 20 æ¡ç‰©ç†è¿æ¥</span><br><span class="line">    kwargs=connection_kwargs,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 4) æ˜¾å¼æ‰“å¼€æ± ï¼ˆpsycopg 3 çš„ ConnectionPool é»˜è®¤æ‡’å¯åŠ¨ï¼Œè°ƒ open() ä¼šç«‹å³å»º min_size æ¡è¿æ¥ï¼‰</span><br><span class="line">connection_pool.open()</span><br><span class="line">print(&quot;æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ&quot;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ­£å¸¸æƒ…å†µæ¯æ¬¡ SQL éƒ½æ–°å»ºä¸€æ¡ TCP è¿æ¥ã€åš SSL æ¡æ‰‹ã€éªŒè¯å¯†ç ã€åˆ†é…å†…å­˜ï¼Œå¦‚æœä¸å¤ç”¨è¿æ¥ï¼Œè¿™äº›åŠ¨ä½œå°±è¦ <strong>æ¯æ¬¡éƒ½é‡æ–°æ¥ä¸€é</strong>ï¼Œ<strong>æˆæœ¬éå¸¸é«˜</strong>ã€‚</p>
<p>è¿æ¥æ± ï¼ˆConnection Poolï¼‰æ˜¯ä¸€ç§ <strong>æ•°æ®åº“è®¿é—®å±‚èµ„æºç®¡ç†ç»„ä»¶</strong>ï¼Œå…¶æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ <strong>é«˜å¹¶å‘ã€çŸ­äº‹åŠ¡</strong> åœºæ™¯ä¸‹ï¼Œé€šè¿‡ <strong>å¤ç”¨å·²å»ºç«‹çš„æ•°æ®åº“ç‰©ç†è¿æ¥</strong> æ¥é™ä½ç³»ç»Ÿæ•´ä½“å»¶è¿Ÿã€å‡å°‘èµ„æºæ¶ˆè€—ï¼Œå¹¶é˜²æ­¢æ•°æ®åº“å› ç¬æ—¶è¿æ¥é£æš´è€Œå´©æºƒã€‚</p>
</blockquote>
<h4 id="åˆå§‹åŒ–pgsql"><a href="#åˆå§‹åŒ–pgsql" class="headerlink" title="åˆå§‹åŒ–pgsql"></a>åˆå§‹åŒ–pgsql</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># åˆå§‹åŒ–PostgresStore</span><br><span class="line">in_postgres_store = PostgresStore(</span><br><span class="line">    pool,</span><br><span class="line">    index=&#123;</span><br><span class="line">        &quot;dims&quot;: 1536,</span><br><span class="line">        &quot;embed&quot;: embedding</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">in_postgres_store.setup()</span><br><span class="line"></span><br><span class="line">#åˆå§‹åŒ–checkpoint</span><br><span class="line"># ä½¿ç”¨ä¼ å…¥çš„è¿æ¥æ± åˆ›å»º PostgresSaver</span><br><span class="line">checkpointer = PostgresSaver(pool)</span><br><span class="line">checkpointer.setup()</span><br><span class="line"></span><br><span class="line">#æœ€åç¼–è¯‘æ—¶æ·»åŠ </span><br><span class="line">graph_builder.compile(checkpointer=checkpointer, store=in_postgres_store)</span><br></pre></td></tr></table></figure>
<p><code>in_postgres_store.setup()</code> çš„è§’è‰²ä¸€å¥è¯å°±èƒ½è¯´æ¸…ï¼š</p>
<blockquote>
<p><strong>æŠŠæ•°æ®åº“é‡Œæ‰€æœ‰ä¸ºäº†è®©å‘é‡å­˜å‚¨æ­£å¸¸å·¥ä½œçš„â€œä¸€æ¬¡æ€§åŸºå»ºâ€å…¨éƒ¨å»ºå¥½</strong>â€”â€”åªå»ºä¸€æ¬¡ï¼Œåé¢å†è·‘å°±ä¸ä¼šé‡å¤æ‰§è¡Œã€‚</p>
</blockquote>
<p>å…·ä½“è€Œè¨€ï¼Œå®ƒé€šå¸¸å¹²ä¸‹é¢ä¸‰ä»¶äº‹ï¼š1.<strong>å»ºè¡¨ / å»ºæ‰©å±•</strong>ï¼›2.<strong>å»ºå‘é‡ç´¢å¼•</strong>ï¼›3.<strong>å…ƒæ•°æ®åˆå§‹åŒ–</strong></p>
<h4 id="fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†"><a href="#fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†" class="headerlink" title="fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†"></a>fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># å®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°lifespanï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªFastAPIåº”ç”¨å®ä¾‹appä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªå‡½æ•°å°†ç®¡ç†åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¯åŠ¨å’Œå…³é—­æ—¶çš„æ“ä½œ</span><br><span class="line"># å‡½æ•°åœ¨åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¦‚åŠ è½½ä¸Šä¸‹æ–‡æ•°æ®ã€ä»¥åŠåˆå§‹åŒ–é—®é¢˜ç”Ÿæˆå™¨</span><br><span class="line"># å‡½æ•°åœ¨åº”ç”¨å…³é—­æ—¶æ‰§è¡Œä¸€äº›æ¸…ç†æ“ä½œ</span><br><span class="line"># @asynccontextmanager è£…é¥°å™¨ç”¨äºåˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒå…è®¸ä½ åœ¨ yield ä¹‹å‰å’Œä¹‹åæ‰§è¡Œç‰¹å®šçš„ä»£ç å—ï¼Œåˆ†åˆ«è¡¨ç¤ºå¯åŠ¨å’Œå…³é—­æ—¶çš„æ“ä½œ</span><br><span class="line">@asynccontextmanager</span><br><span class="line">async def lifespan(app: FastAPI):</span><br><span class="line">    # å¯åŠ¨æ—¶æ‰§è¡Œ</span><br><span class="line">    # ç”³æ˜å¼•ç”¨å…¨å±€å˜é‡ï¼Œåœ¨å‡½æ•°ä¸­è¢«åˆå§‹åŒ–ï¼Œå¹¶åœ¨æ•´ä¸ªåº”ç”¨ä¸­ä½¿ç”¨</span><br><span class="line">    global graph, connection_pool</span><br><span class="line">    # å¯åŠ¨æ—¶æ‰§è¡Œ</span><br><span class="line">    try:</span><br><span class="line">        logger.info(&quot;æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹ã€å®šä¹‰ Graph...&quot;)</span><br><span class="line">        # åˆå§‹åŒ– LLM</span><br><span class="line">        llm, embedding = get_llm(llm_type)</span><br><span class="line">        # åˆ›å»ºæ•°æ®åº“è¿æ¥æ± </span><br><span class="line">        DB_URI = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line">        connection_kwargs = &#123;</span><br><span class="line">            &quot;autocommit&quot;: True,</span><br><span class="line">            &quot;prepare_threshold&quot;: 0,</span><br><span class="line">        &#125;</span><br><span class="line">        connection_pool = ConnectionPool(</span><br><span class="line">            conninfo=DB_URI,</span><br><span class="line">            max_size=20,</span><br><span class="line">            kwargs=connection_kwargs,</span><br><span class="line">        )</span><br><span class="line">        connection_pool.open()  # æ˜¾å¼æ‰“å¼€è¿æ¥æ± </span><br><span class="line">        logger.info(&quot;æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ&quot;)</span><br><span class="line">        # çŸ­æœŸè®°å¿† åˆå§‹åŒ–checkpointer</span><br><span class="line">        checkpointer = PostgresSaver(connection_pool)</span><br><span class="line">        checkpointer.setup()</span><br><span class="line">        # é•¿æœŸè®°å¿† åˆå§‹åŒ–PostgresStore</span><br><span class="line">        in_postgres_store = PostgresStore(</span><br><span class="line">            connection_pool,</span><br><span class="line">            index=&#123;</span><br><span class="line">                &quot;dims&quot;: 1536,</span><br><span class="line">                &quot;embed&quot;: embedding</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        in_postgres_store.setup()</span><br><span class="line">        # å®šä¹‰ Graph</span><br><span class="line">        graph = create_graph(llm, checkpointer, in_postgres_store )</span><br><span class="line">        # ä¿å­˜ Graph å¯è§†åŒ–å›¾</span><br><span class="line">        save_graph_visualization(graph)</span><br><span class="line">        logger.info(&quot;åˆå§‹åŒ–å®Œæˆ&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        logger.error(f&quot;åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™: &#123;str(e)&#125;&quot;)</span><br><span class="line">        raise</span><br><span class="line"></span><br><span class="line">    yield  # åº”ç”¨è¿è¡ŒæœŸé—´</span><br><span class="line"></span><br><span class="line">    # å…³é—­æ—¶æ‰§è¡Œ</span><br><span class="line">    logger.info(&quot;æ­£åœ¨å…³é—­...&quot;)</span><br><span class="line">    if connection_pool:</span><br><span class="line">        connection_pool.close()  # å…³é—­è¿æ¥æ± </span><br><span class="line">        logger.info(&quot;æ•°æ®åº“è¿æ¥æ± å·²å…³é—­&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># lifespanå‚æ•°ç”¨äºåœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹å’Œç»“æŸæ—¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æˆ–æ¸…ç†å·¥ä½œ</span><br><span class="line">app = FastAPI(lifespan=lifespan)</span><br></pre></td></tr></table></figure>
<h3 id="pgsqlçš„å­˜å‚¨ç»“æ„"><a href="#pgsqlçš„å­˜å‚¨ç»“æ„" class="headerlink" title="pgsqlçš„å­˜å‚¨ç»“æ„"></a>pgsqlçš„å­˜å‚¨ç»“æ„</h3><h4 id="ä¸€ã€Checkpoints-ç³»åˆ—"><a href="#ä¸€ã€Checkpoints-ç³»åˆ—" class="headerlink" title="ä¸€ã€Checkpoints ç³»åˆ—"></a>ä¸€ã€Checkpoints ç³»åˆ—</h4><blockquote>
<p>ä½œç”¨ï¼šè®© <strong>LangGraph Runtime</strong> èƒ½åœ¨ <strong>åˆ†å¸ƒå¼/é•¿æµç¨‹</strong> åœºæ™¯ä¸‹ <strong>æ–­ç‚¹ç»­è·‘ã€é‡æ”¾ã€å¹¶å‘æ§åˆ¶</strong>ã€‚</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>è¡¨å</th>
<th>å­˜ä»€ä¹ˆ</th>
<th>å…¸å‹å­—æ®µï¼ˆç¤ºæ„ï¼‰</th>
<th>ä½•æ—¶å†™å…¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>checkpoints</strong></td>
<td>æ¯ä¸ªã€Œå›¾å®ä¾‹ã€çš„ <strong>æœ€æ–°å¿«ç…§</strong>ï¼ˆstate çš„å®Œæ•´ JSONBï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_ns</code>, <code>checkpoint_id</code>, <code>parent_checkpoint_id</code>, <code>state</code>, <code>created_at</code></td>
<td>æ¯æ¬¡èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸåè¦†ç›–æ›´æ–°</td>
</tr>
<tr>
<td><strong>checkpoint_blobs</strong></td>
<td>checkpoints é‡Œ <strong>å¤§å­—æ®µçš„æ‹†åˆ†</strong>ï¼ˆé¿å…è¡Œè¿‡å¤§ï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_ns</code>, <code>channel</code>, <code>type</code>, <code>blob</code></td>
<td>å½“ state è¿‡å¤§ï¼Œè‡ªåŠ¨æ‹†åˆ†</td>
</tr>
<tr>
<td><strong>checkpoint_migrations</strong></td>
<td>è®°å½• <strong>schema ç‰ˆæœ¬/è¿ç§»è„šæœ¬</strong></td>
<td><code>version</code>, <code>name</code>, <code>applied_at</code></td>
<td>åªåœ¨ <code>setup()</code> æ—¶å†™ä¸€æ¬¡</td>
</tr>
<tr>
<td><strong>checkpoint_writes</strong></td>
<td><strong>å†™æ”¾å¤§æ—¥å¿—</strong>ï¼ˆæ¯ä¸ªèŠ‚ç‚¹å†™ state çš„å¢é‡ diffï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_id</code>, <code>task_id</code>, <code>idx</code>, <code>channel</code>, <code>type</code>, <code>value</code></td>
<td>æ¯æ¬¡èŠ‚ç‚¹å®Œæˆæ—¶è¿½åŠ </td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>å…³ç³»ï¼š<br><code>checkpoints</code> = æœ€æ–°å®Œæ•´å¿«ç…§<br><code>checkpoint_writes</code> = æ‰€æœ‰å¢é‡å†å²ï¼ˆç”¨äºé‡æ”¾/å®¡è®¡ï¼‰<br><code>checkpoint_blobs</code> = checkpoints é‡Œè¶…å¤§å‹ value çš„åˆ‡ç‰‡</p>
</blockquote>
<h4 id="äºŒã€Store-ç³»åˆ—"><a href="#äºŒã€Store-ç³»åˆ—" class="headerlink" title="äºŒã€Store ç³»åˆ—"></a>äºŒã€Store ç³»åˆ—</h4><blockquote>
<p>ä½œç”¨ï¼šç»™ <strong>ä¸šåŠ¡ä»£ç ï¼ˆå¼€å‘è€…ï¼‰</strong> æä¾› <strong>æŒä¹…åŒ– KV / å‘é‡å­˜å‚¨</strong>ï¼Œä¸å›¾è¿è¡ŒçŠ¶æ€æ— å…³ã€‚</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>è¡¨å</th>
<th>å­˜ä»€ä¹ˆ</th>
<th>å…¸å‹å­—æ®µï¼ˆç¤ºæ„ï¼‰</th>
<th>ä½•æ—¶å†™å…¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>store</strong></td>
<td><strong>ä»»æ„ KV æ–‡æ¡£</strong>ï¼ˆLangChain Document â†’ JSONBï¼‰</td>
<td><code>uuid</code>, <code>namespace</code>, <code>key</code>, <code>value</code>, <code>created_at</code>, <code>updated_at</code></td>
<td>ä½ è°ƒç”¨ <code>store.amput</code> / <code>amset</code> ç­‰ API</td>
</tr>
<tr>
<td><strong>store_migrations</strong></td>
<td>åŒ checkpoint_migrationsï¼Œè®°å½• store schema ç‰ˆæœ¬</td>
<td><code>version</code>, <code>name</code>, <code>applied_at</code></td>
<td>åªåœ¨ç¬¬ä¸€æ¬¡ <code>setup()</code></td>
</tr>
<tr>
<td><strong>store_vectors</strong></td>
<td><strong>å‘é‡ç´¢å¼•è¡¨</strong>ï¼ˆembedding â†’ vector ç±»å‹ï¼‰</td>
<td><code>uuid</code>, <code>collection_id</code>, <code>embedding</code>, <code>document</code>, <code>metadata</code></td>
<td>ä½ è°ƒç”¨ <code>add_documents(..., embeddings=...)</code></td>
</tr>
<tr>
<td><strong>vector_migrations</strong></td>
<td>è®°å½• pgvector æ‰©å±•åŠç´¢å¼•è¿ç§»ç‰ˆæœ¬</td>
<td><code>version</code>, <code>applied_at</code></td>
<td><code>setup()</code> æ—¶è‹¥ç¬¬ä¸€æ¬¡è£… pgvector</td>
</tr>
</tbody>
</table>
</div>
<h4 id="ä¸‰ã€è°ƒç”¨é“¾è„‘å›¾"><a href="#ä¸‰ã€è°ƒç”¨é“¾è„‘å›¾" class="headerlink" title="ä¸‰ã€è°ƒç”¨é“¾è„‘å›¾"></a>ä¸‰ã€è°ƒç”¨é“¾è„‘å›¾</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ LangGraph    â”‚ è¿è¡Œå›¾å®ä¾‹</span><br><span class="line">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">     â”‚1. å†™ checkpoints</span><br><span class="line">     â”‚2. å†™ checkpoint_writes</span><br><span class="line">     â”‚3. æ‹†å¤§å­—æ®µåˆ° checkpoint_blobs</span><br><span class="line">     â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ä¸šåŠ¡ä»£ç      â”‚ è¯»å†™ KV/å‘é‡</span><br><span class="line">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">     â”‚1. å†™ store</span><br><span class="line">     â”‚2. å†™ store_vectors</span><br><span class="line">     â–¼</span><br><span class="line"> PostgreSQL (pgsql)</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨linuxå®‰è£…postgresql"><a href="#åœ¨linuxå®‰è£…postgresql" class="headerlink" title="åœ¨linuxå®‰è£…postgresql"></a>åœ¨linuxå®‰è£…postgresql</h3><h4 id="æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬"><a href="#æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬"></a>æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹å‘è¡Œç‰ˆåç§°å’Œç‰ˆæœ¬</span><br><span class="line">cat /etc/os-release</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PRETTY_NAME=&quot;Ubuntu 24.04.2 LTS&quot;</span><br><span class="line">NAME=&quot;Ubuntu&quot;</span><br><span class="line">VERSION_ID=&quot;24.04&quot;</span><br><span class="line">VERSION=&quot;24.04.2 LTS (Noble Numbat)&quot;</span><br><span class="line">VERSION_CODENAME=noble</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">HOME_URL=&quot;https://www.ubuntu.com/&quot;</span><br><span class="line">SUPPORT_URL=&quot;https://help.ubuntu.com/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;</span><br><span class="line">PRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span><br><span class="line">UBUNTU_CODENAME=noble</span><br><span class="line">LOGO=ubuntu-logo</span><br></pre></td></tr></table></figure>
<h4 id="å®‰è£…postgresql"><a href="#å®‰è£…postgresql" class="headerlink" title="å®‰è£…postgresql"></a>å®‰è£…postgresql</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•</span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"># å®‰è£… PostgreSQL å’Œå¸¸ç”¨æ‰©å±•</span><br><span class="line">sudo apt install -y postgresql postgresql-contrib</span><br><span class="line"></span><br><span class="line"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span><br><span class="line">#Linux å®¹å™¨/å­ç³»ç»Ÿï¼ˆ Dockerã€WSL æˆ– LXCï¼‰æ²¡æœ‰ä½¿ç”¨ systemd ï¼Œå› æ­¤ systemctl æ— æ³•å·¥ä½œ</span><br><span class="line">sudo systemctl status postgresql</span><br><span class="line"></span><br><span class="line">#ç¡®è®¤ PostgreSQL å·²å®‰è£…</span><br><span class="line">which psql            # åº”è¯¥è¾“å‡º /usr/bin/psql</span><br><span class="line">pg_ctl --version      # æ˜¾ç¤ºç‰ˆæœ¬å·å³å·²å®‰è£…</span><br></pre></td></tr></table></figure>
<ul>
<li><code>postgresql</code> æ˜¯ä¸»ç¨‹åº</li>
<li><code>postgresql-contrib</code> æä¾›é¢å¤–æ‰©å±•ï¼ˆå¦‚ <code>uuid-ossp</code>ã€<code>pgcrypto</code> ç­‰ï¼‰</li>
</ul>
<blockquote>
<p>systemctlä¸€èˆ¬ç”¨äºæœåŠ¡å™¨ä¸Šï¼Œå®Œæ•´çš„linuxç³»ç»Ÿä¸Š</p>
<p>Linux å®¹å™¨/å­ç³»ç»Ÿï¼ˆ Dockerã€WSL æˆ– LXCï¼‰ä½¿ç”¨ service</p>
</blockquote>
<p>å¯åŠ¨pgsqlæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql start</span><br></pre></td></tr></table></figure>
<p>åœæ­¢pgsqlæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql stop</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹çŠ¶æ€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql status</span><br></pre></td></tr></table></figure>
<h3 id="æ›´æ¢apté•œåƒæº"><a href="#æ›´æ¢apté•œåƒæº" class="headerlink" title="æ›´æ¢apté•œåƒæº"></a>æ›´æ¢apté•œåƒæº</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/apt/sources.list &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian-security bookworm-security main contrib non-free</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">apt update</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7470702616906645540">postgresqlå‘é‡æ‰©å±•pgvectorçš„å®‰è£…ä¸å…¥é—¨æœ¬æ–‡ç®€ç­”çš„ä»‹ç»äº† rag çš„æ¶æ„ï¼Œå¼•ç”³å‡ºå‘é‡æ•°æ®åº“çš„ä½œç”¨ï¼Œä»‹ç»äº† - æ˜é‡‘</a></p>
<p>langchainæ”¯æŒå‘é‡å­˜å‚¨<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/vectorstores/">å‘é‡å­˜å‚¨ | ğŸ¦œï¸ğŸ”— LangChain â€”- Vector stores | ğŸ¦œï¸ğŸ”— LangChain</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/transfromers/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/transfromers/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">Transformerå¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00 / ä¿®æ”¹æ—¶é—´ï¼š10:39:27" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/transformer/" itemprop="url" rel="index"><span itemprop="name">transformer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://transformers.run/">Hello! Â· Transformerså¿«é€Ÿå…¥é—¨</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/jsksxs360/How-to-use-Transformers">jsksxs360/How-to-use-Transformers: Transformers åº“å¿«é€Ÿå…¥é—¨æ•™ç¨‹</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">MCP å­¦ä¹ ç¬”è®°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-27 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-27T00:00:00+08:00">2025-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-01 14:31:13" itemprop="dateModified" datetime="2025-08-01T14:31:13+08:00">2025-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä»€ä¹ˆæ˜¯-MCPï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-MCPï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ MCPï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ MCPï¼Ÿ</h3><ul>
<li><strong>å…¨ç§°</strong>ï¼šModel Context Protocol</li>
<li><strong>ä½œç”¨</strong>ï¼šè®© AI åŠ©æ‰‹ï¼ˆå¦‚ Claudeã€Cline ç­‰ï¼‰åœ¨å¯¹è¯è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼ˆToolï¼‰å®Œæˆå¤æ‚ä»»åŠ¡ï¼ˆè¯»å†™æ–‡ä»¶ã€æŸ¥è¯¢æ•°æ®åº“ã€è°ƒç”¨ API ç­‰ï¼‰ã€‚</li>
<li><strong>ç»„æˆ</strong>ï¼š<ol>
<li><strong>MCP Host</strong>ï¼ˆå®¿ä¸»ï¼Œå¦‚ Clineã€Claude Desktopï¼‰</li>
<li><strong>MCP Server</strong>ï¼ˆæä¾› Tool çš„åå°æœåŠ¡ï¼‰</li>
<li><strong>Tool</strong>ï¼ˆå…·ä½“åŠŸèƒ½å•å…ƒï¼Œå¦‚ <code>read_file</code>, <code>exec_command</code> ç­‰ï¼‰</li>
</ol>
</li>
</ul>
<h3 id="æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°"><a href="#æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°"></a>æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°</h3><ul>
<li><strong>MCP Server</strong><ul>
<li>ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œæä¾› 1-N ä¸ª Toolã€‚</li>
<li>å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ç¼–å†™ï¼Œåªè¦æš´éœ²æ ‡å‡† MCP æ¥å£ã€‚</li>
</ul>
</li>
<li><strong>Tool</strong><ul>
<li>æœ€å°æ‰§è¡Œå•å…ƒï¼Œå¿…é¡»åŒ…å«ï¼š<ul>
<li>nameï¼ˆå”¯ä¸€ï¼‰</li>
<li>descriptionï¼ˆè®© LLM ç†è§£ä½•æ—¶è°ƒç”¨ï¼‰</li>
<li>input schemaï¼ˆå‚æ•°ç»“æ„ï¼ŒJSON Schemaï¼‰</li>
</ul>
</li>
</ul>
</li>
<li><strong>äº¤äº’æµç¨‹ï¼ˆé‡ç‚¹ï¼‰</strong><ul>
<li>åœ¨å¯åŠ¨mcp serveræ—¶ï¼Œserverå°†toolä¿¡æ¯ä¼ é€ç»™host</li>
<li>ç”¨æˆ·åœ¨ Host è¾“å…¥è‡ªç„¶è¯­è¨€éœ€æ±‚ã€‚</li>
<li>Host å°†éœ€æ±‚ + å¯ç”¨ Tool åˆ—è¡¨å‘ç»™ LLMã€‚</li>
<li>LLM åˆ¤æ–­è°ƒç”¨å“ªä¸ª Toolï¼Œå¹¶å¡«å……å‚æ•°ã€‚</li>
<li>Host é€šè¿‡ MCP åè®®å‘å¯¹åº” Server å‘é€è¯·æ±‚ã€‚</li>
<li>Server æ‰§è¡Œ Tool å¹¶è¿”å›ç»“æœã€‚</li>
<li>Host å°†ç»“æœåˆå¹¶ä¸Šä¸‹æ–‡ï¼Œç»§ç»­å¯¹è¯ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å®‰è£…mcp"><a href="#å®‰è£…mcp" class="headerlink" title="å®‰è£…mcp"></a>å®‰è£…mcp</h3><p>åœ¨mcp serverå¸‚åœºæŸ¥æ‰¾è‡ªå·±æƒ³ç”¨çš„mcpæœåŠ¡ï¼Œå¦‚<a target="_blank" rel="noopener" href="https://mcp.so/server/fetch/modelcontextprotocol?tab=content">Fetch MCP Server</a></p>
<p>å¤åˆ¶mcpé…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;mcpServers&quot;: &#123;</span><br><span class="line">    &quot;fetch&quot;: &#123;</span><br><span class="line">      &quot;command&quot;: &quot;uvx&quot;,</span><br><span class="line">      &quot;args&quot;: [</span><br><span class="line">        &quot;mcp-server-fetch&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨mcp host ä¸­å®‰è£…ï¼Œå¦‚trae</p>
<p>hostä¼šè‡ªåŠ¨å®Œæˆå¯¹mcpçš„é…ç½®</p>
<h3 id="åˆ›å»ºä¸€ä¸ªmcp-server"><a href="#åˆ›å»ºä¸€ä¸ªmcp-server" class="headerlink" title="åˆ›å»ºä¸€ä¸ªmcp server"></a>åˆ›å»ºä¸€ä¸ªmcp server</h3><p>åˆå§‹åŒ–é¡¹ç›®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uv init weather</span><br><span class="line"></span><br><span class="line">uv sync</span><br><span class="line"></span><br><span class="line">source .venv/bin/activate </span><br><span class="line"></span><br><span class="line">#æ·»åŠ ä¾èµ–</span><br><span class="line">uv add &quot;mcp[cli]&quot; httpx</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºweather.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å…¥ç±»å‹æç¤ºæ¨¡å—ï¼Œç”¨äºç±»å‹æ³¨è§£</span><br><span class="line">from typing import Any</span><br><span class="line"></span><br><span class="line"># å¯¼å…¥httpxåº“ï¼Œç”¨äºå‘é€HTTPè¯·æ±‚</span><br><span class="line">import httpx</span><br><span class="line"></span><br><span class="line"># ä»mcp.server.fastmcpæ¨¡å—å¯¼å…¥FastMCPç±»</span><br><span class="line"># FastMCPæ˜¯ä¸€ä¸ªå¿«é€Ÿæ„å»ºMCPï¼ˆModel Control Protocolï¼‰æœåŠ¡å™¨çš„æ¡†æ¶</span><br><span class="line">from mcp.server.fastmcp import FastMCP</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºFastMCPå®ä¾‹ï¼Œå‘½åä¸º&quot;weather&quot;ï¼Œæ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºERRORï¼ˆåªæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼‰</span><br><span class="line">mcp = FastMCP(&quot;weather&quot;, log_level=&quot;ERROR&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># å¸¸é‡å®šä¹‰</span><br><span class="line"># NWSï¼ˆNational Weather Serviceï¼‰APIçš„åŸºç¡€URL</span><br><span class="line">NWS_API_BASE = &quot;https://api.weather.gov&quot;</span><br><span class="line"># ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†åº”ç”¨ç¨‹åº</span><br><span class="line">USER_AGENT = &quot;weather-app/1.0&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def make_nws_request(url: str) -&gt; dict[str, Any] | None:</span><br><span class="line">    &quot;&quot;&quot;å‘NWS APIå‘èµ·è¯·æ±‚å¹¶å¤„ç†é”™è¯¯ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        url: è¦è¯·æ±‚çš„API URL</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æˆåŠŸæ—¶è¿”å›è§£æåçš„JSONæ•°æ®å­—å…¸ï¼Œå¤±è´¥æ—¶è¿”å›None</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # è®¾ç½®è¯·æ±‚å¤´ä¿¡æ¯</span><br><span class="line">    headers = &#123;</span><br><span class="line">        &quot;User-Agent&quot;: USER_AGENT,           # ç”¨æˆ·ä»£ç†æ ‡è¯†</span><br><span class="line">        &quot;Accept&quot;: &quot;application/geo+json&quot;    # æ¥å—çš„æ•°æ®æ ¼å¼</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # åˆ›å»ºå¼‚æ­¥HTTPå®¢æˆ·ç«¯</span><br><span class="line">    async with httpx.AsyncClient() as client:</span><br><span class="line">        try:</span><br><span class="line">            # å‘èµ·GETè¯·æ±‚ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’</span><br><span class="line">            response = await client.get(url, headers=headers, timeout=30.0)</span><br><span class="line">            # å¦‚æœå“åº”çŠ¶æ€ç ä¸æ˜¯2xxï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            # è¿”å›è§£æåçš„JSONæ•°æ®</span><br><span class="line">            return response.json()</span><br><span class="line">        except Exception:</span><br><span class="line">            # æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œè¿”å›Noneè¡¨ç¤ºè¯·æ±‚å¤±è´¥</span><br><span class="line">            return None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def format_alert(feature: dict) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;å°†è­¦æŠ¥æ•°æ®æ ¼å¼åŒ–ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        feature: åŒ…å«è­¦æŠ¥ä¿¡æ¯çš„å­—å…¸</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„è­¦æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # è·å–è­¦æŠ¥å±æ€§</span><br><span class="line">    props = feature[&quot;properties&quot;]</span><br><span class="line">    # æ ¼å¼åŒ–è­¦æŠ¥ä¿¡æ¯ï¼Œä½¿ç”¨getæ–¹æ³•æä¾›é»˜è®¤å€¼é˜²æ­¢é”®ä¸å­˜åœ¨</span><br><span class="line">    return f&quot;&quot;&quot;</span><br><span class="line">äº‹ä»¶: &#123;props.get(&#x27;event&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">åŒºåŸŸ: &#123;props.get(&#x27;areaDesc&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">ä¸¥é‡ç¨‹åº¦: &#123;props.get(&#x27;severity&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">æè¿°: &#123;props.get(&#x27;description&#x27;, &#x27;æ— æè¿°ä¿¡æ¯&#x27;)&#125;</span><br><span class="line">æŒ‡ç¤º: &#123;props.get(&#x27;instruction&#x27;, &#x27;æ— å…·ä½“æŒ‡ç¤º&#x27;)&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨@mcp.tool()è£…é¥°å™¨å°†å‡½æ•°æ³¨å†Œä¸ºMCPå·¥å…·</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_alerts(state: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šç¾å›½å·çš„å¤©æ°”è­¦æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        state: ä¸¤ä¸ªå­—æ¯çš„ç¾å›½å·ä»£ç ï¼ˆä¾‹å¦‚ï¼šCA, NYï¼‰</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„è­¦æŠ¥ä¿¡æ¯å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # æ„å»ºè·å–å·è­¦æŠ¥çš„URL</span><br><span class="line">    url = f&quot;&#123;NWS_API_BASE&#125;/alerts/active/area/&#123;state&#125;&quot;</span><br><span class="line">    # å‘èµ·APIè¯·æ±‚è·å–æ•°æ®</span><br><span class="line">    data = await make_nws_request(url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ</span><br><span class="line">    if not data or &quot;features&quot; not in data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è­¦æŠ¥æˆ–æœªæ‰¾åˆ°è­¦æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦æœ‰è­¦æŠ¥</span><br><span class="line">    if not data[&quot;features&quot;]:</span><br><span class="line">        return &quot;è¯¥å·æ— æ´»åŠ¨è­¦æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # æ ¼å¼åŒ–æ‰€æœ‰è­¦æŠ¥</span><br><span class="line">    alerts = [format_alert(feature) for feature in data[&quot;features&quot;]]</span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰è­¦æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(alerts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># æ³¨å†Œä¸ºMCPå·¥å…·çš„å¤©æ°”é¢„æŠ¥å‡½æ•°</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_forecast(latitude: float, longitude: float) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”é¢„æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        latitude: ä½ç½®çš„çº¬åº¦</span><br><span class="line">        longitude: ä½ç½®çš„ç»åº¦</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„å¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # é¦–å…ˆè·å–é¢„æŠ¥ç½‘æ ¼ç«¯ç‚¹</span><br><span class="line">    points_url = f&quot;&#123;NWS_API_BASE&#125;/points/&#123;latitude&#125;,&#123;longitude&#125;&quot;</span><br><span class="line">    points_data = await make_nws_request(points_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥ç‚¹æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not points_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–æ­¤ä½ç½®çš„é¢„æŠ¥æ•°æ®ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # ä»ç‚¹å“åº”ä¸­è·å–é¢„æŠ¥URL</span><br><span class="line">    forecast_url = points_data[&quot;properties&quot;][&quot;forecast&quot;]</span><br><span class="line">    forecast_data = await make_nws_request(forecast_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥é¢„æŠ¥æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not forecast_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è¯¦ç»†é¢„æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # å°†æ—¶é—´æ®µæ ¼å¼åŒ–ä¸ºå¯è¯»çš„é¢„æŠ¥</span><br><span class="line">    periods = forecast_data[&quot;properties&quot;][&quot;periods&quot;]</span><br><span class="line">    forecasts = []</span><br><span class="line">    # åªæ˜¾ç¤ºæ¥ä¸‹æ¥çš„5ä¸ªæ—¶é—´æ®µ</span><br><span class="line">    for period in periods[:5]:</span><br><span class="line">        forecast = f&quot;&quot;&quot;</span><br><span class="line">&#123;period[&#x27;name&#x27;]&#125;:</span><br><span class="line">æ¸©åº¦: &#123;period[&#x27;temperature&#x27;]&#125;Â°&#123;period[&#x27;temperatureUnit&#x27;]&#125;</span><br><span class="line">é£åŠ›: &#123;period[&#x27;windSpeed&#x27;]&#125; &#123;period[&#x27;windDirection&#x27;]&#125;</span><br><span class="line">é¢„æŠ¥: &#123;period[&#x27;detailedForecast&#x27;]&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        forecasts.append(forecast)</span><br><span class="line"></span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰é¢„æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(forecasts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ç¨‹åºå…¥å£ç‚¹</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    # åˆå§‹åŒ–å¹¶è¿è¡ŒæœåŠ¡å™¨ï¼Œä½¿ç”¨stdioä¼ è¾“æ–¹å¼</span><br><span class="line">    mcp.run(transport=&#x27;stdio&#x27;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>@mcp.tool()å¯ä»¥å°†å‡½æ•°å†…çš„å­—ç¬¦ä¸²ï¼Œå‚æ•°ç±»å‹ç­‰ä¿¡æ¯ä¼ ç»™å¤§æ¨¡å‹ï¼Œä»¥ä¾›å¤§æ¨¡å‹å†³å®šä½•æ—¶è°ƒç”¨è¿™ä¸ªtool</p>
<p>mcp.run(transport=â€™stdioâ€™)è¯´æ˜mcp serverå’Œhostçš„ä¼ è¾“æ–¹å¼æ˜¯è¾“å…¥å’Œè¾“å‡º</p>
</blockquote>
<p>mcp server é…ç½®ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;weather&quot;: &#123;</span><br><span class="line">    &quot;disabled&quot;: false,</span><br><span class="line">    &quot;timeout&quot;: 60,</span><br><span class="line">    &quot;command&quot;: &quot;uv&quot;,</span><br><span class="line">    &quot;args&quot;: [</span><br><span class="line">      &quot;--directory&quot;,</span><br><span class="line">      &quot;/Users/joeygreen/PycharmProjects/weather&quot;,</span><br><span class="line">      &quot;run&quot;,</span><br><span class="line">      &quot;weather.py&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;transportType&quot;: &quot;stdio&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>â€œdisabledâ€: falseè¡¨ç¤ºè¯¥æœåŠ¡æ˜¯å¦è¢«ç¦ç”¨ã€‚<code>false</code> è¡¨ç¤ºè¯¥æœåŠ¡æ˜¯å¯ç”¨çŠ¶æ€ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p>â€œtimeoutâ€: 60è®¾ç½®è¯¥æœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚</p>
<p>â€œcommandâ€: â€œuvâ€æŒ‡å®šæ‰§è¡Œè¯¥æœåŠ¡æ—¶ä½¿ç”¨çš„å‘½ä»¤ã€‚</p>
<p>â€œargsâ€å‡ºäº†æ‰§è¡Œ <code>command</code> æ—¶éœ€è¦ä¼ é€’çš„å‚æ•°ã€‚</p>
<p>â€œtransportTypeâ€: â€œstdioâ€æŒ‡å®šæœåŠ¡çš„é€šä¿¡æ–¹å¼ã€‚<code>stdio</code> è¡¨ç¤ºæ ‡å‡†è¾“å…¥è¾“å‡ºæµï¼ˆStandard Input Outputï¼‰ï¼Œé€šå¸¸ç”¨äºè¿›ç¨‹é—´é€šä¿¡ã€‚</p>
</blockquote>
<h3 id="è§£æmcp-serverä¸hostçš„é€šä¿¡"><a href="#è§£æmcp-serverä¸hostçš„é€šä¿¡" class="headerlink" title="è§£æmcp serverä¸hostçš„é€šä¿¡"></a>è§£æmcp serverä¸hostçš„é€šä¿¡</h3><p><img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727154739013.png" alt="image-20250727154739013"></p>
<p>è¾“å…¥ä¸ºhostå¯¹serverå‘é€ï¼Œè¾“å‡ºä¸ºserverå¯¹hostå‘é€ï¼Œä»¥ä¸‹å°†åˆ—ä¸¾å‡ ä¸ªé‡è¦çš„è¯´æ˜</p>
<p>è¾“å…¥ä¸­ï¼š<code>method</code>å­—æ®µä¸ºhostå‘Šè¯‰serveræ¥ä¸‹æ¥è¦å¹²ä»€ä¹ˆï¼Œå¦‚<strong>åˆå§‹åŒ– (Initialization)</strong>ï¼Œ<strong>é€šçŸ¥å·²åˆå§‹åŒ– (Notification)</strong>ï¼Œ<strong>æŸ¥è¯¢å¯ç”¨å·¥å…· (Listing Tools)</strong>ï¼Œ<strong>è°ƒç”¨å·¥å…· (Calling a Tool)</strong></p>
<p><code>protocolVersion</code>è¯´æ˜äº†mcpä½¿ç”¨çš„åè®®ç‰ˆæœ¬</p>
<p>ä»¥ä¸‹è§serverè¿”å›çš„toolä¿¡æ¯ï¼Œå…¶ä¸­çš„ä¸€ä¸ªå‚æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;get_forecast&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;Get weather forecast for a location.\n\nArgs:\n    latitude: Latitude of the location\n    longitude: Longitude of the location\n&quot;,</span><br><span class="line">    &quot;inputSchema&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;latitude&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &quot;Latitude&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;number&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;longitude&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &quot;Longitude&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;number&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;required&quot;: [</span><br><span class="line">            &quot;latitude&quot;,</span><br><span class="line">            &quot;longitude&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;title&quot;: &quot;get_forecastArguments&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;object&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å’Œå®šä¹‰çš„å‡½æ•°å¯¹æ¯”å­¦ä¹ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># æ³¨å†Œä¸ºMCPå·¥å…·çš„å¤©æ°”é¢„æŠ¥å‡½æ•°</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_forecast(latitude: float, longitude: float) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”é¢„æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        latitude: ä½ç½®çš„çº¬åº¦</span><br><span class="line">        longitude: ä½ç½®çš„ç»åº¦</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„å¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # é¦–å…ˆè·å–é¢„æŠ¥ç½‘æ ¼ç«¯ç‚¹</span><br><span class="line">    points_url = f&quot;&#123;NWS_API_BASE&#125;/points/&#123;latitude&#125;,&#123;longitude&#125;&quot;</span><br><span class="line">    points_data = await make_nws_request(points_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥ç‚¹æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not points_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–æ­¤ä½ç½®çš„é¢„æŠ¥æ•°æ®ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # ä»ç‚¹å“åº”ä¸­è·å–é¢„æŠ¥URL</span><br><span class="line">    forecast_url = points_data[&quot;properties&quot;][&quot;forecast&quot;]</span><br><span class="line">    forecast_data = await make_nws_request(forecast_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥é¢„æŠ¥æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not forecast_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è¯¦ç»†é¢„æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # å°†æ—¶é—´æ®µæ ¼å¼åŒ–ä¸ºå¯è¯»çš„é¢„æŠ¥</span><br><span class="line">    periods = forecast_data[&quot;properties&quot;][&quot;periods&quot;]</span><br><span class="line">    forecasts = []</span><br><span class="line">    # åªæ˜¾ç¤ºæ¥ä¸‹æ¥çš„5ä¸ªæ—¶é—´æ®µ</span><br><span class="line">    for period in periods[:5]:</span><br><span class="line">        forecast = f&quot;&quot;&quot;</span><br><span class="line">&#123;period[&#x27;name&#x27;]&#125;:</span><br><span class="line">æ¸©åº¦: &#123;period[&#x27;temperature&#x27;]&#125;Â°&#123;period[&#x27;temperatureUnit&#x27;]&#125;</span><br><span class="line">é£åŠ›: &#123;period[&#x27;windSpeed&#x27;]&#125; &#123;period[&#x27;windDirection&#x27;]&#125;</span><br><span class="line">é¢„æŠ¥: &#123;period[&#x27;detailedForecast&#x27;]&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        forecasts.append(forecast)</span><br><span class="line"></span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰é¢„æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(forecasts)</span><br></pre></td></tr></table></figure>
<p><code>description</code>å†…å®¹å³ä¸ºæˆ‘ä»¬åœ¨å®šä¹‰è¿™ä¸ªtoolçš„æ—¶å€™å†™çš„<strong>æ–‡æ¡£å­—ç¬¦ä¸²</strong>ï¼ˆDocumentation Stringï¼‰ï¼Œé€šå¸¸ç®€ç§°ä¸º <strong>docstring</strong></p>
<p><code>inputSchema</code> æ˜¯åœ¨MCPï¼ˆModel Control Protocolï¼‰ä¸­ç”¨æ¥<strong>æè¿°å·¥å…·ï¼ˆtoolï¼‰æ‰€éœ€å‚æ•°çš„ç»“æ„å’Œç±»å‹çš„è§„èŒƒ</strong>ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªJSON Schemaã€‚</p>
<blockquote>
<p>JSON Schema æ˜¯ä¸€ä¸ªç”¨äº<strong>æè¿°å’ŒéªŒè¯ JSON æ•°æ®ç»“æ„çš„è§„èŒƒ</strong>ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸º JSON æ•°æ®çš„â€œè“å›¾â€æˆ–â€œæ¨¡æ¿â€ã€‚</p>
</blockquote>
<p><code>required</code>æŒ‡æ˜å“ªäº›å‚æ•°æ˜¯å¿…éœ€çš„ï¼Œå“ªäº›æ˜¯å¯é€‰çš„ã€‚</p>
<h3 id="ç†è§£mcpçš„æœ¬è´¨"><a href="#ç†è§£mcpçš„æœ¬è´¨" class="headerlink" title="ç†è§£mcpçš„æœ¬è´¨"></a>ç†è§£mcpçš„æœ¬è´¨</h3><p>ä»¥ä¸Šå†…å®¹çš†æ˜¯serverä¸hostç›´æ¥çš„äº¤äº’ï¼Œæœ¬è´¨ä¸Šå¯ä»¥ç†è§£æˆhostå¯¹serveræä¾›çš„å·¥å…·è¿›è¡Œæ³¨å†Œä¸ä½¿ç”¨ã€‚è¿™å…¶ä¸­å¹¶ä¸æ¶‰åŠåˆ°hostä¸å¤§æ¨¡å‹çš„äº¤äº’ï¼Œä¹Ÿå°±æ˜¯å¤§æ¨¡å‹æ˜¯å¦‚ä½•ä½¿ç”¨hostæä¾›çš„ä¿¡æ¯ã€‚å®é™…ä¸Šä¸åŒçš„mcp hostä¸æ¨¡å‹çš„äº¤äº’åè®®ä¹Ÿä¸åŒï¼Œå¦‚clineä½¿ç”¨çš„æ˜¯xmlæ ¼å¼ï¼›cherry studioä½¿ç”¨çš„åˆ™æ˜¯fuction calling</p>
<p>å†çœ‹mcpçš„å…¨ç§°Model Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œä¹Ÿå°±æ˜¯mcpå¢åŠ æ¨¡å‹çš„æ‰©å±•æ€§ï¼Œä½¿ä»–å¯ä»¥è·å–æ›´å¤šä¿¡æ¯ï¼Œè€Œserverå°±æ˜¯ä¸ºæ¨¡å‹æä¾›æ›´å¤šä¿¡æ¯çš„å·¥å…·</p>
<h3 id="mcp-hostä¸æ¨¡å‹çš„äº¤äº’"><a href="#mcp-hostä¸æ¨¡å‹çš„äº¤äº’" class="headerlink" title="mcp hostä¸æ¨¡å‹çš„äº¤äº’"></a>mcp hostä¸æ¨¡å‹çš„äº¤äº’</h3><p>ä½¿ç”¨ä¸­è½¬æœåŠ¡å™¨æˆªè·æ—¥å¿—</p>
<p><img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727163811531-1753605912284-1.png" alt="image-20250727163811531"></p>
<p>ä»¥ä¸‹ä¸ºclineå‘é€ç»™æ¨¡å‹çš„è¯·æ±‚</p>
<p><img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727164527797.png" alt="image-20250727164527797"></p>
<p><code>messages</code>åŒ…å«äº†ç³»ç»Ÿæç¤ºè¯ä¸ç”¨æˆ·è¾“å…¥</p>
<p>å…ˆæ¥çœ‹ç³»ç»Ÿæç¤ºè¯ï¼Œclineæä¾›çš„æç¤ºè¯åŒ…æ‹¬å·¥å…·ä½¿ç”¨æ ¼å¼ï¼Œå·¥å…·ä¿¡æ¯ï¼Œå·¥å…·ä½¿ç”¨æ–¹æ³•ç­‰ã€‚è¿™é‡Œé‡ç‚¹è¯´ä¸€ä¸‹ï¼Œclineçš„å·¥å…·ä½¿ç”¨æ ¼å¼xml</p>
<p>ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;tool_name&gt;</span><br><span class="line">&lt;parameter1_name&gt;value1&lt;/parameter1_name&gt;</span><br><span class="line">&lt;parameter2_name&gt;value2&lt;/parameter2_name&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/tool_name&gt;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;read_file&gt;</span><br><span class="line">src/main.js</span><br><span class="line">&lt;/read_file&gt;</span><br></pre></td></tr></table></figure>
<p>å†ä¸¾ä¸ªä¾‹å­</p>
<p>use_mcp_tool<br>æè¿°ï¼šè¯·æ±‚ä½¿ç”¨ç”±è¿æ¥çš„ MCP æœåŠ¡å™¨æä¾›çš„å·¥å…·ã€‚æ¯ä¸ª MCP æœåŠ¡å™¨å¯ä»¥æä¾›å…·æœ‰ä¸åŒåŠŸèƒ½çš„å¤šä¸ªå·¥å…·ã€‚å·¥å…·æœ‰å®šä¹‰çš„è¾“å…¥æ¨¡å¼ï¼Œç”¨äºæŒ‡å®šå¿…éœ€å’Œå¯é€‰å‚æ•°ã€‚<br>å‚æ•°ï¼š</p>
<p>server_name: (å¿…éœ€) æä¾›è¯¥å·¥å…·çš„ MCP æœåŠ¡å™¨çš„åç§°<br>tool_name: (å¿…éœ€) è¦æ‰§è¡Œçš„å·¥å…·çš„åç§°<br>arguments: (å¿…éœ€) ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å«å·¥å…·çš„è¾“å…¥å‚æ•°ï¼Œéµå¾ªå·¥å…·çš„è¾“å…¥æ¨¡å¼<br>ç”¨æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;use_mcp_tool&gt;</span><br><span class="line">&lt;server_name&gt;æœåŠ¡å™¨åç§°åœ¨æ­¤&lt;/server_name&gt;</span><br><span class="line">&lt;tool_name&gt;å·¥å…·åç§°åœ¨æ­¤&lt;/tool_name&gt;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;param1&quot;: &quot;value1&quot;,</span><br><span class="line">&quot;param2&quot;: &quot;value2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/use_mcp_tool&gt;</span><br></pre></td></tr></table></figure>
<p>æ¨¡å‹è¿”å›å“åº”å¦‚ä¸‹</p>
<p><img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727174504506.png" alt="image-20250727174504506"></p>
<p>sseè¿æ¥ï¼Œæµå¼è¾“å‡º</p>
<blockquote>
<p>SSE æ˜¯ä¸€ç§<strong>åŸºäºæ ‡å‡† HTTP</strong>ã€<strong>åªå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å•å‘æ¨é€æ–‡æœ¬æµ</strong>çš„å®æ—¶é€šä¿¡æŠ€æœ¯ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œè‡ªåŠ¨é‡è¿ï¼Œå¸¸ç”¨äº<strong>AI æµå¼å›ç­”</strong>ã€<strong>å®æ—¶æ—¥å¿—</strong>ã€<strong>è‚¡ä»·/ç›‘æ§æ¨é€</strong>ç­‰åœºæ™¯ã€‚</p>
<p>å³å®¢æˆ·ç«¯å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè¿ç»­æ¥å—å¤šæ¬¡å“åº”ç›´åˆ°ç»“æŸ</p>
</blockquote>
<h3 id="mcpçš„ä¸‰ç§ä¼ è¾“åè®®"><a href="#mcpçš„ä¸‰ç§ä¼ è¾“åè®®" class="headerlink" title="mcpçš„ä¸‰ç§ä¼ è¾“åè®®"></a>mcpçš„ä¸‰ç§ä¼ è¾“åè®®</h3><div class="table-container">
<table>
<thead>
<tr>
<th>åè®®åç§°</th>
<th>é€šä¿¡æ–¹å¼</th>
<th>é€‚ç”¨åœºæ™¯</th>
<th>ä¼˜åŠ¿</th>
<th>å±€é™</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Stdio</strong>ï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰</td>
<td>ä½¿ç”¨è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰å’Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰è¿›è¡Œæœ¬åœ°é€šä¿¡ï¼ŒåŸºäº JSON-RPC 2.0 æ ¼å¼</td>
<td>æœ¬åœ°å¼€å‘ã€è°ƒè¯•ã€IDEæ’ä»¶ã€å‘½ä»¤è¡Œå·¥å…·</td>
<td>ç®€å•æ˜“å®ç°ã€è·¨å¹³å°ã€ä½å»¶è¿Ÿ</td>
<td>ä»…æ”¯æŒæœ¬åœ°é€šä¿¡ï¼Œæ— æ³•è·¨ç½‘ç»œï¼Œä½å¹¶å‘</td>
</tr>
<tr>
<td><strong>SSE</strong>ï¼ˆServer-Sent Eventsï¼‰</td>
<td>å®¢æˆ·ç«¯é€šè¿‡ HTTP POST å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨é€šè¿‡ SSE å•å‘æ¨é€æµå¼å“åº”</td>
<td>å®æ—¶ç›‘æ§ã€æ–°é—»æ¨é€ã€è¿œç¨‹æœåŠ¡è°ƒç”¨</td>
<td>åŸºäº HTTPï¼Œæµè§ˆå™¨å‹å¥½ï¼Œæ”¯æŒæµå¼æ•°æ®</td>
<td>ä»…æ”¯æŒå•å‘é€šä¿¡ï¼ŒMCPå®˜æ–¹å·²æ ‡è®°ä¸ºâ€œå³å°†åºŸå¼ƒâ€</td>
</tr>
<tr>
<td><strong>Streamable HTTP</strong>ï¼ˆæ–°å‹æµå¼HTTPï¼‰</td>
<td>æ”¯æŒåŒå‘æµå¼é€šä¿¡çš„ç°ä»£ HTTP åè®®ï¼Œæ›¿ä»£ SSEï¼Œæ”¯æŒä¼šè¯æ¢å¤ã€OAuth è®¤è¯ç­‰</td>
<td>åˆ†å¸ƒå¼ç³»ç»Ÿã€é«˜å¹¶å‘ã€åŒå‘å®æ—¶äº¤äº’</td>
<td>åŒå‘é€šä¿¡ã€é«˜æ€§èƒ½ã€ä¼ä¸šçº§å®‰å…¨æœºåˆ¶</td>
<td>å®ç°è¾ƒå¤æ‚ï¼Œç”Ÿæ€ä»åœ¨å‘å±•ä¸­</td>
</tr>
</tbody>
</table>
</div>
<h3 id="ReAct"><a href="#ReAct" class="headerlink" title="ReAct"></a>ReAct</h3><p>ReAct æ˜¯ä¸€ç§ç”¨äºå¢å¼ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æ¨ç†å’Œè¡ŒåŠ¨èƒ½åŠ›çš„æŠ€æœ¯æ¡†æ¶ï¼Œå®ƒé€šè¿‡ç»“åˆâ€œæ¨ç†â€ï¼ˆReasoningï¼‰å’Œâ€œè¡ŒåŠ¨â€ï¼ˆActingï¼‰æ¥æå‡æ¨¡å‹å¤„ç†å¤æ‚ä»»åŠ¡çš„èƒ½åŠ›ã€‚</p>
<p>å…¶å·¥ä½œæµç¨‹é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li><strong>æ€è€ƒï¼ˆReasoningï¼‰</strong>ï¼šæ¨¡å‹å¯¹å½“å‰é—®é¢˜è¿›è¡Œåˆ†æï¼Œæ€è€ƒä¸‹ä¸€æ­¥éœ€è¦é‡‡å–çš„è¡ŒåŠ¨ã€‚</li>
<li><strong>è¡ŒåŠ¨ï¼ˆActingï¼‰</strong>ï¼šæ¨¡å‹å†³å®šè°ƒç”¨å“ªäº›å·¥å…·æˆ–å‡½æ•°ï¼Œå¹¶æä¾›å¿…è¦çš„å‚æ•°ã€‚</li>
<li><strong>è§‚å¯Ÿï¼ˆObservationï¼‰</strong>ï¼šå·¥å…·æ‰§è¡Œåè¿”å›ç»“æœï¼Œæ¨¡å‹å¯¹ç»“æœè¿›è¡Œè§‚å¯Ÿã€‚</li>
<li><strong>å“åº”ï¼ˆResponseï¼‰</strong>ï¼šæ ¹æ®è§‚å¯Ÿç»“æœï¼Œæ¨¡å‹ç”Ÿæˆæœ€ç»ˆçš„ç”¨æˆ·å“åº”ã€‚</li>
</ol>
<p>å®é™…åº”ç”¨ä¸Šå°±æ˜¯å‘Šè¯‰å¤§æ¨¡å‹ç”¨ReActè¿™ç§æ¨¡å¼æ¥æ€è€ƒ</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1uronYREWR?spm_id_from=333.788.player.switch&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">MCPç»ˆææŒ‡å— - ä»åŸç†åˆ°å®æˆ˜ï¼Œå¸¦ä½ æ·±å…¥æŒæ¡MCPï¼ˆåŸºç¡€ç¯‡ï¼‰_å“”å“©å“”å“©_bilibili</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/" class="post-title-link" itemprop="url">LangGraphå­¦ä¹ â€”â€”agentâ€”â€”ä¸‹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-22T00:00:00+08:00">2025-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-07-27 12:14:49" itemprop="dateModified" datetime="2025-07-27T12:14:49+08:00">2025-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">aiæ¡†æ¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/langgraph/" itemprop="url" rel="index"><span itemprop="name">langgraph</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æœ¬æ•™ç¨‹ä¸ºlangchainå®˜æ–¹æ•™ç¨‹çš„å­¦ä¹ è®°å½•</p>
<p><a target="_blank" rel="noopener" href="https://academy.langchain.com/enrollments">academy.langchain.com/enrollments</a></p>
<p>ä»£ç è§<a target="_blank" rel="noopener" href="https://github.com/zxj-2023/learn-rag-langchain">zxj-2023/learn-rag-langchain</a></p>
<h3 id="module-4"><a href="#module-4" class="headerlink" title="module-4"></a>module-4</h3><h4 id="Parallel-node-execution-å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ"><a href="#Parallel-node-execution-å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ" class="headerlink" title="Parallel node execution å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ"></a><strong>Parallel node execution</strong> <strong>å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ</strong></h4><h5 id="Waiting-for-nodes-to-finish-ç­‰å¾…èŠ‚ç‚¹å®Œæˆ"><a href="#Waiting-for-nodes-to-finish-ç­‰å¾…èŠ‚ç‚¹å®Œæˆ" class="headerlink" title="Waiting for nodes to finish ç­‰å¾…èŠ‚ç‚¹å®Œæˆ"></a><strong>Waiting for nodes to finish</strong> <strong>ç­‰å¾…èŠ‚ç‚¹å®Œæˆ</strong></h5><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œè·¯å¾„çš„æ­¥éª¤æ¯”å¦ä¸€ä¸ªå¤šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"># Initialize each node with node_secret </span><br><span class="line">builder.add_node(&quot;a&quot;, ReturnNodeValue(&quot;I&#x27;m A&quot;))</span><br><span class="line">builder.add_node(&quot;b&quot;, ReturnNodeValue(&quot;I&#x27;m B&quot;))</span><br><span class="line">builder.add_node(&quot;b2&quot;, ReturnNodeValue(&quot;I&#x27;m B2&quot;))</span><br><span class="line">builder.add_node(&quot;c&quot;, ReturnNodeValue(&quot;I&#x27;m C&quot;))</span><br><span class="line">builder.add_node(&quot;d&quot;, ReturnNodeValue(&quot;I&#x27;m D&quot;))</span><br><span class="line"></span><br><span class="line"># Flow</span><br><span class="line">builder.add_edge(START, &quot;a&quot;)</span><br><span class="line">builder.add_edge(&quot;a&quot;, &quot;b&quot;)</span><br><span class="line">builder.add_edge(&quot;a&quot;, &quot;c&quot;)</span><br><span class="line">builder.add_edge(&quot;b&quot;, &quot;b2&quot;)</span><br><span class="line">builder.add_edge([&quot;b2&quot;, &quot;c&quot;], &quot;d&quot;)</span><br><span class="line">builder.add_edge(&quot;d&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250722143802652.png" alt="image-20250722143802652"></p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>b</code>ã€<code>b2</code> å’Œ <code>c</code> éƒ½æ˜¯åŒä¸€ä¸ªæ­¥éª¤çš„ä¸€éƒ¨åˆ†ã€‚å›¾å½¢å°†åœ¨è¿›å…¥ <code>d</code> æ­¥éª¤ä¹‹å‰ç­‰å¾…æ‰€æœ‰è¿™äº›æ“ä½œå®Œæˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(&#123;&quot;state&quot;: []&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Adding I&#x27;m A to []</span><br><span class="line">Adding I&#x27;m B to [&quot;I&#x27;m A&quot;]</span><br><span class="line">Adding I&#x27;m C to [&quot;I&#x27;m A&quot;]</span><br><span class="line">Adding I&#x27;m B2 to [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;]</span><br><span class="line">Adding I&#x27;m D to [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m B2&quot;]</span><br><span class="line">&#123;&#x27;state&#x27;: [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m B2&quot;, &quot;I&#x27;m D&quot;]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Setting-the-order-of-state-updates-è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº"><a href="#Setting-the-order-of-state-updates-è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº" class="headerlink" title="Setting the order of state updates è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº"></a><strong>Setting the order of state updates</strong> <strong>è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº</strong></h5><p>ç„¶è€Œï¼Œåœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬æ— æ³•å¯¹çŠ¶æ€æ›´æ–°çš„é¡ºåºè¿›è¡Œå…·ä½“æ§åˆ¶ï¼ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯åŸºäºå›¾æ‹“æ‰‘ç»“æ„ç”± LangGraph ç¡®å®šçš„ç¡®å®šæ€§é¡ºåºï¼Œè¯¥é¡ºåºä¸º <strong><em>\</em>æˆ‘ä»¬æ— æ³•æ§åˆ¶**</strong>ã€‚</p>
<p>ä¸Šé¢ï¼Œæˆ‘ä»¬çœ‹åˆ° <code>c</code> è¢«æ·»åŠ åœ¨ <code>b2</code> ä¹‹å‰</p>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ reducer æ¥å®šåˆ¶æ­¤åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œå¯¹çŠ¶æ€æ›´æ–°è¿›è¡Œæ’åºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def sorting_reducer(left, right):</span><br><span class="line">    &quot;&quot;&quot; åˆå¹¶å¹¶æ’åºåˆ—è¡¨ä¸­çš„å€¼&quot;&quot;&quot;</span><br><span class="line">    # å¦‚æœ left ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºåˆ—è¡¨</span><br><span class="line">    if not isinstance(left, list):</span><br><span class="line">        left = [left]</span><br><span class="line"></span><br><span class="line">    # å¦‚æœ right ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºåˆ—è¡¨</span><br><span class="line">    if not isinstance(right, list):</span><br><span class="line">        right = [right]</span><br><span class="line">    </span><br><span class="line">    # åˆå¹¶ left å’Œ right åˆ—è¡¨ï¼Œç„¶åå‡åºæ’åº</span><br><span class="line">    return sorted(left + right, reverse=False)</span><br><span class="line">class State(TypedDict):</span><br><span class="line">    # sorting_reducer å‡½æ•°å°†å¯¹ state ä¸­çš„å€¼è¿›è¡Œæ’åº</span><br><span class="line">    state: Annotated[list, sorting_reducer]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(&#123;&quot;state&quot;: []&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;state&#x27;: [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m B2&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m D&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œreducer å¯¹æ›´æ–°çš„çŠ¶æ€å€¼è¿›è¡Œæ’åºï¼<code>sorting_reducer</code> ç¤ºä¾‹å¯¹æ‰€æœ‰å€¼è¿›è¡Œå…¨å±€æ’åºã€‚æˆ‘ä»¬è¿˜å¯ä»¥ï¼š</p>
<ol>
<li>åœ¨å¹¶è¡Œæ­¥éª¤æœŸé—´å°†è¾“å‡ºå†™å…¥çŠ¶æ€ä¸­çš„å•ç‹¬å­—æ®µ  </li>
<li>åœ¨å¹¶è¡Œæ­¥éª¤ä¹‹åä½¿ç”¨â€œæ±‡â€èŠ‚ç‚¹æ¥åˆå¹¶å’Œæ’åºè¿™äº›è¾“å‡º  </li>
<li>åˆå¹¶åæ¸…é™¤ä¸´æ—¶å­—æ®µ</li>
</ol>
<p>è¯·å‚é˜… <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/branching/#stable-sorting">docs</a> ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p>
<h5 id="Working-with-LLMs-ä½¿ç”¨-LLMs"><a href="#Working-with-LLMs-ä½¿ç”¨-LLMs" class="headerlink" title="Working with LLMs  ä½¿ç”¨ LLMs"></a><strong>Working with LLMs</strong>  <strong>ä½¿ç”¨ LLMs</strong></h5><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç°å®ä¸­çš„ä¾‹å­ï¼æˆ‘ä»¬å¸Œæœ›ä»ä¸¤ä¸ªå¤–éƒ¨æ¥æºï¼ˆWikipedia å’Œ Web-Searchï¼‰æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶è®© LLM å›ç­”ä¸€ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import HumanMessage, SystemMessage</span><br><span class="line"></span><br><span class="line">from langchain_community.document_loaders import WikipediaLoader</span><br><span class="line">from langchain_community.tools import TavilySearchResults</span><br><span class="line"></span><br><span class="line">def search_web(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç½‘ç»œæœç´¢ä¸­æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æœç´¢</span><br><span class="line">    tavily_search = TavilySearchResults(max_results=3)</span><br><span class="line">    search_docs = tavily_search.invoke(state[&#x27;question&#x27;])</span><br><span class="line"></span><br><span class="line">     # å°†å¤šä¸ªæœç´¢æ–‡æ¡£è½¬æ¢æˆäº†ä¸€ä¸ªç»Ÿä¸€æ ¼å¼çš„é•¿æ–‡æœ¬ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½æœ‰è‡ªå·±çš„å…ƒæ•°æ®ï¼ˆå¦‚URLï¼‰ï¼Œå¹¶ä¸”æ–‡æ¡£ä¹‹é—´æœ‰æ˜ç¡®çš„åˆ†éš”ï¼Œä¾¿äºåç»­å¤„ç†æˆ–å±•ç¤ºã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    - è¿™æ˜¯ä¸€ä¸ª åˆ—è¡¨æ¨å¯¼å¼ (list comprehension) ï¼Œå®ƒä¼šéå† search_docs åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼ˆè¿™é‡Œæˆ‘ä»¬ç§°ä¹‹ä¸º doc ï¼‰ã€‚</span><br><span class="line">    - search_docs é‡Œçš„æ¯ä¸ª doc åº”è¯¥æ˜¯ä¸€ä¸ªåŒ…å« &#x27;url&#x27; å’Œ &#x27;content&#x27; é”®çš„å­—å…¸ã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">        [</span><br><span class="line">            f&#x27;&lt;Document href=&quot;&#123;doc[&quot;url&quot;]&#125;&quot;&gt;\n&#123;doc[&quot;content&quot;]&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">            for doc in search_docs</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line"></span><br><span class="line">def search_wikipedia(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç»´åŸºç™¾ç§‘ä¸­æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æœç´¢</span><br><span class="line">    search_docs = WikipediaLoader(query=state[&#x27;question&#x27;], </span><br><span class="line">                                  load_max_docs=2).load()</span><br><span class="line"></span><br><span class="line">     # æ ¼å¼åŒ–</span><br><span class="line">    formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">        [</span><br><span class="line">            f&#x27;&lt;Document source=&quot;&#123;doc.metadata[&quot;source&quot;]&#125;&quot; page=&quot;&#123;doc.metadata.get(&quot;page&quot;, &quot;&quot;)&#125;&quot;&gt;\n&#123;doc.page_content&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">            for doc in search_docs</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line"></span><br><span class="line">def generate_answer(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ç”¨äºå›ç­”é—®é¢˜çš„èŠ‚ç‚¹ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–çŠ¶æ€</span><br><span class="line">    context = state[&quot;context&quot;]</span><br><span class="line">    question = state[&quot;question&quot;]</span><br><span class="line"></span><br><span class="line">    # æ¨¡æ¿</span><br><span class="line">    answer_template = &quot;&quot;&quot;ä½¿ç”¨ä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ &#123;question&#125;: &#123;context&#125;&quot;&quot;&quot;</span><br><span class="line">    answer_instructions = answer_template.format(question=question, </span><br><span class="line">                                                       context=context)    </span><br><span class="line">    </span><br><span class="line">    # å›ç­”</span><br><span class="line">    answer = llm.invoke([SystemMessage(content=answer_instructions)]+[HumanMessage(content=f&quot;å›ç­”é—®é¢˜ã€‚&quot;)])</span><br><span class="line">      </span><br><span class="line">    # å°†å…¶é™„åŠ åˆ°çŠ¶æ€</span><br><span class="line">    return &#123;&quot;answer&quot;: answer&#125;</span><br><span class="line"></span><br><span class="line"># æ·»åŠ èŠ‚ç‚¹</span><br><span class="line">builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–æ¯ä¸ªèŠ‚ç‚¹</span><br><span class="line">builder.add_node(&quot;search_web&quot;,search_web)</span><br><span class="line">builder.add_node(&quot;search_wikipedia&quot;, search_wikipedia)</span><br><span class="line">builder.add_node(&quot;generate_answer&quot;, generate_answer)</span><br><span class="line"></span><br><span class="line"># æµç¨‹</span><br><span class="line">builder.add_edge(START, &quot;search_wikipedia&quot;)</span><br><span class="line">builder.add_edge(START, &quot;search_web&quot;)</span><br><span class="line">builder.add_edge(&quot;search_wikipedia&quot;, &quot;generate_answer&quot;)</span><br><span class="line">builder.add_edge(&quot;search_web&quot;, &quot;generate_answer&quot;)</span><br><span class="line">builder.add_edge(&quot;generate_answer&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250722153534867.png" alt="image-20250722153534867"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = graph.invoke(&#123;&quot;question&quot;: &quot;è‹±ä¼Ÿè¾¾2025å¹´ç¬¬ä¸€å­£åº¦è´¢æŠ¥è¡¨ç°å¦‚ä½•&quot;&#125;)</span><br><span class="line">result[&#x27;answer&#x27;].content</span><br></pre></td></tr></table></figure>
<h4 id="Sub-graphs-å­å›¾"><a href="#Sub-graphs-å­å›¾" class="headerlink" title="Sub-graphs å­å›¾"></a><strong>Sub-graphs</strong> å­å›¾</h4><p>å­å›¾å…è®¸ä½ åœ¨å›¾è¡¨çš„ä¸åŒéƒ¨åˆ†åˆ›å»ºå’Œç®¡ç†ä¸åŒçš„çŠ¶æ€ã€‚è¿™åœ¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­å°¤å…¶æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨æ¯ä¸ªæ™ºèƒ½ä½“éƒ½æœ‰å„è‡ªçŠ¶æ€çš„æ™ºèƒ½ä½“å›¢é˜Ÿä¸­ã€‚</p>
<p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<ul>
<li>æˆ‘æœ‰ä¸€ä¸ªç³»ç»Ÿï¼Œå®ƒæ¥æ”¶æ—¥å¿—ã€‚</li>
<li>è¯¥ç³»ç»Ÿé€šè¿‡ä¸åŒçš„ä»£ç†æ‰§è¡Œä¸¤ä¸ªç‹¬ç«‹çš„å­ä»»åŠ¡ï¼ˆæ€»ç»“æ—¥å¿—ï¼ŒæŸ¥æ‰¾æ•…éšœæ¨¡å¼ï¼‰ã€‚</li>
<li>æˆ‘å¸Œæœ›åœ¨ä¸¤ä¸ªä¸åŒçš„å­å›¾ä¸­æ‰§è¡Œè¿™ä¸¤ä¸ªæ“ä½œã€‚</li>
</ul>
<p>æœ€é‡è¦çš„æ˜¯è¦ç†è§£å›¾è¡¨æ˜¯å¦‚ä½•ä¼ è¾¾ä¿¡æ¯çš„ï¼</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œé€šä¿¡æ˜¯ <strong><em>\</em>é€šè¿‡é‡å å¯†é’¥**</strong> å®ç°çš„ï¼š</p>
<ul>
<li>å­å›¾å¯ä»¥è®¿é—®çˆ¶å›¾ä¸­çš„ <code>docs</code>ï¼ˆæ–‡æ¡£ï¼‰ã€‚</li>
<li>çˆ¶å›¾å¯ä»¥ä»å­å›¾ä¸­è®¿é—® <code>summary</code>ï¼ˆæ‘˜è¦ï¼‰å’Œ <code>failure_report</code>ï¼ˆæ•…éšœæŠ¥å‘Šï¼‰ã€‚</li>
</ul>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/66dbb1abf89f2d847ee6f1ff_sub-graph1.png" alt="subgraph.png"></p>
<ol>
<li><strong>Logs (Traces)</strong>:<ul>
<li>è¿™æ˜¯ç³»ç»Ÿçš„è¾“å…¥ï¼Œè¡¨ç¤ºä¸€ç³»åˆ—çš„æ—¥å¿—è®°å½•ã€‚</li>
</ul>
</li>
<li><strong>Entry Graph</strong>:<ul>
<li>è¿™æ˜¯ç³»ç»Ÿçš„å…¥å£å›¾ï¼Œå®ƒåŒ…å«äº†æ€»ä½“çŠ¶æ€ï¼ˆOverall Stateï¼‰ï¼Œå…¶ä¸­åŒ…å«ï¼š<ul>
<li><code>docs</code>ï¼šæ–‡æ¡£æˆ–æ—¥å¿—æ•°æ®ã€‚</li>
<li><code>summary report</code>ï¼šæ‘˜è¦æŠ¥å‘Šï¼Œè¿™æ˜¯ç³»ç»Ÿæ‰§è¡Œæ‘˜è¦ä»»åŠ¡åç”Ÿæˆçš„ã€‚</li>
<li><code>failure report</code>ï¼šæ•…éšœæŠ¥å‘Šï¼Œè¿™æ˜¯ç³»ç»Ÿæ‰§è¡Œæ•…éšœåˆ†æä»»åŠ¡åç”Ÿæˆçš„ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>Call sub-graphs</strong>:<ul>
<li>è¿™æ˜¯ä»å…¥å£å›¾è°ƒç”¨ä¸¤ä¸ªå­å›¾çš„è¿‡ç¨‹ï¼Œåˆ†åˆ«ç”¨äºæ‰§è¡Œæ‘˜è¦å’Œæ•…éšœåˆ†æä»»åŠ¡ã€‚</li>
</ul>
</li>
<li><strong>Summarization</strong>:<ul>
<li>è¿™ä¸ªå­å›¾è´Ÿè´£ç”Ÿæˆæ—¥å¿—çš„æ‘˜è¦ã€‚å®ƒçš„çŠ¶æ€ï¼ˆSummary Stateï¼‰åŒ…å«ï¼š<ul>
<li><code>docs</code>ï¼šä¸å…¥å£å›¾å…±äº«çš„æ–‡æ¡£æ•°æ®ã€‚</li>
<li><code>summary</code>ï¼šæ‘˜è¦å†…å®¹ã€‚</li>
<li><code>summary report</code>ï¼šæ‘˜è¦æŠ¥å‘Šï¼Œè¿™æ˜¯æ‘˜è¦ä»»åŠ¡å®Œæˆåç”Ÿæˆçš„ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>Failure Analysis</strong>:<ul>
<li>è¿™ä¸ªå­å›¾è´Ÿè´£åˆ†ææ—¥å¿—ä¸­çš„æ•…éšœæ¨¡å¼ã€‚å®ƒçš„çŠ¶æ€ï¼ˆFailure Analysis Stateï¼‰åŒ…å«ï¼š<ul>
<li><code>docs</code>ï¼šä¸å…¥å£å›¾å…±äº«çš„æ–‡æ¡£æ•°æ®ã€‚</li>
<li><code>failures</code>ï¼šæ•…éšœæ¨¡å¼ã€‚</li>
<li><code>failure report</code>ï¼šæ•…éšœæŠ¥å‘Šï¼Œè¿™æ˜¯æ•…éšœåˆ†æä»»åŠ¡å®Œæˆåç”Ÿæˆçš„ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>Finish</strong>:<ul>
<li>è¿™æ˜¯æµç¨‹çš„ç»“æŸç‚¹ï¼Œè¡¨ç¤ºä¸¤ä¸ªå­å›¾çš„ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œå¹¶ä¸”ç”Ÿæˆäº†æ‘˜è¦æŠ¥å‘Šå’Œæ•…éšœæŠ¥å‘Šã€‚</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from operator import add</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line">from typing import List, Optional, Annotated</span><br><span class="line"></span><br><span class="line">#logsç»“æ„</span><br><span class="line">class Log(TypedDict):</span><br><span class="line">    id: str</span><br><span class="line">    question: str</span><br><span class="line">    docs: Optional[List]</span><br><span class="line">    answer: str</span><br><span class="line">    grade: Optional[int]</span><br><span class="line">    grader: Optional[str]</span><br><span class="line">    feedback: Optional[str]</span><br></pre></td></tr></table></figure>
<h5 id="Sub-graphs"><a href="#Sub-graphs" class="headerlink" title="Sub graphs"></a><strong>Sub graphs</strong></h5><p>è¿™é‡Œæ˜¯å¤±è´¥åˆ†æå­å›¾ï¼Œå®ƒä½¿ç”¨äº† <code>FailureAnalysisState</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line">from langgraph.graph import StateGraph, START, END</span><br><span class="line"></span><br><span class="line"># æ•…éšœåˆ†æå­å›¾</span><br><span class="line">class FailureAnalysisState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;ç”¨äºæ•…éšœåˆ†æçš„çŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs: List[Log] # æ¸…ç†åçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    failures: List[Log]     # åŒ…å«æ•…éšœçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    fa_summary: str         # æ•…éšœåˆ†ææ‘˜è¦</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class FailureAnalysisOutputState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;æ•…éšœåˆ†æçš„è¾“å‡ºçŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    fa_summary: str         # æ•…éšœåˆ†ææ‘˜è¦</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">def get_failures(state):</span><br><span class="line">    &quot;&quot;&quot;è·å–åŒ…å«æ•…éšœçš„æ—¥å¿—&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs = state[&quot;cleaned_logs&quot;]</span><br><span class="line">    # ä»æ¸…ç†åçš„æ—¥å¿—ä¸­ç­›é€‰å‡ºåŒ…å« &quot;grade&quot; é”®çš„æ—¥å¿—ï¼Œè¿™äº›è¢«è§†ä¸ºæ•…éšœ</span><br><span class="line">    failures = [log for log in cleaned_logs if &quot;grade&quot; in log]</span><br><span class="line">    return &#123;&quot;failures&quot;: failures&#125;</span><br><span class="line"></span><br><span class="line">def generate_summary(state):</span><br><span class="line">    &quot;&quot;&quot;ç”Ÿæˆæ•…éšœæ‘˜è¦&quot;&quot;&quot;</span><br><span class="line">    failures = state[&quot;failures&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šfa_summary = summary_generation(qs_summary)</span><br><span class="line">    fa_summary = &quot;Chroma æ–‡æ¡£çš„æ£€ç´¢è´¨é‡ä¸ä½³ã€‚&quot;</span><br><span class="line">    # ä¸ºæ¯ä¸ªæ•…éšœæ—¥å¿—ç”Ÿæˆä¸€ä¸ªå¤„ç†è¿‡çš„æ—¥å¿—æ ‡è¯†ç¬¦</span><br><span class="line">    return &#123;&quot;fa_summary&quot;: fa_summary, &quot;processed_logs&quot;: [f&quot;failure-analysis-on-log-&#123;failure[&#x27;id&#x27;]&#125;&quot; for failure in failures]&#125;</span><br><span class="line"></span><br><span class="line">fa_builder = StateGraph(state_schema=FailureAnalysisState,output_schema=FailureAnalysisOutputState)</span><br><span class="line">fa_builder.add_node(&quot;get_failures&quot;, get_failures)</span><br><span class="line">fa_builder.add_node(&quot;generate_summary&quot;, generate_summary)</span><br><span class="line">fa_builder.add_edge(START, &quot;get_failures&quot;)</span><br><span class="line">fa_builder.add_edge(&quot;get_failures&quot;, &quot;generate_summary&quot;)</span><br><span class="line">fa_builder.add_edge(&quot;generate_summary&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = fa_builder.compile()</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723094949158.png" alt="image-20250723094949158"></p>
<p>è¿™é‡Œæ˜¯é—®é¢˜æ€»ç»“å­å›¾ï¼Œå®ƒä½¿ç”¨äº† <code>QuestionSummarizationState</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># æ‘˜è¦ç”Ÿæˆå­å›¾</span><br><span class="line">class QuestionSummarizationState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;ç”¨äºé—®é¢˜æ‘˜è¦çš„çŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs: List[Log] # æ¸…ç†åçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    qs_summary: str         # é—®é¢˜æ‘˜è¦</span><br><span class="line">    report: str             # ä»æ‘˜è¦ç”Ÿæˆçš„æŠ¥å‘Š</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class QuestionSummarizationOutputState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;é—®é¢˜æ‘˜è¦çš„è¾“å‡ºçŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    report: str             # æœ€ç»ˆæŠ¥å‘Š</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">def generate_summary(state):</span><br><span class="line">    &quot;&quot;&quot;ä»æ—¥å¿—ç”Ÿæˆæ‘˜è¦ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs = state[&quot;cleaned_logs&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šsummary = summarize(generate_summary)</span><br><span class="line">    summary = &quot;é—®é¢˜é›†ä¸­åœ¨ ChatOllama å’Œ Chroma å‘é‡å­˜å‚¨çš„ä½¿ç”¨ä¸Šã€‚&quot;</span><br><span class="line">    # è¿”å›æ‘˜è¦ä»¥åŠå·²å¤„ç†çš„æ—¥å¿—ID</span><br><span class="line">    return &#123;&quot;qs_summary&quot;: summary, &quot;processed_logs&quot;: [f&quot;summary-on-log-&#123;log[&#x27;id&#x27;]&#125;&quot; for log in cleaned_logs]&#125;</span><br><span class="line"></span><br><span class="line">def send_to_slack(state):</span><br><span class="line">    &quot;&quot;&quot;æ¨¡æ‹Ÿå‘é€æŠ¥å‘Šã€‚&quot;&quot;&quot;</span><br><span class="line">    qs_summary = state[&quot;qs_summary&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šreport = report_generation(qs_summary)</span><br><span class="line">    report = &quot;foo bar baz&quot;</span><br><span class="line">    return &#123;&quot;report&quot;: report&#125;</span><br><span class="line"></span><br><span class="line">qs_builder = StateGraph(QuestionSummarizationState,output_schema=QuestionSummarizationOutputState)</span><br><span class="line">qs_builder.add_node(&quot;generate_summary&quot;, generate_summary)</span><br><span class="line">qs_builder.add_node(&quot;send_to_slack&quot;, send_to_slack)</span><br><span class="line">qs_builder.add_edge(START, &quot;generate_summary&quot;)</span><br><span class="line">qs_builder.add_edge(&quot;generate_summary&quot;, &quot;send_to_slack&quot;)</span><br><span class="line">qs_builder.add_edge(&quot;send_to_slack&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = qs_builder.compile()</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723100648199.png" alt="image-20250723100648199"></p>
<h5 id="Adding-sub-graphs-to-our-parent-graph-å‘çˆ¶å›¾æ·»åŠ å­å›¾"><a href="#Adding-sub-graphs-to-our-parent-graph-å‘çˆ¶å›¾æ·»åŠ å­å›¾" class="headerlink" title="Adding sub graphs to our parent graph  å‘çˆ¶å›¾æ·»åŠ å­å›¾"></a><strong>Adding sub graphs to our parent graph </strong> <strong>å‘çˆ¶å›¾æ·»åŠ å­å›¾</strong></h5><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>EntryGraphState</code> åˆ›å»ºçˆ¶å›¾ã€‚å¹¶ä¸”æˆ‘ä»¬å°†æˆ‘ä»¬çš„å­å›¾æ·»åŠ ä¸ºèŠ‚ç‚¹ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å…¥å£å›¾</span><br><span class="line">class EntryGraphState(TypedDict):</span><br><span class="line">    # åŸå§‹æ—¥å¿—æ•°æ®åˆ—è¡¨</span><br><span class="line">    raw_logs: List[Log]</span><br><span class="line">    # ç»è¿‡æ¸…æ´—å¤„ç†åçš„æ—¥å¿—æ•°æ®åˆ—è¡¨</span><br><span class="line">    cleaned_logs: List[Log]</span><br><span class="line">    fa_summary: str # è¿™åªä¼šåœ¨æ•…éšœåˆ†æå­å›¾ä¸­ç”Ÿæˆ</span><br><span class="line">    report: str # è¿™åªä¼šåœ¨é—®é¢˜æ‘˜è¦å­å›¾ä¸­ç”Ÿæˆ</span><br><span class="line">    processed_logs:  Annotated[List[int], add] # è·Ÿè¸ªå“ªäº›æ—¥å¿—å·²ç»è¢«å¤„ç†è¿‡ ï¼Œå°¤å…¶æ˜¯åœ¨å­å›¾ä¹‹é—´å…±äº«çŠ¶æ€æ—¶ã€‚</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def clean_logs(state):</span><br><span class="line">    # è·å–æ—¥å¿—</span><br><span class="line">    raw_logs = state[&quot;raw_logs&quot;]</span><br><span class="line">    # æ•°æ®æ¸…æ´— raw_logs -&gt; docs</span><br><span class="line">    cleaned_logs = raw_logs</span><br><span class="line">    return &#123;&quot;cleaned_logs&quot;: cleaned_logs&#125;</span><br><span class="line"></span><br><span class="line">entry_builder = StateGraph(EntryGraphState)</span><br><span class="line">entry_builder.add_node(&quot;clean_logs&quot;, clean_logs)</span><br><span class="line">#æ·»åŠ å­å›¾</span><br><span class="line">entry_builder.add_node(&quot;question_summarization&quot;, qs_builder.compile())</span><br><span class="line">entry_builder.add_node(&quot;failure_analysis&quot;, fa_builder.compile())</span><br><span class="line"></span><br><span class="line">entry_builder.add_edge(START, &quot;clean_logs&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;clean_logs&quot;, &quot;failure_analysis&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;clean_logs&quot;, &quot;question_summarization&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;failure_analysis&quot;, END)</span><br><span class="line">entry_builder.add_edge(&quot;question_summarization&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = entry_builder.compile()</span><br><span class="line"></span><br><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line"># å°† xray è®¾ç½®ä¸º 1 å°†æ˜¾ç¤ºåµŒå¥—å›¾çš„å†…éƒ¨ç»“æ„</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723102913524.png" alt="image-20250723102913524"></p>
<h4 id="Map-reduce"><a href="#Map-reduce" class="headerlink" title="Map-reduce"></a><strong>Map-reduce</strong></h4><p>LangGraph é‡Œçš„ <strong>Map-Reduce</strong> æ˜¯ä¸€ç§<strong>å¹¶è¡Œå¤„ç†æ¨¡å¼</strong>ï¼Œç”¨äºå°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼ˆMapï¼‰ï¼Œå†æ±‡æ€»ç»“æœï¼ˆReduceï¼‰ã€‚è¿™æ˜¯ LangGraph ä¸­å¤„ç†<strong>æ‰¹é‡æ•°æ®æˆ–å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ</strong>çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚</p>
<p>è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå°†å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼š</p>
<p>(1) <strong>æ˜ å°„ï¼ˆMapï¼‰</strong> â€”â€” æ ¹æ®ä¸»é¢˜ç”Ÿæˆä¸€ç»„ç¬‘è¯ã€‚<br>(2) <strong>å½’çº¦ï¼ˆReduceï¼‰</strong> â€”â€” ä»è¿™ç»„ç¬‘è¯ä¸­æŒ‘å‡ºæœ€æ£’çš„ä¸€æ¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line"></span><br><span class="line"># Prompts we will use</span><br><span class="line">subjects_prompt = &quot;&quot;&quot;ç”Ÿæˆä¸€ä¸ªåŒ…å«3ä¸ªå­ä¸»é¢˜çš„åˆ—è¡¨ï¼Œè¿™äº›å­ä¸»é¢˜éƒ½ä¸ä»¥ä¸‹æ€»ä½“ä¸»é¢˜ç›¸å…³ï¼š&#123;topic&#125;ã€‚&quot;&quot;&quot;</span><br><span class="line">joke_prompt = &quot;&quot;&quot;ç”Ÿæˆä¸€ä¸ªå…³äº&#123;subject&#125;çš„ç¬‘è¯&quot;&quot;&quot;</span><br><span class="line">best_joke_prompt = &quot;&quot;&quot;ä¸‹é¢æ˜¯å…³äº&#123;topic&#125;çš„ä¸€å †ç¬‘è¯ã€‚é€‰æ‹©æœ€å¥½çš„ä¸€ä¸ªï¼è¿”å›æœ€å¥½ç¬‘è¯çš„IDï¼Œç¬¬ä¸€ä¸ªç¬‘è¯çš„IDä»0å¼€å§‹ã€‚ç¬‘è¯ï¼š\n\n  &#123;jokes&#125;&quot;&quot;&quot;</span><br><span class="line"># LLM</span><br><span class="line">model = ChatOpenAI(</span><br><span class="line">    model=&quot;qwen-plus-2025-04-28&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;,</span><br><span class="line">    base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h5 id="Parallelizing-joke-generation-å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ"><a href="#Parallelizing-joke-generation-å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ" class="headerlink" title="Parallelizing joke generation å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ"></a><strong>Parallelizing joke generation</strong> <strong>å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ</strong></h5><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰å›¾çš„å…¥å£ç‚¹ï¼Œå®ƒå°†ï¼š</p>
<ul>
<li>æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„ä¸»é¢˜  </li>
<li>åŸºäºè¯¥ä¸»é¢˜ç”Ÿæˆè‹¥å¹²â€œç¬‘è¯å­ä¸»é¢˜â€  </li>
<li>å°†æ¯ä¸ªå­ä¸»é¢˜å‘é€åˆ°ä¸Šé¢å®šä¹‰çš„ç¬‘è¯ç”ŸæˆèŠ‚ç‚¹</li>
</ul>
<p>æˆ‘ä»¬çš„çŠ¶æ€æœ‰ä¸€ä¸ª <code>jokes</code> é”®ï¼Œå®ƒå°†ç´¯ç§¯æ¥è‡ªå¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆçš„ç¬‘è¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Subjects(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰ä¸€ä¸ªPydanticæ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºä¸»é¢˜åˆ—è¡¨ã€‚&quot;&quot;&quot;</span><br><span class="line">    subjects: list[str] # ä¸»é¢˜å­—ç¬¦ä¸²åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class BestJoke(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰ä¸€ä¸ªPydanticæ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºæœ€ä½³ç¬‘è¯çš„IDã€‚&quot;&quot;&quot;</span><br><span class="line">    id: int # æœ€ä½³ç¬‘è¯çš„ç´¢å¼•ID</span><br><span class="line">    </span><br><span class="line">class OverallState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰æ•´ä¸ªå›¾çš„æ€»ä½“çŠ¶æ€ï¼Œä½¿ç”¨TypedDictä»¥ä¾¿äºç±»å‹æç¤ºå’ŒçŠ¶æ€ç®¡ç†ã€‚&quot;&quot;&quot;</span><br><span class="line">    topic: str # å½“å‰è®¨è®ºçš„ä¸»é¢˜</span><br><span class="line">    subjects: list # ç”Ÿæˆçš„å­ä¸»é¢˜åˆ—è¡¨</span><br><span class="line">    jokes: Annotated[list, operator.add] # ç¬‘è¯åˆ—è¡¨ï¼Œä½¿ç”¨operator.addè¡¨ç¤ºåˆ—è¡¨å†…å®¹ä¼šç´¯åŠ è€Œä¸æ˜¯è¦†ç›–</span><br><span class="line">    best_selected_joke: str # æœ€ç»ˆé€‰å‡ºçš„æœ€ä½³ç¬‘è¯</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆç¬‘è¯çš„ä¸»é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#ç”¨äºç”Ÿæˆä¸»é¢˜</span><br><span class="line">def generate_topics(state: OverallState):</span><br><span class="line">    #ä½¿ç”¨ Python çš„ format() æ–¹æ³•æ¥æ„å»ºä¸€ä¸ªæç¤ºå­—ç¬¦ä¸²ï¼ˆ prompt ï¼‰</span><br><span class="line">    prompt = subjects_prompt.format(topic=state[&quot;topic&quot;])</span><br><span class="line">    #.with_structured_output(Subjects) å®ƒæŒ‡ç¤ºæ¨¡å‹å°è¯•å°†å…¶è¾“å‡ºæ ¼å¼åŒ–ä¸º Subjects ç±»</span><br><span class="line">    response = model.with_structured_output(Subjects).invoke(prompt)</span><br><span class="line">    return &#123;&quot;subjects&quot;: response.subjects&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯å¦™å¤„ï¼šæˆ‘ä»¬åˆ©ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/low_level/#send"><code>Send</code></a> ä¸ºæ¯ä¸ªä¸»é¢˜å¹¶è¡Œç”Ÿæˆç¬‘è¯ã€‚</p>
<p>éå¸¸å®ç”¨ï¼æ— è®ºä¸»é¢˜æ•°é‡å¤šå°‘ï¼Œå®ƒéƒ½èƒ½è‡ªåŠ¨å¹¶è¡Œå¤„ç†ã€‚</p>
<ul>
<li><code>generate_joke</code>ï¼šå›¾ä¸­èŠ‚ç‚¹çš„åå­—  </li>
<li><code>&#123;&quot;subject&quot;: s&#125;</code>ï¼šè¦ä¼ é€’çš„çŠ¶æ€</li>
</ul>
<p><code>Send</code> å…è®¸ä½ å‘ <code>generate_joke</code> èŠ‚ç‚¹å‘é€<strong>ä»»æ„</strong>ç»“æ„çš„çŠ¶æ€ï¼Œæ— éœ€ä¸ <code>OverallState</code> å¯¹é½ã€‚<br>åœ¨è¿™é‡Œï¼Œ<code>generate_joke</code> ä½¿ç”¨è‡ªå·±çš„å†…éƒ¨çŠ¶æ€ï¼Œæˆ‘ä»¬é€šè¿‡ <code>Send</code> æŒ‰éœ€å¡«å……å³å¯ã€‚</p>
<blockquote>
<p>åœ¨ LangGraph é‡Œï¼Œ<code>Send</code> æ˜¯ä¸€ä¸ª<strong>â€œåŠ¨æ€æ´¾å‘å™¨â€</strong>ï¼šå®ƒè®©ä½ <strong>åœ¨è¿è¡Œæ—¶</strong>å†³å®šâ€œè¦æŠŠå“ªä¸ªèŠ‚ç‚¹è¿è¡Œå¤šå°‘æ¬¡ã€æ¯æ¬¡ç»™å®ƒä»€ä¹ˆæ•°æ®â€ï¼Œå¹¶è‡ªåŠ¨å¹¶è¡Œæ‰§è¡Œã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.types import Send</span><br><span class="line">def continue_to_jokes(state: OverallState):</span><br><span class="line">    # è¯¥å‡½æ•°æ ¹æ®å½“å‰çŠ¶æ€ä¸­çš„ä¸»é¢˜åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªä¸»é¢˜ç”Ÿæˆä¸€ä¸ª Send å¯¹è±¡ã€‚</span><br><span class="line">    # æ¯ä¸ª Send å¯¹è±¡éƒ½æŒ‡ç¤ºå›¾å°†æ•°æ®å‘é€åˆ°åä¸º &quot;generate_joke&quot; çš„èŠ‚ç‚¹ï¼Œ</span><br><span class="line">    # å¹¶å°†å½“å‰ä¸»é¢˜ä½œä¸º &quot;subject&quot; å‚æ•°ä¼ é€’ï¼Œä»è€Œå®ç°å¹¶è¡Œç”Ÿæˆç¬‘è¯ã€‚</span><br><span class="line">    return [Send(&quot;generate_joke&quot;, &#123;&quot;subject&quot;: s&#125;) for s in state[&quot;subjects&quot;]]</span><br></pre></td></tr></table></figure>
<h5 id="Joke-generation-map-ç¬‘è¯ç”Ÿæˆ"><a href="#Joke-generation-map-ç¬‘è¯ç”Ÿæˆ" class="headerlink" title="Joke generation (map) ç¬‘è¯ç”Ÿæˆ"></a><strong>Joke generation (map)</strong> <strong>ç¬‘è¯ç”Ÿæˆ</strong></h5><p>ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹æ¥ç”Ÿæˆç¬‘è¯ï¼Œå‘½åä¸º <code>generate_joke</code>ï¼</p>
<p>ç”Ÿæˆçš„ç¬‘è¯ä¼šè¢«å†™å›åˆ° <code>OverallState</code> ä¸­çš„ <code>jokes</code> å­—æ®µã€‚<br>è¯¥å­—æ®µé…æœ‰ reducerï¼Œèƒ½å¤Ÿè‡ªåŠ¨æŠŠå¤šæ¬¡å†™å…¥çš„åˆ—è¡¨åˆå¹¶æˆä¸€ä¸ªå¤§åˆ—è¡¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># å®šä¹‰ JokeStateï¼Œç”¨äºè¡¨ç¤ºç”Ÿæˆç¬‘è¯ä»»åŠ¡çš„è¾“å…¥çŠ¶æ€ã€‚</span><br><span class="line">class JokeState(TypedDict):</span><br><span class="line">    subject: str#ç¬‘è¯çš„ä¸»é¢˜</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ Joke æ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºæ¨¡å‹ç”Ÿæˆçš„ç¬‘è¯çš„ç»“æ„ã€‚</span><br><span class="line">class Joke(BaseModel):</span><br><span class="line">    joke: str#ç¬‘è¯çš„æ–‡æœ¬å†…å®¹</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ç”Ÿæˆç¬‘è¯çš„å‡½æ•°ã€‚</span><br><span class="line">def generate_joke(state: JokeState):</span><br><span class="line">    # æ ¹æ® joke_prompt æ¨¡æ¿å’Œå½“å‰çŠ¶æ€ä¸­çš„ä¸»é¢˜æ ¼å¼åŒ–æç¤ºã€‚</span><br><span class="line">    prompt = joke_prompt.format(subject=state[&quot;subject&quot;])</span><br><span class="line">    # è°ƒç”¨è¯­è¨€æ¨¡å‹ï¼Œå¹¶æŒ‡å®šè¾“å‡ºåº”ç»“æ„åŒ–ä¸º Joke ç±»å‹ã€‚</span><br><span class="line">    response = model.with_structured_output(Joke).invoke(prompt)</span><br><span class="line">    # è¿”å›ä¸€ä¸ªåŒ…å«ç”Ÿæˆçš„ç¬‘è¯çš„å­—å…¸ï¼Œé”®ä¸º &quot;jokes&quot;ã€‚</span><br><span class="line">    return &#123;&quot;jokes&quot;: [response.joke]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Best-joke-selection-reduce-æœ€ä½³ç¬‘è¯é€‰æ‹©"><a href="#Best-joke-selection-reduce-æœ€ä½³ç¬‘è¯é€‰æ‹©" class="headerlink" title="Best joke selection (reduce) æœ€ä½³ç¬‘è¯é€‰æ‹©"></a><strong>Best joke selection (reduce)</strong> <strong>æœ€ä½³ç¬‘è¯é€‰æ‹©</strong></h5><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ·»åŠ é€»è¾‘æ¥æŒ‘é€‰æœ€å¥½çš„ç¬‘è¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def best_joke(state: OverallState):</span><br><span class="line">    # å°†çŠ¶æ€ä¸­æ‰€æœ‰ç¬‘è¯åˆ—è¡¨è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªç¬‘è¯ä¹‹é—´ç”¨ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš”</span><br><span class="line">    jokes = &quot;\n\n&quot;.join(state[&quot;jokes&quot;])</span><br><span class="line">    # ä½¿ç”¨ä¸»é¢˜å’Œæ‰€æœ‰ç¬‘è¯æ ¼å¼åŒ–æœ€ä½³ç¬‘è¯æç¤ºè¯­</span><br><span class="line">    prompt = best_joke_prompt.format(topic=state[&quot;topic&quot;], jokes=jokes)</span><br><span class="line">    # è°ƒç”¨æ¨¡å‹ï¼ŒæœŸæœ›å…¶è¾“å‡ºç¬¦åˆ BestJoke ç»“æ„ï¼ˆåŒ…å«æœ€ä½³ç¬‘è¯çš„IDï¼‰</span><br><span class="line">    response = model.with_structured_output(BestJoke).invoke(prompt)</span><br><span class="line">    # æ ¹æ®æ¨¡å‹è¿”å›çš„IDï¼Œä»ç¬‘è¯åˆ—è¡¨ä¸­é€‰æ‹©æœ€ä½³ç¬‘è¯ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨çŠ¶æ€çš„ best_selected_joke å­—æ®µä¸­</span><br><span class="line">    return &#123;&quot;best_selected_joke&quot;: state[&quot;jokes&quot;][response.id]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Compile-ç¼–è¯‘"><a href="#Compile-ç¼–è¯‘" class="headerlink" title="Compile ç¼–è¯‘"></a><strong>Compile</strong> ç¼–è¯‘</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image</span><br><span class="line">from langgraph.graph import END, StateGraph, START</span><br><span class="line"></span><br><span class="line"># æ„å»ºå›¾ï¼šå°†æ‰€æœ‰ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·æ„å»ºæˆ‘ä»¬çš„æµç¨‹å›¾</span><br><span class="line">graph = StateGraph(OverallState)</span><br><span class="line"></span><br><span class="line">graph.add_node(&quot;generate_topics&quot;, generate_topics)</span><br><span class="line">graph.add_node(&quot;generate_joke&quot;, generate_joke)</span><br><span class="line">graph.add_node(&quot;best_joke&quot;, best_joke)</span><br><span class="line"></span><br><span class="line">graph.add_edge(START, &quot;generate_topics&quot;)</span><br><span class="line"># æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ç»§ç»­ç”Ÿæˆç¬‘è¯</span><br><span class="line">graph.add_conditional_edges(&quot;generate_topics&quot;, continue_to_jokes, [&quot;generate_joke&quot;])</span><br><span class="line"># ç”Ÿæˆç¬‘è¯åæ‰§è¡Œé€‰æ‹©æœ€ä½³ç¬‘è¯</span><br><span class="line">graph.add_edge(&quot;generate_joke&quot;, &quot;best_joke&quot;)</span><br><span class="line"># é€‰æ‹©æœ€ä½³ç¬‘è¯åæµç¨‹ç»“æŸ</span><br><span class="line">graph.add_edge(&quot;best_joke&quot;, END)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = graph.compile()</span><br><span class="line">Image(app.get_graph().draw_mermaid_png())</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723112736244.png" alt="image-20250723112736244"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for s in app.stream(&#123;&quot;topic&quot;: &quot;æ—¥æœ¬å¹¿å²›åŸå­å¼¹&quot;&#125;):</span><br><span class="line">    print(s)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;generate_topics&#x27;: &#123;&#x27;subjects&#x27;: [&#x27;åŸå­å¼¹æŠ•æ”¾çš„å†å²èƒŒæ™¯ä¸å†³ç­–è¿‡ç¨‹&#x27;, &#x27;å¹¿å²›åŸçˆ†å¯¹åŸå¸‚ä¸å±…æ°‘çš„å½±å“&#x27;, &#x27;æˆ˜åå’Œå¹³è¿åŠ¨ä¸æ ¸è£å†›å€¡è®®&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&#x27;ä¸ºä»€ä¹ˆå¹¿å²›çš„é‡å»ºè®¡åˆ’ä»ä¸æ‹…å¿ƒäº¤é€šå µå¡ï¼Ÿå› ä¸ºæ¯ä¸ªäººéƒ½ä¹ æƒ¯äº†â€˜ç¬é—´æ¶ˆå¤±â€™ï¼ï¼ˆæ³¨ï¼šæ­¤ç¬‘è¯ä¸ºè™šæ„åˆ›ä½œï¼Œæ—¨åœ¨ä»¥å¹½é»˜æ–¹å¼å¼•å‘æ€è€ƒï¼Œå¹¶éå¯¹å†å²äº‹ä»¶çš„ä¸å°Šé‡ï¼‰&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&#x27;æˆ˜åå’Œå¹³è¿åŠ¨çš„äººå¼€ä¼šè®¨è®ºæ ¸è£å†›ï¼Œä¸€ä¸ªäººç«™èµ·æ¥è¯´ï¼šâ€˜æˆ‘ä»¬å¿…é¡»å½»åº•é”€æ¯æ‰€æœ‰æ ¸æ­¦å™¨ï¼â€™ å¦ä¸€ä¸ªäººçŠ¹è±«åœ°ä¸¾æ‰‹ï¼šâ€˜é‚£â€¦â€¦æˆ‘ä»¬ä¿ç•™ä¸€ä¸ªå§ï¼Œå°±ä¸€ä¸ªï¼Œè—åœ¨å†°ç®±åé¢ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚â€™&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&quot;æœé²é—¨å®£å¸ƒè¦ç»“æŸæˆ˜äº‰ï¼Œé¡¾é—®é—®æ˜¯å¦è¦ä½¿ç”¨åŸå­å¼¹ã€‚ç½—æ–¯ç¦çš„æ£ºææ¿çªç„¶éœ‡åŠ¨äº†ä¸€ä¸‹ï¼Œä¸˜å‰å°”çš„é›ªèŒ„æ‰åœ¨äº†åœ°ä¸Šï¼Œæ–¯å¤§æ—åˆ™é»˜é»˜æ‹¿èµ·äº†ç”µè¯ï¼š&#x27;åŒå¿—ï¼Œæˆ‘ä»¬çš„è®¡åˆ’å¯èƒ½éœ€è¦å†æ¨è¿Ÿä¸€ä¸‹ã€‚&#x27;&quot;]&#125;&#125;</span><br><span class="line">&#123;&#x27;best_joke&#x27;: &#123;&#x27;best_selected_joke&#x27;: &#x27;ä¸ºä»€ä¹ˆå¹¿å²›çš„é‡å»ºè®¡åˆ’ä»ä¸æ‹…å¿ƒäº¤é€šå µå¡ï¼Ÿå› ä¸ºæ¯ä¸ªäººéƒ½ä¹ æƒ¯äº†â€˜ç¬é—´æ¶ˆå¤±â€™ï¼ï¼ˆæ³¨ï¼šæ­¤ç¬‘è¯ä¸ºè™šæ„åˆ›ä½œï¼Œæ—¨åœ¨ä»¥å¹½é»˜æ–¹å¼å¼•å‘æ€è€ƒï¼Œå¹¶éå¯¹å†å²äº‹ä»¶çš„ä¸å°Šé‡ï¼‰&#x27;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Research Assistant</strong> <strong>ç ”ç©¶åŠ©ç†</strong></p>
<p>è§å¦ä¸€ç¯‡æ–‡ç« </p>
<h3 id="module-5"><a href="#module-5" class="headerlink" title="module-5"></a>module-5</h3><h4 id="Chatbot-with-Memory-å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº"><a href="#Chatbot-with-Memory-å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº" class="headerlink" title="Chatbot with Memory å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº"></a><strong>Chatbot with Memory</strong> <strong>å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº</strong></h4><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä»‹ç» <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph Memory Store</a> ä½œä¸ºä¸€ç§ä¿å­˜å’Œæ£€ç´¢é•¿æœŸè®°å¿†çš„æ–¹æ³•ã€‚</p>
<blockquote>
<p>LangGraph Memory Store æ˜¯ <strong>LangGraph æä¾›çš„é•¿æœŸè®°å¿†å­˜å‚¨æ¥å£</strong>ï¼Œç”¨äºåœ¨ <strong>ä¸åŒå¯¹è¯çº¿ç¨‹ä¹‹é—´</strong> æŒä¹…åŒ–ä¿å­˜å’Œæ£€ç´¢ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>BaseStore</strong></td>
<td>æŠ½è±¡æ¥å£ï¼Œå®šä¹‰äº† <code>put/get/search/delete</code> ç­‰æ“ä½œæ–¹æ³•</td>
</tr>
<tr>
<td><strong>InMemoryStore</strong></td>
<td>å†…å­˜å®ç°ï¼Œé€‚åˆåŸå‹éªŒè¯</td>
</tr>
<tr>
<td><strong>RedisStore / AsyncRedisStore</strong></td>
<td>ç”Ÿäº§çº§å®ç°ï¼Œæ”¯æŒå‘é‡æœç´¢ã€å…ƒæ•°æ®è¿‡æ»¤å’Œå‘½åç©ºé—´ç®¡ç†</td>
</tr>
</tbody>
</table>
</div>
</blockquote>
<p>æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªä½¿ç”¨ <code>short-term (within-threadä»…å½“å‰å¯¹è¯çº¿ç¨‹)</code> å’Œ <code>long-term (across-threadè·¨æ‰€æœ‰å¯¹è¯çº¿ç¨‹    )</code> å†…å­˜çš„èŠå¤©æœºå™¨äººã€‚</p>
<p>æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨é•¿æœŸ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#semantic-memory">semantic memory<strong>ï¼ˆè¯­ä¹‰è®°å¿†ï¼‰</strong></a>ï¼Œå®ƒå°†åŒ…å«å…³äºç”¨æˆ·çš„äº‹å®ä¿¡æ¯ã€‚è¿™äº›é•¿æœŸè®°å¿†å°†è¢«ç”¨äºåˆ›å»ºä¸€ä¸ªä¸ªæ€§åŒ–çš„èŠå¤©æœºå™¨äººï¼Œå®ƒå¯ä»¥è®°ä½æœ‰å…³ç”¨æˆ·çš„äº‹å®ã€‚</p>
<p>å®ƒå°†èŠ‚çœå†…å­˜ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#writing-memories">â€œin the hot pathâ€</a>ï¼Œå½“ç”¨æˆ·ä¸ä¹‹èŠå¤©æ—¶ã€‚</p>
<blockquote>
<p><strong>â€œin the hot pathâ€</strong> æŒ‡çš„æ˜¯ï¼š<strong>åœ¨å¯¹è¯æˆ–ä»»åŠ¡æ‰§è¡Œçš„</strong>ä¸»æµç¨‹ä¸­<strong>ï¼ˆå³ç”¨æˆ·è¾“å…¥åç«‹å³ã€åŒæ­¥åœ°ï¼‰</strong>ä¸»åŠ¨è°ƒç”¨å·¥å…·æˆ–å†™å…¥è®°å¿†ï¼Œä½¿ä¿¡æ¯<strong>å®æ—¶ç”Ÿæ•ˆ</strong>å¹¶å¯ç”¨äºä¸‹ä¸€æ­¥å†³ç­–ã€‚</p>
</blockquote>
<h5 id="Introduction-to-the-LangGraph-Store-LangGraph-å­˜å‚¨ç®€ä»‹"><a href="#Introduction-to-the-LangGraph-Store-LangGraph-å­˜å‚¨ç®€ä»‹" class="headerlink" title="Introduction to the LangGraph Store LangGraph å­˜å‚¨ç®€ä»‹"></a><strong>Introduction to the LangGraph Store</strong> <strong>LangGraph å­˜å‚¨ç®€ä»‹</strong></h5><p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph Memory Store</a> æä¾›äº†ä¸€ç§åœ¨ LangGraph ä¸­ <strong>è·¨çº¿ç¨‹</strong> å­˜å‚¨å’Œæ£€ç´¢ä¿¡æ¯çš„æ–¹å¼ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºæŒä¹…åŒ– <code>key-value</code> å­˜å‚¨çš„ <a target="_blank" rel="noopener" href="https://blog.langchain.dev/launching-long-term-memory-support-in-langgraph/">å¼€æºåŸºç±»</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">from langgraph.store.memory import InMemoryStore</span><br><span class="line">in_memory_store = InMemoryStore()</span><br></pre></td></tr></table></figure>
<p>åœ¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">Store</a> ä¸­å­˜å‚¨å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œè®°å¿†ï¼‰æ—¶ï¼Œæˆ‘ä»¬æä¾›ï¼š</p>
<p>- å¯¹è±¡çš„ <code>namespace</code>ï¼ˆç±»ä¼¼äºç›®å½•çš„å…ƒç»„ï¼‰</p>
<p>- å¯¹è±¡çš„ <code>key</code>ï¼ˆç±»ä¼¼äºæ–‡ä»¶åï¼‰</p>
<p>- å¯¹è±¡çš„ <code>value</code>ï¼ˆç±»ä¼¼äºæ–‡ä»¶å†…å®¹ï¼‰</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.put">put</a> æ–¹æ³•é€šè¿‡ <code>namespace</code> å’Œ <code>key</code> å°†å¯¹è±¡ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250725155616205-1753430177489-3.png" alt="image-20250725155616205"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†è®¾ç½®å‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;  # ç”¨æˆ·ID</span><br><span class="line">namespace_for_memory = (user_id, &quot;memories&quot;)  # è®°å¿†å‘½åç©ºé—´</span><br><span class="line"></span><br><span class="line"># ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„é”®å€¼</span><br><span class="line">key = str(uuid.uuid4())  # ä½¿ç”¨UUIDåˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸ºé”®</span><br><span class="line"></span><br><span class="line"># å€¼éœ€è¦æ˜¯ä¸€ä¸ªå­—å…¸æ ¼å¼</span><br><span class="line">value = &#123;&quot;food_preference&quot;: &quot;æˆ‘å–œæ¬¢æŠ«è¨&quot;&#125;  # å­˜å‚¨çš„é£Ÿç‰©åå¥½ä¿¡æ¯</span><br><span class="line"></span><br><span class="line"># ä¿å­˜è®°å¿†</span><br><span class="line">in_memory_store.put(namespace_for_memory, key, value)  # å°†è®°å¿†å­˜å‚¨åˆ°å†…å­˜ä¸­</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.search">search</a> é€šè¿‡ <code>namespace</code> ä»å­˜å‚¨ä¸­æ£€ç´¢å¯¹è±¡ã€‚è¿™å°†è¿”å›ä¸€ä¸ªåˆ—è¡¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">memories = in_memory_store.search(namespace_for_memory)</span><br><span class="line">type(memories)</span><br><span class="line"></span><br><span class="line"># Metatdata </span><br><span class="line">memories[0].dict()</span><br><span class="line"></span><br><span class="line"># The key, value</span><br><span class="line">print(memories[0].key, memories[0].value)</span><br><span class="line">9e65de8a-f404-4974-b509-0df0566d8fb5 &#123;&#x27;food_preference&#x27;: &#x27;æˆ‘å–œæ¬¢æŠ«è¨&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.get">get</a> é€šè¿‡ <code>namespace</code> å’Œ <code>key</code> æ£€ç´¢å¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Get the memory by namespace and key</span><br><span class="line">memory = in_memory_store.get(namespace_for_memory, key)</span><br><span class="line">memory.dict()</span><br></pre></td></tr></table></figure>
<h5 id="Chatbot-with-long-term-memory-å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº"><a href="#Chatbot-with-long-term-memory-å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº" class="headerlink" title="Chatbot with long-term memory å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº"></a><strong>Chatbot with long-term memory</strong> <strong>å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº</strong></h5><p>æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œ<a target="_blank" rel="noopener" href="https://docs.google.com/presentation/d/181mvjlgsnxudQI6S3ritg9sooNyu4AcLLFH1UK0kIuk/edit#slide=id.g30eb3c8cf10_0_156">æœ‰ä¸¤ç§è®°å¿†çš„æ–¹å¼</a>:</p>
<ol>
<li><code>Short-term (within-thread) memory</code>: èŠå¤©æœºå™¨äººå¯ä»¥ä¿ç•™ä¼šè¯å†å²è®°å½•å’Œ/æˆ–å…è®¸åœ¨èŠå¤©ä¼šè¯ä¸­è¿›è¡Œä¸­æ–­ã€‚  </li>
<li><code>Long-term (cross-thread) memory</code>: èŠå¤©æœºå™¨äººå¯ä»¥è®°ä½ç‰¹å®šç”¨æˆ·åœ¨æ‰€æœ‰èŠå¤©ä¼šè¯ä¸­çš„ä¿¡æ¯ <strong>è·¨ä¼šè¯</strong>ã€‚</li>
</ol>
<p>å¯¹äº <code>short-term memory</code>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/persistence/#checkpointer-libraries">checkpointer</a>ã€‚</p>
<ul>
<li>ä»–ä»¬åœ¨æ¯ä¸€æ­¥éƒ½å°†å›¾çŠ¶æ€å†™å…¥çº¿ç¨‹ä¸­ã€‚</li>
<li>ä»–ä»¬åœ¨è¯¥çº¿ç¨‹ä¸­æŒä¹…åŒ–ä¿å­˜èŠå¤©å†å²è®°å½•ã€‚</li>
<li>ä»–ä»¬å…è®¸å›¾åœ¨è¯¥çº¿ç¨‹ä¸­çš„ä»»ä½•æ­¥éª¤è¢«ä¸­æ–­å’Œ/æˆ–æ¢å¤ã€‚</li>
</ul>
<p>å¯¹äº <code>long-term memory</code>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸Šé¢ä»‹ç»çš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph Store</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.graph import StateGraph, MessagesState, START, END</span><br><span class="line">from langgraph.store.base import BaseStore</span><br><span class="line"></span><br><span class="line">from langchain_core.messages import HumanMessage, SystemMessage</span><br><span class="line">from langchain_core.runnables.config import RunnableConfig</span><br><span class="line"></span><br><span class="line"># èŠå¤©æœºå™¨äººæŒ‡ä»¤</span><br><span class="line">MODEL_SYSTEM_MESSAGE = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰è®°å¿†åŠŸèƒ½çš„æœ‰ç”¨åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæä¾›å…³äºç”¨æˆ·çš„ä¿¡æ¯ã€‚</span><br><span class="line">å¦‚æœä½ æœ‰è¿™ä¸ªç”¨æˆ·çš„è®°å¿†ï¼Œè¯·ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯è®°å¿†å†…å®¹ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># æ ¹æ®èŠå¤©å†å²å’Œä»»ä½•ç°æœ‰è®°å¿†åˆ›å»ºæ–°è®°å¿†</span><br><span class="line">CREATE_MEMORY_INSTRUCTION = &quot;&quot;&quot;&quot;ä½ æ­£åœ¨æ”¶é›†ç”¨æˆ·ä¿¡æ¯ä»¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line"></span><br><span class="line">å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š</span><br><span class="line">&#123;memory&#125;</span><br><span class="line"></span><br><span class="line">æŒ‡ä»¤ï¼š</span><br><span class="line">1. ä»”ç»†æŸ¥çœ‹ä¸‹é¢çš„èŠå¤©å†å²</span><br><span class="line">2. è¯†åˆ«æœ‰å…³ç”¨æˆ·çš„æ–°ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</span><br><span class="line">   - ä¸ªäººè¯¦æƒ…ï¼ˆå§“åã€ä½ç½®ï¼‰</span><br><span class="line">   - åå¥½ï¼ˆå–œæ¬¢ã€ä¸å–œæ¬¢ï¼‰</span><br><span class="line">   - å…´è¶£å’Œçˆ±å¥½</span><br><span class="line">   - è¿‡å»çš„ç»å†</span><br><span class="line">   - ç›®æ ‡æˆ–æœªæ¥è®¡åˆ’</span><br><span class="line">3. å°†ä»»ä½•æ–°ä¿¡æ¯ä¸ç°æœ‰è®°å¿†åˆå¹¶</span><br><span class="line">4. å°†è®°å¿†æ ¼å¼åŒ–ä¸ºæ¸…æ™°çš„é¡¹ç›®ç¬¦å·åˆ—è¡¨</span><br><span class="line">5. å¦‚æœæ–°ä¿¡æ¯ä¸ç°æœ‰è®°å¿†å†²çªï¼Œè¯·ä¿ç•™æœ€æ–°ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">è®°ä½ï¼šåªåŒ…æ‹¬ç”¨æˆ·ç›´æ¥é™ˆè¿°çš„äº‹å®ä¿¡æ¯ã€‚ä¸è¦åšå‡è®¾æˆ–æ¨æ–­ã€‚</span><br><span class="line"></span><br><span class="line">åŸºäºä»¥ä¸‹èŠå¤©å†å²ï¼Œè¯·æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼š&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;ä»å­˜å‚¨ä¸­åŠ è½½è®°å¿†å¹¶ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å›å¤ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line">    existing_memory = store.get(namespace, key)</span><br><span class="line"></span><br><span class="line">    # å¦‚æœå­˜åœ¨åˆ™æå–å®é™…çš„è®°å¿†å†…å®¹å¹¶æ·»åŠ å‰ç¼€</span><br><span class="line">    if existing_memory:</span><br><span class="line">        # å€¼æ˜¯ä¸€ä¸ªå¸¦æœ‰memoryé”®çš„å­—å…¸</span><br><span class="line">        existing_memory_content = existing_memory.value.get(&#x27;memory&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        existing_memory_content = &quot;æœªæ‰¾åˆ°ç°æœ‰è®°å¿†ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=existing_memory_content)</span><br><span class="line">    </span><br><span class="line">    # ä½¿ç”¨è®°å¿†ä»¥åŠèŠå¤©å†å²è¿›è¡Œå›å¤</span><br><span class="line">    response = model.invoke([SystemMessage(content=system_msg)]+state[&quot;messages&quot;])</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;messages&quot;: response&#125;</span><br><span class="line"></span><br><span class="line">def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;åæ€èŠå¤©å†å²å¹¶å°†è®°å¿†ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢ç°æœ‰è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">        </span><br><span class="line">    # æå–è®°å¿†</span><br><span class="line">    if existing_memory:</span><br><span class="line">        existing_memory_content = existing_memory.value.get(&#x27;memory&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        existing_memory_content = &quot;æœªæ‰¾åˆ°ç°æœ‰è®°å¿†ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=existing_memory_content)</span><br><span class="line">    new_memory = model.invoke([SystemMessage(content=system_msg)]+state[&#x27;messages&#x27;])</span><br><span class="line"></span><br><span class="line">    # è¦†ç›–å­˜å‚¨ä¸­çš„ç°æœ‰è®°å¿†</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line"></span><br><span class="line">    # å°†å€¼å†™å…¥ä¸ºå¸¦æœ‰memoryé”®çš„å­—å…¸</span><br><span class="line">    store.put(namespace, key, &#123;&quot;memory&quot;: new_memory.content&#125;)</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å›¾</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;call_model&quot;, call_model)</span><br><span class="line">builder.add_node(&quot;write_memory&quot;, write_memory)</span><br><span class="line">builder.add_edge(START, &quot;call_model&quot;)</span><br><span class="line">builder.add_edge(&quot;call_model&quot;, &quot;write_memory&quot;)</span><br><span class="line">builder.add_edge(&quot;write_memory&quot;, END)</span><br><span class="line"></span><br><span class="line"># ç”¨äºè·¨çº¿ç¨‹çš„é•¿æœŸè®°å¿†å­˜å‚¨</span><br><span class="line">across_thread_memory = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ç”¨äºçº¿ç¨‹å†…çš„çŸ­æœŸè®°å¿†æ£€æŸ¥ç‚¹</span><br><span class="line">within_thread_memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ£€æŸ¥ç‚¹å™¨å’Œå­˜å‚¨ç¼–è¯‘å›¾</span><br><span class="line">graph = builder.compile(checkpointer=within_thread_memory, store=across_thread_memory)</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤ºå›¾</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250725161106319.png" alt="image-20250725161106319"></p>
<p>èŠå¤©å†å²å°†é€šè¿‡æ£€æŸ¥ç‚¹å·¥å…·ä¿å­˜åˆ°çŸ­æœŸè®°å¿†ä¸­ã€‚èŠå¤©æœºå™¨äººå°†å›é¡¾èŠå¤©å†å²ã€‚ç„¶åï¼Œå®ƒå°†åˆ›å»ºå¹¶ä¿å­˜ä¸€ä¸ªè®°å¿†åˆ° <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph Store</a>ã€‚æ­¤å†…å­˜å¯åœ¨æœªæ¥çš„èŠå¤©ä¼šè¯ä¸­è®¿é—®ï¼Œä»¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å“åº”ã€‚</p>
<p>å½“æˆ‘ä»¬ä¸èŠå¤©æœºå™¨äººäº¤äº’æ—¶ï¼Œæˆ‘ä»¬æä¾›ä¸¤æ ·ä¸œè¥¿ï¼š</p>
<ol>
<li><code>Short-term (within-thread) memory</code>: ä¸€ä¸ªç”¨äºæŒä¹…åŒ–èŠå¤©å†å²çš„ <code>thread ID</code>ã€‚  </li>
<li><code>Long-term (cross-thread) memory</code>: ä¸€ä¸ªç”¨äºå°†é•¿æœŸè®°å¿†å‘½åç©ºé—´åˆ°ç”¨æˆ·çš„ <code>user ID</code>ã€‚</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›çº¿ç¨‹IDç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†</span><br><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿† </span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lance&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br><span class="line">    </span><br><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lance</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼ŒLanceï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼ŸğŸ˜Š</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ <code>MemorySaver</code> æ£€æŸ¥ç‚¹æ¥ç®¡ç†çº¿ç¨‹å†…å†…å­˜ã€‚è¿™ä¼šå°†èŠå¤©å†å²ä¿å­˜åˆ°çº¿ç¨‹ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¿å­˜åˆ°çº¿ç¨‹çš„èŠå¤©å†å²è®°å½•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">thread = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line">state = graph.get_state(thread).values</span><br><span class="line">for m in state[&quot;messages&quot;]: </span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å­˜å‚¨åº“ç¼–è¯‘äº†è¯¥å›¾ï¼š<code>across_thread_memory = InMemoryStore()</code>å¹¶ä¸”ï¼Œæˆ‘ä»¬å‘å›¾ä¸­æ·»åŠ äº†ä¸€ä¸ªèŠ‚ç‚¹ (<code>write_memory</code>)ï¼Œè¯¥èŠ‚ç‚¹åæ˜ äº†èŠå¤©å†å²å¹¶ä¿å­˜äº†ä¸€æ®µè®°å¿†åˆ°å­˜å‚¨ä¸­ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å†…å­˜æ˜¯å¦å·²ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†è®¾ç½®å‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">existing_memory = across_thread_memory.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">existing_memory.dict()</span><br><span class="line"></span><br><span class="line">&#123;&#x27;namespace&#x27;: [&#x27;memory&#x27;, &#x27;1&#x27;],</span><br><span class="line"> &#x27;key&#x27;: &#x27;user_memory&#x27;,</span><br><span class="line"> &#x27;value&#x27;: &#123;&#x27;memory&#x27;: &#x27;- å§“åï¼šLance  \n- ä½ç½®ï¼šæ—§é‡‘å±±  \n- å…´è¶£å’Œçˆ±å¥½ï¼šéª‘è‡ªè¡Œè½¦  \n- å–œæ¬¢çš„æ´»åŠ¨ï¼šåœ¨æ—§é‡‘å±±éª‘è¡Œï¼Œå¯èƒ½åŒ…æ‹¬é‡‘é—¨å¤§æ¡¥å’Œæ»¨æµ·åŒºè·¯çº¿&#x27;&#125;,</span><br><span class="line"> &#x27;created_at&#x27;: &#x27;2025-07-25T08:12:35.877160+00:00&#x27;,</span><br><span class="line"> &#x27;updated_at&#x27;: &#x27;2025-07-25T08:12:35.877161+00:00&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥ <strong>ç›¸åŒçš„ç”¨æˆ·ID</strong>å¯åŠ¨ä¸€ä¸ª<strong>æ–°çº¿ç¨‹</strong>ã€‚æˆ‘ä»¬åº”è¯¥çœ‹åˆ°èŠå¤©æœºå™¨äººè®°ä½äº†ç”¨æˆ·çš„ä¸ªäººèµ„æ–™ï¼Œå¹¶å°†å…¶ç”¨äºä¸ªæ€§åŒ–å“åº”ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºè·¨çº¿ç¨‹è®°å¿†ä»¥åŠä¸€ä¸ªæ–°çš„çº¿ç¨‹ID</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;2&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼ä½ æ¨èæˆ‘å»å“ªé‡Œéª‘è‡ªè¡Œè½¦ï¼Ÿ&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<h4 id="Chatbot-with-Profile-Schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº"><a href="#Chatbot-with-Profile-Schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº" class="headerlink" title="Chatbot with Profile Schema å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº"></a><strong>Chatbot with Profile Schema</strong> <strong>å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h4><p>æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººå°†è®°å¿†ä¿å­˜ä¸ºå­—ç¬¦ä¸²ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›è®°å¿†å…·æœ‰ç»“æ„åŒ–æ ¼å¼ã€‚ä¾‹å¦‚ï¼Œè®°å¿†å¯ä»¥æ˜¯<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">å•ä¸ªã€æŒç»­æ›´æ–°çš„æ¨¡å¼ </a>ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™æ˜¯ä¸€ä¸ªå•ä¸€çš„ç”¨æˆ·æ¡£æ¡ˆã€‚</p>
<p>æˆ‘ä»¬å°†æ‰©å±•æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººï¼Œå°†è¯­ä¹‰è®°å¿†ä¿å­˜åˆ°å•ä¸ª<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">ç”¨æˆ·æ¡£æ¡ˆ </a>ä¸­ã€‚æˆ‘ä»¬è¿˜å°†ä»‹ç»ä¸€ä¸ªåº“ <a target="_blank" rel="noopener" href="https://github.com/hinthornw/trustcall">Trustcall</a>ï¼Œç”¨äºä½¿ç”¨æ–°ä¿¡æ¯æ›´æ–°æ­¤æ¨¡å¼ã€‚</p>
<h5 id="Defining-a-user-profile-schema-å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼"><a href="#Defining-a-user-profile-schema-å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼" class="headerlink" title="Defining a user profile schema å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼"></a><strong>Defining a user profile schema</strong> <strong>å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼</strong></h5><p>Python æœ‰è®¸å¤šä¸åŒç±»å‹çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#schema-definition">structured data</a>ï¼Œä¾‹å¦‚ TypedDictã€å­—å…¸ã€JSON å’Œ <a target="_blank" rel="noopener" href="https://docs.pydantic.dev/latest/">Pydantic</a>ã€‚</p>
<p>è®©æˆ‘ä»¬å…ˆä½¿ç”¨ TypedDict æ¥å®šä¹‰ä¸€ä¸ªç”¨æˆ·èµ„æ–™æ¨¡å¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from typing import TypedDict, List</span><br><span class="line"></span><br><span class="line">class UserProfile(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;å¸¦æœ‰ç±»å‹å­—æ®µçš„ç”¨æˆ·æ¡£æ¡ˆæ¨¡å¼&quot;&quot;&quot;</span><br><span class="line">    user_name: str  # ç”¨æˆ·çš„é¦–é€‰åç§°</span><br><span class="line">    interests: List[str]  # ç”¨æˆ·å…´è¶£åˆ—è¡¨</span><br></pre></td></tr></table></figure>
<h5 id="Saving-a-schema-to-the-store-å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­"><a href="#Saving-a-schema-to-the-store-å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­" class="headerlink" title="Saving a schema to the store å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­"></a><strong>Saving a schema to the store</strong> <strong>å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­</strong></h5><p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph Store</a> æ¥å—ä»»ä½• Python å­—å…¸ä½œä¸º <code>value</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># TypedDict å®ä¾‹</span><br><span class="line">user_profile: UserProfile = &#123;</span><br><span class="line">    &quot;user_name&quot;: &quot;Lance&quot;,  # ç”¨æˆ·å</span><br><span class="line">    &quot;interests&quot;: [&quot;éª‘è¡Œ&quot;, &quot;ç§‘æŠ€&quot;, &quot;å’–å•¡&quot;]  # å…´è¶£çˆ±å¥½</span><br><span class="line">&#125;</span><br><span class="line">user_profile</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.put">put</a> æ–¹æ³•å°† TypedDict ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">from langgraph.store.memory import InMemoryStore</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–å†…å­˜å­˜å‚¨</span><br><span class="line">in_memory_store = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†åˆ›å»ºå‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace_for_memory = (user_id, &quot;memory&quot;)</span><br><span class="line"></span><br><span class="line"># å°†è®°å¿†ä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ°å‘½åç©ºé—´ä¸­</span><br><span class="line">key = &quot;user_profile&quot;</span><br><span class="line">value = user_profile</span><br><span class="line">in_memory_store.put(namespace_for_memory, key, value)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.search">search</a> æŒ‰å‘½åç©ºé—´ä»å­˜å‚¨ä¸­æ£€ç´¢å¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for m in in_memory_store.search(namespace_for_memory):</span><br><span class="line">    print(m.dict())</span><br><span class="line">    </span><br><span class="line">&#123;&#x27;namespace&#x27;: [&#x27;1&#x27;, &#x27;memory&#x27;], &#x27;key&#x27;: &#x27;user_profile&#x27;, &#x27;value&#x27;: &#123;&#x27;user_name&#x27;: &#x27;Lance&#x27;, &#x27;interests&#x27;: [&#x27;éª‘è¡Œ&#x27;, &#x27;ç§‘æŠ€&#x27;, &#x27;å’–å•¡&#x27;]&#125;, &#x27;created_at&#x27;: &#x27;2025-07-25T08:58:06.031770+00:00&#x27;, &#x27;updated_at&#x27;: &#x27;2025-07-25T08:58:06.031775+00:00&#x27;, &#x27;score&#x27;: None&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.get">get</a> é€šè¿‡å‘½åç©ºé—´å’Œé”®æ¥æ£€ç´¢ç‰¹å®šå¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">profile = in_memory_store.get(namespace_for_memory, &quot;user_profile&quot;)</span><br><span class="line">profile.value</span><br><span class="line"></span><br><span class="line">&#123;&#x27;user_name&#x27;: &#x27;Lance&#x27;, &#x27;interests&#x27;: [&#x27;éª‘è¡Œ&#x27;, &#x27;ç§‘æŠ€&#x27;, &#x27;å’–å•¡&#x27;]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Chatbot-with-profile-schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº"><a href="#Chatbot-with-profile-schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº" class="headerlink" title="Chatbot with profile schema å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº"></a><strong>Chatbot with profile schema</strong> <strong>å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h5><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•ä¸ºè®°å¿†æŒ‡å®šä¸€ä¸ªæ¨¡å¼ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¦‚ä½•æ ¹æ®è¿™ä¸ªç‰¹å®šçš„æ¨¡å¼ <strong>åˆ›å»º</strong> è®°å¿†ï¼Ÿ</p>
<p>åœ¨æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººä¸­ï¼Œæˆ‘ä»¬ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">æƒ³è¦ä»ä¸€ä¸ªèŠå¤©é‡Œåˆ›å»ºè®°å¿†</a>.è¿™å°±æ˜¯ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#recommended-usage">structured outputsæ ¼å¼åŒ–è¾“å‡º</a> æ¦‚å¿µæœ‰ç”¨çš„åœ°æ–¹ã€‚</p>
<p>LangChain çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/chat_models/">chat model</a> æ¥å£æœ‰ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#recommended-usage">PROTECTED$11$</a> æ–¹æ³•ç”¨äºå¼ºåˆ¶ç»“æ„åŒ–è¾“å‡ºã€‚è¿™åœ¨æˆ‘ä»¬éœ€è¦ç¡®ä¿è¾“å‡ºç¬¦åˆæŸä¸ªæ¨¡å¼æ—¶éå¸¸æœ‰ç”¨ï¼Œè€Œä¸”å®ƒä¼šä¸ºæˆ‘ä»¬è§£æè¾“å‡ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å°†æ¨¡å¼ç»‘å®šåˆ°æ¨¡å‹</span><br><span class="line">model_with_structure = model.with_structured_output(UserProfile)</span><br><span class="line"></span><br><span class="line"># è°ƒç”¨æ¨¡å‹ç”Ÿæˆç¬¦åˆæ¨¡å¼çš„ç»“æ„åŒ–è¾“å‡º</span><br><span class="line">structured_output = model_with_structure.invoke([HumanMessage(&quot;æˆ‘çš„åå­—æ˜¯Lanceï¼Œæˆ‘å–œæ¬¢éª‘è‡ªè¡Œè½¦ã€‚&quot;)])</span><br><span class="line">structured_output</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Structured outputsï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰<br>æŒ‡è®©å¤§æ¨¡å‹<strong>ä¸å†â€œéšæ„è¯´äººè¯â€</strong>ï¼Œè€Œæ˜¯<strong>æŒ‰ä½ äº‹å…ˆå®šä¹‰å¥½çš„æ ¼å¼ï¼ˆJSON / è¡¨æ ¼ / æšä¸¾ / åµŒå¥—å¯¹è±¡ç­‰ï¼‰ç²¾ç¡®è¿”å›æ•°æ®</strong>ã€‚ç›¸å½“äºç»™æ¨¡å‹å¥—äº†ä¸€ä¸ªâ€œæ¨¡å…·â€ï¼Œä¿è¯è¾“å‡ºå¯ç›´æ¥è¢«ä»£ç è§£æã€å…¥åº“æˆ–ä¼ ç»™ä¸‹æ¸¸ç³»ç»Ÿï¼Œé¿å…å†ç”¨æ­£åˆ™ã€å­—ç¬¦ä¸²æ‹¼æ¥å»â€œçŒœâ€ç»“æœã€‚</p>
<p>ä½¿ç”¨å®˜æ–¹çš„å¤§æ¨¡å‹ç»„ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from langchain_community.chat_models import ChatTongyi</span><br><span class="line">model=ChatTongyi(</span><br><span class="line">    model=&quot;qwen-plus-2025-07-14&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨èŠå¤©æœºå™¨äººä¸­ä½¿ç”¨å®ƒã€‚è¿™åªéœ€è¦å¯¹ <code>write_memory</code> å‡½æ•°è¿›è¡Œè½»å¾®ä¿®æ”¹ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>model_with_structure</code>ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæ¥ç”Ÿæˆä¸€ä¸ªä¸æˆ‘ä»¬æ¨¡å¼åŒ¹é…çš„é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.graph import StateGraph, MessagesState, START, END</span><br><span class="line">from langgraph.store.base import BaseStore</span><br><span class="line"></span><br><span class="line">from langchain_core.messages import HumanMessage, SystemMessage, AIMessage</span><br><span class="line">from langchain_core.runnables.config import RunnableConfig</span><br><span class="line"></span><br><span class="line"># èŠå¤©æœºå™¨äººæŒ‡ä»¤</span><br><span class="line">MODEL_SYSTEM_MESSAGE = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰è®°å¿†åŠŸèƒ½çš„ helpful åŠ©æ‰‹ï¼Œå¯ä»¥æä¾›å…³äºç”¨æˆ·çš„ä¿¡æ¯ã€‚</span><br><span class="line">å¦‚æœä½ æœ‰è¿™ä¸ªç”¨æˆ·çš„è®°å¿†ï¼Œè¯·ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯è®°å¿†å†…å®¹ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># æ ¹æ®èŠå¤©å†å²å’Œä»»ä½•ç°æœ‰è®°å¿†åˆ›å»ºæ–°è®°å¿†</span><br><span class="line">CREATE_MEMORY_INSTRUCTION = &quot;&quot;&quot;æ ¹æ®ç”¨æˆ·çš„èŠå¤©å†å²åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆè®°å¿†ã€‚</span><br><span class="line">è¿™å°†è¢«ä¿å­˜ä¸ºé•¿æœŸè®°å¿†ã€‚å¦‚æœå­˜åœ¨ç°æœ‰è®°å¿†ï¼Œåªéœ€æ›´æ–°å®ƒã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯ç°æœ‰è®°å¿†ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;ä»å­˜å‚¨ä¸­åŠ è½½è®°å¿†å¹¶ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å›å¤ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line"></span><br><span class="line">    # ä¸ºç³»ç»Ÿæç¤ºæ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    if existing_memory and existing_memory.value:</span><br><span class="line">        memory_dict = existing_memory.value</span><br><span class="line">        formatted_memory = (</span><br><span class="line">            f&quot;å§“å: &#123;memory_dict.get(&#x27;user_name&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;\n&quot;</span><br><span class="line">            f&quot;å…´è¶£: &#123;&#x27;, &#x27;.join(memory_dict.get(&#x27;interests&#x27;, []))&#125;&quot;</span><br><span class="line">        )</span><br><span class="line">    else:</span><br><span class="line">        formatted_memory = None</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=formatted_memory)</span><br><span class="line"></span><br><span class="line">    # ä½¿ç”¨è®°å¿†ä»¥åŠèŠå¤©å†å²æ¥å›å¤</span><br><span class="line">    response = model.invoke([SystemMessage(content=system_msg)]+state[&quot;messages&quot;])</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;messages&quot;: response&#125;</span><br><span class="line"></span><br><span class="line">def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;åæ€èŠå¤©å†å²å¹¶å°†è®°å¿†ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢ç°æœ‰è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line"></span><br><span class="line">    # ä¸ºç³»ç»Ÿæç¤ºæ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    if existing_memory and existing_memory.value:</span><br><span class="line">        memory_dict = existing_memory.value</span><br><span class="line">        formatted_memory = (</span><br><span class="line">            f&quot;å§“å: &#123;memory_dict.get(&#x27;user_name&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;\n&quot;</span><br><span class="line">            f&quot;å…´è¶£: &#123;&#x27;, &#x27;.join(memory_dict.get(&#x27;interests&#x27;, []))&#125;&quot;</span><br><span class="line">        )</span><br><span class="line">    else:</span><br><span class="line">        formatted_memory = None</span><br><span class="line">        </span><br><span class="line">    # åœ¨æŒ‡ä»¤ä¸­æ ¼å¼åŒ–ç°æœ‰è®°å¿†</span><br><span class="line">    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=formatted_memory)</span><br><span class="line"></span><br><span class="line">    # è°ƒç”¨æ¨¡å‹ç”Ÿæˆç¬¦åˆæ¨¡å¼çš„ç»“æ„åŒ–è¾“å‡º</span><br><span class="line">    new_memory = model_with_structure.invoke([SystemMessage(content=system_msg)]+state[&#x27;messages&#x27;])</span><br><span class="line"></span><br><span class="line">    # è¦†ç›–ç°æœ‰çš„ç”¨æˆ·æ¡£æ¡ˆè®°å¿†</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line">    store.put(namespace, key, new_memory)</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å›¾</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;call_model&quot;, call_model)</span><br><span class="line">builder.add_node(&quot;write_memory&quot;, write_memory)</span><br><span class="line">builder.add_edge(START, &quot;call_model&quot;)</span><br><span class="line">builder.add_edge(&quot;call_model&quot;, &quot;write_memory&quot;)</span><br><span class="line">builder.add_edge(&quot;write_memory&quot;, END)</span><br><span class="line"></span><br><span class="line"># ç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿†çš„å­˜å‚¨</span><br><span class="line">across_thread_memory = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†çš„æ£€æŸ¥ç‚¹</span><br><span class="line">within_thread_memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ£€æŸ¥ç‚¹å’Œå­˜å‚¨ç¼–è¯‘å›¾</span><br><span class="line">graph = builder.compile(checkpointer=within_thread_memory, store=across_thread_memory)</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤º</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250726103516996.png" alt="image-20250726103516996"></p>
<p>è°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›çº¿ç¨‹IDç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†</span><br><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿† </span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lanceï¼Œæˆ‘å–œæ¬¢åœ¨æ—§é‡‘å±±éª‘è‡ªè¡Œè½¦å’Œåœ¨é¢åŒ…åº—åƒé¥­ã€‚&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è®°å¿†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Namespace for the memory to save</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">existing_memory = across_thread_memory.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">existing_memory.value</span><br></pre></td></tr></table></figure>
<h5 id="Trustcall-for-creating-and-updating-profile-schemas-Trustcall-ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼"><a href="#Trustcall-for-creating-and-updating-profile-schemas-Trustcall-ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼" class="headerlink" title="Trustcall for creating and updating profile schemas Trustcall ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼"></a><strong>Trustcall for creating and updating profile schemas</strong> <strong>Trustcall ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼</strong></h5><p>Trustcall æ˜¯ä¸€ä¸ªç”± LangChain å›¢é˜Ÿå¼€å‘çš„å¼€æº Python åº“ï¼Œæ—¨åœ¨<strong>è§£å†³å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœ¨ç”Ÿæˆæˆ–ä¿®æ”¹å¤æ‚ JSON æ•°æ®ç»“æ„æ—¶æ•ˆç‡ä½ã€æ˜“å‡ºé”™çš„é—®é¢˜</strong>ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>create_extractor</code>ï¼Œä¼ å…¥æ¨¡å‹ä»¥åŠæˆ‘ä»¬çš„æ¨¡å¼ä½œä¸º <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/tools/">tool</a>ã€‚ä½¿ç”¨ TrustCall æ—¶ï¼Œå¯ä»¥ä»¥å¤šç§æ–¹å¼æä¾›æ¨¡å¼ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ª JSON å¯¹è±¡ / Python å­—å…¸æˆ– Pydantic æ¨¡å‹ã€‚åœ¨åº•å±‚ï¼ŒTrustCall ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/tool_calling/">tool calling</a> ä»è¾“å…¥çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/messages/">messages</a> åˆ—è¡¨ä¸­ç”Ÿæˆ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/">structured output</a>ã€‚ä¸ºäº†å¼ºåˆ¶ Trustcall ç”Ÿæˆ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/">structured output</a>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>tool_choice</code> å‚æ•°ä¸­åŒ…å«æ¨¡å¼åç§°ã€‚</p>
<p>æˆ‘ä»…åšäº†è§£äº†ï¼Œæ„Ÿè§‰ç”¨å¤„ä¸å¤šï¼Œç”¨ç»“æœåŒ–è¾“å‡ºå°±èƒ½è¾¾åˆ°æ•ˆæœ</p>
<h4 id="Chatbot-with-Collection-Schema-å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº"><a href="#Chatbot-with-Collection-Schema-å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº" class="headerlink" title="Chatbot with Collection Schema å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº"></a><strong>Chatbot with Collection Schema</strong> <strong>å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h4><p><strong>â€œcollectionâ€</strong> æŒ‡çš„æ˜¯ä¸€ç§<strong>å°†è¯­ä¹‰è®°å¿†ç»„ç»‡ä¸ºå¤šä¸ªç‹¬ç«‹æ–‡æ¡£ï¼ˆobjectsï¼‰çš„å­˜å‚¨æ–¹å¼</strong>ï¼Œè€Œä¸æ˜¯æŠŠæ‰€æœ‰ä¿¡æ¯éƒ½å¡è¿›ä¸€ä¸ªå·¨å¤§çš„â€œç”¨æˆ·æ¡£æ¡ˆâ€ï¼ˆsingle profileï¼‰é‡Œã€‚</p>
<p>å‡è®¾ä½ åœ¨åšä¸€ä¸ª AI åŠ©æ‰‹ï¼Œç”¨æˆ·è¯´ï¼š</p>
<blockquote>
<p>â€œæˆ‘ä¸‹å‘¨è¦å»ä¸œäº¬å‡ºå·®ï¼Œä½åœ¨æ¶©è°·åŒºçš„ Sakura Hotelã€‚â€<br>â€œæˆ‘æœ‹å‹ Ken ä¹Ÿè¦æ¥ï¼Œä»–å–œæ¬¢åƒæ‹‰é¢ã€‚â€</p>
</blockquote>
<p>å¦‚æœç”¨ <strong>collection</strong>ï¼Œä½ ä¼šå­˜æˆä¸¤æ¡è®°å¿†ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trip&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tokyo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-08-04&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hotel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sakura Hotel, Shibuya&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;friend&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ken&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;food_preference&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ramen&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>æ¯æ¡è®°å¿†éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹æ–‡æ¡£ï¼Œåç»­ä½ å¯ä»¥ï¼š</p>
<ul>
<li>æœç´¢â€œtripâ€ç±»å‹çš„è®°å¿†ï¼Œæ‰¾åˆ°ç”¨æˆ·çš„å‡ºå·®å®‰æ’ï¼›</li>
<li>æœç´¢â€œfriendâ€ç±»å‹çš„è®°å¿†ï¼Œæ‰¾åˆ° Ken çš„åå¥½ï¼›</li>
<li>æ›´æ–° Ken çš„ä¿¡æ¯æ—¶ï¼Œ<strong>åªæ”¹ä¸€æ¡è®°å½•</strong>ï¼Œä¸ä¼šå½±å“å…¶å®ƒè®°å¿†ã€‚</li>
</ul>
<h4 id="Memory-Agent-å†…å­˜ä»£ç†"><a href="#Memory-Agent-å†…å­˜ä»£ç†" class="headerlink" title="Memory Agent å†…å­˜ä»£ç†"></a><strong>Memory Agent</strong> <strong>å†…å­˜ä»£ç†</strong></h4><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†æŠŠå­¦åˆ°çš„å†…å®¹æ•´åˆèµ·æ¥ï¼Œæ„å»ºä¸€ä¸ªå…·æœ‰é•¿æœŸè®°å¿†çš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/agentic_concepts/">agent</a>ã€‚</p>
<p>æˆ‘ä»¬çš„ä»£ç† <code>task_mAIstro</code> å°†å¸®åŠ©æˆ‘ä»¬ç®¡ç†å¾…åŠäº‹é¡¹åˆ—è¡¨ï¼</p>
<p>æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„èŠå¤©æœºå™¨äºº <strong>å§‹ç»ˆ</strong> ä¼šåæ€å¯¹è¯å¹¶ä¿å­˜è®°å¿†ã€‚<code>task_mAIstro</code> å°†å†³å®š <strong>ä½•æ—¶</strong> ä¿å­˜è®°å¿†ï¼ˆå¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­çš„é¡¹ç›®ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„èŠå¤©æœºå™¨äººå§‹ç»ˆä¿å­˜ä¸€ç§ç±»å‹çš„è®°å¿†ï¼Œå³ä¸ªäººèµ„æ–™æˆ–é›†åˆã€‚<code>task_mAIstro</code> å¯ä»¥å†³å®šå°†æ•°æ®ä¿å­˜åˆ°ç”¨æˆ·ä¸ªäººèµ„æ–™æˆ– ToDo äº‹é¡¹é›†åˆä¸­ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>task_mAIstro</code> è¿˜å°†ç®¡ç†ç¨‹åºæ€§è®°å¿†ã€‚è¿™å…è®¸ç”¨æˆ·æ›´æ–°åˆ›å»ºToDoé¡¹çš„åå¥½è®¾ç½®ã€‚</p>
<h5 id="Creating-an-agent-åˆ›å»ºä¸€ä¸ªä»£ç†"><a href="#Creating-an-agent-åˆ›å»ºä¸€ä¸ªä»£ç†" class="headerlink" title="Creating an agent åˆ›å»ºä¸€ä¸ªä»£ç†"></a><strong>Creating an agent</strong> <strong>åˆ›å»ºä¸€ä¸ªä»£ç†</strong></h5><p>æœ‰è®¸å¤šä¸åŒçš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/high_level/">agent</a> æ¶æ„å¯ä¾›é€‰æ‹©ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„å†…å®¹ï¼Œä¸€ä¸ª <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/agentic_concepts/#react-implementation">ReAct</a> ä»£ç†ã€‚è¿™ä¸ªä»£ç†å°†æˆä¸ºåˆ›å»ºå’Œç®¡ç†å¾…åŠäº‹é¡¹åˆ—è¡¨çš„å¾—åŠ›åŠ©æ‰‹ã€‚</p>
<p>æ­¤ä»£ç†å¯ä»¥å†³å®šæ›´æ–°ä¸‰ç§ç±»å‹çš„é•¿æœŸè®°å¿†ï¼š</p>
<p>(a) åˆ›å»ºæˆ–æ›´æ–°å…·æœ‰æ™®é€šç”¨æˆ·ä¿¡æ¯çš„ç”¨æˆ· <code>profile</code></p>
<p>(b) åœ¨ToDoåˆ—è¡¨ä¸­æ·»åŠ æˆ–æ›´æ–°é¡¹ç›® <code>collection</code></p>
<p>(c) æ›´æ–°å…¶è‡ªèº«çš„ <code>instructions</code> ä»¥äº†è§£å¦‚ä½•æ›´æ–°å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­çš„é¡¹ç›®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from typing import TypedDict, Literal</span><br><span class="line"></span><br><span class="line"># æ›´æ–°è®°å¿†å·¥å…·</span><br><span class="line">class UpdateMemory(TypedDict):</span><br><span class="line">    &quot;&quot;&quot; å†³å®šæ›´æ–°å“ªç§è®°å¿†ç±»å‹ &quot;&quot;&quot;</span><br><span class="line">    update_type: Literal[&#x27;user&#x27;, &#x27;todo&#x27;, &#x27;instructions&#x27;]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>&#39;user&#39;</code>ï¼šç”¨æˆ·ç›¸å…³ä¿¡æ¯</li>
<li><code>&#39;todo&#39;</code>ï¼šå¾…åŠäº‹é¡¹</li>
<li><code>&#39;instructions&#39;</code>ï¼šæŒ‡ä»¤ä¿¡æ¯</li>
</ul>
</blockquote>
<h5 id="Graph-definition-å›¾å®šä¹‰"><a href="#Graph-definition-å›¾å®šä¹‰" class="headerlink" title="Graph definition å›¾å®šä¹‰"></a><strong>Graph definition</strong> <strong>å›¾å®šä¹‰</strong></h5><p>æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªç®€å•çš„è·¯ç”±å™¨ <code>route_message</code>ï¼Œå®ƒé€šè¿‡äºŒå…ƒå†³ç­–æ¥èŠ‚çœå†…å­˜ã€‚</p>
<h3 id="module-6"><a href="#module-6" class="headerlink" title="module-6"></a>module-6</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/21/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/Retrieval/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/21/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/Retrieval/" class="post-title-link" itemprop="url">Retrieval</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-21 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-21T00:00:00+08:00">2025-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-05 10:41:56" itemprop="dateModified" datetime="2025-08-05T10:41:56+08:00">2025-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">å®ä¹ </span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">æ™¨æ™Ÿæ™ºæ§</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="elastic-search"><a href="#elastic-search" class="headerlink" title="elastic search"></a>elastic search</h3><p>Elasticsearch æ˜¯å½“ä»Šæœ€æµè¡Œçš„ <strong>å¼€æºåˆ†å¸ƒå¼æœç´¢ä¸åˆ†æå¼•æ“</strong>ï¼Œç”¨ Java å¼€å‘ï¼ŒåŸºäº <strong>Apache Lucene</strong> æ„å»ºã€‚å®ƒæŠŠ<strong>å…¨æ–‡æ£€ç´¢ã€å®æ—¶åˆ†æã€æ—¶åºæ•°æ®ã€åœ°ç†ç©ºé—´æŸ¥è¯¢</strong>å’Œ<strong>å‘é‡æ£€ç´¢</strong>ç»Ÿä¸€åˆ°ä¸€ä¸ªå¹³å°ï¼Œè¢«å¹¿æ³›ç”¨äºæ—¥å¿—ã€æŒ‡æ ‡ã€å®‰å…¨ã€ä¼ä¸šæœç´¢ä»¥åŠ AI/RAG åœºæ™¯ã€‚</p>
<p> RAG ç³»ç»Ÿä¸­ï¼Œ<strong>Elasticsearch ä¸ä»…æ˜¯å‘é‡æ•°æ®åº“ï¼Œæ›´æ˜¯è¯­ä¹‰æ£€ç´¢å¼•æ“å’Œä¸Šä¸‹æ–‡æ„å»ºå™¨</strong>ï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯<strong>å‘é‡æ•°æ®åº“ + å…¨æ–‡æ£€ç´¢å¼•æ“</strong>çš„æ··åˆè§’è‰²ã€‚</p>
<h4 id="æŸ¥æ‰¾è¯­å¥"><a href="#æŸ¥æ‰¾è¯­å¥" class="headerlink" title="æŸ¥æ‰¾è¯­å¥"></a>æŸ¥æ‰¾è¯­å¥</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET /test_full_v1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;é«˜å‹æ—è·¯ç®¡é“ç£ç²‰æ£€æµ‹ä½¿ç”¨çš„æ˜¯å“ªç§ç£åŒ–æ–¹æ³•å’Œç£æ‚¬æ¶²æµ“åº¦ï¼Ÿ&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;text&quot;, &quot;report_name&quot;,&quot;report_url&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_cat/indices?v#æŸ¥çœ‹æ‰€æœ‰çš„æ‰€æœ‰</span><br><span class="line"></span><br><span class="line">GET test_full_v1/_count#æŸ¥çœ‹æ–‡ä»¶æ•°</span><br><span class="line"></span><br><span class="line">GET test_full_v1/_mapping#æŸ¥çœ‹æ˜ å°„</span><br><span class="line"></span><br><span class="line">GET test_full_v1#æŸ¥çœ‹ç´¢å¼•å†…å®¹</span><br><span class="line"></span><br><span class="line">GET test_full_v1/_search#æŸ¥çœ‹ç´¢å¼•å†…å®¹</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_cat/indices/zxj_test#æŸ¥çœ‹ç´¢å¼•æ˜¯å¦å­˜åœ¨</span><br></pre></td></tr></table></figure>
<p>å¯è§†åŒ–å¹³å°kibanaçš„å†…ç½‘è·¯å¾„ï¼š</p>
<ul>
<li><code>http://10.117.128.50:5601</code></li>
<li><a target="_blank" rel="noopener" href="http://10.117.128.50:5601/app/dev_tools#/console/shell">http://10.117.128.50:5601/app/dev_tools#/console/shell</a> å¼€å‘è€…å·¥å…·</li>
</ul>
<h4 id="esæ”¯æŒçš„å‡ ç§æ£€ç´¢å‡½æ•°"><a href="#esæ”¯æŒçš„å‡ ç§æ£€ç´¢å‡½æ•°" class="headerlink" title="esæ”¯æŒçš„å‡ ç§æ£€ç´¢å‡½æ•°"></a>esæ”¯æŒçš„å‡ ç§æ£€ç´¢å‡½æ•°</h4><h5 id="å‘é‡æœç´¢"><a href="#å‘é‡æœç´¢" class="headerlink" title="å‘é‡æœç´¢"></a>å‘é‡æœç´¢</h5><p>è¿™é‡Œçš„å‘é‡æœç´¢ä¹Ÿå°±æ˜¯ç¨ å¯†å‘é‡æ£€ç´¢ï¼Œè¿‡ç¨‹ä¸º<strong>â€œæŠŠæ–‡æœ¬/å›¾åƒç­‰éç»“æ„åŒ–æ•°æ®æ˜ å°„æˆé«˜ç»´å‘é‡ â†’ åœ¨å‘é‡ç©ºé—´é‡Œåšè¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æœç´¢ â†’ æŒ‰ç›¸ä¼¼åº¦æ’åºè¿”å›ç»“æœâ€</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def vector_query(search_query: str):</span><br><span class="line">    # ä½¿ç”¨ä¸ç´¢å¼•æ—¶ç›¸åŒçš„åµŒå…¥æ¨¡å‹å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡</span><br><span class="line">    vector = embeddings.embed_query(search_query)</span><br><span class="line">    </span><br><span class="line">    # æ„å»ºElasticsearch KNNæŸ¥è¯¢ç»“æ„</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;knn&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: dense_vector_field,      # æŒ‡å®šå­˜å‚¨å‘é‡çš„å­—æ®µå</span><br><span class="line">            &quot;query_vector&quot;: vector,           # æŸ¥è¯¢å‘é‡</span><br><span class="line">            &quot;k&quot;: 5,                          # è¿”å›æœ€ç›¸ä¼¼çš„5ä¸ªç»“æœ</span><br><span class="line">            &quot;num_candidates&quot;: 10,            # åœ¨10ä¸ªå€™é€‰ä¸­é€‰æ‹©æœ€ä¼˜çš„5ä¸ªï¼ˆæé«˜æœç´¢æ•ˆç‡å’Œå‡†ç¡®æ€§ï¼‰</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="bm25"><a href="#bm25" class="headerlink" title="bm25"></a>bm25</h5><p>BM25ï¼ˆ<strong>Best Matching 25</strong>ï¼‰ä¹Ÿå°±æ˜¯å…¨æ–‡å…³é”®è¯æœç´¢ï¼Œæˆ–è€…å«ä¼ ç»Ÿå…³é”®è¯æœç´¢ï¼Œä»–çš„æ ¸å¿ƒæ€æƒ³ä¸º<strong>â€œè¯é¢‘è¶Šé«˜ã€æ–‡æ¡£è¶ŠçŸ­ã€è¯è¶Šç¨€æœ‰ï¼Œåˆ™ç›¸å…³æ€§è¶Šé«˜â€</strong>ï¼Œåœ¨ TF-IDF çš„åŸºç¡€ä¸Šå¼•å…¥è¯é¢‘é¥±å’Œã€æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–ä¸¤é¡¹ä¿®æ­£ã€‚</p>
<blockquote>
<p>TF-IDFï¼ˆ<strong>Term Frequencyâ€“Inverse Document Frequencyï¼Œè¯é¢‘-é€†æ–‡æ¡£é¢‘ç‡</strong>ï¼‰æ˜¯ä¸€ç§ç»å…¸çš„ <strong>æ–‡æœ¬ç‰¹å¾æƒé‡è®¡ç®—æ–¹æ³•</strong>ï¼Œç”¨äºè¡¡é‡ <strong>ä¸€ä¸ªè¯å¯¹ä¸€ç¯‡æ–‡æ¡£çš„é‡è¦æ€§</strong>ã€‚</p>
</blockquote>
<p>é¡¹ç›®ä¸­çš„bm25æ£€ç´¢é‡‡å–å¤šå­—æ®µåŒ¹é…çš„æ–¹å¼ï¼Œè¿˜æœ‰å‡ ä¸ªå‚æ•°éœ€è¦äº†è§£ï¼Œå¦‚ä¸‹</p>
<ol>
<li><p><strong>â€˜typeâ€™</strong> :å†³å®šäº†<strong>å¦‚ä½•æŠŠå¤šä¸ªå­—æ®µçš„ BM25 æ‰“åˆ†åˆå¹¶æˆæœ€ç»ˆå¾—åˆ†</strong>,å¸¸ç”¨çš„å‚æ•°æœ‰ä»¥ä¸‹ä¸‰ç§</p>
<p>| type                    | ä¸­æ–‡å«ä¹‰     | æ‰“åˆ†é€»è¾‘                                                     |<br>| :â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” | :â€”â€”â€”â€”â€”- | :â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- |<br>| <strong>best_fields</strong>ï¼ˆé»˜è®¤ï¼‰ | æœ€ä½³å­—æ®µä¼˜å…ˆ | å– <strong>å¾—åˆ†æœ€é«˜çš„é‚£ä¸ªå­—æ®µ</strong> åšæœ€ç»ˆåˆ†ï¼ˆå¯ç”¨ <code>tie_breaker</code> è®©æ¬¡ä½³å­—æ®µå†è´¡çŒ®ä¸€ç‚¹ç‚¹ï¼‰ã€‚ |<br>| <strong>most_fields</strong>         | æœ€å¤šå­—æ®µä¼˜å…ˆ | æŠŠæ‰€æœ‰å‘½ä¸­å­—æ®µçš„å¾—åˆ† <strong>ç›´æ¥ç›¸åŠ </strong>ï¼ˆç±»ä¼¼ OR é€»è¾‘ï¼‰ï¼Œå­—æ®µè¶Šå¤šåˆ†è¶Šé«˜ã€‚ |<br>| <strong>cross_fields</strong>        | è·¨å­—æ®µåˆå¹¶   | æŠŠå¤šä¸ªå­—æ®µè§†ä¸º <strong>ä¸€ä¸ªè™šæ‹Ÿå¤§å­—æ®µ</strong>ï¼Œç»Ÿä¸€è®¡ç®— TF å’Œ IDFï¼Œè§£å†³â€œå…³é”®è¯åˆ†æ•£åœ¨ä¸åŒå­—æ®µâ€é—®é¢˜ã€‚ |</p>
</li>
<li><p><strong><code>&#39;tie_breaker&#39;</code></strong>ï¼šå½“å¤šä¸ªå­—æ®µéƒ½åŒ¹é…æ—¶ï¼Œ<strong>â€œæœ€ä½³å­—æ®µâ€å¾—åˆ† + å…¶ä½™å­—æ®µå¾—åˆ†Ã—tie_breaker</strong> ä½œä¸ºæœ€ç»ˆå¾—åˆ†ã€‚</p>
</li>
<li><strong><code>&#39;operator&#39;</code></strong>:æ§åˆ¶<strong>å•ä¸ªå­—æ®µå†…</strong>çš„å¤šä¸ªè¯é¡¹æ˜¯â€œANDâ€è¿˜æ˜¯â€œORâ€å…³ç³»ã€‚<ul>
<li><strong><code>&quot;AND&quot;</code></strong><br>è¦æ±‚<strong>åŒä¸€ä¸ªå­—æ®µ</strong>å¿…é¡»åŒæ—¶åŒ…å«æ‰€æœ‰æŸ¥è¯¢è¯ï¼Œå‡å°‘å™ªéŸ³ï¼Œæé«˜ç²¾å‡†åº¦ã€‚é€‚åˆåœ°å€ã€å§“åç­‰è·¨å­—æ®µä¸¥æ ¼åŒ¹é…ã€‚</li>
<li><strong><code>&quot;OR&quot;</code></strong><br>åªè¦å­—æ®µé‡Œå‡ºç°ä»»æ„ä¸€ä¸ªè¯å°±åŒ¹é…ï¼Œå¬å›é‡å¤§ï¼Œä½†å¯èƒ½å¼•å…¥ä¸ç›¸å…³ç»“æœã€‚</li>
</ul>
</li>
</ol>
<p>æœ€åï¼Œæ¯ä¸ªå­—æ®µè¿˜å¯ä»¥äººå·¥è®¾ç½®æƒé‡ï¼Œå¦‚<code>&quot;fields&quot;: [&quot;title^3&quot;, &quot;content&quot;, &quot;tags^2&quot;]</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def bm25_query(search_query: str):</span><br><span class="line">    # ä½¿ç”¨BM25ç®—æ³•è¿›è¡Œä¼ ç»Ÿå…³é”®è¯åŒ¹é…</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;query&quot;: &#123;</span><br><span class="line">            &quot;multi_match&quot;: &#123;  # å¤šå­—æ®µåŒ¹é…æŸ¥è¯¢</span><br><span class="line">                &quot;query&quot;: search_query,</span><br><span class="line">                &quot;fields&quot;: [&quot;text&quot;, &quot;report_name&quot;, &quot;report_url&quot;]  # åœ¨è¿™äº›å­—æ®µä¸­æœç´¢</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;size&quot;: 8,  # è¿”å›æœ€å¤š8ä¸ªç»“æœ</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="æ··åˆæ£€ç´¢"><a href="#æ··åˆæ£€ç´¢" class="headerlink" title="æ··åˆæ£€ç´¢"></a>æ··åˆæ£€ç´¢</h5><p>æ··åˆæ£€ç´¢ä¹Ÿå°±æ˜¯ <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rrf.html">Reciprocal Rank Fusion</a>ï¼ˆRRFï¼‰ï¼Œé€šè¿‡ç»“åˆå‘é‡æœç´¢å’Œ BM25 æœç´¢çš„ç»“æœç»¼åˆåˆ¤æ–­ã€‚</p>
<p>ä½†ç”±äºesä¸­æ··åˆæ£€ç´¢éœ€è¦ä»˜è´¹ä½¿ç”¨ï¼Œåç»­æ£€ç´¢æ•ˆæœè¯„ä¼°æ—¶ä¸åšæµ‹è¯•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">def hybrid_query(search_query: str):</span><br><span class="line">    # ä½¿ç”¨ä¸ç´¢å¼•æ—¶ç›¸åŒçš„åµŒå…¥æ¨¡å‹å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡</span><br><span class="line">    vector = embeddings.embed_query(search_query)</span><br><span class="line">    </span><br><span class="line">    # æ„å»ºæ··åˆæœç´¢æŸ¥è¯¢ç»“æ„</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;retriever&quot;: &#123;</span><br><span class="line">            # ä½¿ç”¨RRF (Reciprocal Rank Fusion) ç®—æ³•èåˆå¤šä¸ªæ£€ç´¢å™¨çš„ç»“æœ</span><br><span class="line">            &quot;rrf&quot;: &#123;</span><br><span class="line">                # å®šä¹‰å¤šä¸ªæ£€ç´¢å™¨åˆ—è¡¨</span><br><span class="line">                &quot;retrievers&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        # ç¬¬ä¸€ä¸ªæ£€ç´¢å™¨ï¼šå¤šå­—æ®µBM25å…³é”®è¯æœç´¢</span><br><span class="line">                        &quot;standard&quot;: &#123;</span><br><span class="line">                            &quot;query&quot;: &#123;</span><br><span class="line">                                # ä½¿ç”¨multi_matchåœ¨å¤šä¸ªå­—æ®µä¸Šè¿›è¡ŒBM25æœç´¢</span><br><span class="line">                                &quot;multi_match&quot;: &#123;</span><br><span class="line">                                    &quot;query&quot;: search_query,</span><br><span class="line">                                    &quot;type&quot;: &quot;best_fields&quot;,      # é€‰æ‹©æœ€ä½³åŒ¹é…å­—æ®µ</span><br><span class="line">                                    &quot;fields&quot;: [&quot;text&quot;, &quot;report_name&quot;, &quot;report_url&quot;]  # åœ¨è¿™äº›å­—æ®µä¸­æœç´¢</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        # ç¬¬äºŒä¸ªæ£€ç´¢å™¨ï¼šKNNå‘é‡è¿‘ä¼¼æœç´¢</span><br><span class="line">                        &quot;knn&quot;: &#123;</span><br><span class="line">                            &quot;field&quot;: dense_vector_field,      # å‘é‡å­—æ®µåï¼ˆä½¿ç”¨å®šä¹‰çš„å˜é‡ï¼‰</span><br><span class="line">                            &quot;query_vector&quot;: vector,           # æŸ¥è¯¢å‘é‡</span><br><span class="line">                            &quot;k&quot;: 5,                          # è¿”å›5ä¸ªæœ€ç›¸ä¼¼çš„å‘é‡ç»“æœ</span><br><span class="line">                            &quot;num_candidates&quot;: 10,            # å€™é€‰å‘é‡æ•°é‡ï¼Œç”¨äºæé«˜æœç´¢å‡†ç¡®æ€§</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="æ¨¡ç³Šæ£€ç´¢"><a href="#æ¨¡ç³Šæ£€ç´¢" class="headerlink" title="æ¨¡ç³Šæ£€ç´¢"></a>æ¨¡ç³Šæ£€ç´¢</h5><p>æ— è®ºæ˜¯åœ¨ç½‘é¡µæœç´¢ã€æ–‡ä»¶æ£€ç´¢ï¼Œè¿˜æ˜¯æ•°æ®åº“æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬æ—¶å¸¸ä¼šå› ä¸ºæ‹¼å†™é”™è¯¯æˆ–ä¿¡æ¯ä¸å®Œæ•´è€Œæ— æ³•æ‰¾åˆ°éœ€è¦çš„ç»“æœã€‚<strong>æ¨¡ç³Šæœç´¢</strong>ï¼ˆFuzzy Searchï¼‰åº”è¿è€Œç”Ÿï¼Œå®ƒé€šè¿‡è¯†åˆ«ä¸æŸ¥è¯¢ç›¸ä¼¼çš„è¯è¯­æ¥å¸®åŠ©æˆ‘ä»¬è·å¾—æ›´åŠ çµæ´»çš„æœç´¢ç»“æœã€‚</p>
<p>è¿™é‡Œæ˜¯å°†bm25ä¸æ¨¡ç³Šæœç´¢ç»“åˆèµ·æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">def fuzzy_query(search_query: str):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    åˆ›å»ºæ¨¡ç³Šæœç´¢æŸ¥è¯¢å‡½æ•°ï¼Œæ”¯æŒæ‹¼å†™é”™è¯¯å’Œè¿‘ä¼¼åŒ¹é…</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        search_query (str): ç”¨æˆ·è¾“å…¥çš„æœç´¢æŸ¥è¯¢æ–‡æœ¬</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        Dict: Elasticsearchæ¨¡ç³Šæœç´¢æŸ¥è¯¢ä½“</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;query&quot;: &#123;</span><br><span class="line">            # ä½¿ç”¨matchæŸ¥è¯¢è¿›è¡Œæ–‡æœ¬åŒ¹é…</span><br><span class="line">            &quot;match&quot;: &#123;</span><br><span class="line">                # åœ¨æŒ‡å®šçš„æ–‡æœ¬å­—æ®µä¸­è¿›è¡Œæœç´¢</span><br><span class="line">                text_field: &#123;</span><br><span class="line">                    &quot;query&quot;: search_query,        # ç”¨æˆ·çš„æœç´¢æŸ¥è¯¢æ–‡æœ¬</span><br><span class="line">                    &quot;fuzziness&quot;: &quot;AUTO&quot;,          # è‡ªåŠ¨æ¨¡ç³ŠåŒ¹é…è®¾ç½®</span><br><span class="line">                    # fuzzinesså‚æ•°è¯´æ˜ï¼š</span><br><span class="line">                    # - &quot;AUTO&quot;ï¼šæ ¹æ®è¯é•¿åº¦è‡ªåŠ¨è°ƒæ•´æ¨¡ç³Šåº¦</span><br><span class="line">                    #   - 0-2ä¸ªå­—ç¬¦ï¼šä¸å…è®¸é”™è¯¯</span><br><span class="line">                    #   - 3-5ä¸ªå­—ç¬¦ï¼šå…è®¸1ä¸ªç¼–è¾‘è·ç¦»é”™è¯¯</span><br><span class="line">                    #   - 5ä¸ªä»¥ä¸Šå­—ç¬¦ï¼šå…è®¸2ä¸ªç¼–è¾‘è·ç¦»é”™è¯¯</span><br><span class="line">                    # - ä¹Ÿå¯ä»¥è®¾ç½®å…·ä½“æ•°å€¼ï¼š0, 1, 2</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>AUTO</code> è§„åˆ™ï¼š<strong>0~2 å­—ç¬¦</strong>ä¸å…è®¸é”™ï¼›<strong>3~5 å­—ç¬¦</strong>æœ€å¤š1é”™ï¼›<strong>&gt;5 å­—ç¬¦</strong>æœ€å¤š2é”™ã€‚</li>
<li>å¯¹ <strong>text å­—æ®µ</strong>å…ˆåˆ†è¯ï¼Œå†å¯¹æ¯ä¸ª token åšæ¨¡ç³Š â†’ å¬å› <code>Elasticsearch</code>ã€‚</li>
</ul>
<h4 id="elasticsearchçš„è¿æ¥"><a href="#elasticsearchçš„è¿æ¥" class="headerlink" title="elasticsearchçš„è¿æ¥"></a>elasticsearchçš„è¿æ¥</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from langchain_elasticsearch import ElasticsearchRetriever</span><br><span class="line">from embeddings_model import select_embeddings_model</span><br><span class="line"># æ ¹æ®æ¨¡å‹åç§°é€‰æ‹©åµŒå…¥æ¨¡å‹</span><br><span class="line">embedding_model_name=&#x27;bge&#x27;</span><br><span class="line">embeddings = select_embeddings_model(embedding_model_name)</span><br><span class="line">dense_vector_field=&#x27;vector&#x27;</span><br><span class="line">text_field=&#x27;text&#x27;</span><br><span class="line">search_func=fuzzy_query</span><br><span class="line"># åˆ›å»ºElasticsearchæ£€ç´¢å™¨</span><br><span class="line">retriever = ElasticsearchRetriever.from_es_params(</span><br><span class="line">    index_name=&quot;zxj_test&quot;,  # æŒ‡å®šç´¢å¼•åç§°</span><br><span class="line">    body_func=fuzzy_query,  # æŸ¥è¯¢å‡½æ•°</span><br><span class="line">    content_field=&quot;text&quot;,  # å†…å®¹å­—æ®µå</span><br><span class="line">    url=&#x27;http://elasticsearch:9200/&#x27;# ElasticsearchæœåŠ¡å™¨åœ°å€</span><br><span class="line">)</span><br><span class="line">print(&quot;è¿æ¥æˆåŠŸ&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="elasticsearchçš„å…¥åº“"><a href="#elasticsearchçš„å…¥åº“" class="headerlink" title="elasticsearchçš„å…¥åº“"></a>elasticsearchçš„å…¥åº“</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">document = []</span><br><span class="line">id_list = []</span><br><span class="line"></span><br><span class="line"># éå†æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰.mdæ–‡ä»¶</span><br><span class="line">for filename in os.listdir(folder_path):</span><br><span class="line">    if filename.endswith(&quot;.md&quot;):</span><br><span class="line">        file_path = os.path.join(folder_path, filename)</span><br><span class="line"></span><br><span class="line">        # ä»æ–‡ä»¶åä¸­æå–chunk_idï¼ˆå»é™¤.mdæ‰©å±•åï¼‰</span><br><span class="line">        chunk_id = filename.replace(&quot;.md&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        # è¯»å–MDæ–‡ä»¶å†…å®¹</span><br><span class="line">        with open(file_path, &#x27;r&#x27;, encoding=&#x27;utf-8&#x27;) as file:</span><br><span class="line">            text_content = file.read()</span><br><span class="line">  </span><br><span class="line">        # æŸ¥æ‰¾å¯¹åº”çš„URLï¼ˆæ ¹æ®æ–‡ä»¶ååŒ¹é…ï¼‰</span><br><span class="line">        report_url = &quot;&quot;</span><br><span class="line">        # ä»folder_nameä¸­æå–æ ¸å¿ƒæ–‡æ¡£åï¼ˆæœ€åä¸€ä¸ª^åé¢çš„éƒ¨åˆ†ï¼‰</span><br><span class="line">        core_folder_name = folder_name.split(&#x27;^&#x27;)[-1]  # æå–æ ¸å¿ƒæ–‡æ¡£å</span><br><span class="line"></span><br><span class="line">        # æ ¹æ®core_folder_nameæŸ¥æ‰¾å¯¹åº”çš„URL</span><br><span class="line">        report_url = find_url_by_name_from_list(docs_data, core_folder_name)</span><br><span class="line"></span><br><span class="line">        # æ„å»ºdocumentç»“æ„</span><br><span class="line">        doc = Document(</span><br><span class="line">            page_content=text_content,</span><br><span class="line">            metadata=&#123;</span><br><span class="line">                &quot;report_name&quot;: folder_name,</span><br><span class="line">                &quot;report_url&quot;: report_url,</span><br><span class="line">                &quot;chunk_id&quot;: chunk_id</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        document.append(doc)</span><br><span class="line">        id_list.append(folder_name + &quot;_&quot; + chunk_id)</span><br><span class="line"></span><br><span class="line"># æ‰¹é‡æ·»åŠ åˆ°å‘é‡åº“</span><br><span class="line">es_vector_store.add_documents(documents=document, ids=id_list)</span><br><span class="line">print(f&quot;    æ–‡ä»¶å¤¹ &#123;folder_name&#125; å·²æˆåŠŸå…¥åº“ï¼Œå…± &#123;len(document)&#125; ä¸ªæ–‡æ¡£å—&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h4><p><a target="_blank" rel="noopener" href="https://python.langchain.ac.cn/docs/integrations/retrievers/elasticsearch_retriever/#bm25">Elasticsearchæ£€ç´¢å™¨ | ğŸ¦œï¸ğŸ”— LangChain æ¡†æ¶</a></p>
<h3 id="ä¸»æµçš„æ£€ç´¢ç­–ç•¥"><a href="#ä¸»æµçš„æ£€ç´¢ç­–ç•¥" class="headerlink" title="ä¸»æµçš„æ£€ç´¢ç­–ç•¥"></a>ä¸»æµçš„æ£€ç´¢ç­–ç•¥</h3><h4 id="BM25-å…¨æ–‡å…³é”®è¯æ£€ç´¢"><a href="#BM25-å…¨æ–‡å…³é”®è¯æ£€ç´¢" class="headerlink" title="BM25 å…¨æ–‡å…³é”®è¯æ£€ç´¢"></a>BM25 å…¨æ–‡å…³é”®è¯æ£€ç´¢</h4><p>BM25ï¼ˆBest Matching 25ï¼‰æ˜¯ä¸€ç§ä¹…ç»è€ƒéªŒçš„æ’åºç®—æ³•ï¼Œå¹¿æ³›åº”ç”¨äºä¼ ç»Ÿæœç´¢å¼•æ“ä¸­ã€‚å®ƒåŸºäºâ€œè¯è¢‹æ¨¡å‹â€ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å…³é”®è¯åŒ¹é…ç¨‹åº¦æ¥è¡¡é‡æ–‡æ¡£ä¸æŸ¥è¯¢çš„ç›¸å…³æ€§ã€‚</p>
<p>æ ¸å¿ƒåŸç†æ¦‚è§ˆï¼š</p>
<p>è¯é¢‘ (Term Frequency, TF)ï¼šä¸€ä¸ªè¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°è¶Šå¤šï¼Œé€šå¸¸æ„å‘³ç€è¿™ç¯‡æ–‡æ¡£ä¸è¯¥è¯ç›¸å…³æ€§è¶Šé«˜ã€‚ä½†BM25ä¼šè¿›è¡Œâ€œé¥±å’Œåº¦â€å¤„ç†ï¼Œé¿å…æŸäº›è¶…é«˜é¢‘è¯è¿‡åº¦å½±å“ç»“æœã€‚å¯ä»¥æƒ³è±¡æˆï¼Œä¸€ç¯‡æ–‡ç« æåˆ°â€œè‹¹æœâ€10æ¬¡ï¼Œæ¯”æåˆ°1æ¬¡æ›´ç›¸å…³ï¼Œä½†æåˆ°100æ¬¡å’Œæåˆ°50æ¬¡ï¼Œåœ¨â€œè‹¹æœâ€è¿™ä¸ªä¸»é¢˜ä¸Šçš„ç›¸å…³æ€§å¢åŠ å¯èƒ½å°±æ²¡é‚£ä¹ˆæ˜¾è‘—äº†ã€‚<br>é€†æ–‡æ¡£é¢‘ç‡ (Inverse Document Frequency, IDF)ï¼šå¦‚æœä¸€ä¸ªè¯åœ¨æ•´ä¸ªæ–‡æ¡£é›†åˆä¸­éƒ½å¾ˆç½•è§ï¼ˆåªåœ¨å°‘æ•°æ–‡æ¡£ä¸­å‡ºç°ï¼‰ï¼Œé‚£ä¹ˆå®ƒå¯¹äºåŒºåˆ†æ–‡æ¡£ä¸»é¢˜å°±æ›´é‡è¦ï¼ŒIDFå€¼å°±é«˜ã€‚æ¯”å¦‚â€œé‡å­çº ç¼ â€è¿™ä¸ªè¯è¿œæ¯”â€œçš„â€ã€â€œæ˜¯â€è¿™ç±»è¯æ›´èƒ½é”å®šä¸“ä¸šæ–‡æ¡£ã€‚<br>æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–ï¼šç”¨äºå¹³è¡¡é•¿çŸ­æ–‡æ¡£çš„å¾—åˆ†ï¼Œé¿å…é•¿æ–‡æ¡£ä»…ä»…å› ä¸ºå†…å®¹å¤šè€Œè·å¾—ä¸å…¬å¹³çš„é«˜åˆ†ã€‚<br>å·¥ä½œæ–¹å¼ä¸¾ä¾‹ï¼šå½“ç”¨æˆ·æœç´¢â€œæ·±åº¦å­¦ä¹ å…¥é—¨æ•™ç¨‹â€æ—¶ï¼ŒBM25ä¼šå€¾å‘äºæ‰¾å‡ºé‚£äº›æ›´é¢‘ç¹å‡ºç°â€œæ·±åº¦å­¦ä¹ â€ã€â€œå…¥é—¨â€ã€â€œæ•™ç¨‹â€è¿™äº›è¯ï¼Œä¸”è¿™äº›è¯ç›¸å¯¹ä¸é‚£ä¹ˆå¸¸è§çš„æ–‡æ¡£ã€‚</p>
<p><strong>1. å…¬å¼æ•´ä½“ç»“æ„</strong></p>
<script type="math/tex; mode=display">
\text{score}(D, Q) = \sum_{i=1}^{n} \text{IDF}(q_i) \cdot \underbrace{\frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot \left(1 - b + b \cdot \frac{|D|}{\text{avgdl}}\right)}}_{\text{è¯é¢‘å½’ä¸€åŒ–é¡¹ï¼ˆTFï¼‰}}</script><ul>
<li><strong>IDF éƒ¨åˆ†</strong>ï¼šè¡¡é‡è¯é¡¹ $ q_i $ çš„åŒºåˆ†èƒ½åŠ›ï¼ˆé€†æ–‡æ¡£é¢‘ç‡ï¼‰ã€‚</li>
<li><strong>TF éƒ¨åˆ†</strong>ï¼šè¡¡é‡è¯é¡¹ $ q_i $ åœ¨æ–‡æ¡£ $ D $ ä¸­çš„åŒ¹é…ç¨‹åº¦ï¼ˆè¯é¢‘å½’ä¸€åŒ–ï¼‰ã€‚</li>
<li><strong>æ±‚å’Œ</strong>ï¼šå¯¹æŸ¥è¯¢ä¸­çš„æ‰€æœ‰è¯é¡¹ $ q_i $ çš„å¾—åˆ†æ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆç›¸å…³æ€§åˆ†æ•°ã€‚</li>
</ul>
<p><strong>2. IDF éƒ¨åˆ†</strong></p>
<script type="math/tex; mode=display">
\text{IDF}(q_i) = \ln\left(\frac{N - n(q_i) + 0.5}{n(q_i) + 0.5}\right)</script><ul>
<li><strong>æ„ä¹‰</strong>ï¼šIDF å€¼è¶Šé«˜ï¼Œè¯é¡¹ $ q_i $ è¶Šèƒ½åŒºåˆ†æ–‡æ¡£ï¼ˆå¸¸è§äºå°‘æ•°æ–‡æ¡£ä¸­çš„è¯ï¼‰ã€‚</li>
<li><strong>å¹³æ»‘å¤„ç†</strong>ï¼šåˆ†å­å’Œåˆ†æ¯å‡åŠ  0.5ï¼Œé¿å…æç«¯å€¼ï¼ˆå¦‚ $ n(q_i) = 0 $ æ—¶ ID æ— é™å¤§ï¼‰ã€‚</li>
<li><strong>å‚æ•°</strong>ï¼š<ul>
<li>$ N $ï¼šæ–‡æ¡£æ€»æ•°ã€‚</li>
<li>$ n(q_i) $ï¼šåŒ…å« $ q_i $ çš„æ–‡æ¡£æ•°ã€‚</li>
</ul>
</li>
</ul>
<p><strong>3. è¯é¢‘å½’ä¸€åŒ–é¡¹ï¼ˆTFï¼‰</strong></p>
<script type="math/tex; mode=display">
\frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot \left(1 - b + b \cdot \frac{|D|}{\text{avgdl}}\right)}</script><ul>
<li><strong>éçº¿æ€§é¥±å’Œ</strong>ï¼šåˆ†å­å’Œåˆ†æ¯å‡åŒ…å« $ f(q_i, D) $ï¼Œä½¿è¯é¢‘å¢é•¿å¸¦æ¥çš„å¢ç›Šé€æ¸å‡å°ï¼ˆé¿å…é•¿æ–‡æ¡£ä¸­é‡å¤è¯é¡¹çš„è¿‡åº¦å½±å“ï¼‰ã€‚</li>
<li><strong>æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–</strong>ï¼š<ul>
<li>$ |D| $ï¼šæ–‡æ¡£ $ D $ çš„é•¿åº¦ï¼ˆè¯æ•°ï¼‰ã€‚</li>
<li>$ \text{avgdl} $ï¼šæ•´ä¸ªæ–‡æ¡£é›†åˆçš„å¹³å‡æ–‡æ¡£é•¿åº¦ã€‚</li>
<li>$ b $ï¼šæ§åˆ¶æ–‡æ¡£é•¿åº¦å¯¹å¾—åˆ†çš„å½±å“ï¼ˆ$ b=1 $ æ—¶å®Œå…¨å½’ä¸€åŒ–ï¼Œ$ b=0 $ æ—¶å¿½ç•¥é•¿åº¦ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>å‚æ•°</strong>ï¼š<ul>
<li>$ k_1 $ï¼šæ§åˆ¶è¯é¢‘é¥±å’Œçš„ç³»æ•°ï¼ˆé€šå¸¸ $ k_1 \in [1.2, 2.0] $ï¼Œé»˜è®¤ $ k_1 = 1.5 $ï¼‰ã€‚</li>
<li>$ b $ï¼šé»˜è®¤ $ b = 0.75 $ã€‚</li>
</ul>
</li>
</ul>
<p>è¿™ä¸ªå…¬å¼è™½ç„¶çœ‹èµ·æ¥æœ‰äº›å¤æ‚ï¼Œä½†å®ƒç²¾å¦™åœ°å¹³è¡¡äº†è¯é¢‘ã€è¯çš„ç¨€æœ‰åº¦ä»¥åŠæ–‡æ¡£é•¿åº¦è¿™å‡ ä¸ªæ ¸å¿ƒå› ç´ ï¼Œæ˜¯BM25ç®—æ³•æ•ˆæœå‡ºè‰²çš„å…³é”®ã€‚</p>
<h6 id="BM25ã€å…¨æ–‡æœç´¢ä¸å€’æ’ç´¢å¼•ï¼šå®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ"><a href="#BM25ã€å…¨æ–‡æœç´¢ä¸å€’æ’ç´¢å¼•ï¼šå®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ" class="headerlink" title="BM25ã€å…¨æ–‡æœç´¢ä¸å€’æ’ç´¢å¼•ï¼šå®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ"></a>BM25ã€å…¨æ–‡æœç´¢ä¸å€’æ’ç´¢å¼•ï¼šå®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ</h6><p><strong>è¿™ä¸‰è€…æ˜¯æ„å»ºæœç´¢ç³»ç»Ÿçš„å…³é”®ç»„ä»¶ï¼š</strong></p>
<ul>
<li><p>å…¨æ–‡æœç´¢ (Full-Text Search)ï¼šè¿™æ˜¯æˆ‘ä»¬å¸Œæœ›è¾¾æˆçš„ç›®æ ‡â€”â€”åœ¨å¤§é‡æ–‡æœ¬ä¸­æ‰¾åˆ°åŒ…å«ç‰¹å®šä¿¡æ¯çš„æ–‡æ¡£ã€‚</p>
</li>
<li><p>å€’æ’ç´¢å¼• (Inverted Index)ï¼šè¿™æ˜¯å®ç°é«˜æ•ˆå…¨æ–‡æœç´¢çš„æ•°æ®ç»“æ„åŸºç¡€ã€‚å®ƒåƒä¸€æœ¬ä¹¦æœ«å°¾çš„è¯¦ç»†â€œå…³é”®è¯ç´¢å¼•â€ï¼Œè®°å½•äº†æ¯ä¸ªè¯å‡ºç°åœ¨å“ªäº›æ–‡æ¡£ä¸­ä»¥åŠç›¸å…³ä½ç½®ä¿¡æ¯ã€‚å½“ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡å€’æ’ç´¢å¼•å¿«é€Ÿå®šä½åˆ°åŒ…å«æŸ¥è¯¢è¯çš„å€™é€‰æ–‡æ¡£ã€‚</p>
</li>
<li>BM25ï¼šåœ¨é€šè¿‡å€’æ’ç´¢å¼•æ‰¾åˆ°å€™é€‰æ–‡æ¡£åï¼ŒBM25ç®—æ³•ç™»åœºï¼Œä¸ºæ¯ä¸ªæ–‡æ¡£è®¡ç®—ä¸€ä¸ªç›¸å…³æ€§å¾—åˆ†ï¼Œç„¶åæŒ‰åˆ†æ’åºï¼Œå°†æœ€ç›¸å…³çš„ç»“æœå‘ˆç°ç»™ç”¨æˆ·ã€‚</li>
</ul>
<p><strong>æŠŠå®ƒä»¬æ¯”ä½œåœ¨å›¾ä¹¦é¦†æ‰¾ç‰¹å®šä¸»é¢˜çš„ä¹¦ç±ï¼š</strong></p>
<ul>
<li>ä½ å‘Šè¯‰å›¾ä¹¦ç®¡ç†å‘˜ä½ è¦æ‰¾å…³äºâ€œå¤©ä½“ç‰©ç†å­¦â€çš„ä¹¦ï¼ˆç”¨æˆ·æŸ¥è¯¢ï¼‰ã€‚</li>
<li>ç®¡ç†å‘˜æŸ¥é˜…ä¸€ä¸ªæ€»å¡ç‰‡ç´¢å¼•ï¼ˆå€’æ’ç´¢å¼•ï¼‰ï¼Œè¿…é€Ÿå‘Šè¯‰ä½ å“ªäº›ä¹¦æ¶ï¼ˆæ–‡æ¡£IDï¼‰ä¸Šæœ‰åŒ…å«â€œå¤©ä½“ç‰©ç†å­¦â€è¿™ä¸ªè¯çš„ä¹¦ã€‚</li>
<li>ä½ èµ°åˆ°è¿™äº›ä¹¦æ¶ï¼Œå¿«é€Ÿç¿»é˜…è¿™äº›ä¹¦ï¼ˆBM25è¯„åˆ†è¿‡ç¨‹ï¼‰ï¼Œæ ¹æ®ç›®å½•ã€æ‘˜è¦å’ŒæåŠâ€œå¤©ä½“ç‰©ç†å­¦â€çš„é¢‘ç¹ç¨‹åº¦åŠé‡è¦æ€§ï¼Œåˆ¤æ–­å“ªå‡ æœ¬æœ€ç¬¦åˆä½ çš„éœ€æ±‚ï¼Œå¹¶æŠŠå®ƒä»¬æŒ‰ç›¸å…³æ€§é«˜ä½æ’å¥½ã€‚</li>
</ul>
<h4 id="Dense-Vector-kNN-å‘é‡è¯­ä¹‰æ£€ç´¢"><a href="#Dense-Vector-kNN-å‘é‡è¯­ä¹‰æ£€ç´¢" class="headerlink" title="Dense Vector / kNN å‘é‡è¯­ä¹‰æ£€ç´¢"></a>Dense Vector / kNN å‘é‡è¯­ä¹‰æ£€ç´¢</h4><p>å‘é‡è¯­ä¹‰æ£€ç´¢ï¼ˆDense Vector / k-Nearest Neighborï¼Œç®€ç§° kNNï¼‰æ˜¯ä¸€ç§<strong>åŸºäºé«˜ç»´ç¨ å¯†å‘é‡è¡¨ç¤ºçš„è¯­ä¹‰æ£€ç´¢æŠ€æœ¯</strong>ï¼Œä¸ä¼ ç»Ÿå…³é”®è¯å€’æ’ç´¢å¼•ä¸åŒï¼Œå®ƒé€šè¿‡<strong>è‡ªç„¶è¯­è¨€çš„ä¸Šä¸‹æ–‡å«ä¹‰</strong>è€Œéå­—é¢åŒ¹é…æ¥å¯»æ‰¾æœ€ç›¸å…³çš„æ–‡æ¡£æˆ–å®ä½“ã€‚</p>
<ol>
<li><p><strong>Embedding</strong>ï¼šä½¿ç”¨é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆå¦‚ BERTã€Sentence-Transformersï¼‰æŠŠæ–‡æœ¬æ˜ å°„ä¸º<strong>å›ºå®šç»´åº¦çš„ç¨ å¯†å‘é‡</strong>ï¼ˆé€šå¸¸ 128â€“1024 ç»´ï¼‰ã€‚</p>
</li>
<li><p><strong>kNN æœç´¢</strong>ï¼šç»™å®šæŸ¥è¯¢å‘é‡ï¼Œ<strong>åœ¨å‘é‡ç©ºé—´ä¸­æ‰¾è·ç¦»æœ€è¿‘çš„ k ä¸ªæ–‡æ¡£å‘é‡</strong>ã€‚è·ç¦»åº¦é‡å¸¸è§ï¼š</p>
<ul>
<li>ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosineï¼‰</li>
<li>å†…ç§¯ / dot-product</li>
<li>L2 æ¬§æ°è·ç¦»</li>
</ul>
</li>
</ol>
<h4 id="Hybrid-Retrieval-æ··åˆæ£€ç´¢"><a href="#Hybrid-Retrieval-æ··åˆæ£€ç´¢" class="headerlink" title="Hybrid Retrieval æ··åˆæ£€ç´¢"></a>Hybrid Retrieval æ··åˆæ£€ç´¢</h4><p>æ—¢ç„¶ä¸åŒçš„æ£€ç´¢ç­–ç•¥å„æœ‰åƒç§‹ï¼ˆä¾‹å¦‚ï¼ŒBM25æ“…é•¿å…³é”®è¯ç²¾ç¡®åŒ¹é…ï¼ŒEmbeddingæ“…é•¿è¯­ä¹‰ç†è§£ï¼‰ï¼Œé‚£ä¹ˆå°†å®ƒä»¬ç»“åˆèµ·æ¥ï¼Œæ˜¯ä¸æ˜¯èƒ½è¾¾åˆ°â€œ1+1&gt;2â€çš„æ•ˆæœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¿™å°±æ˜¯æ··åˆæ£€ç´¢çš„æ ¸å¿ƒæ€æƒ³ã€‚</p>
<p>å¸¸è§åšæ³•ï¼šåŒæ—¶ä½¿ç”¨BM25ï¼ˆæˆ–å…¶ä»–ç¨€ç–æ£€ç´¢æ–¹æ³•ï¼‰å’Œä¸€ç§æˆ–å¤šç§Embeddingæ£€ç´¢æ–¹æ³•ï¼Œç„¶åå°†å®ƒä»¬å„è‡ªçš„æ£€ç´¢ç»“æœè¿›è¡Œèåˆæ’åºã€‚</p>
<p>èåˆç­–ç•¥ä¸¾ä¾‹ï¼š</p>
<p>RRF (Reciprocal Rank Fusion, å€’æ•°æ’åºèåˆ)ï¼šä¸€ç§ç®€å•ä½†é²æ£’çš„èåˆæ–¹æ³•ã€‚å®ƒä¸å…³å¿ƒä¸åŒæ£€ç´¢ç³»ç»Ÿè¾“å‡ºçš„åŸå§‹å¾—åˆ†ï¼Œåªå…³å¿ƒæ¯ä¸ªæ–‡æ¡£åœ¨å„è‡ªç»“æœåˆ—è¡¨ä¸­çš„æ’åã€‚ä¸€ä¸ªæ–‡æ¡£ doc çš„RRFå¾—åˆ†è®¡ç®—å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
Score_RRF(doc) = Î£_{s âˆˆ Systems} (1 / (k + rank_s(doc)))</script><p>å…¶ä¸­ï¼š</p>
<ul>
<li>Systems æ˜¯æ‰€æœ‰å‚ä¸èåˆçš„æ£€ç´¢ç³»ç»Ÿçš„é›†åˆã€‚</li>
<li>rank_s(doc) æ˜¯æ–‡æ¡£ doc åœ¨æ£€ç´¢ç³»ç»Ÿ s ç»™å‡ºçš„ç»“æœåˆ—è¡¨ä¸­çš„æ’åï¼ˆä¾‹å¦‚ï¼Œç¬¬ä¸€åæ˜¯1ï¼Œç¬¬äºŒåæ˜¯2ï¼‰ã€‚</li>
<li>k æ˜¯ä¸€ä¸ªå°å¸¸æ•°ï¼ˆä¾‹å¦‚ï¼Œå¸¸è®¾ç½®ä¸º60ï¼‰ï¼Œç”¨äºå¹³æ»‘å¾—åˆ†ï¼Œé¿å…æ’åé åçš„æ–‡æ¡£å¾—åˆ†è¿‡å°æˆ–æ’åç¬¬ä¸€çš„æ–‡æ¡£å¾—åˆ†å æ¯”è¿‡é«˜ã€‚</li>
</ul>
<h4 id="Reranker-é‡æ’åºå™¨"><a href="#Reranker-é‡æ’åºå™¨" class="headerlink" title="Reranker  é‡æ’åºå™¨"></a>Reranker  é‡æ’åºå™¨</h4><p>ç»è¿‡ä¸Šè¿°ä¸€ç§æˆ–å¤šç§æ£€ç´¢ç­–ç•¥çš„â€œç²—ç­›â€ï¼ˆå¬å›é˜¶æ®µï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«è¾ƒå¤šå€™é€‰æ–‡æ¡£çš„åˆ—è¡¨ï¼ˆæ¯”å¦‚å‡ ç™¾ä¸ªï¼‰ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡æœ€ç»ˆå–‚ç»™LLMçš„æ–‡æ¡£è´¨é‡ï¼ŒRerankerï¼ˆé‡æ’åºå™¨ï¼‰åº”è¿è€Œç”Ÿã€‚å®ƒç›¸å½“äºä¸€ä½â€œç²¾ç‚¼å¸ˆâ€æˆ–â€œè´¨é‡å“é‰´å®˜â€ï¼Œå¯¹åˆæ­¥å¬å›çš„ç»“æœè¿›è¡Œæ›´ç»†è‡´ã€æ›´ç²¾å‡†çš„äºŒæ¬¡æ’åºã€‚</p>
<ol>
<li>å¬å›<br>å€’æ’ / å‘é‡ / æ··åˆå…ˆç»™ <strong>Top-N</strong>ï¼ˆNâ‰ˆ100~1 kï¼‰ã€‚</li>
<li>æ‹¼ç‰¹å¾<br>æŠŠ <code>(query, doc)</code> æ‹¼æˆä¸€æ¡è¾“å…¥ï¼š<br><code>[CLS] ç”¨æˆ·é—®é¢˜ [SEP] æ ‡é¢˜+æ­£æ–‡ [SEP]</code>ã€‚</li>
<li>æ‰“åˆ†<br>æ‰”ç»™ Cross-Encoder æˆ– ColBERT â†’ è¾“å‡º<strong>ä¸€ä¸ªç›¸å…³æ€§åˆ†æ•°</strong>ã€‚</li>
<li>é‡æ’<br>æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½é‡æ–°æ’åºï¼Œåªç•™ <strong>Top-K</strong>ï¼ˆKâ‰ˆ10~20ï¼‰ã€‚</li>
<li>è¿”å›<br>é‡æ’åçš„çŸ­åˆ—è¡¨äº¤ç»™å‰ç«¯æˆ– LLMï¼Œå®Œæˆä¸€æ¬¡â€œç²¾è¯»â€ã€‚</li>
</ol>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_59614665/article/details/149066780">å¤§æ¨¡å‹RAG | æ·±å…¥äº†è§£å‡ ç§ä¸»æµçš„æ£€ç´¢ç­–ç•¥ï¼ˆBM25ã€Embeddingã€æ··åˆæ£€ç´¢ã€Rerankerï¼‰-CSDNåšå®¢</a></p>
<h3 id="é¡¹ç›®å…³äºelasticsearchä»£ç é˜…è¯»è®°å½•"><a href="#é¡¹ç›®å…³äºelasticsearchä»£ç é˜…è¯»è®°å½•" class="headerlink" title="é¡¹ç›®å…³äºelasticsearchä»£ç é˜…è¯»è®°å½•"></a>é¡¹ç›®å…³äºelasticsearchä»£ç é˜…è¯»è®°å½•</h3><p>é˜…è¯»elasticsearchä»£ç ç›¸å…³è®°å½•:</p>
<ol>
<li><strong>embedding_model</strong>.select_embeddings_model:æ ¹æ®æŒ‡å®šçš„æ¨¡å‹åç§°åŠ è½½</li>
<li><strong>make_es_vector_store</strong>ï¼š<ol>
<li>docs_url = pd.read_excel(â€˜docs_new.xlsxâ€™)ï¼Œä»excelåŠ è½½urlå¹¶è¿›è¡Œæ•°æ®å¤„ç†ï¼Œä¿å­˜ç­›é€‰åçš„ur</li>
<li>å®Œæˆæ–‡ä»¶åŠ è½½æµ‹è¯•ï¼šxizhang/retrival/docfile_test/test.pyï¼›</li>
<li>åˆå§‹åŒ–esï¼Œä½¿ç”¨elastic_search.load_es_indexåŠ è½½å­˜å‚¨ç´¢å¼•</li>
<li>å®Œæˆæµ‹è¯•elasticsearchè¿æ¥ä¸ç´¢å¼•æ„å»ºï¼ˆç´¢å¼•åzxj_testï¼‰ï¼š/aisys/repo_dev/xizhang/retrival/elasticsearch_test/test_es_connect.pyï¼Œ/aisys/repo_dev/xizhang/retrival/elasticsearch_test/test_add_es.py</li>
<li>é¡ºåºæ‰¹é‡å¤„ç†æ–‡ä»¶ï¼šå…±16000å¤šä»½ï¼Œæ¯åä»½ä¸ºä¸€æ‰¹è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨download_pdf.pyè¿›è¡Œæ–‡ä»¶ä¸‹è½½ï¼Œä½¿ç”¨ï¼Œä½¿ç”¨vector_base.rewrite_fileå¯¹æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œå¯ä»¥ä¿®æ”¹ä»£ç ï¼Œå¢åŠ å¯¹mineruå¤„ç†pdfçš„markdownæ–‡ä»¶çš„å¤„ç†ï¼Œè¿”å›Documentå¯¹è±¡åˆ—è¡¨ï¼›</li>
</ol>
</li>
<li><strong>elastic_search</strong></li>
</ol>
<p>é‡å†™äº†æ£€ç´¢ç­–ç•¥çš„å‡½æ•°ï¼ŒåŒ…æ‹¬BM25ï¼ŒKNNï¼Œæ··åˆæœç´¢</p>
<ol>
<li><p>elastic_retrieveråˆ›å»ºElasticsearchæ£€ç´¢å™¨ï¼šæ ¹æ®æœç´¢ç±»å‹é€‰æ‹©å¯¹åº”çš„æŸ¥è¯¢å‡½æ•°ï¼Œåˆ›å»ºElasticsearchæ£€ç´¢å™¨ElasticsearchRetriever.from_es_params</p>
</li>
<li><p><strong>retrievers</strong></p>
<ol>
<li>å®šä¹‰å‡½æ•°select_retrieverï¼Œæ ¹æ®æŒ‡å®šçš„åç§°é€‰æ‹©å¹¶è¿”å›ç›¸åº”çš„æ£€ç´¢å™¨ï¼Œç›®å‰åªæœ‰bm25</li>
</ol>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/" class="post-title-link" itemprop="url">LangGraphå­¦ä¹ â€”â€”agentâ€”â€”ä¸Š</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-18 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-18T00:00:00+08:00">2025-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-07-27 12:14:37" itemprop="dateModified" datetime="2025-07-27T12:14:37+08:00">2025-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">aiæ¡†æ¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/langgraph/" itemprop="url" rel="index"><span itemprop="name">langgraph</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æœ¬æ•™ç¨‹ä¸ºlangchainå®˜æ–¹æ•™ç¨‹çš„å­¦ä¹ è®°å½•</p>
<p><a target="_blank" rel="noopener" href="https://academy.langchain.com/enrollments">academy.langchain.com/enrollments</a></p>
<p>ä»£ç è§<a target="_blank" rel="noopener" href="https://github.com/zxj-2023/learn-rag-langchain">zxj-2023/learn-rag-langchain</a></p>
<h3 id="module-1"><a href="#module-1" class="headerlink" title="module-1"></a>module-1</h3><h4 id="routeè·¯ç”±"><a href="#routeè·¯ç”±" class="headerlink" title="routeè·¯ç”±"></a>routeè·¯ç”±</h4><p>åœ¨ LangGraph ä¸­ï¼Œ<strong>routeï¼ˆè·¯ç”±ï¼‰\</strong>çš„æ ¸å¿ƒä½œç”¨æ˜¯*<em>æ ¹æ®å½“å‰çŠ¶æ€åŠ¨æ€å†³å®šâ€œä¸‹ä¸€æ­¥åº”è¯¥æ‰§è¡Œå“ªä¸ªèŠ‚ç‚¹â€*</em></p>
<h5 id="å®šä¹‰å·¥å…·"><a href="#å®šä¹‰å·¥å…·" class="headerlink" title="å®šä¹‰å·¥å…·"></a>å®šä¹‰å·¥å…·</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def multiply(a: int, b: int) -&gt; int:</span><br><span class="line">    &quot;&quot;&quot;Multiply a and b.</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">        a: first int</span><br><span class="line">        b: second int</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return a * b</span><br><span class="line">    </span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">llm_with_tools = llm.bind_tools([multiply])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸‰å¼•å·å­—ç¬¦ä¸²å« <strong>docstring</strong>ï¼Œå®ƒä¼šè¢« LangChain æ‹¿æ¥åšä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li><strong>ç”Ÿæˆå·¥å…·çš„ descriptionï¼ˆç»™å¤§æ¨¡å‹çœ‹çš„â€œè¯´æ˜ä¹¦â€ï¼‰</strong><br>æ²¡æœ‰å®ƒæ—¶ï¼ŒLangChain åªèƒ½é€€è€Œæ±‚å…¶æ¬¡ï¼ŒæŠŠå‡½æ•°å <code>multiply</code> æ‹¼æˆä¸€å¥ â€œmultiply toolâ€ ä¹‹ç±»çš„é»˜è®¤æè¿°ã€‚å¤§æ¨¡å‹æ‹¿åˆ°çš„å·¥å…·åˆ—è¡¨é‡Œï¼Œè¿™ä¸ªå·¥å…·å°±åªæœ‰ä¸€ä¸ªå¹²å·´å·´çš„åå­—å’Œå‚æ•°åˆ—è¡¨ï¼Œå®ƒå¯èƒ½çŒœä¸åˆ°è¿™ä¸ªå·¥å…·åˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„</li>
<li><strong>ç»™äººç±»å¼€å‘è€…è‡ªå·±çœ‹</strong><br>IDEã€æ–‡æ¡£ç”Ÿæˆå™¨ã€é™æ€æ£€æŸ¥å·¥å…·éƒ½ä¼šè¯»å–è¿™æ®µæ–‡å­—ï¼Œæ–¹ä¾¿åæœŸç»´æŠ¤ã€‚</li>
</ol>
</blockquote>
<h5 id="æ„å»ºæ¡ä»¶è¾¹"><a href="#æ„å»ºæ¡ä»¶è¾¹" class="headerlink" title="æ„å»ºæ¡ä»¶è¾¹"></a>æ„å»ºæ¡ä»¶è¾¹</h5><p><code>tool_calling_llm</code> æ˜¯ä¸€ä¸ª<strong>æ™®é€šçš„è®¡ç®—èŠ‚ç‚¹</strong>ï¼ˆnodeï¼‰ï¼Œè´Ÿè´£æŠŠå½“å‰å¯¹è¯çŠ¶æ€äº¤ç»™å¤§æ¨¡å‹ï¼Œè®©å¤§æ¨¡å‹å†³å®šè¦ä¸è¦è°ƒç”¨å·¥å…·ï¼›</p>
<p>çœŸæ­£å®Œæˆâ€œè·¯ç”±â€åŠ¨ä½œçš„æ˜¯ <strong><code>tools_condition</code></strong> è¿™ä¸ªå‡½æ•°â€”â€”å®ƒæ‰æ˜¯ LangGraph é‡Œçš„ <strong>routeï¼ˆæ¡ä»¶è¾¹ï¼‰</strong>ã€‚</p>
<p><code>tools_condition</code> æ˜¯ ä½œä¸º<strong>LangGraph é¢„ç½®çš„â€œé»˜è®¤è·¯ç”±å‡½æ•°â€</strong>ï¼ŒåŠŸèƒ½å°±æ˜¯ï¼Œå¦‚æœå¤§æ¨¡å‹çš„æœ€æ–°å›å¤ä¸­åŒ…å«å·¥å…·è°ƒç”¨ï¼Œå°±è°ƒç”¨å·¥å…·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># Node</span><br><span class="line">def tool_calling_llm(state: MessagesState):</span><br><span class="line">	#è°ƒç”¨å¤§æ¨¡å‹åå°†æœ€æ–°çš„æ¶ˆæ¯è¿”å›</span><br><span class="line">    return &#123;&quot;messages&quot;: [llm_with_tools.invoke(state[&quot;messages&quot;])]&#125;</span><br><span class="line"></span><br><span class="line"># Build graph</span><br><span class="line">#MessagesState æ˜¯ LangGraph å®˜æ–¹é¢„ç½® çš„ä¸€ç§ çŠ¶æ€ï¼ˆStateï¼‰å®šä¹‰</span><br><span class="line">#è¿™ä¸ªçŠ¶æ€ç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯listï¼Œæœ‰æ–°çš„æ¶ˆæ¯å°±åŠ è¿›è¿™ä¸ªæ¶ˆæ¯list</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;tool_calling_llm&quot;, tool_calling_llm)</span><br><span class="line">builder.add_node(&quot;tools&quot;, ToolNode([multiply]))</span><br><span class="line">builder.add_edge(START, &quot;tool_calling_llm&quot;)</span><br><span class="line">builder.add_conditional_edges(</span><br><span class="line">    &quot;tool_calling_llm&quot;,</span><br><span class="line">    # å¦‚æœåŠ©æ‰‹ï¼ˆç»“æœï¼‰çš„æœ€æ–°æ¶ˆæ¯æ˜¯å·¥å…·è°ƒç”¨ -&gt; tools_condition è·¯ç”±åˆ°å·¥å…·</span><br><span class="line">    # å¦‚æœåŠ©æ‰‹ï¼ˆç»“æœï¼‰çš„æœ€æ–°æ¶ˆæ¯ä¸æ˜¯å·¥å…·è°ƒç”¨ -&gt; tools_condition è·¯ç”±åˆ° END</span><br><span class="line">    tools_condition,</span><br><span class="line">)</span><br><span class="line">builder.add_edge(&quot;tools&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250719142543838.png" alt="image-20250719142543838"></p>
<h5 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import HumanMessage</span><br><span class="line">messages = [HumanMessage(content=&quot;ä½ å¥½ï¼Œ2ä¹˜2æ˜¯å¤šå°‘&quot;)]</span><br><span class="line">messages = graph.invoke(&#123;&quot;messages&quot;: messages&#125;)</span><br><span class="line">for m in messages[&#x27;messages&#x27;]:</span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼Œ2ä¹˜2æ˜¯å¤šå°‘</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line">Tool Calls:</span><br><span class="line">  multiply (call_e026ceb409e247748786ad)</span><br><span class="line"> Call ID: call_e026ceb409e247748786ad</span><br><span class="line">  Args:</span><br><span class="line">    a: 2</span><br><span class="line">    b: 2</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: multiply</span><br><span class="line"></span><br><span class="line">4</span><br></pre></td></tr></table></figure>
<h4 id="agentä»£ç†"><a href="#agentä»£ç†" class="headerlink" title="agentä»£ç†"></a>agentä»£ç†</h4><p>åœ¨ LangGraph ä¸­ï¼Œ<strong>ä»£ç†ï¼ˆAgentï¼‰</strong> è¢«æ˜ç¡®å®šä¹‰ä¸º<strong>â€œä¸€ä¸ªç”±å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰é©±åŠ¨çš„ã€èƒ½å¤Ÿå¾ªç¯å†³ç­–å¹¶è°ƒç”¨å¤–éƒ¨å·¥å…·æ¥å®Œæˆä»»åŠ¡çš„èŠ‚ç‚¹æˆ–å­å›¾â€</strong>ã€‚</p>
<p><strong>Agent = LLM + å·¥å…·é›†åˆ + æç¤ºæ¨¡æ¿</strong>ï¼Œä¸‰è€…åœ¨ LangGraph çš„çŠ¶æ€åŒ–å›¾ç»“æ„é‡Œå¾ªç¯è¿è¡Œï¼Œç›´åˆ°æ»¡è¶³åœæ­¢æ¡ä»¶ã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2210.03629">ReAct</a> æ˜¯ä¸€ç§æµè¡Œçš„é€šç”¨æ™ºèƒ½ä½“æ¶æ„ï¼Œå®ƒç»“åˆäº†è¿™äº›æ‰©å±•ï¼Œå¹¶æ•´åˆäº†ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.langchain.ac.cn/langgraph/concepts/agentic_concepts/#tool-calling">å·¥å…·è°ƒç”¨</a>ï¼šå…è®¸LLMæ ¹æ®éœ€è¦é€‰æ‹©å’Œä½¿ç”¨å„ç§å·¥å…·ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://github.langchain.ac.cn/langgraph/concepts/agentic_concepts/#memory">è®°å¿†</a>ï¼šä½¿æ™ºèƒ½ä½“èƒ½å¤Ÿä¿ç•™å’Œä½¿ç”¨ä¹‹å‰æ­¥éª¤çš„ä¿¡æ¯ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://github.langchain.ac.cn/langgraph/concepts/agentic_concepts/#planning">è§„åˆ’</a>ï¼šä½¿LLMèƒ½å¤Ÿåˆ›å»ºå¹¶éµå¾ªå¤šæ­¥è®¡åˆ’ä»¥å®ç°ç›®æ ‡ã€‚</li>
</ol>
<p>å³</p>
<p><code>act</code>- è®©æ¨¡å‹è°ƒç”¨ç‰¹å®šå·¥å…·</p>
<p><code>observe</code> - å°†å·¥å…·è¾“å‡ºä¼ é€’å›æ¨¡å‹  </p>
<p> <code>reason</code> - è®©æ¨¡å‹å¯¹å·¥å…·è¾“å‡ºè¿›è¡Œæ¨ç†ï¼Œä»¥å†³å®šä¸‹ä¸€æ­¥æ“ä½œï¼ˆä¾‹å¦‚ï¼Œè°ƒç”¨å¦ä¸€ä¸ªå·¥å…·æˆ–ç›´æ¥å“åº”ï¼‰</p>
</blockquote>
<h5 id="å®šä¹‰å·¥å…·-1"><a href="#å®šä¹‰å·¥å…·-1" class="headerlink" title="å®šä¹‰å·¥å…·"></a>å®šä¹‰å·¥å…·</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tools = [add, multiply, divide]#å·¥å…·å‡½æ•°å…·ä½“å†…å®¹çœç•¥</span><br><span class="line">llm = ChatOpenAI()</span><br><span class="line"></span><br><span class="line"># åœ¨è¿™ä¸ª ipynb æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†å¹¶è¡Œå·¥å…·è°ƒç”¨ï¼ˆparallel tool callingï¼‰è®¾ç½®ä¸º falseï¼Œå› ä¸ºæ•°å­¦è®¡ç®—é€šå¸¸æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œå¹¶ä¸”è¿™æ¬¡æˆ‘ä»¬æœ‰3ä¸ªå¯ä»¥è¿›è¡Œæ•°å­¦è®¡ç®—çš„å·¥å…·ã€‚</span><br><span class="line"># OpenAI æ¨¡å‹ä¸ºäº†æ•ˆç‡ï¼Œé»˜è®¤è¿›è¡Œå¹¶è¡Œå·¥å…·è°ƒç”¨ï¼Œè¯¦æƒ…è¯·å‚é˜… `https://python.langchain.com/docs/how_to/tool_calling_parallel/`</span><br><span class="line"># ä¸å¦¨å°è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æ¨¡å‹åœ¨å¤„ç†æ•°å­¦æ–¹ç¨‹å¼æ—¶çš„è¡¨ç°ï¼</span><br><span class="line">llm_with_tools = llm.bind_tools(tools, parallel_tool_calls=False)</span><br></pre></td></tr></table></figure>
<h5 id="åˆ›å»ºä»£ç†"><a href="#åˆ›å»ºä»£ç†" class="headerlink" title="åˆ›å»ºä»£ç†"></a>åˆ›å»ºä»£ç†</h5><p>å®šä¹‰èŠ‚ç‚¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.graph import MessagesState</span><br><span class="line">from langchain_core.messages import HumanMessage, SystemMessage</span><br><span class="line"></span><br><span class="line"># System message</span><br><span class="line">sys_msg = SystemMessage(content=&quot;ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„åŠ©æ‰‹ï¼Œè´Ÿè´£å¯¹ä¸€ç»„è¾“å…¥æ‰§è¡Œç®—æœ¯è¿ç®—ã€‚&quot;)</span><br><span class="line"></span><br><span class="line"># Node</span><br><span class="line">def assistant(state: MessagesState):</span><br><span class="line">   return &#123;&quot;messages&quot;: [llm_with_tools.invoke([sys_msg] + state[&quot;messages&quot;])]&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€æ­¥ç›¸å½“äºå®šä¹‰äº†ç³»ç»Ÿæç¤ºè¯ï¼Œç„¶ååœ¨ assistant è¿™ä¸ªèŠ‚ç‚¹é‡Œï¼Œé€šè¿‡ [sys_msg] + state[â€œmessagesâ€] è¿™éƒ¨åˆ†ä»£ç ï¼Œè¿™ä¸ªç³»ç»Ÿæç¤ºè¯è¢«æ·»åŠ åˆ°äº†æ•´ä¸ªå¯¹è¯å†å²çš„æœ€å‰é¢ï¼Œç„¶åä¸€èµ·å‘é€ç»™æ¨¡å‹ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¨¡å‹åœ¨ç”Ÿæˆå›å¤æ—¶å°±ä¼šéµå¾ªè¿™ä¸ªç³»ç»Ÿæç¤ºè¯çš„æŒ‡ç¤ºã€‚</p>
<p>ä¸ä¸Šä¸€ä¸ªä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å°† <code>Tools</code> èŠ‚ç‚¹ <strong>å›ç¯</strong> è¿æ¥åˆ° <code>Assistant</code>ï¼Œä»è€Œå½¢æˆä¸€ä¸ªå›è·¯ã€‚</p>
<p>åœ¨ assistantèŠ‚ç‚¹æ‰§è¡Œåï¼Œ<code>tools_condition</code>æ£€æŸ¥æ¨¡å‹çš„è¾“å‡ºæ˜¯å¦ä¸ºå·¥å…·è°ƒç”¨ã€‚</p>
<p>å¦‚æœæ˜¯å·¥å…·è°ƒç”¨ï¼Œåˆ™æµç¨‹è¢«å¯¼å‘è‡³ <code>tools</code> èŠ‚ç‚¹ã€‚  </p>
<p><code>tools</code>èŠ‚ç‚¹é‡æ–°è¿æ¥åˆ°<code>assistant</code><strong>ã€‚</strong> åªè¦æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·ï¼Œæ­¤å¾ªç¯å°±ä¼šç»§ç»­ã€‚  </p>
<p>å¦‚æœæ¨¡å‹çš„å“åº”ä¸æ˜¯å·¥å…·è°ƒç”¨ï¼Œåˆ™æµç¨‹è¢«å¯¼å‘è‡³ç»“æŸï¼Œç»ˆæ­¢è¯¥è¿‡ç¨‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># Graph</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line"></span><br><span class="line"># Define nodes: these do the work</span><br><span class="line">builder.add_node(&quot;assistant&quot;, assistant)</span><br><span class="line">builder.add_node(&quot;tools&quot;, ToolNode(tools))</span><br><span class="line"></span><br><span class="line"># Define edges: these determine how the control flow moves</span><br><span class="line">builder.add_edge(START, &quot;assistant&quot;)</span><br><span class="line">builder.add_conditional_edges(</span><br><span class="line">    &quot;assistant&quot;,</span><br><span class="line">    # If the latest message (result) from assistant is a tool call -&gt; tools_condition routes to tools</span><br><span class="line">    # If the latest message (result) from assistant is a not a tool call -&gt; tools_condition routes to END</span><br><span class="line">    tools_condition,</span><br><span class="line">)</span><br><span class="line">builder.add_edge(&quot;tools&quot;, &quot;assistant&quot;)</span><br><span class="line">react_graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># Show</span><br><span class="line">display(Image(react_graph.get_graph(xray=True).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250719145948088.png" alt="image-20250719145948088"></p>
<h5 id="è°ƒç”¨-1"><a href="#è°ƒç”¨-1" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">messages = [HumanMessage(content=&quot;å°†3å’Œ4ç›¸åŠ ã€‚å°†ç»“æœä¹˜ä»¥2ã€‚å†å°†ç»“æœé™¤ä»¥5ã€‚&quot;)]</span><br><span class="line">messages = react_graph.invoke(&#123;&quot;messages&quot;: messages&#125;)</span><br><span class="line"></span><br><span class="line">for m in messages[&#x27;messages&#x27;]:</span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<p>parallel_tool_calls=Falseçš„è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">å°†3å’Œ4ç›¸åŠ ã€‚å°†ç»“æœä¹˜ä»¥2ã€‚å†å°†ç»“æœé™¤ä»¥5ã€‚</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line">Tool Calls:</span><br><span class="line">  add (call_6c69898dba0342bfbb889e)</span><br><span class="line"> Call ID: call_6c69898dba0342bfbb889e</span><br><span class="line">  Args:</span><br><span class="line">    a: 3</span><br><span class="line">    b: 4</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: add</span><br><span class="line"></span><br><span class="line">7</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line">Tool Calls:</span><br><span class="line">  multiply (call_9940e7603ecf4a13a5f2fb)</span><br><span class="line"> Call ID: call_9940e7603ecf4a13a5f2fb</span><br><span class="line">  Args:</span><br><span class="line">    a: 7</span><br><span class="line">    b: 2</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: multiply</span><br><span class="line"></span><br><span class="line">14</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line">Tool Calls:</span><br><span class="line">  divide (call_d48fbbe205a14dfbaa3500)</span><br><span class="line"> Call ID: call_d48fbbe205a14dfbaa3500</span><br><span class="line">  Args:</span><br><span class="line">    a: 14</span><br><span class="line">    b: 5</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: divide</span><br><span class="line"></span><br><span class="line">2.8</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">æœ€ç»ˆç»“æœæ˜¯2.8ã€‚</span><br></pre></td></tr></table></figure>
<p>parallel_tool_calls=Trueçš„è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">å°†3å’Œ4ç›¸åŠ ã€‚å°†ç»“æœä¹˜ä»¥2ã€‚å†å°†ç»“æœé™¤ä»¥5ã€‚</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line">Tool Calls:</span><br><span class="line">  add (call_e0c7d8e65f2c49e8aecd3e)</span><br><span class="line"> Call ID: call_e0c7d8e65f2c49e8aecd3e</span><br><span class="line">  Args:</span><br><span class="line">    a: 3</span><br><span class="line">    b: 4</span><br><span class="line">  multiply (call_5bf824058e64489aaace91)</span><br><span class="line"> Call ID: call_5bf824058e64489aaace91</span><br><span class="line">  Args:</span><br><span class="line">    a: 7</span><br><span class="line">    b: 2</span><br><span class="line">  divide (call_36c34f69f6574028b28847)</span><br><span class="line"> Call ID: call_36c34f69f6574028b28847</span><br><span class="line">  Args:</span><br><span class="line">    a: 14</span><br><span class="line">    b: 5</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: add</span><br><span class="line"></span><br><span class="line">7</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: multiply</span><br><span class="line"></span><br><span class="line">14</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: divide</span><br><span class="line"></span><br><span class="line">2.8</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">æœ€ç»ˆç»“æœæ˜¯ **2.8**ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="Agent-memoryä»£ç†è®°å¿†"><a href="#Agent-memoryä»£ç†è®°å¿†" class="headerlink" title="Agent memoryä»£ç†è®°å¿†"></a>Agent memoryä»£ç†è®°å¿†</h4><p>ä½¿ç”¨chekpointeræ£€æŸ¥ç‚¹çš„åŠŸèƒ½ï¼Œæœ€ç®€å•çš„æ£€æŸ¥ç‚¹ä¹‹ä¸€æ˜¯ <code>MemorySaver</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºå›¾å½¢çŠ¶æ€çš„å†…å­˜é”®å€¼å­˜å‚¨ã€‚</p>
<p>è¿™ä¸ªæ£€æŸ¥ç‚¹å°±ç›¸å½“äºæŠŠ<strong>å›¾çš„æ¯ä¸€æ¬¡â€œçŠ¶æ€å¿«ç…§â€æŒä¹…åŒ–åˆ°å¤–éƒ¨å­˜å‚¨</strong>çš„æœºåˆ¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">memory = MemorySaver()</span><br><span class="line">react_graph_memory = builder.compile(checkpointer=memory)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/persistence/">è®°å¿†åŠŸèƒ½</a> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼LangGraph å¯ä»¥ä½¿ç”¨æ£€æŸ¥ç‚¹å·¥å…·åœ¨æ¯ä¸€æ­¥ä¹‹åè‡ªåŠ¨ä¿å­˜å›¾çš„çŠ¶æ€ã€‚è¿™ä¸€å†…ç½®çš„æŒä¹…åŒ–å±‚ä¸ºæˆ‘ä»¬æä¾›äº†å†…å­˜åŠŸèƒ½ï¼Œä½¿ LangGraph èƒ½å¤Ÿä»æœ€åä¸€æ¬¡çŠ¶æ€æ›´æ–°å¤„ç»§ç»­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Specify a thread</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># Specify an input</span><br><span class="line">messages = [HumanMessage(content=&quot;Add 3 and 4.&quot;)]</span><br><span class="line"></span><br><span class="line"># Run</span><br><span class="line">messages = react_graph_memory.invoke(&#123;&quot;messages&quot;: messages&#125;,config)</span><br><span class="line">for m in messages[&#x27;messages&#x27;]:</span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ä½¿ç”¨å†…å­˜æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šä¸€ä¸ª <code>thread_id</code>ã€‚è¿™ <code>thread_id</code> å°†å­˜å‚¨æˆ‘ä»¬çš„å›¾å½¢çŠ¶æ€é›†åˆã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼Œæ£€æŸ¥ç‚¹åœ¨å›¾çš„æ¯ä¸€æ­¥å†™å…¥çŠ¶æ€ï¼Œè¿™äº›æ£€æŸ¥ç‚¹ä¿å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>thread_id</code> åœ¨æœªæ¥è®¿é—®è¯¥çº¿ç¨‹</p>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/66e0e9f526b41a4ed9e2d28b_agent-memory2.png" alt="state.jpg"></p>
<h3 id="module-2"><a href="#module-2" class="headerlink" title="module-2"></a>module-2</h3><h4 id="state-schemeçŠ¶æ€æ¨¡å¼"><a href="#state-schemeçŠ¶æ€æ¨¡å¼" class="headerlink" title="state-schemeçŠ¶æ€æ¨¡å¼"></a>state-schemeçŠ¶æ€æ¨¡å¼</h4><p>LangGraph çš„ <strong>state-schemeï¼ˆçŠ¶æ€æ¨¡å¼ï¼‰</strong> å°±æ˜¯â€œä¸€å¼ <strong>è“å›¾</strong>â€ï¼Œå®ƒå‘Šè¯‰æ¡†æ¶ï¼šâ€œåœ¨æ•´ä¸ªå›¾çš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼ŒçŠ¶æ€å¯¹è±¡åº”è¯¥é•¿ä»€ä¹ˆæ ·ã€æ¯ä¸ªå­—æ®µæ€æ ·è¢«æ›´æ–°ã€ä»¥åŠèŠ‚ç‚¹ä¹‹é—´å¦‚ä½•å…±äº«æˆ–éš”ç¦»æ•°æ®ã€‚â€</p>
<p>state-scheme ç”¨ <strong>TypedDict</strong> æˆ– <strong>Pydantic BaseModel</strong> æ¥å£°æ˜ï¼Œå®šä¹‰äº†ï¼š</p>
<ul>
<li>çŠ¶æ€é‡Œæœ‰å“ªäº›å­—æ®µï¼ˆkeyï¼‰</li>
<li>æ¯ä¸ªå­—æ®µçš„ Python ç±»å‹</li>
<li><strong>å¯é€‰</strong> è¯¥å­—æ®µçš„ <strong>reducer</strong>ï¼ˆæ›´æ–°è§„åˆ™ï¼‰</li>
</ul>
<h5 id="TypedDict"><a href="#TypedDict" class="headerlink" title="TypedDict"></a><strong>TypedDict</strong></h5><p><strong>åŸºæœ¬å®šä¹‰</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from typing_extensions import TypedDict</span><br><span class="line"></span><br><span class="line">class TypedDictState(TypedDict):</span><br><span class="line">    foo: str</span><br><span class="line">    bar: str</span><br></pre></td></tr></table></figure>
<p><strong>å¯å¢åŠ åƒ <code>Literal</code> è¿™æ ·çš„ç±»å‹æç¤ºï¼Œä½¿å…¶æ›´æœ‰ä»·å€¼</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from typing import Literal</span><br><span class="line"></span><br><span class="line">class TypedDictState(TypedDict):</span><br><span class="line">    name: str</span><br><span class="line">    mood: Literal[&quot;happy&quot;,&quot;sad&quot;]</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œï¼Œ<code>mood</code> åªèƒ½æ˜¯ â€œhappyâ€ æˆ– â€œsadâ€ã€‚</p>
<p><strong>åŠ  reducerï¼šè®©æ›´æ–°â€œå¯è¿½åŠ â€è€Œä¸è¦†ç›–</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class MathState(TypedDict):</span><br><span class="line">    question: str</span><br><span class="line">    scratchpad: Annotated[list[str], add_message]  # æ–°å…ƒç´ è‡ªåŠ¨è¿½åŠ </span><br><span class="line">    answer: int</span><br></pre></td></tr></table></figure>
<p><code>Annotated[list[str], add]</code> å‘Šè¯‰ LangGraphï¼šå½“èŠ‚ç‚¹è¿”å› <code>&#123;&quot;scratchpad&quot;: [&quot;æ–°æ­¥éª¤&quot;]&#125;</code> æ—¶ï¼Œ<strong>è¿½åŠ </strong>åˆ°ç°æœ‰åˆ—è¡¨ï¼Œè€Œä¸æ˜¯æ›¿æ¢</p>
<p><strong>ç¤ºä¾‹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line">from IPython.display import Image, display</span><br><span class="line">from langgraph.graph import StateGraph, START, END</span><br><span class="line">#å®šä¹‰èŠ‚ç‚¹</span><br><span class="line">def node_1(state):</span><br><span class="line">    print(&quot;---Node 1---&quot;)</span><br><span class="line">    return &#123;&quot;name&quot;: state[&#x27;name&#x27;] + &quot; is ... &quot;&#125;</span><br><span class="line"></span><br><span class="line">def node_2(state):</span><br><span class="line">    print(&quot;---Node 2---&quot;)</span><br><span class="line">    return &#123;&quot;mood&quot;: &quot;happy&quot;&#125;</span><br><span class="line"></span><br><span class="line">def node_3(state):</span><br><span class="line">    print(&quot;---Node 3---&quot;)</span><br><span class="line">    return &#123;&quot;mood&quot;: &quot;sad&quot;&#125;</span><br><span class="line">#è·¯ç”±å‡½æ•°</span><br><span class="line">def decide_mood(state) -&gt; Literal[&quot;node_2&quot;, &quot;node_3&quot;]:</span><br><span class="line">        </span><br><span class="line">    # Here, let&#x27;s just do a 50 / 50 split between nodes 2, 3</span><br><span class="line">    if random.random() &lt; 0.5:</span><br><span class="line"></span><br><span class="line">        # 50% of the time, we return Node 2</span><br><span class="line">        return &quot;node_2&quot;</span><br><span class="line">    </span><br><span class="line">    # 50% of the time, we return Node 3</span><br><span class="line">    return &quot;node_3&quot;</span><br><span class="line"></span><br><span class="line"># Build graph</span><br><span class="line">builder = StateGraph(TypedDictState)</span><br><span class="line">builder.add_node(&quot;node_1&quot;, node_1)</span><br><span class="line">builder.add_node(&quot;node_2&quot;, node_2)</span><br><span class="line">builder.add_node(&quot;node_3&quot;, node_3)</span><br><span class="line"></span><br><span class="line"># Logic</span><br><span class="line">builder.add_edge(START, &quot;node_1&quot;)</span><br><span class="line">builder.add_conditional_edges(&quot;node_1&quot;, decide_mood)</span><br><span class="line">builder.add_edge(&quot;node_2&quot;, END)</span><br><span class="line">builder.add_edge(&quot;node_3&quot;, END)</span><br><span class="line"></span><br><span class="line"># Add</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250719154439415.png" alt="image-20250719154439415"></p>
<p>å› ä¸ºæˆ‘ä»¬çš„çŠ¶æ€æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæˆ‘ä»¬åªéœ€ç”¨ä¸€ä¸ªå­—å…¸è°ƒç”¨å›¾ï¼Œä»¥è®¾ç½®çŠ¶æ€ä¸­ <code>name</code> é”®çš„åˆå§‹å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(&#123;&quot;name&quot;:&quot;Lance&quot;&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="Dataclassæ•°æ®ç±»"><a href="#Dataclassæ•°æ®ç±»" class="headerlink" title="Dataclassæ•°æ®ç±»"></a><strong>Dataclassæ•°æ®ç±»</strong></h5><p>pythonçš„dataclassesåº“æä¾›äº†ä¸€ç§ç®€æ´çš„è¯­æ³•ï¼Œç”¨äºåˆ›å»ºä¸»è¦ç”¨äºå­˜å‚¨æ•°æ®çš„ç±»ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from dataclasses import dataclass</span><br><span class="line"></span><br><span class="line">@dataclass</span><br><span class="line">class DataclassState:</span><br><span class="line">    name: str</span><br><span class="line">    mood: Literal[&quot;happy&quot;,&quot;sad&quot;]</span><br></pre></td></tr></table></figure>
<p><strong>ç¤ºä¾‹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">def node_1(state):</span><br><span class="line">    print(&quot;---Node 1---&quot;)</span><br><span class="line">    return &#123;&quot;name&quot;: state.name + &quot; is ... &quot;&#125;</span><br><span class="line"></span><br><span class="line"># Build graph</span><br><span class="line">builder = StateGraph(DataclassState)</span><br><span class="line">builder.add_node(&quot;node_1&quot;, node_1)</span><br><span class="line">builder.add_node(&quot;node_2&quot;, node_2)</span><br><span class="line">builder.add_node(&quot;node_3&quot;, node_3)</span><br><span class="line"></span><br><span class="line"># Logic</span><br><span class="line">builder.add_edge(START, &quot;node_1&quot;)</span><br><span class="line">builder.add_conditional_edges(&quot;node_1&quot;, decide_mood)</span><br><span class="line">builder.add_edge(&quot;node_2&quot;, END)</span><br><span class="line">builder.add_edge(&quot;node_3&quot;, END)</span><br><span class="line"></span><br><span class="line"># Add</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p>è¦è®¿é—® <code>dataclass</code> çš„é”®ï¼Œæˆ‘ä»¬åªéœ€ä¿®æ”¹åœ¨ <code>node_1</code> ä¸­ä½¿ç”¨çš„ä¸‹æ ‡å³å¯ï¼š</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>state.name</code> æ¥è¡¨ç¤º <code>dataclass</code> çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ <code>state[&quot;name&quot;]</code> æ¥è¡¨ç¤ºä¸Šé¢çš„ <code>TypedDict</code>ã€‚</p>
<p>ä½ ä¼šæ³¨æ„åˆ°ä¸€ä¸ªæœ‰ç‚¹å¥‡æ€ªçš„åœ°æ–¹ï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶è¿”å›ä¸€ä¸ªå­—å…¸æ¥æ‰§è¡ŒçŠ¶æ€æ›´æ–°ã€‚</p>
<p><strong>Dataclass åªæ˜¯â€œæè¿°â€çŠ¶æ€çš„å½¢çŠ¶ï¼Œè€ŒçœŸæ­£åœ¨ LangGraph çš„èŠ‚ç‚¹ä¹‹é—´æµåŠ¨çš„ä¾æ—§æ˜¯ã€Œå­—å…¸ã€</strong>ï¼Œè¿™æ˜¯æ¡†æ¶è®¾è®¡å±‚é¢çš„çº¦å®š</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>dataclass</code> æ‹¥æœ‰é”® <code>name</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»èŠ‚ç‚¹ä¼ é€’ä¸€ä¸ªå­—å…¸æ¥æ›´æ–°å®ƒï¼Œå°±åƒåœ¨çŠ¶æ€ä¸º <code>TypedDict</code> æ—¶æ‰€åšçš„é‚£æ ·ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(DataclassState(name=&quot;Lance&quot;,mood=&quot;sad&quot;))</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é€šè¿‡ <code>dataclass</code> æ¥è®¾ç½®çŠ¶æ€ä¸­æ¯ä¸ªé”®/é€šé“çš„åˆå§‹å€¼ï¼</p>
<h4 id="State-ReducersçŠ¶æ€æ›´æ–°å‡½æ•°"><a href="#State-ReducersçŠ¶æ€æ›´æ–°å‡½æ•°" class="headerlink" title="State ReducersçŠ¶æ€æ›´æ–°å‡½æ•°"></a><strong>State Reducers</strong>çŠ¶æ€æ›´æ–°å‡½æ•°</h4><p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/low_level/#reducers">Reducers</a> ä¸ºæˆ‘ä»¬æŒ‡å®šäº†å¦‚ä½•æ‰§è¡Œæ›´æ–°ã€‚å®ƒæ¥æ”¶ <strong>æ—§çŠ¶æ€</strong> ä¸ <strong>ä¸€æ¬¡å˜æ›´æŒ‡ä»¤ï¼ˆaction / å¢é‡å­—æ®µï¼‰</strong>ï¼Œ<strong>è¿”å›å…¨æ–°çš„çŠ¶æ€å¯¹è±¡</strong>ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­<strong>ä¸èƒ½ä¿®æ”¹åŸæœ‰æ•°æ®</strong>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>Annotated</code> ç±»å‹æ¥æŒ‡å®šä¸€ä¸ª reducer å‡½æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè®©æˆ‘ä»¬å°†æ¯ä¸ªèŠ‚ç‚¹è¿”å›çš„å€¼é™„åŠ åˆ°ç»“æœä¸­ï¼Œè€Œä¸æ˜¯è¦†ç›–å®ƒä»¬ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from operator import add</span><br><span class="line">from typing import Annotated</span><br><span class="line"></span><br><span class="line">class State(TypedDict):</span><br><span class="line">    foo: Annotated[list[int], add]</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªå¯ä»¥æ‰§è¡Œæ­¤æ“ä½œçš„ç¼©å‡å™¨ï¼š<code>operator.add</code> æ˜¯ Python å†…ç½® operator æ¨¡å—ä¸­çš„ä¸€ä¸ªå‡½æ•°ã€‚å½“ <code>operator.add</code> åº”ç”¨äºåˆ—è¡¨æ—¶ï¼Œå®ƒæ‰§è¡Œåˆ—è¡¨è¿æ¥ã€‚</p>
<h5 id="Custom-Reducers-è‡ªå®šä¹‰-Reducers"><a href="#Custom-Reducers-è‡ªå®šä¹‰-Reducers" class="headerlink" title="Custom Reducers è‡ªå®šä¹‰ Reducers"></a><strong>Custom Reducers è‡ªå®šä¹‰ Reducers</strong></h5><p>æˆ‘ä»¬åŒæ ·å¯ä»¥è‡ªå®šä¹‰reducerså‡½æ•°ï¼Œè§£å†³ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚ï¼Œå¦‚ä¸‹å¯ä»¥è§£å†³ä¼ å…¥å‚æ•°ä¸ºnoneçš„æƒ…å†µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def reduce_list(left: list | None, right: list | None) -&gt; list:</span><br><span class="line">    &quot;&quot;&quot;å®‰å…¨åœ°åˆå¹¶ä¸¤ä¸ªåˆ—è¡¨ï¼Œå¤„ç†å…¶ä¸­ä¸€ä¸ªæˆ–ä¸¤ä¸ªè¾“å…¥å¯èƒ½ä¸º None çš„æƒ…å†µã€‚</span><br><span class="line"></span><br><span class="line">    å‚æ•°ï¼š</span><br><span class="line">        left (list | None): è¦åˆå¹¶çš„ç¬¬ä¸€ä¸ªåˆ—è¡¨ï¼Œæˆ– Noneã€‚</span><br><span class="line">        right (list | None): è¦åˆå¹¶çš„ç¬¬äºŒä¸ªåˆ—è¡¨ï¼Œæˆ– Noneã€‚</span><br><span class="line"></span><br><span class="line">    è¿”å›ï¼š</span><br><span class="line">        list: ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªè¾“å…¥åˆ—è¡¨æ‰€æœ‰å…ƒç´ çš„æ–°åˆ—è¡¨ã€‚</span><br><span class="line">               å¦‚æœè¾“å…¥ä¸º Noneï¼Œåˆ™å°†å…¶è§†ä¸ºç©ºåˆ—è¡¨ã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    if not left:</span><br><span class="line">        left = []</span><br><span class="line">    if not right:</span><br><span class="line">        right = []</span><br><span class="line">    return left + right</span><br><span class="line"></span><br><span class="line">class DefaultState(TypedDict):</span><br><span class="line">    foo: Annotated[list[int], add]</span><br><span class="line"></span><br><span class="line">class CustomReducerState(TypedDict):</span><br><span class="line">    foo: Annotated[list[int], reduce_list]</span><br></pre></td></tr></table></figure>
<h5 id="MessagesState"><a href="#MessagesState" class="headerlink" title="MessagesState"></a>MessagesState</h5><p>æˆ‘å¯ä»¥ä½¿ç”¨å†…ç½®çš„ reducer <code>add_messages</code> æ¥å¤„ç†çŠ¶æ€ä¸­çš„æ¶ˆæ¯</p>
<p>è€Œ<em><code>MessagesState</code></em> <em>å†…ç½®äº†ä¸€ä¸ª</em> <em><code>messages</code></em> é”® å®ƒè¿˜ä¸ºè¯¥é”®å†…ç½®äº†ä¸€ä¸ª <code>add_messages</code> åˆå¹¶å™¨ï¼Œè¿™ä¸¤ä¸ªæ˜¯ç­‰ä»·çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from typing import Annotated</span><br><span class="line">from langgraph.graph import MessagesState</span><br><span class="line">from langchain_core.messages import AnyMessage</span><br><span class="line">from langgraph.graph.message import add_messages</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ TypedDictï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå¸¦æœ‰ add_messages reducer çš„æ¶ˆæ¯åˆ—è¡¨ã€‚</span><br><span class="line">class CustomMessagesState(TypedDict):</span><br><span class="line">    messages: Annotated[list[AnyMessage], add_messages]</span><br><span class="line">    added_key_1: str</span><br><span class="line">    added_key_2: str</span><br><span class="line">    # etc</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨ MessagesState ï¼Œå®ƒåŒ…å«å¸¦æœ‰ add_messages reducer çš„ messages é”®ã€‚</span><br><span class="line">class ExtendedMessagesState(MessagesState):</span><br><span class="line">    # æ·»åŠ é™¤ messages ä¹‹å¤–æ‰€éœ€çš„ä»»ä½•é”®ï¼Œ messages æ˜¯é¢„æ„å»ºçš„ã€‚</span><br><span class="line">    added_key_1: str</span><br><span class="line">    added_key_2: str</span><br><span class="line">    # etc</span><br></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨ <code>add_messages</code> reducer æ—¶ï¼Œè®©æˆ‘ä»¬å±•ç¤ºä¸€äº›æœ‰ç”¨çš„æŠ€å·§ã€‚</p>
<p><strong>é‡å†™ï¼ˆRe-writingï¼‰</strong></p>
<p>å¦‚æœæˆ‘ä»¬ä¼ é€’çš„æ¶ˆæ¯ä¸ <code>messages</code> åˆ—è¡¨ä¸­å·²æœ‰çš„æ¶ˆæ¯å…·æœ‰ç›¸åŒçš„ IDï¼Œåˆ™è¯¥æ¶ˆæ¯å°†è¢«è¦†ç›–ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Initial state</span><br><span class="line">initial_messages = [AIMessage(content=&quot;Hello! How can I assist you?&quot;, name=&quot;Model&quot;, id=&quot;1&quot;),</span><br><span class="line">                    HumanMessage(content=&quot;I&#x27;m looking for information on marine biology.&quot;, name=&quot;Lance&quot;, id=&quot;2&quot;)</span><br><span class="line">                   ]</span><br><span class="line"></span><br><span class="line"># New message to add</span><br><span class="line">new_message = HumanMessage(content=&quot;I&#x27;m looking for information on whales, specifically&quot;, name=&quot;Lance&quot;, id=&quot;2&quot;)</span><br><span class="line"></span><br><span class="line"># Test</span><br><span class="line">add_messages(initial_messages , new_message)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[AIMessage(content=&#x27;Hello! How can I assist you?&#x27;, name=&#x27;Model&#x27;, id=&#x27;1&#x27;),</span><br><span class="line"> HumanMessage(content=&quot;I&#x27;m looking for information on whales, specifically&quot;, name=&#x27;Lance&#x27;, id=&#x27;2&#x27;)]</span><br></pre></td></tr></table></figure>
<p><strong>åˆ é™¤ï¼ˆRemovalï¼‰</strong></p>
<p><code>add_messages</code> ä¹Ÿ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/memory/delete-messages/">åŒæ ·æ”¯æŒåˆ é™¤</a>ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ç®€å•åœ°ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://api.python.langchain.com/en/latest/messages/langchain_core.messages.modifier.RemoveMessage.html">RemoveMessage</a> æ¥è‡ª <code>langchain_core</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import RemoveMessage</span><br><span class="line"></span><br><span class="line"># Message list</span><br><span class="line">messages = [AIMessage(&quot;Hi.&quot;, name=&quot;Bot&quot;, id=&quot;1&quot;)]</span><br><span class="line">messages.append(HumanMessage(&quot;Hi.&quot;, name=&quot;Lance&quot;, id=&quot;2&quot;))</span><br><span class="line">messages.append(AIMessage(&quot;So you said you were researching ocean mammals?&quot;, name=&quot;Bot&quot;, id=&quot;3&quot;))</span><br><span class="line">messages.append(HumanMessage(&quot;Yes, I know about whales. But what others should I learn about?&quot;, name=&quot;Lance&quot;, id=&quot;4&quot;))</span><br><span class="line"></span><br><span class="line"># Isolate messages to delete</span><br><span class="line">delete_messages = [RemoveMessage(id=m.id) for m in messages[:-2]]</span><br><span class="line">print(delete_messages)</span><br></pre></td></tr></table></figure>
<h4 id="Multiple-Schemas-å¤šç§çŠ¶æ€"><a href="#Multiple-Schemas-å¤šç§çŠ¶æ€" class="headerlink" title="Multiple Schemas å¤šç§çŠ¶æ€"></a><strong>Multiple Schemas</strong> å¤šç§çŠ¶æ€</h4><h5 id="Private-State-ç§æœ‰çŠ¶æ€"><a href="#Private-State-ç§æœ‰çŠ¶æ€" class="headerlink" title="Private State ç§æœ‰çŠ¶æ€"></a><strong>Private State</strong> ç§æœ‰çŠ¶æ€</h5><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬è®¨è®ºåœ¨èŠ‚ç‚¹ä¹‹é—´ä¼ é€’ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/pass_private_state/">private state</a> çš„æƒ…å†µã€‚è¿™å¯¹äºå›¾çš„ä¸­é—´è®¡ç®—é€»è¾‘ä¸­éœ€è¦çš„ä»»ä½•å†…å®¹éƒ½å¾ˆæœ‰ç”¨ï¼Œä½†ä¸å›¾çš„æ•´ä½“è¾“å…¥æˆ–è¾“å‡ºæ— å…³ã€‚</p>
<p>ç¤ºä¾‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">from typing_extensions import TypedDict</span><br><span class="line">from IPython.display import Image, display</span><br><span class="line">from langgraph.graph import StateGraph, START, END</span><br><span class="line"></span><br><span class="line">class OverallState(TypedDict):</span><br><span class="line">    foo: int</span><br><span class="line"></span><br><span class="line">class PrivateState(TypedDict):</span><br><span class="line">    baz: int</span><br><span class="line"></span><br><span class="line">def node_1(state: OverallState) -&gt; PrivateState:</span><br><span class="line">    print(&quot;---Node 1---&quot;)</span><br><span class="line">    return &#123;&quot;baz&quot;: state[&#x27;foo&#x27;] + 1&#125;</span><br><span class="line"></span><br><span class="line">def node_2(state: PrivateState) -&gt; OverallState:</span><br><span class="line">    print(&quot;---Node 2---&quot;)</span><br><span class="line">    return &#123;&quot;foo&quot;: state[&#x27;baz&#x27;] + 1&#125;</span><br><span class="line"></span><br><span class="line"># Build graph</span><br><span class="line">builder = StateGraph(OverallState)</span><br><span class="line">builder.add_node(&quot;node_1&quot;, node_1)</span><br><span class="line">builder.add_node(&quot;node_2&quot;, node_2)</span><br><span class="line"></span><br><span class="line"># Logic</span><br><span class="line">builder.add_edge(START, &quot;node_1&quot;)</span><br><span class="line">builder.add_edge(&quot;node_1&quot;, &quot;node_2&quot;)</span><br><span class="line">builder.add_edge(&quot;node_2&quot;, END)</span><br><span class="line"></span><br><span class="line"># Add</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250719171509917.png" alt="image-20250719171509917"></p>
<p>æˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ª <code>OverallState</code> å’Œä¸€ä¸ª <code>PrivateState</code>ã€‚<code>node_2</code> ä½¿ç”¨ <code>PrivateState</code> ä½œä¸ºè¾“å…¥ï¼Œä½†è¾“å‡ºå†™å…¥åˆ° <code>OverallState</code>ã€‚</p>
<p><code>baz</code> ä»…åŒ…å«åœ¨ <code>PrivateState</code> ä¸­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>baz</code> è¢«æ’é™¤åœ¨å›¾å½¢è¾“å‡ºä¹‹å¤–ï¼Œå› ä¸ºå®ƒä¸åœ¨ <code>OverallState</code> ä¸­ã€‚</p>
<h5 id="Input-Output-Schema-è¾“å…¥-è¾“å‡ºæ¨¡å¼"><a href="#Input-Output-Schema-è¾“å…¥-è¾“å‡ºæ¨¡å¼" class="headerlink" title="Input / Output Schema è¾“å…¥/è¾“å‡ºæ¨¡å¼"></a><strong>Input / Output Schema </strong>è¾“å…¥/è¾“å‡ºæ¨¡å¼</h5><p>åœ¨ LangGraph ä¸­ï¼Œ<strong>Input / Output Schema</strong> å°±æ˜¯â€œ<strong>å›¾çš„å¯¹å¤–æ¥å£åè®®</strong>â€ï¼š<strong>è°ƒç”¨è€…åªèƒ½æŒ‰ Input Schema ä¼ å‚ï¼›å›¾è¿è¡Œå®Œåï¼Œåªåå‡º Output Schema è§„å®šçš„å­—æ®µã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.graph import StateGraph, START, END</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line"></span><br><span class="line"># å®šä¹‰è¾“å…¥çš„æ¨¡å¼</span><br><span class="line">class InputState(TypedDict):</span><br><span class="line">    question: str</span><br><span class="line"></span><br><span class="line"># å®šä¹‰è¾“å‡ºçš„æ¨¡å¼</span><br><span class="line">class OutputState(TypedDict):</span><br><span class="line">    answer: str</span><br><span class="line"></span><br><span class="line"># å®šä¹‰æ•´ä½“æ¨¡å¼ï¼Œç»“åˆè¾“å…¥å’Œè¾“å‡º</span><br><span class="line">class OverallState(InputState, OutputState):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å¤„ç†è¾“å…¥å¹¶ç”Ÿæˆç­”æ¡ˆçš„èŠ‚ç‚¹</span><br><span class="line">def answer_node(state: InputState):</span><br><span class="line">    # ç¤ºä¾‹ç­”æ¡ˆå’Œé¢å¤–é”®</span><br><span class="line">    return &#123;&quot;answer&quot;: &quot;bye&quot;, &quot;question&quot;: state[&quot;question&quot;]&#125;</span><br><span class="line"></span><br><span class="line"># æ„å»ºå›¾ï¼Œå¹¶æŒ‡å®šè¾“å…¥å’Œè¾“å‡ºæ¨¡å¼</span><br><span class="line">builder = StateGraph(OverallState, input_schema=InputState, output_schema=OutputState)</span><br><span class="line">builder.add_node(answer_node)  # æ·»åŠ ç­”æ¡ˆèŠ‚ç‚¹</span><br><span class="line">builder.add_edge(START, &quot;answer_node&quot;)  # å®šä¹‰èµ·å§‹è¾¹</span><br><span class="line">builder.add_edge(&quot;answer_node&quot;, END)  # å®šä¹‰ç»“æŸè¾¹</span><br><span class="line">graph = builder.compile()  # ç¼–è¯‘å›¾</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨è¾“å…¥è°ƒç”¨å›¾å¹¶æ‰“å°ç»“æœ</span><br><span class="line">print(graph.invoke(&#123;&quot;question&quot;: &quot;hi&quot;&#125;))</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;answer&#x27;: &#x27;bye Lance&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œï¼Œ<code>input</code> / <code>output</code> æ¨¡å¼å¯¹å›¾çš„è¾“å…¥å’Œè¾“å‡ºä¸Šå…è®¸çš„é”®è¿›è¡Œ <strong>è¿‡æ»¤</strong>ã€‚å¯ä»¥çœ‹åˆ° <code>output</code> æ¨¡å¼å°†è¾“å‡ºé™åˆ¶ä¸ºä»…åŒ…å« <code>answer</code> é”®ã€‚</p>
<h4 id="Filtering-and-trimming-messagesç­›é€‰å’Œç²¾ç®€æ¶ˆæ¯"><a href="#Filtering-and-trimming-messagesç­›é€‰å’Œç²¾ç®€æ¶ˆæ¯" class="headerlink" title="Filtering and trimming messagesç­›é€‰å’Œç²¾ç®€æ¶ˆæ¯"></a><strong>Filtering and trimming messages</strong>ç­›é€‰å’Œç²¾ç®€æ¶ˆæ¯</h4><p>å¦‚æœæˆ‘ä»¬åœ¨å¤„ç†é•¿æ—¶é—´å¯¹è¯æ—¶ä¸å¤Ÿå°å¿ƒï¼Œä¼šå¯¼è‡´é«˜ä»¤ç‰Œä½¿ç”¨é‡å’Œå»¶è¿Ÿï¼Œå› ä¸ºæˆ‘ä»¬ä¼ é€’ç»™æ¨¡å‹çš„æ˜¯ä¸€ç³»åˆ—ä¸æ–­å¢åŠ çš„æ¶ˆæ¯ã€‚æ‰€ä»¥è¦è¿›è¡Œç­›é€‰å’Œç²¾ç®€æ¶ˆæ¯ã€‚</p>
<h5 id="ç®€åŒ–å™¨ï¼ˆReducerï¼‰"><a href="#ç®€åŒ–å™¨ï¼ˆReducerï¼‰" class="headerlink" title="ç®€åŒ–å™¨ï¼ˆReducerï¼‰"></a><strong>ç®€åŒ–å™¨ï¼ˆReducerï¼‰</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import RemoveMessage</span><br><span class="line"></span><br><span class="line"># Nodes</span><br><span class="line">def filter_messages(state: MessagesState):</span><br><span class="line">    # åˆ é™¤é™¤æœ€è¿‘ä¸¤æ¡æ¶ˆæ¯å¤–çš„æ‰€æœ‰æ¶ˆæ¯</span><br><span class="line">    delete_messages = [RemoveMessage(id=m.id) for m in state[&quot;messages&quot;][:-2]]</span><br><span class="line">    return &#123;&quot;messages&quot;: delete_messages&#125;</span><br><span class="line"></span><br><span class="line">def chat_model_node(state: MessagesState):    </span><br><span class="line">    return &#123;&quot;messages&quot;: [llm.invoke(state[&quot;messages&quot;])]&#125;</span><br><span class="line"></span><br><span class="line"># Build graph</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;filter&quot;, filter_messages)</span><br><span class="line">builder.add_node(&quot;chat_model&quot;, chat_model_node)</span><br><span class="line">builder.add_edge(START, &quot;filter&quot;)</span><br><span class="line">builder.add_edge(&quot;filter&quot;, &quot;chat_model&quot;)</span><br><span class="line">builder.add_edge(&quot;chat_model&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250719203204234.png" alt="image-20250719203204234"></p>
<h5 id="ç­›é€‰æ¶ˆæ¯ï¼ˆFiltering-messagesï¼‰"><a href="#ç­›é€‰æ¶ˆæ¯ï¼ˆFiltering-messagesï¼‰" class="headerlink" title="ç­›é€‰æ¶ˆæ¯ï¼ˆFiltering messagesï¼‰"></a><strong>ç­›é€‰æ¶ˆæ¯ï¼ˆFiltering messagesï¼‰</strong></h5><p>å¦‚æœä½ ä¸éœ€è¦æˆ–ä¸å¸Œæœ›ä¿®æ”¹å›¾çŠ¶æ€ï¼Œå¯ä»¥ç›´æ¥è¿‡æ»¤ä¼ é€’ç»™èŠå¤©æ¨¡å‹çš„æ¶ˆæ¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Node</span><br><span class="line">def chat_model_node(state: MessagesState):</span><br><span class="line">    return &#123;&quot;messages&quot;: [llm.invoke(state[&quot;messages&quot;][-1:])]&#125;</span><br><span class="line"></span><br><span class="line"># Build graph</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;chat_model&quot;, chat_model_node)</span><br><span class="line">builder.add_edge(START, &quot;chat_model&quot;)</span><br><span class="line">builder.add_edge(&quot;chat_model&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œåªéœ€ä¼ é€’ä¸€ä¸ªè¿‡æ»¤åçš„åˆ—è¡¨ï¼š<code>llm.invoke(messages[-1:])</code> ç»™æ¨¡å‹ã€‚</p>
<p>çŠ¶æ€åŒ…å«äº†æ‰€æœ‰æ¶ˆæ¯ã€‚ä½†è¿™é‡Œæ¨¡å‹è°ƒç”¨ä»…ä½¿ç”¨æœ€åä¸€æ¡æ¶ˆæ¯</p>
<h5 id="è£å‰ªæ¶ˆæ¯ï¼ˆTrim-messagesï¼‰"><a href="#è£å‰ªæ¶ˆæ¯ï¼ˆTrim-messagesï¼‰" class="headerlink" title="è£å‰ªæ¶ˆæ¯ï¼ˆTrim messagesï¼‰"></a><strong>è£å‰ªæ¶ˆæ¯ï¼ˆTrim messagesï¼‰</strong></h5><p>å¦ä¸€ç§æ–¹æ³•æ˜¯æ ¹æ®è®¾å®šä¸€å®šæ•°é‡çš„tokensè¿›è¡Œ <a target="_blank" rel="noopener" href="https://python.langchain.com/v0.2/docs/how_to/trim_messages/#getting-the-last-max_tokens-tokens">trim messages</a>ã€‚åœ¨æŠŠå¯¹è¯å†å²å‘ç»™å¤§æ¨¡å‹ä¹‹å‰ï¼ŒæŒ‰ <strong>token é¢„ç®—</strong> æŠŠè¶…é•¿æ¶ˆæ¯åˆ—è¡¨â€œå‰ªâ€åˆ°åˆé€‚é•¿åº¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import trim_messages</span><br><span class="line"></span><br><span class="line"># Node</span><br><span class="line">def chat_model_node(state: MessagesState):</span><br><span class="line">    # ä½¿ç”¨ trim_messages å‡½æ•°ä¿®å‰ªæ¶ˆæ¯åˆ—è¡¨</span><br><span class="line">    # max_tokens: é™åˆ¶æ¶ˆæ¯çš„æœ€å¤§ä»¤ç‰Œæ•°</span><br><span class="line">    # strategy: ä¿®å‰ªç­–ç•¥ï¼Œè¿™é‡Œæ˜¯â€œlastâ€ï¼Œè¡¨ç¤ºä¿ç•™æœ€æ–°çš„æ¶ˆæ¯</span><br><span class="line">    # token_counter: ç”¨äºè®¡ç®—ä»¤ç‰Œæ•°çš„æ¨¡å‹å®ä¾‹</span><br><span class="line">    # allow_partial: æ˜¯å¦å…è®¸éƒ¨åˆ†ä¿®å‰ª</span><br><span class="line">    messages = trim_messages(</span><br><span class="line">            state[&quot;messages&quot;],</span><br><span class="line">            max_tokens=100,</span><br><span class="line">            strategy=&quot;last&quot;,</span><br><span class="line">            token_counter= ChatOpenAI(</span><br><span class="line">                model=&quot;qwen-plus-2025-04-28&quot;,</span><br><span class="line">                api_key=&quot;sk-&quot;,</span><br><span class="line">                base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;),</span><br><span class="line">            allow_partial=False,</span><br><span class="line">        )</span><br><span class="line">    # è°ƒç”¨è¯­è¨€æ¨¡å‹ï¼ˆllmï¼‰å¤„ç†ä¿®å‰ªåçš„æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç»“æœ</span><br><span class="line">    return &#123;&quot;messages&quot;: [llm.invoke(messages)]&#125;</span><br><span class="line"></span><br><span class="line"># Build graph</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;chat_model&quot;, chat_model_node)</span><br><span class="line">builder.add_edge(START, &quot;chat_model&quot;)</span><br><span class="line">builder.add_edge(&quot;chat_model&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<h4 id="Chatbot-with-message-summarizationå¸¦æœ‰æ¶ˆæ¯æ€»ç»“åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº"><a href="#Chatbot-with-message-summarizationå¸¦æœ‰æ¶ˆæ¯æ€»ç»“åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº" class="headerlink" title="Chatbot with message summarizationå¸¦æœ‰æ¶ˆæ¯æ€»ç»“åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº"></a><strong>Chatbot with message summarization</strong>å¸¦æœ‰æ¶ˆæ¯æ€»ç»“åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº</h4><p>ä¸å…¶ä»…ä»…ä¿®å‰ªæˆ–è¿‡æ»¤æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æ¥ç”Ÿæˆå¯¹è¯çš„å®æ—¶æ‘˜è¦ã€‚</p>
<p>è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¿ç•™æ•´ä¸ªå¯¹è¯çš„å‹ç¼©è¡¨ç¤ºï¼Œè€Œä¸ä»…ä»…æ˜¯é€šè¿‡ä¿®å‰ªæˆ–è¿‡æ»¤å°†å…¶ç§»é™¤ã€‚</p>
<p>æˆ‘ä»¬å°†ä¸ºè¯¥èŠå¤©æœºå™¨äººé…å¤‡è®°å¿†åŠŸèƒ½ï¼Œæ”¯æŒé•¿æ—¶é—´å¯¹è¯ï¼ŒåŒæ—¶ä¸ä¼šäº§ç”Ÿé«˜æ˜‚çš„ token æˆæœ¬æˆ–å»¶è¿Ÿã€‚</p>
<h5 id="å®šä¹‰æ€»ç»“çŠ¶æ€"><a href="#å®šä¹‰æ€»ç»“çŠ¶æ€" class="headerlink" title="å®šä¹‰æ€»ç»“çŠ¶æ€"></a>å®šä¹‰æ€»ç»“çŠ¶æ€</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.graph import MessagesState</span><br><span class="line">class State(MessagesState):</span><br><span class="line">    summary: str</span><br></pre></td></tr></table></figure>
<p>é™¤äº†å†…ç½®çš„ <code>messages</code> é”®ä¹‹å¤–ï¼Œæˆ‘ä»¬ç°åœ¨è¿˜å°†åŒ…å«ä¸€ä¸ªè‡ªå®šä¹‰é”®ï¼ˆ<code>summary</code>ï¼‰ã€‚</p>
<h5 id="å®šä¹‰LLMèŠ‚ç‚¹"><a href="#å®šä¹‰LLMèŠ‚ç‚¹" class="headerlink" title="å®šä¹‰LLMèŠ‚ç‚¹"></a>å®šä¹‰LLMèŠ‚ç‚¹</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import SystemMessage, HumanMessage, RemoveMessage </span><br><span class="line"> </span><br><span class="line"> # å®šä¹‰è°ƒç”¨æ¨¡å‹çš„é€»è¾‘</span><br><span class="line">def call_model(state: State): </span><br><span class="line">     </span><br><span class="line">     # è·å–æ‘˜è¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ </span><br><span class="line">     summary = state.get(&quot;summary&quot;, &quot;&quot;) </span><br><span class="line"> </span><br><span class="line">     # å¦‚æœæœ‰æ‘˜è¦ï¼Œåˆ™æ·»åŠ å®ƒ</span><br><span class="line">     if summary: </span><br><span class="line">         </span><br><span class="line">         # å°†æ‘˜è¦æ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ä¸­</span><br><span class="line">         system_message = f&quot;å…ˆå‰å¯¹è¯çš„æ‘˜è¦ï¼š&#123;summary&#125;&quot; </span><br><span class="line"> </span><br><span class="line">         # å°†æ‘˜è¦é™„åŠ åˆ°ä»»ä½•è¾ƒæ–°çš„æ¶ˆæ¯ä¸­</span><br><span class="line">         messages = [SystemMessage(content=system_message)] + state[&quot;messages&quot;] </span><br><span class="line">     </span><br><span class="line">     else: </span><br><span class="line">         messages = state[&quot;messages&quot;] </span><br><span class="line">     </span><br><span class="line">     response = model.invoke(messages) </span><br><span class="line">     return &#123;&quot;messages&quot;: response&#125; </span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹æ¥<strong>è°ƒç”¨æˆ‘ä»¬çš„LLM</strong>ï¼Œå¦‚æœå­˜åœ¨æ‘˜è¦ï¼Œåˆ™å°†å…¶çº³å…¥æç¤ºä¸­ã€‚</p>
<blockquote>
<p>å½“ call_model å‡½æ•°è¿”å› {â€œmessagesâ€: response} æ—¶ï¼Œå®ƒæ˜¯åœ¨å‘Šè¯‰ langgraph ï¼šâ€œè¯·ç”¨ response ï¼ˆå³æ¨¡å‹çš„æ–°è¾“å‡ºï¼‰æ¥æ›´æ–° State å¯¹è±¡ä¸­ messages é”®å¯¹åº”çš„å€¼ã€‚â€ langgraph ä¼šå°†è¿™ä¸ªæ–°æ¶ˆæ¯è¿½åŠ åˆ° messages åˆ—è¡¨ä¸­ï¼Œä»è€Œä¿æŒäº†å¯¹è¯å†å²çš„è¿ç»­æ€§</p>
</blockquote>
<h5 id="å®šä¹‰æ‘˜è¦èŠ‚ç‚¹"><a href="#å®šä¹‰æ‘˜è¦èŠ‚ç‚¹" class="headerlink" title="å®šä¹‰æ‘˜è¦èŠ‚ç‚¹"></a>å®šä¹‰æ‘˜è¦èŠ‚ç‚¹</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">def summarize_conversation(state: State): </span><br><span class="line">     </span><br><span class="line">     # é¦–å…ˆï¼Œæˆ‘ä»¬è·å–ä»»ä½•ç°æœ‰çš„æ‘˜è¦</span><br><span class="line">     summary = state.get(&quot;summary&quot;, &quot;&quot;) </span><br><span class="line"> </span><br><span class="line">     # åˆ›å»ºæˆ‘ä»¬çš„æ‘˜è¦æç¤º</span><br><span class="line">     if summary: </span><br><span class="line">         </span><br><span class="line">         # æ‘˜è¦å·²å­˜åœ¨</span><br><span class="line">         summary_message = ( </span><br><span class="line">             f&quot;è¿™æ˜¯è¿„ä»Šä¸ºæ­¢å¯¹è¯çš„æ‘˜è¦ï¼š&#123;summary&#125;\n\n&quot; </span><br><span class="line">             &quot;è¯·ç»“åˆä»¥ä¸Šæ–°æ¶ˆæ¯æ‰©å±•æ‘˜è¦ï¼š&quot; </span><br><span class="line">         ) </span><br><span class="line">         </span><br><span class="line">     else: </span><br><span class="line">         summary_message = &quot;åˆ›å»ºä»¥ä¸Šå¯¹è¯çš„æ‘˜è¦ï¼š&quot; </span><br><span class="line"> </span><br><span class="line">     # å°†æç¤ºæ·»åŠ åˆ°æˆ‘ä»¬çš„å†å²è®°å½•ä¸­</span><br><span class="line">     messages = state[&quot;messages&quot;] + [HumanMessage(content=summary_message)] </span><br><span class="line">     response = model.invoke(messages) </span><br><span class="line">     </span><br><span class="line">     # åˆ é™¤é™¤æœ€è¿‘2æ¡æ¶ˆæ¯å¤–çš„æ‰€æœ‰æ¶ˆæ¯</span><br><span class="line">     delete_messages = [RemoveMessage(id=m.id) for m in state[&quot;messages&quot;][:-2]] </span><br><span class="line">     return &#123;&quot;summary&quot;: response.content, &quot;messages&quot;: delete_messages&#125; </span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹æ¥<strong>ç”Ÿæˆæ‘˜è¦</strong>ã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨ <code>RemoveMessage</code> åœ¨ç”Ÿæˆæ‘˜è¦åè¿‡æ»¤æˆ‘ä»¬çš„çŠ¶æ€ã€‚</p>
<h5 id="å®šä¹‰è·¯ç”±å‡½æ•°"><a href="#å®šä¹‰è·¯ç”±å‡½æ•°" class="headerlink" title="å®šä¹‰è·¯ç”±å‡½æ•°"></a>å®šä¹‰è·¯ç”±å‡½æ•°</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.graph import END </span><br><span class="line"> # å†³å®šæ˜¯ç»“æŸå¯¹è¯è¿˜æ˜¯æ€»ç»“å¯¹è¯</span><br><span class="line">def should_continue(state: State): </span><br><span class="line">     </span><br><span class="line">     &quot;&quot;&quot;è¿”å›è¦æ‰§è¡Œçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚&quot;&quot;&quot; </span><br><span class="line">     </span><br><span class="line">     messages = state[&quot;messages&quot;] </span><br><span class="line">     </span><br><span class="line">     # å¦‚æœæ¶ˆæ¯è¶…è¿‡å…­æ¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€»ç»“å¯¹è¯</span><br><span class="line">     if len(messages) &gt; 6: </span><br><span class="line">         return &quot;summarize_conversation&quot; </span><br><span class="line">     </span><br><span class="line">     # å¦åˆ™æˆ‘ä»¬å°±å¯ä»¥ç»“æŸäº†</span><br><span class="line">     return END </span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªæ¡ä»¶è¾¹ï¼Œä»¥æ ¹æ®å¯¹è¯é•¿åº¦ç¡®å®šæ˜¯å¦ç”Ÿæˆæ‘˜è¦ã€‚</p>
<blockquote>
<p>åœ¨ langgraph ä¸­ï¼Œ Command æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»å‹ï¼Œç”¨äºæŒ‡å¯¼å›¾å½¢ï¼ˆgraphï¼‰å†³å®šæ¥ä¸‹æ¥åº”è¯¥æ‰§è¡Œå“ªä¸ªèŠ‚ç‚¹ã€‚ æ‚¨å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ç»™å›¾å½¢ä¸‹è¾¾çš„ä¸€ä¸ªâ€œå‘½ä»¤â€ã€‚</p>
</blockquote>
<h5 id="æ·»åŠ å†…å­˜å¹¶ç¼–è¯‘å›¾"><a href="#æ·»åŠ å†…å­˜å¹¶ç¼–è¯‘å›¾" class="headerlink" title="æ·»åŠ å†…å­˜å¹¶ç¼–è¯‘å›¾"></a>æ·»åŠ å†…å­˜å¹¶ç¼–è¯‘å›¾</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.graph import StateGraph, START</span><br><span class="line"></span><br><span class="line"># Define a new graph</span><br><span class="line">workflow = StateGraph(State)</span><br><span class="line">workflow.add_node(&quot;conversation&quot;, call_model)</span><br><span class="line">workflow.add_node(&quot;summarize_conversation&quot;,summarize_conversation)</span><br><span class="line"></span><br><span class="line"># Set the entrypoint as conversation</span><br><span class="line">workflow.add_edge(START, &quot;conversation&quot;)</span><br><span class="line">workflow.add_conditional_edges(&quot;conversation&quot;, should_continue)</span><br><span class="line">workflow.add_edge(&quot;summarize_conversation&quot;, END)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Compile</span><br><span class="line">memory = MemorySaver()</span><br><span class="line">graph = workflow.compile(checkpointer=memory)</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<h5 id="ä½¿ç”¨çº¿ç¨‹è°ƒç”¨"><a href="#ä½¿ç”¨çº¿ç¨‹è°ƒç”¨" class="headerlink" title="ä½¿ç”¨çº¿ç¨‹è°ƒç”¨"></a>ä½¿ç”¨çº¿ç¨‹è°ƒç”¨</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;2&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">input_message = HumanMessage(content=&quot;æˆ‘å–œæ¬¢ç©lolï¼Œä½ çŸ¥é“è¿™ä¸ªæ¸¸æˆå—&quot;)</span><br><span class="line">output = graph.invoke(&#123;&quot;messages&quot;: [input_message]&#125;, config) </span><br><span class="line">for m in output[&#x27;messages&#x27;][-1:]:</span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<p>å½“å¯¹è¯å¤§äº6ï¼Œå¯ç”Ÿæˆæ¦‚è¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.get_state(config).values.get(&quot;summary&quot;,&quot;&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="Chatbot-with-message-summarization-amp-external-DB-memoryå…·æœ‰æ¶ˆæ¯æ€»ç»“å’Œå¤–éƒ¨æ•°æ®åº“è®°å¿†çš„èŠå¤©æœºå™¨äºº"><a href="#Chatbot-with-message-summarization-amp-external-DB-memoryå…·æœ‰æ¶ˆæ¯æ€»ç»“å’Œå¤–éƒ¨æ•°æ®åº“è®°å¿†çš„èŠå¤©æœºå™¨äºº" class="headerlink" title="Chatbot with message summarization &amp; external DB memoryå…·æœ‰æ¶ˆæ¯æ€»ç»“å’Œå¤–éƒ¨æ•°æ®åº“è®°å¿†çš„èŠå¤©æœºå™¨äºº"></a><strong>Chatbot with message summarization &amp; external DB memory</strong>å…·æœ‰æ¶ˆæ¯æ€»ç»“å’Œå¤–éƒ¨æ•°æ®åº“è®°å¿†çš„èŠå¤©æœºå™¨äºº</h4><h5 id="ä½¿ç”¨æ•°æ®åº“"><a href="#ä½¿ç”¨æ•°æ®åº“" class="headerlink" title="ä½¿ç”¨æ•°æ®åº“"></a>ä½¿ç”¨æ•°æ®åº“</h5><p><code>SqliteSaver</code> æ˜¯ LangGraph æä¾›çš„ä¸€ä¸ª <strong>è½»é‡çº§çŠ¶æ€æŒä¹…åŒ–å·¥å…·</strong>ï¼Œå®ƒå°†å›¾çš„è¿è¡ŒçŠ¶æ€ï¼ˆå³ checkpointï¼‰ä¿å­˜åˆ°æœ¬åœ°çš„ SQLite æ•°æ®åº“ä¸­ï¼Œä½¿å¾—ä½ å¯ä»¥åœ¨ç¨‹åºä¸­æ–­æˆ–é‡å¯å<strong>æ¢å¤æ‰§è¡Œä¸Šä¸‹æ–‡</strong>ï¼Œç‰¹åˆ«é€‚åˆæœ¬åœ°å¼€å‘ã€å®éªŒæ€§é¡¹ç›®æˆ–ä¸­å°è§„æ¨¡åº”ç”¨ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æä¾› â€œ:memory:â€ ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªå†…å­˜ä¸­çš„ SQLite æ•°æ®åº“ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import sqlite3</span><br><span class="line"># In memory</span><br><span class="line">conn = sqlite3.connect(&quot;:memory:&quot;, check_same_thread = False)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬æä¾›ä¸€ä¸ª db è·¯å¾„ï¼Œé‚£ä¹ˆå®ƒå°†ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªç›®å½• state_dbï¼Œå¹¶å°è¯•ä» GitHub ä¸‹è½½ä¸€ä¸ªåä¸º example.db çš„ SQLite æ•°æ®åº“æ–‡ä»¶</span><br><span class="line">!mkdir -p state_db &amp;&amp; [ ! -f state_db/example.db ] &amp;&amp; wget -P state_db https://github.com/langchain-ai/langchain-academy/raw/main/module-2/state_db/example.db</span><br><span class="line"></span><br><span class="line">db_path = &quot;state_db/example.db&quot;</span><br><span class="line">conn = sqlite3.connect(db_path, check_same_thread=False)</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰checkpoint</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.checkpoint.sqlite import SqliteSaver</span><br><span class="line">memory = SqliteSaver(conn)</span><br></pre></td></tr></table></figure>
<p>åƒä¸Šä¸€ä¸ªå½¢å¼ç¼–è¯‘å›¾</p>
<p>è®©æˆ‘ä»¬ç¡®è®¤ä¸€ä¸‹æˆ‘ä»¬çš„çŠ¶æ€æ˜¯å¦å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line">graph_state = graph.get_state(config)</span><br><span class="line">graph_state</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨åƒ Sqlite è¿™æ ·çš„æ•°æ®åº“æ„å‘³ç€çŠ¶æ€ä¼šè¢«æŒä¹…åŒ–ï¼</p>
<h3 id="module-3"><a href="#module-3" class="headerlink" title="module-3"></a>module-3</h3><h4 id="Streaming-æµå¼ä¼ è¾“"><a href="#Streaming-æµå¼ä¼ è¾“" class="headerlink" title="Streaming æµå¼ä¼ è¾“"></a><strong>Streaming</strong> æµå¼ä¼ è¾“</h4><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥è°ˆè°ˆ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/low_level/#streaming">æµå¼ä¼ è¾“æˆ‘ä»¬çš„å›¾çŠ¶æ€</a> çš„æ–¹æ³•ã€‚<code>.stream</code> å’Œ <code>.astream</code> æ˜¯ç”¨äºæµå¼è¿”å›ç»“æœçš„åŒæ­¥å’Œå¼‚æ­¥æ–¹æ³•ã€‚</p>
<p><code>values</code>ï¼šè¿™å°†åœ¨æ¯ä¸ªèŠ‚ç‚¹è¢«è°ƒç”¨åæµå¼ä¼ è¾“å›¾çš„å®Œæ•´çŠ¶æ€ã€‚ <code>updates</code>ï¼šè¿™å°†åœ¨æ¯ä¸ªèŠ‚ç‚¹è¢«è°ƒç”¨åæµå¼ä¼ è¾“å›¾çš„çŠ¶æ€æ›´æ–°ã€‚</p>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/66dbaf892d24625a201744e5_streaming1.png" alt="values_vs_updates.png"></p>
<h5 id="stream-mode-â€updatesâ€"><a href="#stream-mode-â€updatesâ€" class="headerlink" title="stream_mode=â€updatesâ€"></a>stream_mode=â€updatesâ€</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Create a thread</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># Start conversation</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: [HumanMessage(content=&quot;ä½ å¥½æˆ‘æ˜¯zxj&quot;)]&#125;, config, stream_mode=&quot;updates&quot;):</span><br><span class="line">    print(chunk)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;conversation&#x27;: &#123;&#x27;messages&#x27;: AIMessage(content=&#x27;ä½ å¥½ï¼Œzxjï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï½æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼ŸğŸ˜Š&#x27;, additional_kwargs=&#123;&#x27;refusal&#x27;: None&#125;, response_metadata=&#123;&#x27;token_usage&#x27;: &#123;&#x27;completion_tokens&#x27;: 16, &#x27;prompt_tokens&#x27;: 576, &#x27;total_tokens&#x27;: 592, &#x27;completion_tokens_details&#x27;: None, &#x27;prompt_tokens_details&#x27;: None&#125;, &#x27;model_name&#x27;: &#x27;qwen-plus-2025-04-28&#x27;, &#x27;system_fingerprint&#x27;: None, &#x27;id&#x27;: &#x27;chatcmpl-891471ae-2fe8-9b3d-b5f7-f4fcd55a4e16&#x27;, &#x27;service_tier&#x27;: None, &#x27;finish_reason&#x27;: &#x27;stop&#x27;, &#x27;logprobs&#x27;: None&#125;, id=&#x27;run--f36409f3-af43-4e9b-8a46-39646ad7c106-0&#x27;, usage_metadata=&#123;&#x27;input_tokens&#x27;: 576, &#x27;output_tokens&#x27;: 16, &#x27;total_tokens&#x27;: 592, &#x27;input_token_details&#x27;: &#123;&#125;, &#x27;output_token_details&#x27;: &#123;&#125;&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>stream_mode=&quot;updates&quot;</code>ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨ <code>updates</code> è¿›è¡Œæµå¼ä¼ è¾“ï¼Œæ‰€ä»¥åªæœ‰åœ¨å›¾ä¸­çš„èŠ‚ç‚¹è¿è¡Œåï¼Œæˆ‘ä»¬æ‰èƒ½çœ‹åˆ°çŠ¶æ€çš„æ›´æ–°ã€‚æ¯ä¸ª <code>chunk</code> æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä»¥ <code>node_name</code> ä¸ºé”®ï¼Œæ›´æ–°åçš„çŠ¶æ€ä¸ºå€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Start conversation</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: [HumanMessage(content=&quot;ä½ å¥½æˆ‘æ˜¯zxj&quot;)]&#125;, config, stream_mode=&quot;updates&quot;):</span><br><span class="line">    chunk[&#x27;conversation&#x27;][&quot;messages&quot;].pretty_print()</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬ç›´æ¥æ‰“å°çŠ¶æ€æ›´æ–°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½å‘€ï¼Œzxjï¼å†æ¬¡è§åˆ°ä½ çœŸé«˜å…´ï½ğŸ˜Š æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®å¿™çš„å—ï¼Ÿ</span><br></pre></td></tr></table></figure>
<h5 id="stream-mode-â€valuesâ€"><a href="#stream-mode-â€valuesâ€" class="headerlink" title="stream_mode=â€valuesâ€"></a>stream_mode=â€valuesâ€</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Start conversation, again</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;2&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># Start conversation</span><br><span class="line">input_message = HumanMessage(content=&quot;ä½ å¥½æˆ‘æ˜¯zxj&quot;)</span><br><span class="line">for event in graph.stream(&#123;&quot;messages&quot;: [input_message]&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    for m in event[&#x27;messages&#x27;]:</span><br><span class="line">        m.pretty_print()</span><br><span class="line">    print(&quot;---&quot;*25)</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>stream_mode=&quot;values&quot;</code>.è¿™æ˜¯åœ¨ <code>conversation</code> èŠ‚ç‚¹è¢«è°ƒç”¨åï¼Œå›¾çš„æ•´ä¸ªçŠ¶æ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½æˆ‘æ˜¯zxj</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½æˆ‘æ˜¯zxj</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼Œzxjï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼ŸğŸ˜Š</span><br><span class="line">---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<h5 id="Streaming-tokens-æµå¼ä¼ è¾“ä»¤ç‰Œ"><a href="#Streaming-tokens-æµå¼ä¼ è¾“ä»¤ç‰Œ" class="headerlink" title="Streaming tokens æµå¼ä¼ è¾“ä»¤ç‰Œ"></a><strong>Streaming tokens</strong> <strong>æµå¼ä¼ è¾“ä»¤ç‰Œ</strong></h5><p>åœ¨ LangGraph ä¸­ï¼Œâ€œæµå¼ä¼ è¾“ä»¤ç‰Œï¼ˆStreaming tokensï¼‰â€æŒ‡çš„æ˜¯<strong>åœ¨èŠ‚ç‚¹å†…éƒ¨çš„å¤§æ¨¡å‹ï¼ˆLLMï¼‰ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œé€ token åœ°å°†ä¸­é—´ç»“æœå®æ—¶æ¨é€åˆ°å®¢æˆ·ç«¯</strong>çš„èƒ½åŠ›ã€‚å®ç°è¿™ä¸€èƒ½åŠ›çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ <code>astream_events</code>ï¼Œå®ƒä¼šä»¥äº‹ä»¶æµçš„å½¢å¼æš´éœ²æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ç»†èŠ‚ï¼ŒåŒ…æ‹¬æ¯ä¸€æ¬¡ LLM è°ƒç”¨äº§ç”Ÿçš„ tokenã€‚</p>
<p>æ¯ä¸ªäº‹ä»¶æ˜¯ä¸€ä¸ªåŒ…å«å‡ ä¸ªé”®çš„å­—å…¸ï¼š</p>
<p><code>event</code>ï¼šè¿™æ˜¯æ­£åœ¨å‘å‡ºçš„äº‹ä»¶çš„ç±»å‹ã€‚</p>
<p> <code>name</code>ï¼šè¿™æ˜¯äº‹ä»¶çš„åç§°ã€‚</p>
<p><code>data</code>ï¼šè¿™æ˜¯ä¸äº‹ä»¶ç›¸å…³è”çš„æ•°æ®ã€‚</p>
<p> <code>metadata</code>ï¼šåŒ…å« <code>langgraph_node</code>ï¼Œå³å‘å‡ºäº‹ä»¶çš„èŠ‚ç‚¹ã€‚</p>
<p>è¦ç‚¹æ˜¯ï¼Œå›¾è¡¨ä¸­èŠå¤©æ¨¡å‹çš„ä»¤ç‰Œå…·æœ‰ <code>on_chat_model_stream</code> ç±»å‹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>event[&#39;metadata&#39;][&#39;langgraph_node&#39;]</code> æ¥é€‰æ‹©è¦æµå¼çš„èŠ‚ç‚¹ã€‚å¹¶ä¸”æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>event[&#39;data&#39;]</code> æ¥è·å–æ¯ä¸ªäº‹ä»¶çš„å®é™…æ•°æ®ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®æ˜¯ä¸€ä¸ª <code>AIMessageChunk</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">node_to_stream = &#x27;conversation&#x27;#å®šä¹‰æµå¼ä¼ è¾“çš„èŠ‚ç‚¹</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;5&quot;&#125;&#125;</span><br><span class="line">input_message = HumanMessage(content=&quot;ä¸ºæˆ‘ä»‹ç»lol&quot;)</span><br><span class="line">async for event in graph.astream_events(&#123;&quot;messages&quot;: [input_message]&#125;, config, version=&quot;v2&quot;):</span><br><span class="line">    # ä»ç‰¹å®šèŠ‚ç‚¹è·å–èŠå¤©æ¨¡å‹ç”Ÿæˆçš„ Token</span><br><span class="line">    #äº‹ä»¶ç±»å‹å¿…é¡»æ˜¯ é€ token æµå¼è¾“å‡ºï¼ˆon_chat_model_streamï¼‰ã€‚</span><br><span class="line">    if event[&quot;event&quot;] == &quot;on_chat_model_stream&quot; and event[&#x27;metadata&#x27;].get(&#x27;langgraph_node&#x27;,&#x27;&#x27;) == node_to_stream:</span><br><span class="line">        data = event[&quot;data&quot;]</span><br><span class="line">        print(data[&quot;chunk&quot;].content, end=&quot;|&quot;)</span><br></pre></td></tr></table></figure>
<p>eventçš„å¸¸è§ç±»å‹</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹ (<code>event</code>)</th>
<th>è§¦å‘æ—¶æœºä¸è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>on_chain_start</code></td>
<td>ä»»æ„ Runnableï¼ˆèŠ‚ç‚¹ã€å­å›¾æˆ–æ•´ä¸ªå›¾ï¼‰å¼€å§‹æ‰§è¡Œ</td>
</tr>
<tr>
<td><code>on_chain_stream</code></td>
<td>èŠ‚ç‚¹/å›¾åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ <strong>å¢é‡è¾“å‡º</strong> chunk</td>
</tr>
<tr>
<td><code>on_chain_end</code></td>
<td>ä»»æ„ Runnable æ‰§è¡Œå®Œæˆ</td>
</tr>
<tr>
<td><code>on_chat_model_start</code></td>
<td><strong>ChatModel</strong> å¼€å§‹è°ƒç”¨</td>
</tr>
<tr>
<td><code>on_chat_model_stream</code></td>
<td><strong>ChatModel</strong> é€ token è¿”å›å†…å®¹ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰</td>
</tr>
<tr>
<td><code>on_chat_model_end</code></td>
<td><strong>ChatModel</strong> è°ƒç”¨ç»“æŸ</td>
</tr>
<tr>
<td><code>on_tool_start</code></td>
<td><strong>Tool</strong> å¼€å§‹è°ƒç”¨</td>
</tr>
<tr>
<td><code>on_tool_end</code></td>
<td><strong>Tool</strong> è°ƒç”¨ç»“æŸ</td>
</tr>
<tr>
<td><code>on_retriever_start</code></td>
<td><strong>Retriever</strong> å¼€å§‹æ£€ç´¢</td>
</tr>
<tr>
<td><code>on_retriever_end</code></td>
<td><strong>Retriever</strong> æ£€ç´¢ç»“æŸ</td>
</tr>
</tbody>
</table>
</div>
<h4 id="Breakpoints-æ–­ç‚¹"><a href="#Breakpoints-æ–­ç‚¹" class="headerlink" title="Breakpoints æ–­ç‚¹"></a><strong>Breakpoints æ–­ç‚¹</strong></h4><p><code>human-in-the-loop</code>ï¼ˆäººå·¥ä»‹å…¥/äººåœ¨å›è·¯ï¼‰çš„ä¸‰å¤§åŠ¨æœºï¼š</p>
<p>1ï¸âƒ£ Approvalï¼ˆå®¡æ‰¹ï¼‰æˆ‘ä»¬å¯ä»¥ä¸­æ–­æ™ºèƒ½ä½“ï¼Œå°†å½“å‰çŠ¶æ€å‘ˆç°ç»™ç”¨æˆ·ï¼Œå¹¶è®©ç”¨æˆ·å†³å®šæ˜¯å¦æ‰§è¡Œè¯¥æ“ä½œã€‚</p>
<p>2ï¸âƒ£ Debuggingï¼ˆè°ƒè¯•/å›æ”¾ï¼‰æˆ‘ä»¬å¯ä»¥å›é€€å›¾å½¢ä»¥é‡ç°æˆ–é¿å…é—®é¢˜</p>
<p>3ï¸âƒ£ Editingï¼ˆç¼–è¾‘ï¼‰AI äº§å‡ºçš„ä¸­é—´ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œä½†ä¸æƒ³é‡è·‘æ•´å›¾ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹çŠ¶æ€</p>
<p>æˆ‘ä»¬å°†ä»‹ç» <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/breakpoints/#simple-usage">breakpoints</a>ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ç‰¹å®šæ­¥éª¤åœæ­¢å›¾çš„ç®€å•æ–¹æ³•ã€‚</p>
<h5 id="Breakpoints-for-human-approvalç”¨äºäººç±»å®¡æ‰¹çš„æ–­ç‚¹"><a href="#Breakpoints-for-human-approvalç”¨äºäººç±»å®¡æ‰¹çš„æ–­ç‚¹" class="headerlink" title="Breakpoints for human approvalç”¨äºäººç±»å®¡æ‰¹çš„æ–­ç‚¹"></a><strong>Breakpoints for human approval</strong>ç”¨äºäººç±»å®¡æ‰¹çš„æ–­ç‚¹</h5><p>å‡è®¾æˆ‘ä»¬å…³æ³¨å·¥å…·çš„ä½¿ç”¨ï¼šæˆ‘ä»¬å¸Œæœ›æ‰¹å‡†ä»£ç†ä½¿ç”¨å…¶ä»»ä½•å·¥å…·ã€‚</p>
<p>æˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯ç®€å•åœ°ç”¨ <code>interrupt_before=[&quot;tools&quot;]</code> ç¼–è¯‘å›¾å½¢ï¼Œå…¶ä¸­ <code>tools</code> æ˜¯æˆ‘ä»¬çš„å·¥å…·èŠ‚ç‚¹ã€‚</p>
<p>è¿™æ„å‘³ç€åœ¨æ‰§è¡Œå·¥å…·è°ƒç”¨çš„èŠ‚ç‚¹ <code>tools</code> ä¹‹å‰ï¼Œæ‰§è¡Œå°†è¢«ä¸­æ–­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph = builder.compile(interrupt_before=[&quot;tools&quot;], checkpointer=memory)</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250720225640772.png" alt="image-20250720225640772"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Input</span><br><span class="line">initial_input = &#123;&quot;messages&quot;: HumanMessage(content=&quot;2ä¹˜3&quot;)&#125;</span><br><span class="line"></span><br><span class="line"># Thread</span><br><span class="line">thread = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># Run the graph until the first interruption</span><br><span class="line">for event in graph.stream(initial_input, thread, stream_mode=&quot;values&quot;):</span><br><span class="line">    event[&#x27;messages&#x27;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">2ä¹˜3</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line">Tool Calls:</span><br><span class="line">  multiply (call_92a4bcf88d25476d925775)</span><br><span class="line"> Call ID: call_92a4bcf88d25476d925775</span><br><span class="line">  Args:</span><br><span class="line">    a: 2</span><br><span class="line">    b: 3</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥è·å–çŠ¶æ€å¹¶æŸ¥çœ‹è¦è°ƒç”¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚è¿™æ˜¯ä¸€ç§å¾ˆå¥½çš„æ–¹æ³•ï¼Œå¯ä»¥å‘ç°å›¾å·²è¢«ä¸­æ–­ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸€ä¸ªå¾ˆå¥½çš„æŠ€å·§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ <code>None</code> è°ƒç”¨å›¾æ—¶ï¼Œå®ƒå°†ç›´æ¥ä»æœ€åä¸€ä¸ªçŠ¶æ€æ£€æŸ¥ç‚¹ç»§ç»­ï¼</p>
<p><img src="https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66dbae7985b747dfed67775d_breakpoints1.png" alt="breakpoints.jpg"></p>
<p>çŠ¶æ€å¿«ç…§ï¼ˆStateSnapshotï¼‰</p>
<ul>
<li>ç±»å‹ï¼šä¸“é—¨ç”¨æ¥å­˜ <strong>ä¸€ä¸ªæ—¶åˆ»</strong> çš„å®Œæ•´çŠ¶æ€</li>
<li>è·å–æ–¹å¼ï¼š<ul>
<li><code>Graph.get_state()</code> â†’ <strong>æœ€æ–°çš„</strong> å¿«ç…§</li>
<li><code>Graph.get_state_history()</code> â†’ <strong>æ‰€æœ‰</strong> å¿«ç…§åˆ—è¡¨</li>
</ul>
</li>
</ul>
<p>ç»§ç»­/é‡è·‘å›¾</p>
<ul>
<li><code>Graph.stream(None, &#123;&quot;thread_id&quot;: &quot;xxx&quot;&#125;)</code><ul>
<li>ä¸ä¼ æ–°è¾“å…¥ <code>None</code> è¡¨ç¤º <strong>ä»å½“å‰æœ€æ–°çŠ¶æ€ç»§ç»­è·‘</strong></li>
<li>ä¹Ÿå¯å›é€€åˆ°å†å²å¿«ç…§ï¼Œå†é‡è·‘ï¼ˆè°ƒè¯•/å›æ”¾ï¼‰</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for event in graph.stream(None, thread, stream_mode=&quot;values&quot;):</span><br><span class="line">    event[&#x27;messages&#x27;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line">Tool Calls:</span><br><span class="line">  multiply (call_92a4bcf88d25476d925775)</span><br><span class="line"> Call ID: call_92a4bcf88d25476d925775</span><br><span class="line">  Args:</span><br><span class="line">    a: 2</span><br><span class="line">    b: 3</span><br><span class="line">=================================[1m Tool Message [0m=================================</span><br><span class="line">Name: multiply</span><br><span class="line"></span><br><span class="line">6</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">2ä¹˜3çš„ç»“æœæ˜¯6ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="Editing-graph-state-ç¼–è¾‘å›¾çŠ¶æ€"><a href="#Editing-graph-state-ç¼–è¾‘å›¾çŠ¶æ€" class="headerlink" title="Editing graph state ç¼–è¾‘å›¾çŠ¶æ€"></a><strong>Editing graph state </strong>ç¼–è¾‘å›¾çŠ¶æ€</h4><p>æ–­ç‚¹ä¹Ÿæ˜¯<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/edit-graph-state/">ä¿®æ”¹å›¾çŠ¶æ€çš„æœºä¼š</a>è®©æˆ‘ä»¬åœ¨ <code>assistant</code> èŠ‚ç‚¹ä¹‹å‰ä¸ºä»£ç†è®¾ç½®æ–­ç‚¹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph = builder.compile(interrupt_before=[&quot;assistant&quot;], checkpointer=memory)</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250720230924672.png" alt="image-20250720230924672"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Input</span><br><span class="line">initial_input = &#123;&quot;messages&quot;: &quot;2ä¹˜3&quot;&#125;</span><br><span class="line"></span><br><span class="line"># Thread</span><br><span class="line">thread = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># Run the graph until the first interruption</span><br><span class="line">for event in graph.stream(initial_input, thread, stream_mode=&quot;values&quot;):</span><br><span class="line">    event[&#x27;messages&#x27;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">2ä¹˜3</span><br></pre></td></tr></table></figure>
<p>å½“çŠ¶æ€ä¸­æ–­æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åº”ç”¨çŠ¶æ€æ›´æ–°</p>
<p>è®°ä½ï¼Œå¯¹ <code>messages</code> é”®çš„æ›´æ–°å°†ä½¿ç”¨ <code>add_messages</code> reducerï¼š</p>
<p><strong>å¦‚æœæˆ‘ä»¬æƒ³è¦†ç›–ç°æœ‰çš„æ¶ˆæ¯ï¼Œå¯ä»¥æä¾›å¸¦æœ‰<em> </em><code>id</code><em> </em>çš„æ¶ˆæ¯ã€‚</strong> å¦‚æœæˆ‘ä»¬åªæƒ³å°†æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨ä¸­ï¼Œåˆ™å¯ä»¥ä¼ é€’æœªæŒ‡å®š <code>id</code> çš„æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph.update_state(</span><br><span class="line">    thread,</span><br><span class="line">    &#123;&quot;messages&quot;: [HumanMessage(content=&quot;ä¸è¦ï¼Œå®é™…ä¸Šè¦3ä¹˜3!&quot;)]&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new_state = graph.get_state(thread).values</span><br><span class="line">for m in new_state[&#x27;messages&#x27;]:</span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">2ä¹˜3</span><br><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">ä¸è¦ï¼Œå®é™…ä¸Šè¦3ä¹˜3!</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»§ç»­è¿›è¡Œæˆ‘ä»¬çš„ä»£ç†æ“ä½œï¼Œåªéœ€ä¼ é€’ <code>None</code> å¹¶å…è®¸å…¶ä»å½“å‰çŠ¶æ€ç»§ç»­æ‰§è¡Œã€‚æˆ‘ä»¬è¾“å‡ºå½“å‰å†…å®¹ï¼Œç„¶åç»§ç»­æ‰§è¡Œå‰©ä½™çš„èŠ‚ç‚¹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for event in graph.stream(None, thread, stream_mode=&quot;values&quot;):</span><br><span class="line">    event[&#x27;messages&#x27;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<h4 id="Dynamic-breakpoints-åŠ¨æ€æ–­ç‚¹"><a href="#Dynamic-breakpoints-åŠ¨æ€æ–­ç‚¹" class="headerlink" title="Dynamic breakpoints åŠ¨æ€æ–­ç‚¹"></a><strong>Dynamic breakpoints </strong>åŠ¨æ€æ–­ç‚¹</h4><p>ä½ å¯ä»¥æ ¹æ®æ¡ä»¶æ¥å®ç°å®ƒï¼ˆä»èŠ‚ç‚¹å†…éƒ¨åŸºäºå¼€å‘äººå‘˜å®šä¹‰çš„é€»è¾‘ï¼‰ã€‚æ‚¨å¯ä»¥å‘ç”¨æˆ·è¯´æ˜å…¶ä¸­æ–­åŸå› ï¼ˆé€šè¿‡å°†æ‚¨æƒ³ä¼ é€’çš„å†…å®¹å‘é€åˆ° <code>NodeInterrupt</code>ï¼‰ã€‚</p>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå›¾è¡¨ï¼Œå…¶ä¸­æ ¹æ®è¾“å…¥çš„é•¿åº¦ä¼šæŠ›å‡ºä¸€ä¸ª <code>NodeInterrupt</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.errors import NodeInterrupt</span><br><span class="line">from langgraph.graph import START, END, StateGraph</span><br><span class="line"></span><br><span class="line">class State(TypedDict):</span><br><span class="line">    input: str</span><br><span class="line"></span><br><span class="line">def step_1(state: State) -&gt; State:</span><br><span class="line">    print(&quot;---Step 1---&quot;)</span><br><span class="line">    return state</span><br><span class="line"></span><br><span class="line">def step_2(state: State) -&gt; State:</span><br><span class="line">    # å¦‚æœè¾“å…¥å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡5ä¸ªå­—ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æŠ›å‡ºNodeInterruptå¼‚å¸¸</span><br><span class="line">    if len(state[&#x27;input&#x27;]) &gt; 5:</span><br><span class="line">        raise NodeInterrupt(f&quot;æ”¶åˆ°é•¿åº¦è¶…è¿‡5ä¸ªå­—ç¬¦çš„è¾“å…¥: &#123;state[&#x27;input&#x27;]&#125;&quot;)</span><br><span class="line">    </span><br><span class="line">    print(&quot;---Step 2---&quot;)</span><br><span class="line">    return state</span><br><span class="line"></span><br><span class="line">def step_3(state: State) -&gt; State:</span><br><span class="line">    print(&quot;---Step 3---&quot;)</span><br><span class="line">    return state</span><br><span class="line"></span><br><span class="line">builder = StateGraph(State)</span><br><span class="line">builder.add_node(&quot;step_1&quot;, step_1)</span><br><span class="line">builder.add_node(&quot;step_2&quot;, step_2)</span><br><span class="line">builder.add_node(&quot;step_3&quot;, step_3)</span><br><span class="line">builder.add_edge(START, &quot;step_1&quot;)</span><br><span class="line">builder.add_edge(&quot;step_1&quot;, &quot;step_2&quot;)</span><br><span class="line">builder.add_edge(&quot;step_2&quot;, &quot;step_3&quot;)</span><br><span class="line">builder.add_edge(&quot;step_3&quot;, END)</span><br><span class="line"></span><br><span class="line"># Set up memory</span><br><span class="line">memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># Compile the graph with memory</span><br><span class="line">graph = builder.compile(checkpointer=memory)</span><br><span class="line"></span><br><span class="line"># View</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/image-20250721222709712.png" alt="image-20250721222709712"></p>
<p>è®©æˆ‘ä»¬è¿è¡Œä¸€ä¸ªè¾“å…¥è¶…è¿‡5ä¸ªå­—ç¬¦çš„å›¾ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">initial_input = &#123;&quot;input&quot;: &quot;hello world&quot;&#125;</span><br><span class="line">thread_config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># Run the graph until the first interruption</span><br><span class="line">for event in graph.stream(initial_input, thread_config, stream_mode=&quot;values&quot;):</span><br><span class="line">    print(event)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;input&#x27;: &#x27;hello world&#x27;&#125;</span><br><span class="line">---Step 1---</span><br><span class="line">&#123;&#x27;input&#x27;: &#x27;hello world&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å°è¯•ä»æ–­ç‚¹æ¢å¤å›¾ã€‚ä½†æ˜¯ï¼Œè¿™åªä¼šé‡æ–°è¿è¡Œç›¸åŒçš„èŠ‚ç‚¹ï¼é™¤éçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™æˆ‘ä»¬å°†ä¸€ç›´å¡åœ¨è¿™é‡Œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph.update_state(</span><br><span class="line">    thread_config,</span><br><span class="line">    &#123;&quot;input&quot;: &quot;hi&quot;&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨update_stateæ›´æ–°çŠ¶æ€</p>
<h4 id="Time-travel-æ—¶é—´æ—…è¡Œ"><a href="#Time-travel-æ—¶é—´æ—…è¡Œ" class="headerlink" title="Time travel æ—¶é—´æ—…è¡Œ"></a><strong>Time travel</strong> æ—¶é—´æ—…è¡Œ</h4><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ã€é‡æ’­ï¼Œç”šè‡³ä»è¿‡å»çš„çŠ¶æ€å‰å‡ºï¼Œæ¥å±•ç¤º LangGraph <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/time-travel/">æ”¯æŒdebug</a> çš„åŠŸèƒ½ã€‚</p>
<h5 id="Browsing-History-æµè§ˆå†å²"><a href="#Browsing-History-æµè§ˆå†å²" class="headerlink" title="Browsing History æµè§ˆå†å²"></a><strong>Browsing History</strong> <strong>æµè§ˆå†å²</strong></h5><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>get_state</code> æ¥æŸ¥çœ‹ç»™å®š <code>thread_id</code> çš„å›¾çš„ å½“å‰ çŠ¶æ€ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.get_state(&#123;&#x27;configurable&#x27;: &#123;&#x27;thread_id&#x27;: &#x27;1&#x27;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥æµè§ˆä»£ç†çš„çŠ¶æ€å†å²ã€‚<code>get_state_history</code> è®©æˆ‘ä»¬èƒ½å¤Ÿè·å–æ‰€æœ‰å…ˆå‰æ­¥éª¤çš„çŠ¶æ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">all_states = [s for s in graph.get_state_history(thread)]</span><br><span class="line">len(all_states)</span><br><span class="line">print(all_states)</span><br></pre></td></tr></table></figure>
<h5 id="Replaying-å›æ”¾"><a href="#Replaying-å›æ”¾" class="headerlink" title="Replaying å›æ”¾"></a><strong>Replaying</strong> <strong>å›æ”¾</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">to_replay = all_states[-2]</span><br><span class="line">to_replay.values</span><br><span class="line">&#123;&#x27;messages&#x27;: [HumanMessage(content=&#x27;2ä¹˜3&#x27;, additional_kwargs=&#123;&#125;, response_metadata=&#123;&#125;, id=&#x27;0676d9b5-cd59-4630-924d-b5c8d950e8d8&#x27;)]&#125;</span><br><span class="line">to_replay.next</span><br><span class="line">(&#x27;assistant&#x27;,)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜è·å–äº†é…ç½®ï¼Œå®ƒå‘Šè¯‰äº†æˆ‘ä»¬ <code>checkpoint_id</code> ä»¥åŠ <code>thread_id</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">to_replay.config</span><br><span class="line">&#123;&#x27;configurable&#x27;: &#123;&#x27;thread_id&#x27;: &#x27;1&#x27;,</span><br><span class="line">  &#x27;checkpoint_ns&#x27;: &#x27;&#x27;,</span><br><span class="line">  &#x27;checkpoint_id&#x27;: &#x27;1f066c0e-2ee2-66d5-8000-5dde78194aae&#x27;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>è¦ä»è¿™é‡Œé‡æ’­ï¼Œæˆ‘ä»¬åªéœ€å°†é…ç½®ä¼ å›ç»™ä»£ç†ï¼å›¾çŸ¥é“è¿™ä¸ªæ£€æŸ¥ç‚¹å·²ç»æ‰§è¡Œè¿‡äº†ã€‚å®ƒåªæ˜¯ä»è¿™ä¸ªæ£€æŸ¥ç‚¹é‡æ–°æ’­æ”¾ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for event in graph.stream(None, to_replay.config, stream_mode=&quot;values&quot;):</span><br><span class="line">    event[&#x27;messages&#x27;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<h5 id="Forking-åˆ†å‰"><a href="#Forking-åˆ†å‰" class="headerlink" title="Forking åˆ†å‰"></a><strong>Forking</strong> åˆ†å‰</h5><p>å¦‚æœæˆ‘ä»¬æƒ³ä»ç›¸åŒçš„æ­¥éª¤è¿è¡Œï¼Œä½†ä½¿ç”¨ä¸åŒçš„è¾“å…¥ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™æ˜¯åˆ†å‰ã€‚</p>
<p><img src="/2025/07/18/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent/66dbb038f89f2d847ee5c336_time-travel3.png" alt="fig3.jpg"></p>
<p>è®©æˆ‘ä»¬ä¿®æ”¹æ­¤æ£€æŸ¥ç‚¹çš„çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æä¾›çš„ <code>checkpoint_id</code> æ¥è¿è¡Œ <code>update_state</code>ã€‚</p>
<p>è¯·è®°ä½æˆ‘ä»¬å¯¹ <code>messages</code> çš„ reducer æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p>
<ul>
<li>å®ƒä¼šè¿½åŠ æ¶ˆæ¯ï¼Œé™¤éæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¶ˆæ¯ IDã€‚</li>
<li>æˆ‘ä»¬æä¾›æ¶ˆæ¯ ID æ˜¯ä¸ºäº†è¦†ç›–æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯å°†æ¶ˆæ¯è¿½åŠ åˆ°çŠ¶æ€ä¸­ï¼</li>
</ul>
<p>å› æ­¤ï¼Œè¦è¦†ç›–æ¶ˆæ¯ï¼Œæˆ‘ä»¬åªéœ€æä¾›æ¶ˆæ¯ IDï¼Œè€Œæˆ‘ä»¬å·²æœ‰ <code>to_fork.values[&quot;messages&quot;].id</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fork_config = graph.update_state(</span><br><span class="line">    to_fork.config,</span><br><span class="line">    &#123;&quot;messages&quot;: [HumanMessage(content=&#x27;5ä¹˜3&#x27;, </span><br><span class="line">                               id=to_fork.values[&quot;messages&quot;][0].id)]&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h3><h4 id="message"><a href="#message" class="headerlink" title="message"></a>message</h4><p>LangChain ä¸­çš„ HumanMessage ã€ AIMessage ã€ SystemMessage å’Œ ToolMessage ã€‚è¿™äº›æ¶ˆæ¯ç±»å‹æ˜¯æ„å»ºä¸è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰äº¤äº’çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒä»¬å…±åŒæ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„å¯¹è¯å†å²ï¼Œå¸®åŠ©æ¨¡å‹ç†è§£ä¸Šä¸‹æ–‡å¹¶åšå‡ºæ°å½“çš„å›åº”ã€‚</p>
<ol>
<li>SystemMessage</li>
</ol>
<p>SystemMessage çš„ç»“æ„æœ€ç®€å•ï¼Œå®ƒåªåŒ…å«å†…å®¹å’Œç±»å‹ã€‚</p>
<p>æ•°æ®ç»“æ„ :</p>
<ul>
<li>content (str): æ¶ˆæ¯çš„å…·ä½“å†…å®¹ï¼Œå³ç»™ AI çš„æŒ‡ä»¤ã€‚</li>
<li>type (str): å›ºå®šä¸ºå­—ç¬¦ä¸² â€˜systemâ€™ ã€‚</li>
</ul>
<ol>
<li>HumanMessage</li>
</ol>
<p>HumanMessage çš„ç»“æ„ä¹ŸåŒæ ·ç®€å•ï¼Œä»£è¡¨ç”¨æˆ·çš„è¾“å…¥ã€‚</p>
<p>æ•°æ®ç»“æ„ :</p>
<ul>
<li>content (str): ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ã€‚</li>
<li>type (str): å›ºå®šä¸ºå­—ç¬¦ä¸² â€˜humanâ€™ ã€‚</li>
</ul>
<ol>
<li>AIMessage</li>
</ol>
<p>AIMessage çš„ç»“æ„ç›¸å¯¹å¤æ‚ï¼Œå› ä¸ºå®ƒä¸ä»…å¯ä»¥åŒ…å«æ–‡æœ¬å“åº”ï¼Œè¿˜å¯ä»¥åŒ…å«å¯¹å·¥å…·çš„è°ƒç”¨è¯·æ±‚ã€‚</p>
<p>æ•°æ®ç»“æ„ :</p>
<ul>
<li>content (str): AI ç”Ÿæˆçš„æ–‡æœ¬å“åº”ã€‚å¦‚æœ AI çš„å›å¤æ˜¯å‘èµ·å·¥å…·è°ƒç”¨ï¼Œæ­¤å­—æ®µå¯ä»¥ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</li>
<li>tool_calls (list[dict], å¯é€‰): ä¸€ä¸ªå­—å…¸åˆ—è¡¨ï¼Œæ¯ä¸ªå­—å…¸ä»£è¡¨ä¸€ä¸ªå·¥å…·è°ƒç”¨è¯·æ±‚ã€‚è¿™æ˜¯æ”¯æŒâ€œFunction Callingâ€æˆ–â€œTool Callingâ€åŠŸèƒ½çš„æ ¸å¿ƒã€‚å…¶ç»“æ„é€šå¸¸åŒ…å«ï¼š<ul>
<li>name (str): è¦è°ƒç”¨çš„å·¥å…·åç§°ã€‚</li>
<li>args (dict): è°ƒç”¨å·¥å…·æ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°ã€‚</li>
<li>id (str): æ­¤æ¬¡å·¥å…·è°ƒç”¨çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåç»­ ToolMessage çš„å…³è”ã€‚</li>
</ul>
</li>
<li>type (str): å›ºå®šä¸ºå­—ç¬¦ä¸² â€˜aiâ€™ ã€‚</li>
</ul>
<ol>
<li>ToolMessage</li>
</ol>
<p>ToolMessage ç”¨äºæ‰¿è½½å·¥å…·æ‰§è¡Œåçš„è¿”å›ç»“æœã€‚</p>
<p>æ•°æ®ç»“æ„ :</p>
<ul>
<li>content (str): å·¥å…·æ‰§è¡Œè¿”å›çš„ç»“æœã€‚é€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚</li>
<li>tool_call_id (str): æ­¤æ¬¡å·¥å…·è°ƒç”¨çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œ å¿…é¡» ä¸ä¹‹å‰ AIMessage ä¸­ tool_calls é‡Œçš„ id ç›¸å¯¹åº”ã€‚è¿™ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿå‡†ç¡®åœ°å°†ç»“æœä¸è¯·æ±‚åŒ¹é…èµ·æ¥ã€‚</li>
<li>type (str): å›ºå®šä¸ºå­—ç¬¦ä¸² â€˜toolâ€™ ã€‚</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/18/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/libreoffice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/18/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/libreoffice/" class="post-title-link" itemprop="url">Libreoffice</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-18 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-18T00:00:00+08:00">2025-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-07-30 15:26:37" itemprop="dateModified" datetime="2025-07-30T15:26:37+08:00">2025-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">å®ä¹ </span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">æ™¨æ™Ÿæ™ºæ§</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="libreofficeéƒ¨ç½²"><a href="#libreofficeéƒ¨ç½²" class="headerlink" title="libreofficeéƒ¨ç½²"></a>libreofficeéƒ¨ç½²</h3><h4 id="æŸ¥çœ‹Linuxå‘è¡Œç‰ˆ"><a href="#æŸ¥çœ‹Linuxå‘è¡Œç‰ˆ" class="headerlink" title="æŸ¥çœ‹Linuxå‘è¡Œç‰ˆ"></a>æŸ¥çœ‹Linuxå‘è¡Œç‰ˆ</h4><p><img src="/2025/07/18/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/libreoffice/image-20250718095931232.png" alt="image-20250718095931232"></p>
<p>ç³»ç»Ÿæ˜¯ <strong>é“¶æ²³éº’éºŸé«˜çº§æœåŠ¡å™¨æ“ä½œç³»ç»Ÿ V10ï¼ˆKylin Linux Advanced Server V10ï¼‰</strong>ï¼Œå±äº <strong>ä¸­å›½å›½äº§ã€å…¼å®¹ CentOS/RHEL ç”Ÿæ€</strong> çš„ Linux å‘è¡Œç‰ˆã€‚</p>
<p>å› æ­¤å®ƒä½¿ç”¨ <strong>RPM åŒ…ç®¡ç†</strong>ï¼ˆ<code>dnf</code>/<code>yum</code>ï¼‰ï¼Œè€Œä¸æ˜¯ <code>.deb</code>ã€‚</p>
<h4 id="æŸ¥çœ‹CPU-å¤„ç†å™¨æ¶æ„"><a href="#æŸ¥çœ‹CPU-å¤„ç†å™¨æ¶æ„" class="headerlink" title="æŸ¥çœ‹CPU å¤„ç†å™¨æ¶æ„"></a>æŸ¥çœ‹<strong>CPU å¤„ç†å™¨æ¶æ„</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -m</span><br></pre></td></tr></table></figure>
<p>æ˜¯<strong>x86_64</strong></p>
<h4 id="ä¸ç”¨éƒ¨ç½²äº†ï¼Œé•œåƒé‡Œæœ‰ï¼Œç›´æ¥ç”¨äº†"><a href="#ä¸ç”¨éƒ¨ç½²äº†ï¼Œé•œåƒé‡Œæœ‰ï¼Œç›´æ¥ç”¨äº†" class="headerlink" title="ä¸ç”¨éƒ¨ç½²äº†ï¼Œé•œåƒé‡Œæœ‰ï¼Œç›´æ¥ç”¨äº†"></a>ä¸ç”¨éƒ¨ç½²äº†ï¼Œé•œåƒé‡Œæœ‰ï¼Œç›´æ¥ç”¨äº†</h4><h4 id="ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf"><a href="#ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf" class="headerlink" title="ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf"></a>ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf</h4><p>å°†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰ <code>.doc</code> å’Œ <code>.docx</code> è½¬ä¸º PDFï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">libreoffice --headless --convert-to pdf *.doc *.docx --outdir ./pdf_output/</span><br><span class="line"></span><br><span class="line"># æ£€æŸ¥æ˜¯å¦æœ‰æ®‹ç•™è¿›ç¨‹</span><br><span class="line">ps aux | grep libreoffice</span><br><span class="line"></span><br><span class="line"># å¦‚æœæœ‰æ®‹ç•™è¿›ç¨‹ï¼Œæ€æ­»å®ƒä»¬</span><br><span class="line">killall soffice.bin 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import subprocess</span><br><span class="line">import argparse</span><br><span class="line">import glob</span><br><span class="line">from pathlib import Path</span><br><span class="line">def batch_convert_documents(input_path, output_dir):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    æ‰¹é‡è½¬æ¢æ–‡æ¡£çš„å‡½æ•°ç‰ˆæœ¬</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        input_path (str): è¾“å…¥è·¯å¾„ï¼ˆæ–‡ä»¶ã€ç›®å½•æˆ–é€šé…ç¬¦ï¼‰</span><br><span class="line">        output_dir (str): è¾“å‡ºç›®å½•</span><br><span class="line">    </span><br><span class="line">    Returns:</span><br><span class="line">        bool: è½¬æ¢æ˜¯å¦æˆåŠŸ</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨</span><br><span class="line">    Path(output_dir).mkdir(parents=True, exist_ok=True)</span><br><span class="line">    </span><br><span class="line">    # æ”¶é›†æ‰€æœ‰è¦è½¬æ¢çš„æ–‡ä»¶</span><br><span class="line">    files_to_convert = []</span><br><span class="line">    </span><br><span class="line">    if os.path.isfile(input_path):</span><br><span class="line">        # å•ä¸ªæ–‡ä»¶</span><br><span class="line">        if input_path.lower().endswith((&#x27;.doc&#x27;, &#x27;.docx&#x27;)):</span><br><span class="line">            files_to_convert.append(input_path)</span><br><span class="line">    elif os.path.isdir(input_path):</span><br><span class="line">        # ç›®å½•ä¸­çš„æ‰€æœ‰doc/docxæ–‡ä»¶</span><br><span class="line">        for pattern in [&#x27;*.doc&#x27;, &#x27;*.docx&#x27;]:</span><br><span class="line">            files_to_convert.extend(glob.glob(os.path.join(input_path, pattern)))</span><br><span class="line">    else:</span><br><span class="line">        # é€šé…ç¬¦æ¨¡å¼</span><br><span class="line">        files_to_convert = glob.glob(input_path)</span><br><span class="line">        # è¿‡æ»¤å‡ºdocå’Œdocxæ–‡ä»¶</span><br><span class="line">        files_to_convert = [f for f in files_to_convert if f.lower().endswith((&#x27;.doc&#x27;, &#x27;.docx&#x27;))]</span><br><span class="line">    </span><br><span class="line">    if not files_to_convert:</span><br><span class="line">        print(&quot;æœªæ‰¾åˆ°è¦è½¬æ¢çš„æ–‡æ¡£æ–‡ä»¶&quot;)</span><br><span class="line">        return False</span><br><span class="line">    </span><br><span class="line">    print(f&quot;æ‰¾åˆ° &#123;len(files_to_convert)&#125; ä¸ªæ–‡ä»¶éœ€è¦è½¬æ¢&quot;)</span><br><span class="line">    </span><br><span class="line">    # æ„å»ºå‘½ä»¤</span><br><span class="line">    cmd = [</span><br><span class="line">        &#x27;libreoffice&#x27;,</span><br><span class="line">        &#x27;--headless&#x27;,</span><br><span class="line">        &#x27;--convert-to&#x27;, &#x27;pdf&#x27;,</span><br><span class="line">        &#x27;--outdir&#x27;, output_dir</span><br><span class="line">    ] + files_to_convert</span><br><span class="line">    </span><br><span class="line">    try:</span><br><span class="line">        print(&quot;æ­£åœ¨è½¬æ¢æ–‡ä»¶...&quot;)</span><br><span class="line">        result = subprocess.run(cmd, capture_output=True, text=True, timeout=600)</span><br><span class="line">        </span><br><span class="line">        if result.returncode == 0:</span><br><span class="line">            print(f&quot;æˆåŠŸè½¬æ¢ &#123;len(files_to_convert)&#125; ä¸ªæ–‡ä»¶&quot;)</span><br><span class="line">            return True</span><br><span class="line">        else:</span><br><span class="line">            print(f&quot;è½¬æ¢å¤±è´¥: &#123;result.stderr&#125;&quot;)</span><br><span class="line">            return False</span><br><span class="line">            </span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;è½¬æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: &#123;e&#125;&quot;)</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    success = batch_convert_documents(&quot;./docs&quot;, &quot;./pdf_output&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="Linuxæ‰«ç›²"><a href="#Linuxæ‰«ç›²" class="headerlink" title="Linuxæ‰«ç›²"></a>Linuxæ‰«ç›²</h3><h4 id="å‘è¡Œç‰ˆ"><a href="#å‘è¡Œç‰ˆ" class="headerlink" title="å‘è¡Œç‰ˆ"></a>å‘è¡Œç‰ˆ</h4><p>åƒUbuntuï¼ŒCentOSéƒ½å±äºLinuxçš„å‘è¡Œç‰ˆï¼Œå°±åƒWindows11å±äºWindowsçš„å…³ç³»</p>
<p>å¸¸è§å‘è¡Œç‰ˆåˆ†ç±»ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>ç³»åˆ—</th>
<th>ä»£è¡¨å‘è¡Œç‰ˆ</th>
<th>åŒ…æ ¼å¼</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Debian ç³»</strong></td>
<td>Debianã€Ubuntuã€Kaliã€Linux Mint</td>
<td><code>.deb</code></td>
<td>åŒ…å¤šã€ç¤¾åŒºå¤§ã€æ•™ç¨‹å¤š</td>
</tr>
<tr>
<td><strong>Red Hat ç³»</strong></td>
<td>CentOSã€RHELã€Rockyã€Almaã€Fedora</td>
<td><code>.rpm</code></td>
<td>ä¼ä¸šçº§ç¨³å®šã€å®˜æ–¹æ”¯æŒé•¿</td>
</tr>
<tr>
<td><strong>SUSE ç³»</strong></td>
<td>openSUSE Leap / Tumbleweed</td>
<td><code>.rpm</code></td>
<td>YaST ç®¡ç†å·¥å…·ã€æ¬§æ´²æµè¡Œ</td>
</tr>
<tr>
<td><strong>Arch ç³»</strong></td>
<td>Arch Linuxã€Manjaro</td>
<td><code>.pkg.tar.zst</code></td>
<td>æ»šåŠ¨æ›´æ–°ã€æå®¢å‘</td>
</tr>
<tr>
<td><strong>è½»é‡/æœ€å°</strong></td>
<td>Alpineã€Debian netinstã€CentOS Stream Minimal</td>
<td>ä»»æ„</td>
<td>é•œåƒå°ã€èµ„æºå ç”¨ä½</td>
</tr>
</tbody>
</table>
</div>
<p>å¦‚ä½•æŸ¥çœ‹Linuxå‘è¡Œç‰ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/os-release</span><br></pre></td></tr></table></figure>
<h4 id="debå’Œrpm"><a href="#debå’Œrpm" class="headerlink" title="debå’Œrpm"></a>debå’Œrpm</h4><p> <code>.deb</code> å’Œ <code>.rpm</code> æƒ³è±¡æˆ <strong>â€œLinux ä¸–ç•Œé‡Œçš„å®‰è£…ç¨‹åºâ€</strong>ï¼Œå°±åƒ Windows çš„ <code>.exe</code> / <code>.msi</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>æ ¼å¼</th>
<th>é€‚ç”¨ç³»ç»Ÿ</th>
<th>å®‰è£…å‘½ä»¤</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>.deb</code></strong></td>
<td>Debianã€Ubuntuã€Linux Mintã€Kali ç­‰</td>
<td><code>sudo dpkg -i xxx.deb</code> æˆ– <code>sudo apt install ./xxx.deb</code></td>
</tr>
<tr>
<td><strong><code>.rpm</code></strong></td>
<td>CentOSã€RHELã€Fedoraã€openSUSEã€Rockyã€Alma ç­‰</td>
<td><code>sudo rpm -ivh xxx.rpm</code> æˆ– <code>sudo dnf/yum install xxx.rpm</code></td>
</tr>
</tbody>
</table>
</div>
<h4 id="cpuå¤„ç†å™¨æ¶æ„"><a href="#cpuå¤„ç†å™¨æ¶æ„" class="headerlink" title="cpuå¤„ç†å™¨æ¶æ„"></a>cpuå¤„ç†å™¨æ¶æ„</h4><div class="table-container">
<table>
<thead>
<tr>
<th>ç›®å½•å</th>
<th>ä»£è¡¨æ¶æ„</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>x86_64</strong></td>
<td><strong>Intel/AMD 64 ä½</strong></td>
<td>ç»å¤§å¤šæ•°å°å¼æœºã€æœåŠ¡å™¨ï¼ˆå¦‚ Xeonã€EPYCã€Coreã€Ryzenï¼‰</td>
</tr>
<tr>
<td><strong>aarch64</strong></td>
<td><strong>ARM 64 ä½</strong></td>
<td>æ ‘è“æ´¾ 4/5ã€è‹¹æœ M ç³»åˆ—ï¼ˆAsahi Linuxï¼‰ã€é²²é¹ã€é£è…¾ã€Ampere ARM æœåŠ¡å™¨ç­‰</td>
</tr>
</tbody>
</table>
</div>
<p>æŸ¥çœ‹å¤„ç†å™¨æ¶æ„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -m</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/18/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/18/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">å®æˆ˜</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-18 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-18T00:00:00+08:00">2025-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-07-30 09:15:18" itemprop="dateModified" datetime="2025-07-30T09:15:18+08:00">2025-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">å®ä¹ </span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">æ™¨æ™Ÿæ™ºæ§</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h3><p>éƒ¨ç½²æ—¥å¿—è§å®ä¹ æ—¥å¿—é‚£ç¯‡æ–‡ç« </p>
<h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><p>æŸ¥çœ‹mineruæå–çš„markdownæ–‡æ¡£åï¼Œå‘ç°mineruæš‚æ—¶æ— æ³•æå–å¤šçº§æ ‡é¢˜ï¼Œæ‰€ä»¥å¯ä»¥èˆå¼ƒæ ¹æ®markdownæ–‡æ¡£ç»“æ„çš„åˆ†å—ç­–ç•¥</p>
<p>UnstructuredMarkdownLoaderä¼šä¸¢å¤±è¡¨æ ¼æ ¼å¼ï¼Œä¸èƒ½ä½¿ç”¨</p>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>å°† <code>Markdown</code> æ–‡æ¡£åŠ è½½åˆ° LangChain <a target="_blank" rel="noopener" href="https://python.langchain.com/api_reference/core/documents/langchain_core.documents.base.Document.html#langchain_core.documents.base.Document">æ–‡æ¡£</a> å¯¹è±¡ä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨åç»­ä½¿ç”¨</p>
<h4 id="ä½¿ç”¨UnstructuredMarkdownLoader-å¯¹è±¡"><a href="#ä½¿ç”¨UnstructuredMarkdownLoader-å¯¹è±¡" class="headerlink" title="ä½¿ç”¨UnstructuredMarkdownLoader å¯¹è±¡"></a>ä½¿ç”¨<a target="_blank" rel="noopener" href="https://python.langchain.com/api_reference/community/document_loaders/langchain_community.document_loaders.markdown.UnstructuredMarkdownLoader.html">UnstructuredMarkdownLoader</a> å¯¹è±¡</h4><p>UnstructuredMarkdownLoader æ˜¯ LangChain ä¸­çš„ä¸€ä¸ª æ–‡æ¡£åŠ è½½å™¨ï¼ˆDocument Loaderï¼‰ ï¼Œä¸“é—¨ç”¨äºåŠ è½½å’Œè§£æ Markdown ( .md ) æ–‡ä»¶ã€‚å®ƒçš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºï¼Œå®ƒåº•å±‚ä¾èµ–äºä¸€ä¸ªå¼ºå¤§çš„å¼€æºåº“ unstructured ã€‚</p>
<p><strong>UnstructuredMarkdownLoader çš„æ ¸å¿ƒåŠŸèƒ½</strong></p>
<p>ä¼ ç»Ÿçš„æ–‡æœ¬åŠ è½½å™¨å¯èƒ½ä¼šå°†æ•´ä¸ª Markdown æ–‡ä»¶ä½œä¸ºä¸€ä¸ªå¤§å­—ç¬¦ä¸²è¯»å…¥ã€‚è€Œ UnstructuredMarkdownLoader å‡­å€Ÿ unstructured åº“çš„èƒ½åŠ›ï¼Œå¯ä»¥ æ™ºèƒ½åœ°è¯†åˆ« Markdown æ–‡ä»¶å†…éƒ¨çš„ç»“æ„ ã€‚</p>
<p>å®ƒèƒ½å¤Ÿå°†æ–‡æ¡£åˆ†è§£æˆå¤šä¸ªæœ‰æ„ä¹‰çš„<strong>â€œå…ƒç´ â€ (Elements)</strong>ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>æ ‡é¢˜ (Titles)</li>
<li>å™è¿°æ€§æ–‡æœ¬ (Narrative Text / Paragraphs)</li>
<li>åˆ—è¡¨é¡¹ (List Items)</li>
<li>ä»£ç å— (Code Blocks)<br>è¿™ç§æ™ºèƒ½åˆ†åŒºå¯¹äºåç»­çš„ RAG (Retrieval-Augmented Generation) åº”ç”¨éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒèƒ½è®©æ‚¨ä»¥æ›´å°çš„ã€é€»è¾‘ä¸Šè¿è´¯çš„å—æ¥å¤„ç†æ–‡æœ¬ï¼Œä»è€Œæé«˜æ£€ç´¢çš„å‡†ç¡®æ€§ã€‚</li>
</ul>
<p><strong>é‡è¦çš„ mode å‚æ•°</strong></p>
<p>UnstructuredMarkdownLoader çš„æ„é€ å‡½æ•°ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ mode å‚æ•°ï¼Œå®ƒå†³å®šäº†æ–‡æ¡£çš„åŠ è½½æ–¹å¼ï¼š</p>
<ol>
<li><p>mode=â€singleâ€ (é»˜è®¤å€¼)</p>
<ul>
<li>å°†æ•´ä¸ª Markdown æ–‡ä»¶çš„æ‰€æœ‰å†…å®¹åŠ è½½æˆ ä¸€ä¸ªå•ç‹¬çš„ Document å¯¹è±¡ ã€‚</li>
<li>page_content åŒ…å«æ–‡ä»¶çš„å…¨éƒ¨æ–‡æœ¬ã€‚</li>
</ul>
</li>
<li><p>mode=â€elementsâ€</p>
<ul>
<li>è¿™æ˜¯å®ƒæœ€å¼ºå¤§çš„æ¨¡å¼ã€‚å®ƒä¼šå°†æ–‡ä»¶è§£ææˆå¤šä¸ª Document å¯¹è±¡ï¼Œ æ¯ä¸ªå¯¹è±¡å¯¹åº”ä¸€ä¸ªè¯†åˆ«å‡ºçš„å…ƒç´  ï¼ˆå¦‚ä¸€ä¸ªæ ‡é¢˜ã€ä¸€ä¸ªæ®µè½ï¼‰ã€‚</li>
<li>è¿™å¯¹äºåˆ›å»ºç²¾ç»†çš„æ–‡æœ¬å—ä»¥è¿›è¡Œå‘é‡åµŒå…¥å’Œæ£€ç´¢éå¸¸æœ‰ç”¨ã€‚</li>
</ul>
</li>
</ol>
<h4 id="ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf"><a href="#ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf" class="headerlink" title="ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf"></a>ä½¿ç”¨libreofficeå¤„ç†docæ–‡ä»¶ï¼Œè½¬æˆpdf</h4><p>å°†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰ <code>.doc</code> å’Œ <code>.docx</code> è½¬ä¸º PDFï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libreoffice --headless --convert-to pdf *.doc *.docx --outdir ./pdf_output/</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/15/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langchain%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/15/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langchain%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">LangChainå­¦ä¹ </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-15 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-15T00:00:00+08:00">2025-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-02 15:52:08" itemprop="dateModified" datetime="2025-08-02T15:52:08+08:00">2025-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">aiæ¡†æ¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/langchain/" itemprop="url" rel="index"><span itemprop="name">langchain</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å®æˆ˜demo"><a href="#å®æˆ˜demo" class="headerlink" title="å®æˆ˜demo"></a>å®æˆ˜demo</h3><h4 id="agentå®æˆ˜"><a href="#agentå®æˆ˜" class="headerlink" title="agentå®æˆ˜"></a>agentå®æˆ˜</h4><p>langchainçš„agentä¸langgraphçš„agentä¸»è¦å·®å¼‚ç‚¹åœ¨create_openai_functions_agent, AgentExecutorè¿™ä¸¤ä¸ªå‡½æ•°</p>
<p>å‰è€…çš„ä½œç”¨ç±»ä¼¼<strong>æ„å»º Runnable é“¾</strong>ï¼Œè¿”å›ä¸€ä¸ª<code>RunnablePassthrough.assign(...)|prompt|llm_with_tools|ToolsAgentOutputParser()</code>ï¼Œä½†å…¶invokeä»…èƒ½å®Œæˆå•æ­¥çš„è°ƒç”¨ï¼Œè€Œ<code>AgentExecutor</code> ä¼šè‡ªåŠ¨å®Œæˆ3 æ­¥å¾ªç¯ï¼ˆè°ƒç”¨å·¥å…·â†’æ‹¼å›ç»“æœâ†’å†æ¬¡è°ƒç”¨ LLMï¼‰ï¼Œç›´åˆ°ä»»åŠ¡ç»“æŸã€‚</p>
<blockquote>
<p>ä»¥ä¸‹ä¸ºaiçš„è§£é‡Š</p>
<p><strong>ç›´æ¥ä½¿ç”¨ <code>agent</code> (Runnable) çš„å±€é™æ€§:</strong></p>
<ol>
<li><strong>å•æ­¥æ‰§è¡Œ</strong>: ä½ ç›´æ¥è°ƒç”¨ <code>agent.invoke()</code> æˆ– <code>agent.ainvoke()</code> æ—¶ï¼Œå®ƒé€šå¸¸åªæ‰§è¡Œ<strong>ä¸€æ­¥</strong>ã€‚å¯¹äºåƒ <code>create_tool_calling_agent</code> ç”Ÿæˆçš„ <code>agent</code> æ¥è¯´ï¼Œè¿™ä¸€æ­¥å°±æ˜¯ï¼š<ul>
<li>æ¥æ”¶è¾“å…¥ï¼ˆåŒ…æ‹¬å†å²æ¶ˆæ¯å’Œ <code>agent_scratchpad</code>ï¼‰ã€‚</li>
<li>è®© LLM å†³å®šæ˜¯ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ (<code>AgentFinish</code>) è¿˜æ˜¯è°ƒç”¨å·¥å…· (<code>AgentAction</code>)ã€‚</li>
<li>è¿”å›è¿™ä¸ªå†³å®šã€‚</li>
</ul>
</li>
<li><strong>å·¥å…·è°ƒç”¨éœ€è¦æ‰‹åŠ¨å¤„ç†</strong>: å¦‚æœ LLM å†³å®šè°ƒç”¨å·¥å…·ï¼ˆè¿”å› <code>AgentAction</code>ï¼‰ï¼Œ<strong>ä½ </strong>éœ€è¦è´Ÿè´£ï¼š<ul>
<li>ä»è¿”å›çš„ <code>AgentAction</code> ä¸­æ‰¾å‡ºå·¥å…·åç§°å’Œè¾“å…¥å‚æ•°ã€‚</li>
<li>åœ¨ä½ çš„å·¥å…·åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å·¥å…·ã€‚</li>
<li>æ‰§è¡Œè¿™ä¸ªå·¥å…·ã€‚</li>
<li>è·å–å·¥å…·çš„è¾“å‡ºï¼ˆObservationï¼‰ã€‚</li>
<li><strong>å†æ¬¡æ‰‹åŠ¨è°ƒç”¨ <code>agent.invoke(...)</code></strong>ï¼ŒæŠŠå·¥å…·çš„è¾“å‡ºï¼ˆé€šå¸¸éœ€è¦æ ¼å¼åŒ–æˆ <code>ToolMessage</code>ï¼‰æ”¾å› <code>agent_scratchpad</code> æˆ– <code>intermediate_steps</code> ä¸­ã€‚</li>
<li>é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ° <code>agent</code> æœ€ç»ˆè¿”å› <code>AgentFinish</code>ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä½¿ç”¨ <code>AgentExecutor</code> çš„ä¼˜åŠ¿:</strong></p>
<p><code>AgentExecutor</code> å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜è€Œè®¾è®¡çš„ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>è‡ªåŠ¨åŒ–çš„æ‰§è¡Œå¼•æ“</strong>ï¼Œä¸ºä½ ç®¡ç†æ•´ä¸ª Agent çš„æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯ã€‚</p>
<ol>
<li><strong>è‡ªåŠ¨åŒ–å¾ªç¯</strong>: <code>AgentExecutor</code> å†…éƒ¨ä¼šè‡ªåŠ¨è¿è¡Œé‚£ä¸ªå¾ªç¯ï¼š<ul>
<li>è°ƒç”¨ <code>agent</code> (Runnable)ã€‚</li>
<li>æ£€æŸ¥è¿”å›çš„æ˜¯ <code>AgentAction</code> è¿˜æ˜¯ <code>AgentFinish</code>ã€‚</li>
<li>å¦‚æœæ˜¯ <code>AgentAction</code>ï¼Œå®ƒä¼šè‡ªåŠ¨æ ¹æ®ä½ æä¾›çš„ <code>tools</code> åˆ—è¡¨æ‰¾åˆ°å¹¶æ‰§è¡Œå¯¹åº”çš„å·¥å…·ã€‚</li>
<li>å®ƒä¼šè‡ªåŠ¨å°†å·¥å…·çš„è¾“å‡ºï¼ˆObservationï¼‰è®°å½•ä¸‹æ¥ï¼Œå¹¶ä½œä¸ºä¸‹ä¸€æ­¥çš„è¾“å…¥ï¼ˆæ”¾å…¥ <code>agent_scratchpad</code>ï¼‰å†æ¬¡è°ƒç”¨ <code>agent</code>ã€‚</li>
<li>è¿™ä¸ªè¿‡ç¨‹ä¼šä¸€ç›´é‡å¤ã€‚</li>
</ul>
</li>
</ol>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">from langchain.agents import create_openai_functions_agent, AgentExecutor</span><br><span class="line">from langchain.tools import tool</span><br><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line">from pydantic import BaseModel, Field</span><br><span class="line"></span><br><span class="line"># 1. å®šä¹‰å·¥å…·</span><br><span class="line">class WeatherInput(BaseModel):</span><br><span class="line">    location: str = Field(description=&quot;åŸå¸‚åç§°&quot;)</span><br><span class="line"></span><br><span class="line">@tool(&quot;get_weather&quot;, args_schema=WeatherInput)</span><br><span class="line">def get_weather(location: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;æŸ¥è¯¢åŸå¸‚å¤©æ°”&quot;&quot;&quot;</span><br><span class="line">    return f&quot;&#123;location&#125; ä»Šå¤©æ˜¯æ™´å¤©ï¼Œ25Â°C&quot;</span><br><span class="line"></span><br><span class="line"># 2. åˆ›å»ºAgent</span><br><span class="line">llm = ChatOpenAI(model=&quot;gpt-4&quot;)</span><br><span class="line">tools = [get_weather]</span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    (&quot;system&quot;, &quot;ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œå¯ä»¥è°ƒç”¨å·¥å…·&quot;),</span><br><span class="line">    (&quot;human&quot;, &quot;&#123;input&#125;&quot;)</span><br><span class="line">])</span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)</span><br><span class="line"></span><br><span class="line"># 3. æ‰§è¡Œ</span><br><span class="line">result = agent_executor.invoke(&#123;&quot;input&quot;: &quot;åŒ—äº¬å¤©æ°”å¦‚ä½•ï¼Ÿ&quot;&#125;)</span><br><span class="line">print(result[&quot;output&quot;])</span><br></pre></td></tr></table></figure>
<h4 id="å·¥å…·è°ƒç”¨"><a href="#å·¥å…·è°ƒç”¨" class="headerlink" title="å·¥å…·è°ƒç”¨"></a>å·¥å…·è°ƒç”¨</h4><p>åˆ©ç”¨bind_toolsç»‘å®šå·¥å…·ï¼Œå½“å¤§æ¨¡å‹éœ€è¦è°ƒç”¨å·¥å…·çš„æ—¶å€™ï¼Œä¼šè¿”å›å·¥å…·ä¿¡æ¯ï¼Œtool_callsï¼Œå¦‚ä¸‹</p>
<p>[{â€˜nameâ€™: â€˜add_numbersâ€™, â€˜argsâ€™: {â€˜aâ€™: 15, â€˜bâ€™: 27}, â€˜idâ€™: â€˜4e7b261cce6d4e3da09134086c704c3câ€™, â€˜typeâ€™: â€˜tool_callâ€™}]</p>
<blockquote>
<p><code>llm_with_tools.invoke(...)</code> åªæ˜¯ä¸€ä¸ª<strong>å•æ­¥è°ƒç”¨</strong>ï¼ŒLLM è¿”å›çš„æ˜¯<strong>â€œæˆ‘æƒ³è°ƒç”¨å“ªä¸ªå·¥å…·ã€ä¼ ä»€ä¹ˆå‚æ•°â€</strong>ï¼ˆå³ <code>tool_calls</code>ï¼‰ã€‚<br><strong>ä½† LLM å¹¶ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œå·¥å…·</strong>ï¼Œæ‰€ä»¥ä½ å¿…é¡»ï¼š</p>
<ol>
<li><strong>æ‰‹åŠ¨æ‰§è¡Œå·¥å…·</strong>ï¼ˆæˆ–è®© AgentExecutor å¸®ä½ æ‰§è¡Œï¼‰ã€‚</li>
<li><strong>æŠŠæ‰§è¡Œç»“æœæ‹¼å›å¯¹è¯</strong>ï¼ˆä½œä¸º <code>ToolMessage</code>ï¼‰ã€‚</li>
<li><strong>å†æ¬¡è°ƒç”¨ LLM</strong>ï¼Œè®©å®ƒåŸºäºå·¥å…·è¿”å›çš„ç»“æœç”Ÿæˆæœ€ç»ˆç­”æ¡ˆã€‚</li>
</ol>
</blockquote>
<p>è¿™é‡Œå±•ç¤ºçš„æ˜¯æ‰‹åŠ¨æ‹¼æ¥ï¼Œå¹¶ä¼ ç»™å¤§æ¨¡å‹ï¼Œå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># å°†å·¥å…·çš„è¾“å‡ºå‘é€å›LLMï¼Œè®©LLMåŸºäºç»“æœç”Ÿæˆæœ€ç»ˆå›ç­”</span><br><span class="line">            # è¿™æ˜¯ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼Œé€šå¸¸åœ¨Agentä¸­è‡ªåŠ¨å¤„ç†ã€‚è¿™é‡Œæ‰‹åŠ¨æ¼”ç¤ºã€‚</span><br><span class="line">            final_response = llm_with_tools.invoke([</span><br><span class="line">                HumanMessage(content=&quot;What is 15 + 27?&quot;),</span><br><span class="line">                AIMessage(content=&quot;&quot;, tool_calls=[tool_call]), # å‘ŠçŸ¥LLMå®ƒä¹‹å‰å»ºè®®çš„å·¥å…·è°ƒç”¨</span><br><span class="line">                ToolMessage(content=str(result), tool_call_id=tool_call[&#x27;id&#x27;]) # å‘ŠçŸ¥LLMå·¥å…·çš„æ‰§è¡Œç»“æœ</span><br><span class="line">            ])</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.tools import tool</span><br><span class="line">from typing import Literal</span><br><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line">from langchain_core.messages import HumanMessage, AIMessage, ToolMessage</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ä¸€ä¸ªåŠ æ³•å·¥å…·</span><br><span class="line">@tool</span><br><span class="line">def add_numbers(a: float, b: float) -&gt; float:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Adds two numbers together.</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">        a: The first number.</span><br><span class="line">        b: The second number.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return a + b</span><br><span class="line"></span><br><span class="line"># æˆ‘ä»¬å¯ä»¥å®šä¹‰æ›´å¤šçš„å·¥å…·ï¼Œä¾‹å¦‚ä¸€ä¸ªä¹˜æ³•å·¥å…·</span><br><span class="line">@tool</span><br><span class="line">def multiply_numbers(a: float, b: float) -&gt; float:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Multiplies two numbers together.</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">        a: The first number.</span><br><span class="line">        b: The second number.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return a * b</span><br><span class="line"></span><br><span class="line"># å°†æˆ‘ä»¬å®šä¹‰çš„å·¥å…·æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­</span><br><span class="line">tools = [add_numbers, multiply_numbers]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–LLM</span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    temperature=0.5,</span><br><span class="line">    model_name=&quot;deepseek-v3-0324&quot;, # èŠå¤©æ¨¡å‹é€šå¸¸ä½¿ç”¨&quot;gpt-3.5-turbo&quot;æˆ–&quot;gpt-4&quot;</span><br><span class="line">    openai_api_base=&quot;https://api.qnaigc.com/v1&quot;, # ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æŒ‡å®šbase_url</span><br><span class="line">    openai_api_key=&quot;sk-&quot; # ç›´æ¥åœ¨æ­¤å¤„è®¾ç½®APIå¯†é’¥ï¼Œæˆ–è€…é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®</span><br><span class="line">)</span><br><span class="line"># å°†å·¥å…·ç»‘å®šåˆ°LLM</span><br><span class="line"># LLMç°åœ¨çŸ¥é“äº†add_numberså’Œmultiply_numbersè¿™ä¸¤ä¸ªå·¥å…·åŠå…¶åŠŸèƒ½</span><br><span class="line">llm_with_tools = llm.bind_tools(tools)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># åœºæ™¯ä¸€ï¼šLLMç›´æ¥å›ç­”ï¼Œä¸éœ€è¦å·¥å…·</span><br><span class="line">print(&quot;--- åœºæ™¯ä¸€ï¼šLLMç›´æ¥å›ç­” ---&quot;)</span><br><span class="line">response1 = llm_with_tools.invoke([HumanMessage(content=&quot;Hello, what&#x27;s your name?&quot;)])</span><br><span class="line">print(response1.content) # LLMç›´æ¥ç”Ÿæˆæ–‡æœ¬å›å¤</span><br><span class="line"></span><br><span class="line">print(&quot;\n--- åœºæ™¯äºŒï¼šLLMå†³å®šè°ƒç”¨å·¥å…· ---&quot;)</span><br><span class="line"># åœºæ™¯äºŒï¼šLLMå†³å®šè°ƒç”¨å·¥å…·</span><br><span class="line"># å½“LLMçš„å“åº”ä¸­åŒ…å«tool_callsæ—¶ï¼Œæ„å‘³ç€å®ƒæƒ³è¦è°ƒç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå·¥å…·</span><br><span class="line">response2 = llm_with_tools.invoke([HumanMessage(content=&quot;What is 15 + 27?&quot;)])</span><br><span class="line">print(response2.tool_calls) # æ‰“å°LLMå†³å®šè°ƒç”¨çš„å·¥å…·ä¿¡æ¯</span><br><span class="line"></span><br><span class="line"># æ£€æŸ¥å¹¶æ‰§è¡ŒLLMå»ºè®®çš„å·¥å…·è°ƒç”¨</span><br><span class="line">if response2.tool_calls:</span><br><span class="line">    for tool_call in response2.tool_calls:</span><br><span class="line">        if tool_call[&#x27;name&#x27;] == &quot;add_numbers&quot;:</span><br><span class="line">            # æå–LLMä¸ºå·¥å…·è°ƒç”¨ç”Ÿæˆçš„å‚æ•°</span><br><span class="line">            args = tool_call[&#x27;args&#x27;]</span><br><span class="line">            result = add_numbers.invoke(args) # æ‰§è¡Œå·¥å…·</span><br><span class="line">            print(f&quot;Tool call: add_numbers(&#123;args[&#x27;a&#x27;]&#125;, &#123;args[&#x27;b&#x27;]&#125;) = &#123;result&#125;&quot;)</span><br><span class="line"></span><br><span class="line">            # å°†å·¥å…·çš„è¾“å‡ºå‘é€å›LLMï¼Œè®©LLMåŸºäºç»“æœç”Ÿæˆæœ€ç»ˆå›ç­”</span><br><span class="line">            # è¿™æ˜¯ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼Œé€šå¸¸åœ¨Agentä¸­è‡ªåŠ¨å¤„ç†ã€‚è¿™é‡Œæ‰‹åŠ¨æ¼”ç¤ºã€‚</span><br><span class="line">            final_response = llm_with_tools.invoke([</span><br><span class="line">                HumanMessage(content=&quot;What is 15 + 27?&quot;),</span><br><span class="line">                AIMessage(content=&quot;&quot;, tool_calls=[tool_call]), # å‘ŠçŸ¥LLMå®ƒä¹‹å‰å»ºè®®çš„å·¥å…·è°ƒç”¨</span><br><span class="line">                ToolMessage(content=str(result), tool_call_id=tool_call[&#x27;id&#x27;]) # å‘ŠçŸ¥LLMå·¥å…·çš„æ‰§è¡Œç»“æœ</span><br><span class="line">            ])</span><br><span class="line">            print(&quot;Final LLM response based on tool output:&quot;)</span><br><span class="line">            print(final_response.content)</span><br></pre></td></tr></table></figure>
<h3 id="æ¦‚å¿µæ‰«ç›²"><a href="#æ¦‚å¿µæ‰«ç›²" class="headerlink" title="æ¦‚å¿µæ‰«ç›²"></a>æ¦‚å¿µæ‰«ç›²</h3><h4 id="Document-å¯¹è±¡"><a href="#Document-å¯¹è±¡" class="headerlink" title="Document å¯¹è±¡"></a>Document å¯¹è±¡</h4><p>Document å¯¹è±¡æ˜¯ LangChain ç”¨æ¥å°è£…å’Œå¤„ç†æ–‡æœ¬æ•°æ®çš„åŸºæœ¬å•ä½ã€‚æ— è®ºæ‚¨æ˜¯ä» PDFã€Markdown æ–‡ä»¶ã€ç½‘ç«™è¿˜æ˜¯æ•°æ®åº“åŠ è½½æ•°æ®ï¼ŒLangChain éƒ½ä¼šå°†è¿™äº›æ•°æ®è½¬æ¢æˆä¸€ä¸ªæˆ–å¤šä¸ª Document å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨åç»­çš„æµç¨‹ä¸­ä½¿ç”¨ã€‚</p>
<p>ä¸€ä¸ª Document å¯¹è±¡ä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><p>page_content (å­—ç¬¦ä¸²)</p>
<ul>
<li>è¿™æ˜¯æ–‡æ¡£å¯¹è±¡çš„æ ¸å¿ƒï¼Œå­˜å‚¨äº†åŸå§‹çš„æ–‡æœ¬å†…å®¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåŠ è½½ä¸€ä¸ª Markdown æ–‡ä»¶ï¼Œ page_content å°±ä¼šåŒ…å«è¯¥æ–‡ä»¶çš„æ‰€æœ‰æ–‡æœ¬ã€‚</li>
</ul>
</li>
<li><p>metadata (å­—å…¸)</p>
<ul>
<li>è¿™æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œç”¨äºå­˜å‚¨å…³äºæ–‡æ¡£çš„â€œå…ƒæ•°æ®â€æˆ–é™„åŠ ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯¹äºè¿‡æ»¤ã€è¿½è¸ªæˆ–å¢å¼ºæ–‡æ¡£å¤„ç†æµç¨‹éå¸¸æœ‰ç”¨ã€‚å¸¸è§çš„å…ƒæ•°æ®åŒ…æ‹¬ï¼š<ul>
<li>source ï¼šæ–‡æ¡£çš„æ¥æºï¼Œæ¯”å¦‚æ–‡ä»¶åã€URLç­‰ã€‚</li>
<li>page ï¼šå¦‚æœæ–‡æ¡£æ¥è‡ªå¤šé¡µæ–‡ä»¶ï¼ˆå¦‚PDFï¼‰ï¼Œè¿™é‡Œå¯ä»¥å­˜å‚¨é¡µç ã€‚</li>
<li>å…¶ä»–è‡ªå®šä¹‰ä¿¡æ¯ï¼šæ‚¨å¯ä»¥æ·»åŠ ä»»ä½•æœ‰åŠ©äºæ‚¨åº”ç”¨çš„ä¿¡æ¯ï¼Œå¦‚ä½œè€…ã€åˆ›å»ºæ—¥æœŸç­‰ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>é™¤äº†é€šè¿‡æ–‡æ¡£åŠ è½½å™¨ï¼ˆLoadersï¼‰è‡ªåŠ¨åˆ›å»ºï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª Document å¯¹è±¡ã€‚è¿™åœ¨æµ‹è¯•æˆ–å¤„ç†ç®€å•æ–‡æœ¬æ—¶éå¸¸æ–¹ä¾¿ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºä¸€ä¸ªç®€å•çš„ Document å¯¹è±¡</span><br><span class="line">doc = Document(</span><br><span class="line">    page_content=&quot;è¿™æ˜¯æ–‡æ¡£çš„ä¸»è¦å†…å®¹ã€‚LangChain çœŸé…·ï¼&quot;,</span><br><span class="line">    metadata=&#123;</span><br><span class="line">        &#x27;source&#x27;: &#x27;my_notebook.ipynb&#x27;,</span><br><span class="line">        &#x27;author&#x27;: &#x27;AI Assistant&#x27;,</span><br><span class="line">        &#x27;chapter&#x27;: 2</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="Runnableåè®®"><a href="#Runnableåè®®" class="headerlink" title="Runnableåè®®"></a>Runnableåè®®</h4><p><a target="_blank" rel="noopener" href="https://python.langchain.com/api_reference/core/runnables/langchain_core.runnables.base.Runnable.html#langchain_core.runnables.base.Runnable">â€œRunnableâ€</a>åè®®</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV12TLAzuEni/?spm_id_from=333.337.search-card.all.click&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">2025æœ€æ–°ç‰ˆï¼langchainå…¥é—¨åˆ°ç²¾é€šå®æˆ˜æ•™ç¨‹ï¼ç»“åˆå®æˆ˜æ¡ˆä¾‹ï¼Œå¹²è´§æ‹‰æ»¡ï¼99%çš„äººä¸çŸ¥é“çš„æš´åˆ©ç©æ³•ï¼Œå­¦å®Œæ•¢è°·æ­Œå·¥ç¨‹å¸ˆå«æ¿ï¼_å“”å“©å“”å“©_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://www.langchain.com.cn/docs/introduction/">introduction | LangChainä¸­æ–‡ç½‘</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1XudVYzEcW?spm_id_from=333.788.videopod.episodes&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">è·Ÿç€å®˜ç½‘å­¦langchain2025(version 0.3)_å“”å“©å“”å“©_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.langchain.com/langgraph-platform">LangGraph Platform - Docs by LangChain</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/15/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langsmith/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/15/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langsmith/" class="post-title-link" itemprop="url">Langsmith</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-15 00:00:00 / ä¿®æ”¹æ—¶é—´ï¼š17:55:00" itemprop="dateCreated datePublished" datetime="2025-07-15T00:00:00+08:00">2025-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">aiæ¡†æ¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/langsmith/" itemprop="url" rel="index"><span itemprop="name">langsmith</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="é…ç½®langsmith">é…ç½®langsmith</h3>
<h4 id="å®‰è£…langsmith-sdk">å®‰è£…LangSmith SDK</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install langsmith</span><br></pre></td></tr></table></figure>
<h4 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</h4>
<p>è·å–api<a target="_blank" rel="noopener" href="https://smith.langchain.com/o/56031c2a-c402-41d4-83ed-ed15d0693548/settings/apikeys">LangSmith</a></p>
<p>è®¾ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡ã€‚è¿™å°†æŠŠè·Ÿè¸ªè®°å½•åˆ°<code>default</code>é¡¹ç›®ï¼ˆå°½ç®¡æ‚¨å¯ä»¥è½»æ¾æ›´æ”¹ï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export LANGSMITH_TRACING=true</span><br><span class="line">export LANGSMITH_API_KEY=</span><br><span class="line">export LANGSMITH_PROJECT=default</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LANGSMITH_TRACING=true</span><br><span class="line">LANGSMITH_ENDPOINT=&quot;https://api.smith.langchain.com&quot;</span><br><span class="line">LANGSMITH_API_KEY=&quot;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&quot;</span><br><span class="line">LANGSMITH_PROJECT=&quot;langgraph&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="èµ„æº">èµ„æº</h3>
<p>å®˜ç½‘<a target="_blank" rel="noopener" href="https://smith.langchain.com/o/56031c2a-c402-41d4-83ed-ed15d0693548/">ã€ŠLangSmithã€‹
â€” LangSmith</a></p>
<p>å‚è€ƒæ–‡æ¡£<a target="_blank" rel="noopener" href="https://langsmith.langchain.ac.cn/">LangSmith å…¥é—¨ |
ğŸ¦œï¸ğŸ› ï¸ LangSmith æ–‡æ¡£</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.smith.langchain.com/">Get started with
LangSmith | ğŸ¦œï¸ğŸ› ï¸ LangSmith</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">å¼ ç†™æµš</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="æœ¬ç«™è®¿é—®æ•° fa fa-user æ¬¡"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="æœ¬ç«™æ€»è®¿é—®é‡ fa fa-eye æ¬¡"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="400" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
