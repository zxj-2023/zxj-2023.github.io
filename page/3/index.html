<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-bounce.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="zxj Blogs">
<meta property="og:type" content="website">
<meta property="og:title" content="Zhang XiJun">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Zhang XiJun">
<meta property="og:description" content="zxj Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="å¼ ç†™æµš">
<meta property="article:tag" content="zxj">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zhang XiJun</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zhang XiJun</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">BLOGS</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="å¼ ç†™æµš"
      src="/images/zxjavatar.gif">
  <p class="site-author-name" itemprop="name">å¼ ç†™æµš</p>
  <div class="site-description" itemprop="description">zxj Blogs</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">136</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zxj-2023" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;zxj-2023" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://wpa.qq.com/msgrd?v=3&uin=2902065320&site=qq&menu=yes" title="QQ â†’ http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;2902065320&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener me" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          é“¾æ¥
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://zxj-2023.github.io/" title="https:&#x2F;&#x2F;zxj-2023.github.io" rel="noopener" target="_blank">Zhang XiJun</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://theme-next.js.org/" title="https:&#x2F;&#x2F;theme-next.js.org" rel="noopener" target="_blank">NexT</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/01/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/mcp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/01/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/mcp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">MCP æœåŠ¡ç«¯å®æˆ˜</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-01T00:00:00+08:00">2025-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-02 12:01:56" itemprop="dateModified" datetime="2025-08-02T12:01:56+08:00">2025-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="é…ç½®ç¯å¢ƒ">é…ç½®ç¯å¢ƒ</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Create a new directory for our project</span><br><span class="line">uv init weather</span><br><span class="line">cd weather</span><br><span class="line"></span><br><span class="line"># Create virtual environment and activate it</span><br><span class="line">uv venv</span><br><span class="line">source .venv/bin/activate</span><br><span class="line"></span><br><span class="line"># Install dependencies</span><br><span class="line">uv add &quot;mcp[cli]&quot; httpx</span><br><span class="line"></span><br><span class="line"># Create our server file</span><br><span class="line">touch weather.py</span><br></pre></td></tr></table></figure>
<h3 id="mcp-studioæ ·ä¾‹">mcp studioæ ·ä¾‹</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from mcp.server.fastmcp import FastMCP</span><br><span class="line"></span><br><span class="line">mcp = FastMCP(&quot;Math&quot;)</span><br><span class="line"></span><br><span class="line">@mcp.tool()</span><br><span class="line">def add(a: int, b: int) -&gt; int:</span><br><span class="line">    &quot;&quot;&quot;Add two numbers&quot;&quot;&quot;</span><br><span class="line">    return a + b</span><br><span class="line"></span><br><span class="line">@mcp.tool()</span><br><span class="line">def multiply(a: int, b: int) -&gt; int:</span><br><span class="line">    &quot;&quot;&quot;Multiply two numbers&quot;&quot;&quot;</span><br><span class="line">    return a * b</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    mcp.run(transport=&quot;stdio&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="mcp-streamable-http-æ ·ä¾‹">mcp streamable-http æ ·ä¾‹</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from mcp.server.fastmcp import FastMCP</span><br><span class="line"></span><br><span class="line">mcp = FastMCP(&quot;Weather&quot;)</span><br><span class="line"></span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_weather(location: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;Get weather for location.&quot;&quot;&quot;</span><br><span class="line">    return &quot;It&#x27;s always sunny in New York&quot;</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    mcp.run(transport=&quot;streamable-http&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>
<p>mcpå¸‚åœº<a target="_blank" rel="noopener" href="https://www.modelscope.cn/mcp">MCP å¹¿åœº Â·
é­”æ­ç¤¾åŒº</a></p>
<p><strong>ä½¿ç”¨ uvï¼ˆæ¨èï¼‰</strong></p>
<p>å½“ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://docs.astral.sh/uv/"><code>uv</code></a>
æ—¶ä¸éœ€è¦ç‰¹å®šçš„å®‰è£…æ­¥éª¤ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://docs.astral.sh/uv/guides/tools/"><code>uvx</code></a>
ç›´æ¥è¿è¡Œ <em>mcp-server-fetch</em>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;mcpServers&quot;: &#123;</span><br><span class="line">  &quot;fetch&quot;: &#123;</span><br><span class="line">    &quot;command&quot;: &quot;uvx&quot;,</span><br><span class="line">    &quot;args&quot;: [&quot;mcp-server-fetch&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä½¿ç”¨ PIP</strong></p>
<p>æˆ–è€…ï¼Œæ‚¨å¯ä»¥é€šè¿‡ pip å®‰è£… <code>mcp-server-fetch</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mcp-server-fetch</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;mcpServers&quot;: &#123;</span><br><span class="line">  &quot;fetch&quot;: &#123;</span><br><span class="line">    &quot;command&quot;: &quot;python&quot;,</span><br><span class="line">    &quot;args&quot;: [&quot;-m&quot;, &quot;mcp_server_fetch&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¿œç¨‹æ‰˜ç®¡</strong></p>
<figure>
<img src="/2025/08/01/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/mcp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E6%88%98/image-20250802120145192.png" alt="image-20250802120145192">
<figcaption aria-hidden="true">image-20250802120145192</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;mcpServers&quot;: &#123;</span><br><span class="line">    &quot;fetch&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;sse&quot;,</span><br><span class="line">      &quot;url&quot;: &quot;https://mcp.api-inference.modelscope.net/991cf46/sse&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/quickstart/server#core-mcp-concepts">æ„å»º
MCP æœåŠ¡å™¨ - æ¨¡å‹ä¸Šä¸‹æ–‡åè®® â€” Build an MCP Server - Model Context
Protocol</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/01/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/langgraph%E5%AE%9E%E6%88%98mcp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/01/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/langgraph%E5%AE%9E%E6%88%98mcp/" class="post-title-link" itemprop="url">langgraphå®æˆ˜mcp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-01T00:00:00+08:00">2025-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-02 11:47:16" itemprop="dateModified" datetime="2025-08-02T11:47:16+08:00">2025-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install langchain-mcp-adapters</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨langgraphè°ƒç”¨mcp">ä½¿ç”¨langgraphè°ƒç”¨mcp</h3>
<p>è¦ç‚¹ä¸»è¦æ˜¯åˆ©ç”¨MultiServerMCPClientæ„å»ºæœåŠ¡ï¼Œè·å–tool</p>
<p>åˆ©ç”¨é¢„è®¾çš„create_react_agentæ„å»ºReActæ¶æ„çš„æ™ºèƒ½ä½“å¹¶è°ƒç”¨å·¥å…·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">import asyncio # éœ€è¦å¯¼å…¥ asyncio æ¥è¿è¡Œå¼‚æ­¥å‡½æ•°</span><br><span class="line"># ä»langchain_mcp_adapters.clientæ¨¡å—å¯¼å…¥MultiServerMCPClientç±»</span><br><span class="line"># ä»langgraph.prebuiltæ¨¡å—å¯¼å…¥create_react_agentå‡½æ•°</span><br><span class="line">from langchain_mcp_adapters.client import MultiServerMCPClient</span><br><span class="line">from langgraph.prebuilt import create_react_agent</span><br><span class="line"></span><br><span class="line"># å¯¼å…¥ LLM ç›¸å…³åº“</span><br><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line"></span><br><span class="line"># å°†ä¸»è¦é€»è¾‘å°è£…åœ¨ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ä¸­</span><br><span class="line">async def main():</span><br><span class="line">    # åˆ›å»ºMultiServerMCPClientå®ä¾‹ï¼Œé…ç½®ä¸¤ä¸ªä¸åŒçš„æœåŠ¡</span><br><span class="line">    client = MultiServerMCPClient(</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;math&quot;: &#123;  # æ•°å­¦è®¡ç®—æœåŠ¡</span><br><span class="line">                &quot;command&quot;: &quot;python&quot;,  # ä½¿ç”¨pythonå‘½ä»¤å¯åŠ¨</span><br><span class="line">                # æ›¿æ¢ä¸ºä½ çš„math_server.pyæ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span><br><span class="line">                &quot;args&quot;: [&quot;/workspace/langgraph-mcp/math_server.py&quot;],</span><br><span class="line">                &quot;transport&quot;: &quot;stdio&quot;,  # ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºä¼ è¾“</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;weather&quot;: &#123;  # å¤©æ°”æœåŠ¡</span><br><span class="line">                # ç¡®ä¿ä½ çš„å¤©æ°”æœåŠ¡å™¨åœ¨8000ç«¯å£è¿è¡Œ</span><br><span class="line">                # *** ç¡®ä¿è¿™ä¸ª URL æ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ ***</span><br><span class="line">                &quot;url&quot;: &quot;http://localhost:8000/mcp&quot;,</span><br><span class="line">                &quot;transport&quot;: &quot;streamable_http&quot;,  # ä½¿ç”¨å¯æµå¼HTTPä¼ è¾“</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    tools = []</span><br><span class="line">    try:</span><br><span class="line">        # åœ¨å¼‚æ­¥å‡½æ•°å†…éƒ¨æ­£ç¡®ä½¿ç”¨ await</span><br><span class="line">        tools = await client.get_tools()</span><br><span class="line">        print(f&quot;æˆåŠŸè·å–åˆ° &#123;len(tools)&#125; ä¸ªMCPå·¥å…·ã€‚&quot;)</span><br><span class="line">        for tool_item in tools:</span><br><span class="line">            print(f&quot;  - &#123;tool_item.name&#125;: &#123;tool_item.description&#125;&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;è·å–MCPå·¥å…·å¤±è´¥: &#123;e&#125;&quot;)</span><br><span class="line">        print(&quot;è¯·ç¡®ä¿MCPæœåŠ¡URLæœ‰æ•ˆä¸”å¯è®¿é—®ï¼Œæˆ–è€…æ‚¨å·²æ­£ç¡®é…ç½®äº†è®¤è¯ä¿¡æ¯ã€‚&quot;)</span><br><span class="line">        # åœ¨å‡½æ•°å†…éƒ¨ï¼Œå¦‚æœå‡ºé”™å¯ä»¥é€‰æ‹©è¿”å›æˆ–ç»§ç»­å¤„ç†</span><br><span class="line">        # return # è¿™é‡Œå¯ä»¥ returnï¼Œä½†ä¼šç»“æŸ main å‡½æ•°</span><br><span class="line"></span><br><span class="line">    if not tools:</span><br><span class="line">        print(&quot;æ²¡æœ‰è·å–åˆ°å·¥å…·ï¼Œæ— æ³•åˆ›å»ºä»£ç†ã€‚&quot;)</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºReActä»£ç†</span><br><span class="line">    llm = ChatOpenAI(</span><br><span class="line">        model=&quot;qwen3-235b-a22b-thinking-2507&quot;,</span><br><span class="line">        api_key=&quot;sk-a8ef27c47ea84224ac6eed6d4bba1bab&quot;,</span><br><span class="line">        base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot; # ä¿®æ­£äº†æœ«å°¾å¤šä½™çš„ç©ºæ ¼</span><br><span class="line">    )</span><br><span class="line">    agent = create_react_agent(llm, tools)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    # å¼‚æ­¥è°ƒç”¨ä»£ç†æ¥è§£å†³æ•°å­¦é—®é¢˜</span><br><span class="line">    # ç¡®ä¿åœ¨å¼‚æ­¥å‡½æ•°å†…éƒ¨ä½¿ç”¨ await</span><br><span class="line">    math_response = await agent.ainvoke(</span><br><span class="line">        &#123;&quot;messages&quot;: [&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;what&#x27;s (3 + 5) x 12?&quot;&#125;]&#125;</span><br><span class="line">    )</span><br><span class="line">    print(&quot;\n--- æ•°å­¦é—®é¢˜å›ç­” ---&quot;)</span><br><span class="line">    print(math_response[&quot;messages&quot;][-1].content) # æ‰“å°æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆLLMçš„å›ç­”ï¼‰</span><br><span class="line"></span><br><span class="line">    # å¼‚æ­¥è°ƒç”¨ä»£ç†æ¥æŸ¥è¯¢å¤©æ°”</span><br><span class="line">    weather_response = await agent.ainvoke(</span><br><span class="line">        &#123;&quot;messages&quot;: [&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;what is the weather in nyc?&quot;&#125;]&#125;</span><br><span class="line">    )</span><br><span class="line">    print(&quot;\n--- å¤©æ°”é—®é¢˜å›ç­” ---&quot;)</span><br><span class="line">    print(weather_response[&quot;messages&quot;][-1].content) # æ‰“å°æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆLLMçš„å›ç­”ï¼‰</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># --- è¿™æ˜¯è„šæœ¬çš„å…¥å£ç‚¹ ---</span><br><span class="line"># ä½¿ç”¨ asyncio.run() æ¥è¿è¡Œä½ çš„ä¸»å¼‚æ­¥å‡½æ•°</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    asyncio.run(main())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://github.langchain.ac.cn/langgraph/agents/mcp/">ä½¿ç”¨
MCP - LangChain æ¡†æ¶</a></p>
<h3 id="æ¡†æ¶æµç¨‹">æ¡†æ¶æµç¨‹</h3>
<figure>
<img src="/2025/08/01/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/langgraph%E5%AE%9E%E6%88%98mcp/image-20250801164905578.png" alt="image-20250801164905578">
<figcaption aria-hidden="true">image-20250801164905578</figcaption>
</figure>
<p>âœ… ä¸‰ä¸ªè§’è‰²ï¼ˆç³»ç»Ÿç»„ä»¶ï¼‰</p>
<table>
<colgroup>
<col style="width: 28%">
<col style="width: 72%">
</colgroup>
<thead>
<tr>
<th>è§’è‰²</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Client</strong></td>
<td>å‰ç«¯æˆ–ç”¨æˆ·ç•Œé¢ï¼Œå‘èµ·è¯·æ±‚</td>
</tr>
<tr>
<td><strong>Auth Provider</strong></td>
<td>è®¤è¯æœåŠ¡ï¼ˆå¦‚ OAuthã€JWT æä¾›è€…ï¼‰ï¼Œè´Ÿè´£ç™»å½•å’Œç­¾å‘ token</td>
</tr>
<tr>
<td><strong>LangGraph Backend</strong></td>
<td>åº”ç”¨çš„åç«¯æœåŠ¡ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘</td>
</tr>
<tr>
<td><strong>Secret Store</strong></td>
<td>å­˜æ”¾ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ tokenã€å¯†é’¥ç­‰ï¼‰</td>
</tr>
<tr>
<td><strong>MCP Server</strong></td>
<td>åç«¯å·¥å…·æœåŠ¡ï¼Œæä¾›å…·ä½“çš„å·¥å…·æˆ–èµ„æºæ¥å£</td>
</tr>
</tbody>
</table>
<p>âœ… æµç¨‹è¯¦è§£ï¼ˆ12æ­¥ï¼‰</p>
<p>ğŸ” é˜¶æ®µä¸€ï¼šç”¨æˆ·ç™»å½• &amp; è·å– Tokenï¼ˆ1~6ï¼‰</p>
<ol type="1">
<li><p><strong>ç”¨æˆ·ç™»å½•</strong><br>
Client æäº¤ç”¨æˆ·åå’Œå¯†ç ç»™ Auth Providerã€‚</p></li>
<li><p><strong>è¿”å› Token</strong><br>
Auth Provider éªŒè¯æˆåŠŸåï¼Œè¿”å›ä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼ˆtokenï¼‰ã€‚</p></li>
<li><p><strong>æºå¸¦ Token è¯·æ±‚</strong><br>
Client å°† token é™„åŠ åœ¨è¯·æ±‚å¤´ä¸­ï¼Œå‘ç»™ LangGraph Backendã€‚</p></li>
<li><p><strong>éªŒè¯ Token</strong><br>
LangGraph Backend ä½¿ç”¨ <code>@auth.authenticate</code> ä¸­é—´ä»¶éªŒè¯ token
æ˜¯å¦æœ‰æ•ˆã€‚</p></li>
<li><p><strong>è·å–ç”¨æˆ·ä¿¡æ¯</strong><br>
éªŒè¯é€šè¿‡åï¼ŒLangGraph Backend ä» Auth Provider
æ‹‰å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ã€‚</p></li>
<li><p><strong>ç¡®è®¤æœ‰æ•ˆæ€§</strong><br>
åç«¯ç¡®è®¤ç”¨æˆ·ä¿¡æ¯æ— è¯¯ï¼Œæµç¨‹ç»§ç»­ã€‚</p></li>
</ol>
<p>ğŸ”‘ é˜¶æ®µäºŒï¼šè·å–ç”¨æˆ·æƒé™ Tokenï¼ˆ6a~6bï¼‰</p>
<p>6a. <strong>æ‹‰å–ç”¨æˆ·æƒé™ Token</strong><br>
LangGraph Backend ä» Secret Store è·å–è¯¥ç”¨æˆ·å¯¹åº”çš„æƒé™ tokenï¼ˆå¯èƒ½æ˜¯ MCP
æ‰€éœ€çš„è®¿é—®å‡­è¯ï¼‰ã€‚</p>
<p>6b. <strong>è¿”å›æƒé™ Token</strong><br>
Secret Store è¿”å›è¯¥ tokenã€‚</p>
<p>ğŸ› ï¸ é˜¶æ®µä¸‰ï¼šè°ƒç”¨å·¥å…· &amp; è¿”å›ç»“æœï¼ˆ7~12ï¼‰</p>
<ol start="7" type="1">
<li><p><strong>æƒé™æ§åˆ¶æ£€æŸ¥</strong><br>
LangGraph Backend ä½¿ç”¨ <code>@auth.on.*</code>
æƒé™æ§åˆ¶é€»è¾‘ï¼Œç¡®è®¤ç”¨æˆ·æ˜¯å¦æœ‰æƒè°ƒç”¨è¯¥å·¥å…·ã€‚</p></li>
<li><p><strong>æ„å»º MCP Client</strong><br>
åç«¯ç”¨ç”¨æˆ·çš„æƒé™ token æ„å»ºä¸€ä¸ª MCP å®¢æˆ·ç«¯ã€‚</p></li>
<li><p><strong>è°ƒç”¨ MCP å·¥å…·</strong><br>
MCP Client å‘èµ·è¯·æ±‚ï¼Œè°ƒç”¨æŸä¸ªå…·ä½“å·¥å…·ï¼Œæºå¸¦
tokenï¼ˆé€šå¸¸æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼‰ã€‚</p></li>
<li><p><strong>MCP éªŒè¯å¹¶æ‰§è¡Œ</strong><br>
MCP Server éªŒè¯ token æ˜¯å¦æœ‰æ•ˆï¼Œç¡®è®¤æ— è¯¯åæ‰§è¡Œå·¥å…·é€»è¾‘ã€‚</p></li>
<li><p><strong>å·¥å…·è¿”å›ç»“æœ</strong><br>
MCP Server è¿”å›å·¥å…·æ‰§è¡Œç»“æœæˆ–èµ„æºæ•°æ®ã€‚</p></li>
<li><p><strong>è¿”å›ç»™å‰ç«¯</strong><br>
LangGraph Backend å°†ç»“æœè¿”å›ç»™ Clientï¼Œå®Œæˆæ•´ä¸ªé“¾è·¯ã€‚</p></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/31/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/%E5%82%A8%E5%AD%98%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93Chroma/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/31/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/%E5%82%A8%E5%AD%98%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93Chroma/" class="post-title-link" itemprop="url">å‚¨å­˜å‘é‡æ•°æ®åº“Chroma</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-31 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-31T00:00:00+08:00">2025-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-19 17:16:04" itemprop="dateModified" datetime="2025-08-19T17:16:04+08:00">2025-08-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/agent%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">agentå®æˆ˜</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="chromaæ˜¯ä»€ä¹ˆ">Chromaæ˜¯ä»€ä¹ˆ</h3>
<p>Chromaï¼ˆé€šå¸¸æŒ‡ <strong>ChromaDB</strong>ï¼‰æ˜¯ä¸€æ¬¾ <strong>å¼€æºã€AI
åŸç”Ÿçš„å‘é‡æ•°æ®åº“</strong>ï¼Œä¸“ä¸ºå­˜å‚¨å’Œæ£€ç´¢ <strong>é«˜ç»´åµŒå…¥å‘é‡</strong>
è€Œè®¾è®¡ï¼Œç›®æ ‡æ˜¯è®©å¼€å‘è€… <strong>5 åˆ†é’Ÿå†…åœ¨æœ¬åœ°è·‘èµ·ä¸€ä¸ªè¯­ä¹‰æœç´¢æˆ– RAG
ç³»ç»Ÿ</strong>ã€‚</p>
<p><strong>æç®€å®‰è£…</strong>ï¼š<code>pip install chromadb</code></p>
<p><strong>åŒè¿è¡Œæ¨¡å¼</strong>ï¼š</p>
<ul>
<li><strong>å†…å­˜æ¨¡å¼</strong>ï¼šè°ƒè¯•/åŸå‹éšæ„é‡å¯ï¼›</li>
<li><strong>æŒä¹…åŒ–æ¨¡å¼</strong>ï¼šæŒ‡å®š <code>persist_directory</code>
å³å¯è½ç›˜ï¼Œç”Ÿäº§ä¹Ÿä¸æ€•ä¸¢æ•°æ®ã€‚</li>
</ul>
<p><strong>HNSW ç´¢å¼•</strong>ï¼šç™¾ä¸‡çº§å‘é‡ä¹Ÿèƒ½ <strong>æ¯«ç§’çº§</strong>
å“åº”ã€‚</p>
<h3 id="ä½¿ç”¨chromaå­˜å‚¨">ä½¿ç”¨chromaå­˜å‚¨</h3>
<h4 id="æ–‡æ¡£åˆ†å—">æ–‡æ¡£åˆ†å—</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from langchain.document_loaders import PyPDFLoader</span><br><span class="line">from langchain.text_splitter import RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line">loader = PyPDFLoader(&quot;input/å¥åº·æ¡£æ¡ˆ.pdf&quot;)</span><br><span class="line">docs = loader.load()</span><br><span class="line">#é€’å½’åˆ†å—</span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter(chunk_siz</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰embeddingæ¨¡å‹ä¸chroma">å®šä¹‰embeddingæ¨¡å‹ä¸chroma</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from langchain.vectorstores import Chroma</span><br><span class="line">from langchain_openai import OpenAIEmbeddings</span><br><span class="line">embedding = OpenAIEmbeddings(</span><br><span class="line">api_key=&quot;sk-&quot;, </span><br><span class="line">base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;,</span><br><span class="line">model=&quot;text-embedding-v4&quot;,</span><br><span class="line">check_embedding_ctx_length = False,</span><br><span class="line">dimensions=1536</span><br><span class="line">)</span><br><span class="line"># ä½¿ç”¨ Chroma å‘é‡æ•°æ®åº“å­˜å‚¨æ–‡æ¡£ chunks</span><br><span class="line">vectorstore = Chroma.from_documents(</span><br><span class="line">    documents=chunks,           # è¦å­˜å‚¨çš„æ–‡æ¡£chunksåˆ—è¡¨ï¼ˆå·²å¤„ç†å¥½çš„æ–‡æœ¬ç‰‡æ®µï¼‰</span><br><span class="line">    embedding=embedding,        </span><br><span class="line">    persist_directory=&quot;chromaDB&quot;,  # å‘é‡æ•°æ®åº“çš„æŒä¹…åŒ–å­˜å‚¨ç›®å½•è·¯å¾„</span><br><span class="line">    collection_name=&quot;demo001&quot;   # é›†åˆåç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„æ–‡æ¡£é›†åˆ</span><br><span class="line">)</span><br><span class="line">vectorstore.persist()</span><br></pre></td></tr></table></figure>
<h4 id="æ£€ç´¢">æ£€ç´¢</h4>
<p>è¿™é‡Œé‡‡å–ç›´æ¥æ£€ç´¢è¿›è¡Œæµ‹è¯•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">results = vectorstore.similarity_search(</span><br><span class="line">    &quot;å¼ ä¸‰ä¹çš„åŸºæœ¬ä¿¡æ¯æ˜¯ä»€ä¹ˆ&quot;,</span><br><span class="line">    k=2,</span><br><span class="line">    collection_name=&quot;demo001&quot;  # æŒ‡å®šæ£€ç´¢çš„é›†åˆ</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="é‡æ–°åŠ è½½">é‡æ–°åŠ è½½</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># é‡æ–°åŠ è½½å·²å­˜åœ¨çš„ Chroma æ•°æ®åº“</span><br><span class="line">vectorstore = Chroma(</span><br><span class="line">    persist_directory=&quot;./chroma_db&quot;,</span><br><span class="line">    embedding_function=embedding</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">retriever = vectorstore.as_retriever()</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/vectorstores/chroma/#add-items-to-vector-store">Chroma
| ğŸ¦œï¸ğŸ”— LangChain â€” Chroma | ğŸ¦œï¸ğŸ”— LangChain</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/pgsql%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/pgsql%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/" class="post-title-link" itemprop="url">pgsqlå®ç°æŒä¹…åŒ–</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-06 15:00:36" itemprop="dateModified" datetime="2025-08-06T15:00:36+08:00">2025-08-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/agent%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">agentå®æˆ˜</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€">å‰è¨€</h3>
<p>å¸¸ä½¿ç”¨pgsqlä¸redisé…åˆlanggraphçš„checkpointä¸storeè¿›è¡ŒæŒä¹…åŒ–å‚¨å­˜ï¼Œå®Œæˆé•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†çš„å®ç°</p>
<h3 id="pgsqlå®ç°æŒä¹…åŒ–">pgsqlå®ç°æŒä¹…åŒ–</h3>
<h4 id="ä»€ä¹ˆæ˜¯pgsql">ä»€ä¹ˆæ˜¯pgsql</h4>
<p>PostgreSQLï¼ˆå¸¸ç®€ç§°pgsqlæˆ–Postgresï¼‰æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¼€æºå¯¹è±¡-å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆORDBMSï¼‰ï¼Œä»¥å…¶ç¨³å®šæ€§ã€æ‰©å±•æ€§å’Œç¬¦åˆSQLæ ‡å‡†è‘—ç§°ã€‚</p>
<h4 id="dockeræ‹‰å–">dockeræ‹‰å–</h4>
<p>docker-compose</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  postgres:</span><br><span class="line">    image: postgres:15        # æŒ‡å®šå…·ä½“ç‰ˆæœ¬</span><br><span class="line">    container_name: postgres_db</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_USER: postgres</span><br><span class="line">      POSTGRES_PASSWORD: postgres</span><br><span class="line">      POSTGRES_DB: postgres</span><br><span class="line">      TZ: Asia/Shanghai       # è®¾ç½®æ—¶åŒº</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5432:5432&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - pgdata:/var/lib/postgresql/data</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:             # å¥åº·æ£€æŸ¥</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;pg_isready&quot;, &quot;-U&quot;, &quot;nange&quot;]</span><br><span class="line">      interval: 10s</span><br><span class="line">      timeout: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">    command: [&quot;postgres&quot;, &quot;-c&quot;, &quot;max_connections=200&quot;]  # è‡ªå®šä¹‰é…ç½®</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  pgdata:</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Docker Compose</strong> æ˜¯ä¸€ä¸ª <strong>å®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨
Docker åº”ç”¨</strong> çš„ <strong>å£°æ˜å¼å·¥å…·</strong>ã€‚ å®ƒé€šè¿‡ä¸€ä¸ª
<strong>YAML æ–‡ä»¶ï¼ˆé€šå¸¸å« <code>docker-compose.yml</code>ï¼‰</strong>
æè¿°æ•´ä¸ªåº”ç”¨çš„æœåŠ¡ã€ç½‘ç»œã€å­˜å‚¨ç­‰é…ç½®ï¼Œç„¶åç”¨ä¸€æ¡å‘½ä»¤å³å¯
<strong>å¯åŠ¨/åœæ­¢/ç®¡ç†</strong> æ‰€æœ‰å®¹å™¨ï¼Œæ— éœ€æ‰‹åŠ¨é€ä¸ª
<code>docker run</code>ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ‹‰å–å¹¶è¿è¡Œ</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<h4 id="åœ¨pgsqslå®‰è£…ä¾èµ–">åœ¨pgsqslå®‰è£…ä¾èµ–</h4>
<p>å› ä¸ºLangGraphçš„PostgresStoreéœ€è¦ä½¿ç”¨åˆ°pgvectorï¼Œå› æ­¤éœ€è¦åœ¨å®¹å™¨ä¸­æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼Œç›´æ¥ä½¿ç”¨Docker
Desktopè½¯ä»¶ä¸­è¿›è¡Œæ“ä½œ</p>
<blockquote>
<ul>
<li>ä¸ºä»€ä¹ˆéœ€è¦ <code>pgvector</code>ï¼Ÿ</li>
<li><code>PostgresStore</code> æ”¯æŒå°†
<strong>å‘é‡åµŒå…¥ï¼ˆembeddingï¼‰</strong> å­˜å‚¨åœ¨ PostgreSQL
ä¸­ï¼Œå¹¶åŸºäºå®ƒä»¬è¿›è¡Œ <strong>è¯­ä¹‰æœç´¢</strong>ã€‚</li>
<li>è¯¥åŠŸèƒ½ä¾èµ– <code>pgvector</code> æ‰©å±•æä¾›çš„ <code>vector</code>
ç±»å‹å’Œç´¢å¼•æœºåˆ¶ï¼ˆå¦‚ HNSWï¼‰ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å®‰è£…ä¾èµ–           </span><br><span class="line">apt update    #åˆ·æ–°æœ¬åœ°è½¯ä»¶åŒ…ç´¢å¼•           </span><br><span class="line">apt install -y git build-essential postgresql-server-dev-15                          </span><br></pre></td></tr></table></figure>
<blockquote>
<p>apt install -y git build-essential postgresql-server-dev-15ä¸€æ¬¡æ€§å®‰è£…
3 ç±»ä¾èµ–ã€‚</p>
<ul>
<li><code>git</code> â€”â€” ç”¨æ¥å…‹éš† pgvector æºç ã€‚</li>
<li><code>build-essential</code> â€”â€” Debian/Ubuntu
çš„â€œç¼–è¯‘å·¥å…·é“¾â€å…ƒåŒ…ï¼ŒåŒ…å« gccã€make ç­‰ã€‚</li>
<li><code>postgresql-server-dev-15</code> â€”â€” ä¸å½“å‰ Postgres
<strong>ä¸»ç‰ˆæœ¬ä¸€è‡´</strong> çš„å¼€å‘å¤´æ–‡ä»¶å’Œ <code>pg_config</code>ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ç¼–è¯‘å¹¶å®‰è£… pgvector      </span><br><span class="line">#æŠŠ pgvector çš„ v0.7.0 ç¨³å®šç‰ˆ æºç å…‹éš†åˆ°æœ¬åœ°ç›®å½• ./pgvectorã€‚</span><br><span class="line">git clone --branch v0.7.0 https://github.com/pgvector/pgvector.git                </span><br><span class="line">cd pgvector  </span><br><span class="line">#è°ƒç”¨ Makefile æ ¹æ®å½“å‰æ“ä½œç³»ç»Ÿ + PostgreSQL ç‰ˆæœ¬ç¼–è¯‘å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ.so å…±äº«åº“ï¼‰ã€‚</span><br><span class="line">make          </span><br><span class="line">#æŠŠåˆšåˆšç¼–å¥½çš„ .so æ–‡ä»¶å’Œ .sql/.control æ–‡ä»¶å¤åˆ¶åˆ° PostgreSQL çš„æ‰©å±•ç›®å½•</span><br><span class="line">make install                </span><br><span class="line">éªŒè¯å®‰è£…ï¼Œæ£€æŸ¥æ‰©å±•æ–‡ä»¶æ˜¯å¦å®‰è£…æˆåŠŸ                    </span><br><span class="line">ls -l /usr/share/postgresql/15/extension/vector* </span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/pgvector/pgvector">pgvector/pgvector:
Open-source vector similarity search for Postgres</a></p>
<p>æ¥ä¸‹æ¥ï¼Œè‹¥è¦åœ¨è„šæœ¬ä¸­è¿›è¡Œä½¿ç”¨ï¼Œé¦–å…ˆåœ¨ç³»ç»Ÿç¯å¢ƒä¸­éœ€è¦å®‰è£…PostgreSQL
çš„å¼€å‘åº“ï¼ˆlibpqï¼‰ï¼Œå› ä¸º psycopg éœ€è¦å®ƒæ¥ç¼–è¯‘æˆ–è¿è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install libpq-dev postgresql-server-dev-all</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>psycopgï¼ˆPython æ“ä½œ PostgreSQL çš„åº“ï¼‰</strong> åœ¨
<strong>Linux/macOS</strong> ä¸Šè¿è¡Œæ—¶ï¼Œåº•å±‚ä¾èµ–äº <strong>PostgreSQL çš„
C è¯­è¨€å¼€å‘åº“ libpq</strong>ã€‚ å¦‚æœç³»ç»Ÿé‡Œ <strong>æ²¡æœ‰
libpq</strong>ï¼Œpsycopg ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§é—®é¢˜ï¼š</p>
<ol type="1">
<li><p><strong>ç¼–è¯‘å®‰è£…å¤±è´¥</strong>ï¼ˆæºç /æ—§ç‰ˆæœ¬ï¼‰ å½“
<code>pip install psycopg2</code> éœ€è¦ç°åœºç¼–è¯‘æ—¶ï¼Œä¼šæ‰¾ä¸åˆ°å¤´æ–‡ä»¶
<code>libpq-fe.h</code> æˆ–åŠ¨æ€åº“ <code>libpq.so</code>ï¼Œå¯¼è‡´æŠ¥é”™ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: libpq-fe.h: No such file or directory</span><br></pre></td></tr></table></figure></li>
<li><p><strong>è¿è¡Œæ—¶å´©æºƒ</strong> å³ä½¿é€šè¿‡é¢„ç¼–è¯‘çš„ wheel
åŒ…å®‰è£…æˆåŠŸï¼Œè¿è¡Œæ—¶ä¹Ÿå¯èƒ½æç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImportError: libpq.so.5: cannot open shared object file</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<p>æœ€åï¼Œå†å®‰è£…ç›¸å…³ä¾èµ–åŒ…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install langgraph-checkpoint-postgres                    </span><br><span class="line">pip install psycopg psycopg-pool </span><br></pre></td></tr></table></figure>
<p>psycopgå®˜æ–¹ PostgreSQL é©±åŠ¨ï¼Œåœ¨ <code>psycopg</code>
ä¹‹ä¸Šå†åŒ…ä¸€å±‚â€œ<strong>è¿æ¥æ± </strong>â€ï¼Œè®©å¹¶å‘è®¿é—®æ›´å¿«ã€æ›´ç¨³å®šã€‚</p>
<h4 id="è¿æ¥pgsql">è¿æ¥pgsql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.store.postgres import PostgresStore</span><br><span class="line">from langgraph.checkpoint.postgres import PostgresSaver</span><br><span class="line">from psycopg_pool import ConnectionPool</span><br><span class="line"># 1) è¿æ¥å­—ç¬¦ä¸²ï¼ˆURI è¯­æ³•ï¼‰</span><br><span class="line">DB_URI = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line">#   åè®®://      ç”¨æˆ·   : å¯†ç    @ ä¸»æœº:ç«¯å£ / æ•°æ®åº“å  ? é¢å¤–å‚æ•°</span><br><span class="line"></span><br><span class="line"># 2) è¿æ¥çº§å‚æ•°</span><br><span class="line">connection_kwargs = &#123;</span><br><span class="line">    &quot;autocommit&quot;: True,     # æ¯æ¡ SQL æ‰§è¡Œå®Œç«‹å³æäº¤ï¼Œæ— éœ€æ‰‹åŠ¨ commit</span><br><span class="line">    &quot;prepare_threshold&quot;: 0, # ç¦ç”¨æœåŠ¡å™¨ç«¯ prepared statementï¼Œå¯å‡å°‘ä¸€æ¬¡å¾€è¿”</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 3) åˆ›å»ºæ± </span><br><span class="line">connection_pool = ConnectionPool(</span><br><span class="line">    conninfo=DB_URI,</span><br><span class="line">    max_size=20,            # æœ€å¤š 20 æ¡ç‰©ç†è¿æ¥</span><br><span class="line">    kwargs=connection_kwargs,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 4) æ˜¾å¼æ‰“å¼€æ± ï¼ˆpsycopg 3 çš„ ConnectionPool é»˜è®¤æ‡’å¯åŠ¨ï¼Œè°ƒ open() ä¼šç«‹å³å»º min_size æ¡è¿æ¥ï¼‰</span><br><span class="line">connection_pool.open()</span><br><span class="line">print(&quot;æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ&quot;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ­£å¸¸æƒ…å†µæ¯æ¬¡ SQL éƒ½æ–°å»ºä¸€æ¡ TCP è¿æ¥ã€åš SSL
æ¡æ‰‹ã€éªŒè¯å¯†ç ã€åˆ†é…å†…å­˜ï¼Œå¦‚æœä¸å¤ç”¨è¿æ¥ï¼Œè¿™äº›åŠ¨ä½œå°±è¦
<strong>æ¯æ¬¡éƒ½é‡æ–°æ¥ä¸€é</strong>ï¼Œ<strong>æˆæœ¬éå¸¸é«˜</strong>ã€‚</p>
<p>è¿æ¥æ± ï¼ˆConnection Poolï¼‰æ˜¯ä¸€ç§
<strong>æ•°æ®åº“è®¿é—®å±‚èµ„æºç®¡ç†ç»„ä»¶</strong>ï¼Œå…¶æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨
<strong>é«˜å¹¶å‘ã€çŸ­äº‹åŠ¡</strong> åœºæ™¯ä¸‹ï¼Œé€šè¿‡
<strong>å¤ç”¨å·²å»ºç«‹çš„æ•°æ®åº“ç‰©ç†è¿æ¥</strong>
æ¥é™ä½ç³»ç»Ÿæ•´ä½“å»¶è¿Ÿã€å‡å°‘èµ„æºæ¶ˆè€—ï¼Œå¹¶é˜²æ­¢æ•°æ®åº“å› ç¬æ—¶è¿æ¥é£æš´è€Œå´©æºƒã€‚</p>
</blockquote>
<h4 id="åˆå§‹åŒ–pgsql">åˆå§‹åŒ–pgsql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># åˆå§‹åŒ–PostgresStore</span><br><span class="line">in_postgres_store = PostgresStore(</span><br><span class="line">    pool,</span><br><span class="line">    index=&#123;</span><br><span class="line">        &quot;dims&quot;: 1536,</span><br><span class="line">        &quot;embed&quot;: embedding</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">in_postgres_store.setup()</span><br><span class="line"></span><br><span class="line">#åˆå§‹åŒ–checkpoint</span><br><span class="line"># ä½¿ç”¨ä¼ å…¥çš„è¿æ¥æ± åˆ›å»º PostgresSaver</span><br><span class="line">checkpointer = PostgresSaver(pool)</span><br><span class="line">checkpointer.setup()</span><br><span class="line"></span><br><span class="line">#æœ€åç¼–è¯‘æ—¶æ·»åŠ </span><br><span class="line">graph_builder.compile(checkpointer=checkpointer, store=in_postgres_store)</span><br></pre></td></tr></table></figure>
<p><code>in_postgres_store.setup()</code> çš„è§’è‰²ä¸€å¥è¯å°±èƒ½è¯´æ¸…ï¼š</p>
<blockquote>
<p><strong>æŠŠæ•°æ®åº“é‡Œæ‰€æœ‰ä¸ºäº†è®©å‘é‡å­˜å‚¨æ­£å¸¸å·¥ä½œçš„â€œä¸€æ¬¡æ€§åŸºå»ºâ€å…¨éƒ¨å»ºå¥½</strong>â€”â€”åªå»ºä¸€æ¬¡ï¼Œåé¢å†è·‘å°±ä¸ä¼šé‡å¤æ‰§è¡Œã€‚</p>
</blockquote>
<p>å…·ä½“è€Œè¨€ï¼Œå®ƒé€šå¸¸å¹²ä¸‹é¢ä¸‰ä»¶äº‹ï¼š1.<strong>å»ºè¡¨ /
å»ºæ‰©å±•</strong>ï¼›2.<strong>å»ºå‘é‡ç´¢å¼•</strong>ï¼›3.<strong>å…ƒæ•°æ®åˆå§‹åŒ–</strong></p>
<h4 id="fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†">fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># å®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°lifespanï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªFastAPIåº”ç”¨å®ä¾‹appä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªå‡½æ•°å°†ç®¡ç†åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¯åŠ¨å’Œå…³é—­æ—¶çš„æ“ä½œ</span><br><span class="line"># å‡½æ•°åœ¨åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¦‚åŠ è½½ä¸Šä¸‹æ–‡æ•°æ®ã€ä»¥åŠåˆå§‹åŒ–é—®é¢˜ç”Ÿæˆå™¨</span><br><span class="line"># å‡½æ•°åœ¨åº”ç”¨å…³é—­æ—¶æ‰§è¡Œä¸€äº›æ¸…ç†æ“ä½œ</span><br><span class="line"># @asynccontextmanager è£…é¥°å™¨ç”¨äºåˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒå…è®¸ä½ åœ¨ yield ä¹‹å‰å’Œä¹‹åæ‰§è¡Œç‰¹å®šçš„ä»£ç å—ï¼Œåˆ†åˆ«è¡¨ç¤ºå¯åŠ¨å’Œå…³é—­æ—¶çš„æ“ä½œ</span><br><span class="line">@asynccontextmanager</span><br><span class="line">async def lifespan(app: FastAPI):</span><br><span class="line">    # å¯åŠ¨æ—¶æ‰§è¡Œ</span><br><span class="line">    # ç”³æ˜å¼•ç”¨å…¨å±€å˜é‡ï¼Œåœ¨å‡½æ•°ä¸­è¢«åˆå§‹åŒ–ï¼Œå¹¶åœ¨æ•´ä¸ªåº”ç”¨ä¸­ä½¿ç”¨</span><br><span class="line">    global graph, connection_pool</span><br><span class="line">    # å¯åŠ¨æ—¶æ‰§è¡Œ</span><br><span class="line">    try:</span><br><span class="line">        logger.info(&quot;æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹ã€å®šä¹‰ Graph...&quot;)</span><br><span class="line">        # åˆå§‹åŒ– LLM</span><br><span class="line">        llm, embedding = get_llm(llm_type)</span><br><span class="line">        # åˆ›å»ºæ•°æ®åº“è¿æ¥æ± </span><br><span class="line">        DB_URI = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line">        connection_kwargs = &#123;</span><br><span class="line">            &quot;autocommit&quot;: True,</span><br><span class="line">            &quot;prepare_threshold&quot;: 0,</span><br><span class="line">        &#125;</span><br><span class="line">        connection_pool = ConnectionPool(</span><br><span class="line">            conninfo=DB_URI,</span><br><span class="line">            max_size=20,</span><br><span class="line">            kwargs=connection_kwargs,</span><br><span class="line">        )</span><br><span class="line">        connection_pool.open()  # æ˜¾å¼æ‰“å¼€è¿æ¥æ± </span><br><span class="line">        logger.info(&quot;æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ&quot;)</span><br><span class="line">        # çŸ­æœŸè®°å¿† åˆå§‹åŒ–checkpointer</span><br><span class="line">        checkpointer = PostgresSaver(connection_pool)</span><br><span class="line">        checkpointer.setup()</span><br><span class="line">        # é•¿æœŸè®°å¿† åˆå§‹åŒ–PostgresStore</span><br><span class="line">        in_postgres_store = PostgresStore(</span><br><span class="line">            connection_pool,</span><br><span class="line">            index=&#123;</span><br><span class="line">                &quot;dims&quot;: 1536,</span><br><span class="line">                &quot;embed&quot;: embedding</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        in_postgres_store.setup()</span><br><span class="line">        # å®šä¹‰ Graph</span><br><span class="line">        graph = create_graph(llm, checkpointer, in_postgres_store )</span><br><span class="line">        # ä¿å­˜ Graph å¯è§†åŒ–å›¾</span><br><span class="line">        save_graph_visualization(graph)</span><br><span class="line">        logger.info(&quot;åˆå§‹åŒ–å®Œæˆ&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        logger.error(f&quot;åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™: &#123;str(e)&#125;&quot;)</span><br><span class="line">        raise</span><br><span class="line"></span><br><span class="line">    yield  # åº”ç”¨è¿è¡ŒæœŸé—´</span><br><span class="line"></span><br><span class="line">    # å…³é—­æ—¶æ‰§è¡Œ</span><br><span class="line">    logger.info(&quot;æ­£åœ¨å…³é—­...&quot;)</span><br><span class="line">    if connection_pool:</span><br><span class="line">        connection_pool.close()  # å…³é—­è¿æ¥æ± </span><br><span class="line">        logger.info(&quot;æ•°æ®åº“è¿æ¥æ± å·²å…³é—­&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># lifespanå‚æ•°ç”¨äºåœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹å’Œç»“æŸæ—¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æˆ–æ¸…ç†å·¥ä½œ</span><br><span class="line">app = FastAPI(lifespan=lifespan)</span><br></pre></td></tr></table></figure>
<h3 id="pgsqlçš„å­˜å‚¨ç»“æ„">pgsqlçš„å­˜å‚¨ç»“æ„</h3>
<h4 id="ä¸€checkpoints-ç³»åˆ—">ä¸€ã€Checkpoints ç³»åˆ—</h4>
<blockquote>
<p>ä½œç”¨ï¼šè®© <strong>LangGraph Runtime</strong> èƒ½åœ¨
<strong>åˆ†å¸ƒå¼/é•¿æµç¨‹</strong> åœºæ™¯ä¸‹
<strong>æ–­ç‚¹ç»­è·‘ã€é‡æ”¾ã€å¹¶å‘æ§åˆ¶</strong>ã€‚</p>
</blockquote>
<table>
<colgroup>
<col style="width: 15%">
<col style="width: 31%">
<col style="width: 37%">
<col style="width: 16%">
</colgroup>
<thead>
<tr>
<th>è¡¨å</th>
<th>å­˜ä»€ä¹ˆ</th>
<th>å…¸å‹å­—æ®µï¼ˆç¤ºæ„ï¼‰</th>
<th>ä½•æ—¶å†™å…¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>checkpoints</strong></td>
<td>æ¯ä¸ªã€Œå›¾å®ä¾‹ã€çš„ <strong>æœ€æ–°å¿«ç…§</strong>ï¼ˆstate çš„å®Œæ•´
JSONBï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_ns</code>,
<code>checkpoint_id</code>, <code>parent_checkpoint_id</code>,
<code>state</code>, <code>created_at</code></td>
<td>æ¯æ¬¡èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸåè¦†ç›–æ›´æ–°</td>
</tr>
<tr>
<td><strong>checkpoint_blobs</strong></td>
<td>checkpoints é‡Œ <strong>å¤§å­—æ®µçš„æ‹†åˆ†</strong>ï¼ˆé¿å…è¡Œè¿‡å¤§ï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_ns</code>,
<code>channel</code>, <code>type</code>, <code>blob</code></td>
<td>å½“ state è¿‡å¤§ï¼Œè‡ªåŠ¨æ‹†åˆ†</td>
</tr>
<tr>
<td><strong>checkpoint_migrations</strong></td>
<td>è®°å½• <strong>schema ç‰ˆæœ¬/è¿ç§»è„šæœ¬</strong></td>
<td><code>version</code>, <code>name</code>,
<code>applied_at</code></td>
<td>åªåœ¨ <code>setup()</code> æ—¶å†™ä¸€æ¬¡</td>
</tr>
<tr>
<td><strong>checkpoint_writes</strong></td>
<td><strong>å†™æ”¾å¤§æ—¥å¿—</strong>ï¼ˆæ¯ä¸ªèŠ‚ç‚¹å†™ state çš„å¢é‡ diffï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_id</code>,
<code>task_id</code>, <code>idx</code>, <code>channel</code>,
<code>type</code>, <code>value</code></td>
<td>æ¯æ¬¡èŠ‚ç‚¹å®Œæˆæ—¶è¿½åŠ </td>
</tr>
</tbody>
</table>
<blockquote>
<p>å…³ç³»ï¼š<br>
<code>checkpoints</code> = æœ€æ–°å®Œæ•´å¿«ç…§<br>
<code>checkpoint_writes</code> = æ‰€æœ‰å¢é‡å†å²ï¼ˆç”¨äºé‡æ”¾/å®¡è®¡ï¼‰<br>
<code>checkpoint_blobs</code> = checkpoints é‡Œè¶…å¤§å‹ value çš„åˆ‡ç‰‡</p>
</blockquote>
<h4 id="äºŒstore-ç³»åˆ—">äºŒã€Store ç³»åˆ—</h4>
<blockquote>
<p>ä½œç”¨ï¼šç»™ <strong>ä¸šåŠ¡ä»£ç ï¼ˆå¼€å‘è€…ï¼‰</strong> æä¾› <strong>æŒä¹…åŒ– KV /
å‘é‡å­˜å‚¨</strong>ï¼Œä¸å›¾è¿è¡ŒçŠ¶æ€æ— å…³ã€‚</p>
</blockquote>
<table>
<colgroup>
<col style="width: 12%">
<col style="width: 27%">
<col style="width: 34%">
<col style="width: 25%">
</colgroup>
<thead>
<tr>
<th>è¡¨å</th>
<th>å­˜ä»€ä¹ˆ</th>
<th>å…¸å‹å­—æ®µï¼ˆç¤ºæ„ï¼‰</th>
<th>ä½•æ—¶å†™å…¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>store</strong></td>
<td><strong>ä»»æ„ KV æ–‡æ¡£</strong>ï¼ˆLangChain Document â†’ JSONBï¼‰</td>
<td><code>uuid</code>, <code>namespace</code>, <code>key</code>,
<code>value</code>, <code>created_at</code>,
<code>updated_at</code></td>
<td>ä½ è°ƒç”¨ <code>store.amput</code> / <code>amset</code> ç­‰ API</td>
</tr>
<tr>
<td><strong>store_migrations</strong></td>
<td>åŒ checkpoint_migrationsï¼Œè®°å½• store schema ç‰ˆæœ¬</td>
<td><code>version</code>, <code>name</code>,
<code>applied_at</code></td>
<td>åªåœ¨ç¬¬ä¸€æ¬¡ <code>setup()</code></td>
</tr>
<tr>
<td><strong>store_vectors</strong></td>
<td><strong>å‘é‡ç´¢å¼•è¡¨</strong>ï¼ˆembedding â†’ vector ç±»å‹ï¼‰</td>
<td><code>uuid</code>, <code>collection_id</code>,
<code>embedding</code>, <code>document</code>,
<code>metadata</code></td>
<td>ä½ è°ƒç”¨ <code>add_documents(..., embeddings=...)</code></td>
</tr>
<tr>
<td><strong>vector_migrations</strong></td>
<td>è®°å½• pgvector æ‰©å±•åŠç´¢å¼•è¿ç§»ç‰ˆæœ¬</td>
<td><code>version</code>, <code>applied_at</code></td>
<td><code>setup()</code> æ—¶è‹¥ç¬¬ä¸€æ¬¡è£… pgvector</td>
</tr>
</tbody>
</table>
<h4 id="ä¸‰è°ƒç”¨é“¾è„‘å›¾">ä¸‰ã€è°ƒç”¨é“¾è„‘å›¾</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ LangGraph    â”‚ è¿è¡Œå›¾å®ä¾‹</span><br><span class="line">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">     â”‚1. å†™ checkpoints</span><br><span class="line">     â”‚2. å†™ checkpoint_writes</span><br><span class="line">     â”‚3. æ‹†å¤§å­—æ®µåˆ° checkpoint_blobs</span><br><span class="line">     â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ä¸šåŠ¡ä»£ç      â”‚ è¯»å†™ KV/å‘é‡</span><br><span class="line">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">     â”‚1. å†™ store</span><br><span class="line">     â”‚2. å†™ store_vectors</span><br><span class="line">     â–¼</span><br><span class="line"> PostgreSQL (pgsql)</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨linuxå®‰è£…postgresql">åœ¨linuxå®‰è£…postgresql</h3>
<h4 id="æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬">æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹å‘è¡Œç‰ˆåç§°å’Œç‰ˆæœ¬</span><br><span class="line">cat /etc/os-release</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PRETTY_NAME=&quot;Ubuntu 24.04.2 LTS&quot;</span><br><span class="line">NAME=&quot;Ubuntu&quot;</span><br><span class="line">VERSION_ID=&quot;24.04&quot;</span><br><span class="line">VERSION=&quot;24.04.2 LTS (Noble Numbat)&quot;</span><br><span class="line">VERSION_CODENAME=noble</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">HOME_URL=&quot;https://www.ubuntu.com/&quot;</span><br><span class="line">SUPPORT_URL=&quot;https://help.ubuntu.com/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;</span><br><span class="line">PRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span><br><span class="line">UBUNTU_CODENAME=noble</span><br><span class="line">LOGO=ubuntu-logo</span><br></pre></td></tr></table></figure>
<h4 id="å®‰è£…postgresql">å®‰è£…postgresql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•</span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"># å®‰è£… PostgreSQL å’Œå¸¸ç”¨æ‰©å±•</span><br><span class="line">sudo apt install -y postgresql postgresql-contrib</span><br><span class="line"></span><br><span class="line"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span><br><span class="line">#Linux å®¹å™¨/å­ç³»ç»Ÿï¼ˆ Dockerã€WSL æˆ– LXCï¼‰æ²¡æœ‰ä½¿ç”¨ systemd ï¼Œå› æ­¤ systemctl æ— æ³•å·¥ä½œ</span><br><span class="line">sudo systemctl status postgresql</span><br><span class="line"></span><br><span class="line">#ç¡®è®¤ PostgreSQL å·²å®‰è£…</span><br><span class="line">which psql            # åº”è¯¥è¾“å‡º /usr/bin/psql</span><br><span class="line">pg_ctl --version      # æ˜¾ç¤ºç‰ˆæœ¬å·å³å·²å®‰è£…</span><br></pre></td></tr></table></figure>
<ul>
<li><code>postgresql</code> æ˜¯ä¸»ç¨‹åº</li>
<li><code>postgresql-contrib</code> æä¾›é¢å¤–æ‰©å±•ï¼ˆå¦‚
<code>uuid-ossp</code>ã€<code>pgcrypto</code> ç­‰ï¼‰</li>
</ul>
<blockquote>
<p>systemctlä¸€èˆ¬ç”¨äºæœåŠ¡å™¨ä¸Šï¼Œå®Œæ•´çš„linuxç³»ç»Ÿä¸Š</p>
<p>Linux å®¹å™¨/å­ç³»ç»Ÿï¼ˆ Dockerã€WSL æˆ– LXCï¼‰ä½¿ç”¨ service</p>
</blockquote>
<h4 id="pgsqlå¸¸ç”¨æŒ‡ä»¤">pgsqlå¸¸ç”¨æŒ‡ä»¤</h4>
<p>å¯åŠ¨pgsqlæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql start</span><br></pre></td></tr></table></figure>
<p>åœæ­¢pgsqlæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql stop</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹çŠ¶æ€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql status</span><br></pre></td></tr></table></figure>
<p>è¿æ¥PostgreSQL é»˜è®¤çš„ç³»ç»Ÿç”¨æˆ·ï¼Œå¯ä»¥æ‰§è¡Œpgsqlçš„ç›¸å…³æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>psql</strong>ä¸ºPostgreSQL
çš„ç»ˆç«¯å®¢æˆ·ç«¯ï¼Œé»˜è®¤ä¼šè¿æ¥ä¸å½“å‰æ“ä½œç³»ç»Ÿç”¨æˆ·ååŒåçš„æ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“ã€‚</p>
<p><strong>postgres</strong>ä¸ºPostgreSQL
è‡ªå¸¦çš„ç³»ç»Ÿæ•°æ®åº“ï¼Œ<code>postgres</code> é»˜è®¤
<strong>æ•°æ®åº“å¯†ç ä¸ºç©º</strong>ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œè®¾ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- è®¾ç½®postgresç”¨æˆ·å¯†ç </span><br><span class="line">ALTER USER postgres PASSWORD &#x27;postgres&#x27;;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>æ•°æ®åº“å…³äºuserçš„ä½œç”¨</p>
<p>æ•°æ®åº“é‡Œçš„â€œç”¨æˆ·â€æ˜¯ PostgreSQL
<strong>å†…éƒ¨ç”¨æ¥åšâ€œè®¿é—®æ§åˆ¶â€çš„ä¸€æŠŠé’¥åŒ™</strong>ã€‚ä¸€å¥è¯ï¼š<strong>â€œè°èƒ½è¿å“ªä¸ªåº“ã€è°èƒ½è¯»å“ªå¼ è¡¨ã€è°èƒ½æ”¹å“ªäº›è¡Œâ€â€”â€”å…¨é è¿™äº›æ•°æ®åº“ç”¨æˆ·ï¼ˆè§’è‰²ï¼‰æ¥åˆ¤å®šã€‚</strong></p>
<table>
<colgroup>
<col style="width: 32%">
<col style="width: 67%">
</colgroup>
<thead>
<tr>
<th>ä½œç”¨</th>
<th>ä¸¾ä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. è®¤è¯</strong>ï¼ˆAuthenticationï¼‰</td>
<td>å‘Šè¯‰ PostgreSQL â€œæˆ‘è¿åº“æ—¶æä¾›çš„ç”¨æˆ·å+å¯†ç æ˜¯å¦åˆæ³•â€ã€‚</td>
</tr>
<tr>
<td><strong>2. æˆæƒ</strong>ï¼ˆAuthorizationï¼‰</td>
<td>å†³å®š
â€œè¿™ä¸ªç”¨æˆ·è¿è¿›æ¥åï¼Œå¯¹å“ªäº›åº“ã€å“ªäº›è¡¨ã€å“ªäº›è¡Œæœ‰ä½•ç§æƒé™ï¼ˆSELECT/INSERT/UPDATE/DELETEâ€¦ï¼‰â€ã€‚</td>
</tr>
<tr>
<td><strong>3. èµ„æºéš”ç¦»</strong>ï¼ˆIsolationï¼‰</td>
<td>ä¸åŒä¸šåŠ¡/å›¢é˜Ÿç”¨ä¸åŒç”¨æˆ·ï¼Œæ–¹ä¾¿å®¡è®¡ã€é™æµã€å›æ”¶æƒé™ï¼Œäº’ä¸å¹²æ‰°ã€‚</td>
</tr>
</tbody>
</table>
<p>pgsqlé€šç”¨ URL æ¨¡æ¿</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgresql://&lt;ç”¨æˆ·å&gt;:&lt;å¯†ç &gt;@127.0.0.1:5432/&lt;æ•°æ®åº“å&gt;[?å‚æ•°=å€¼&amp;...]</span><br></pre></td></tr></table></figure>
<h4 id="è¿æ¥pgsql-1">è¿æ¥pgsql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># åŸºäºæ•°æ®åº“æŒä¹…åŒ–å­˜å‚¨çš„short-term</span><br><span class="line">db_uri = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line"></span><br><span class="line"># short-termçŸ­æœŸè®°å¿† å®ä¾‹åŒ–PostgresSaverå¯¹è±¡ å¹¶åˆå§‹åŒ–checkpointer</span><br><span class="line"># long-termé•¿æœŸè®°å¿† å®ä¾‹åŒ–PostgresStoreå¯¹è±¡ å¹¶åˆå§‹åŒ–store</span><br><span class="line">async with (</span><br><span class="line">    AsyncPostgresSaver.from_conn_string(db_uri) as checkpointer,</span><br><span class="line">    AsyncPostgresStore.from_conn_string(db_uri) as store</span><br><span class="line"></span><br><span class="line">):</span><br><span class="line">    await store.setup()</span><br><span class="line">    await checkpointer.setup()</span><br></pre></td></tr></table></figure>
<h3 id="æ›´æ¢apté•œåƒæº">æ›´æ¢apté•œåƒæº</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/apt/sources.list &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian-security bookworm-security main contrib non-free</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">apt update</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7470702616906645540">postgresqlå‘é‡æ‰©å±•pgvectorçš„å®‰è£…ä¸å…¥é—¨æœ¬æ–‡ç®€ç­”çš„ä»‹ç»äº†
rag çš„æ¶æ„ï¼Œå¼•ç”³å‡ºå‘é‡æ•°æ®åº“çš„ä½œç”¨ï¼Œä»‹ç»äº† - æ˜é‡‘</a></p>
<p>langchainæ”¯æŒå‘é‡å­˜å‚¨<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/vectorstores/">å‘é‡å­˜å‚¨
| ğŸ¦œï¸ğŸ”— LangChain â€” Vector stores | ğŸ¦œï¸ğŸ”— LangChain</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/Plan-and-Execute%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/Plan-and-Execute%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Plan-and-Executeæ¨¡å¼</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-27 10:01:58" itemprop="dateModified" datetime="2025-08-27T10:01:58+08:00">2025-08-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/agent%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">agentå®æˆ˜</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä»€ä¹ˆæ˜¯plan-and-executeæ¨¡å¼">ä»€ä¹ˆæ˜¯Plan-and-Executeæ¨¡å¼</h3>
<p>Plan-and-Executeæ¶æ„æµç¨‹ï¼šå…ˆæŒ‡å®šè®¡åˆ’ï¼Œåäº¤ç»™æ‰§è¡Œagentï¼Œæ‰§è¡Œåäº¤ç»™replanèŠ‚ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°è®¡åˆ’ï¼Œè‹¥è¦æ›´æ–°è®¡åˆ’è¿”å›è¿”å›æ›´æ–°åçš„æœºä¼šï¼Œå¦åˆ™è¿”å›responseï¼Œç„¶åè·¯ç”±åˆ¤æ–­æ˜¯æ‰§è¡Œagentè¿˜æ˜¯response</p>
<p>ä¸ReActæ¨¡å¼ä¸åŒçš„æ˜¯ï¼ŒReActåªåšä¸€æ¬¡è§„åˆ’ï¼Œè€ŒPlan-and-Executeæ¨¡å¼æ ¸å¿ƒæ€æƒ³æ˜¯é¦–å…ˆåˆ¶å®šä¸€ä¸ªå¤šæ­¥éª¤è®¡åˆ’ï¼Œç„¶åé€é¡¹æ‰§è¡Œè¯¥è®¡åˆ’ã€‚å®Œæˆç‰¹å®šä»»åŠ¡åï¼Œå¯ä»¥é‡æ–°å®¡è§†è®¡åˆ’å¹¶è¿›è¡Œé€‚å½“ä¿®æ”¹ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œç”¨æˆ·åœ¨é—®ä¸€ä¸ªé—®é¢˜åï¼Œagentäº§ç”Ÿä¸€ä»½ä»»åŠ¡æ¸…å•ï¼Œé€‰å–ç¬¬ä¸€ä»½ä»»åŠ¡å¼€å§‹æ‰§è¡Œï¼Œæ‰§è¡Œåçš„ç»“æœç»“åˆä»»åŠ¡æ¸…å•ï¼Œæ‰§è¡Œreplanï¼Œç»“åˆæ–°çš„ä¿¡æ¯ï¼Œæ›´æ”¹ä»»åŠ¡æ¸…å•çš„å†…å®¹ï¼Œè®©åç»­å¤§æ¨¡å‹æ›´å¥½åœ°æ‰§è¡Œï¼Œå¹¶å»é™¤å·²ç»å®Œæˆçš„ä»»åŠ¡</p>
<p>å®é™…ç”Ÿäº§ä¸­ï¼Œåº”è¯¥åœ¨plannerä¹‹å‰å†è¿›è¡Œä¸€æ¬¡åˆ¤æ–­ï¼Œå¦‚æœé—®é¢˜è¿‡äºç®€å•ï¼Œä¸éœ€è¦è¿›è¡ŒPlan-and-Executeæ¨¡å¼</p>
<h3 id="å®æˆ˜">å®æˆ˜</h3>
<h4 id="å®‰è£…åŒ…">å®‰è£…åŒ…</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --quiet -U langgraph langchain-community langchain-openai tavily-python</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰ç½‘ç»œæœç´¢å·¥å…·ä¸æ‰§è¡Œagent">å®šä¹‰ç½‘ç»œæœç´¢å·¥å…·ä¸æ‰§è¡Œagent</h4>
<p>åœ¨äº§ç”Ÿplanåï¼Œè¦æœ‰ä¸€ä¸ªagentå¯¹ä»»åŠ¡æ¸…å•è¿›è¡Œæ‰§è¡Œï¼Œè¿™é‡Œä»¥ä¸€ä¸ªReActçš„ç½‘ç»œæœç´¢agentä¸ºä¾‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#å®šä¹‰å·¥å…·</span><br><span class="line">from langchain_tavily import TavilySearch</span><br><span class="line">tools = [TavilySearch(max_results=3)]</span><br><span class="line"></span><br><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line"></span><br><span class="line">from langgraph.prebuilt import create_react_agent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    model=&quot;qwen3-235b-a22b-thinking-2507&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;,</span><br><span class="line">    base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><br><span class="line">)</span><br><span class="line">prompt = &quot;You are a helpful assistant.&quot;</span><br><span class="line">agent_executor = create_react_agent(llm, tools, prompt=prompt)</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•åŠŸèƒ½</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent_executor.invoke(&#123;&quot;messages&quot;: [(&quot;user&quot;, &quot;ä»Šå¤©æ˜¯å‡ æœˆå‡ æ—¥&quot;)]&#125;)</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰æ‰§è¡ŒèŠ‚ç‚¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from typing import Literal</span><br><span class="line">from langgraph.graph import END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def execute_step(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;æ‰§è¡Œè®¡åˆ’ä¸­çš„æ­¥éª¤&quot;&quot;&quot;</span><br><span class="line">    plan = state[&quot;plan&quot;]</span><br><span class="line">    # å°†è®¡åˆ’æ ¼å¼åŒ–ä¸ºå¸¦ç¼–å·çš„å­—ç¬¦ä¸²</span><br><span class="line">    plan_str = &quot;\n&quot;.join(f&quot;&#123;i + 1&#125;. &#123;step&#125;&quot; for i, step in enumerate(plan))</span><br><span class="line">    task = plan[0]  # è·å–ç¬¬ä¸€ä¸ªå¾…æ‰§è¡Œçš„ä»»åŠ¡</span><br><span class="line">    task_formatted = f&quot;&quot;&quot;å¯¹äºä»¥ä¸‹è®¡åˆ’:</span><br><span class="line">&#123;plan_str&#125;\n\nä½ è¢«åˆ†é…æ‰§è¡Œç¬¬ &#123;1&#125; æ­¥, &#123;task&#125;ã€‚&quot;&quot;&quot;</span><br><span class="line">    # è°ƒç”¨ä»£ç†æ‰§è¡Œå™¨æ¥æ‰§è¡Œä»»åŠ¡</span><br><span class="line">    agent_response = await agent_executor.ainvoke(</span><br><span class="line">        &#123;&quot;messages&quot;: [(&quot;user&quot;, task_formatted)]&#125;</span><br><span class="line">    )</span><br><span class="line">    # è¿”å›æ‰§è¡Œç»“æœï¼Œæ·»åŠ åˆ°å†å²æ­¥éª¤ä¸­</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;past_steps&quot;: [(task, agent_response[&quot;messages&quot;][-1].content)],</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>create_react_agent æ˜¯ LangGraph æä¾›çš„ä¸€ä¸ªé¢„æ„å»ºå‡½æ•°ï¼Œä½äº
langgraph.prebuilt æ¨¡å—ä¸­ï¼Œç”¨äºå¿«é€Ÿåˆ›å»ºä¸€ä¸ªåŸºäº ReActï¼ˆReasoning +
Actingï¼‰æ¶æ„çš„æ™ºèƒ½ä»£ç†ã€‚</p>
</blockquote>
<blockquote>
<p>langgraphé¢„è®¾çš„å…¶ä»–å¸¸ç”¨ç»„ä»¶å¦‚ä¸‹</p>
<p><strong>ToolNode</strong></p>
<p>åŠŸèƒ½ï¼šæŠŠ LangChain å·¥å…·ï¼ˆBaseToolï¼‰å°è£…æˆä¸€ä¸ªå›¾èŠ‚ç‚¹ï¼Œè´Ÿè´£ï¼š</p>
<ul>
<li><p>æ¥æ”¶ LLM ç”Ÿæˆçš„å·¥å…·è°ƒç”¨è¯·æ±‚</p></li>
<li><p>çœŸæ­£æ‰§è¡Œå·¥å…·</p></li>
<li><p>æŠŠç»“æœè¿”å›ç»™å›¾</p></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.prebuilt import ToolNode</span><br><span class="line"></span><br><span class="line">tool_node = ToolNode(tools=[search, calculator])</span><br></pre></td></tr></table></figure>
<p><strong>tools_condition</strong></p>
<p>åŠŸèƒ½ï¼šåˆ¤æ–­ LLM æ˜¯å¦è¦ç»§ç»­è°ƒç”¨å·¥å…·çš„â€œè·¯ç”±å‡½æ•°â€ã€‚</p>
<p>åœ¨ ReAct å›¾é‡Œé€šå¸¸æ”¾åœ¨èŠ‚ç‚¹ä¹‹é—´çš„ æ¡ä»¶è¾¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.prebuilt import tools_condition</span><br><span class="line"></span><br><span class="line">graph.add_conditional_edges(&quot;agent&quot;, tools_condition, &#123;</span><br><span class="line"></span><br><span class="line">  &quot;tools&quot;: &quot;tool_node&quot;,    # éœ€è¦å·¥å…· â†’ å» ToolNode</span><br><span class="line"></span><br><span class="line">  &quot;**__end__**&quot;: END       # ä¸éœ€è¦ â†’ ç»“æŸ</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="å®šä¹‰çŠ¶æ€">å®šä¹‰çŠ¶æ€</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import operator</span><br><span class="line">from typing import Annotated, List, Tuple</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class PlanExecute(TypedDict):</span><br><span class="line">    input: str</span><br><span class="line">    plan: List[str]</span><br><span class="line">    past_steps: Annotated[List[Tuple], operator.add]</span><br><span class="line">    response: str</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from pydantic import BaseModel, Field</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Plan(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;æœªæ¥è¦éµå¾ªçš„è®¡åˆ’&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    steps: List[str] = Field(</span><br><span class="line">        description=&quot;éœ€è¦éµå¾ªçš„ä¸åŒæ­¥éª¤ï¼Œåº”è¯¥æŒ‰æ’åºé¡ºåºæ’åˆ—&quot;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰æ¨¡å‹">å®šä¹‰æ¨¡å‹</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from langchain_community.chat_models import ChatTongyi</span><br><span class="line">model=ChatTongyi(</span><br><span class="line"> model=&quot;qwen-plus-2025-07-14&quot;,</span><br><span class="line"> api_key=&quot;sk-&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰åˆå§‹è®¡åˆ’èŠ‚ç‚¹">å®šä¹‰åˆå§‹è®¡åˆ’èŠ‚ç‚¹</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.prompts import ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">planner_prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (</span><br><span class="line">            &quot;system&quot;,</span><br><span class="line">            &quot;&quot;&quot;å¯¹äºç»™å®šçš„ç›®æ ‡ï¼Œåˆ¶å®šä¸€ä¸ªç®€å•çš„é€æ­¥è®¡åˆ’ã€‚\</span><br><span class="line">è¿™ä¸ªè®¡åˆ’åº”è¯¥åŒ…å«ç‹¬ç«‹çš„ä»»åŠ¡ï¼Œå¦‚æœæ­£ç¡®æ‰§è¡Œè¿™äº›ä»»åŠ¡å°†å¾—åˆ°æ­£ç¡®çš„ç­”æ¡ˆã€‚ä¸è¦æ·»åŠ ä»»ä½•å¤šä½™çš„æ­¥éª¤ã€‚\</span><br><span class="line">æœ€åä¸€æ­¥çš„ç»“æœåº”è¯¥æ˜¯æœ€ç»ˆç­”æ¡ˆã€‚ç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½åŒ…å«æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯â€”â€”ä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤ã€‚&quot;&quot;&quot;,</span><br><span class="line">        ),</span><br><span class="line">        (&quot;placeholder&quot;, &quot;&#123;messages&#125;&quot;),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">planner = planner_prompt | model.with_structured_output(Plan)</span><br><span class="line"></span><br><span class="line">async def plan_step(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;åˆ¶å®šåˆå§‹è®¡åˆ’æ­¥éª¤&quot;&quot;&quot;</span><br><span class="line">    # ä½¿ç”¨è§„åˆ’å™¨ä¸ºç”¨æˆ·è¾“å…¥åˆ¶å®šè®¡åˆ’</span><br><span class="line">    plan = await planner.ainvoke(&#123;&quot;messages&quot;: [(&quot;user&quot;, state[&quot;input&quot;])]&#125;)</span><br><span class="line">    </span><br><span class="line">    return &#123;&quot;plan&quot;: plan.steps&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰å†è®¡åˆ’èŠ‚ç‚¹">å®šä¹‰å†è®¡åˆ’èŠ‚ç‚¹</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">from typing import Union</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Response(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å¯¹ç”¨æˆ·çš„å“åº”&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    response: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Act(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;è¦æ‰§è¡Œçš„åŠ¨ä½œ&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    action: Union[Response, Plan] = Field(</span><br><span class="line">        description=&quot;è¦æ‰§è¡Œçš„åŠ¨ä½œã€‚å¦‚æœä½ æƒ³å“åº”ç”¨æˆ·ï¼Œä½¿ç”¨ Responseã€‚&quot;</span><br><span class="line">        &quot;å¦‚æœä½ éœ€è¦è¿›ä¸€æ­¥ä½¿ç”¨å·¥å…·æ¥è·å–ç­”æ¡ˆï¼Œä½¿ç”¨ Planã€‚&quot;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">replanner_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    &quot;&quot;&quot;å¯¹äºç»™å®šçš„ç›®æ ‡ï¼Œåˆ¶å®šä¸€ä¸ªç®€å•çš„é€æ­¥è®¡åˆ’ã€‚\</span><br><span class="line">è¿™ä¸ª    è®¡åˆ’åº”è¯¥åŒ…å«ç‹¬ç«‹çš„ä»»åŠ¡ï¼Œå¦‚æœæ­£ç¡®æ‰§è¡Œè¿™äº›ä»»åŠ¡å°†å¾—åˆ°æ­£ç¡®çš„ç­”æ¡ˆã€‚ä¸è¦æ·»åŠ ä»»ä½•å¤šä½™çš„æ­¥éª¤ã€‚\</span><br><span class="line">æœ€åä¸€æ­¥çš„ç»“æœåº”è¯¥æ˜¯æœ€ç»ˆç­”æ¡ˆã€‚ç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½åŒ…å«æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯â€”â€”ä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤ã€‚</span><br><span class="line"></span><br><span class="line">ä½ çš„ç›®æ ‡æ˜¯ï¼š</span><br><span class="line">&#123;input&#125;</span><br><span class="line"></span><br><span class="line">ä½ çš„åŸå§‹è®¡åˆ’æ˜¯ï¼š</span><br><span class="line">&#123;plan&#125;</span><br><span class="line"></span><br><span class="line">ä½ ç›®å‰å·²ç»å®Œæˆäº†ä»¥ä¸‹æ­¥éª¤ï¼š</span><br><span class="line">&#123;past_steps&#125;</span><br><span class="line"></span><br><span class="line">ç›¸åº”åœ°æ›´æ–°ä½ çš„è®¡åˆ’ã€‚å¦‚æœä¸éœ€è¦æ›´å¤šæ­¥éª¤å¹¶ä¸”å¯ä»¥è¿”å›ç»™ç”¨æˆ·ï¼Œåˆ™ç›´æ¥å“åº”ã€‚å¦åˆ™ï¼Œå¡«å†™è®¡åˆ’ã€‚åªæ·»åŠ ä»éœ€è¦å®Œæˆçš„æ­¥éª¤åˆ°è®¡åˆ’ä¸­ã€‚ä¸è¦å°†å·²ç»å®Œæˆçš„æ­¥éª¤ä½œä¸ºè®¡åˆ’çš„ä¸€éƒ¨åˆ†è¿”å›ã€‚&quot;&quot;&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">replanner = replanner_prompt | model.with_structured_output(Act)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">async def replan_step(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;é‡æ–°è§„åˆ’æ­¥éª¤&quot;&quot;&quot;</span><br><span class="line">    # ä½¿ç”¨é‡æ–°è§„åˆ’å™¨æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°è®¡åˆ’</span><br><span class="line">    output = await replanner.ainvoke(state)</span><br><span class="line">    if isinstance(output.action, Response):</span><br><span class="line">        # å¦‚æœåŠ¨ä½œæ˜¯å“åº”ï¼Œè¿”å›æœ€ç»ˆå“åº”</span><br><span class="line">        return &#123;&quot;response&quot;: output.action.response&#125;</span><br><span class="line">    else:</span><br><span class="line">        # å¦‚æœåŠ¨ä½œæ˜¯è®¡åˆ’ï¼Œè¿”å›æ–°çš„è®¡åˆ’æ­¥éª¤</span><br><span class="line">        return &#123;&quot;plan&quot;: output.action.steps&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰è·¯ç”±">å®šä¹‰è·¯ç”±</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def should_end(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;åˆ¤æ–­æ˜¯å¦ç»“æŸæ‰§è¡Œæµç¨‹&quot;&quot;&quot;</span><br><span class="line">    if &quot;response&quot; in state and state[&quot;response&quot;]:</span><br><span class="line">        # å¦‚æœå­˜åœ¨å“åº”å†…å®¹ï¼Œç»“æŸæµç¨‹</span><br><span class="line">        return END</span><br><span class="line">    else:</span><br><span class="line">        # å¦åˆ™ç»§ç»­æ‰§è¡Œä»£ç†æ­¥éª¤</span><br><span class="line">        return &quot;agent&quot;</span><br></pre></td></tr></table></figure>
<h4 id="ç¼–è¯‘å›¾">ç¼–è¯‘å›¾</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.graph import StateGraph, START</span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºå†…å­˜æ£€æŸ¥ç‚¹ä¿å­˜å™¨</span><br><span class="line">memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºå·¥ä½œæµå›¾ï¼Œä½¿ç”¨ PlanExecute çŠ¶æ€ç±»å‹</span><br><span class="line">workflow = StateGraph(PlanExecute)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ è®¡åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_node(&quot;planner&quot;, plan_step)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ æ‰§è¡Œæ­¥éª¤èŠ‚ç‚¹</span><br><span class="line">workflow.add_node(&quot;agent&quot;, execute_step)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ é‡æ–°è§„åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_node(&quot;replan&quot;, replan_step)</span><br><span class="line"></span><br><span class="line"># ä»å¼€å§‹èŠ‚ç‚¹è¿æ¥åˆ°è®¡åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_edge(START, &quot;planner&quot;)</span><br><span class="line"></span><br><span class="line"># ä»è®¡åˆ’èŠ‚ç‚¹è¿æ¥åˆ°ä»£ç†æ‰§è¡ŒèŠ‚ç‚¹</span><br><span class="line">workflow.add_edge(&quot;planner&quot;, &quot;agent&quot;)</span><br><span class="line"></span><br><span class="line"># ä»ä»£ç†æ‰§è¡ŒèŠ‚ç‚¹è¿æ¥åˆ°é‡æ–°è§„åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_edge(&quot;agent&quot;, &quot;replan&quot;)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ æ¡ä»¶è¾¹ - ä»é‡æ–°è§„åˆ’èŠ‚ç‚¹æ ¹æ®æ¡ä»¶å†³å®šä¸‹ä¸€æ­¥</span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    &quot;replan&quot;,</span><br><span class="line">    # ä¼ å…¥å†³å®šä¸‹ä¸€ä¸ªè°ƒç”¨èŠ‚ç‚¹çš„å‡½æ•°</span><br><span class="line">    should_end,</span><br><span class="line">    [&quot;agent&quot;, END],  # å¯èƒ½çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼šä»£ç†èŠ‚ç‚¹æˆ–ç»“æŸ</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># æœ€åï¼Œç¼–è¯‘å·¥ä½œæµå¹¶æ·»åŠ æ£€æŸ¥ç‚¹åŠŸèƒ½ï¼</span><br><span class="line"># è¿™å°†å…¶ç¼–è¯‘ä¸º LangChain Runnableï¼Œ</span><br><span class="line"># æ„å‘³ç€ä½ å¯ä»¥åƒä½¿ç”¨å…¶ä»–ä»»ä½• runnable ä¸€æ ·ä½¿ç”¨å®ƒ</span><br><span class="line">app = workflow.compile(checkpointer=memory)</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/Plan-and-Execute%E6%A8%A1%E5%BC%8F/image-20250729092408872.png" alt="image-20250729092408872">
<figcaption aria-hidden="true">image-20250729092408872</figcaption>
</figure>
<h4 id="è°ƒç”¨">è°ƒç”¨</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># é…ç½®é€’å½’é™åˆ¶ï¼Œé˜²æ­¢æ— é™å¾ªç¯</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;</span><br><span class="line">        &quot;thread_id&quot;: &quot;1&quot;,  # å¿…éœ€ï¼šçº¿ç¨‹ID</span><br><span class="line">    &#125;,&quot;recursion_limit&quot;: 50&#125;</span><br><span class="line"></span><br><span class="line"># è¾“å…¥é—®é¢˜ï¼š2024å¹´æ¾³å¤§åˆ©äºšç½‘çƒå…¬å¼€èµ›ç”·å•å† å†›çš„å®¶ä¹¡æ˜¯å“ªé‡Œï¼Ÿ</span><br><span class="line">inputs = &#123;&quot;input&quot;: &quot;2024å¹´æ¾³å¤§åˆ©äºšç½‘çƒå…¬å¼€èµ›ç”·å•å† å†›çš„å®¶ä¹¡æ˜¯å“ªé‡Œï¼Ÿ&quot;&#125;</span><br><span class="line"></span><br><span class="line"># å¼‚æ­¥æµå¼æ‰§è¡Œåº”ç”¨</span><br><span class="line">async for event in app.astream(inputs, config=config):</span><br><span class="line">    # éå†æ¯ä¸ªäº‹ä»¶</span><br><span class="line">    for k, v in event.items():</span><br><span class="line">        # æ’é™¤ç»“æŸæ ‡è®°ï¼Œæ‰“å°å…¶ä»–æ‰€æœ‰äº‹ä»¶å†…å®¹</span><br><span class="line">        if k != &quot;__end__&quot;:</span><br><span class="line">            print(v)</span><br></pre></td></tr></table></figure>
<h3 id="èµ„æº">èµ„æº</h3>
<p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/tutorials/plan-and-execute/plan-and-execute/">è®¡åˆ’ä¸æ‰§è¡Œ
â€” Plan-and-Execute</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">Transformerå­¦ä¹ </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-11 15:40:12" itemprop="dateModified" datetime="2025-08-11T15:40:12+08:00">2025-08-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">å¤§æ¨¡å‹ç®—æ³•</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/transformer/" itemprop="url" rel="index"><span itemprop="name">transformer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€">å‰è¨€</h3>
<p>æœ¬æ–‡åŸºäº<a target="_blank" rel="noopener" href="https://github.com/Hoper-J/AI-Guide-and-Demos-zh_CN/blob/master/PaperNotes/Transformer%20è®ºæ–‡ç²¾è¯».md#å‰è¨€">AI-Guide-and-Demos-zh_CN/PaperNotes/Transformer
è®ºæ–‡ç²¾è¯».md at master Â· Hoper-J/AI-Guide-and-Demos-zh_CN</a>ä¸<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1pu411o7BE/?spm_id_from=333.337.search-card.all.click&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">Transformerè®ºæ–‡é€æ®µç²¾è¯»ã€è®ºæ–‡ç²¾è¯»ã€‘_å“”å“©å“”å“©_bilibili</a>é˜…è¯»å­¦ä¹ </p>
<h3 id="transformerè´¡çŒ®">transformerè´¡çŒ®</h3>
<p>å®é™…åœ¨è¿™ä¸€é˜¶æ®µçš„å·¥ä½œä¸­ï¼Œ<strong>æ³¨æ„åŠ›æœºåˆ¶</strong>å°±å·²ç»åœ¨<strong>ç¼–ç å™¨-è§£ç å™¨æ¶æ„</strong>ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼ˆä¸
RNN ä¸€èµ·ä½¿ç”¨ï¼‰ï¼Œä½† Transformer
å½»åº•é¢ è¦†äº†é»˜è®¤é‡‡å–çš„é€»è¾‘ï¼š<strong>ç›´æ¥æ”¾å¼ƒ RNN
çš„é€’å½’ç»“æ„ï¼Œåªä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶æ¥ç¼–ç å’Œè§£ç åºåˆ—ä¿¡æ¯</strong>ã€‚</p>
<p>Transformer çš„ä¸»è¦è´¡çŒ®å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><strong>å–æ¶ˆé€’å½’ç»“æ„ï¼Œå®ç°å¹¶è¡Œè®¡ç®—</strong></p>
<p>é€šè¿‡é‡‡ç”¨<strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰</strong>ï¼ŒTransformer
å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¾“å…¥åºåˆ—ï¼Œæå¤§æé«˜äº†è®¡ç®—çš„å¹¶è¡Œåº¦å’Œè®­ç»ƒé€Ÿåº¦ã€‚</p></li>
<li><p><strong>å¼•å…¥ä½ç½®ç¼–ç ï¼ˆPositional Encodingï¼‰å¹¶ç»“åˆ Attention
æœºåˆ¶å·§å¦™åœ°æ•æ‰ä½ç½®ä¿¡æ¯</strong></p>
<p>åœ¨ä¸ä¾èµ– RNN
ç»“æ„çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä½ç½®ç¼–ç ä¸ºåºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ åµŒå…¥ä½ç½®ä¿¡æ¯ï¼Œä»è€Œä½¿æ¨¡å‹èƒ½å¤Ÿæ„ŸçŸ¥è¾“å…¥çš„é¡ºåºã€‚</p></li>
</ul>
<h3 id="transformeræ¶æ„">transformeræ¶æ„</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807135151542.png" alt="image-20250807135151542">
<figcaption aria-hidden="true">image-20250807135151542</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807145354145.png" alt="image-20250807145354145">
<figcaption aria-hidden="true">image-20250807145354145</figcaption>
</figure>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1MY41137AK?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ã€Transformeræ¨¡å‹ã€‘æ›¼å¦™åŠ¨ç”»è½»æ¾å­¦ï¼Œå½¢è±¡æ¯”å–»è´¼å¥½è®°_å“”å“©å“”å“©_bilibili</a></p>
<p>Transformer æ¨¡å‹åŸºäº<strong>ç¼–ç å™¨</strong>ï¼ˆå·¦ï¼‰-
<strong>è§£ç å™¨</strong>ï¼ˆå³ï¼‰æ¶æ„</p>
<p><strong>Transformerç¼–ç å™¨</strong>åŒæ ·ç”± <strong>N
ä¸ªå®Œå…¨ç›¸åŒçš„å±‚</strong>ï¼ˆåŸå§‹è®ºæ–‡ä¸­
N=6ï¼‰å †å è€Œæˆï¼Œæ¯å±‚åªæœ‰ä¸¤ä¸ªå­å±‚ï¼Œè€Œè§£ç å™¨æœ‰ä¸‰ä¸ªã€‚</p>
<ol type="1">
<li>å¤šå¤´è‡ªæ³¨æ„åŠ›ï¼ˆMulti-Head Self-Attentionï¼‰
è®©è¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®éƒ½èƒ½å…³æ³¨åºåˆ—å†…æ‰€æœ‰ä½ç½®ï¼Œç›´æ¥å»ºæ¨¡å…¨å±€ä¾èµ–ã€‚</li>
<li>å‰é¦ˆå…¨è¿æ¥ç½‘ç»œï¼ˆPosition-wise Feed-Forward Networkï¼‰
å¯¹æ¯ä¸ªä½ç½®ç‹¬ç«‹åœ°åšä¸€æ¬¡ä¸¤å±‚çš„å…¨è¿æ¥å˜æ¢ï¼ˆé€šå¸¸å…ˆå‡ç»´å†é™ç»´ï¼‰ã€‚</li>
</ol>
<p>åŒæ ·ï¼Œæ¯ä¸ªå­å±‚åéƒ½æœ‰</p>
<ul>
<li>æ®‹å·®è¿æ¥ï¼ˆResidual Connectionï¼‰</li>
<li>å±‚å½’ä¸€åŒ–ï¼ˆLayer Normalizationï¼‰</li>
</ul>
<p>å¦å¤–ï¼Œç¼–ç å™¨åœ¨è¾“å…¥ç«¯è¿˜ä¼šç”¨åˆ°</p>
<ul>
<li>ä½ç½®ç¼–ç ï¼ˆPositional
Encodingï¼‰â€”â€”ç»™æ¨¡å‹æä¾›åºåˆ—ä½ç½®ä¿¡æ¯ï¼Œå› ä¸ºæ³¨æ„åŠ›æœ¬èº«ä¸åŒ…å«é¡ºåºä¿¡æ¯ã€‚</li>
</ul>
<p><strong>Transformerè§£ç å™¨</strong>ç”±å¤šä¸ªç›¸åŒçš„å±‚å †å è€Œæˆï¼Œæ¯ä¸€å±‚åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒå­å±‚ï¼š</p>
<ol type="1">
<li><strong>æ©è”½å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ï¼ˆMasked Multi-Head Attentionï¼‰
ç”¨äºå¤„ç†ç›®æ ‡åºåˆ—ï¼Œé€šè¿‡æ©ç é˜²æ­¢å½“å‰ä½ç½®å…³æ³¨æœªæ¥ä½ç½®ï¼Œç¡®ä¿ç”Ÿæˆè¿‡ç¨‹çš„è‡ªå›å½’ç‰¹æ€§ã€‚</li>
<li><strong>ç¼–ç å™¨-è§£ç å™¨æ³¨æ„åŠ›æœºåˆ¶</strong>ï¼ˆEncoder-Decoder
Attentionï¼‰
ä½¿è§£ç å™¨èƒ½å¤Ÿå…³æ³¨ç¼–ç å™¨è¾“å‡ºçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå»ºç«‹è¾“å…¥ä¸è¾“å‡ºåºåˆ—ä¹‹é—´çš„å…³è”ã€‚</li>
<li><strong>å‰é¦ˆç¥ç»ç½‘ç»œ</strong>ï¼ˆFeed-Forward Neural Networkï¼‰
å¯¹æ³¨æ„åŠ›æœºåˆ¶çš„è¾“å‡ºè¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œå¢å¼ºæ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚</li>
</ol>
<p>æ­¤å¤–ï¼Œæ¯ä¸ªå­å±‚åå‡åŒ…å«<strong>æ®‹å·®è¿æ¥</strong>ï¼ˆResidual
Connectionï¼‰å’Œ<strong>å±‚å½’ä¸€åŒ–</strong>ï¼ˆLayer
Normalizationï¼‰ï¼Œä»¥ç¨³å®šè®­ç»ƒè¿‡ç¨‹å¹¶åŠ é€Ÿæ”¶æ•›ã€‚æœ€ç»ˆï¼Œè§£ç å™¨çš„è¾“å‡ºé€šè¿‡çº¿æ€§å±‚å’ŒSoftmaxå±‚æ˜ å°„ä¸ºè¯æ±‡è¡¨ä¸Šçš„æ¦‚ç‡åˆ†å¸ƒã€‚</p>
<h3 id="åµŒå…¥embeddings">åµŒå…¥ï¼ˆEmbeddingsï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808103256344.png" alt="image-20250808103256344">
<figcaption aria-hidden="true">image-20250808103256344</figcaption>
</figure>
<p>åœ¨ Transformer æ¨¡å‹ä¸­ï¼Œ<strong>åµŒå…¥å±‚</strong>ï¼ˆEmbedding Layerï¼‰
æ˜¯å¤„ç†è¾“å…¥å’Œè¾“å‡ºæ•°æ®çš„å…³é”®æ­¥éª¤ï¼Œå› ä¸ºæ¨¡å‹å®é™…æ“ä½œçš„æ˜¯<strong>å¼ é‡</strong>ï¼ˆtensorï¼‰ï¼Œè€Œé<strong>å­—ç¬¦ä¸²</strong>ï¼ˆstringï¼‰ã€‚åœ¨å°†è¾“å…¥æ–‡æœ¬ä¼ é€’ç»™æ¨¡å‹ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦è¿›è¡Œ<strong>åˆ†è¯</strong>ï¼ˆtokenizationï¼‰ï¼Œå³å°†æ–‡æœ¬æ‹†è§£ä¸ºå¤šä¸ª
<strong>token</strong>ï¼Œéšåè¿™äº› token ä¼šè¢«æ˜ å°„ä¸ºå¯¹åº”çš„ <strong>token
ID</strong>ï¼Œä»è€Œè½¬æ¢ä¸ºæ¨¡å‹å¯ç†è§£çš„æ•°å€¼å½¢å¼ã€‚æ­¤æ—¶ï¼Œæ•°æ®çš„å½¢çŠ¶ä¸º
<code>(seq_len,)</code>ï¼Œå…¶ä¸­ <code>seq_len</code>
è¡¨ç¤ºè¾“å…¥åºåˆ—çš„é•¿åº¦ã€‚</p>
<p>ç›®çš„ï¼šä¸ºäº†è®©æ¨¡å‹æ•æ‰åˆ° token èƒŒåå¤æ‚çš„è¯­ä¹‰ï¼ˆSemantic
meaningï¼‰å…³ç³»ï¼Œæˆ‘ä»¬éœ€è¦å°†ç¦»æ•£çš„ token ID
æ˜ å°„åˆ°ä¸€ä¸ªé«˜ç»´çš„è¿ç»­å‘é‡ç©ºé—´ï¼ˆContinuous, denseï¼‰ã€‚è¿™æ„å‘³ç€æ¯ä¸ª token ID
ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ª<strong>åµŒå…¥å‘é‡</strong>ï¼ˆembedding
vectorï¼‰ï¼ŒæœŸæœ›é€šè¿‡è¿™ç§æ–¹å¼è®©è¯­ä¹‰ç›¸è¿‘çš„è¯æ±‡åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»æ›´è¿‘ï¼Œä½¿æ¨¡å‹èƒ½æ›´å¥½åœ°æ•æ‰è¯æ±‡ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>æµç¨‹ï¼šï¼ˆå‰é¢è¦è¿›è¡Œåˆ†è¯ï¼Œåé¢è¦è¿›è¡Œä½ç½®ç¼–ç ï¼‰</p>
<p>åˆå§‹åŒ–ä¸€ä¸ªå¯å­¦ä¹ çš„çŸ©é˜µ <code>E âˆˆ â„^(|V| Ã— d_model)</code>
<code>|V|</code> = è¯è¡¨å¤§å°ï¼ˆæ¯”å¦‚ 32 kã€50 kï¼‰ï¼Œ<code>d_model</code> =
512/768/1024â€¦</p>
<p>æŠŠ token id ä½œä¸ºè¡Œå·ï¼Œç›´æ¥å–å¯¹åº”è¡Œï¼š <code>x_i = E[token_id_i]</code>
å¾—åˆ° <code>[batch, seq_len, d_model]</code> çš„æµ®ç‚¹å¼ é‡ã€‚</p>
<h3 id="ä½ç½®ç¼–ç positional-encoding">ä½ç½®ç¼–ç ï¼ˆPositional
Encodingï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808103418150.png" alt="image-20250808103418150">
<figcaption aria-hidden="true">image-20250808103418150</figcaption>
</figure>
<p>Transformer
çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰æ˜¯<strong>ä½ç½®æ— å…³ï¼ˆposition-agnosticï¼‰</strong>çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œæ¨¡å‹æ— æ³•åŒºåˆ†â€œæˆ‘çˆ±ä½ â€å’Œâ€œä½ çˆ±æˆ‘â€è¿™ä¸¤ä¸ªå¥å­çš„å·®å¼‚ï¼Œå› ä¸ºè‡ªæ³¨æ„åŠ›æœºåˆ¶åªå…³æ³¨
token ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œè€Œä¸è€ƒè™‘å®ƒä»¬åœ¨åºåˆ—ä¸­çš„é¡ºåºã€‚</p>
<p>ä¸ºäº†è®©æ¨¡å‹æ„ŸçŸ¥åˆ° token çš„ä½ç½®ä¿¡æ¯ï¼ŒTransformer
å¼•å…¥äº†<strong>ä½ç½®ç¼–ç </strong>ã€‚</p>
<p>åœ¨åŸå§‹è®ºæ–‡ä¸­ï¼ŒTransformer ä½¿ç”¨çš„æ˜¯å›ºå®šä½ç½®ç¼–ç ï¼ˆPositional
Encodingï¼‰ï¼Œå…¶å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math display">$$
\begin{aligned}
PE_{(pos, 2i)} &amp;=
\sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right), \\
PE_{(pos, 2i+1)} &amp;=
\cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right).
\end{aligned}
$$</span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="math inline"><em>p</em><em>o</em><em>s</em></span>
è¡¨ç¤ºä½ç½®ç´¢å¼•ï¼ˆPositionï¼‰ã€‚</li>
<li><span class="math inline"><em>i</em></span> è¡¨ç¤ºç»´åº¦ç´¢å¼•ã€‚</li>
<li><span class="math inline"><em>d</em><sub>model</sub></span>
æ˜¯åµŒå…¥å‘é‡çš„ç»´åº¦ã€‚</li>
</ul>
<p>æµç¨‹ï¼šè¾“å…¥çš„æ˜¯ä¸€ä¸ª<strong>æ•´æ•°ç´¢å¼•</strong>ï¼ˆä½ç½®åºå·
0,1,2,â€¦ï¼‰ã€‚ä½ç½®ç¼–ç æ¨¡å—å…ˆæŠŠè¿™äº›æ•´æ•°æ˜ å°„æˆä¸è¯å‘é‡åŒç»´åº¦çš„å‘é‡ï¼ˆä¾‹å¦‚ 512
ç»´ï¼‰ï¼Œå†æŠŠç»“æœåŠ åˆ°è¯å‘é‡ä¸Šã€‚</p>
<h3 id="softmax">Softmax</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808111823715.png" alt="image-20250808111823715">
<figcaption aria-hidden="true">image-20250808111823715</figcaption>
</figure>
<p>åœ¨ Transformer æ¨¡å‹ä¸­ï¼Œ<strong>Softmax</strong>
å‡½æ•°ä¸ä»…åœ¨è®¡ç®—<strong>æ³¨æ„åŠ›æƒé‡</strong>æ—¶ç”¨åˆ°ï¼Œåœ¨é¢„æµ‹é˜¶æ®µçš„è¾“å‡ºå¤„ç†ç¯èŠ‚ä¹Ÿä¼šç”¨åˆ°ï¼Œå› ä¸ºé¢„æµ‹
token çš„è¿‡ç¨‹å¯ä»¥çœ‹æˆæ˜¯<strong>å¤šåˆ†ç±»é—®é¢˜</strong>ã€‚</p>
<p><strong>Softmax</strong>
å‡½æ•°æ˜¯ä¸€ç§å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œèƒ½å¤Ÿå°†ä»»æ„å®æ•°å‘é‡è½¬æ¢ä¸º<strong>æ¦‚ç‡åˆ†å¸ƒ</strong>ï¼Œç¡®ä¿æ¯ä¸ªå…ƒç´ çš„å–å€¼èŒƒå›´åœ¨
[0, 1] ä¹‹é—´ï¼Œå¹¶ä¸”æ‰€æœ‰å…ƒç´ çš„å’Œä¸º 1ã€‚å…¶æ•°å­¦å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><span class="math display">$$
\text{Softmax}(x_i) = \frac{e^{x_i}}{\sum_{j} e^{x_j}}
$$</span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="math inline"><em>x</em><sub><em>i</em></sub></span>
è¡¨ç¤ºè¾“å…¥å‘é‡ä¸­çš„ç¬¬ <span class="math inline"><em>i</em></span>
ä¸ªå…ƒç´ ã€‚</li>
<li><span class="math inline">Softmax(<em>x</em><sub><em>i</em></sub>)</span>
è¡¨ç¤ºè¾“å…¥ <span class="math inline"><em>x</em><sub><em>i</em></sub></span>
è½¬æ¢åçš„æ¦‚ç‡ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥æŠŠ Softmax
çœ‹ä½œä¸€ç§<strong>å½’ä¸€åŒ–çš„æŒ‡æ•°å˜æ¢</strong>ã€‚ç›¸æ¯”äºç®€å•çš„æ¯”ä¾‹å½’ä¸€åŒ– <span class="math inline">$\frac{x_i}{\sum_j x_j}$</span>, <strong>Softmax
é€šè¿‡æŒ‡æ•°å˜æ¢æ”¾å¤§æ•°å€¼é—´çš„å·®å¼‚ï¼Œè®©è¾ƒå¤§çš„å€¼å¯¹åº”æ›´é«˜çš„æ¦‚ç‡ï¼ŒåŒæ—¶é¿å…äº†è´Ÿå€¼å’Œæ•°å€¼è¿‡å°çš„é—®é¢˜ï¼Œè®©æ¨¡å‹èšç„¦äºæƒé‡æœ€é«˜çš„ä½ç½®</strong>ï¼ŒåŒæ—¶ä¿ç•™å…¨å±€ä¿¡æ¯ï¼ˆä½æƒé‡ä»éé›¶ï¼‰ã€‚</p>
<h3 id="æ³¨æ„åŠ›æœºåˆ¶">æ³¨æ„åŠ›æœºåˆ¶</h3>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1xS4y1k7tn?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ã€Attention
æ³¨æ„åŠ›æœºåˆ¶ã€‘æ¿€æƒ…å‘Šç™½transformerã€Bertã€GNNçš„ç²¾é«“_å“”å“©å“”å“©_bilibili</a></p>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808135811744.png" alt="image-20250808135811744">
<figcaption aria-hidden="true">image-20250808135811744</figcaption>
</figure>
<h4 id="ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶scaled-dot-product-attention"><strong>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled
Dot-Product Attentionï¼‰</strong></h4>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808140834132.png" alt="image-20250808140834132">
<figcaption aria-hidden="true">image-20250808140834132</figcaption>
</figure>
<p>Transformer çš„æ ¸å¿ƒæ˜¯<strong>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Head
Attentionï¼‰</strong>ï¼Œå®ƒèƒ½å¤Ÿæ•æ‰è¾“å…¥åºåˆ—ä¸­ä¸åŒä½ç½®ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶ä»å¤šä¸ªè§’åº¦å¯¹ä¿¡æ¯è¿›è¡Œå»ºæ¨¡ã€‚æ¨¡å—å°†è‡ªåº•å‘ä¸Šçš„è¿›è¡Œè®²è§£ï¼šåœ¨æ·±å…¥ç†è§£æ³¨æ„åŠ›æœºåˆ¶å‰ï¼Œé¦–å…ˆéœ€è¦ç†è§£è®ºæ–‡ä½¿ç”¨çš„<strong>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled
Dot-Product Attentionï¼‰</strong>ã€‚</p>
<p>ç»™å®šæŸ¥è¯¢çŸ©é˜µ <span class="math inline"><em>Q</em></span>ã€é”®çŸ©é˜µ
<span class="math inline"><em>K</em></span> å’Œå€¼çŸ©é˜µ <span class="math inline"><em>V</em></span>,
å…¶æ³¨æ„åŠ›è¾“å‡ºçš„æ•°å­¦è¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math display">$$
\text{Attention}(Q, K, V) = \text{Softmax}\left(\frac{Q
K^\top}{\sqrt{d_k}}\right) V
$$</span></p>
<ul>
<li><strong><span class="math inline"><em>Q</em></span>ï¼ˆQueryï¼‰</strong>:
ç”¨äºæŸ¥è¯¢çš„å‘é‡çŸ©é˜µã€‚</li>
<li><strong><span class="math inline"><em>K</em></span>ï¼ˆKeyï¼‰</strong>:
è¡¨ç¤ºé”®çš„å‘é‡çŸ©é˜µï¼Œç”¨äºä¸æŸ¥è¯¢åŒ¹é…ã€‚</li>
<li><strong><span class="math inline"><em>V</em></span>ï¼ˆValueï¼‰</strong>:
å€¼çŸ©é˜µï¼Œæ³¨æ„åŠ›æƒé‡æœ€ç»ˆä¼šä½œç”¨åœ¨è¯¥çŸ©é˜µä¸Šã€‚</li>
<li><strong><span class="math inline"><em>d</em><sub><em>k</em></sub></span></strong>:
é”®æˆ–æŸ¥è¯¢å‘é‡çš„ç»´åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç†è§£ Qã€Kã€V
çš„å…³é”®åœ¨äºä»£ç ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯é€šè¿‡çº¿æ€§å˜æ¢ä»è¾“å…¥åºåˆ—ç”Ÿæˆçš„</p>
</blockquote>
<p>å…¬å¼è§£é‡Š</p>
<ol type="1">
<li><p><strong>ç‚¹ç§¯è®¡ç®—ï¼ˆDot Produceï¼‰</strong></p>
<p>å°†æŸ¥è¯¢çŸ©é˜µ <span class="math inline"><em>Q</em></span> ä¸é”®çŸ©é˜µçš„è½¬ç½®
<span class="math inline"><em>K</em><sup>âŠ¤</sup></span>
åšç‚¹ç§¯ï¼Œè®¡ç®—æ¯ä¸ªæŸ¥è¯¢å‘é‡ä¸æ‰€æœ‰é”®å‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼š</p>
<p><span class="math inline">$`\text{Scores} = Q K^\top`$</span></p>
<ul>
<li><strong>æ¯ä¸€è¡Œ</strong>è¡¨ç¤ºæŸä¸ªæŸ¥è¯¢ä¸æ‰€æœ‰é”®ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼ˆåŒ¹é…åˆ†æ•°ï¼‰ã€‚</li>
<li><strong>æ¯ä¸€åˆ—</strong>è¡¨ç¤ºæŸä¸ªé”®ä¸æ‰€æœ‰æŸ¥è¯¢ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼ˆåŒ¹é…åˆ†æ•°ï¼‰ã€‚</li>
</ul></li>
<li><p><strong>ç¼©æ”¾ï¼ˆScalingï¼‰</strong></p>
<p>å½“ <span class="math inline"><em>d</em><sub><em>k</em></sub></span>
è¾ƒå¤§æ—¶ï¼Œç‚¹ç§¯çš„æ•°å€¼å¯èƒ½ä¼šè¿‡å¤§ï¼Œå¯¼è‡´ Softmax è¿‡åçš„æ¢¯åº¦å˜å¾—æå°ï¼Œå› æ­¤é™¤ä»¥
<span class="math inline">$\sqrt{d_k}$</span>
ç¼©æ”¾ç‚¹ç§¯ç»“æœçš„æ•°å€¼èŒƒå›´ï¼š</p>
<p><span class="math inline">$`\text{Scaled Scores} = \frac{Q
K^\top}{\sqrt{d_k}}`$</span></p>
<p>ç¼©æ”¾åï¼ˆScaled Dot-Productï¼‰ä¹Ÿç§°ä¸ºæ³¨æ„åŠ›åˆ†æ•°ï¼ˆ<strong>attention
scores</strong>ï¼‰ã€‚</p></li>
<li><p><strong>Softmax å½’ä¸€åŒ–</strong></p>
<p>ä½¿ç”¨ Softmax å‡½æ•°å°†ç¼©æ”¾åçš„åˆ†æ•°è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼š</p>
<p><span class="math inline">$`\text{Attention Weights} =
\text{Softmax}\left(\frac{Q K^\top}{\sqrt{d_k}}\right)`$</span></p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šSoftmax
æ˜¯åœ¨æ¯ä¸€è¡Œä¸Šè¿›è¡Œçš„ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªæŸ¥è¯¢çš„åŒ¹é…åˆ†æ•°å°†å½’ä¸€åŒ–ä¸ºæ¦‚ç‡ï¼Œæ€»å’Œä¸º
1ã€‚</p>
</blockquote></li>
<li><p><strong>åŠ æƒæ±‚å’Œï¼ˆWeighted Sumï¼‰</strong></p>
<p>æœ€åï¼Œä½¿ç”¨å½’ä¸€åŒ–åçš„æ³¨æ„åŠ›æƒé‡å¯¹å€¼çŸ©é˜µ <span class="math inline"><em>V</em></span>
è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æ¯ä¸ªæŸ¥è¯¢ä½ç½®çš„æœ€ç»ˆè¾“å‡ºï¼š <span class="math inline">$`\text{Output} = \text{Attention Weights} \times
V`$</span></p></li>
</ol>
<h3 id="å•å¤´æ³¨æ„åŠ›æœºåˆ¶single-head-attention">å•å¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆSingle-Head
Attentionï¼‰</h3>
<p>å°†è¾“å…¥åºåˆ—ï¼ˆInputsï¼‰é€šè¿‡çº¿æ€§å˜æ¢ç”Ÿæˆ<strong>æŸ¥è¯¢çŸ©é˜µ</strong>ï¼ˆQuery,
Qï¼‰ã€<strong>é”®çŸ©é˜µ</strong>ï¼ˆKey, Kï¼‰å’Œ<strong>å€¼çŸ©é˜µ</strong>ï¼ˆValue,
Vï¼‰ï¼Œéšåæ‰§è¡Œ<strong>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›</strong>ï¼ˆScaled Dot-Product
Attentionï¼‰ã€‚</p>
<h4 id="æ©ç æ³¨æ„åŠ›æœºåˆ¶masked-attention">æ©ç æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMasked
Attentionï¼‰</h4>
<p>å¦‚æœä½¿ç”¨ mask æ©ç›–å°†è¦é¢„æµ‹çš„è¯æ±‡ï¼Œé‚£ä¹ˆ Attention å°±å»¶ä¼¸ä¸º Masked
Attention</p>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>mask</code>
çŸ©é˜µç”¨äºæŒ‡å®šå“ªäº›ä½ç½®åº”è¯¥è¢«é®è”½ï¼ˆå³å¡«å……ä¸º
-âˆï¼‰ï¼Œä»è€Œä¿è¯è¿™äº›ä½ç½®çš„æ³¨æ„åŠ›æƒé‡åœ¨ softmax
è¾“å‡ºä¸­æ¥è¿‘äºé›¶ã€‚æ³¨æ„ï¼Œæ©ç æœºåˆ¶å¹¶ä¸æ˜¯ç›´æ¥åœ¨æˆªæ–­è¾“å…¥åºåˆ—ï¼Œä¹Ÿä¸æ˜¯åœ¨ç®—åˆ†æ•°çš„æ—¶å€™å°±æ’é™¤ä¸åº”è¯¥çœ‹åˆ°çš„ä½ç½®ï¼Œå› ä¸ºçœ‹åˆ°ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œä¸ä¼šå½±å“ä¸å…¶ä»–ä½ç½®çš„åˆ†æ•°ï¼Œæ‰€ä»¥åœ¨ä¼ å…¥
Softmaxï¼ˆè®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼‰ä¹‹å‰æ’é™¤å°±å¯ä»¥äº†ã€‚</p>
<p>å¦å¤–ï¼Œæ ¹æ®è¾“å…¥æ•°æ®çš„æ¥æºï¼Œè¿˜å¯ä»¥å°†æ³¨æ„åŠ›åˆ†ä¸º<strong>è‡ªæ³¨æ„åŠ›ï¼ˆSelf-Attentionï¼‰å’Œäº¤å‰æ³¨æ„åŠ›ï¼ˆCross-Attention)</strong>ã€‚</p>
<h4 id="è‡ªæ³¨æ„åŠ›æœºåˆ¶self-attention">è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-attentionï¼‰</h4>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808142109091.png" alt="image-20250808142109091">
<figcaption aria-hidden="true">image-20250808142109091</figcaption>
</figure>
<p>Transformer
æ¨¡å‹æ¶æ„ä½¿ç”¨åˆ°äº†ä¸‰ä¸ªçœ‹èµ·æ¥ä¸åŒçš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œæˆ‘ä»¬ç»§ç»­å¿½è§†å…±æœ‰çš„
Multi-Headã€‚è§‚å¯Ÿè¾“å…¥ï¼Œçº¿æ¡ä¸€åˆ†ä¸ºä¸‰ä¼ å…¥ Attention
æ¨¡å—ï¼Œè¿™æ„å‘³ç€æŸ¥è¯¢ï¼ˆqueryï¼‰ã€é”®ï¼ˆkeyï¼‰å’Œå€¼ï¼ˆvalueï¼‰å®é™…ä¸Šéƒ½æ¥è‡ª<strong>åŒä¸€è¾“å…¥åºåˆ—
<span class="math inline"><strong>X</strong></span></strong>ï¼Œæ•°å­¦è¡¨è¾¾å¦‚ä¸‹ï¼š</p>
<p><span class="math display"><em>Q</em>â€„=â€„<em>X</em><em>W</em><sup><em>Q</em></sup>,â€Šâ€<em>K</em>â€„=â€„<em>X</em><em>W</em><sup><em>K</em></sup>,â€Šâ€<em>V</em>â€„=â€„<em>X</em><em>W</em><sup><em>V</em></sup></span></p>
<ul>
<li><strong><span class="math inline"><em>W</em><sup><em>Q</em></sup>,â€†<em>W</em><sup><em>K</em></sup>,â€†<em>W</em><sup><em>V</em></sup></span></strong>ï¼šå¯è®­ç»ƒçš„çº¿æ€§å˜æ¢æƒé‡ï¼Œå®é™…ä¸Šå°±æ˜¯ç®€å•çš„çº¿æ€§å±‚</li>
</ul>
<h4 id="äº¤å‰æ³¨æ„åŠ›æœºåˆ¶cross-attention">äº¤å‰æ³¨æ„åŠ›æœºåˆ¶ï¼ˆCross-Attentionï¼‰</h4>
<p>åœ¨ Transformer è§£ç å™¨ä¸­ï¼Œé™¤äº†è‡ªæ³¨æ„åŠ›å¤–ï¼Œè¿˜ä½¿ç”¨äº†
<strong>äº¤å‰æ³¨æ„åŠ›ï¼ˆCross-Attentionï¼‰</strong>ã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè§£ç å™¨ï¼ˆå³ï¼‰åœ¨è‡ªåº•å‘ä¸Šçš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå…ˆæ‰§è¡Œè‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œç„¶åé€šè¿‡äº¤å‰æ³¨æ„åŠ›ä»ç¼–ç å™¨çš„è¾“å‡ºä¸­è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808142428374.png" alt="image-20250808142428374">
<figcaption aria-hidden="true">image-20250808142428374</figcaption>
</figure>
<p>æ•°å­¦è¡¨è¾¾å¦‚ä¸‹ï¼š</p>
<p><span class="math display"><em>Q</em>â€„=â€„<em>X</em><sub>decoder</sub><em>W</em><sup><em>Q</em></sup>,â€Šâ€<em>K</em>â€„=â€„<em>X</em><sub>encoder</sub><em>W</em><sup><em>K</em></sup>,â€Šâ€<em>V</em>â€„=â€„<em>X</em><sub>encoder</sub><em>W</em><sup><em>V</em></sup></span></p>
<h4 id="å¯¹æ¯”å­¦ä¹ ">å¯¹æ¯”å­¦ä¹ </h4>
<p><strong>Masked Attention</strong>ã€<strong>Self-Attention</strong> å’Œ
<strong>Cross-Attention</strong>
çš„æœ¬è´¨æ˜¯ä¸€è‡´çš„ï¼Œè¿™ä¸€ç‚¹ä»ä»£ç è°ƒç”¨å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸‰è€…çš„åŒºåˆ«åœ¨äºæœªæ¥æ©ç çš„ä½¿ç”¨å’Œè¾“å…¥æ•°æ®çš„æ¥æºï¼š</p>
<ul>
<li><p><strong>Masked
Attention</strong>ï¼šç”¨äºè§£ç è¿‡ç¨‹ï¼Œé€šè¿‡æ©ç å±è”½æœªæ¥çš„æ—¶é—´æ­¥ï¼Œç¡®ä¿æ¨¡å‹åªèƒ½åŸºäºå·²ç”Ÿæˆçš„éƒ¨åˆ†è¿›è¡Œé¢„æµ‹ï¼Œè®ºæ–‡ä¸­è§£ç å™¨éƒ¨åˆ†çš„ç¬¬ä¸€ä¸ª
Attention ä½¿ç”¨çš„æ˜¯ Masked Self-Attentionã€‚</p></li>
<li><p><strong>Self-Attention</strong>ï¼šæŸ¥è¯¢ã€é”®å’Œå€¼çŸ©é˜µæ¥è‡ªåŒä¸€è¾“å…¥åºåˆ—ï¼Œæ¨¡å‹é€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶å­¦ä¹ è¾“å…¥åºåˆ—çš„å…¨å±€ä¾èµ–å…³ç³»ã€‚</p></li>
<li><p><strong>Cross-Attention</strong>ï¼šæŸ¥è¯¢çŸ©é˜µæ¥è‡ªè§£ç å™¨çš„è¾“å…¥ï¼Œè€Œé”®å’Œå€¼çŸ©é˜µæ¥è‡ªç¼–ç å™¨çš„è¾“å‡ºï¼Œè§£ç å™¨çš„ç¬¬äºŒä¸ª
Attention æ¨¡å—å°±æ˜¯
Cross-Attentionï¼Œç”¨äºä»ç¼–ç å™¨è¾“å‡ºä¸­è·å–ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<ul>
<li><p>ä»¥<strong>æœºå™¨ç¿»è¯‘</strong>ä¸­çš„<strong>ä¸­è¯‘è‹±ä»»åŠ¡</strong>ä¸ºä¾‹ï¼šå¯¹äºä¸­æ–‡å¥å­â€œ<strong>ä¸­å›½çš„é¦–éƒ½æ˜¯åŒ—äº¬</strong>â€ï¼Œå‡è®¾æ¨¡å‹å·²ç»ç”Ÿæˆäº†éƒ¨åˆ†è¯‘æ–‡â€œThe
capital of China isâ€ï¼Œæ­¤æ—¶éœ€è¦é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€‚</p>
<p>åœ¨è¿™ä¸€é˜¶æ®µï¼Œ<strong>è§£ç å™¨ä¸­çš„äº¤å‰æ³¨æ„åŠ›æœºåˆ¶</strong>ä¼šä½¿ç”¨<strong>å½“å‰å·²ç”Ÿæˆçš„è¯‘æ–‡â€œThe
capital of China
isâ€çš„ç¼–ç è¡¨ç¤ºä½œä¸ºæŸ¥è¯¢</strong>ï¼Œå¹¶å°†<strong>ç¼–ç å™¨å¯¹è¾“å…¥å¥å­â€œä¸­å›½çš„é¦–éƒ½æ˜¯åŒ—äº¬â€ç¼–ç è¡¨ç¤º</strong>ä½œä¸º<strong>é”®</strong>å’Œ<strong>å€¼</strong>ï¼Œé€šè¿‡è®¡ç®—<strong>æŸ¥è¯¢ä¸é”®ä¹‹é—´çš„åŒ¹é…ç¨‹åº¦</strong>ï¼Œç”Ÿæˆç›¸åº”çš„æ³¨æ„åŠ›æƒé‡ï¼Œä»¥æ­¤ä»å€¼ä¸­æå–ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŸºäºè¿™äº›ä¿¡æ¯ç”Ÿæˆä¸‹ä¸€ä¸ªå¯èƒ½çš„å•è¯ï¼ˆtokenï¼‰ï¼Œæ¯”å¦‚ï¼šâ€œBeijingâ€ã€‚</p></li>
</ul></li>
</ul>
<h3 id="å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶multi-head-attention">å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Head
Attentionï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808143810965.png" alt="image-20250808143810965">
<figcaption aria-hidden="true">image-20250808143810965</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808143822630.png" alt="image-20250808143822630">
<figcaption aria-hidden="true">image-20250808143822630</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808143845681.png" alt="image-20250808143845681">
<figcaption aria-hidden="true">image-20250808143845681</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808145725202.png" alt="image-20250808145725202">
<figcaption aria-hidden="true">image-20250808145725202</figcaption>
</figure>
<p>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å°±æ˜¯å­˜åœ¨å¤šä¸ªä¸åŒçš„æƒé‡çŸ©é˜µï¼Œå½¢æˆå¤šä¸ªçŸ©é˜µZï¼Œå†æŠŠå®ƒä»¬
<strong>æŒ‰æœ€åä¸€ç»´ï¼ˆhiddenï¼‰æ‹¼æ¥ï¼ˆconcatï¼‰â†’ åšä¸€æ¬¡çº¿æ€§å˜æ¢</strong>
å¾—åˆ°æœ€ç»ˆè¾“å‡ºã€‚</p>
<blockquote>
<p>çº¿æ€§bianâ€™hæŠŠæ‹¼æ¥åçš„å¤šå¤´ç»“æœ <code>Z_concat</code>ï¼ˆå½¢çŠ¶
batchÃ—seqÃ—d_modelï¼‰é‡æ–°<strong>çº¿æ€§æ˜ å°„</strong>å›ä¸è¾“å…¥ç›¸åŒçš„ç»´åº¦ï¼ŒåŒæ—¶è®©ç½‘ç»œå¯ä»¥<strong>å­¦ä¹ å¦‚ä½•èåˆä¸åŒå¤´çš„ä¿¡æ¯</strong>ã€‚</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1MY41137AK?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ã€Transformeræ¨¡å‹ã€‘æ›¼å¦™åŠ¨ç”»è½»æ¾å­¦ï¼Œå½¢è±¡æ¯”å–»è´¼å¥½è®°_å“”å“©å“”å“©_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1HsTyz8ECC?spm_id_from=333.788.player.switch&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">TransformeråŸç†åŠæ¶æ„ï¼šå¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶_å“”å“©å“”å“©_bilibili</a></p>
<h3 id="æ®‹å·®è¿æ¥residual-connectionå’Œå±‚å½’ä¸€åŒ–layer-normalization-layernorm">æ®‹å·®è¿æ¥ï¼ˆResidual
Connectionï¼‰å’Œå±‚å½’ä¸€åŒ–ï¼ˆLayer Normalization, LayerNormï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808150313758.png" alt="image-20250808150313758">
<figcaption aria-hidden="true">image-20250808150313758</figcaption>
</figure>
<p>åœ¨ Transformer æ¶æ„ä¸­ï¼Œ<strong>æ®‹å·®è¿æ¥</strong>ï¼ˆResidual
Connectionï¼‰ä¸<strong>å±‚å½’ä¸€åŒ–</strong>ï¼ˆLayerNormï¼‰ç»“åˆä½¿ç”¨ï¼Œç»Ÿç§°ä¸º
<strong>Add &amp; Norm</strong> æ“ä½œã€‚</p>
<h4 id="addæ®‹å·®è¿æ¥residual-connection">Addï¼ˆæ®‹å·®è¿æ¥ï¼ŒResidual
Connectionï¼‰</h4>
<p>æ®‹å·®è¿æ¥æ˜¯ä¸€ç§è·³è·ƒè¿æ¥ï¼ˆSkip
Connectionï¼‰ï¼Œå®ƒå°†å±‚çš„è¾“å…¥ç›´æ¥åŠ åˆ°è¾“å‡ºä¸Šï¼ˆè§‚å¯Ÿæ¶æ„å›¾ä¸­çš„ç®­å¤´ï¼‰ï¼Œå¯¹åº”çš„å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math display">Outputâ€„=â€„SubLayer(<em>x</em>)â€…+â€…<em>x</em></span></p>
<p>è¿™ç§è¿æ¥æ–¹å¼æœ‰æ•ˆç¼“è§£äº†<strong>æ·±å±‚ç¥ç»ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±</strong>é—®é¢˜ã€‚</p>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808151004667.png" alt="image-20250808151004667">
<figcaption aria-hidden="true">image-20250808151004667</figcaption>
</figure>
<p>åœ¨transformä¸­ï¼Œå°±æ˜¯è¾“å…¥çš„çŸ©é˜µxåŠ ä¸Šç»è¿‡æ³¨æ„åŠ›æœºåˆ¶è®¡ç®—å‡ºæ¥çš„zçŸ©é˜µ</p>
<h4 id="normå±‚å½’ä¸€åŒ–layer-normalization">Normï¼ˆå±‚å½’ä¸€åŒ–ï¼ŒLayer
Normalizationï¼‰</h4>
<p><strong>å±‚å½’ä¸€åŒ–</strong>ï¼ˆLayerNormï¼‰æ˜¯ä¸€ç§å½’ä¸€åŒ–æŠ€æœ¯ï¼Œç”¨äºæå‡è®­ç»ƒçš„ç¨³å®šæ€§å’Œæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p>
<p>å‡è®¾è¾“å…¥å‘é‡ä¸º <span class="math inline"><em>x</em>â€„=â€„(<em>x</em><sub>1</sub>,â€†<em>x</em><sub>2</sub>,â€†â€¦,â€†<em>x</em><sub><em>d</em></sub>)</span>,
LayerNorm çš„è®¡ç®—æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><p><strong>è®¡ç®—å‡å€¼å’Œæ–¹å·®</strong>ï¼š å¯¹è¾“å…¥çš„æ‰€æœ‰ç‰¹å¾æ±‚å‡å€¼ <span class="math inline"><em>Î¼</em></span> å’Œæ–¹å·® <span class="math inline"><em>Ïƒ</em><sup>2</sup></span>ï¼š</p>
<p><span class="math inline">$`
\mu = \frac{1}{d} \sum_{j=1}^{d} x_j, \quad
\sigma^2 = \frac{1}{d} \sum_{j=1}^{d} (x_j - \mu)^2
`$</span></p></li>
<li><p><strong>å½’ä¸€åŒ–å…¬å¼</strong>ï¼š å°†è¾“å…¥ç‰¹å¾ <span class="math inline"><em>xÌ‚</em><sub><em>i</em></sub></span>
è¿›è¡Œå½’ä¸€åŒ–ï¼š</p>
<p><span class="math inline">$`
\hat{x}_i = \frac{x_i - \mu}{\sqrt{\sigma^2 + \epsilon}}
`$</span></p>
<p>å…¶ä¸­, <span class="math inline"><em>Ïµ</em></span>
æ˜¯ä¸€ä¸ªå¾ˆå°çš„å¸¸æ•°ï¼ˆæ¯”å¦‚ 1e-9ï¼‰ï¼Œç”¨äºé˜²æ­¢é™¤ä»¥é›¶çš„æƒ…å†µã€‚</p></li>
<li><p><strong>å¼•å…¥å¯å­¦ä¹ å‚æ•°</strong>ï¼š å½’ä¸€åŒ–åçš„è¾“å‡ºä¹˜ä»¥ <span class="math inline"><em>Î³</em></span> å¹¶åŠ ä¸Š <span class="math inline"><em>Î²</em></span>, å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math inline">$`
\text{Output} = \gamma \hat{x} + \beta
`$</span></p>
<p>å…¶ä¸­ <span class="math inline"><em>Î³</em></span> å’Œ <span class="math inline"><em>Î²</em></span>
æ˜¯å¯å­¦ä¹ çš„å‚æ•°ï¼Œç”¨äºè¿›ä¸€æ­¥è°ƒæ•´å½’ä¸€åŒ–åçš„è¾“å‡ºã€‚</p></li>
</ol>
<h3 id="å‰é¦ˆç¥ç»ç½‘ç»œ-position-wise-feed-forward-networksffn">å‰é¦ˆç¥ç»ç½‘ç»œ
Position-wise Feed-Forward Networksï¼ˆFFNï¼‰</h3>
<p>åœ¨ Transformer ä¸­ï¼Œå‰é¦ˆç½‘ç»œå±‚ï¼ˆFeed-Forward
Networkï¼ŒFFNï¼‰çš„ä½œç”¨å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€å¥è¯ï¼š
<strong>â€œå¯¹æ¯ä¸ªä½ç½®çš„å‘é‡è¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œå¢åŠ æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚â€</strong></p>
<p>åœ¨ç¼–ç å™¨-è§£ç å™¨æ¶æ„ä¸­ï¼Œå¦ä¸€ä¸ªçœ‹èµ·æ¥â€œå¤§ä¸€ç‚¹â€çš„æ¨¡å—å°±æ˜¯ Feed
Forwardï¼Œå®ƒåœ¨æ¯ä¸ªä½ç½® <span class="math inline"><em>i</em></span>
ä¸Šçš„è®¡ç®—å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p>
<p><span class="math display">FFN(<em>x</em><sub><em>i</em></sub>)â€„=â€„max(0,â€†<em>x</em><sub><em>i</em></sub><em>W</em><sub>1</sub>â€…+â€…<em>b</em><sub>1</sub>)<em>W</em><sub>2</sub>â€…+â€…<em>b</em><sub>2</sub></span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="math inline"><em>x</em><sub><em>i</em></sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>model</sub></sup></span>
è¡¨ç¤ºç¬¬ <span class="math inline"><em>i</em></span>
ä¸ªä½ç½®çš„è¾“å…¥å‘é‡ã€‚</li>
<li><span class="math inline"><em>W</em><sub>1</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>model</sub>â€…Ã—â€…<em>d</em><sub>ff</sub></sup></span>
å’Œ <span class="math inline"><em>W</em><sub>2</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>ff</sub>â€…Ã—â€…<em>d</em><sub>model</sub></sup></span>
æ˜¯ä¸¤ä¸ªçº¿æ€§å˜æ¢çš„æƒé‡çŸ©é˜µã€‚</li>
<li><span class="math inline"><em>b</em><sub>1</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>ff</sub></sup></span>
å’Œ <span class="math inline"><em>b</em><sub>2</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>model</sub></sup></span>
æ˜¯å¯¹åº”çš„åç½®å‘é‡ã€‚</li>
<li><span class="math inline">max(0,â€†â‹…)</span> æ˜¯ <strong>ReLU
æ¿€æ´»å‡½æ•°</strong>ï¼Œç”¨äºå¼•å…¥éçº¿æ€§ã€‚</li>
</ul>
<h3 id="å¤§æ¨¡å‹å‘å±•æ ‘">å¤§æ¨¡å‹å‘å±•æ ‘</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807171237889.png" alt="image-20250807171237889">
<figcaption aria-hidden="true">image-20250807171237889</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807173520481.png" alt="image-20250807173520481">
<figcaption aria-hidden="true">image-20250807173520481</figcaption>
</figure>
<h3 id="é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹">é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹</h3>
<p>é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆPLMï¼‰æ˜¯ä¸€ç§é€šè¿‡å¤§é‡æ–‡æœ¬æ•°æ®è¿›è¡Œæ— ç›‘ç£æˆ–å¼±ç›‘ç£è®­ç»ƒçš„è¯­è¨€æ¨¡å‹ï¼Œç›®çš„æ˜¯å­¦ä¹ è¯­è¨€çš„é€šç”¨è¡¨ç¤ºï¼ˆå³è¯­è¨€çš„æ¨¡å¼ã€è¯­æ³•ã€è¯­ä¹‰ç­‰ï¼‰ã€‚è¿™äº›æ¨¡å‹é€šå¸¸åœ¨å¤§è§„æ¨¡æ–‡æœ¬æ•°æ®ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œç„¶åå¯ä»¥è¢«å¾®è°ƒï¼ˆFine
- tuningï¼‰ä»¥é€‚åº”å„ç§ä¸‹æ¸¸ä»»åŠ¡ï¼Œå¦‚æ–‡æœ¬åˆ†ç±»ã€é—®ç­”ã€å‘½åå®ä½“è¯†åˆ«ç­‰ã€‚</p>
<p>é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨å¤§é‡çš„æ— æ ‡æ³¨æ–‡æœ¬æ•°æ®æ¥å­¦ä¹ è¯­è¨€çš„é€šç”¨ç‰¹å¾ï¼Œä»è€Œä¸ºå„ç§è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡æä¾›å¼ºå¤§çš„è¯­è¨€ç†è§£èƒ½åŠ›ã€‚é¢„è®­ç»ƒæ¨¡å‹å¯ä»¥æ˜¾è‘—æé«˜ä»»åŠ¡çš„æ€§èƒ½ï¼Œå‡å°‘å¯¹æ ‡æ³¨æ•°æ®çš„ä¾èµ–ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¿«é€Ÿé€‚åº”æ–°çš„ä»»åŠ¡ã€‚</p>
<h4 id="bertæ¨¡å‹encoder-only-plm">BERTæ¨¡å‹ï¼ˆEncoder-only PLMï¼‰</h4>
<p>é’ˆå¯¹ Encoderã€Decoder çš„ç‰¹ç‚¹ï¼Œå¼•å…¥ ELMo
çš„é¢„è®­ç»ƒæ€è·¯ï¼Œå¼€å§‹å‡ºç°ä¸åŒçš„ã€å¯¹ Transformer
è¿›è¡Œä¼˜åŒ–çš„æ€è·¯ã€‚ä¾‹å¦‚ï¼Œ<strong>Google ä»…é€‰æ‹©äº† Encoder
å±‚</strong>ï¼Œé€šè¿‡å°† Encoder
å±‚è¿›è¡Œå †å ï¼Œå†æå‡ºä¸åŒçš„é¢„è®­ç»ƒä»»åŠ¡-æ©ç è¯­è¨€æ¨¡å‹ï¼ˆMasked Language
Modelï¼ŒMLMï¼‰ï¼Œæ‰“é€ äº†ä¸€ç»Ÿè‡ªç„¶è¯­è¨€ç†è§£ï¼ˆNatural Language
Understandingï¼ŒNLUï¼‰ä»»åŠ¡çš„ä»£è¡¨æ¨¡å‹â€”â€”<strong>BERT</strong>ã€‚</p>
<p>BERTï¼Œå…¨åä¸º Bidirectional Encoder Representations from
Transformersï¼Œæ˜¯ç”± Google å›¢é˜Ÿåœ¨
2018å¹´å‘å¸ƒçš„é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ã€‚è¯¥æ¨¡å‹å‘å¸ƒäºè®ºæ–‡ã€ŠBERT: Pre-training of Deep
Bidirectional Transformers for Language Understandingã€‹ï¼Œå®ç°äº†åŒ…æ‹¬
GLUEã€MultiNLI ç­‰ä¸ƒä¸ªè‡ªç„¶è¯­è¨€å¤„ç†è¯„æµ‹ä»»åŠ¡çš„æœ€ä¼˜æ€§èƒ½ï¼ˆState Of The
Artï¼ŒSOTAï¼‰ï¼Œå ªç§°é‡Œç¨‹ç¢‘å¼çš„æˆæœã€‚</p>
<h4 id="t5encoder-decoder-plm">T5ï¼ˆEncoder-Decoder PLMï¼‰</h4>
<p>BERT ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ MLM
ä»»åŠ¡å’Œä¸‹æ¸¸ä»»åŠ¡å¾®è°ƒçš„ä¸ä¸€è‡´æ€§ï¼Œä»¥åŠæ— æ³•å¤„ç†è¶…è¿‡æ¨¡å‹è®­ç»ƒé•¿åº¦çš„è¾“å…¥ç­‰é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œç ”ç©¶è€…ä»¬æå‡ºäº†
<strong>Encoder-Decoder æ¨¡å‹</strong>ï¼Œé€šè¿‡å¼•å…¥ Decoder
éƒ¨åˆ†æ¥è§£å†³è¿™äº›é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿä¸º NLP é¢†åŸŸå¸¦æ¥äº†æ–°çš„æ€è·¯å’Œæ–¹æ³•ã€‚</p>
<p><strong>T5ï¼ˆText-To-Text Transfer Transformerï¼‰æ˜¯ç”± Google
æå‡ºçš„ä¸€ç§é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹</strong>ï¼Œé€šè¿‡å°†æ‰€æœ‰ NLP
ä»»åŠ¡ç»Ÿä¸€è¡¨ç¤ºä¸ºæ–‡æœ¬åˆ°æ–‡æœ¬çš„è½¬æ¢é—®é¢˜ï¼Œå¤§å¤§ç®€åŒ–äº†æ¨¡å‹è®¾è®¡å’Œä»»åŠ¡å¤„ç†ã€‚T5
åŸºäº Transformer
æ¶æ„ï¼ŒåŒ…å«ç¼–ç å™¨å’Œè§£ç å™¨ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä½¿ç”¨è‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œå¤šå¤´æ³¨æ„åŠ›æ•æ‰å…¨å±€ä¾èµ–å…³ç³»ï¼Œåˆ©ç”¨ç›¸å¯¹ä½ç½®ç¼–ç å¤„ç†é•¿åºåˆ—ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œå¹¶åœ¨æ¯å±‚ä¸­åŒ…å«å‰é¦ˆç¥ç»ç½‘ç»œè¿›ä¸€æ­¥å¤„ç†ç‰¹å¾ã€‚</p>
<h4 id="llamaæ¨¡å‹decoder-only-plm">LLamaæ¨¡å‹ï¼ˆDecoder-Only PLMï¼‰</h4>
<p>LLaMAæ¨¡å‹æ˜¯ç”±Metaï¼ˆå‰Facebookï¼‰å¼€å‘çš„ä¸€ç³»åˆ—å¤§å‹é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ã€‚ä»LLaMA-1åˆ°LLaMA-3ï¼ŒLLaMAç³»åˆ—æ¨¡å‹å±•ç¤ºäº†å¤§è§„æ¨¡é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„æ¼”è¿›åŠå…¶åœ¨å®é™…åº”ç”¨ä¸­çš„æ˜¾è‘—æ½œåŠ›ã€‚</p>
<h4 id="gptæ¨¡å‹decoder-only-plm">GPTæ¨¡å‹ï¼ˆDecoder-Only PLMï¼‰</h4>
<p>GPTï¼Œå³ Generative Pre-Training Language Modelï¼Œæ˜¯ç”± OpenAI å›¢é˜Ÿäº
2018å¹´å‘å¸ƒçš„é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ã€‚è™½ç„¶å­¦ç•Œæ™®éè®¤å¯ BERT
ä½œä¸ºé¢„è®­ç»ƒè¯­è¨€æ¨¡å‹æ—¶ä»£çš„ä»£è¡¨ï¼Œä½†é¦–å…ˆæ˜ç¡®æå‡º<strong>é¢„è®­ç»ƒ-å¾®è°ƒæ€æƒ³çš„æ¨¡å‹</strong>å…¶å®æ˜¯
GPTã€‚</p>
<p>GPT
æå‡ºäº†é€šç”¨é¢„è®­ç»ƒçš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯åœ¨æµ·é‡æ— ç›‘ç£è¯­æ–™ä¸Šé¢„è®­ç»ƒï¼Œè¿›è€Œåœ¨æ¯ä¸ªç‰¹å®šä»»åŠ¡ä¸Šè¿›è¡Œå¾®è°ƒï¼Œä»è€Œå®ç°è¿™äº›ä»»åŠ¡çš„å·¨å¤§æ”¶ç›Šã€‚è™½ç„¶åœ¨å‘å¸ƒä¹‹åˆï¼Œç”±äºæ€§èƒ½ç•¥è¾“äºä¸ä¹…åå‘å¸ƒçš„
BERTï¼Œæ²¡èƒ½å–å¾—è½°åŠ¨æ€§æˆæœï¼Œä¹Ÿæ²¡èƒ½è®© GPT æ‰€ä½¿ç”¨çš„ <strong>Decoder-Only
æ¶æ„</strong>æˆä¸ºå­¦ç•Œç ”ç©¶çš„ä¸»æµï¼Œä½† OpenAI
å›¢é˜Ÿåšå®šåœ°é€‰æ‹©äº†ä¸æ–­æ‰©å¤§é¢„è®­ç»ƒæ•°æ®ã€å¢åŠ æ¨¡å‹å‚æ•°ï¼Œåœ¨ GPT
æ¶æ„ä¸Šä¸æ–­ä¼˜åŒ–ï¼Œæœ€ç»ˆåœ¨ 2020å¹´å‘å¸ƒçš„ GPT-3 æˆå°±äº† LLM æ—¶ä»£çš„åŸºç¡€ï¼Œå¹¶ä»¥
GPT-3 ä¸ºåŸºåº§æ¨¡å‹çš„ ChatGPT æˆåŠŸæ‰“å¼€æ–°æ—¶ä»£çš„å¤§é—¨ï¼Œæˆä¸º LLM
æ—¶ä»£çš„æœ€å¼ºç«äº‰è€…ä¹Ÿæ˜¯ç›®å‰çš„æœ€å¤§èµ¢å®¶ã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://transformers.run/">Hello! Â·
Transformerså¿«é€Ÿå…¥é—¨</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/jsksxs360/How-to-use-Transformers">jsksxs360/How-to-use-Transformers:
Transformers åº“å¿«é€Ÿå…¥é—¨æ•™ç¨‹</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Hoper-J/AI-Guide-and-Demos-zh_CN">Hoper-J/AI-Guide-and-Demos-zh_CN:
è¿™æ˜¯ä¸€ä»½å…¥é—¨AI/LLMå¤§æ¨¡å‹çš„é€æ­¥æŒ‡å—ï¼ŒåŒ…å«æ•™ç¨‹å’Œæ¼”ç¤ºä»£ç ï¼Œå¸¦ä½ ä»APIèµ°è¿›æœ¬åœ°å¤§æ¨¡å‹éƒ¨ç½²å’Œå¾®è°ƒï¼Œä»£ç æ–‡ä»¶ä¼šæä¾›Kaggleæˆ–Colabåœ¨çº¿ç‰ˆæœ¬ï¼Œå³ä¾¿æ²¡æœ‰æ˜¾å¡ä¹Ÿå¯ä»¥è¿›è¡Œå­¦ä¹ ã€‚é¡¹ç›®ä¸­è¿˜å¼€è®¾äº†ä¸€ä¸ªå°å‹çš„ä»£ç æ¸¸ä¹åœºğŸ¡ï¼Œä½ å¯ä»¥å°è¯•åœ¨é‡Œé¢å®éªŒä¸€äº›æœ‰æ„æ€çš„AIè„šæœ¬ã€‚åŒæ—¶ï¼ŒåŒ…å«æå®æ¯…
(HUNG-YI LEEï¼‰2024ç”Ÿæˆå¼äººå·¥æ™ºèƒ½å¯¼è®ºè¯¾ç¨‹çš„å®Œæ•´ä¸­æ–‡é•œåƒä½œä¸šã€‚</a></p>
<p><a target="_blank" rel="noopener" href="https://datawhalechina.github.io/happy-llm/#/">Happy-LLM</a></p>
<p><a target="_blank" rel="noopener" href="https://gengzhige.ai/video.html">æ¢—ç›´å“¥</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1RBdTYxENw/?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">90%äººä¸çŸ¥é“çš„LLMé»‘ç§‘æŠ€ï¼šæ‹†è§£Transformerå¦‚ä½•åƒé€å…¨ç½‘çŸ¥è¯†ï¼_å“”å“©å“”å“©_bilibili</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">MCP å­¦ä¹ ç¬”è®°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-27 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-27T00:00:00+08:00">2025-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-15 09:25:54" itemprop="dateModified" datetime="2025-08-15T09:25:54+08:00">2025-08-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä»€ä¹ˆæ˜¯-mcp">ä»€ä¹ˆæ˜¯ MCPï¼Ÿ</h3>
<ul>
<li><strong>å…¨ç§°</strong>ï¼šModel Context Protocol</li>
<li><strong>ä½œç”¨</strong>ï¼šè®© AI åŠ©æ‰‹ï¼ˆå¦‚ Claudeã€Cline
ç­‰ï¼‰åœ¨å¯¹è¯è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼ˆToolï¼‰å®Œæˆå¤æ‚ä»»åŠ¡ï¼ˆè¯»å†™æ–‡ä»¶ã€æŸ¥è¯¢æ•°æ®åº“ã€è°ƒç”¨
API ç­‰ï¼‰ã€‚</li>
<li><strong>ç»„æˆ</strong>ï¼š
<ol type="1">
<li><strong>MCP Host</strong>ï¼ˆå®¿ä¸»ï¼Œå¦‚ Clineã€Claude Desktopï¼‰</li>
<li><strong>MCP Server</strong>ï¼ˆæä¾› Tool çš„åå°æœåŠ¡ï¼‰</li>
<li><strong>Tool</strong>ï¼ˆå…·ä½“åŠŸèƒ½å•å…ƒï¼Œå¦‚ <code>read_file</code>,
<code>exec_command</code> ç­‰ï¼‰</li>
</ol></li>
</ul>
<h3 id="æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°">æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°</h3>
<ul>
<li><strong>MCP Server</strong>
<ul>
<li>ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œæä¾› 1-N ä¸ª Toolã€‚</li>
<li>å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ç¼–å†™ï¼Œåªè¦æš´éœ²æ ‡å‡† MCP æ¥å£ã€‚</li>
</ul></li>
<li><strong>Tool</strong>
<ul>
<li>æœ€å°æ‰§è¡Œå•å…ƒï¼Œå¿…é¡»åŒ…å«ï¼š
<ul>
<li>nameï¼ˆå”¯ä¸€ï¼‰</li>
<li>descriptionï¼ˆè®© LLM ç†è§£ä½•æ—¶è°ƒç”¨ï¼‰</li>
<li>input schemaï¼ˆå‚æ•°ç»“æ„ï¼ŒJSON Schemaï¼‰</li>
</ul></li>
</ul></li>
<li><strong>äº¤äº’æµç¨‹ï¼ˆé‡ç‚¹ï¼‰</strong>
<ul>
<li>åœ¨å¯åŠ¨mcp serveræ—¶ï¼Œserverå°†toolä¿¡æ¯ä¼ é€ç»™host</li>
<li>ç”¨æˆ·åœ¨ Host è¾“å…¥è‡ªç„¶è¯­è¨€éœ€æ±‚ã€‚</li>
<li>Host å°†éœ€æ±‚ + å¯ç”¨ Tool åˆ—è¡¨å‘ç»™ LLMã€‚</li>
<li>LLM åˆ¤æ–­è°ƒç”¨å“ªä¸ª Toolï¼Œå¹¶å¡«å……å‚æ•°ã€‚</li>
<li>Host é€šè¿‡ MCP åè®®å‘å¯¹åº” Server å‘é€è¯·æ±‚ã€‚</li>
<li>Server æ‰§è¡Œ Tool å¹¶è¿”å›ç»“æœã€‚</li>
<li>Host å°†ç»“æœåˆå¹¶ä¸Šä¸‹æ–‡ï¼Œç»§ç»­å¯¹è¯ã€‚</li>
</ul></li>
</ul>
<h3 id="mcpå’Œfuction-callingçš„åŒºåˆ«">mcpå’Œfuction callingçš„åŒºåˆ«</h3>
<table>
<colgroup>
<col style="width: 7%">
<col style="width: 46%">
<col style="width: 46%">
</colgroup>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>Function Callingï¼ˆFCï¼‰</th>
<th>MCPï¼ˆModel Context Protocolï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœ¬è´¨</td>
<td><strong>èƒ½åŠ›</strong> â€”â€”
æŸä¸ªå¤§æ¨¡å‹åŸç”Ÿå°±å¸¦çš„ä¸€ç§ã€Œè°ƒç”¨å‡½æ•°ã€åŠŸèƒ½</td>
<td><strong>åè®®</strong> â€”â€” å®šä¹‰ AI
ä¸å¤–éƒ¨ä¸–ç•Œå¦‚ä½•é•¿æœŸã€æ ‡å‡†ã€å¯å¤ç”¨åœ°äº¤äº’</td>
</tr>
<tr>
<td>å·¥ä½œæ–¹å¼</td>
<td>æ¨¡å‹åœ¨ä¸€æ¬¡æ¨ç†é‡Œ<strong>ä¸»åŠ¨</strong>å†³å®šè¦è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œå¹¶åå‡ºç»“æ„åŒ–å‚æ•°</td>
<td>é€šè¿‡ã€Œå®¢æˆ·ç«¯-æœåŠ¡å™¨ã€æ¶æ„ï¼Œç”± MCP Server
<strong>è¢«åŠ¨</strong>ç­‰å¾…æ¨¡å‹æˆ– Agent çš„è¯·æ±‚</td>
</tr>
<tr>
<td>æ˜¯å¦æ ‡å‡†åŒ–</td>
<td>å¦ã€‚OpenAIã€Anthropicã€ç™¾åº¦ç­‰å„å®¶æ¥å£æ ¼å¼ä¸åŒ</td>
<td>æ˜¯ã€‚ç»Ÿä¸€ JSON-RPC 2.0 åè®®ï¼Œè·¨æ¨¡å‹é€šç”¨</td>
</tr>
<tr>
<td>ä¸Šä¸‹æ–‡ç®¡ç†</td>
<td>å•æ¬¡è°ƒç”¨ï¼Œæ— çŠ¶æ€ï¼›å¤æ‚å¤šè½®ä»»åŠ¡éœ€è‡ªå·±ç»´æŠ¤</td>
<td>åè®®å±‚é¢æ”¯æŒä¼šè¯ã€çŠ¶æ€ã€é•¿é“¾è·¯ä»»åŠ¡</td>
</tr>
<tr>
<td>å¤ç”¨/å…±äº«</td>
<td>å‡½æ•°ä»£ç å¾€å¾€ç´§è€¦åˆåœ¨é¡¹ç›®é‡Œï¼Œæ¢æ¨¡å‹å°±å¾—é‡å†™</td>
<td>ä¸€æ¬¡å†™æˆ MCP Serverï¼Œå¯è¢«ä»»ä½•æ”¯æŒ MCP çš„æ¨¡å‹/IDE/Agent ç›´æ¥æ’ç”¨</td>
</tr>
</tbody>
</table>
<p>ä¸€å¥è¯æ€»ç»“ï¼š <strong>Function Calling
æ˜¯ã€ŒæŸä¸ªæ¨¡å‹è‡ªå¸¦çš„å¿«æ·æŒ‡ä»¤ã€ï¼ŒMCP
æ˜¯ã€Œè®©ä»»ä½•æ¨¡å‹éƒ½èƒ½ç»Ÿä¸€æ’æ‹”å·¥å…·çš„å·¥ä¸šæ ‡å‡†ã€ã€‚</strong> äºŒè€…å¹¶éäº’æ–¥â€”â€”MCP
çš„å®ç°é‡Œä»ç„¶å¯ä»¥ç”¨ Function Calling
å»è§¦å‘å…·ä½“å‡½æ•°ï¼Œä½†å®ƒæŠŠã€Œæ€ä¹ˆæè¿°å·¥å…·ã€æ€ä¹ˆå‘ç°å·¥å…·ã€æ€ä¹ˆä¿æŒä¼šè¯ã€è¿™äº›äº‹éƒ½æ ‡å‡†åŒ–äº†ï¼Œä»è€Œè§£å†³äº†
FC å¸¦æ¥çš„ç¢ç‰‡åŒ–ã€éš¾ç»´æŠ¤ã€éš¾å…±äº«çš„é—®é¢˜ ã€‚</p>
<h3 id="å®‰è£…mcp">å®‰è£…mcp</h3>
<p>åœ¨mcp serverå¸‚åœºæŸ¥æ‰¾è‡ªå·±æƒ³ç”¨çš„mcpæœåŠ¡ï¼Œå¦‚<a target="_blank" rel="noopener" href="https://mcp.so/server/fetch/modelcontextprotocol?tab=content">Fetch
MCP Server</a></p>
<p>å¤åˆ¶mcpé…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;mcpServers&quot;: &#123;</span><br><span class="line">    &quot;fetch&quot;: &#123;</span><br><span class="line">      &quot;command&quot;: &quot;uvx&quot;,</span><br><span class="line">      &quot;args&quot;: [</span><br><span class="line">        &quot;mcp-server-fetch&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨mcp host ä¸­å®‰è£…ï¼Œå¦‚trae</p>
<p>hostä¼šè‡ªåŠ¨å®Œæˆå¯¹mcpçš„é…ç½®</p>
<h3 id="åˆ›å»ºä¸€ä¸ªmcp-server">åˆ›å»ºä¸€ä¸ªmcp server</h3>
<p>åˆå§‹åŒ–é¡¹ç›®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uv init weather</span><br><span class="line"></span><br><span class="line">uv sync</span><br><span class="line"></span><br><span class="line">source .venv/bin/activate </span><br><span class="line"></span><br><span class="line">#æ·»åŠ ä¾èµ–</span><br><span class="line">uv add &quot;mcp[cli]&quot; httpx</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºweather.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å…¥ç±»å‹æç¤ºæ¨¡å—ï¼Œç”¨äºç±»å‹æ³¨è§£</span><br><span class="line">from typing import Any</span><br><span class="line"></span><br><span class="line"># å¯¼å…¥httpxåº“ï¼Œç”¨äºå‘é€HTTPè¯·æ±‚</span><br><span class="line">import httpx</span><br><span class="line"></span><br><span class="line"># ä»mcp.server.fastmcpæ¨¡å—å¯¼å…¥FastMCPç±»</span><br><span class="line"># FastMCPæ˜¯ä¸€ä¸ªå¿«é€Ÿæ„å»ºMCPï¼ˆModel Control Protocolï¼‰æœåŠ¡å™¨çš„æ¡†æ¶</span><br><span class="line">from mcp.server.fastmcp import FastMCP</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºFastMCPå®ä¾‹ï¼Œå‘½åä¸º&quot;weather&quot;ï¼Œæ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºERRORï¼ˆåªæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼‰</span><br><span class="line">mcp = FastMCP(&quot;weather&quot;, log_level=&quot;ERROR&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># å¸¸é‡å®šä¹‰</span><br><span class="line"># NWSï¼ˆNational Weather Serviceï¼‰APIçš„åŸºç¡€URL</span><br><span class="line">NWS_API_BASE = &quot;https://api.weather.gov&quot;</span><br><span class="line"># ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†åº”ç”¨ç¨‹åº</span><br><span class="line">USER_AGENT = &quot;weather-app/1.0&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def make_nws_request(url: str) -&gt; dict[str, Any] | None:</span><br><span class="line">    &quot;&quot;&quot;å‘NWS APIå‘èµ·è¯·æ±‚å¹¶å¤„ç†é”™è¯¯ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        url: è¦è¯·æ±‚çš„API URL</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æˆåŠŸæ—¶è¿”å›è§£æåçš„JSONæ•°æ®å­—å…¸ï¼Œå¤±è´¥æ—¶è¿”å›None</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # è®¾ç½®è¯·æ±‚å¤´ä¿¡æ¯</span><br><span class="line">    headers = &#123;</span><br><span class="line">        &quot;User-Agent&quot;: USER_AGENT,           # ç”¨æˆ·ä»£ç†æ ‡è¯†</span><br><span class="line">        &quot;Accept&quot;: &quot;application/geo+json&quot;    # æ¥å—çš„æ•°æ®æ ¼å¼</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # åˆ›å»ºå¼‚æ­¥HTTPå®¢æˆ·ç«¯</span><br><span class="line">    async with httpx.AsyncClient() as client:</span><br><span class="line">        try:</span><br><span class="line">            # å‘èµ·GETè¯·æ±‚ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’</span><br><span class="line">            response = await client.get(url, headers=headers, timeout=30.0)</span><br><span class="line">            # å¦‚æœå“åº”çŠ¶æ€ç ä¸æ˜¯2xxï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            # è¿”å›è§£æåçš„JSONæ•°æ®</span><br><span class="line">            return response.json()</span><br><span class="line">        except Exception:</span><br><span class="line">            # æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œè¿”å›Noneè¡¨ç¤ºè¯·æ±‚å¤±è´¥</span><br><span class="line">            return None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def format_alert(feature: dict) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;å°†è­¦æŠ¥æ•°æ®æ ¼å¼åŒ–ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        feature: åŒ…å«è­¦æŠ¥ä¿¡æ¯çš„å­—å…¸</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„è­¦æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # è·å–è­¦æŠ¥å±æ€§</span><br><span class="line">    props = feature[&quot;properties&quot;]</span><br><span class="line">    # æ ¼å¼åŒ–è­¦æŠ¥ä¿¡æ¯ï¼Œä½¿ç”¨getæ–¹æ³•æä¾›é»˜è®¤å€¼é˜²æ­¢é”®ä¸å­˜åœ¨</span><br><span class="line">    return f&quot;&quot;&quot;</span><br><span class="line">äº‹ä»¶: &#123;props.get(&#x27;event&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">åŒºåŸŸ: &#123;props.get(&#x27;areaDesc&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">ä¸¥é‡ç¨‹åº¦: &#123;props.get(&#x27;severity&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">æè¿°: &#123;props.get(&#x27;description&#x27;, &#x27;æ— æè¿°ä¿¡æ¯&#x27;)&#125;</span><br><span class="line">æŒ‡ç¤º: &#123;props.get(&#x27;instruction&#x27;, &#x27;æ— å…·ä½“æŒ‡ç¤º&#x27;)&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨@mcp.tool()è£…é¥°å™¨å°†å‡½æ•°æ³¨å†Œä¸ºMCPå·¥å…·</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_alerts(state: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šç¾å›½å·çš„å¤©æ°”è­¦æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        state: ä¸¤ä¸ªå­—æ¯çš„ç¾å›½å·ä»£ç ï¼ˆä¾‹å¦‚ï¼šCA, NYï¼‰</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„è­¦æŠ¥ä¿¡æ¯å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # æ„å»ºè·å–å·è­¦æŠ¥çš„URL</span><br><span class="line">    url = f&quot;&#123;NWS_API_BASE&#125;/alerts/active/area/&#123;state&#125;&quot;</span><br><span class="line">    # å‘èµ·APIè¯·æ±‚è·å–æ•°æ®</span><br><span class="line">    data = await make_nws_request(url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ</span><br><span class="line">    if not data or &quot;features&quot; not in data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è­¦æŠ¥æˆ–æœªæ‰¾åˆ°è­¦æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦æœ‰è­¦æŠ¥</span><br><span class="line">    if not data[&quot;features&quot;]:</span><br><span class="line">        return &quot;è¯¥å·æ— æ´»åŠ¨è­¦æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # æ ¼å¼åŒ–æ‰€æœ‰è­¦æŠ¥</span><br><span class="line">    alerts = [format_alert(feature) for feature in data[&quot;features&quot;]]</span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰è­¦æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(alerts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># æ³¨å†Œä¸ºMCPå·¥å…·çš„å¤©æ°”é¢„æŠ¥å‡½æ•°</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_forecast(latitude: float, longitude: float) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”é¢„æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        latitude: ä½ç½®çš„çº¬åº¦</span><br><span class="line">        longitude: ä½ç½®çš„ç»åº¦</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„å¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # é¦–å…ˆè·å–é¢„æŠ¥ç½‘æ ¼ç«¯ç‚¹</span><br><span class="line">    points_url = f&quot;&#123;NWS_API_BASE&#125;/points/&#123;latitude&#125;,&#123;longitude&#125;&quot;</span><br><span class="line">    points_data = await make_nws_request(points_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥ç‚¹æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not points_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–æ­¤ä½ç½®çš„é¢„æŠ¥æ•°æ®ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # ä»ç‚¹å“åº”ä¸­è·å–é¢„æŠ¥URL</span><br><span class="line">    forecast_url = points_data[&quot;properties&quot;][&quot;forecast&quot;]</span><br><span class="line">    forecast_data = await make_nws_request(forecast_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥é¢„æŠ¥æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not forecast_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è¯¦ç»†é¢„æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # å°†æ—¶é—´æ®µæ ¼å¼åŒ–ä¸ºå¯è¯»çš„é¢„æŠ¥</span><br><span class="line">    periods = forecast_data[&quot;properties&quot;][&quot;periods&quot;]</span><br><span class="line">    forecasts = []</span><br><span class="line">    # åªæ˜¾ç¤ºæ¥ä¸‹æ¥çš„5ä¸ªæ—¶é—´æ®µ</span><br><span class="line">    for period in periods[:5]:</span><br><span class="line">        forecast = f&quot;&quot;&quot;</span><br><span class="line">&#123;period[&#x27;name&#x27;]&#125;:</span><br><span class="line">æ¸©åº¦: &#123;period[&#x27;temperature&#x27;]&#125;Â°&#123;period[&#x27;temperatureUnit&#x27;]&#125;</span><br><span class="line">é£åŠ›: &#123;period[&#x27;windSpeed&#x27;]&#125; &#123;period[&#x27;windDirection&#x27;]&#125;</span><br><span class="line">é¢„æŠ¥: &#123;period[&#x27;detailedForecast&#x27;]&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        forecasts.append(forecast)</span><br><span class="line"></span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰é¢„æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(forecasts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ç¨‹åºå…¥å£ç‚¹</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    # åˆå§‹åŒ–å¹¶è¿è¡ŒæœåŠ¡å™¨ï¼Œä½¿ç”¨stdioä¼ è¾“æ–¹å¼</span><br><span class="line">    mcp.run(transport=&#x27;stdio&#x27;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><span class="citation" data-cites="mcp.tool">@mcp.tool</span>()å¯ä»¥å°†å‡½æ•°å†…çš„å­—ç¬¦ä¸²ï¼Œå‚æ•°ç±»å‹ç­‰ä¿¡æ¯ä¼ ç»™å¤§æ¨¡å‹ï¼Œä»¥ä¾›å¤§æ¨¡å‹å†³å®šä½•æ—¶è°ƒç”¨è¿™ä¸ªtool</p>
<p>mcp.run(transport=â€˜stdioâ€™)è¯´æ˜mcp
serverå’Œhostçš„ä¼ è¾“æ–¹å¼æ˜¯è¾“å…¥å’Œè¾“å‡º</p>
</blockquote>
<p>mcp server é…ç½®ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;weather&quot;: &#123;</span><br><span class="line">    &quot;disabled&quot;: false,</span><br><span class="line">    &quot;timeout&quot;: 60,</span><br><span class="line">    &quot;command&quot;: &quot;uv&quot;,</span><br><span class="line">    &quot;args&quot;: [</span><br><span class="line">      &quot;--directory&quot;,</span><br><span class="line">      &quot;/Users/joeygreen/PycharmProjects/weather&quot;,</span><br><span class="line">      &quot;run&quot;,</span><br><span class="line">      &quot;weather.py&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;transportType&quot;: &quot;stdio&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>â€œdisabledâ€: falseè¡¨ç¤ºè¯¥æœåŠ¡æ˜¯å¦è¢«ç¦ç”¨ã€‚<code>false</code>
è¡¨ç¤ºè¯¥æœåŠ¡æ˜¯å¯ç”¨çŠ¶æ€ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p>â€œtimeoutâ€: 60è®¾ç½®è¯¥æœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚</p>
<p>â€œcommandâ€: â€œuvâ€æŒ‡å®šæ‰§è¡Œè¯¥æœåŠ¡æ—¶ä½¿ç”¨çš„å‘½ä»¤ã€‚</p>
<p>â€œargsâ€å‡ºäº†æ‰§è¡Œ <code>command</code> æ—¶éœ€è¦ä¼ é€’çš„å‚æ•°ã€‚</p>
<p>â€œtransportTypeâ€: â€œstdioâ€æŒ‡å®šæœåŠ¡çš„é€šä¿¡æ–¹å¼ã€‚<code>stdio</code>
è¡¨ç¤ºæ ‡å‡†è¾“å…¥è¾“å‡ºæµï¼ˆStandard Input Outputï¼‰ï¼Œé€šå¸¸ç”¨äºè¿›ç¨‹é—´é€šä¿¡ã€‚</p>
</blockquote>
<h3 id="è§£æmcp-serverä¸hostçš„é€šä¿¡">è§£æmcp serverä¸hostçš„é€šä¿¡</h3>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727154739013.png" alt="image-20250727154739013">
<figcaption aria-hidden="true">image-20250727154739013</figcaption>
</figure>
<p>è¾“å…¥ä¸ºhostå¯¹serverå‘é€ï¼Œè¾“å‡ºä¸ºserverå¯¹hostå‘é€ï¼Œä»¥ä¸‹å°†åˆ—ä¸¾å‡ ä¸ªé‡è¦çš„è¯´æ˜</p>
<p>è¾“å…¥ä¸­ï¼š<code>method</code>å­—æ®µä¸ºhostå‘Šè¯‰serveræ¥ä¸‹æ¥è¦å¹²ä»€ä¹ˆï¼Œå¦‚<strong>åˆå§‹åŒ–
(Initialization)</strong>ï¼Œ<strong>é€šçŸ¥å·²åˆå§‹åŒ–
(Notification)</strong>ï¼Œ<strong>æŸ¥è¯¢å¯ç”¨å·¥å…· (Listing
Tools)</strong>ï¼Œ<strong>è°ƒç”¨å·¥å…· (Calling a Tool)</strong></p>
<p><code>protocolVersion</code>è¯´æ˜äº†mcpä½¿ç”¨çš„åè®®ç‰ˆæœ¬</p>
<p>ä»¥ä¸‹è§serverè¿”å›çš„toolä¿¡æ¯ï¼Œå…¶ä¸­çš„ä¸€ä¸ªå‚æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;get_forecast&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;Get weather forecast for a location.\n\nArgs:\n    latitude: Latitude of the location\n    longitude: Longitude of the location\n&quot;,</span><br><span class="line">    &quot;inputSchema&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;latitude&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &quot;Latitude&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;number&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;longitude&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &quot;Longitude&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;number&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;required&quot;: [</span><br><span class="line">            &quot;latitude&quot;,</span><br><span class="line">            &quot;longitude&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;title&quot;: &quot;get_forecastArguments&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;object&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å’Œå®šä¹‰çš„å‡½æ•°å¯¹æ¯”å­¦ä¹ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># æ³¨å†Œä¸ºMCPå·¥å…·çš„å¤©æ°”é¢„æŠ¥å‡½æ•°</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_forecast(latitude: float, longitude: float) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”é¢„æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        latitude: ä½ç½®çš„çº¬åº¦</span><br><span class="line">        longitude: ä½ç½®çš„ç»åº¦</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„å¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # é¦–å…ˆè·å–é¢„æŠ¥ç½‘æ ¼ç«¯ç‚¹</span><br><span class="line">    points_url = f&quot;&#123;NWS_API_BASE&#125;/points/&#123;latitude&#125;,&#123;longitude&#125;&quot;</span><br><span class="line">    points_data = await make_nws_request(points_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥ç‚¹æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not points_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–æ­¤ä½ç½®çš„é¢„æŠ¥æ•°æ®ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # ä»ç‚¹å“åº”ä¸­è·å–é¢„æŠ¥URL</span><br><span class="line">    forecast_url = points_data[&quot;properties&quot;][&quot;forecast&quot;]</span><br><span class="line">    forecast_data = await make_nws_request(forecast_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥é¢„æŠ¥æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not forecast_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è¯¦ç»†é¢„æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # å°†æ—¶é—´æ®µæ ¼å¼åŒ–ä¸ºå¯è¯»çš„é¢„æŠ¥</span><br><span class="line">    periods = forecast_data[&quot;properties&quot;][&quot;periods&quot;]</span><br><span class="line">    forecasts = []</span><br><span class="line">    # åªæ˜¾ç¤ºæ¥ä¸‹æ¥çš„5ä¸ªæ—¶é—´æ®µ</span><br><span class="line">    for period in periods[:5]:</span><br><span class="line">        forecast = f&quot;&quot;&quot;</span><br><span class="line">&#123;period[&#x27;name&#x27;]&#125;:</span><br><span class="line">æ¸©åº¦: &#123;period[&#x27;temperature&#x27;]&#125;Â°&#123;period[&#x27;temperatureUnit&#x27;]&#125;</span><br><span class="line">é£åŠ›: &#123;period[&#x27;windSpeed&#x27;]&#125; &#123;period[&#x27;windDirection&#x27;]&#125;</span><br><span class="line">é¢„æŠ¥: &#123;period[&#x27;detailedForecast&#x27;]&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        forecasts.append(forecast)</span><br><span class="line"></span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰é¢„æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(forecasts)</span><br></pre></td></tr></table></figure>
<p><code>description</code>å†…å®¹å³ä¸ºæˆ‘ä»¬åœ¨å®šä¹‰è¿™ä¸ªtoolçš„æ—¶å€™å†™çš„<strong>æ–‡æ¡£å­—ç¬¦ä¸²</strong>ï¼ˆDocumentation
Stringï¼‰ï¼Œé€šå¸¸ç®€ç§°ä¸º <strong>docstring</strong></p>
<p><code>inputSchema</code> æ˜¯åœ¨MCPï¼ˆModel Control
Protocolï¼‰ä¸­ç”¨æ¥<strong>æè¿°å·¥å…·ï¼ˆtoolï¼‰æ‰€éœ€å‚æ•°çš„ç»“æ„å’Œç±»å‹çš„è§„èŒƒ</strong>ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªJSON
Schemaã€‚</p>
<blockquote>
<p>JSON Schema æ˜¯ä¸€ä¸ªç”¨äº<strong>æè¿°å’ŒéªŒè¯ JSON
æ•°æ®ç»“æ„çš„è§„èŒƒ</strong>ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸º JSON
æ•°æ®çš„â€œè“å›¾â€æˆ–â€œæ¨¡æ¿â€ã€‚</p>
</blockquote>
<p><code>required</code>æŒ‡æ˜å“ªäº›å‚æ•°æ˜¯å¿…éœ€çš„ï¼Œå“ªäº›æ˜¯å¯é€‰çš„ã€‚</p>
<h3 id="ç†è§£mcpçš„æœ¬è´¨">ç†è§£mcpçš„æœ¬è´¨</h3>
<p>ä»¥ä¸Šå†…å®¹çš†æ˜¯serverä¸hostç›´æ¥çš„äº¤äº’ï¼Œæœ¬è´¨ä¸Šå¯ä»¥ç†è§£æˆhostå¯¹serveræä¾›çš„å·¥å…·è¿›è¡Œæ³¨å†Œä¸ä½¿ç”¨ã€‚è¿™å…¶ä¸­å¹¶ä¸æ¶‰åŠåˆ°hostä¸å¤§æ¨¡å‹çš„äº¤äº’ï¼Œä¹Ÿå°±æ˜¯å¤§æ¨¡å‹æ˜¯å¦‚ä½•ä½¿ç”¨hostæä¾›çš„ä¿¡æ¯ã€‚å®é™…ä¸Šä¸åŒçš„mcp
hostä¸æ¨¡å‹çš„äº¤äº’åè®®ä¹Ÿä¸åŒï¼Œå¦‚clineä½¿ç”¨çš„æ˜¯xmlæ ¼å¼ï¼›cherry
studioä½¿ç”¨çš„åˆ™æ˜¯fuction calling</p>
<p>å†çœ‹mcpçš„å…¨ç§°Model Context
Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œä¹Ÿå°±æ˜¯mcpå¢åŠ æ¨¡å‹çš„æ‰©å±•æ€§ï¼Œä½¿ä»–å¯ä»¥è·å–æ›´å¤šä¿¡æ¯ï¼Œè€Œserverå°±æ˜¯ä¸ºæ¨¡å‹æä¾›æ›´å¤šä¿¡æ¯çš„å·¥å…·</p>
<h3 id="mcp-hostä¸æ¨¡å‹çš„äº¤äº’">mcp hostä¸æ¨¡å‹çš„äº¤äº’</h3>
<p>ä½¿ç”¨ä¸­è½¬æœåŠ¡å™¨æˆªè·æ—¥å¿—</p>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727163811531-1753605912284-1.png" alt="image-20250727163811531">
<figcaption aria-hidden="true">image-20250727163811531</figcaption>
</figure>
<p>ä»¥ä¸‹ä¸ºclineå‘é€ç»™æ¨¡å‹çš„è¯·æ±‚</p>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727164527797.png" alt="image-20250727164527797">
<figcaption aria-hidden="true">image-20250727164527797</figcaption>
</figure>
<p><code>messages</code>åŒ…å«äº†ç³»ç»Ÿæç¤ºè¯ä¸ç”¨æˆ·è¾“å…¥</p>
<p>å…ˆæ¥çœ‹ç³»ç»Ÿæç¤ºè¯ï¼Œclineæä¾›çš„æç¤ºè¯åŒ…æ‹¬å·¥å…·ä½¿ç”¨æ ¼å¼ï¼Œå·¥å…·ä¿¡æ¯ï¼Œå·¥å…·ä½¿ç”¨æ–¹æ³•ç­‰ã€‚è¿™é‡Œé‡ç‚¹è¯´ä¸€ä¸‹ï¼Œclineçš„å·¥å…·ä½¿ç”¨æ ¼å¼xml</p>
<p>ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;tool_name&gt;</span><br><span class="line">&lt;parameter1_name&gt;value1&lt;/parameter1_name&gt;</span><br><span class="line">&lt;parameter2_name&gt;value2&lt;/parameter2_name&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/tool_name&gt;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;read_file&gt;</span><br><span class="line">src/main.js</span><br><span class="line">&lt;/read_file&gt;</span><br></pre></td></tr></table></figure>
<p>å†ä¸¾ä¸ªä¾‹å­</p>
<p>use_mcp_tool æè¿°ï¼šè¯·æ±‚ä½¿ç”¨ç”±è¿æ¥çš„ MCP æœåŠ¡å™¨æä¾›çš„å·¥å…·ã€‚æ¯ä¸ª MCP
æœåŠ¡å™¨å¯ä»¥æä¾›å…·æœ‰ä¸åŒåŠŸèƒ½çš„å¤šä¸ªå·¥å…·ã€‚å·¥å…·æœ‰å®šä¹‰çš„è¾“å…¥æ¨¡å¼ï¼Œç”¨äºæŒ‡å®šå¿…éœ€å’Œå¯é€‰å‚æ•°ã€‚
å‚æ•°ï¼š</p>
<p>server_name: (å¿…éœ€) æä¾›è¯¥å·¥å…·çš„ MCP æœåŠ¡å™¨çš„åç§° tool_name: (å¿…éœ€)
è¦æ‰§è¡Œçš„å·¥å…·çš„åç§° arguments: (å¿…éœ€) ä¸€ä¸ª JSON
å¯¹è±¡ï¼ŒåŒ…å«å·¥å…·çš„è¾“å…¥å‚æ•°ï¼Œéµå¾ªå·¥å…·çš„è¾“å…¥æ¨¡å¼ ç”¨æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;use_mcp_tool&gt;</span><br><span class="line">&lt;server_name&gt;æœåŠ¡å™¨åç§°åœ¨æ­¤&lt;/server_name&gt;</span><br><span class="line">&lt;tool_name&gt;å·¥å…·åç§°åœ¨æ­¤&lt;/tool_name&gt;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;param1&quot;: &quot;value1&quot;,</span><br><span class="line">&quot;param2&quot;: &quot;value2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/use_mcp_tool&gt;</span><br></pre></td></tr></table></figure>
<p>æ¨¡å‹è¿”å›å“åº”å¦‚ä¸‹</p>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727174504506.png" alt="image-20250727174504506">
<figcaption aria-hidden="true">image-20250727174504506</figcaption>
</figure>
<p>sseè¿æ¥ï¼Œæµå¼è¾“å‡º</p>
<blockquote>
<p>SSE æ˜¯ä¸€ç§<strong>åŸºäºæ ‡å‡†
HTTP</strong>ã€<strong>åªå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å•å‘æ¨é€æ–‡æœ¬æµ</strong>çš„å®æ—¶é€šä¿¡æŠ€æœ¯ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œè‡ªåŠ¨é‡è¿ï¼Œå¸¸ç”¨äº<strong>AI
æµå¼å›ç­”</strong>ã€<strong>å®æ—¶æ—¥å¿—</strong>ã€<strong>è‚¡ä»·/ç›‘æ§æ¨é€</strong>ç­‰åœºæ™¯ã€‚</p>
<p>å³å®¢æˆ·ç«¯å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè¿ç»­æ¥å—å¤šæ¬¡å“åº”ç›´åˆ°ç»“æŸ</p>
</blockquote>
<h3 id="mcpçš„ä¸‰ç§ä¼ è¾“åè®®">mcpçš„ä¸‰ç§ä¼ è¾“åè®®</h3>
<table>
<colgroup>
<col style="width: 16%">
<col style="width: 29%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 19%">
</colgroup>
<thead>
<tr>
<th>åè®®åç§°</th>
<th>é€šä¿¡æ–¹å¼</th>
<th>é€‚ç”¨åœºæ™¯</th>
<th>ä¼˜åŠ¿</th>
<th>å±€é™</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Stdio</strong>ï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰</td>
<td>ä½¿ç”¨è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰å’Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰è¿›è¡Œæœ¬åœ°é€šä¿¡ï¼ŒåŸºäº
JSON-RPC 2.0 æ ¼å¼</td>
<td>æœ¬åœ°å¼€å‘ã€è°ƒè¯•ã€IDEæ’ä»¶ã€å‘½ä»¤è¡Œå·¥å…·</td>
<td>ç®€å•æ˜“å®ç°ã€è·¨å¹³å°ã€ä½å»¶è¿Ÿ</td>
<td>ä»…æ”¯æŒæœ¬åœ°é€šä¿¡ï¼Œæ— æ³•è·¨ç½‘ç»œï¼Œä½å¹¶å‘</td>
</tr>
<tr>
<td><strong>SSE</strong>ï¼ˆServer-Sent Eventsï¼‰</td>
<td>å®¢æˆ·ç«¯é€šè¿‡ HTTP POST å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨é€šè¿‡ SSE å•å‘æ¨é€æµå¼å“åº”</td>
<td>å®æ—¶ç›‘æ§ã€æ–°é—»æ¨é€ã€è¿œç¨‹æœåŠ¡è°ƒç”¨</td>
<td>åŸºäº HTTPï¼Œæµè§ˆå™¨å‹å¥½ï¼Œæ”¯æŒæµå¼æ•°æ®</td>
<td>ä»…æ”¯æŒå•å‘é€šä¿¡ï¼ŒMCPå®˜æ–¹å·²æ ‡è®°ä¸ºâ€œå³å°†åºŸå¼ƒâ€</td>
</tr>
<tr>
<td><strong>Streamable HTTP</strong>ï¼ˆæ–°å‹æµå¼HTTPï¼‰</td>
<td>æ”¯æŒåŒå‘æµå¼é€šä¿¡çš„ç°ä»£ HTTP åè®®ï¼Œæ›¿ä»£ SSEï¼Œæ”¯æŒä¼šè¯æ¢å¤ã€OAuth
è®¤è¯ç­‰</td>
<td>åˆ†å¸ƒå¼ç³»ç»Ÿã€é«˜å¹¶å‘ã€åŒå‘å®æ—¶äº¤äº’</td>
<td>åŒå‘é€šä¿¡ã€é«˜æ€§èƒ½ã€ä¼ä¸šçº§å®‰å…¨æœºåˆ¶</td>
<td>å®ç°è¾ƒå¤æ‚ï¼Œç”Ÿæ€ä»åœ¨å‘å±•ä¸­</td>
</tr>
</tbody>
</table>
<h3 id="react">ReAct</h3>
<p>ReAct
æ˜¯ä¸€ç§ç”¨äºå¢å¼ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æ¨ç†å’Œè¡ŒåŠ¨èƒ½åŠ›çš„æŠ€æœ¯æ¡†æ¶ï¼Œå®ƒé€šè¿‡ç»“åˆâ€œæ¨ç†â€ï¼ˆReasoningï¼‰å’Œâ€œè¡ŒåŠ¨â€ï¼ˆActingï¼‰æ¥æå‡æ¨¡å‹å¤„ç†å¤æ‚ä»»åŠ¡çš„èƒ½åŠ›ã€‚</p>
<p>å…¶å·¥ä½œæµç¨‹é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol type="1">
<li><strong>æ€è€ƒï¼ˆReasoningï¼‰</strong>ï¼šæ¨¡å‹å¯¹å½“å‰é—®é¢˜è¿›è¡Œåˆ†æï¼Œæ€è€ƒä¸‹ä¸€æ­¥éœ€è¦é‡‡å–çš„è¡ŒåŠ¨ã€‚</li>
<li><strong>è¡ŒåŠ¨ï¼ˆActingï¼‰</strong>ï¼šæ¨¡å‹å†³å®šè°ƒç”¨å“ªäº›å·¥å…·æˆ–å‡½æ•°ï¼Œå¹¶æä¾›å¿…è¦çš„å‚æ•°ã€‚</li>
<li><strong>è§‚å¯Ÿï¼ˆObservationï¼‰</strong>ï¼šå·¥å…·æ‰§è¡Œåè¿”å›ç»“æœï¼Œæ¨¡å‹å¯¹ç»“æœè¿›è¡Œè§‚å¯Ÿã€‚</li>
<li><strong>å“åº”ï¼ˆResponseï¼‰</strong>ï¼šæ ¹æ®è§‚å¯Ÿç»“æœï¼Œæ¨¡å‹ç”Ÿæˆæœ€ç»ˆçš„ç”¨æˆ·å“åº”ã€‚</li>
</ol>
<p>å®é™…åº”ç”¨ä¸Šå°±æ˜¯å‘Šè¯‰å¤§æ¨¡å‹ç”¨ReActè¿™ç§æ¨¡å¼æ¥æ€è€ƒ</p>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1uronYREWR?spm_id_from=333.788.player.switch&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">MCPç»ˆææŒ‡å—
- ä»åŸç†åˆ°å®æˆ˜ï¼Œå¸¦ä½ æ·±å…¥æŒæ¡MCPï¼ˆåŸºç¡€ç¯‡ï¼‰_å“”å“©å“”å“©_bilibili</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph%E5%AE%9E%E6%88%98-Research%20Assistant%E7%A0%94%E7%A9%B6%E5%8A%A9%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph%E5%AE%9E%E6%88%98-Research%20Assistant%E7%A0%94%E7%A9%B6%E5%8A%A9%E7%90%86/" class="post-title-link" itemprop="url">Research Assistantç ”ç©¶åŠ©ç†</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-22T00:00:00+08:00">2025-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-08 21:50:22" itemprop="dateModified" datetime="2025-08-08T21:50:22+08:00">2025-08-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">aiæ¡†æ¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/langgraph/" itemprop="url" rel="index"><span itemprop="name">langgraph</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="research-assistant-ç ”ç©¶åŠ©ç†"><strong>Research Assistant</strong>
<strong>ç ”ç©¶åŠ©ç†</strong></h4>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å›´ç»•èŠå¤©æ¨¡å‹æ„å»ºä¸€ä¸ªè½»é‡çº§ã€å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼Œä»¥å®šåˆ¶ç ”ç©¶è¿‡ç¨‹ã€‚</p>
<p>Source Selection</p>
<ul>
<li>ç”¨æˆ·å¯ä¸ºç ”ç©¶è‡ªè¡Œé€‰æ‹©ä»»æ„è¾“å…¥æºã€‚</li>
</ul>
<p>Planning</p>
<ul>
<li>ç”¨æˆ·æä¾›ä¸»é¢˜åï¼Œç³»ç»Ÿç”Ÿæˆä¸€ç»„ AI
åˆ†æå¸ˆï¼Œæ¯ä½åˆ†æå¸ˆèšç„¦ä¸€ä¸ªå­ä¸»é¢˜ã€‚</li>
<li>åœ¨ç ”ç©¶å¼€å§‹å‰ï¼Œé‡‡ç”¨ <strong>äººæœºååŒ</strong>
æ–¹å¼å¯¹å­ä¸»é¢˜è¿›è¡Œç²¾è°ƒã€‚</li>
</ul>
<p>LLM Utilization</p>
<ul>
<li>æ¯ä½åˆ†æå¸ˆåŸºäºæ‰€é€‰æºï¼Œä¸ä¸“å®¶ AI å¼€å±•æ·±åº¦è®¿è°ˆã€‚</li>
<li>è®¿è°ˆé‡‡ç”¨å¤šè½®å¯¹è¯å½¢å¼ï¼Œä»¥ STORM è®ºæ–‡æ‰€ç¤ºæ–¹å¼æå–è¯¦å°½æ´è§ã€‚</li>
<li>è®¿è°ˆè¿‡ç¨‹å°†ä»¥â€œ<strong>å­å›¾</strong>â€å½¢å¼è®°å½•ï¼Œå¹¶ä¿å­˜å„è‡ªå†…éƒ¨çŠ¶æ€ã€‚</li>
</ul>
<p>Research Process</p>
<ul>
<li>ä¸“å®¶ AI å¹¶è¡Œæ”¶é›†ä¿¡æ¯ï¼Œå®æ—¶å›ç­”åˆ†æå¸ˆæé—®ã€‚</li>
<li>æ‰€æœ‰è®¿è°ˆé€šè¿‡ <strong>map-reduce</strong> æ¶æ„åŒæ—¶å±•å¼€ã€‚</li>
</ul>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph%E5%AE%9E%E6%88%98-Research%20Assistant%E7%A0%94%E7%A9%B6%E5%8A%A9%E7%90%86/66dbb164d61c93d48e604091_research-assistant1.png" alt="Screenshot 2024-08-26 at 7.26.33 PM.png">
<figcaption aria-hidden="true">Screenshot 2024-08-26 at 7.26.33
PM.png</figcaption>
</figure>
<h5 id="generate-analysts-human-in-the-loop-ç”Ÿæˆåˆ†æå¸ˆ"><strong>Generate
Analysts: Human-In-The-Loop</strong> <strong>ç”Ÿæˆåˆ†æå¸ˆ</strong></h5>
<p>åˆ›å»ºåˆ†æå¸ˆå¹¶ä½¿ç”¨äººå·¥å¾ªç¯ï¼ˆhuman-in-the-loopï¼‰æ¥å®¡æŸ¥ä»–ä»¬ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">from typing import List</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line">from pydantic import BaseModel, Field</span><br><span class="line"></span><br><span class="line">class Analyst(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    åˆ†æå¸ˆæ¨¡å‹ç±»</span><br><span class="line">    ç”¨äºå®šä¹‰å•ä¸ªåˆ†æå¸ˆçš„åŸºæœ¬ä¿¡æ¯å’Œå±æ€§</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    affiliation: str = Field(</span><br><span class="line">        description=&quot;åˆ†æå¸ˆçš„ä¸»è¦éš¶å±æœºæ„ã€‚&quot;,</span><br><span class="line">    )</span><br><span class="line">    name: str = Field(</span><br><span class="line">        description=&quot;åˆ†æå¸ˆçš„å§“å&quot;</span><br><span class="line">    )</span><br><span class="line">    role: str = Field(</span><br><span class="line">        description=&quot;åˆ†æå¸ˆåœ¨è¯¥ä¸»é¢˜èƒŒæ™¯ä¸‹çš„è§’è‰²ã€‚&quot;,</span><br><span class="line">    )</span><br><span class="line">    description: str = Field(</span><br><span class="line">        description=&quot;åˆ†æå¸ˆçš„å…³æ³¨ç‚¹ã€æ‹…å¿§å’ŒåŠ¨æœºçš„æè¿°ã€‚&quot;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    @property#@property è£…é¥°å™¨çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–¹æ³•è½¬æ¢ä¸ºåªè¯»å±æ€§ ï¼Œè®©æ–¹æ³•å¯ä»¥åƒè®¿é—®å±æ€§ä¸€æ ·ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦åŠ æ‹¬å·è°ƒç”¨ã€‚</span><br><span class="line">    def persona(self) -&gt; str:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        ç”Ÿæˆåˆ†æå¸ˆçš„äººè®¾ä¿¡æ¯</span><br><span class="line">        è¿”å›æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²åŒ…å«åˆ†æå¸ˆçš„æ‰€æœ‰å…³é”®ä¿¡æ¯</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        return f&quot;å§“å: &#123;self.name&#125;\nè§’è‰²: &#123;self.role&#125;\néš¶å±æœºæ„: &#123;self.affiliation&#125;\næè¿°: &#123;self.description&#125;\n&quot;</span><br><span class="line"></span><br><span class="line">class Perspectives(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    è§†è§’æ¨¡å‹ç±»</span><br><span class="line">    ç”¨äºç®¡ç†å¤šä¸ªåˆ†æå¸ˆçš„é›†åˆ</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    analysts: List[Analyst] = Field(</span><br><span class="line">        description=&quot;åŒ…å«è§’è‰²å’Œéš¶å±æœºæ„çš„åˆ†æå¸ˆç»¼åˆåˆ—è¡¨ã€‚&quot;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">class GenerateAnalystsState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    ç”Ÿæˆåˆ†æå¸ˆçŠ¶æ€ç±»å‹å®šä¹‰</span><br><span class="line">    ç”¨äºç±»å‹æç¤ºï¼Œå®šä¹‰åœ¨ç”Ÿæˆåˆ†æå¸ˆè¿‡ç¨‹ä¸­éœ€è¦çš„çŠ¶æ€ä¿¡æ¯</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    topic: str # ç ”ç©¶ä¸»é¢˜ - ç”¨æˆ·è¾“å…¥çš„ç ”ç©¶è¯é¢˜</span><br><span class="line">    max_analysts: int # åˆ†æå¸ˆæ•°é‡ - éœ€è¦ç”Ÿæˆçš„åˆ†æå¸ˆæœ€å¤§æ•°é‡</span><br><span class="line">    human_analyst_feedback: str # äººç±»åé¦ˆ - æ¥è‡ªç”¨æˆ·çš„åé¦ˆä¿¡æ¯ï¼Œç”¨äºè°ƒæ•´åˆ†æå¸ˆç”Ÿæˆ</span><br><span class="line">    analysts: List[Analyst] # æå‡ºé—®é¢˜çš„åˆ†æå¸ˆ - å·²ç”Ÿæˆçš„åˆ†æå¸ˆåˆ—è¡¨</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>Field</code> æ˜¯ Pydantic
æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œä¸»è¦ç”¨äºä¸ºæ¨¡å‹å­—æ®µæ·»åŠ é¢å¤–çš„å…ƒæ•°æ®å’Œé…ç½®ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line">from langgraph.graph import START, END, StateGraph</span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langchain_core.messages import AIMessage, HumanMessage, SystemMessage</span><br><span class="line"></span><br><span class="line"># åˆ†æå¸ˆæŒ‡ä»¤æ¨¡æ¿</span><br><span class="line">analyst_instructions=&quot;&quot;&quot;æ‚¨éœ€è¦åˆ›å»ºä¸€ç»„AIåˆ†æå¸ˆè§’è‰²ã€‚è¯·ä»”ç»†éµå¾ªä»¥ä¸‹æŒ‡ä»¤ï¼š</span><br><span class="line"></span><br><span class="line">1. é¦–å…ˆï¼ŒæŸ¥çœ‹ç ”ç©¶ä¸»é¢˜ï¼š</span><br><span class="line">&#123;topic&#125;</span><br><span class="line">        </span><br><span class="line">2. æ£€æŸ¥ä»»ä½•å¯é€‰çš„ç¼–è¾‘åé¦ˆï¼Œè¿™äº›åé¦ˆç”¨äºæŒ‡å¯¼åˆ†æå¸ˆçš„åˆ›å»ºï¼š </span><br><span class="line">        </span><br><span class="line">&#123;human_analyst_feedback&#125;</span><br><span class="line">    </span><br><span class="line">3. æ ¹æ®ä¸Šè¿°æ–‡æ¡£å’Œ/æˆ–åé¦ˆç¡®å®šæœ€æœ‰è¶£çš„ä¸»é¢˜ã€‚</span><br><span class="line">                    </span><br><span class="line">4. é€‰æ‹©å‰ &#123;max_analysts&#125; ä¸ªä¸»é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">5. ä¸ºæ¯ä¸ªä¸»é¢˜åˆ†é…ä¸€ä¸ªåˆ†æå¸ˆã€‚</span><br><span class="line"></span><br><span class="line">6. é‡è¦ï¼šè¯·ä»¥JSONæ ¼å¼è¿”å›æ‚¨çš„å“åº”ï¼Œç»“æ„å¦‚ä¸‹ï¼š</span><br><span class="line">   &#123;&#123;</span><br><span class="line">     &quot;analysts&quot;: [</span><br><span class="line">       &#123;&#123;</span><br><span class="line">         &quot;name&quot;: &quot;åˆ†æå¸ˆå§“å&quot;,</span><br><span class="line">         &quot;affiliation&quot;: &quot;æ‰€å±æœºæ„&quot;,</span><br><span class="line">         &quot;role&quot;: &quot;è§’è‰²æè¿°&quot;,</span><br><span class="line">         &quot;description&quot;: &quot;è¯¦ç»†æè¿°&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ]</span><br><span class="line">   &#125;&#125;</span><br><span class="line"></span><br><span class="line">7. è¯·ç¡®ä¿å“åº”ä¸­åŒ…å«&#x27;json&#x27;è¿™ä¸ªè¯ï¼Œè¿™æ˜¯å¿…éœ€çš„ã€‚&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def create_analysts(state: GenerateAnalystsState):</span><br><span class="line">    &quot;&quot;&quot; åˆ›å»ºåˆ†æå¸ˆ &quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    topic=state[&#x27;topic&#x27;]</span><br><span class="line">    max_analysts=state[&#x27;max_analysts&#x27;]</span><br><span class="line">    human_analyst_feedback=state.get(&#x27;human_analyst_feedback&#x27;, &#x27;&#x27;)#é˜²æ­¢ä¸ºç©º</span><br><span class="line">        </span><br><span class="line">    # å¼ºåˆ¶ç»“æ„åŒ–è¾“å‡º</span><br><span class="line">    structured_llm = llm.with_structured_output(Perspectives)</span><br><span class="line"></span><br><span class="line">    # ç³»ç»Ÿæ¶ˆæ¯</span><br><span class="line">    system_message = analyst_instructions.format(topic=topic,human_analyst_feedback=human_analyst_feedback, max_analysts=max_analysts)</span><br><span class="line"></span><br><span class="line">    # ç”Ÿæˆåˆ†æå¸ˆ</span><br><span class="line">    analysts = structured_llm.invoke([SystemMessage(content=system_message)]+[HumanMessage(content=&quot;ç”Ÿæˆåˆ†æå¸ˆé›†åˆã€‚&quot;)])</span><br><span class="line">    </span><br><span class="line">    # å°†åˆ†æå¸ˆåˆ—è¡¨å†™å…¥çŠ¶æ€</span><br><span class="line">    return &#123;&quot;analysts&quot;: analysts.analysts&#125;</span><br><span class="line"></span><br><span class="line">def human_feedback(state: GenerateAnalystsState):</span><br><span class="line">    &quot;&quot;&quot; æ— æ“ä½œèŠ‚ç‚¹ï¼Œåº”è¯¥åœ¨æ­¤å¤„ä¸­æ–­ &quot;&quot;&quot;</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def should_continue(state: GenerateAnalystsState):</span><br><span class="line">    &quot;&quot;&quot; è¿”å›ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·åé¦ˆ</span><br><span class="line">    human_analyst_feedback=state.get(&#x27;human_analyst_feedback&#x27;, None)</span><br><span class="line">    if human_analyst_feedback:</span><br><span class="line">        return &quot;create_analysts&quot;</span><br><span class="line">    </span><br><span class="line">    # å¦åˆ™ç»“æŸ</span><br><span class="line">    return END</span><br><span class="line"></span><br><span class="line"># æ·»åŠ èŠ‚ç‚¹å’Œè¾¹</span><br><span class="line">builder = StateGraph(GenerateAnalystsState)</span><br><span class="line">builder.add_node(&quot;create_analysts&quot;, create_analysts)  # æ·»åŠ åˆ›å»ºåˆ†æå¸ˆèŠ‚ç‚¹</span><br><span class="line">builder.add_node(&quot;human_feedback&quot;, human_feedback)   # æ·»åŠ ç”¨æˆ·åé¦ˆèŠ‚ç‚¹</span><br><span class="line">builder.add_edge(START, &quot;create_analysts&quot;)           # ä»å¼€å§‹åˆ°åˆ›å»ºåˆ†æå¸ˆ</span><br><span class="line">builder.add_edge(&quot;create_analysts&quot;, &quot;human_feedback&quot;) # ä»åˆ›å»ºåˆ†æå¸ˆåˆ°ç”¨æˆ·åé¦ˆ</span><br><span class="line">builder.add_conditional_edges(&quot;human_feedback&quot;, should_continue, [&quot;create_analysts&quot;, END]) # æ¡ä»¶è¾¹</span><br><span class="line"></span><br><span class="line"># ç¼–è¯‘å›¾</span><br><span class="line">memory = MemorySaver()</span><br><span class="line">graph = builder.compile(interrupt_before=[&#x27;human_feedback&#x27;], checkpointer=memory)  # åœ¨ç”¨æˆ·åé¦ˆå‰ä¸­æ–­</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤ºå›¾</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))  # æ˜¾ç¤ºæµç¨‹å›¾</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph%E5%AE%9E%E6%88%98-Research%20Assistant%E7%A0%94%E7%A9%B6%E5%8A%A9%E7%90%86/image-20250723171742889.png" alt="image-20250723171742889">
<figcaption aria-hidden="true">image-20250723171742889</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># è¾“å…¥</span><br><span class="line">max_analysts = 3  # æœ€å¤§åˆ†æå¸ˆæ•°é‡</span><br><span class="line">topic = &quot;é‡‡ç”¨LangGraphä½œä¸ºä»£ç†æ¡†æ¶çš„å¥½å¤„&quot;  # ç ”ç©¶ä¸»é¢˜</span><br><span class="line">thread = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;  # çº¿ç¨‹é…ç½®ï¼Œç”¨äºä¼šè¯è·Ÿè¸ª</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾ç›´åˆ°ç¬¬ä¸€æ¬¡ä¸­æ–­</span><br><span class="line">for event in graph.stream(&#123;&quot;topic&quot;:topic,&quot;max_analysts&quot;:max_analysts,&#125;, thread, stream_mode=&quot;values&quot;):</span><br><span class="line">    # å®¡æŸ¥ç»“æœ</span><br><span class="line">    analysts = event.get(&#x27;analysts&#x27;, &#x27;&#x27;)  # è·å–åˆ†æå¸ˆåˆ—è¡¨</span><br><span class="line">    if analysts:</span><br><span class="line">        for analyst in analysts:</span><br><span class="line">            print(f&quot;å§“å: &#123;analyst.name&#125;&quot;)        # æ‰“å°åˆ†æå¸ˆå§“å</span><br><span class="line">            print(f&quot;éš¶å±æœºæ„: &#123;analyst.affiliation&#125;&quot;)  # æ‰“å°éš¶å±æœºæ„</span><br><span class="line">            print(f&quot;è§’è‰²: &#123;analyst.role&#125;&quot;)        # æ‰“å°è§’è‰²</span><br><span class="line">            print(f&quot;æè¿°: &#123;analyst.description&#125;&quot;)  # æ‰“å°æè¿°</span><br><span class="line">            print(&quot;-&quot; * 50)  # æ‰“å°åˆ†éš”çº¿</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å§“å: è‰¾ç³Â·å²å¯†æ–¯</span><br><span class="line">éš¶å±æœºæ„: äººå·¥æ™ºèƒ½ä¸ä»£ç†ç³»ç»Ÿç ”ç©¶æ‰€</span><br><span class="line">è§’è‰²: LangGraphæ¶æ„ä¸“å®¶</span><br><span class="line">æè¿°: ä¸“æ³¨äºç ”ç©¶åŸºäºå›¾ç»“æ„çš„AIä»£ç†æ¡†æ¶ï¼Œå°¤å…¶æ˜¯LangGraphåœ¨å¤æ‚å†³ç­–æµç¨‹ä¸­çš„æ¨¡å—åŒ–ä¸å¯æ‰©å±•æ€§ä¼˜åŠ¿ã€‚</span><br><span class="line">--------------------------------------------------</span><br><span class="line">å§“å: æ‹‰èƒ¡å°”Â·æ¢…èµ«å¡”</span><br><span class="line">éš¶å±æœºæ„: åˆ†å¸ƒå¼ç³»ç»Ÿä¸AIå®éªŒå®¤</span><br><span class="line">è§’è‰²: ä»£ç†æ¡†æ¶æ€§èƒ½åˆ†æå¸ˆ</span><br><span class="line">æè¿°: ç ”ç©¶LangGraphåœ¨å¤šä»£ç†åä½œä¸­çš„æ•ˆç‡æå‡ï¼Œä»¥åŠå…¶åœ¨å¼‚æ­¥é€šä¿¡ã€çŠ¶æ€ç®¡ç†å’Œé”™è¯¯æ¢å¤æ–¹é¢çš„ä¼˜åŠ¿ã€‚</span><br><span class="line">--------------------------------------------------</span><br><span class="line">å§“å: è‰¾ç±³ä¸½Â·é™ˆ</span><br><span class="line">éš¶å±æœºæ„: äººæœºäº¤äº’ä¸æ™ºèƒ½ç³»ç»Ÿä¸­å¿ƒ</span><br><span class="line">è§’è‰²: ä»£ç†æ¡†æ¶ç”¨æˆ·ä½“éªŒç ”ç©¶å‘˜</span><br><span class="line">æè¿°: åˆ†æLangGraphå¦‚ä½•æ”¯æŒå¼€å‘è€…æ„å»ºæ›´å…·äº¤äº’æ€§å’Œå¯è§£é‡Šæ€§çš„AIä»£ç†ç³»ç»Ÿï¼Œç‰¹åˆ«æ˜¯åœ¨å¯è§†åŒ–æµç¨‹è®¾è®¡å’Œè°ƒè¯•æ–¹é¢çš„ä¼˜åŠ¿ã€‚</span><br><span class="line">--------------------------------------------------</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬ç°åœ¨åƒ human_feedback èŠ‚ç‚¹ä¸€æ ·æ›´æ–°çŠ¶æ€</span><br><span class="line">graph.update_state(thread, &#123;&quot;human_analyst_feedback&quot;: </span><br><span class="line">                            &quot;æ·»åŠ ä¸€ä¸ªæ¥è‡ªåˆåˆ›å…¬å¸çš„äººï¼Œä»¥å¢åŠ ä¼ä¸šå®¶è§†è§’&quot;&#125;, as_node=&quot;human_feedback&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ç»§ç»­å›¾çš„æ‰§è¡Œ</span><br><span class="line">for event in graph.stream(None, thread, stream_mode=&quot;values&quot;):</span><br><span class="line">    # å®¡æŸ¥ç»“æœ</span><br><span class="line">    analysts = event.get(&#x27;analysts&#x27;, &#x27;&#x27;)  # è·å–åˆ†æå¸ˆåˆ—è¡¨</span><br><span class="line">    if analysts:</span><br><span class="line">        for analyst in analysts:</span><br><span class="line">            print(f&quot;å§“å: &#123;analyst.name&#125;&quot;)        # æ‰“å°åˆ†æå¸ˆå§“å</span><br><span class="line">            print(f&quot;éš¶å±æœºæ„: &#123;analyst.affiliation&#125;&quot;)  # æ‰“å°éš¶å±æœºæ„</span><br><span class="line">            print(f&quot;è§’è‰²: &#123;analyst.role&#125;&quot;)        # æ‰“å°è§’è‰²</span><br><span class="line">            print(f&quot;æè¿°: &#123;analyst.description&#125;&quot;)  # æ‰“å°æè¿°</span><br><span class="line">            print(&quot;-&quot; * 50)  # æ‰“å°åˆ†éš”çº¿</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># å¦‚æœæˆ‘ä»¬æ»¡æ„ï¼Œé‚£ä¹ˆå°±ä¸æä¾›ä»»ä½•åé¦ˆ</span><br><span class="line">further_feedback = None #å¦‚æœæ»¡æ„å°±è¿”å›noneï¼Œå¦‚æœä¸æ»¡æ„å°±è¿›è¡Œåé¦ˆ</span><br><span class="line">graph.update_state(thread, &#123;&quot;human_analyst_feedback&quot;: </span><br><span class="line">                            further_feedback&#125;, as_node=&quot;human_feedback&quot;)</span><br></pre></td></tr></table></figure>
<h5 id="conduct-interview-è¿›è¡Œé¢è¯•"><strong>Conduct Interview</strong>
<strong>è¿›è¡Œé¢è¯•</strong></h5>
<p><strong>ç”Ÿæˆé—®é¢˜</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import operator</span><br><span class="line">from typing import  Annotated</span><br><span class="line">from langgraph.graph import MessagesState</span><br><span class="line"></span><br><span class="line">class InterviewState(MessagesState):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    è®¿è°ˆçŠ¶æ€ç±»</span><br><span class="line">    ç»§æ‰¿è‡ªMessagesStateï¼Œç”¨äºç®¡ç†è®¿è°ˆè¿‡ç¨‹ä¸­çš„å„ç§çŠ¶æ€ä¿¡æ¯</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    max_num_turns: int # å¯¹è¯è½®æ•°ä¸Šé™</span><br><span class="line">    context: Annotated[list, operator.add] # æºæ–‡æ¡£ï¼Œä½¿ç”¨operator.addè¿›è¡Œåˆå¹¶</span><br><span class="line">    analyst: Analyst # æé—®çš„åˆ†æå¸ˆ</span><br><span class="line">    interview: str # è®¿è°ˆè®°å½•ï¼ˆæ–‡å­—è®°å½•ï¼‰</span><br><span class="line">    sections: list # æœ€ç»ˆç« èŠ‚ï¼Œæˆ‘ä»¬åœ¨å¤–éƒ¨çŠ¶æ€ä¸­é‡å¤æ­¤å­—æ®µä»¥ç”¨äºSend() API</span><br><span class="line"></span><br><span class="line">class SearchQuery(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    æœç´¢æŸ¥è¯¢æ¨¡å‹</span><br><span class="line">    ç”¨äºå®šä¹‰æœç´¢æŸ¥è¯¢çš„ç»“æ„</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    search_query: str = Field(None, description=&quot;ç”¨äºæ£€ç´¢çš„æœç´¢æŸ¥è¯¢ã€‚&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># é—®é¢˜ç”ŸæˆæŒ‡ä»¤</span><br><span class="line">question_instructions = &quot;&quot;&quot;ä½ æ˜¯ä¸€ååˆ†æå¸ˆï¼Œä»»åŠ¡æ˜¯é‡‡è®¿ä¸“å®¶ä»¥äº†è§£ç‰¹å®šä¸»é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">ä½ çš„ç›®æ ‡æ˜¯æç‚¼å‡ºä¸ä½ ä¸»é¢˜ç›¸å…³çš„æœ‰è¶£ä¸”å…·ä½“çš„è§è§£ã€‚</span><br><span class="line"></span><br><span class="line">1. æœ‰è¶£çš„ï¼šäººä»¬ä¼šæ„Ÿåˆ°æƒŠè®¶æˆ–ä¸æ˜æ˜¾çš„è§è§£ã€‚</span><br><span class="line">        </span><br><span class="line">2. å…·ä½“çš„ï¼šé¿å…æ³›æ³›è€Œè°ˆçš„è§è§£ï¼ŒåŒ…å«æ¥è‡ªä¸“å®¶çš„å…·ä½“ä¾‹å­ã€‚</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä½ çš„å…³æ³¨ä¸»é¢˜å’Œç›®æ ‡é›†åˆï¼š&#123;goals&#125;</span><br><span class="line">        </span><br><span class="line">é¦–å…ˆä½¿ç”¨ç¬¦åˆä½ äººè®¾çš„åå­—ä»‹ç»è‡ªå·±ï¼Œç„¶åæå‡ºä½ çš„é—®é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">ç»§ç»­æé—®ä»¥æ·±å…¥æŒ–æ˜å’Œç»†åŒ–ä½ å¯¹è¯¥ä¸»é¢˜çš„ç†è§£ã€‚</span><br><span class="line">        </span><br><span class="line">å½“ä½ å¯¹ç†è§£æ»¡æ„æ—¶ï¼Œç”¨&quot;éå¸¸æ„Ÿè°¢æ‚¨çš„å¸®åŠ©ï¼&quot;æ¥ç»“æŸé‡‡è®¿ã€‚</span><br><span class="line"></span><br><span class="line">è®°ä½åœ¨æ•´ä¸ªå›å¤ä¸­ä¿æŒè§’è‰²ç‰¹å¾ï¼Œä½“ç°æä¾›ç»™ä½ çš„äººè®¾å’Œç›®æ ‡ã€‚&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def generate_question(state: InterviewState):</span><br><span class="line">    &quot;&quot;&quot; ç”Ÿæˆé—®é¢˜çš„èŠ‚ç‚¹ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–çŠ¶æ€</span><br><span class="line">    analyst = state[&quot;analyst&quot;]      # å½“å‰åˆ†æå¸ˆ</span><br><span class="line">    messages = state[&quot;messages&quot;]    # å¯¹è¯å†å²</span><br><span class="line"></span><br><span class="line">    # ç”Ÿæˆé—®é¢˜</span><br><span class="line">    system_message = question_instructions.format(goals=analyst.persona)  # æ ¼å¼åŒ–ç³»ç»Ÿæ¶ˆæ¯</span><br><span class="line">    question = llm.invoke([SystemMessage(content=system_message)]+messages)  # è°ƒç”¨LLMç”Ÿæˆé—®é¢˜</span><br><span class="line">        </span><br><span class="line">    # å°†æ¶ˆæ¯å†™å…¥çŠ¶æ€</span><br><span class="line">    return &#123;&quot;messages&quot;: [question]&#125;  # è¿”å›æ–°ç”Ÿæˆçš„é—®é¢˜</span><br></pre></td></tr></table></figure>
<p><strong>ç”Ÿæˆé—®é¢˜çš„å¹¶è¡Œå¤„ç†</strong></p>
<p>ä¸“å®¶å°†å¹¶è¡Œä»å¤šä¸ªæ¥æºæ”¶é›†ä¿¡æ¯ä»¥å›ç­”é—®é¢˜ã€‚</p>
<ul>
<li>ç‰¹å®šç½‘ç«™ï¼šä¾‹å¦‚é€šè¿‡ <a target="_blank" rel="noopener" href="https://python.langchain.com/v0.2/docs/integrations/document_loaders/web_base/">WebBaseLoader</a><br>
</li>
<li>å·²ç´¢å¼•æ–‡æ¡£ï¼šä¾‹å¦‚é€šè¿‡ <a target="_blank" rel="noopener" href="https://python.langchain.com/v0.2/docs/tutorials/rag/">RAG</a><br>
</li>
<li>ç½‘é¡µæœç´¢<br>
</li>
<li>ç»´åŸºç™¾ç§‘æœç´¢</li>
</ul>
<p>ä½ å¯ä»¥å°è¯•ä¸åŒçš„ç½‘ç»œæœç´¢å·¥å…·ï¼Œæ¯”å¦‚ <a target="_blank" rel="noopener" href="https://tavily.com/">Tavily</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Web search tool</span><br><span class="line">from langchain_community.tools.tavily_search import TavilySearchResults</span><br><span class="line">from langchain_tavily import TavilySearch</span><br><span class="line">#tavily_search = TavilySearchResults(max_results=3)</span><br><span class="line">tavily_search=TavilySearch(max_result=3)</span><br><span class="line"></span><br><span class="line"># Wikipedia search tool</span><br><span class="line">from langchain_community.document_loaders import WikipediaLoader</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºèŠ‚ç‚¹ä»¥æœç´¢ç½‘ç»œå’Œç»´åŸºç™¾ç§‘ã€‚</p>
<p>æˆ‘ä»¬è¿˜å°†åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹æ¥å›ç­”åˆ†æå¸ˆçš„é—®é¢˜ã€‚æœ€åï¼Œæˆ‘ä»¬å°†åˆ›å»ºèŠ‚ç‚¹ä»¥ä¿å­˜å®Œæ•´çš„é‡‡è®¿å†…å®¹ï¼Œå¹¶æ’°å†™é‡‡è®¿çš„æ‘˜è¦ï¼ˆâ€œéƒ¨åˆ†â€ï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import get_buffer_string</span><br><span class="line"></span><br><span class="line"># æœç´¢æŸ¥è¯¢ç¼–å†™</span><br><span class="line">search_instructions = SystemMessage(content=f&quot;&quot;&quot;ä½ å°†è·å¾—åˆ†æå¸ˆå’Œä¸“å®¶ä¹‹é—´çš„å¯¹è¯ã€‚</span><br><span class="line"></span><br><span class="line">ä½ çš„ç›®æ ‡æ˜¯ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–çš„ JSON å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«ä¸€ä¸ªç”¨äºç½‘ç»œæœç´¢çš„æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚</span><br><span class="line"></span><br><span class="line">è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</span><br><span class="line"></span><br><span class="line">1.  ä»”ç»†åˆ†ææ•´ä¸ªå¯¹è¯ã€‚</span><br><span class="line">2.  ç‰¹åˆ«å…³æ³¨åˆ†æå¸ˆæå‡ºçš„æœ€åä¸€ä¸ªé—®é¢˜ã€‚</span><br><span class="line">3.  æ ¹æ®è¯¥é—®é¢˜ï¼Œç”Ÿæˆä¸€ä¸ªæ¸…æ™°ã€ç®€æ´ã€æœ‰æ•ˆçš„æœç´¢æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚</span><br><span class="line">4.  **ä½ çš„æœ€ç»ˆè¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„ JSON å¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ–è§£é‡Šï¼š**</span><br><span class="line">    &#123;&#123;&quot;search_query&quot;: &quot;ä½ çš„æŸ¥è¯¢å­—ç¬¦ä¸²æ”¾åœ¨è¿™é‡Œ&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">**ç¤ºä¾‹ï¼š**</span><br><span class="line">å¦‚æœæœ€åä¸€ä¸ªé—®é¢˜æ¶‰åŠ &quot;LangGraph ä¸å…¶ä»–ä»£ç†æ¡†æ¶ï¼ˆå¦‚ AutoGenï¼‰ç›¸æ¯”çš„ä¼˜åŠ¿&quot;ï¼Œ</span><br><span class="line">ä½ çš„è¾“å‡ºå¿…é¡»ä¸¥æ ¼æ˜¯ï¼š</span><br><span class="line">&#123;&#123;&quot;search_query&quot;: &quot;LangGraph vs AutoGen agent framework advantages&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">åˆ†æå¸ˆçš„æœ€åä¸€ä¸ªé—®é¢˜æ‰æ˜¯å…³é”®ï¼Œè¯·åŸºäºå®ƒç”ŸæˆæŸ¥è¯¢ã€‚</span><br><span class="line"></span><br><span class="line">**ä½ çš„è¾“å‡ºï¼š**&quot;&quot;&quot;)</span><br><span class="line"></span><br><span class="line">def search_web(state: InterviewState):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç½‘ç»œæœç´¢ä¸­æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æœç´¢æŸ¥è¯¢</span><br><span class="line">    structured_llm = llm.with_structured_output(SearchQuery)</span><br><span class="line">    search_query = structured_llm.invoke([search_instructions]+state[&#x27;messages&#x27;])</span><br><span class="line">    </span><br><span class="line">    # æœç´¢</span><br><span class="line">    search_docs = tavily_search.invoke(search_query.search_query)</span><br><span class="line"></span><br><span class="line">     # æ ¼å¼åŒ–</span><br><span class="line">    formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">        [</span><br><span class="line">            f&#x27;&lt;Document href=&quot;&#123;doc[&quot;url&quot;]&#125;&quot;/&gt;\n&#123;doc[&quot;content&quot;]&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">            for doc in search_docs</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line"></span><br><span class="line">def search_wikipedia(state: InterviewState):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç»´åŸºç™¾ç§‘æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # # æœç´¢æŸ¥è¯¢</span><br><span class="line">    # structured_llm = llm.with_structured_output(SearchQuery)</span><br><span class="line">    # search_query = structured_llm.invoke([search_instructions]+state[&#x27;messages&#x27;])</span><br><span class="line">    </span><br><span class="line">    # # æœç´¢</span><br><span class="line">    # search_docs = WikipediaLoader(query=search_query.search_query, </span><br><span class="line">    #                               load_max_docs=2).load()</span><br><span class="line"></span><br><span class="line">    #  # æ ¼å¼åŒ–</span><br><span class="line">    # formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">    #     [</span><br><span class="line">    #         f&#x27;&lt;Document source=&quot;&#123;doc.metadata[&quot;source&quot;]&#125;&quot; page=&quot;&#123;doc.metadata.get(&quot;page&quot;, &quot;&quot;)&#125;&quot;/&gt;\n&#123;doc.page_content&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">    #         for doc in search_docs</span><br><span class="line">    #     ]</span><br><span class="line">    # )</span><br><span class="line"></span><br><span class="line">    # return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line">    return &#123;&quot;context&quot;: [&quot;&quot;]&#125;</span><br><span class="line"></span><br><span class="line">answer_instructions = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä½æ­£åœ¨æ¥å—åˆ†æå¸ˆé‡‡è®¿çš„ä¸“å®¶ã€‚</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯åˆ†æå¸ˆçš„å…³æ³¨é¢†åŸŸï¼š&#123;goals&#125;ã€‚</span><br><span class="line">        </span><br><span class="line">ä½ çš„ç›®æ ‡æ˜¯å›ç­”é¢è¯•å®˜æå‡ºçš„é—®é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">è¦å›ç­”é—®é¢˜ï¼Œè¯·ä½¿ç”¨æ­¤ä¸Šä¸‹æ–‡ï¼š</span><br><span class="line">        </span><br><span class="line">&#123;context&#125;</span><br><span class="line"></span><br><span class="line">å›ç­”é—®é¢˜æ—¶ï¼Œè¯·éµå¾ªä»¥ä¸‹å‡†åˆ™ï¼š</span><br><span class="line">        </span><br><span class="line">1. ä»…ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­æä¾›çš„ä¿¡æ¯ã€‚</span><br><span class="line">        </span><br><span class="line">2. ä¸è¦å¼•å…¥å¤–éƒ¨ä¿¡æ¯æˆ–åœ¨ä¸Šä¸‹æ–‡ä¸­æ˜ç¡®è¯´æ˜ä¹‹å¤–è¿›è¡Œå‡è®¾ã€‚</span><br><span class="line"></span><br><span class="line">3. ä¸Šä¸‹æ–‡åŒ…å«æ¯ä¸ªç‹¬ç«‹æ–‡æ¡£ä¸»é¢˜çš„æ¥æºã€‚</span><br><span class="line"></span><br><span class="line">4. åœ¨ä»»ä½•ç›¸å…³é™ˆè¿°æ—è¾¹åŒ…å«è¿™äº›æ¥æºã€‚ä¾‹å¦‚ï¼Œå¯¹äºæ¥æº # 1 ä½¿ç”¨ [1]ã€‚</span><br><span class="line"></span><br><span class="line">5. åœ¨ç­”æ¡ˆåº•éƒ¨æŒ‰é¡ºåºåˆ—å‡ºä½ çš„æ¥æºã€‚ [1] æ¥æº 1ï¼Œ[2] æ¥æº 2ï¼Œç­‰ç­‰</span><br><span class="line">        </span><br><span class="line">6. å¦‚æœæ¥æºæ˜¯ï¼š&lt;Document source=&quot;assistant/docs/llama3_1.pdf&quot; page=&quot;7&quot;/&gt;&#x27; é‚£ä¹ˆåªéœ€åˆ—å‡ºï¼š</span><br><span class="line">        </span><br><span class="line">[1] assistant/docs/llama3_1.pdf, page 7 </span><br><span class="line">        </span><br><span class="line">å¹¶è·³è¿‡æ‹¬å·çš„æ·»åŠ ä»¥åŠå¼•ç”¨ä¸­çš„ Document source å‰è¨€ã€‚&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def generate_answer(state: InterviewState):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; å›ç­”é—®é¢˜çš„èŠ‚ç‚¹ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–çŠ¶æ€</span><br><span class="line">    analyst = state[&quot;analyst&quot;]</span><br><span class="line">    messages = state[&quot;messages&quot;]</span><br><span class="line">    context = state[&quot;context&quot;]</span><br><span class="line"></span><br><span class="line">    # å›ç­”é—®é¢˜</span><br><span class="line">    system_message = answer_instructions.format(goals=analyst.persona, context=context)</span><br><span class="line">    answer = llm.invoke([SystemMessage(content=system_message)]+messages)</span><br><span class="line">            </span><br><span class="line">    # å°†æ¶ˆæ¯å‘½åä¸ºæ¥è‡ªä¸“å®¶</span><br><span class="line">    answer.name = &quot;expert&quot;</span><br><span class="line">    </span><br><span class="line">    # å°†å…¶é™„åŠ åˆ°çŠ¶æ€</span><br><span class="line">    return &#123;&quot;messages&quot;: [answer]&#125;</span><br><span class="line"></span><br><span class="line">def save_interview(state: InterviewState):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä¿å­˜é‡‡è®¿ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–æ¶ˆæ¯</span><br><span class="line">    messages = state[&quot;messages&quot;]</span><br><span class="line">    </span><br><span class="line">    # å°†é‡‡è®¿è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span><br><span class="line">    interview = get_buffer_string(messages)</span><br><span class="line">    </span><br><span class="line">    # ä¿å­˜åˆ° interviews é”®</span><br><span class="line">    return &#123;&quot;interview&quot;: interview&#125;</span><br><span class="line"></span><br><span class="line">def route_messages(state: InterviewState, </span><br><span class="line">                   name: str = &quot;expert&quot;):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot; åœ¨é—®é¢˜å’Œç­”æ¡ˆä¹‹é—´è·¯ç”± &quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # è·å–æ¶ˆæ¯</span><br><span class="line">    messages = state[&quot;messages&quot;]</span><br><span class="line">    max_num_turns = state.get(&#x27;max_num_turns&#x27;,2)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥ä¸“å®¶ç­”æ¡ˆçš„æ•°é‡</span><br><span class="line">    #isinstance(m, AIMessage) ï¼šæ£€æŸ¥å½“å‰æ¶ˆæ¯ m æ˜¯å¦æ˜¯ AIMessage ç±»çš„å®ä¾‹ã€‚è¿™é€šå¸¸ç”¨äºè¯†åˆ«ç”± AI æ¨¡å‹ç”Ÿæˆçš„æ¶ˆæ¯ã€‚</span><br><span class="line">    num_responses = len(</span><br><span class="line">        [m for m in messages if isinstance(m, AIMessage) and m.name == name]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # å¦‚æœä¸“å®¶å›ç­”çš„æ¬¡æ•°è¶…è¿‡æœ€å¤§è½®æ•°ï¼Œåˆ™ç»“æŸ</span><br><span class="line">    if num_responses &gt;= max_num_turns:</span><br><span class="line">        return &#x27;save_interview&#x27;</span><br><span class="line"></span><br><span class="line">    # è·å–æå‡ºçš„æœ€åä¸€ä¸ªé—®é¢˜ï¼Œä»¥æ£€æŸ¥å®ƒæ˜¯å¦è¡¨ç¤ºè®¨è®ºç»“æŸ</span><br><span class="line">    #messages[-2] ï¼šåˆ†æå¸ˆæå‡ºçš„ æœ€åä¸€ä¸ªé—®é¢˜ ã€‚</span><br><span class="line">    #messages[-1] ï¼šä¸“å®¶å¯¹è¿™ä¸ªé—®é¢˜çš„ æœ€æ–°å›ç­” ã€‚</span><br><span class="line">    last_question = messages[-2]</span><br><span class="line">    </span><br><span class="line">    if &quot;éå¸¸æ„Ÿè°¢ä½ çš„å¸®åŠ©&quot; in last_question.content:</span><br><span class="line">        return &#x27;save_interview&#x27;</span><br><span class="line">    return &quot;ask_question&quot;</span><br><span class="line"></span><br><span class="line">section_writer_instructions = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç§‘æŠ€ä½œå®¶ã€‚</span><br><span class="line">            </span><br><span class="line">ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸€ç»„æºæ–‡æ¡£åˆ›å»ºä¸€ä»½ç®€çŸ­ã€æ˜“äºç†è§£çš„æŠ¥å‘Šéƒ¨åˆ†ã€‚</span><br><span class="line"></span><br><span class="line">1. åˆ†ææºæ–‡æ¡£çš„å†…å®¹ï¼š</span><br><span class="line">- æ¯ä¸ªæºæ–‡æ¡£çš„åç§°éƒ½åœ¨æ–‡æ¡£å¼€å¤´ï¼Œå¸¦æœ‰ &lt;Document æ ‡ç­¾ã€‚</span><br><span class="line">        </span><br><span class="line">2. ä½¿ç”¨ markdown æ ¼å¼åˆ›å»ºæŠ¥å‘Šç»“æ„ï¼š</span><br><span class="line">- ä½¿ç”¨ ## ä½œä¸ºç« èŠ‚æ ‡é¢˜</span><br><span class="line">- ä½¿ç”¨ ### ä½œä¸ºå°èŠ‚æ ‡é¢˜</span><br><span class="line">        </span><br><span class="line">3. æŒ‰ç…§æ­¤ç»“æ„ç¼–å†™æŠ¥å‘Šï¼š</span><br><span class="line">a. æ ‡é¢˜ (## header)</span><br><span class="line">b. æ‘˜è¦ (### header)</span><br><span class="line">c. æ¥æº (### header)</span><br><span class="line"></span><br><span class="line">4. æ ¹æ®åˆ†æå¸ˆçš„å…³æ³¨é¢†åŸŸï¼Œä½¿ä½ çš„æ ‡é¢˜å¼•äººå…¥èƒœï¼š</span><br><span class="line">&#123;focus&#125;</span><br><span class="line"></span><br><span class="line">5. å¯¹äºæ‘˜è¦éƒ¨åˆ†ï¼š</span><br><span class="line">- è®¾ç½®ä¸åˆ†æå¸ˆå…³æ³¨é¢†åŸŸç›¸å…³çš„é€šç”¨èƒŒæ™¯/ä¸Šä¸‹æ–‡çš„æ‘˜è¦</span><br><span class="line">- å¼ºè°ƒä»é‡‡è®¿ä¸­æ”¶é›†åˆ°çš„æ–°é¢–ã€æœ‰è¶£æˆ–ä»¤äººæƒŠè®¶çš„è§è§£</span><br><span class="line">- åˆ›å»ºä¸€ä¸ªä½¿ç”¨è¿‡çš„æºæ–‡æ¡£çš„ç¼–å·åˆ—è¡¨</span><br><span class="line">- ä¸è¦æåŠé¢è¯•å®˜æˆ–ä¸“å®¶çš„å§“å</span><br><span class="line">- ç›®æ ‡æ˜¯æœ€å¤šçº¦ 400 å­—</span><br><span class="line">- æ ¹æ®æºæ–‡æ¡£ä¸­çš„ä¿¡æ¯ï¼Œåœ¨æŠ¥å‘Šä¸­ä½¿ç”¨ç¼–å·æ¥æºï¼ˆä¾‹å¦‚ï¼Œ[1]ã€[2]ï¼‰</span><br><span class="line">        </span><br><span class="line">6. åœ¨æ¥æºéƒ¨åˆ†ï¼š</span><br><span class="line">- åŒ…å«æŠ¥å‘Šä¸­ä½¿ç”¨çš„æ‰€æœ‰æ¥æº</span><br><span class="line">- æä¾›ç›¸å…³ç½‘ç«™æˆ–ç‰¹å®šæ–‡æ¡£è·¯å¾„çš„å®Œæ•´é“¾æ¥</span><br><span class="line">- æ¯ä¸ªæ¥æºç”¨æ¢è¡Œç¬¦åˆ†éš”ã€‚åœ¨æ¯è¡Œæœ«å°¾ä½¿ç”¨ä¸¤ä¸ªç©ºæ ¼ä»¥åœ¨ Markdown ä¸­åˆ›å»ºæ¢è¡Œç¬¦ã€‚</span><br><span class="line">- å®ƒçœ‹èµ·æ¥åƒï¼š</span><br><span class="line"></span><br><span class="line">### æ¥æº</span><br><span class="line">[1] é“¾æ¥æˆ–æ–‡æ¡£åç§°</span><br><span class="line">[2] é“¾æ¥æˆ–æ–‡æ¡£åç§°</span><br><span class="line"></span><br><span class="line">7. åŠ¡å¿…åˆå¹¶æ¥æºã€‚ä¾‹å¦‚ï¼Œè¿™ä¸æ­£ç¡®ï¼š</span><br><span class="line"></span><br><span class="line">[3] https://ai.meta.com/blog/meta-llama-3-1/</span><br><span class="line">[4] https://ai.meta.com/blog/meta-llama-3-1/</span><br><span class="line"></span><br><span class="line">ä¸åº”æœ‰å†—ä½™æ¥æºã€‚å®ƒåº”è¯¥åªæ˜¯ï¼š</span><br><span class="line"></span><br><span class="line">[3] https://ai.meta.com/blog/meta-llama-3-1/</span><br><span class="line">        </span><br><span class="line">8. æœ€ç»ˆå®¡æŸ¥ï¼š</span><br><span class="line">- ç¡®ä¿æŠ¥å‘Šéµå¾ªæ‰€éœ€çš„ç»“æ„</span><br><span class="line">- åœ¨æŠ¥å‘Šæ ‡é¢˜ä¹‹å‰ä¸åŒ…å«ä»»ä½•å‰è¨€</span><br><span class="line">- æ£€æŸ¥æ‰€æœ‰å‡†åˆ™æ˜¯å¦å·²éµå¾ª&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def write_section(state: InterviewState):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot; ç¼–å†™ç« èŠ‚çš„èŠ‚ç‚¹ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–çŠ¶æ€</span><br><span class="line">    interview = state[&quot;interview&quot;]</span><br><span class="line">    context = state[&quot;context&quot;]</span><br><span class="line">    analyst = state[&quot;analyst&quot;]</span><br><span class="line">   </span><br><span class="line">    # ä½¿ç”¨ä»é‡‡è®¿ï¼ˆä¸Šä¸‹æ–‡ï¼‰æˆ–é‡‡è®¿æœ¬èº«ï¼ˆinterviewï¼‰æ”¶é›†çš„æºæ–‡æ¡£ç¼–å†™ç« èŠ‚</span><br><span class="line">    system_message = section_writer_instructions.format(focus=analyst.description)</span><br><span class="line">    section = llm.invoke([SystemMessage(content=system_message)]+[HumanMessage(content=f&quot;Use this source to write your section: &#123;context&#125;&quot;)]) </span><br><span class="line">                </span><br><span class="line">    # å°†å…¶é™„åŠ åˆ°çŠ¶æ€</span><br><span class="line">    return &#123;&quot;sections&quot;: [section.content]&#125;</span><br><span class="line"></span><br><span class="line"># æ·»åŠ èŠ‚ç‚¹å’Œè¾¹</span><br><span class="line">interview_builder = StateGraph(InterviewState)</span><br><span class="line">interview_builder.add_node(&quot;ask_question&quot;, generate_question)</span><br><span class="line">interview_builder.add_node(&quot;search_web&quot;, search_web)</span><br><span class="line">interview_builder.add_node(&quot;search_wikipedia&quot;, search_wikipedia)</span><br><span class="line">interview_builder.add_node(&quot;answer_question&quot;, generate_answer)</span><br><span class="line">interview_builder.add_node(&quot;save_interview&quot;, save_interview)</span><br><span class="line">interview_builder.add_node(&quot;write_section&quot;, write_section)</span><br><span class="line"></span><br><span class="line"># æµç¨‹</span><br><span class="line">interview_builder.add_edge(START, &quot;ask_question&quot;)</span><br><span class="line">interview_builder.add_edge(&quot;ask_question&quot;, &quot;search_web&quot;)</span><br><span class="line">interview_builder.add_edge(&quot;ask_question&quot;, &quot;search_wikipedia&quot;)</span><br><span class="line">interview_builder.add_edge(&quot;search_web&quot;, &quot;answer_question&quot;)</span><br><span class="line">interview_builder.add_edge(&quot;search_wikipedia&quot;, &quot;answer_question&quot;)</span><br><span class="line">interview_builder.add_conditional_edges(&quot;answer_question&quot;, route_messages,[&#x27;ask_question&#x27;,&#x27;save_interview&#x27;])</span><br><span class="line">interview_builder.add_edge(&quot;save_interview&quot;, &quot;write_section&quot;)</span><br><span class="line">interview_builder.add_edge(&quot;write_section&quot;, END)</span><br><span class="line"></span><br><span class="line"># é‡‡è®¿</span><br><span class="line">memory = MemorySaver()</span><br><span class="line">interview_graph = interview_builder.compile(checkpointer=memory).with_config(run_name=&quot;Conduct Interviews&quot;)</span><br><span class="line"></span><br><span class="line"># è§†å›¾</span><br><span class="line">display(Image(interview_graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph%E5%AE%9E%E6%88%98-Research%20Assistant%E7%A0%94%E7%A9%B6%E5%8A%A9%E7%90%86/image-20250725101725158.png" alt="image-20250725101725158">
<figcaption aria-hidden="true">image-20250725101725158</figcaption>
</figure>
<h5 id="map-reduceparallelze-interviews-map-reduce-å¹¶è¡ŒåŒ–è®¿è°ˆ"><strong>Map-Reduceï¼ˆParallelze
interviews: Map-Reduceï¼‰</strong> <strong>å¹¶è¡ŒåŒ–è®¿è°ˆ</strong></h5>
<p>æˆ‘ä»¬é€šè¿‡ <code>Send()</code> API
å¹¶è¡ŒåŒ–å¤„ç†è®¿è°ˆï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜ å°„æ­¥éª¤ã€‚æˆ‘ä»¬å°†å®ƒä»¬åœ¨ reduce
æ­¥éª¤ä¸­ç»„åˆæˆæŠ¥å‘Šæ­£æ–‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import operator</span><br><span class="line">from typing import List, Annotated</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line"></span><br><span class="line">class ResearchGraphState(TypedDict):</span><br><span class="line">    topic: str                           # ç ”ç©¶ä¸»é¢˜ (å­—ç¬¦ä¸²ç±»å‹)</span><br><span class="line">    max_analysts: int                   # åˆ†æå¸ˆæ•°é‡ (æ•´æ•°ç±»å‹)</span><br><span class="line">    human_analyst_feedback: str         # äººç±»åˆ†æå¸ˆçš„åé¦ˆ (å­—ç¬¦ä¸²ç±»å‹)</span><br><span class="line">    analysts: List[Analyst]             # æé—®çš„åˆ†æå¸ˆåˆ—è¡¨ (Analyst å¯¹è±¡çš„åˆ—è¡¨)</span><br><span class="line">    sections: Annotated[list, operator.add] # æŠ¥å‘Šç« èŠ‚åˆ—è¡¨ (ä½¿ç”¨ operator.add ä½œä¸º Send() API çš„é”®ï¼Œæ„å‘³ç€åˆ—è¡¨å¯ä»¥é€šè¿‡ç›¸åŠ æ¥åˆå¹¶)</span><br><span class="line">    introduction: str                   # æœ€ç»ˆæŠ¥å‘Šçš„å¼•è¨€éƒ¨åˆ† (å­—ç¬¦ä¸²ç±»å‹)</span><br><span class="line">    content: str                        # æœ€ç»ˆæŠ¥å‘Šçš„å†…å®¹ä¸»ä½“éƒ¨åˆ† (å­—ç¬¦ä¸²ç±»å‹)</span><br><span class="line">    conclusion: str                     # æœ€ç»ˆæŠ¥å‘Šçš„ç»“è®ºéƒ¨åˆ† (å­—ç¬¦ä¸²ç±»å‹)</span><br><span class="line">    final_report: str                   # æœ€ç»ˆå®Œæ•´çš„æŠ¥å‘Š (å­—ç¬¦ä¸²ç±»å‹)</span><br><span class="line"></span><br><span class="line"># ä» langgraph.constants å¯¼å…¥ Send ç±»</span><br><span class="line">from langgraph.constants import Send</span><br><span class="line">def initiate_all_interviews(state: ResearchGraphState):</span><br><span class="line">    &quot;&quot;&quot; è¿™æ˜¯â€œmapâ€ï¼ˆæ˜ å°„ï¼‰æ­¥éª¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ Send API å¹¶è¡Œè¿è¡Œæ¯ä¸ªé‡‡è®¿å­å›¾ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨äººç±»åé¦ˆ</span><br><span class="line">    human_analyst_feedback = state.get(&#x27;human_analyst_feedback&#x27;)</span><br><span class="line">    if human_analyst_feedback:</span><br><span class="line">        # å¦‚æœæœ‰åé¦ˆï¼Œåˆ™è¿”å›åˆ° &quot;create_analysts&quot; èŠ‚ç‚¹è¿›è¡Œè°ƒæ•´</span><br><span class="line">        return &quot;create_analysts&quot;</span><br><span class="line"></span><br><span class="line">    # å¦åˆ™ï¼Œé€šè¿‡ Send() API å¹¶è¡Œå¯åŠ¨æ‰€æœ‰é‡‡è®¿</span><br><span class="line">    else:</span><br><span class="line">        topic = state[&quot;topic&quot;]</span><br><span class="line">        # ä¸ºæ¯ä¸ªåˆ†æå¸ˆåˆ›å»ºä¸€ä¸ª Send å¯¹è±¡</span><br><span class="line">        # ç›®æ ‡æ˜¯ &quot;conduct_interview&quot; èŠ‚ç‚¹</span><br><span class="line">        # ä¼ é€’çš„å‚æ•°åŒ…æ‹¬è¯¥åˆ†æå¸ˆå¯¹è±¡å’Œä¸€æ¡åˆå§‹æ¶ˆæ¯</span><br><span class="line">        return [Send(&quot;conduct_interview&quot;, &#123;&quot;analyst&quot;: analyst,</span><br><span class="line">                                           &quot;messages&quot;: [HumanMessage(</span><br><span class="line">                                               content=f&quot;æ‰€ä»¥ä½ è¯´ä½ æ­£åœ¨å†™ä¸€ç¯‡å…³äº &#123;topic&#125; çš„æ–‡ç« ï¼Ÿ&quot;</span><br><span class="line">                                           )</span><br><span class="line">                                                       ]&#125;) for analyst in state[&quot;analysts&quot;]]</span><br></pre></td></tr></table></figure>
<h5 id="finalize-æœ€ç»ˆç¡®å®š"><strong>Finalize</strong>
<strong>æœ€ç»ˆç¡®å®š</strong></h5>
<p>æˆ‘ä»¬æ·»åŠ æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œä¸ºæœ€ç»ˆæŠ¥å‘Šæ’°å†™å¼•è¨€å’Œç»“è®ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">import operator</span><br><span class="line">from typing import List, Annotated</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ç”¨äºæ’°å†™æœ€ç»ˆæŠ¥å‘Šçš„æŒ‡ä»¤æ¨¡æ¿</span><br><span class="line">report_writer_instructions = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä½æ­£åœ¨æ’°å†™å…³äºä»¥ä¸‹ä¸»é¢˜æŠ¥å‘Šçš„æŠ€æœ¯ä½œå®¶ï¼š</span><br><span class="line"></span><br><span class="line">&#123;topic&#125;</span><br><span class="line">    </span><br><span class="line">ä½ æœ‰ä¸€ä¸ªåˆ†æå¸ˆå›¢é˜Ÿã€‚æ¯ä¸ªåˆ†æå¸ˆåšäº†ä¸¤ä»¶äº‹ï¼š</span><br><span class="line"></span><br><span class="line">1. ä»–ä»¬å°±ä¸€ä¸ªç‰¹å®šçš„å­ä¸»é¢˜ä¸ä¸“å®¶è¿›è¡Œäº†é‡‡è®¿ã€‚</span><br><span class="line">2. ä»–ä»¬å°†ä»–ä»¬çš„å‘ç°å†™æˆäº†ä¸€ä»½å¤‡å¿˜å½•ã€‚</span><br><span class="line"></span><br><span class="line">ä½ çš„ä»»åŠ¡ï¼š</span><br><span class="line"></span><br><span class="line">1. ä½ å°†å¾—åˆ°ä¸€ä»½æ¥è‡ªä½ æ‰€æœ‰åˆ†æå¸ˆçš„å¤‡å¿˜å½•é›†åˆã€‚</span><br><span class="line">2. ä»”ç»†æ€è€ƒæ¯ä»½å¤‡å¿˜å½•ä¸­çš„è§è§£ã€‚</span><br><span class="line">3. å°†è¿™äº›è§è§£æ•´åˆæˆä¸€ä¸ªæ¸…æ™°çš„æ•´ä½“æ‘˜è¦ï¼ŒæŠŠæ‰€æœ‰å¤‡å¿˜å½•ä¸­çš„æ ¸å¿ƒæ€æƒ³è”ç³»èµ·æ¥ã€‚</span><br><span class="line">4. å°†æ¯ä»½å¤‡å¿˜å½•ä¸­çš„è¦ç‚¹æ€»ç»“æˆä¸€ä¸ªè¿è´¯çš„å•ä¸€å™è¿°ã€‚</span><br><span class="line"></span><br><span class="line">æŠ¥å‘Šæ ¼å¼è¦æ±‚ï¼š</span><br><span class="line"> </span><br><span class="line">1. ä½¿ç”¨ Markdown æ ¼å¼ã€‚</span><br><span class="line">2. æŠ¥å‘Šå¼€å¤´ä¸è¦æœ‰å‰è¨€ã€‚</span><br><span class="line">3. ä¸è¦ä½¿ç”¨å­æ ‡é¢˜ã€‚</span><br><span class="line">4. æŠ¥å‘Šå¼€å¤´ä½¿ç”¨ä¸€ä¸ªä¸€çº§æ ‡é¢˜ï¼š## Insights ï¼ˆ## è§è§£ï¼‰</span><br><span class="line">5. åœ¨æŠ¥å‘Šä¸­ä¸è¦æåŠä»»ä½•åˆ†æå¸ˆçš„åå­—ã€‚</span><br><span class="line">6. ä¿ç•™å¤‡å¿˜å½•ä¸­çš„æ‰€æœ‰å¼•ç”¨ï¼Œè¿™äº›å¼•ç”¨ä¼šç”¨æ–¹æ‹¬å·æ ‡æ³¨ï¼Œä¾‹å¦‚ [1] æˆ– [2]ã€‚</span><br><span class="line">7. åˆ›å»ºä¸€ä¸ªæœ€ç»ˆçš„ã€åˆå¹¶çš„æ¥æºåˆ—è¡¨ï¼Œå¹¶æ·»åŠ åˆ°ä»¥ `## Sources` ä¸ºæ ‡é¢˜çš„éƒ¨åˆ†ã€‚</span><br><span class="line">8. æŒ‰é¡ºåºåˆ—å‡ºä½ çš„æ¥æºï¼Œä¸è¦é‡å¤ã€‚</span><br><span class="line"></span><br><span class="line">[1] æ¥æº 1</span><br><span class="line">[2] æ¥æº 2</span><br><span class="line"></span><br><span class="line">ä»¥ä¸‹æ˜¯ä½ çš„åˆ†æå¸ˆæä¾›çš„å¤‡å¿˜å½•ï¼Œä½ éœ€è¦æ ¹æ®å®ƒä»¬æ¥æ’°å†™æŠ¥å‘Šï¼š</span><br><span class="line"></span><br><span class="line">&#123;context&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def write_report(state: ResearchGraphState):</span><br><span class="line">    &quot;&quot;&quot; æ’°å†™æŠ¥å‘Šä¸»ä½“å†…å®¹çš„èŠ‚ç‚¹å‡½æ•° &quot;&quot;&quot;</span><br><span class="line">    # è·å–æ‰€æœ‰ç« èŠ‚ï¼ˆå¤‡å¿˜å½•ï¼‰</span><br><span class="line">    sections = state[&quot;sections&quot;]</span><br><span class="line">    topic = state[&quot;topic&quot;]</span><br><span class="line"></span><br><span class="line">    # å°†æ‰€æœ‰ç« èŠ‚ï¼ˆå¤‡å¿˜å½•ï¼‰è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">    formatted_str_sections = &quot;\n\n&quot;.join([f&quot;&#123;section&#125;&quot; for section in sections])</span><br><span class="line">    </span><br><span class="line">    # ä½¿ç”¨æŒ‡ä»¤æ¨¡æ¿å’Œå¤‡å¿˜å½•å†…å®¹ï¼Œè°ƒç”¨ LLM ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š</span><br><span class="line">    system_message = report_writer_instructions.format(topic=topic, context=formatted_str_sections)    </span><br><span class="line">    report = llm.invoke([SystemMessage(content=system_message)] + [HumanMessage(content=&quot;æ ¹æ®è¿™äº›å¤‡å¿˜å½•å†™ä¸€ä»½æŠ¥å‘Šã€‚&quot;)]) </span><br><span class="line">    # è¿”å›æŠ¥å‘Šå†…å®¹</span><br><span class="line">    return &#123;&quot;content&quot;: report.content&#125;</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ç”¨äºæ’°å†™å¼•è¨€å’Œç»“è®ºçš„æŒ‡ä»¤æ¨¡æ¿</span><br><span class="line">intro_conclusion_instructions = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä½æ­£åœ¨å®Œæˆå…³äº &#123;topic&#125; æŠ¥å‘Šçš„æŠ€æœ¯ä½œå®¶ã€‚</span><br><span class="line"></span><br><span class="line">ä½ å°†å¾—åˆ°æŠ¥å‘Šçš„æ‰€æœ‰ç« èŠ‚ã€‚</span><br><span class="line"></span><br><span class="line">ä½ çš„å·¥ä½œæ˜¯æ’°å†™ä¸€ä¸ªæ¸…æ™°ä¸”æœ‰è¯´æœåŠ›çš„å¼•è¨€æˆ–ç»“è®ºéƒ¨åˆ†ã€‚</span><br><span class="line"></span><br><span class="line">ç”¨æˆ·ä¼šæŒ‡ç¤ºä½ æ˜¯å†™å¼•è¨€è¿˜æ˜¯ç»“è®ºã€‚</span><br><span class="line"></span><br><span class="line">ä¸¤ä¸ªéƒ¨åˆ†éƒ½ä¸è¦æœ‰å‰è¨€ã€‚</span><br><span class="line"></span><br><span class="line">ç›®æ ‡å¤§çº¦ 100 ä¸ªè¯ï¼Œç®€æ´åœ°é¢„è§ˆï¼ˆå¯¹äºå¼•è¨€ï¼‰æˆ–å›é¡¾ï¼ˆå¯¹äºç»“è®ºï¼‰æŠ¥å‘Šçš„æ‰€æœ‰ç« èŠ‚ã€‚</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ Markdown æ ¼å¼ã€‚</span><br><span class="line"></span><br><span class="line">å¯¹äºä½ çš„å¼•è¨€ï¼Œåˆ›å»ºä¸€ä¸ªå¼•äººæ³¨ç›®çš„æ ‡é¢˜ï¼Œå¹¶ä½¿ç”¨ # æ ‡é¢˜çº§åˆ«ã€‚</span><br><span class="line">å¯¹äºä½ çš„å¼•è¨€ï¼Œä½¿ç”¨ ## Introduction ï¼ˆ## å¼•è¨€ï¼‰ ä½œä¸ºéƒ¨åˆ†æ ‡é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">å¯¹äºä½ çš„ç»“è®ºï¼Œä½¿ç”¨ ## Conclusion ï¼ˆ## ç»“è®ºï¼‰ ä½œä¸ºéƒ¨åˆ†æ ‡é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">ä»¥ä¸‹æ˜¯ä¾›ä½ å‚è€ƒä»¥æ’°å†™ç›¸åº”éƒ¨åˆ†çš„ç« èŠ‚ï¼š&#123;formatted_str_sections&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def write_introduction(state: ResearchGraphState):</span><br><span class="line">    &quot;&quot;&quot; æ’°å†™æŠ¥å‘Šå¼•è¨€çš„èŠ‚ç‚¹å‡½æ•° &quot;&quot;&quot;</span><br><span class="line">    # è·å–æ‰€æœ‰ç« èŠ‚</span><br><span class="line">    sections = state[&quot;sections&quot;]</span><br><span class="line">    topic = state[&quot;topic&quot;]</span><br><span class="line"></span><br><span class="line">    # å°†æ‰€æœ‰ç« èŠ‚è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">    formatted_str_sections = &quot;\n\n&quot;.join([f&quot;&#123;section&#125;&quot; for section in sections])</span><br><span class="line">    </span><br><span class="line">    # ä½¿ç”¨æŒ‡ä»¤æ¨¡æ¿å’Œç« èŠ‚å†…å®¹ï¼Œè°ƒç”¨ LLM ç”Ÿæˆå¼•è¨€</span><br><span class="line">    instructions = intro_conclusion_instructions.format(topic=topic, formatted_str_sections=formatted_str_sections)    </span><br><span class="line">    intro = llm.invoke([instructions] + [HumanMessage(content=&quot;å†™æŠ¥å‘Šçš„å¼•è¨€&quot;)]) </span><br><span class="line">    # è¿”å›å¼•è¨€å†…å®¹</span><br><span class="line">    return &#123;&quot;introduction&quot;: intro.content&#125;</span><br><span class="line"></span><br><span class="line">def write_conclusion(state: ResearchGraphState):</span><br><span class="line">    &quot;&quot;&quot; æ’°å†™æŠ¥å‘Šç»“è®ºçš„èŠ‚ç‚¹å‡½æ•° &quot;&quot;&quot;</span><br><span class="line">    # è·å–æ‰€æœ‰ç« èŠ‚</span><br><span class="line">    sections = state[&quot;sections&quot;]</span><br><span class="line">    topic = state[&quot;topic&quot;]</span><br><span class="line"></span><br><span class="line">    # å°†æ‰€æœ‰ç« èŠ‚è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">    formatted_str_sections = &quot;\n\n&quot;.join([f&quot;&#123;section&#125;&quot; for section in sections])</span><br><span class="line">    </span><br><span class="line">    # ä½¿ç”¨æŒ‡ä»¤æ¨¡æ¿å’Œç« èŠ‚å†…å®¹ï¼Œè°ƒç”¨ LLM ç”Ÿæˆç»“è®º</span><br><span class="line">    instructions = intro_conclusion_instructions.format(topic=topic, formatted_str_sections=formatted_str_sections)    </span><br><span class="line">    conclusion = llm.invoke([instructions] + [HumanMessage(content=&quot;å†™æŠ¥å‘Šçš„ç»“è®º&quot;)]) </span><br><span class="line">    # è¿”å›ç»“è®ºå†…å®¹</span><br><span class="line">    return &#123;&quot;conclusion&quot;: conclusion.content&#125;</span><br><span class="line"></span><br><span class="line">def finalize_report(state: ResearchGraphState):</span><br><span class="line">    &quot;&quot;&quot; è¿™æ˜¯â€œreduceâ€ï¼ˆå½’çº¦ï¼‰æ­¥éª¤ï¼Œæˆ‘ä»¬æ”¶é›†æ‰€æœ‰éƒ¨åˆ†ï¼Œå°†å®ƒä»¬ç»„åˆèµ·æ¥ï¼Œå¹¶è¿›è¡Œåæ€ä»¥å†™å‡ºå¼•è¨€/ç»“è®º &quot;&quot;&quot;</span><br><span class="line">    &quot;&quot;&quot; æœ€ç»ˆæ•´åˆæŠ¥å‘Šçš„èŠ‚ç‚¹å‡½æ•° &quot;&quot;&quot;</span><br><span class="line">    # è·å–æŠ¥å‘Šä¸»ä½“å†…å®¹</span><br><span class="line">    content = state[&quot;content&quot;]</span><br><span class="line">    # å¦‚æœå†…å®¹ä»¥ &quot;## Insights&quot; å¼€å¤´ï¼Œåˆ™ç§»é™¤è¿™ä¸ªæ ‡é¢˜</span><br><span class="line">    if content.startswith(&quot;## Insights&quot;):</span><br><span class="line">        content = content.strip(&quot;## Insights&quot;)</span><br><span class="line">    # å°è¯•åˆ†ç¦»æŠ¥å‘Šä¸»ä½“å’Œæ¥æºéƒ¨åˆ†</span><br><span class="line">    if &quot;## Sources&quot; in content:</span><br><span class="line">        try:</span><br><span class="line">            content, sources = content.split(&quot;\n## Sources\n&quot;)</span><br><span class="line">        except:</span><br><span class="line">            sources = None # å¦‚æœåˆ†ç¦»å¤±è´¥ï¼Œåˆ™æ¥æºéƒ¨åˆ†ä¸ºç©º</span><br><span class="line">    else:</span><br><span class="line">        sources = None</span><br><span class="line"></span><br><span class="line">    # å°†å¼•è¨€ã€ä¸»ä½“å†…å®¹å’Œç»“è®ºè¿æ¥èµ·æ¥å½¢æˆæœ€ç»ˆæŠ¥å‘Š</span><br><span class="line">    final_report = state[&quot;introduction&quot;] + &quot;\n\n---\n\n&quot; + content + &quot;\n\n---\n\n&quot; + state[&quot;conclusion&quot;]</span><br><span class="line">    # å¦‚æœå­˜åœ¨æ¥æºéƒ¨åˆ†ï¼Œåˆ™å°†å…¶é™„åŠ åˆ°æœ€ç»ˆæŠ¥å‘Šæœ«å°¾</span><br><span class="line">    if sources is not None:</span><br><span class="line">        final_report += &quot;\n\n## Sources\n&quot; + sources</span><br><span class="line">    # è¿”å›æœ€ç»ˆæŠ¥å‘Š</span><br><span class="line">    return &#123;&quot;final_report&quot;: final_report&#125;</span><br><span class="line"></span><br><span class="line"># æ·»åŠ èŠ‚ç‚¹å’Œè¾¹</span><br><span class="line">builder = StateGraph(ResearchGraphState)</span><br><span class="line">builder.add_node(&quot;create_analysts&quot;, create_analysts)</span><br><span class="line">builder.add_node(&quot;human_feedback&quot;, human_feedback)</span><br><span class="line">builder.add_node(&quot;conduct_interview&quot;, interview_builder.compile()) # å°†ä¹‹å‰å®šä¹‰çš„é‡‡è®¿å›¾ç¼–è¯‘åä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="line">builder.add_node(&quot;write_report&quot;, write_report)</span><br><span class="line">builder.add_node(&quot;write_introduction&quot;, write_introduction)</span><br><span class="line">builder.add_node(&quot;write_conclusion&quot;, write_conclusion)</span><br><span class="line">builder.add_node(&quot;finalize_report&quot;, finalize_report)</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å·¥ä½œæµé€»è¾‘</span><br><span class="line">builder.add_edge(START, &quot;create_analysts&quot;) # ä»å¼€å§‹åˆ°åˆ›å»ºåˆ†æå¸ˆ</span><br><span class="line">builder.add_edge(&quot;create_analysts&quot;, &quot;human_feedback&quot;) # åˆ›å»ºåˆ†æå¸ˆåè¿›å…¥äººç±»åé¦ˆç¯èŠ‚</span><br><span class="line"># æ¡ä»¶è¾¹ï¼šæ ¹æ® human_feedback èŠ‚ç‚¹çš„è¾“å‡ºï¼Œå†³å®šæ˜¯å›åˆ°åˆ›å»ºåˆ†æå¸ˆè¿˜æ˜¯å¼€å§‹é‡‡è®¿</span><br><span class="line">builder.add_conditional_edges(&quot;human_feedback&quot;, initiate_all_interviews, [&quot;create_analysts&quot;, &quot;conduct_interview&quot;]) </span><br><span class="line"># é‡‡è®¿å®Œæˆåï¼Œå¹¶è¡Œæ‰§è¡Œæ’°å†™æŠ¥å‘Šã€å¼•è¨€å’Œç»“è®º</span><br><span class="line">builder.add_edge(&quot;conduct_interview&quot;, &quot;write_report&quot;)</span><br><span class="line">builder.add_edge(&quot;conduct_interview&quot;, &quot;write_introduction&quot;)</span><br><span class="line">builder.add_edge(&quot;conduct_interview&quot;, &quot;write_conclusion&quot;)</span><br><span class="line"># æ’°å†™å®ŒæŠ¥å‘Šçš„ä¸‰ä¸ªéƒ¨åˆ†åï¼Œæ±‡èšåˆ°æœ€ç»ˆæ•´åˆæ­¥éª¤</span><br><span class="line">builder.add_edge([&quot;write_conclusion&quot;, &quot;write_report&quot;, &quot;write_introduction&quot;], &quot;finalize_report&quot;)</span><br><span class="line">builder.add_edge(&quot;finalize_report&quot;, END) # æœ€ç»ˆæ•´åˆåç»“æŸ</span><br><span class="line"></span><br><span class="line"># ç¼–è¯‘å›¾</span><br><span class="line">memory = MemorySaver()</span><br><span class="line"># ç¼–è¯‘å›¾ï¼Œå¹¶è®¾ç½®åœ¨ &#x27;human_feedback&#x27; èŠ‚ç‚¹å‰ä¸­æ–­ï¼Œä»¥åŠä½¿ç”¨æ£€æŸ¥ç‚¹ä¿å­˜å™¨</span><br><span class="line">graph = builder.compile(interrupt_before=[&#x27;human_feedback&#x27;], checkpointer=memory)</span><br><span class="line"># æ˜¾ç¤ºå›¾çš„å¯è§†åŒ–è¡¨ç¤º</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph%E5%AE%9E%E6%88%98-Research%20Assistant%E7%A0%94%E7%A9%B6%E5%8A%A9%E7%90%86/image-20250725102148881.png" alt="image-20250725102148881">
<figcaption aria-hidden="true">image-20250725102148881</figcaption>
</figure>
<h5 id="æµ‹è¯•">æµ‹è¯•</h5>
<p>è®©æˆ‘ä»¬æå‡ºä¸€ä¸ªå…³äº LangGraph çš„å¼€æ”¾å¼é—®é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">max_analysts = 3 </span><br><span class="line">topic = &quot;é‡‡ç”¨ LangGraph ä½œä¸ºä»£ç†æ¡†æ¶çš„å¥½å¤„&quot;</span><br><span class="line">thread = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨ stream ä½†ä¸æ‰§è¡Œæ‰“å°é€»è¾‘</span><br><span class="line">for event in graph.stream(&#123;</span><br><span class="line">    &quot;topic&quot;: topic,</span><br><span class="line">    &quot;max_analysts&quot;: max_analysts</span><br><span class="line">&#125;, thread, stream_mode=&quot;values&quot;):</span><br><span class="line">    pass  # ä¸æ‰§è¡Œä»»ä½•æ“ä½œ</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#äººå·¥æ›´æ–°èŠ‚ç‚¹</span><br><span class="line">graph.update_state(thread, &#123;&quot;human_analyst_feedback&quot;: </span><br><span class="line">                                &quot;è¯·åŠ å…¥è¿™å®¶åŸç”Ÿç”Ÿæˆå¼ AI åˆ›ä¸šå…¬å¸çš„é¦–å¸­æ‰§è¡Œå®˜ã€‚&quot;&#125;, as_node=&quot;human_feedback&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ç¡®è®¤æˆ‘ä»¬å·²ç»æ»¡æ„ï¼Œè¿”å›none</span><br><span class="line">graph.update_state(thread, &#123;&quot;human_analyst_feedback&quot;: </span><br><span class="line">                            None&#125;, as_node=&quot;human_feedback&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ç»§ç»­æ‰§è¡Œ</span><br><span class="line">for event in graph.stream(None, thread, stream_mode=&quot;updates&quot;):</span><br><span class="line">    print(&quot;--Node--&quot;)</span><br><span class="line">    node_name = next(iter(event.keys()))</span><br><span class="line">    print(node_name)</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph%E5%AE%9E%E6%88%98-Research%20Assistant%E7%A0%94%E7%A9%B6%E5%8A%A9%E7%90%86/image-20250725103159942.png" alt="image-20250725103159942">
<figcaption aria-hidden="true">image-20250725103159942</figcaption>
</figure>
<p>https://smith.langchain.com/public/6504cafd-d314-48d1-8640-57dc3f472e61/r</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/" class="post-title-link" itemprop="url">LangGraphå­¦ä¹ â€”â€”agentâ€”â€”ä¸‹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-22T00:00:00+08:00">2025-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-13 09:25:38" itemprop="dateModified" datetime="2025-08-13T09:25:38+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">aiæ¡†æ¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/langgraph/" itemprop="url" rel="index"><span itemprop="name">langgraph</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€">å‰è¨€</h3>
<p>æœ¬æ•™ç¨‹ä¸ºlangchainå®˜æ–¹æ•™ç¨‹çš„å­¦ä¹ è®°å½•</p>
<p><a target="_blank" rel="noopener" href="https://academy.langchain.com/enrollments">academy.langchain.com/enrollments</a></p>
<p>ä»£ç è§<a target="_blank" rel="noopener" href="https://github.com/zxj-2023/learn-rag-langchain">[learn-rag-langchain/academy-langgraph
at main Â·
zxj-2023/learn-rag-langchain](https://github.com/zxj-2023/learn-rag-langchain/tree/main/academy-langgraph)</a></p>
<h3 id="module-4">module-4</h3>
<h4 id="parallel-node-execution-å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ"><strong>Parallel node
execution</strong> <strong>å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ</strong></h4>
<h5 id="waiting-for-nodes-to-finish-ç­‰å¾…èŠ‚ç‚¹å®Œæˆ"><strong>Waiting for
nodes to finish</strong> <strong>ç­‰å¾…èŠ‚ç‚¹å®Œæˆ</strong></h5>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œè·¯å¾„çš„æ­¥éª¤æ¯”å¦ä¸€ä¸ªå¤šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"># Initialize each node with node_secret </span><br><span class="line">builder.add_node(&quot;a&quot;, ReturnNodeValue(&quot;I&#x27;m A&quot;))</span><br><span class="line">builder.add_node(&quot;b&quot;, ReturnNodeValue(&quot;I&#x27;m B&quot;))</span><br><span class="line">builder.add_node(&quot;b2&quot;, ReturnNodeValue(&quot;I&#x27;m B2&quot;))</span><br><span class="line">builder.add_node(&quot;c&quot;, ReturnNodeValue(&quot;I&#x27;m C&quot;))</span><br><span class="line">builder.add_node(&quot;d&quot;, ReturnNodeValue(&quot;I&#x27;m D&quot;))</span><br><span class="line"></span><br><span class="line"># Flow</span><br><span class="line">builder.add_edge(START, &quot;a&quot;)</span><br><span class="line">builder.add_edge(&quot;a&quot;, &quot;b&quot;)</span><br><span class="line">builder.add_edge(&quot;a&quot;, &quot;c&quot;)</span><br><span class="line">builder.add_edge(&quot;b&quot;, &quot;b2&quot;)</span><br><span class="line">builder.add_edge([&quot;b2&quot;, &quot;c&quot;], &quot;d&quot;)</span><br><span class="line">builder.add_edge(&quot;d&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250722143802652.png" alt="image-20250722143802652">
<figcaption aria-hidden="true">image-20250722143802652</figcaption>
</figure>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>b</code>ã€<code>b2</code> å’Œ <code>c</code>
éƒ½æ˜¯åŒä¸€ä¸ªæ­¥éª¤çš„ä¸€éƒ¨åˆ†ã€‚å›¾å½¢å°†åœ¨è¿›å…¥ <code>d</code>
æ­¥éª¤ä¹‹å‰ç­‰å¾…æ‰€æœ‰è¿™äº›æ“ä½œå®Œæˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(&#123;&quot;state&quot;: []&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Adding I&#x27;m A to []</span><br><span class="line">Adding I&#x27;m B to [&quot;I&#x27;m A&quot;]</span><br><span class="line">Adding I&#x27;m C to [&quot;I&#x27;m A&quot;]</span><br><span class="line">Adding I&#x27;m B2 to [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;]</span><br><span class="line">Adding I&#x27;m D to [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m B2&quot;]</span><br><span class="line">&#123;&#x27;state&#x27;: [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m B2&quot;, &quot;I&#x27;m D&quot;]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="setting-the-order-of-state-updates-è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº"><strong>Setting
the order of state updates</strong>
<strong>è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº</strong></h5>
<p>ç„¶è€Œï¼Œåœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬æ— æ³•å¯¹çŠ¶æ€æ›´æ–°çš„é¡ºåºè¿›è¡Œå…·ä½“æ§åˆ¶ï¼ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯åŸºäºå›¾æ‹“æ‰‘ç»“æ„ç”±
LangGraph ç¡®å®šçš„ç¡®å®šæ€§é¡ºåºï¼Œè¯¥é¡ºåºä¸º
<strong><em>*æˆ‘ä»¬æ— æ³•æ§åˆ¶*</em></strong>ã€‚</p>
<p>ä¸Šé¢ï¼Œæˆ‘ä»¬çœ‹åˆ° <code>c</code> è¢«æ·»åŠ åœ¨ <code>b2</code> ä¹‹å‰</p>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ reducer
æ¥å®šåˆ¶æ­¤åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œå¯¹çŠ¶æ€æ›´æ–°è¿›è¡Œæ’åºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def sorting_reducer(left, right):</span><br><span class="line">    &quot;&quot;&quot; åˆå¹¶å¹¶æ’åºåˆ—è¡¨ä¸­çš„å€¼&quot;&quot;&quot;</span><br><span class="line">    # å¦‚æœ left ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºåˆ—è¡¨</span><br><span class="line">    if not isinstance(left, list):</span><br><span class="line">        left = [left]</span><br><span class="line"></span><br><span class="line">    # å¦‚æœ right ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºåˆ—è¡¨</span><br><span class="line">    if not isinstance(right, list):</span><br><span class="line">        right = [right]</span><br><span class="line">    </span><br><span class="line">    # åˆå¹¶ left å’Œ right åˆ—è¡¨ï¼Œç„¶åå‡åºæ’åº</span><br><span class="line">    return sorted(left + right, reverse=False)</span><br><span class="line">class State(TypedDict):</span><br><span class="line">    # sorting_reducer å‡½æ•°å°†å¯¹ state ä¸­çš„å€¼è¿›è¡Œæ’åº</span><br><span class="line">    state: Annotated[list, sorting_reducer]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(&#123;&quot;state&quot;: []&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;state&#x27;: [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m B2&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m D&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œreducer å¯¹æ›´æ–°çš„çŠ¶æ€å€¼è¿›è¡Œæ’åºï¼<code>sorting_reducer</code>
ç¤ºä¾‹å¯¹æ‰€æœ‰å€¼è¿›è¡Œå…¨å±€æ’åºã€‚æˆ‘ä»¬è¿˜å¯ä»¥ï¼š</p>
<ol type="1">
<li>åœ¨å¹¶è¡Œæ­¥éª¤æœŸé—´å°†è¾“å‡ºå†™å…¥çŠ¶æ€ä¸­çš„å•ç‹¬å­—æ®µ<br>
</li>
<li>åœ¨å¹¶è¡Œæ­¥éª¤ä¹‹åä½¿ç”¨â€œæ±‡â€èŠ‚ç‚¹æ¥åˆå¹¶å’Œæ’åºè¿™äº›è¾“å‡º<br>
</li>
<li>åˆå¹¶åæ¸…é™¤ä¸´æ—¶å­—æ®µ</li>
</ol>
<p>è¯·å‚é˜… <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/branching/#stable-sorting">docs</a>
ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p>
<h5 id="working-with-llms-ä½¿ç”¨-llms"><strong>Working with LLMs</strong>
<strong>ä½¿ç”¨ LLMs</strong></h5>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç°å®ä¸­çš„ä¾‹å­ï¼æˆ‘ä»¬å¸Œæœ›ä»ä¸¤ä¸ªå¤–éƒ¨æ¥æºï¼ˆWikipedia
å’Œ Web-Searchï¼‰æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶è®© LLM å›ç­”ä¸€ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import HumanMessage, SystemMessage</span><br><span class="line"></span><br><span class="line">from langchain_community.document_loaders import WikipediaLoader</span><br><span class="line">from langchain_community.tools import TavilySearchResults</span><br><span class="line"></span><br><span class="line">def search_web(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç½‘ç»œæœç´¢ä¸­æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æœç´¢</span><br><span class="line">    tavily_search = TavilySearchResults(max_results=3)</span><br><span class="line">    search_docs = tavily_search.invoke(state[&#x27;question&#x27;])</span><br><span class="line"></span><br><span class="line">     # å°†å¤šä¸ªæœç´¢æ–‡æ¡£è½¬æ¢æˆäº†ä¸€ä¸ªç»Ÿä¸€æ ¼å¼çš„é•¿æ–‡æœ¬ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½æœ‰è‡ªå·±çš„å…ƒæ•°æ®ï¼ˆå¦‚URLï¼‰ï¼Œå¹¶ä¸”æ–‡æ¡£ä¹‹é—´æœ‰æ˜ç¡®çš„åˆ†éš”ï¼Œä¾¿äºåç»­å¤„ç†æˆ–å±•ç¤ºã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    - è¿™æ˜¯ä¸€ä¸ª åˆ—è¡¨æ¨å¯¼å¼ (list comprehension) ï¼Œå®ƒä¼šéå† search_docs åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼ˆè¿™é‡Œæˆ‘ä»¬ç§°ä¹‹ä¸º doc ï¼‰ã€‚</span><br><span class="line">    - search_docs é‡Œçš„æ¯ä¸ª doc åº”è¯¥æ˜¯ä¸€ä¸ªåŒ…å« &#x27;url&#x27; å’Œ &#x27;content&#x27; é”®çš„å­—å…¸ã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">        [</span><br><span class="line">            f&#x27;&lt;Document href=&quot;&#123;doc[&quot;url&quot;]&#125;&quot;&gt;\n&#123;doc[&quot;content&quot;]&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">            for doc in search_docs</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line"></span><br><span class="line">def search_wikipedia(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç»´åŸºç™¾ç§‘ä¸­æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æœç´¢</span><br><span class="line">    search_docs = WikipediaLoader(query=state[&#x27;question&#x27;], </span><br><span class="line">                                  load_max_docs=2).load()</span><br><span class="line"></span><br><span class="line">     # æ ¼å¼åŒ–</span><br><span class="line">    formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">        [</span><br><span class="line">            f&#x27;&lt;Document source=&quot;&#123;doc.metadata[&quot;source&quot;]&#125;&quot; page=&quot;&#123;doc.metadata.get(&quot;page&quot;, &quot;&quot;)&#125;&quot;&gt;\n&#123;doc.page_content&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">            for doc in search_docs</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line"></span><br><span class="line">def generate_answer(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ç”¨äºå›ç­”é—®é¢˜çš„èŠ‚ç‚¹ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–çŠ¶æ€</span><br><span class="line">    context = state[&quot;context&quot;]</span><br><span class="line">    question = state[&quot;question&quot;]</span><br><span class="line"></span><br><span class="line">    # æ¨¡æ¿</span><br><span class="line">    answer_template = &quot;&quot;&quot;ä½¿ç”¨ä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ &#123;question&#125;: &#123;context&#125;&quot;&quot;&quot;</span><br><span class="line">    answer_instructions = answer_template.format(question=question, </span><br><span class="line">                                                       context=context)    </span><br><span class="line">    </span><br><span class="line">    # å›ç­”</span><br><span class="line">    answer = llm.invoke([SystemMessage(content=answer_instructions)]+[HumanMessage(content=f&quot;å›ç­”é—®é¢˜ã€‚&quot;)])</span><br><span class="line">      </span><br><span class="line">    # å°†å…¶é™„åŠ åˆ°çŠ¶æ€</span><br><span class="line">    return &#123;&quot;answer&quot;: answer&#125;</span><br><span class="line"></span><br><span class="line"># æ·»åŠ èŠ‚ç‚¹</span><br><span class="line">builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–æ¯ä¸ªèŠ‚ç‚¹</span><br><span class="line">builder.add_node(&quot;search_web&quot;,search_web)</span><br><span class="line">builder.add_node(&quot;search_wikipedia&quot;, search_wikipedia)</span><br><span class="line">builder.add_node(&quot;generate_answer&quot;, generate_answer)</span><br><span class="line"></span><br><span class="line"># æµç¨‹</span><br><span class="line">builder.add_edge(START, &quot;search_wikipedia&quot;)</span><br><span class="line">builder.add_edge(START, &quot;search_web&quot;)</span><br><span class="line">builder.add_edge(&quot;search_wikipedia&quot;, &quot;generate_answer&quot;)</span><br><span class="line">builder.add_edge(&quot;search_web&quot;, &quot;generate_answer&quot;)</span><br><span class="line">builder.add_edge(&quot;generate_answer&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250722153534867.png" alt="image-20250722153534867">
<figcaption aria-hidden="true">image-20250722153534867</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = graph.invoke(&#123;&quot;question&quot;: &quot;è‹±ä¼Ÿè¾¾2025å¹´ç¬¬ä¸€å­£åº¦è´¢æŠ¥è¡¨ç°å¦‚ä½•&quot;&#125;)</span><br><span class="line">result[&#x27;answer&#x27;].content</span><br></pre></td></tr></table></figure>
<h4 id="sub-graphs-å­å›¾"><strong>Sub-graphs</strong> å­å›¾</h4>
<p>å­å›¾å…è®¸ä½ åœ¨å›¾è¡¨çš„ä¸åŒéƒ¨åˆ†åˆ›å»ºå’Œç®¡ç†ä¸åŒçš„çŠ¶æ€ã€‚è¿™åœ¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­å°¤å…¶æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨æ¯ä¸ªæ™ºèƒ½ä½“éƒ½æœ‰å„è‡ªçŠ¶æ€çš„æ™ºèƒ½ä½“å›¢é˜Ÿä¸­ã€‚</p>
<p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<ul>
<li>æˆ‘æœ‰ä¸€ä¸ªç³»ç»Ÿï¼Œå®ƒæ¥æ”¶æ—¥å¿—ã€‚</li>
<li>è¯¥ç³»ç»Ÿé€šè¿‡ä¸åŒçš„ä»£ç†æ‰§è¡Œä¸¤ä¸ªç‹¬ç«‹çš„å­ä»»åŠ¡ï¼ˆæ€»ç»“æ—¥å¿—ï¼ŒæŸ¥æ‰¾æ•…éšœæ¨¡å¼ï¼‰ã€‚</li>
<li>æˆ‘å¸Œæœ›åœ¨ä¸¤ä¸ªä¸åŒçš„å­å›¾ä¸­æ‰§è¡Œè¿™ä¸¤ä¸ªæ“ä½œã€‚</li>
</ul>
<p>æœ€é‡è¦çš„æ˜¯è¦ç†è§£å›¾è¡¨æ˜¯å¦‚ä½•ä¼ è¾¾ä¿¡æ¯çš„ï¼</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œé€šä¿¡æ˜¯ <strong><em>*é€šè¿‡é‡å å¯†é’¥*</em></strong>
å®ç°çš„ï¼š</p>
<ul>
<li>å­å›¾å¯ä»¥è®¿é—®çˆ¶å›¾ä¸­çš„ <code>docs</code>ï¼ˆæ–‡æ¡£ï¼‰ã€‚</li>
<li>çˆ¶å›¾å¯ä»¥ä»å­å›¾ä¸­è®¿é—® <code>summary</code>ï¼ˆæ‘˜è¦ï¼‰å’Œ
<code>failure_report</code>ï¼ˆæ•…éšœæŠ¥å‘Šï¼‰ã€‚</li>
</ul>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/66dbb1abf89f2d847ee6f1ff_sub-graph1.png" alt="subgraph.png">
<figcaption aria-hidden="true">subgraph.png</figcaption>
</figure>
<ol type="1">
<li><strong>Logs (Traces)</strong>:
<ul>
<li>è¿™æ˜¯ç³»ç»Ÿçš„è¾“å…¥ï¼Œè¡¨ç¤ºä¸€ç³»åˆ—çš„æ—¥å¿—è®°å½•ã€‚</li>
</ul></li>
<li><strong>Entry Graph</strong>:
<ul>
<li>è¿™æ˜¯ç³»ç»Ÿçš„å…¥å£å›¾ï¼Œå®ƒåŒ…å«äº†æ€»ä½“çŠ¶æ€ï¼ˆOverall Stateï¼‰ï¼Œå…¶ä¸­åŒ…å«ï¼š
<ul>
<li><code>docs</code>ï¼šæ–‡æ¡£æˆ–æ—¥å¿—æ•°æ®ã€‚</li>
<li><code>summary report</code>ï¼šæ‘˜è¦æŠ¥å‘Šï¼Œè¿™æ˜¯ç³»ç»Ÿæ‰§è¡Œæ‘˜è¦ä»»åŠ¡åç”Ÿæˆçš„ã€‚</li>
<li><code>failure report</code>ï¼šæ•…éšœæŠ¥å‘Šï¼Œè¿™æ˜¯ç³»ç»Ÿæ‰§è¡Œæ•…éšœåˆ†æä»»åŠ¡åç”Ÿæˆçš„ã€‚</li>
</ul></li>
</ul></li>
<li><strong>Call sub-graphs</strong>:
<ul>
<li>è¿™æ˜¯ä»å…¥å£å›¾è°ƒç”¨ä¸¤ä¸ªå­å›¾çš„è¿‡ç¨‹ï¼Œåˆ†åˆ«ç”¨äºæ‰§è¡Œæ‘˜è¦å’Œæ•…éšœåˆ†æä»»åŠ¡ã€‚</li>
</ul></li>
<li><strong>Summarization</strong>:
<ul>
<li>è¿™ä¸ªå­å›¾è´Ÿè´£ç”Ÿæˆæ—¥å¿—çš„æ‘˜è¦ã€‚å®ƒçš„çŠ¶æ€ï¼ˆSummary Stateï¼‰åŒ…å«ï¼š
<ul>
<li><code>docs</code>ï¼šä¸å…¥å£å›¾å…±äº«çš„æ–‡æ¡£æ•°æ®ã€‚</li>
<li><code>summary</code>ï¼šæ‘˜è¦å†…å®¹ã€‚</li>
<li><code>summary report</code>ï¼šæ‘˜è¦æŠ¥å‘Šï¼Œè¿™æ˜¯æ‘˜è¦ä»»åŠ¡å®Œæˆåç”Ÿæˆçš„ã€‚</li>
</ul></li>
</ul></li>
<li><strong>Failure Analysis</strong>:
<ul>
<li>è¿™ä¸ªå­å›¾è´Ÿè´£åˆ†ææ—¥å¿—ä¸­çš„æ•…éšœæ¨¡å¼ã€‚å®ƒçš„çŠ¶æ€ï¼ˆFailure Analysis
Stateï¼‰åŒ…å«ï¼š
<ul>
<li><code>docs</code>ï¼šä¸å…¥å£å›¾å…±äº«çš„æ–‡æ¡£æ•°æ®ã€‚</li>
<li><code>failures</code>ï¼šæ•…éšœæ¨¡å¼ã€‚</li>
<li><code>failure report</code>ï¼šæ•…éšœæŠ¥å‘Šï¼Œè¿™æ˜¯æ•…éšœåˆ†æä»»åŠ¡å®Œæˆåç”Ÿæˆçš„ã€‚</li>
</ul></li>
</ul></li>
<li><strong>Finish</strong>:
<ul>
<li>è¿™æ˜¯æµç¨‹çš„ç»“æŸç‚¹ï¼Œè¡¨ç¤ºä¸¤ä¸ªå­å›¾çš„ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œå¹¶ä¸”ç”Ÿæˆäº†æ‘˜è¦æŠ¥å‘Šå’Œæ•…éšœæŠ¥å‘Šã€‚</li>
</ul></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from operator import add</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line">from typing import List, Optional, Annotated</span><br><span class="line"></span><br><span class="line">#logsç»“æ„</span><br><span class="line">class Log(TypedDict):</span><br><span class="line">    id: str</span><br><span class="line">    question: str</span><br><span class="line">    docs: Optional[List]</span><br><span class="line">    answer: str</span><br><span class="line">    grade: Optional[int]</span><br><span class="line">    grader: Optional[str]</span><br><span class="line">    feedback: Optional[str]</span><br></pre></td></tr></table></figure>
<h5 id="sub-graphs"><strong>Sub graphs</strong></h5>
<p>è¿™é‡Œæ˜¯å¤±è´¥åˆ†æå­å›¾ï¼Œå®ƒä½¿ç”¨äº† <code>FailureAnalysisState</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line">from langgraph.graph import StateGraph, START, END</span><br><span class="line"></span><br><span class="line"># æ•…éšœåˆ†æå­å›¾</span><br><span class="line">class FailureAnalysisState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;ç”¨äºæ•…éšœåˆ†æçš„çŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs: List[Log] # æ¸…ç†åçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    failures: List[Log]     # åŒ…å«æ•…éšœçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    fa_summary: str         # æ•…éšœåˆ†ææ‘˜è¦</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class FailureAnalysisOutputState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;æ•…éšœåˆ†æçš„è¾“å‡ºçŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    fa_summary: str         # æ•…éšœåˆ†ææ‘˜è¦</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">def get_failures(state):</span><br><span class="line">    &quot;&quot;&quot;è·å–åŒ…å«æ•…éšœçš„æ—¥å¿—&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs = state[&quot;cleaned_logs&quot;]</span><br><span class="line">    # ä»æ¸…ç†åçš„æ—¥å¿—ä¸­ç­›é€‰å‡ºåŒ…å« &quot;grade&quot; é”®çš„æ—¥å¿—ï¼Œè¿™äº›è¢«è§†ä¸ºæ•…éšœ</span><br><span class="line">    failures = [log for log in cleaned_logs if &quot;grade&quot; in log]</span><br><span class="line">    return &#123;&quot;failures&quot;: failures&#125;</span><br><span class="line"></span><br><span class="line">def generate_summary(state):</span><br><span class="line">    &quot;&quot;&quot;ç”Ÿæˆæ•…éšœæ‘˜è¦&quot;&quot;&quot;</span><br><span class="line">    failures = state[&quot;failures&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šfa_summary = summary_generation(qs_summary)</span><br><span class="line">    fa_summary = &quot;Chroma æ–‡æ¡£çš„æ£€ç´¢è´¨é‡ä¸ä½³ã€‚&quot;</span><br><span class="line">    # ä¸ºæ¯ä¸ªæ•…éšœæ—¥å¿—ç”Ÿæˆä¸€ä¸ªå¤„ç†è¿‡çš„æ—¥å¿—æ ‡è¯†ç¬¦</span><br><span class="line">    return &#123;&quot;fa_summary&quot;: fa_summary, &quot;processed_logs&quot;: [f&quot;failure-analysis-on-log-&#123;failure[&#x27;id&#x27;]&#125;&quot; for failure in failures]&#125;</span><br><span class="line"></span><br><span class="line">fa_builder = StateGraph(state_schema=FailureAnalysisState,output_schema=FailureAnalysisOutputState)</span><br><span class="line">fa_builder.add_node(&quot;get_failures&quot;, get_failures)</span><br><span class="line">fa_builder.add_node(&quot;generate_summary&quot;, generate_summary)</span><br><span class="line">fa_builder.add_edge(START, &quot;get_failures&quot;)</span><br><span class="line">fa_builder.add_edge(&quot;get_failures&quot;, &quot;generate_summary&quot;)</span><br><span class="line">fa_builder.add_edge(&quot;generate_summary&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = fa_builder.compile()</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723094949158.png" alt="image-20250723094949158">
<figcaption aria-hidden="true">image-20250723094949158</figcaption>
</figure>
<p>è¿™é‡Œæ˜¯é—®é¢˜æ€»ç»“å­å›¾ï¼Œå®ƒä½¿ç”¨äº†
<code>QuestionSummarizationState</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># æ‘˜è¦ç”Ÿæˆå­å›¾</span><br><span class="line">class QuestionSummarizationState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;ç”¨äºé—®é¢˜æ‘˜è¦çš„çŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs: List[Log] # æ¸…ç†åçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    qs_summary: str         # é—®é¢˜æ‘˜è¦</span><br><span class="line">    report: str             # ä»æ‘˜è¦ç”Ÿæˆçš„æŠ¥å‘Š</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class QuestionSummarizationOutputState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;é—®é¢˜æ‘˜è¦çš„è¾“å‡ºçŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    report: str             # æœ€ç»ˆæŠ¥å‘Š</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">def generate_summary(state):</span><br><span class="line">    &quot;&quot;&quot;ä»æ—¥å¿—ç”Ÿæˆæ‘˜è¦ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs = state[&quot;cleaned_logs&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šsummary = summarize(generate_summary)</span><br><span class="line">    summary = &quot;é—®é¢˜é›†ä¸­åœ¨ ChatOllama å’Œ Chroma å‘é‡å­˜å‚¨çš„ä½¿ç”¨ä¸Šã€‚&quot;</span><br><span class="line">    # è¿”å›æ‘˜è¦ä»¥åŠå·²å¤„ç†çš„æ—¥å¿—ID</span><br><span class="line">    return &#123;&quot;qs_summary&quot;: summary, &quot;processed_logs&quot;: [f&quot;summary-on-log-&#123;log[&#x27;id&#x27;]&#125;&quot; for log in cleaned_logs]&#125;</span><br><span class="line"></span><br><span class="line">def send_to_slack(state):</span><br><span class="line">    &quot;&quot;&quot;æ¨¡æ‹Ÿå‘é€æŠ¥å‘Šã€‚&quot;&quot;&quot;</span><br><span class="line">    qs_summary = state[&quot;qs_summary&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šreport = report_generation(qs_summary)</span><br><span class="line">    report = &quot;foo bar baz&quot;</span><br><span class="line">    return &#123;&quot;report&quot;: report&#125;</span><br><span class="line"></span><br><span class="line">qs_builder = StateGraph(QuestionSummarizationState,output_schema=QuestionSummarizationOutputState)</span><br><span class="line">qs_builder.add_node(&quot;generate_summary&quot;, generate_summary)</span><br><span class="line">qs_builder.add_node(&quot;send_to_slack&quot;, send_to_slack)</span><br><span class="line">qs_builder.add_edge(START, &quot;generate_summary&quot;)</span><br><span class="line">qs_builder.add_edge(&quot;generate_summary&quot;, &quot;send_to_slack&quot;)</span><br><span class="line">qs_builder.add_edge(&quot;send_to_slack&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = qs_builder.compile()</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723100648199.png" alt="image-20250723100648199">
<figcaption aria-hidden="true">image-20250723100648199</figcaption>
</figure>
<h5 id="adding-sub-graphs-to-our-parent-graph-å‘çˆ¶å›¾æ·»åŠ å­å›¾"><strong>Adding
sub graphs to our parent graph </strong>
<strong>å‘çˆ¶å›¾æ·»åŠ å­å›¾</strong></h5>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ã€‚æˆ‘ä»¬ä½¿ç”¨
<code>EntryGraphState</code>
åˆ›å»ºçˆ¶å›¾ã€‚å¹¶ä¸”æˆ‘ä»¬å°†æˆ‘ä»¬çš„å­å›¾æ·»åŠ ä¸ºèŠ‚ç‚¹ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å…¥å£å›¾</span><br><span class="line">class EntryGraphState(TypedDict):</span><br><span class="line">    # åŸå§‹æ—¥å¿—æ•°æ®åˆ—è¡¨</span><br><span class="line">    raw_logs: List[Log]</span><br><span class="line">    # ç»è¿‡æ¸…æ´—å¤„ç†åçš„æ—¥å¿—æ•°æ®åˆ—è¡¨</span><br><span class="line">    cleaned_logs: List[Log]</span><br><span class="line">    fa_summary: str # è¿™åªä¼šåœ¨æ•…éšœåˆ†æå­å›¾ä¸­ç”Ÿæˆ</span><br><span class="line">    report: str # è¿™åªä¼šåœ¨é—®é¢˜æ‘˜è¦å­å›¾ä¸­ç”Ÿæˆ</span><br><span class="line">    processed_logs:  Annotated[List[int], add] # è·Ÿè¸ªå“ªäº›æ—¥å¿—å·²ç»è¢«å¤„ç†è¿‡ ï¼Œå°¤å…¶æ˜¯åœ¨å­å›¾ä¹‹é—´å…±äº«çŠ¶æ€æ—¶ã€‚</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def clean_logs(state):</span><br><span class="line">    # è·å–æ—¥å¿—</span><br><span class="line">    raw_logs = state[&quot;raw_logs&quot;]</span><br><span class="line">    # æ•°æ®æ¸…æ´— raw_logs -&gt; docs</span><br><span class="line">    cleaned_logs = raw_logs</span><br><span class="line">    return &#123;&quot;cleaned_logs&quot;: cleaned_logs&#125;</span><br><span class="line"></span><br><span class="line">entry_builder = StateGraph(EntryGraphState)</span><br><span class="line">entry_builder.add_node(&quot;clean_logs&quot;, clean_logs)</span><br><span class="line">#æ·»åŠ å­å›¾</span><br><span class="line">entry_builder.add_node(&quot;question_summarization&quot;, qs_builder.compile())</span><br><span class="line">entry_builder.add_node(&quot;failure_analysis&quot;, fa_builder.compile())</span><br><span class="line"></span><br><span class="line">entry_builder.add_edge(START, &quot;clean_logs&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;clean_logs&quot;, &quot;failure_analysis&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;clean_logs&quot;, &quot;question_summarization&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;failure_analysis&quot;, END)</span><br><span class="line">entry_builder.add_edge(&quot;question_summarization&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = entry_builder.compile()</span><br><span class="line"></span><br><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line"># å°† xray è®¾ç½®ä¸º 1 å°†æ˜¾ç¤ºåµŒå¥—å›¾çš„å†…éƒ¨ç»“æ„</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723102913524.png" alt="image-20250723102913524">
<figcaption aria-hidden="true">image-20250723102913524</figcaption>
</figure>
<h4 id="map-reduce"><strong>Map-reduce</strong></h4>
<p>LangGraph é‡Œçš„ <strong>Map-Reduce</strong>
æ˜¯ä¸€ç§<strong>å¹¶è¡Œå¤„ç†æ¨¡å¼</strong>ï¼Œç”¨äºå°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼ˆMapï¼‰ï¼Œå†æ±‡æ€»ç»“æœï¼ˆReduceï¼‰ã€‚è¿™æ˜¯
LangGraph
ä¸­å¤„ç†<strong>æ‰¹é‡æ•°æ®æˆ–å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ</strong>çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚</p>
<p>è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå°†å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol type="1">
<li><strong>æ˜ å°„ï¼ˆMapï¼‰</strong> â€”â€” æ ¹æ®ä¸»é¢˜ç”Ÿæˆä¸€ç»„ç¬‘è¯ã€‚<br>
</li>
<li><strong>å½’çº¦ï¼ˆReduceï¼‰</strong> â€”â€” ä»è¿™ç»„ç¬‘è¯ä¸­æŒ‘å‡ºæœ€æ£’çš„ä¸€æ¡ã€‚</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line"></span><br><span class="line"># Prompts we will use</span><br><span class="line">subjects_prompt = &quot;&quot;&quot;ç”Ÿæˆä¸€ä¸ªåŒ…å«3ä¸ªå­ä¸»é¢˜çš„åˆ—è¡¨ï¼Œè¿™äº›å­ä¸»é¢˜éƒ½ä¸ä»¥ä¸‹æ€»ä½“ä¸»é¢˜ç›¸å…³ï¼š&#123;topic&#125;ã€‚&quot;&quot;&quot;</span><br><span class="line">joke_prompt = &quot;&quot;&quot;ç”Ÿæˆä¸€ä¸ªå…³äº&#123;subject&#125;çš„ç¬‘è¯&quot;&quot;&quot;</span><br><span class="line">best_joke_prompt = &quot;&quot;&quot;ä¸‹é¢æ˜¯å…³äº&#123;topic&#125;çš„ä¸€å †ç¬‘è¯ã€‚é€‰æ‹©æœ€å¥½çš„ä¸€ä¸ªï¼è¿”å›æœ€å¥½ç¬‘è¯çš„IDï¼Œç¬¬ä¸€ä¸ªç¬‘è¯çš„IDä»0å¼€å§‹ã€‚ç¬‘è¯ï¼š\n\n  &#123;jokes&#125;&quot;&quot;&quot;</span><br><span class="line"># LLM</span><br><span class="line">model = ChatOpenAI(</span><br><span class="line">    model=&quot;qwen-plus-2025-04-28&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;,</span><br><span class="line">    base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h5 id="parallelizing-joke-generation-å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ"><strong>Parallelizing
joke generation</strong> <strong>å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ</strong></h5>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰å›¾çš„å…¥å£ç‚¹ï¼Œå®ƒå°†ï¼š</p>
<ul>
<li>æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„ä¸»é¢˜<br>
</li>
<li>åŸºäºè¯¥ä¸»é¢˜ç”Ÿæˆè‹¥å¹²â€œç¬‘è¯å­ä¸»é¢˜â€<br>
</li>
<li>å°†æ¯ä¸ªå­ä¸»é¢˜å‘é€åˆ°ä¸Šé¢å®šä¹‰çš„ç¬‘è¯ç”ŸæˆèŠ‚ç‚¹</li>
</ul>
<p>æˆ‘ä»¬çš„çŠ¶æ€æœ‰ä¸€ä¸ª <code>jokes</code>
é”®ï¼Œå®ƒå°†ç´¯ç§¯æ¥è‡ªå¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆçš„ç¬‘è¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Subjects(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰ä¸€ä¸ªPydanticæ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºä¸»é¢˜åˆ—è¡¨ã€‚&quot;&quot;&quot;</span><br><span class="line">    subjects: list[str] # ä¸»é¢˜å­—ç¬¦ä¸²åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class BestJoke(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰ä¸€ä¸ªPydanticæ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºæœ€ä½³ç¬‘è¯çš„IDã€‚&quot;&quot;&quot;</span><br><span class="line">    id: int # æœ€ä½³ç¬‘è¯çš„ç´¢å¼•ID</span><br><span class="line">    </span><br><span class="line">class OverallState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰æ•´ä¸ªå›¾çš„æ€»ä½“çŠ¶æ€ï¼Œä½¿ç”¨TypedDictä»¥ä¾¿äºç±»å‹æç¤ºå’ŒçŠ¶æ€ç®¡ç†ã€‚&quot;&quot;&quot;</span><br><span class="line">    topic: str # å½“å‰è®¨è®ºçš„ä¸»é¢˜</span><br><span class="line">    subjects: list # ç”Ÿæˆçš„å­ä¸»é¢˜åˆ—è¡¨</span><br><span class="line">    jokes: Annotated[list, operator.add] # ç¬‘è¯åˆ—è¡¨ï¼Œä½¿ç”¨operator.addè¡¨ç¤ºåˆ—è¡¨å†…å®¹ä¼šç´¯åŠ è€Œä¸æ˜¯è¦†ç›–</span><br><span class="line">    best_selected_joke: str # æœ€ç»ˆé€‰å‡ºçš„æœ€ä½³ç¬‘è¯</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆç¬‘è¯çš„ä¸»é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#ç”¨äºç”Ÿæˆä¸»é¢˜</span><br><span class="line">def generate_topics(state: OverallState):</span><br><span class="line">    #ä½¿ç”¨ Python çš„ format() æ–¹æ³•æ¥æ„å»ºä¸€ä¸ªæç¤ºå­—ç¬¦ä¸²ï¼ˆ prompt ï¼‰</span><br><span class="line">    prompt = subjects_prompt.format(topic=state[&quot;topic&quot;])</span><br><span class="line">    #.with_structured_output(Subjects) å®ƒæŒ‡ç¤ºæ¨¡å‹å°è¯•å°†å…¶è¾“å‡ºæ ¼å¼åŒ–ä¸º Subjects ç±»</span><br><span class="line">    response = model.with_structured_output(Subjects).invoke(prompt)</span><br><span class="line">    return &#123;&quot;subjects&quot;: response.subjects&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯å¦™å¤„ï¼šæˆ‘ä»¬åˆ©ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/low_level/#send"><code>Send</code></a>
ä¸ºæ¯ä¸ªä¸»é¢˜å¹¶è¡Œç”Ÿæˆç¬‘è¯ã€‚</p>
<p>éå¸¸å®ç”¨ï¼æ— è®ºä¸»é¢˜æ•°é‡å¤šå°‘ï¼Œå®ƒéƒ½èƒ½è‡ªåŠ¨å¹¶è¡Œå¤„ç†ã€‚</p>
<ul>
<li><code>generate_joke</code>ï¼šå›¾ä¸­èŠ‚ç‚¹çš„åå­—<br>
</li>
<li><code>&#123;"subject": s&#125;</code>ï¼šè¦ä¼ é€’çš„çŠ¶æ€</li>
</ul>
<p><code>Send</code> å…è®¸ä½ å‘ <code>generate_joke</code>
èŠ‚ç‚¹å‘é€<strong>ä»»æ„</strong>ç»“æ„çš„çŠ¶æ€ï¼Œæ— éœ€ä¸
<code>OverallState</code> å¯¹é½ã€‚<br>
åœ¨è¿™é‡Œï¼Œ<code>generate_joke</code> ä½¿ç”¨è‡ªå·±çš„å†…éƒ¨çŠ¶æ€ï¼Œæˆ‘ä»¬é€šè¿‡
<code>Send</code> æŒ‰éœ€å¡«å……å³å¯ã€‚</p>
<blockquote>
<p>åœ¨ LangGraph é‡Œï¼Œ<code>Send</code>
æ˜¯ä¸€ä¸ª<strong>â€œåŠ¨æ€æ´¾å‘å™¨â€</strong>ï¼šå®ƒè®©ä½ <strong>åœ¨è¿è¡Œæ—¶</strong>å†³å®šâ€œè¦æŠŠå“ªä¸ªèŠ‚ç‚¹è¿è¡Œå¤šå°‘æ¬¡ã€æ¯æ¬¡ç»™å®ƒä»€ä¹ˆæ•°æ®â€ï¼Œå¹¶è‡ªåŠ¨å¹¶è¡Œæ‰§è¡Œã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.types import Send</span><br><span class="line">def continue_to_jokes(state: OverallState):</span><br><span class="line">    # è¯¥å‡½æ•°æ ¹æ®å½“å‰çŠ¶æ€ä¸­çš„ä¸»é¢˜åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªä¸»é¢˜ç”Ÿæˆä¸€ä¸ª Send å¯¹è±¡ã€‚</span><br><span class="line">    # æ¯ä¸ª Send å¯¹è±¡éƒ½æŒ‡ç¤ºå›¾å°†æ•°æ®å‘é€åˆ°åä¸º &quot;generate_joke&quot; çš„èŠ‚ç‚¹ï¼Œ</span><br><span class="line">    # å¹¶å°†å½“å‰ä¸»é¢˜ä½œä¸º &quot;subject&quot; å‚æ•°ä¼ é€’ï¼Œä»è€Œå®ç°å¹¶è¡Œç”Ÿæˆç¬‘è¯ã€‚</span><br><span class="line">    return [Send(&quot;generate_joke&quot;, &#123;&quot;subject&quot;: s&#125;) for s in state[&quot;subjects&quot;]]</span><br></pre></td></tr></table></figure>
<h5 id="joke-generation-map-ç¬‘è¯ç”Ÿæˆ"><strong>Joke generation
(map)</strong> <strong>ç¬‘è¯ç”Ÿæˆ</strong></h5>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹æ¥ç”Ÿæˆç¬‘è¯ï¼Œå‘½åä¸º
<code>generate_joke</code>ï¼</p>
<p>ç”Ÿæˆçš„ç¬‘è¯ä¼šè¢«å†™å›åˆ° <code>OverallState</code> ä¸­çš„
<code>jokes</code> å­—æ®µã€‚ è¯¥å­—æ®µé…æœ‰
reducerï¼Œèƒ½å¤Ÿè‡ªåŠ¨æŠŠå¤šæ¬¡å†™å…¥çš„åˆ—è¡¨åˆå¹¶æˆä¸€ä¸ªå¤§åˆ—è¡¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># å®šä¹‰ JokeStateï¼Œç”¨äºè¡¨ç¤ºç”Ÿæˆç¬‘è¯ä»»åŠ¡çš„è¾“å…¥çŠ¶æ€ã€‚</span><br><span class="line">class JokeState(TypedDict):</span><br><span class="line">    subject: str#ç¬‘è¯çš„ä¸»é¢˜</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ Joke æ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºæ¨¡å‹ç”Ÿæˆçš„ç¬‘è¯çš„ç»“æ„ã€‚</span><br><span class="line">class Joke(BaseModel):</span><br><span class="line">    joke: str#ç¬‘è¯çš„æ–‡æœ¬å†…å®¹</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ç”Ÿæˆç¬‘è¯çš„å‡½æ•°ã€‚</span><br><span class="line">def generate_joke(state: JokeState):</span><br><span class="line">    # æ ¹æ® joke_prompt æ¨¡æ¿å’Œå½“å‰çŠ¶æ€ä¸­çš„ä¸»é¢˜æ ¼å¼åŒ–æç¤ºã€‚</span><br><span class="line">    prompt = joke_prompt.format(subject=state[&quot;subject&quot;])</span><br><span class="line">    # è°ƒç”¨è¯­è¨€æ¨¡å‹ï¼Œå¹¶æŒ‡å®šè¾“å‡ºåº”ç»“æ„åŒ–ä¸º Joke ç±»å‹ã€‚</span><br><span class="line">    response = model.with_structured_output(Joke).invoke(prompt)</span><br><span class="line">    # è¿”å›ä¸€ä¸ªåŒ…å«ç”Ÿæˆçš„ç¬‘è¯çš„å­—å…¸ï¼Œé”®ä¸º &quot;jokes&quot;ã€‚</span><br><span class="line">    return &#123;&quot;jokes&quot;: [response.joke]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="best-joke-selection-reduce-æœ€ä½³ç¬‘è¯é€‰æ‹©"><strong>Best joke
selection (reduce)</strong> <strong>æœ€ä½³ç¬‘è¯é€‰æ‹©</strong></h5>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ·»åŠ é€»è¾‘æ¥æŒ‘é€‰æœ€å¥½çš„ç¬‘è¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def best_joke(state: OverallState):</span><br><span class="line">    # å°†çŠ¶æ€ä¸­æ‰€æœ‰ç¬‘è¯åˆ—è¡¨è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªç¬‘è¯ä¹‹é—´ç”¨ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš”</span><br><span class="line">    jokes = &quot;\n\n&quot;.join(state[&quot;jokes&quot;])</span><br><span class="line">    # ä½¿ç”¨ä¸»é¢˜å’Œæ‰€æœ‰ç¬‘è¯æ ¼å¼åŒ–æœ€ä½³ç¬‘è¯æç¤ºè¯­</span><br><span class="line">    prompt = best_joke_prompt.format(topic=state[&quot;topic&quot;], jokes=jokes)</span><br><span class="line">    # è°ƒç”¨æ¨¡å‹ï¼ŒæœŸæœ›å…¶è¾“å‡ºç¬¦åˆ BestJoke ç»“æ„ï¼ˆåŒ…å«æœ€ä½³ç¬‘è¯çš„IDï¼‰</span><br><span class="line">    response = model.with_structured_output(BestJoke).invoke(prompt)</span><br><span class="line">    # æ ¹æ®æ¨¡å‹è¿”å›çš„IDï¼Œä»ç¬‘è¯åˆ—è¡¨ä¸­é€‰æ‹©æœ€ä½³ç¬‘è¯ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨çŠ¶æ€çš„ best_selected_joke å­—æ®µä¸­</span><br><span class="line">    return &#123;&quot;best_selected_joke&quot;: state[&quot;jokes&quot;][response.id]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="compile-ç¼–è¯‘"><strong>Compile</strong> ç¼–è¯‘</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image</span><br><span class="line">from langgraph.graph import END, StateGraph, START</span><br><span class="line"></span><br><span class="line"># æ„å»ºå›¾ï¼šå°†æ‰€æœ‰ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·æ„å»ºæˆ‘ä»¬çš„æµç¨‹å›¾</span><br><span class="line">graph = StateGraph(OverallState)</span><br><span class="line"></span><br><span class="line">graph.add_node(&quot;generate_topics&quot;, generate_topics)</span><br><span class="line">graph.add_node(&quot;generate_joke&quot;, generate_joke)</span><br><span class="line">graph.add_node(&quot;best_joke&quot;, best_joke)</span><br><span class="line"></span><br><span class="line">graph.add_edge(START, &quot;generate_topics&quot;)</span><br><span class="line"># æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ç»§ç»­ç”Ÿæˆç¬‘è¯</span><br><span class="line">graph.add_conditional_edges(&quot;generate_topics&quot;, continue_to_jokes, [&quot;generate_joke&quot;])</span><br><span class="line"># ç”Ÿæˆç¬‘è¯åæ‰§è¡Œé€‰æ‹©æœ€ä½³ç¬‘è¯</span><br><span class="line">graph.add_edge(&quot;generate_joke&quot;, &quot;best_joke&quot;)</span><br><span class="line"># é€‰æ‹©æœ€ä½³ç¬‘è¯åæµç¨‹ç»“æŸ</span><br><span class="line">graph.add_edge(&quot;best_joke&quot;, END)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = graph.compile()</span><br><span class="line">Image(app.get_graph().draw_mermaid_png())</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723112736244.png" alt="image-20250723112736244">
<figcaption aria-hidden="true">image-20250723112736244</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for s in app.stream(&#123;&quot;topic&quot;: &quot;æ—¥æœ¬å¹¿å²›åŸå­å¼¹&quot;&#125;):</span><br><span class="line">    print(s)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;generate_topics&#x27;: &#123;&#x27;subjects&#x27;: [&#x27;åŸå­å¼¹æŠ•æ”¾çš„å†å²èƒŒæ™¯ä¸å†³ç­–è¿‡ç¨‹&#x27;, &#x27;å¹¿å²›åŸçˆ†å¯¹åŸå¸‚ä¸å±…æ°‘çš„å½±å“&#x27;, &#x27;æˆ˜åå’Œå¹³è¿åŠ¨ä¸æ ¸è£å†›å€¡è®®&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&#x27;ä¸ºä»€ä¹ˆå¹¿å²›çš„é‡å»ºè®¡åˆ’ä»ä¸æ‹…å¿ƒäº¤é€šå µå¡ï¼Ÿå› ä¸ºæ¯ä¸ªäººéƒ½ä¹ æƒ¯äº†â€˜ç¬é—´æ¶ˆå¤±â€™ï¼ï¼ˆæ³¨ï¼šæ­¤ç¬‘è¯ä¸ºè™šæ„åˆ›ä½œï¼Œæ—¨åœ¨ä»¥å¹½é»˜æ–¹å¼å¼•å‘æ€è€ƒï¼Œå¹¶éå¯¹å†å²äº‹ä»¶çš„ä¸å°Šé‡ï¼‰&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&#x27;æˆ˜åå’Œå¹³è¿åŠ¨çš„äººå¼€ä¼šè®¨è®ºæ ¸è£å†›ï¼Œä¸€ä¸ªäººç«™èµ·æ¥è¯´ï¼šâ€˜æˆ‘ä»¬å¿…é¡»å½»åº•é”€æ¯æ‰€æœ‰æ ¸æ­¦å™¨ï¼â€™ å¦ä¸€ä¸ªäººçŠ¹è±«åœ°ä¸¾æ‰‹ï¼šâ€˜é‚£â€¦â€¦æˆ‘ä»¬ä¿ç•™ä¸€ä¸ªå§ï¼Œå°±ä¸€ä¸ªï¼Œè—åœ¨å†°ç®±åé¢ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚â€™&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&quot;æœé²é—¨å®£å¸ƒè¦ç»“æŸæˆ˜äº‰ï¼Œé¡¾é—®é—®æ˜¯å¦è¦ä½¿ç”¨åŸå­å¼¹ã€‚ç½—æ–¯ç¦çš„æ£ºææ¿çªç„¶éœ‡åŠ¨äº†ä¸€ä¸‹ï¼Œä¸˜å‰å°”çš„é›ªèŒ„æ‰åœ¨äº†åœ°ä¸Šï¼Œæ–¯å¤§æ—åˆ™é»˜é»˜æ‹¿èµ·äº†ç”µè¯ï¼š&#x27;åŒå¿—ï¼Œæˆ‘ä»¬çš„è®¡åˆ’å¯èƒ½éœ€è¦å†æ¨è¿Ÿä¸€ä¸‹ã€‚&#x27;&quot;]&#125;&#125;</span><br><span class="line">&#123;&#x27;best_joke&#x27;: &#123;&#x27;best_selected_joke&#x27;: &#x27;ä¸ºä»€ä¹ˆå¹¿å²›çš„é‡å»ºè®¡åˆ’ä»ä¸æ‹…å¿ƒäº¤é€šå µå¡ï¼Ÿå› ä¸ºæ¯ä¸ªäººéƒ½ä¹ æƒ¯äº†â€˜ç¬é—´æ¶ˆå¤±â€™ï¼ï¼ˆæ³¨ï¼šæ­¤ç¬‘è¯ä¸ºè™šæ„åˆ›ä½œï¼Œæ—¨åœ¨ä»¥å¹½é»˜æ–¹å¼å¼•å‘æ€è€ƒï¼Œå¹¶éå¯¹å†å²äº‹ä»¶çš„ä¸å°Šé‡ï¼‰&#x27;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Research Assistant</strong> <strong>ç ”ç©¶åŠ©ç†</strong></p>
<p>è§å¦ä¸€ç¯‡æ–‡ç« </p>
<h3 id="module-5">module-5</h3>
<h4 id="chatbot-with-memory-å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with Memory</strong> <strong>å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº</strong></h4>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä»‹ç» <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Memory Store</a> ä½œä¸ºä¸€ç§ä¿å­˜å’Œæ£€ç´¢é•¿æœŸè®°å¿†çš„æ–¹æ³•ã€‚</p>
<blockquote>
<p>LangGraph Memory Store æ˜¯ <strong>LangGraph
æä¾›çš„é•¿æœŸè®°å¿†å­˜å‚¨æ¥å£</strong>ï¼Œç”¨äºåœ¨
<strong>ä¸åŒå¯¹è¯çº¿ç¨‹ä¹‹é—´</strong> æŒä¹…åŒ–ä¿å­˜å’Œæ£€ç´¢ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<table>
<colgroup>
<col style="width: 38%">
<col style="width: 61%">
</colgroup>
<thead>
<tr>
<th>åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>BaseStore</strong></td>
<td>æŠ½è±¡æ¥å£ï¼Œå®šä¹‰äº† <code>put/get/search/delete</code> ç­‰æ“ä½œæ–¹æ³•</td>
</tr>
<tr>
<td><strong>InMemoryStore</strong></td>
<td>å†…å­˜å®ç°ï¼Œé€‚åˆåŸå‹éªŒè¯</td>
</tr>
<tr>
<td><strong>RedisStore / AsyncRedisStore</strong></td>
<td>ç”Ÿäº§çº§å®ç°ï¼Œæ”¯æŒå‘é‡æœç´¢ã€å…ƒæ•°æ®è¿‡æ»¤å’Œå‘½åç©ºé—´ç®¡ç†</td>
</tr>
</tbody>
</table>
</blockquote>
<p>æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªä½¿ç”¨
<code>short-term (within-threadä»…å½“å‰å¯¹è¯çº¿ç¨‹)</code> å’Œ
<code>long-term (across-threadè·¨æ‰€æœ‰å¯¹è¯çº¿ç¨‹    )</code>
å†…å­˜çš„èŠå¤©æœºå™¨äººã€‚</p>
<p>æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨é•¿æœŸ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#semantic-memory">semantic
memory<strong>ï¼ˆè¯­ä¹‰è®°å¿†ï¼‰</strong></a>ï¼Œå®ƒå°†åŒ…å«å…³äºç”¨æˆ·çš„äº‹å®ä¿¡æ¯ã€‚è¿™äº›é•¿æœŸè®°å¿†å°†è¢«ç”¨äºåˆ›å»ºä¸€ä¸ªä¸ªæ€§åŒ–çš„èŠå¤©æœºå™¨äººï¼Œå®ƒå¯ä»¥è®°ä½æœ‰å…³ç”¨æˆ·çš„äº‹å®ã€‚</p>
<p>å®ƒå°†èŠ‚çœå†…å­˜ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#writing-memories">â€œin
the hot pathâ€</a>ï¼Œå½“ç”¨æˆ·ä¸ä¹‹èŠå¤©æ—¶ã€‚</p>
<blockquote>
<p><strong>â€œin the hot pathâ€</strong>
æŒ‡çš„æ˜¯ï¼š<strong>åœ¨å¯¹è¯æˆ–ä»»åŠ¡æ‰§è¡Œçš„</strong>ä¸»æµç¨‹ä¸­<strong>ï¼ˆå³ç”¨æˆ·è¾“å…¥åç«‹å³ã€åŒæ­¥åœ°ï¼‰</strong>ä¸»åŠ¨è°ƒç”¨å·¥å…·æˆ–å†™å…¥è®°å¿†ï¼Œä½¿ä¿¡æ¯<strong>å®æ—¶ç”Ÿæ•ˆ</strong>å¹¶å¯ç”¨äºä¸‹ä¸€æ­¥å†³ç­–ã€‚</p>
</blockquote>
<h5 id="introduction-to-the-langgraph-store-langgraph-å­˜å‚¨ç®€ä»‹"><strong>Introduction
to the LangGraph Store</strong> <strong>LangGraph å­˜å‚¨ç®€ä»‹</strong></h5>
<p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Memory Store</a> æä¾›äº†ä¸€ç§åœ¨ LangGraph ä¸­ <strong>è·¨çº¿ç¨‹</strong>
å­˜å‚¨å’Œæ£€ç´¢ä¿¡æ¯çš„æ–¹å¼ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºæŒä¹…åŒ– <code>key-value</code> å­˜å‚¨çš„
<a target="_blank" rel="noopener" href="https://blog.langchain.dev/launching-long-term-memory-support-in-langgraph/">å¼€æºåŸºç±»</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">from langgraph.store.memory import InMemoryStore</span><br><span class="line">in_memory_store = InMemoryStore()</span><br></pre></td></tr></table></figure>
<p>åœ¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">Store</a>
ä¸­å­˜å‚¨å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œè®°å¿†ï¼‰æ—¶ï¼Œæˆ‘ä»¬æä¾›ï¼š</p>
<p>- å¯¹è±¡çš„ <code>namespace</code>ï¼ˆç±»ä¼¼äºç›®å½•çš„å…ƒç»„ï¼‰</p>
<p>- å¯¹è±¡çš„ <code>key</code>ï¼ˆç±»ä¼¼äºæ–‡ä»¶åï¼‰</p>
<p>- å¯¹è±¡çš„ <code>value</code>ï¼ˆç±»ä¼¼äºæ–‡ä»¶å†…å®¹ï¼‰</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.put">put</a>
æ–¹æ³•é€šè¿‡ <code>namespace</code> å’Œ <code>key</code>
å°†å¯¹è±¡ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250725155616205-1753430177489-3.png" alt="image-20250725155616205">
<figcaption aria-hidden="true">image-20250725155616205</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†è®¾ç½®å‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;  # ç”¨æˆ·ID</span><br><span class="line">namespace_for_memory = (user_id, &quot;memories&quot;)  # è®°å¿†å‘½åç©ºé—´</span><br><span class="line"></span><br><span class="line"># ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„é”®å€¼</span><br><span class="line">key = str(uuid.uuid4())  # ä½¿ç”¨UUIDåˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸ºé”®</span><br><span class="line"></span><br><span class="line"># å€¼éœ€è¦æ˜¯ä¸€ä¸ªå­—å…¸æ ¼å¼</span><br><span class="line">value = &#123;&quot;food_preference&quot;: &quot;æˆ‘å–œæ¬¢æŠ«è¨&quot;&#125;  # å­˜å‚¨çš„é£Ÿç‰©åå¥½ä¿¡æ¯</span><br><span class="line"></span><br><span class="line"># ä¿å­˜è®°å¿†</span><br><span class="line">in_memory_store.put(namespace_for_memory, key, value)  # å°†è®°å¿†å­˜å‚¨åˆ°å†…å­˜ä¸­</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.search">search</a>
é€šè¿‡ <code>namespace</code> ä»å­˜å‚¨ä¸­æ£€ç´¢å¯¹è±¡ã€‚è¿™å°†è¿”å›ä¸€ä¸ªåˆ—è¡¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">memories = in_memory_store.search(namespace_for_memory)</span><br><span class="line">type(memories)</span><br><span class="line"></span><br><span class="line"># Metatdata </span><br><span class="line">memories[0].dict()</span><br><span class="line"></span><br><span class="line"># The key, value</span><br><span class="line">print(memories[0].key, memories[0].value)</span><br><span class="line">9e65de8a-f404-4974-b509-0df0566d8fb5 &#123;&#x27;food_preference&#x27;: &#x27;æˆ‘å–œæ¬¢æŠ«è¨&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.get">get</a>
é€šè¿‡ <code>namespace</code> å’Œ <code>key</code> æ£€ç´¢å¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Get the memory by namespace and key</span><br><span class="line">memory = in_memory_store.get(namespace_for_memory, key)</span><br><span class="line">memory.dict()</span><br></pre></td></tr></table></figure>
<h5 id="chatbot-with-long-term-memory-å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with long-term memory</strong>
<strong>å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº</strong></h5>
<p>æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œ<a target="_blank" rel="noopener" href="https://docs.google.com/presentation/d/181mvjlgsnxudQI6S3ritg9sooNyu4AcLLFH1UK0kIuk/edit#slide=id.g30eb3c8cf10_0_156">æœ‰ä¸¤ç§è®°å¿†çš„æ–¹å¼</a>:</p>
<ol type="1">
<li><code>Short-term (within-thread) memory</code>:
èŠå¤©æœºå™¨äººå¯ä»¥ä¿ç•™ä¼šè¯å†å²è®°å½•å’Œ/æˆ–å…è®¸åœ¨èŠå¤©ä¼šè¯ä¸­è¿›è¡Œä¸­æ–­ã€‚<br>
</li>
<li><code>Long-term (cross-thread) memory</code>:
èŠå¤©æœºå™¨äººå¯ä»¥è®°ä½ç‰¹å®šç”¨æˆ·åœ¨æ‰€æœ‰èŠå¤©ä¼šè¯ä¸­çš„ä¿¡æ¯
<strong>è·¨ä¼šè¯</strong>ã€‚</li>
</ol>
<p>å¯¹äº <code>short-term memory</code>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/persistence/#checkpointer-libraries">checkpointer</a>ã€‚</p>
<ul>
<li>ä»–ä»¬åœ¨æ¯ä¸€æ­¥éƒ½å°†å›¾çŠ¶æ€å†™å…¥çº¿ç¨‹ä¸­ã€‚</li>
<li>ä»–ä»¬åœ¨è¯¥çº¿ç¨‹ä¸­æŒä¹…åŒ–ä¿å­˜èŠå¤©å†å²è®°å½•ã€‚</li>
<li>ä»–ä»¬å…è®¸å›¾åœ¨è¯¥çº¿ç¨‹ä¸­çš„ä»»ä½•æ­¥éª¤è¢«ä¸­æ–­å’Œ/æˆ–æ¢å¤ã€‚</li>
</ul>
<p>å¯¹äº <code>long-term memory</code>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸Šé¢ä»‹ç»çš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Store</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.graph import StateGraph, MessagesState, START, END</span><br><span class="line">from langgraph.store.base import BaseStore</span><br><span class="line"></span><br><span class="line">from langchain_core.messages import HumanMessage, SystemMessage</span><br><span class="line">from langchain_core.runnables.config import RunnableConfig</span><br><span class="line"></span><br><span class="line"># èŠå¤©æœºå™¨äººæŒ‡ä»¤</span><br><span class="line">MODEL_SYSTEM_MESSAGE = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰è®°å¿†åŠŸèƒ½çš„æœ‰ç”¨åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæä¾›å…³äºç”¨æˆ·çš„ä¿¡æ¯ã€‚</span><br><span class="line">å¦‚æœä½ æœ‰è¿™ä¸ªç”¨æˆ·çš„è®°å¿†ï¼Œè¯·ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯è®°å¿†å†…å®¹ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># æ ¹æ®èŠå¤©å†å²å’Œä»»ä½•ç°æœ‰è®°å¿†åˆ›å»ºæ–°è®°å¿†</span><br><span class="line">CREATE_MEMORY_INSTRUCTION = &quot;&quot;&quot;&quot;ä½ æ­£åœ¨æ”¶é›†ç”¨æˆ·ä¿¡æ¯ä»¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line"></span><br><span class="line">å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š</span><br><span class="line">&#123;memory&#125;</span><br><span class="line"></span><br><span class="line">æŒ‡ä»¤ï¼š</span><br><span class="line">1. ä»”ç»†æŸ¥çœ‹ä¸‹é¢çš„èŠå¤©å†å²</span><br><span class="line">2. è¯†åˆ«æœ‰å…³ç”¨æˆ·çš„æ–°ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</span><br><span class="line">   - ä¸ªäººè¯¦æƒ…ï¼ˆå§“åã€ä½ç½®ï¼‰</span><br><span class="line">   - åå¥½ï¼ˆå–œæ¬¢ã€ä¸å–œæ¬¢ï¼‰</span><br><span class="line">   - å…´è¶£å’Œçˆ±å¥½</span><br><span class="line">   - è¿‡å»çš„ç»å†</span><br><span class="line">   - ç›®æ ‡æˆ–æœªæ¥è®¡åˆ’</span><br><span class="line">3. å°†ä»»ä½•æ–°ä¿¡æ¯ä¸ç°æœ‰è®°å¿†åˆå¹¶</span><br><span class="line">4. å°†è®°å¿†æ ¼å¼åŒ–ä¸ºæ¸…æ™°çš„é¡¹ç›®ç¬¦å·åˆ—è¡¨</span><br><span class="line">5. å¦‚æœæ–°ä¿¡æ¯ä¸ç°æœ‰è®°å¿†å†²çªï¼Œè¯·ä¿ç•™æœ€æ–°ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">è®°ä½ï¼šåªåŒ…æ‹¬ç”¨æˆ·ç›´æ¥é™ˆè¿°çš„äº‹å®ä¿¡æ¯ã€‚ä¸è¦åšå‡è®¾æˆ–æ¨æ–­ã€‚</span><br><span class="line"></span><br><span class="line">åŸºäºä»¥ä¸‹èŠå¤©å†å²ï¼Œè¯·æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼š&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;ä»å­˜å‚¨ä¸­åŠ è½½è®°å¿†å¹¶ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å›å¤ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line">    existing_memory = store.get(namespace, key)</span><br><span class="line"></span><br><span class="line">    # å¦‚æœå­˜åœ¨åˆ™æå–å®é™…çš„è®°å¿†å†…å®¹å¹¶æ·»åŠ å‰ç¼€</span><br><span class="line">    if existing_memory:</span><br><span class="line">        # å€¼æ˜¯ä¸€ä¸ªå¸¦æœ‰memoryé”®çš„å­—å…¸</span><br><span class="line">        existing_memory_content = existing_memory.value.get(&#x27;memory&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        existing_memory_content = &quot;æœªæ‰¾åˆ°ç°æœ‰è®°å¿†ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=existing_memory_content)</span><br><span class="line">    </span><br><span class="line">    # ä½¿ç”¨è®°å¿†ä»¥åŠèŠå¤©å†å²è¿›è¡Œå›å¤</span><br><span class="line">    response = model.invoke([SystemMessage(content=system_msg)]+state[&quot;messages&quot;])</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;messages&quot;: response&#125;</span><br><span class="line"></span><br><span class="line">def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;åæ€èŠå¤©å†å²å¹¶å°†è®°å¿†ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢ç°æœ‰è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">        </span><br><span class="line">    # æå–è®°å¿†</span><br><span class="line">    if existing_memory:</span><br><span class="line">        existing_memory_content = existing_memory.value.get(&#x27;memory&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        existing_memory_content = &quot;æœªæ‰¾åˆ°ç°æœ‰è®°å¿†ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=existing_memory_content)</span><br><span class="line">    new_memory = model.invoke([SystemMessage(content=system_msg)]+state[&#x27;messages&#x27;])</span><br><span class="line"></span><br><span class="line">    # è¦†ç›–å­˜å‚¨ä¸­çš„ç°æœ‰è®°å¿†</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line"></span><br><span class="line">    # å°†å€¼å†™å…¥ä¸ºå¸¦æœ‰memoryé”®çš„å­—å…¸</span><br><span class="line">    store.put(namespace, key, &#123;&quot;memory&quot;: new_memory.content&#125;)</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å›¾</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;call_model&quot;, call_model)</span><br><span class="line">builder.add_node(&quot;write_memory&quot;, write_memory)</span><br><span class="line">builder.add_edge(START, &quot;call_model&quot;)</span><br><span class="line">builder.add_edge(&quot;call_model&quot;, &quot;write_memory&quot;)</span><br><span class="line">builder.add_edge(&quot;write_memory&quot;, END)</span><br><span class="line"></span><br><span class="line"># ç”¨äºè·¨çº¿ç¨‹çš„é•¿æœŸè®°å¿†å­˜å‚¨</span><br><span class="line">across_thread_memory = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ç”¨äºçº¿ç¨‹å†…çš„çŸ­æœŸè®°å¿†æ£€æŸ¥ç‚¹</span><br><span class="line">within_thread_memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ£€æŸ¥ç‚¹å™¨å’Œå­˜å‚¨ç¼–è¯‘å›¾</span><br><span class="line">graph = builder.compile(checkpointer=within_thread_memory, store=across_thread_memory)</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤ºå›¾</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250725161106319.png" alt="image-20250725161106319">
<figcaption aria-hidden="true">image-20250725161106319</figcaption>
</figure>
<p>èŠå¤©å†å²å°†é€šè¿‡æ£€æŸ¥ç‚¹å·¥å…·ä¿å­˜åˆ°çŸ­æœŸè®°å¿†ä¸­ã€‚èŠå¤©æœºå™¨äººå°†å›é¡¾èŠå¤©å†å²ã€‚ç„¶åï¼Œå®ƒå°†åˆ›å»ºå¹¶ä¿å­˜ä¸€ä¸ªè®°å¿†åˆ°
<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Store</a>ã€‚æ­¤å†…å­˜å¯åœ¨æœªæ¥çš„èŠå¤©ä¼šè¯ä¸­è®¿é—®ï¼Œä»¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å“åº”ã€‚</p>
<p>å½“æˆ‘ä»¬ä¸èŠå¤©æœºå™¨äººäº¤äº’æ—¶ï¼Œæˆ‘ä»¬æä¾›ä¸¤æ ·ä¸œè¥¿ï¼š</p>
<ol type="1">
<li><code>Short-term (within-thread) memory</code>:
ä¸€ä¸ªç”¨äºæŒä¹…åŒ–èŠå¤©å†å²çš„ <code>thread ID</code>ã€‚<br>
</li>
<li><code>Long-term (cross-thread) memory</code>:
ä¸€ä¸ªç”¨äºå°†é•¿æœŸè®°å¿†å‘½åç©ºé—´åˆ°ç”¨æˆ·çš„ <code>user ID</code>ã€‚</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›çº¿ç¨‹IDç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†</span><br><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿† </span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lance&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br><span class="line">    </span><br><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lance</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼ŒLanceï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼ŸğŸ˜Š</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ <code>MemorySaver</code>
æ£€æŸ¥ç‚¹æ¥ç®¡ç†çº¿ç¨‹å†…å†…å­˜ã€‚è¿™ä¼šå°†èŠå¤©å†å²ä¿å­˜åˆ°çº¿ç¨‹ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¿å­˜åˆ°çº¿ç¨‹çš„èŠå¤©å†å²è®°å½•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">thread = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line">state = graph.get_state(thread).values</span><br><span class="line">for m in state[&quot;messages&quot;]: </span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å­˜å‚¨åº“ç¼–è¯‘äº†è¯¥å›¾ï¼š<code>across_thread_memory = InMemoryStore()</code>å¹¶ä¸”ï¼Œæˆ‘ä»¬å‘å›¾ä¸­æ·»åŠ äº†ä¸€ä¸ªèŠ‚ç‚¹
(<code>write_memory</code>)ï¼Œè¯¥èŠ‚ç‚¹åæ˜ äº†èŠå¤©å†å²å¹¶ä¿å­˜äº†ä¸€æ®µè®°å¿†åˆ°å­˜å‚¨ä¸­ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å†…å­˜æ˜¯å¦å·²ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†è®¾ç½®å‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">existing_memory = across_thread_memory.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">existing_memory.dict()</span><br><span class="line"></span><br><span class="line">&#123;&#x27;namespace&#x27;: [&#x27;memory&#x27;, &#x27;1&#x27;],</span><br><span class="line"> &#x27;key&#x27;: &#x27;user_memory&#x27;,</span><br><span class="line"> &#x27;value&#x27;: &#123;&#x27;memory&#x27;: &#x27;- å§“åï¼šLance  \n- ä½ç½®ï¼šæ—§é‡‘å±±  \n- å…´è¶£å’Œçˆ±å¥½ï¼šéª‘è‡ªè¡Œè½¦  \n- å–œæ¬¢çš„æ´»åŠ¨ï¼šåœ¨æ—§é‡‘å±±éª‘è¡Œï¼Œå¯èƒ½åŒ…æ‹¬é‡‘é—¨å¤§æ¡¥å’Œæ»¨æµ·åŒºè·¯çº¿&#x27;&#125;,</span><br><span class="line"> &#x27;created_at&#x27;: &#x27;2025-07-25T08:12:35.877160+00:00&#x27;,</span><br><span class="line"> &#x27;updated_at&#x27;: &#x27;2025-07-25T08:12:35.877161+00:00&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥
<strong>ç›¸åŒçš„ç”¨æˆ·ID</strong>å¯åŠ¨ä¸€ä¸ª<strong>æ–°çº¿ç¨‹</strong>ã€‚æˆ‘ä»¬åº”è¯¥çœ‹åˆ°èŠå¤©æœºå™¨äººè®°ä½äº†ç”¨æˆ·çš„ä¸ªäººèµ„æ–™ï¼Œå¹¶å°†å…¶ç”¨äºä¸ªæ€§åŒ–å“åº”ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºè·¨çº¿ç¨‹è®°å¿†ä»¥åŠä¸€ä¸ªæ–°çš„çº¿ç¨‹ID</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;2&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼ä½ æ¨èæˆ‘å»å“ªé‡Œéª‘è‡ªè¡Œè½¦ï¼Ÿ&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<h4 id="chatbot-with-profile-schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with Profile Schema</strong>
<strong>å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h4>
<p>æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººå°†è®°å¿†ä¿å­˜ä¸ºå­—ç¬¦ä¸²ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›è®°å¿†å…·æœ‰ç»“æ„åŒ–æ ¼å¼ã€‚ä¾‹å¦‚ï¼Œè®°å¿†å¯ä»¥æ˜¯<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">å•ä¸ªã€æŒç»­æ›´æ–°çš„æ¨¡å¼</a>ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™æ˜¯ä¸€ä¸ªå•ä¸€çš„ç”¨æˆ·æ¡£æ¡ˆã€‚</p>
<p>æˆ‘ä»¬å°†æ‰©å±•æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººï¼Œå°†è¯­ä¹‰è®°å¿†ä¿å­˜åˆ°å•ä¸ª<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">ç”¨æˆ·æ¡£æ¡ˆ</a>ä¸­ã€‚æˆ‘ä»¬è¿˜å°†ä»‹ç»ä¸€ä¸ªåº“
<a target="_blank" rel="noopener" href="https://github.com/hinthornw/trustcall">Trustcall</a>ï¼Œç”¨äºä½¿ç”¨æ–°ä¿¡æ¯æ›´æ–°æ­¤æ¨¡å¼ã€‚</p>
<h5 id="defining-a-user-profile-schema-å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼"><strong>Defining
a user profile schema</strong>
<strong>å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼</strong></h5>
<p>Python æœ‰è®¸å¤šä¸åŒç±»å‹çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#schema-definition">structured
data</a>ï¼Œä¾‹å¦‚ TypedDictã€å­—å…¸ã€JSON å’Œ <a target="_blank" rel="noopener" href="https://docs.pydantic.dev/latest/">Pydantic</a>ã€‚</p>
<p>è®©æˆ‘ä»¬å…ˆä½¿ç”¨ TypedDict æ¥å®šä¹‰ä¸€ä¸ªç”¨æˆ·èµ„æ–™æ¨¡å¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from typing import TypedDict, List</span><br><span class="line"></span><br><span class="line">class UserProfile(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;å¸¦æœ‰ç±»å‹å­—æ®µçš„ç”¨æˆ·æ¡£æ¡ˆæ¨¡å¼&quot;&quot;&quot;</span><br><span class="line">    user_name: str  # ç”¨æˆ·çš„é¦–é€‰åç§°</span><br><span class="line">    interests: List[str]  # ç”¨æˆ·å…´è¶£åˆ—è¡¨</span><br></pre></td></tr></table></figure>
<h5 id="saving-a-schema-to-the-store-å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­"><strong>Saving
a schema to the store</strong> <strong>å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­</strong></h5>
<p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Store</a> æ¥å—ä»»ä½• Python å­—å…¸ä½œä¸º <code>value</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># TypedDict å®ä¾‹</span><br><span class="line">user_profile: UserProfile = &#123;</span><br><span class="line">    &quot;user_name&quot;: &quot;Lance&quot;,  # ç”¨æˆ·å</span><br><span class="line">    &quot;interests&quot;: [&quot;éª‘è¡Œ&quot;, &quot;ç§‘æŠ€&quot;, &quot;å’–å•¡&quot;]  # å…´è¶£çˆ±å¥½</span><br><span class="line">&#125;</span><br><span class="line">user_profile</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.put">put</a>
æ–¹æ³•å°† TypedDict ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">from langgraph.store.memory import InMemoryStore</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–å†…å­˜å­˜å‚¨</span><br><span class="line">in_memory_store = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†åˆ›å»ºå‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace_for_memory = (user_id, &quot;memory&quot;)</span><br><span class="line"></span><br><span class="line"># å°†è®°å¿†ä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ°å‘½åç©ºé—´ä¸­</span><br><span class="line">key = &quot;user_profile&quot;</span><br><span class="line">value = user_profile</span><br><span class="line">in_memory_store.put(namespace_for_memory, key, value)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.search">search</a>
æŒ‰å‘½åç©ºé—´ä»å­˜å‚¨ä¸­æ£€ç´¢å¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for m in in_memory_store.search(namespace_for_memory):</span><br><span class="line">    print(m.dict())</span><br><span class="line">    </span><br><span class="line">&#123;&#x27;namespace&#x27;: [&#x27;1&#x27;, &#x27;memory&#x27;], &#x27;key&#x27;: &#x27;user_profile&#x27;, &#x27;value&#x27;: &#123;&#x27;user_name&#x27;: &#x27;Lance&#x27;, &#x27;interests&#x27;: [&#x27;éª‘è¡Œ&#x27;, &#x27;ç§‘æŠ€&#x27;, &#x27;å’–å•¡&#x27;]&#125;, &#x27;created_at&#x27;: &#x27;2025-07-25T08:58:06.031770+00:00&#x27;, &#x27;updated_at&#x27;: &#x27;2025-07-25T08:58:06.031775+00:00&#x27;, &#x27;score&#x27;: None&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.get">get</a>
é€šè¿‡å‘½åç©ºé—´å’Œé”®æ¥æ£€ç´¢ç‰¹å®šå¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">profile = in_memory_store.get(namespace_for_memory, &quot;user_profile&quot;)</span><br><span class="line">profile.value</span><br><span class="line"></span><br><span class="line">&#123;&#x27;user_name&#x27;: &#x27;Lance&#x27;, &#x27;interests&#x27;: [&#x27;éª‘è¡Œ&#x27;, &#x27;ç§‘æŠ€&#x27;, &#x27;å’–å•¡&#x27;]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="chatbot-with-profile-schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº-1"><strong>Chatbot
with profile schema</strong>
<strong>å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h5>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•ä¸ºè®°å¿†æŒ‡å®šä¸€ä¸ªæ¨¡å¼ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¦‚ä½•æ ¹æ®è¿™ä¸ªç‰¹å®šçš„æ¨¡å¼
<strong>åˆ›å»º</strong> è®°å¿†ï¼Ÿ</p>
<p>åœ¨æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººä¸­ï¼Œæˆ‘ä»¬ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">æƒ³è¦ä»ä¸€ä¸ªèŠå¤©é‡Œåˆ›å»ºè®°å¿†</a>.è¿™å°±æ˜¯
<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#recommended-usage">structured
outputsæ ¼å¼åŒ–è¾“å‡º</a> æ¦‚å¿µæœ‰ç”¨çš„åœ°æ–¹ã€‚</p>
<p>LangChain çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/chat_models/">chat
model</a> æ¥å£æœ‰ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#recommended-usage">PROTECTED<span class="math inline">11</span></a>
æ–¹æ³•ç”¨äºå¼ºåˆ¶ç»“æ„åŒ–è¾“å‡ºã€‚è¿™åœ¨æˆ‘ä»¬éœ€è¦ç¡®ä¿è¾“å‡ºç¬¦åˆæŸä¸ªæ¨¡å¼æ—¶éå¸¸æœ‰ç”¨ï¼Œè€Œä¸”å®ƒä¼šä¸ºæˆ‘ä»¬è§£æè¾“å‡ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å°†æ¨¡å¼ç»‘å®šåˆ°æ¨¡å‹</span><br><span class="line">model_with_structure = model.with_structured_output(UserProfile)</span><br><span class="line"></span><br><span class="line"># è°ƒç”¨æ¨¡å‹ç”Ÿæˆç¬¦åˆæ¨¡å¼çš„ç»“æ„åŒ–è¾“å‡º</span><br><span class="line">structured_output = model_with_structure.invoke([HumanMessage(&quot;æˆ‘çš„åå­—æ˜¯Lanceï¼Œæˆ‘å–œæ¬¢éª‘è‡ªè¡Œè½¦ã€‚&quot;)])</span><br><span class="line">structured_output</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Structured outputsï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰
æŒ‡è®©å¤§æ¨¡å‹<strong>ä¸å†â€œéšæ„è¯´äººè¯â€</strong>ï¼Œè€Œæ˜¯<strong>æŒ‰ä½ äº‹å…ˆå®šä¹‰å¥½çš„æ ¼å¼ï¼ˆJSON
/ è¡¨æ ¼ / æšä¸¾ /
åµŒå¥—å¯¹è±¡ç­‰ï¼‰ç²¾ç¡®è¿”å›æ•°æ®</strong>ã€‚ç›¸å½“äºç»™æ¨¡å‹å¥—äº†ä¸€ä¸ªâ€œæ¨¡å…·â€ï¼Œä¿è¯è¾“å‡ºå¯ç›´æ¥è¢«ä»£ç è§£æã€å…¥åº“æˆ–ä¼ ç»™ä¸‹æ¸¸ç³»ç»Ÿï¼Œé¿å…å†ç”¨æ­£åˆ™ã€å­—ç¬¦ä¸²æ‹¼æ¥å»â€œçŒœâ€ç»“æœã€‚</p>
<p>ä½¿ç”¨å®˜æ–¹çš„å¤§æ¨¡å‹ç»„ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from langchain_community.chat_models import ChatTongyi</span><br><span class="line">model=ChatTongyi(</span><br><span class="line">    model=&quot;qwen-plus-2025-07-14&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨èŠå¤©æœºå™¨äººä¸­ä½¿ç”¨å®ƒã€‚è¿™åªéœ€è¦å¯¹
<code>write_memory</code> å‡½æ•°è¿›è¡Œè½»å¾®ä¿®æ”¹ã€‚æˆ‘ä»¬ä½¿ç”¨
<code>model_with_structure</code>ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæ¥ç”Ÿæˆä¸€ä¸ªä¸æˆ‘ä»¬æ¨¡å¼åŒ¹é…çš„é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.graph import StateGraph, MessagesState, START, END</span><br><span class="line">from langgraph.store.base import BaseStore</span><br><span class="line"></span><br><span class="line">from langchain_core.messages import HumanMessage, SystemMessage, AIMessage</span><br><span class="line">from langchain_core.runnables.config import RunnableConfig</span><br><span class="line"></span><br><span class="line"># èŠå¤©æœºå™¨äººæŒ‡ä»¤</span><br><span class="line">MODEL_SYSTEM_MESSAGE = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰è®°å¿†åŠŸèƒ½çš„ helpful åŠ©æ‰‹ï¼Œå¯ä»¥æä¾›å…³äºç”¨æˆ·çš„ä¿¡æ¯ã€‚</span><br><span class="line">å¦‚æœä½ æœ‰è¿™ä¸ªç”¨æˆ·çš„è®°å¿†ï¼Œè¯·ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯è®°å¿†å†…å®¹ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># æ ¹æ®èŠå¤©å†å²å’Œä»»ä½•ç°æœ‰è®°å¿†åˆ›å»ºæ–°è®°å¿†</span><br><span class="line">CREATE_MEMORY_INSTRUCTION = &quot;&quot;&quot;æ ¹æ®ç”¨æˆ·çš„èŠå¤©å†å²åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆè®°å¿†ã€‚</span><br><span class="line">è¿™å°†è¢«ä¿å­˜ä¸ºé•¿æœŸè®°å¿†ã€‚å¦‚æœå­˜åœ¨ç°æœ‰è®°å¿†ï¼Œåªéœ€æ›´æ–°å®ƒã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯ç°æœ‰è®°å¿†ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;ä»å­˜å‚¨ä¸­åŠ è½½è®°å¿†å¹¶ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å›å¤ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line"></span><br><span class="line">    # ä¸ºç³»ç»Ÿæç¤ºæ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    if existing_memory and existing_memory.value:</span><br><span class="line">        memory_dict = existing_memory.value</span><br><span class="line">        formatted_memory = (</span><br><span class="line">            f&quot;å§“å: &#123;memory_dict.get(&#x27;user_name&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;\n&quot;</span><br><span class="line">            f&quot;å…´è¶£: &#123;&#x27;, &#x27;.join(memory_dict.get(&#x27;interests&#x27;, []))&#125;&quot;</span><br><span class="line">        )</span><br><span class="line">    else:</span><br><span class="line">        formatted_memory = None</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=formatted_memory)</span><br><span class="line"></span><br><span class="line">    # ä½¿ç”¨è®°å¿†ä»¥åŠèŠå¤©å†å²æ¥å›å¤</span><br><span class="line">    response = model.invoke([SystemMessage(content=system_msg)]+state[&quot;messages&quot;])</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;messages&quot;: response&#125;</span><br><span class="line"></span><br><span class="line">def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;åæ€èŠå¤©å†å²å¹¶å°†è®°å¿†ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢ç°æœ‰è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line"></span><br><span class="line">    # ä¸ºç³»ç»Ÿæç¤ºæ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    if existing_memory and existing_memory.value:</span><br><span class="line">        memory_dict = existing_memory.value</span><br><span class="line">        formatted_memory = (</span><br><span class="line">            f&quot;å§“å: &#123;memory_dict.get(&#x27;user_name&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;\n&quot;</span><br><span class="line">            f&quot;å…´è¶£: &#123;&#x27;, &#x27;.join(memory_dict.get(&#x27;interests&#x27;, []))&#125;&quot;</span><br><span class="line">        )</span><br><span class="line">    else:</span><br><span class="line">        formatted_memory = None</span><br><span class="line">        </span><br><span class="line">    # åœ¨æŒ‡ä»¤ä¸­æ ¼å¼åŒ–ç°æœ‰è®°å¿†</span><br><span class="line">    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=formatted_memory)</span><br><span class="line"></span><br><span class="line">    # è°ƒç”¨æ¨¡å‹ç”Ÿæˆç¬¦åˆæ¨¡å¼çš„ç»“æ„åŒ–è¾“å‡º</span><br><span class="line">    new_memory = model_with_structure.invoke([SystemMessage(content=system_msg)]+state[&#x27;messages&#x27;])</span><br><span class="line"></span><br><span class="line">    # è¦†ç›–ç°æœ‰çš„ç”¨æˆ·æ¡£æ¡ˆè®°å¿†</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line">    store.put(namespace, key, new_memory)</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å›¾</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;call_model&quot;, call_model)</span><br><span class="line">builder.add_node(&quot;write_memory&quot;, write_memory)</span><br><span class="line">builder.add_edge(START, &quot;call_model&quot;)</span><br><span class="line">builder.add_edge(&quot;call_model&quot;, &quot;write_memory&quot;)</span><br><span class="line">builder.add_edge(&quot;write_memory&quot;, END)</span><br><span class="line"></span><br><span class="line"># ç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿†çš„å­˜å‚¨</span><br><span class="line">across_thread_memory = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†çš„æ£€æŸ¥ç‚¹</span><br><span class="line">within_thread_memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ£€æŸ¥ç‚¹å’Œå­˜å‚¨ç¼–è¯‘å›¾</span><br><span class="line">graph = builder.compile(checkpointer=within_thread_memory, store=across_thread_memory)</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤º</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250726103516996.png" alt="image-20250726103516996">
<figcaption aria-hidden="true">image-20250726103516996</figcaption>
</figure>
<p>è°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›çº¿ç¨‹IDç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†</span><br><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿† </span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lanceï¼Œæˆ‘å–œæ¬¢åœ¨æ—§é‡‘å±±éª‘è‡ªè¡Œè½¦å’Œåœ¨é¢åŒ…åº—åƒé¥­ã€‚&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è®°å¿†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Namespace for the memory to save</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">existing_memory = across_thread_memory.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">existing_memory.value</span><br></pre></td></tr></table></figure>
<h5 id="trustcall-for-creating-and-updating-profile-schemas-trustcall-ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼"><strong>Trustcall
for creating and updating profile schemas</strong> <strong>Trustcall
ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼</strong></h5>
<p>Trustcall æ˜¯ä¸€ä¸ªç”± LangChain å›¢é˜Ÿå¼€å‘çš„å¼€æº Python
åº“ï¼Œæ—¨åœ¨<strong>è§£å†³å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœ¨ç”Ÿæˆæˆ–ä¿®æ”¹å¤æ‚ JSON
æ•°æ®ç»“æ„æ—¶æ•ˆç‡ä½ã€æ˜“å‡ºé”™çš„é—®é¢˜</strong>ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>create_extractor</code>ï¼Œä¼ å…¥æ¨¡å‹ä»¥åŠæˆ‘ä»¬çš„æ¨¡å¼ä½œä¸º <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/tools/">tool</a>ã€‚ä½¿ç”¨
TrustCall æ—¶ï¼Œå¯ä»¥ä»¥å¤šç§æ–¹å¼æä¾›æ¨¡å¼ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ª JSON å¯¹è±¡ / Python å­—å…¸æˆ– Pydantic
æ¨¡å‹ã€‚åœ¨åº•å±‚ï¼ŒTrustCall ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/tool_calling/">tool
calling</a> ä»è¾“å…¥çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/messages/">messages</a>
åˆ—è¡¨ä¸­ç”Ÿæˆ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/">structured
output</a>ã€‚ä¸ºäº†å¼ºåˆ¶ Trustcall ç”Ÿæˆ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/">structured
output</a>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>tool_choice</code> å‚æ•°ä¸­åŒ…å«æ¨¡å¼åç§°ã€‚</p>
<p>æˆ‘ä»…åšäº†è§£äº†ï¼Œæ„Ÿè§‰ç”¨å¤„ä¸å¤šï¼Œç”¨ç»“æœåŒ–è¾“å‡ºå°±èƒ½è¾¾åˆ°æ•ˆæœ</p>
<h4 id="chatbot-with-collection-schema-å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with Collection Schema</strong>
<strong>å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h4>
<p><strong>â€œcollectionâ€</strong>
æŒ‡çš„æ˜¯ä¸€ç§<strong>å°†è¯­ä¹‰è®°å¿†ç»„ç»‡ä¸ºå¤šä¸ªç‹¬ç«‹æ–‡æ¡£ï¼ˆobjectsï¼‰çš„å­˜å‚¨æ–¹å¼</strong>ï¼Œè€Œä¸æ˜¯æŠŠæ‰€æœ‰ä¿¡æ¯éƒ½å¡è¿›ä¸€ä¸ªå·¨å¤§çš„â€œç”¨æˆ·æ¡£æ¡ˆâ€ï¼ˆsingle
profileï¼‰é‡Œã€‚</p>
<p>å‡è®¾ä½ åœ¨åšä¸€ä¸ª AI åŠ©æ‰‹ï¼Œç”¨æˆ·è¯´ï¼š</p>
<blockquote>
<p>â€œæˆ‘ä¸‹å‘¨è¦å»ä¸œäº¬å‡ºå·®ï¼Œä½åœ¨æ¶©è°·åŒºçš„ Sakura Hotelã€‚â€ â€œæˆ‘æœ‹å‹ Ken
ä¹Ÿè¦æ¥ï¼Œä»–å–œæ¬¢åƒæ‹‰é¢ã€‚â€</p>
</blockquote>
<p>å¦‚æœç”¨ <strong>collection</strong>ï¼Œä½ ä¼šå­˜æˆä¸¤æ¡è®°å¿†ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trip&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tokyo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-08-04&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hotel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sakura Hotel, Shibuya&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;friend&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ken&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;food_preference&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ramen&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>æ¯æ¡è®°å¿†éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹æ–‡æ¡£ï¼Œåç»­ä½ å¯ä»¥ï¼š</p>
<ul>
<li>æœç´¢â€œtripâ€ç±»å‹çš„è®°å¿†ï¼Œæ‰¾åˆ°ç”¨æˆ·çš„å‡ºå·®å®‰æ’ï¼›</li>
<li>æœç´¢â€œfriendâ€ç±»å‹çš„è®°å¿†ï¼Œæ‰¾åˆ° Ken çš„åå¥½ï¼›</li>
<li>æ›´æ–° Ken
çš„ä¿¡æ¯æ—¶ï¼Œ<strong>åªæ”¹ä¸€æ¡è®°å½•</strong>ï¼Œä¸ä¼šå½±å“å…¶å®ƒè®°å¿†ã€‚</li>
</ul>
<h4 id="memory-agent-å†…å­˜ä»£ç†"><strong>Memory Agent</strong>
<strong>å†…å­˜ä»£ç†</strong></h4>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†æŠŠå­¦åˆ°çš„å†…å®¹æ•´åˆèµ·æ¥ï¼Œæ„å»ºä¸€ä¸ªå…·æœ‰é•¿æœŸè®°å¿†çš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/agentic_concepts/">agent</a>ã€‚</p>
<p>æˆ‘ä»¬çš„ä»£ç† <code>task_mAIstro</code> å°†å¸®åŠ©æˆ‘ä»¬ç®¡ç†å¾…åŠäº‹é¡¹åˆ—è¡¨ï¼</p>
<p>æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„èŠå¤©æœºå™¨äºº <strong>å§‹ç»ˆ</strong>
ä¼šåæ€å¯¹è¯å¹¶ä¿å­˜è®°å¿†ã€‚<code>task_mAIstro</code> å°†å†³å®š
<strong>ä½•æ—¶</strong> ä¿å­˜è®°å¿†ï¼ˆå¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­çš„é¡¹ç›®ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„èŠå¤©æœºå™¨äººå§‹ç»ˆä¿å­˜ä¸€ç§ç±»å‹çš„è®°å¿†ï¼Œå³ä¸ªäººèµ„æ–™æˆ–é›†åˆã€‚<code>task_mAIstro</code>
å¯ä»¥å†³å®šå°†æ•°æ®ä¿å­˜åˆ°ç”¨æˆ·ä¸ªäººèµ„æ–™æˆ– ToDo äº‹é¡¹é›†åˆä¸­ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>task_mAIstro</code>
è¿˜å°†ç®¡ç†ç¨‹åºæ€§è®°å¿†ã€‚è¿™å…è®¸ç”¨æˆ·æ›´æ–°åˆ›å»ºToDoé¡¹çš„åå¥½è®¾ç½®ã€‚</p>
<h5 id="creating-an-agent-åˆ›å»ºä¸€ä¸ªä»£ç†"><strong>Creating an
agent</strong> <strong>åˆ›å»ºä¸€ä¸ªä»£ç†</strong></h5>
<p>æœ‰è®¸å¤šä¸åŒçš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/high_level/">agent</a>
æ¶æ„å¯ä¾›é€‰æ‹©ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„å†…å®¹ï¼Œä¸€ä¸ª <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/agentic_concepts/#react-implementation">ReAct</a>
ä»£ç†ã€‚è¿™ä¸ªä»£ç†å°†æˆä¸ºåˆ›å»ºå’Œç®¡ç†å¾…åŠäº‹é¡¹åˆ—è¡¨çš„å¾—åŠ›åŠ©æ‰‹ã€‚</p>
<p>æ­¤ä»£ç†å¯ä»¥å†³å®šæ›´æ–°ä¸‰ç§ç±»å‹çš„é•¿æœŸè®°å¿†ï¼š</p>
<ol type="a">
<li><p>åˆ›å»ºæˆ–æ›´æ–°å…·æœ‰æ™®é€šç”¨æˆ·ä¿¡æ¯çš„ç”¨æˆ· <code>profile</code></p></li>
<li><p>åœ¨ToDoåˆ—è¡¨ä¸­æ·»åŠ æˆ–æ›´æ–°é¡¹ç›® <code>collection</code></p></li>
<li><p>æ›´æ–°å…¶è‡ªèº«çš„ <code>instructions</code>
ä»¥äº†è§£å¦‚ä½•æ›´æ–°å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­çš„é¡¹ç›®</p></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from typing import TypedDict, Literal</span><br><span class="line"></span><br><span class="line"># æ›´æ–°è®°å¿†å·¥å…·</span><br><span class="line">class UpdateMemory(TypedDict):</span><br><span class="line">    &quot;&quot;&quot; å†³å®šæ›´æ–°å“ªç§è®°å¿†ç±»å‹ &quot;&quot;&quot;</span><br><span class="line">    update_type: Literal[&#x27;user&#x27;, &#x27;todo&#x27;, &#x27;instructions&#x27;]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>'user'</code>ï¼šç”¨æˆ·ç›¸å…³ä¿¡æ¯</li>
<li><code>'todo'</code>ï¼šå¾…åŠäº‹é¡¹</li>
<li><code>'instructions'</code>ï¼šæŒ‡ä»¤ä¿¡æ¯</li>
</ul>
</blockquote>
<h5 id="graph-definition-å›¾å®šä¹‰"><strong>Graph definition</strong>
<strong>å›¾å®šä¹‰</strong></h5>
<p>æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªç®€å•çš„è·¯ç”±å™¨
<code>route_message</code>ï¼Œå®ƒé€šè¿‡äºŒå…ƒå†³ç­–æ¥èŠ‚çœå†…å­˜ã€‚</p>
<h3 id="module-6">module-6</h3>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/21/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/Retrieval/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/21/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/Retrieval/" class="post-title-link" itemprop="url">Retrieval</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-21 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-21T00:00:00+08:00">2025-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-05 10:41:58" itemprop="dateModified" datetime="2025-08-05T10:41:58+08:00">2025-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">å®ä¹ </span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E4%B9%A0/%E6%99%A8%E6%99%9F%E6%99%BA%E6%8E%A7/" itemprop="url" rel="index"><span itemprop="name">æ™¨æ™Ÿæ™ºæ§</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="elastic-search">elastic search</h3>
<p>Elasticsearch æ˜¯å½“ä»Šæœ€æµè¡Œçš„
<strong>å¼€æºåˆ†å¸ƒå¼æœç´¢ä¸åˆ†æå¼•æ“</strong>ï¼Œç”¨ Java å¼€å‘ï¼ŒåŸºäº
<strong>Apache Lucene</strong>
æ„å»ºã€‚å®ƒæŠŠ<strong>å…¨æ–‡æ£€ç´¢ã€å®æ—¶åˆ†æã€æ—¶åºæ•°æ®ã€åœ°ç†ç©ºé—´æŸ¥è¯¢</strong>å’Œ<strong>å‘é‡æ£€ç´¢</strong>ç»Ÿä¸€åˆ°ä¸€ä¸ªå¹³å°ï¼Œè¢«å¹¿æ³›ç”¨äºæ—¥å¿—ã€æŒ‡æ ‡ã€å®‰å…¨ã€ä¼ä¸šæœç´¢ä»¥åŠ
AI/RAG åœºæ™¯ã€‚</p>
<p>RAG ç³»ç»Ÿä¸­ï¼Œ<strong>Elasticsearch
ä¸ä»…æ˜¯å‘é‡æ•°æ®åº“ï¼Œæ›´æ˜¯è¯­ä¹‰æ£€ç´¢å¼•æ“å’Œä¸Šä¸‹æ–‡æ„å»ºå™¨</strong>ï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯<strong>å‘é‡æ•°æ®åº“
+ å…¨æ–‡æ£€ç´¢å¼•æ“</strong>çš„æ··åˆè§’è‰²ã€‚</p>
<h4 id="æŸ¥æ‰¾è¯­å¥">æŸ¥æ‰¾è¯­å¥</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET /test_full_v1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;é«˜å‹æ—è·¯ç®¡é“ç£ç²‰æ£€æµ‹ä½¿ç”¨çš„æ˜¯å“ªç§ç£åŒ–æ–¹æ³•å’Œç£æ‚¬æ¶²æµ“åº¦ï¼Ÿ&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;text&quot;, &quot;report_name&quot;,&quot;report_url&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_cat/indices?v#æŸ¥çœ‹æ‰€æœ‰çš„æ‰€æœ‰</span><br><span class="line"></span><br><span class="line">GET test_full_v1/_count#æŸ¥çœ‹æ–‡ä»¶æ•°</span><br><span class="line"></span><br><span class="line">GET test_full_v1/_mapping#æŸ¥çœ‹æ˜ å°„</span><br><span class="line"></span><br><span class="line">GET test_full_v1#æŸ¥çœ‹ç´¢å¼•å†…å®¹</span><br><span class="line"></span><br><span class="line">GET test_full_v1/_search#æŸ¥çœ‹ç´¢å¼•å†…å®¹</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 3,</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_cat/indices/zxj_test#æŸ¥çœ‹ç´¢å¼•æ˜¯å¦å­˜åœ¨</span><br></pre></td></tr></table></figure>
<p>å¯è§†åŒ–å¹³å°kibanaçš„å†…ç½‘è·¯å¾„ï¼š</p>
<ul>
<li><code>http://10.117.128.50:5601</code></li>
<li>http://10.117.128.50:5601/app/dev_tools#/console/shell
å¼€å‘è€…å·¥å…·</li>
</ul>
<h4 id="esæ”¯æŒçš„å‡ ç§æ£€ç´¢å‡½æ•°">esæ”¯æŒçš„å‡ ç§æ£€ç´¢å‡½æ•°</h4>
<h5 id="å‘é‡æœç´¢">å‘é‡æœç´¢</h5>
<p>è¿™é‡Œçš„å‘é‡æœç´¢ä¹Ÿå°±æ˜¯ç¨ å¯†å‘é‡æ£€ç´¢ï¼Œè¿‡ç¨‹ä¸º<strong>â€œæŠŠæ–‡æœ¬/å›¾åƒç­‰éç»“æ„åŒ–æ•°æ®æ˜ å°„æˆé«˜ç»´å‘é‡
â†’ åœ¨å‘é‡ç©ºé—´é‡Œåšè¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æœç´¢ â†’
æŒ‰ç›¸ä¼¼åº¦æ’åºè¿”å›ç»“æœâ€</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def vector_query(search_query: str):</span><br><span class="line">    # ä½¿ç”¨ä¸ç´¢å¼•æ—¶ç›¸åŒçš„åµŒå…¥æ¨¡å‹å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡</span><br><span class="line">    vector = embeddings.embed_query(search_query)</span><br><span class="line">    </span><br><span class="line">    # æ„å»ºElasticsearch KNNæŸ¥è¯¢ç»“æ„</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;knn&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: dense_vector_field,      # æŒ‡å®šå­˜å‚¨å‘é‡çš„å­—æ®µå</span><br><span class="line">            &quot;query_vector&quot;: vector,           # æŸ¥è¯¢å‘é‡</span><br><span class="line">            &quot;k&quot;: 5,                          # è¿”å›æœ€ç›¸ä¼¼çš„5ä¸ªç»“æœ</span><br><span class="line">            &quot;num_candidates&quot;: 10,            # åœ¨10ä¸ªå€™é€‰ä¸­é€‰æ‹©æœ€ä¼˜çš„5ä¸ªï¼ˆæé«˜æœç´¢æ•ˆç‡å’Œå‡†ç¡®æ€§ï¼‰</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="bm25">bm25</h5>
<p>BM25ï¼ˆ<strong>Best Matching
25</strong>ï¼‰ä¹Ÿå°±æ˜¯å…¨æ–‡å…³é”®è¯æœç´¢ï¼Œæˆ–è€…å«ä¼ ç»Ÿå…³é”®è¯æœç´¢ï¼Œä»–çš„æ ¸å¿ƒæ€æƒ³ä¸º<strong>â€œè¯é¢‘è¶Šé«˜ã€æ–‡æ¡£è¶ŠçŸ­ã€è¯è¶Šç¨€æœ‰ï¼Œåˆ™ç›¸å…³æ€§è¶Šé«˜â€</strong>ï¼Œåœ¨
TF-IDF çš„åŸºç¡€ä¸Šå¼•å…¥è¯é¢‘é¥±å’Œã€æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–ä¸¤é¡¹ä¿®æ­£ã€‚</p>
<blockquote>
<p>TF-IDFï¼ˆ<strong>Term Frequencyâ€“Inverse Document
Frequencyï¼Œè¯é¢‘-é€†æ–‡æ¡£é¢‘ç‡</strong>ï¼‰æ˜¯ä¸€ç§ç»å…¸çš„
<strong>æ–‡æœ¬ç‰¹å¾æƒé‡è®¡ç®—æ–¹æ³•</strong>ï¼Œç”¨äºè¡¡é‡
<strong>ä¸€ä¸ªè¯å¯¹ä¸€ç¯‡æ–‡æ¡£çš„é‡è¦æ€§</strong>ã€‚</p>
</blockquote>
<p>é¡¹ç›®ä¸­çš„bm25æ£€ç´¢é‡‡å–å¤šå­—æ®µåŒ¹é…çš„æ–¹å¼ï¼Œè¿˜æœ‰å‡ ä¸ªå‚æ•°éœ€è¦äº†è§£ï¼Œå¦‚ä¸‹</p>
<ol type="1">
<li><p><strong>â€˜typeâ€™</strong> :å†³å®šäº†<strong>å¦‚ä½•æŠŠå¤šä¸ªå­—æ®µçš„ BM25
æ‰“åˆ†åˆå¹¶æˆæœ€ç»ˆå¾—åˆ†</strong>,å¸¸ç”¨çš„å‚æ•°æœ‰ä»¥ä¸‹ä¸‰ç§</p>
<table>
<colgroup>
<col style="width: 24%">
<col style="width: 12%">
<col style="width: 63%">
</colgroup>
<thead>
<tr>
<th style="text-align: left;">type</th>
<th style="text-align: left;">ä¸­æ–‡å«ä¹‰</th>
<th style="text-align: left;">æ‰“åˆ†é€»è¾‘</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>best_fields</strong>ï¼ˆé»˜è®¤ï¼‰</td>
<td style="text-align: left;">æœ€ä½³å­—æ®µä¼˜å…ˆ</td>
<td style="text-align: left;">å– <strong>å¾—åˆ†æœ€é«˜çš„é‚£ä¸ªå­—æ®µ</strong>
åšæœ€ç»ˆåˆ†ï¼ˆå¯ç”¨ <code>tie_breaker</code> è®©æ¬¡ä½³å­—æ®µå†è´¡çŒ®ä¸€ç‚¹ç‚¹ï¼‰ã€‚</td>
</tr>
<tr>
<td style="text-align: left;"><strong>most_fields</strong></td>
<td style="text-align: left;">æœ€å¤šå­—æ®µä¼˜å…ˆ</td>
<td style="text-align: left;">æŠŠæ‰€æœ‰å‘½ä¸­å­—æ®µçš„å¾—åˆ†
<strong>ç›´æ¥ç›¸åŠ </strong>ï¼ˆç±»ä¼¼ OR é€»è¾‘ï¼‰ï¼Œå­—æ®µè¶Šå¤šåˆ†è¶Šé«˜ã€‚</td>
</tr>
<tr>
<td style="text-align: left;"><strong>cross_fields</strong></td>
<td style="text-align: left;">è·¨å­—æ®µåˆå¹¶</td>
<td style="text-align: left;">æŠŠå¤šä¸ªå­—æ®µè§†ä¸º
<strong>ä¸€ä¸ªè™šæ‹Ÿå¤§å­—æ®µ</strong>ï¼Œç»Ÿä¸€è®¡ç®— TF å’Œ
IDFï¼Œè§£å†³â€œå…³é”®è¯åˆ†æ•£åœ¨ä¸åŒå­—æ®µâ€é—®é¢˜ã€‚</td>
</tr>
</tbody>
</table></li>
<li><p><strong><code>'tie_breaker'</code></strong>ï¼šå½“å¤šä¸ªå­—æ®µéƒ½åŒ¹é…æ—¶ï¼Œ<strong>â€œæœ€ä½³å­—æ®µâ€å¾—åˆ†
+ å…¶ä½™å­—æ®µå¾—åˆ†Ã—tie_breaker</strong> ä½œä¸ºæœ€ç»ˆå¾—åˆ†ã€‚</p></li>
<li><p><strong><code>'operator'</code></strong>:æ§åˆ¶<strong>å•ä¸ªå­—æ®µå†…</strong>çš„å¤šä¸ªè¯é¡¹æ˜¯â€œANDâ€è¿˜æ˜¯â€œORâ€å…³ç³»ã€‚</p>
<ul>
<li><strong><code>"AND"</code></strong>
è¦æ±‚<strong>åŒä¸€ä¸ªå­—æ®µ</strong>å¿…é¡»åŒæ—¶åŒ…å«æ‰€æœ‰æŸ¥è¯¢è¯ï¼Œå‡å°‘å™ªéŸ³ï¼Œæé«˜ç²¾å‡†åº¦ã€‚é€‚åˆåœ°å€ã€å§“åç­‰è·¨å­—æ®µä¸¥æ ¼åŒ¹é…ã€‚</li>
<li><strong><code>"OR"</code></strong>
åªè¦å­—æ®µé‡Œå‡ºç°ä»»æ„ä¸€ä¸ªè¯å°±åŒ¹é…ï¼Œå¬å›é‡å¤§ï¼Œä½†å¯èƒ½å¼•å…¥ä¸ç›¸å…³ç»“æœã€‚</li>
</ul></li>
</ol>
<p>æœ€åï¼Œæ¯ä¸ªå­—æ®µè¿˜å¯ä»¥äººå·¥è®¾ç½®æƒé‡ï¼Œå¦‚<code>"fields": ["title^3", "content", "tags^2"]</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def bm25_query(search_query: str):</span><br><span class="line">    # ä½¿ç”¨BM25ç®—æ³•è¿›è¡Œä¼ ç»Ÿå…³é”®è¯åŒ¹é…</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;query&quot;: &#123;</span><br><span class="line">            &quot;multi_match&quot;: &#123;  # å¤šå­—æ®µåŒ¹é…æŸ¥è¯¢</span><br><span class="line">                &quot;query&quot;: search_query,</span><br><span class="line">                &quot;fields&quot;: [&quot;text&quot;, &quot;report_name&quot;, &quot;report_url&quot;]  # åœ¨è¿™äº›å­—æ®µä¸­æœç´¢</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;size&quot;: 8,  # è¿”å›æœ€å¤š8ä¸ªç»“æœ</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="æ··åˆæ£€ç´¢">æ··åˆæ£€ç´¢</h5>
<p>æ··åˆæ£€ç´¢ä¹Ÿå°±æ˜¯ <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rrf.html">Reciprocal
Rank Fusion</a>ï¼ˆRRFï¼‰ï¼Œé€šè¿‡ç»“åˆå‘é‡æœç´¢å’Œ BM25 æœç´¢çš„ç»“æœç»¼åˆåˆ¤æ–­ã€‚</p>
<p>ä½†ç”±äºesä¸­æ··åˆæ£€ç´¢éœ€è¦ä»˜è´¹ä½¿ç”¨ï¼Œåç»­æ£€ç´¢æ•ˆæœè¯„ä¼°æ—¶ä¸åšæµ‹è¯•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">def hybrid_query(search_query: str):</span><br><span class="line">    # ä½¿ç”¨ä¸ç´¢å¼•æ—¶ç›¸åŒçš„åµŒå…¥æ¨¡å‹å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡</span><br><span class="line">    vector = embeddings.embed_query(search_query)</span><br><span class="line">    </span><br><span class="line">    # æ„å»ºæ··åˆæœç´¢æŸ¥è¯¢ç»“æ„</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;retriever&quot;: &#123;</span><br><span class="line">            # ä½¿ç”¨RRF (Reciprocal Rank Fusion) ç®—æ³•èåˆå¤šä¸ªæ£€ç´¢å™¨çš„ç»“æœ</span><br><span class="line">            &quot;rrf&quot;: &#123;</span><br><span class="line">                # å®šä¹‰å¤šä¸ªæ£€ç´¢å™¨åˆ—è¡¨</span><br><span class="line">                &quot;retrievers&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        # ç¬¬ä¸€ä¸ªæ£€ç´¢å™¨ï¼šå¤šå­—æ®µBM25å…³é”®è¯æœç´¢</span><br><span class="line">                        &quot;standard&quot;: &#123;</span><br><span class="line">                            &quot;query&quot;: &#123;</span><br><span class="line">                                # ä½¿ç”¨multi_matchåœ¨å¤šä¸ªå­—æ®µä¸Šè¿›è¡ŒBM25æœç´¢</span><br><span class="line">                                &quot;multi_match&quot;: &#123;</span><br><span class="line">                                    &quot;query&quot;: search_query,</span><br><span class="line">                                    &quot;type&quot;: &quot;best_fields&quot;,      # é€‰æ‹©æœ€ä½³åŒ¹é…å­—æ®µ</span><br><span class="line">                                    &quot;fields&quot;: [&quot;text&quot;, &quot;report_name&quot;, &quot;report_url&quot;]  # åœ¨è¿™äº›å­—æ®µä¸­æœç´¢</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        # ç¬¬äºŒä¸ªæ£€ç´¢å™¨ï¼šKNNå‘é‡è¿‘ä¼¼æœç´¢</span><br><span class="line">                        &quot;knn&quot;: &#123;</span><br><span class="line">                            &quot;field&quot;: dense_vector_field,      # å‘é‡å­—æ®µåï¼ˆä½¿ç”¨å®šä¹‰çš„å˜é‡ï¼‰</span><br><span class="line">                            &quot;query_vector&quot;: vector,           # æŸ¥è¯¢å‘é‡</span><br><span class="line">                            &quot;k&quot;: 5,                          # è¿”å›5ä¸ªæœ€ç›¸ä¼¼çš„å‘é‡ç»“æœ</span><br><span class="line">                            &quot;num_candidates&quot;: 10,            # å€™é€‰å‘é‡æ•°é‡ï¼Œç”¨äºæé«˜æœç´¢å‡†ç¡®æ€§</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="æ¨¡ç³Šæ£€ç´¢">æ¨¡ç³Šæ£€ç´¢</h5>
<p>æ— è®ºæ˜¯åœ¨ç½‘é¡µæœç´¢ã€æ–‡ä»¶æ£€ç´¢ï¼Œè¿˜æ˜¯æ•°æ®åº“æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬æ—¶å¸¸ä¼šå› ä¸ºæ‹¼å†™é”™è¯¯æˆ–ä¿¡æ¯ä¸å®Œæ•´è€Œæ— æ³•æ‰¾åˆ°éœ€è¦çš„ç»“æœã€‚<strong>æ¨¡ç³Šæœç´¢</strong>ï¼ˆFuzzy
Searchï¼‰åº”è¿è€Œç”Ÿï¼Œå®ƒé€šè¿‡è¯†åˆ«ä¸æŸ¥è¯¢ç›¸ä¼¼çš„è¯è¯­æ¥å¸®åŠ©æˆ‘ä»¬è·å¾—æ›´åŠ çµæ´»çš„æœç´¢ç»“æœã€‚</p>
<p>è¿™é‡Œæ˜¯å°†bm25ä¸æ¨¡ç³Šæœç´¢ç»“åˆèµ·æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">def fuzzy_query(search_query: str):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    åˆ›å»ºæ¨¡ç³Šæœç´¢æŸ¥è¯¢å‡½æ•°ï¼Œæ”¯æŒæ‹¼å†™é”™è¯¯å’Œè¿‘ä¼¼åŒ¹é…</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        search_query (str): ç”¨æˆ·è¾“å…¥çš„æœç´¢æŸ¥è¯¢æ–‡æœ¬</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        Dict: Elasticsearchæ¨¡ç³Šæœç´¢æŸ¥è¯¢ä½“</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;query&quot;: &#123;</span><br><span class="line">            # ä½¿ç”¨matchæŸ¥è¯¢è¿›è¡Œæ–‡æœ¬åŒ¹é…</span><br><span class="line">            &quot;match&quot;: &#123;</span><br><span class="line">                # åœ¨æŒ‡å®šçš„æ–‡æœ¬å­—æ®µä¸­è¿›è¡Œæœç´¢</span><br><span class="line">                text_field: &#123;</span><br><span class="line">                    &quot;query&quot;: search_query,        # ç”¨æˆ·çš„æœç´¢æŸ¥è¯¢æ–‡æœ¬</span><br><span class="line">                    &quot;fuzziness&quot;: &quot;AUTO&quot;,          # è‡ªåŠ¨æ¨¡ç³ŠåŒ¹é…è®¾ç½®</span><br><span class="line">                    # fuzzinesså‚æ•°è¯´æ˜ï¼š</span><br><span class="line">                    # - &quot;AUTO&quot;ï¼šæ ¹æ®è¯é•¿åº¦è‡ªåŠ¨è°ƒæ•´æ¨¡ç³Šåº¦</span><br><span class="line">                    #   - 0-2ä¸ªå­—ç¬¦ï¼šä¸å…è®¸é”™è¯¯</span><br><span class="line">                    #   - 3-5ä¸ªå­—ç¬¦ï¼šå…è®¸1ä¸ªç¼–è¾‘è·ç¦»é”™è¯¯</span><br><span class="line">                    #   - 5ä¸ªä»¥ä¸Šå­—ç¬¦ï¼šå…è®¸2ä¸ªç¼–è¾‘è·ç¦»é”™è¯¯</span><br><span class="line">                    # - ä¹Ÿå¯ä»¥è®¾ç½®å…·ä½“æ•°å€¼ï¼š0, 1, 2</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>AUTO</code> è§„åˆ™ï¼š<strong>0~2
å­—ç¬¦</strong>ä¸å…è®¸é”™ï¼›<strong>3~5 å­—ç¬¦</strong>æœ€å¤š1é”™ï¼›<strong>&gt;5
å­—ç¬¦</strong>æœ€å¤š2é”™ã€‚</li>
<li>å¯¹ <strong>text å­—æ®µ</strong>å…ˆåˆ†è¯ï¼Œå†å¯¹æ¯ä¸ª token åšæ¨¡ç³Š â†’ å¬å›
<code>Elasticsearch</code>ã€‚</li>
</ul>
<h4 id="elasticsearchçš„è¿æ¥">elasticsearchçš„è¿æ¥</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from langchain_elasticsearch import ElasticsearchRetriever</span><br><span class="line">from embeddings_model import select_embeddings_model</span><br><span class="line"># æ ¹æ®æ¨¡å‹åç§°é€‰æ‹©åµŒå…¥æ¨¡å‹</span><br><span class="line">embedding_model_name=&#x27;bge&#x27;</span><br><span class="line">embeddings = select_embeddings_model(embedding_model_name)</span><br><span class="line">dense_vector_field=&#x27;vector&#x27;</span><br><span class="line">text_field=&#x27;text&#x27;</span><br><span class="line">search_func=fuzzy_query</span><br><span class="line"># åˆ›å»ºElasticsearchæ£€ç´¢å™¨</span><br><span class="line">retriever = ElasticsearchRetriever.from_es_params(</span><br><span class="line">    index_name=&quot;zxj_test&quot;,  # æŒ‡å®šç´¢å¼•åç§°</span><br><span class="line">    body_func=fuzzy_query,  # æŸ¥è¯¢å‡½æ•°</span><br><span class="line">    content_field=&quot;text&quot;,  # å†…å®¹å­—æ®µå</span><br><span class="line">    url=&#x27;http://elasticsearch:9200/&#x27;# ElasticsearchæœåŠ¡å™¨åœ°å€</span><br><span class="line">)</span><br><span class="line">print(&quot;è¿æ¥æˆåŠŸ&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="elasticsearchçš„å…¥åº“">elasticsearchçš„å…¥åº“</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">document = []</span><br><span class="line">id_list = []</span><br><span class="line"></span><br><span class="line"># éå†æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰.mdæ–‡ä»¶</span><br><span class="line">for filename in os.listdir(folder_path):</span><br><span class="line">    if filename.endswith(&quot;.md&quot;):</span><br><span class="line">        file_path = os.path.join(folder_path, filename)</span><br><span class="line"></span><br><span class="line">        # ä»æ–‡ä»¶åä¸­æå–chunk_idï¼ˆå»é™¤.mdæ‰©å±•åï¼‰</span><br><span class="line">        chunk_id = filename.replace(&quot;.md&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        # è¯»å–MDæ–‡ä»¶å†…å®¹</span><br><span class="line">        with open(file_path, &#x27;r&#x27;, encoding=&#x27;utf-8&#x27;) as file:</span><br><span class="line">            text_content = file.read()</span><br><span class="line">  </span><br><span class="line">        # æŸ¥æ‰¾å¯¹åº”çš„URLï¼ˆæ ¹æ®æ–‡ä»¶ååŒ¹é…ï¼‰</span><br><span class="line">        report_url = &quot;&quot;</span><br><span class="line">        # ä»folder_nameä¸­æå–æ ¸å¿ƒæ–‡æ¡£åï¼ˆæœ€åä¸€ä¸ª^åé¢çš„éƒ¨åˆ†ï¼‰</span><br><span class="line">        core_folder_name = folder_name.split(&#x27;^&#x27;)[-1]  # æå–æ ¸å¿ƒæ–‡æ¡£å</span><br><span class="line"></span><br><span class="line">        # æ ¹æ®core_folder_nameæŸ¥æ‰¾å¯¹åº”çš„URL</span><br><span class="line">        report_url = find_url_by_name_from_list(docs_data, core_folder_name)</span><br><span class="line"></span><br><span class="line">        # æ„å»ºdocumentç»“æ„</span><br><span class="line">        doc = Document(</span><br><span class="line">            page_content=text_content,</span><br><span class="line">            metadata=&#123;</span><br><span class="line">                &quot;report_name&quot;: folder_name,</span><br><span class="line">                &quot;report_url&quot;: report_url,</span><br><span class="line">                &quot;chunk_id&quot;: chunk_id</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        document.append(doc)</span><br><span class="line">        id_list.append(folder_name + &quot;_&quot; + chunk_id)</span><br><span class="line"></span><br><span class="line"># æ‰¹é‡æ·»åŠ åˆ°å‘é‡åº“</span><br><span class="line">es_vector_store.add_documents(documents=document, ids=id_list)</span><br><span class="line">print(f&quot;    æ–‡ä»¶å¤¹ &#123;folder_name&#125; å·²æˆåŠŸå…¥åº“ï¼Œå…± &#123;len(document)&#125; ä¸ªæ–‡æ¡£å—&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ç›¸å…³èµ„æ–™">ç›¸å…³èµ„æ–™</h4>
<p><a target="_blank" rel="noopener" href="https://python.langchain.ac.cn/docs/integrations/retrievers/elasticsearch_retriever/#bm25">Elasticsearchæ£€ç´¢å™¨
| ğŸ¦œï¸ğŸ”— LangChain æ¡†æ¶</a></p>
<h3 id="ä¸»æµçš„æ£€ç´¢ç­–ç•¥">ä¸»æµçš„æ£€ç´¢ç­–ç•¥</h3>
<h4 id="bm25-å…¨æ–‡å…³é”®è¯æ£€ç´¢">BM25 å…¨æ–‡å…³é”®è¯æ£€ç´¢</h4>
<p>BM25ï¼ˆBest Matching
25ï¼‰æ˜¯ä¸€ç§ä¹…ç»è€ƒéªŒçš„æ’åºç®—æ³•ï¼Œå¹¿æ³›åº”ç”¨äºä¼ ç»Ÿæœç´¢å¼•æ“ä¸­ã€‚å®ƒåŸºäºâ€œè¯è¢‹æ¨¡å‹â€ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å…³é”®è¯åŒ¹é…ç¨‹åº¦æ¥è¡¡é‡æ–‡æ¡£ä¸æŸ¥è¯¢çš„ç›¸å…³æ€§ã€‚</p>
<p>æ ¸å¿ƒåŸç†æ¦‚è§ˆï¼š</p>
<p>è¯é¢‘ (Term Frequency,
TF)ï¼šä¸€ä¸ªè¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°è¶Šå¤šï¼Œé€šå¸¸æ„å‘³ç€è¿™ç¯‡æ–‡æ¡£ä¸è¯¥è¯ç›¸å…³æ€§è¶Šé«˜ã€‚ä½†BM25ä¼šè¿›è¡Œâ€œé¥±å’Œåº¦â€å¤„ç†ï¼Œé¿å…æŸäº›è¶…é«˜é¢‘è¯è¿‡åº¦å½±å“ç»“æœã€‚å¯ä»¥æƒ³è±¡æˆï¼Œä¸€ç¯‡æ–‡ç« æåˆ°â€œè‹¹æœâ€10æ¬¡ï¼Œæ¯”æåˆ°1æ¬¡æ›´ç›¸å…³ï¼Œä½†æåˆ°100æ¬¡å’Œæåˆ°50æ¬¡ï¼Œåœ¨â€œè‹¹æœâ€è¿™ä¸ªä¸»é¢˜ä¸Šçš„ç›¸å…³æ€§å¢åŠ å¯èƒ½å°±æ²¡é‚£ä¹ˆæ˜¾è‘—äº†ã€‚
é€†æ–‡æ¡£é¢‘ç‡ (Inverse Document Frequency,
IDF)ï¼šå¦‚æœä¸€ä¸ªè¯åœ¨æ•´ä¸ªæ–‡æ¡£é›†åˆä¸­éƒ½å¾ˆç½•è§ï¼ˆåªåœ¨å°‘æ•°æ–‡æ¡£ä¸­å‡ºç°ï¼‰ï¼Œé‚£ä¹ˆå®ƒå¯¹äºåŒºåˆ†æ–‡æ¡£ä¸»é¢˜å°±æ›´é‡è¦ï¼ŒIDFå€¼å°±é«˜ã€‚æ¯”å¦‚â€œé‡å­çº ç¼ â€è¿™ä¸ªè¯è¿œæ¯”â€œçš„â€ã€â€œæ˜¯â€è¿™ç±»è¯æ›´èƒ½é”å®šä¸“ä¸šæ–‡æ¡£ã€‚
æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–ï¼šç”¨äºå¹³è¡¡é•¿çŸ­æ–‡æ¡£çš„å¾—åˆ†ï¼Œé¿å…é•¿æ–‡æ¡£ä»…ä»…å› ä¸ºå†…å®¹å¤šè€Œè·å¾—ä¸å…¬å¹³çš„é«˜åˆ†ã€‚
å·¥ä½œæ–¹å¼ä¸¾ä¾‹ï¼šå½“ç”¨æˆ·æœç´¢â€œæ·±åº¦å­¦ä¹ å…¥é—¨æ•™ç¨‹â€æ—¶ï¼ŒBM25ä¼šå€¾å‘äºæ‰¾å‡ºé‚£äº›æ›´é¢‘ç¹å‡ºç°â€œæ·±åº¦å­¦ä¹ â€ã€â€œå…¥é—¨â€ã€â€œæ•™ç¨‹â€è¿™äº›è¯ï¼Œä¸”è¿™äº›è¯ç›¸å¯¹ä¸é‚£ä¹ˆå¸¸è§çš„æ–‡æ¡£ã€‚</p>
<p><strong>1. å…¬å¼æ•´ä½“ç»“æ„</strong> <span class="math display">$$
\text{score}(D, Q) = \sum_{i=1}^{n} \text{IDF}(q_i) \cdot
\underbrace{\frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot
\left(1 - b + b \cdot
\frac{|D|}{\text{avgdl}}\right)}}_{\text{è¯é¢‘å½’ä¸€åŒ–é¡¹ï¼ˆTFï¼‰}}
$$</span> - <strong>IDF éƒ¨åˆ†</strong>ï¼šè¡¡é‡è¯é¡¹ $ q_i $
çš„åŒºåˆ†èƒ½åŠ›ï¼ˆé€†æ–‡æ¡£é¢‘ç‡ï¼‰ã€‚ - <strong>TF éƒ¨åˆ†</strong>ï¼šè¡¡é‡è¯é¡¹ $ q_i $
åœ¨æ–‡æ¡£ $ D $ ä¸­çš„åŒ¹é…ç¨‹åº¦ï¼ˆè¯é¢‘å½’ä¸€åŒ–ï¼‰ã€‚ -
<strong>æ±‚å’Œ</strong>ï¼šå¯¹æŸ¥è¯¢ä¸­çš„æ‰€æœ‰è¯é¡¹ $ q_i $
çš„å¾—åˆ†æ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆç›¸å…³æ€§åˆ†æ•°ã€‚</p>
<p><strong>2. IDF éƒ¨åˆ†</strong> <span class="math display">$$
\text{IDF}(q_i) = \ln\left(\frac{N - n(q_i) + 0.5}{n(q_i) + 0.5}\right)
$$</span> - <strong>æ„ä¹‰</strong>ï¼šIDF å€¼è¶Šé«˜ï¼Œè¯é¡¹ $ q_i $
è¶Šèƒ½åŒºåˆ†æ–‡æ¡£ï¼ˆå¸¸è§äºå°‘æ•°æ–‡æ¡£ä¸­çš„è¯ï¼‰ã€‚ -
<strong>å¹³æ»‘å¤„ç†</strong>ï¼šåˆ†å­å’Œåˆ†æ¯å‡åŠ  0.5ï¼Œé¿å…æç«¯å€¼ï¼ˆå¦‚ $ n(q_i) =
0 $ æ—¶ ID æ— é™å¤§ï¼‰ã€‚ - <strong>å‚æ•°</strong>ï¼š - $ N $ï¼šæ–‡æ¡£æ€»æ•°ã€‚ - $
n(q_i) $ï¼šåŒ…å« $ q_i $ çš„æ–‡æ¡£æ•°ã€‚</p>
<p><strong>3. è¯é¢‘å½’ä¸€åŒ–é¡¹ï¼ˆTFï¼‰</strong> <span class="math display">$$
\frac{f(q_i, D) \cdot (k_1 + 1)}{f(q_i, D) + k_1 \cdot \left(1 - b + b
\cdot \frac{|D|}{\text{avgdl}}\right)}
$$</span> - <strong>éçº¿æ€§é¥±å’Œ</strong>ï¼šåˆ†å­å’Œåˆ†æ¯å‡åŒ…å« $ f(q_i, D)
$ï¼Œä½¿è¯é¢‘å¢é•¿å¸¦æ¥çš„å¢ç›Šé€æ¸å‡å°ï¼ˆé¿å…é•¿æ–‡æ¡£ä¸­é‡å¤è¯é¡¹çš„è¿‡åº¦å½±å“ï¼‰ã€‚ -
<strong>æ–‡æ¡£é•¿åº¦å½’ä¸€åŒ–</strong>ï¼š - $ |D| $ï¼šæ–‡æ¡£ $ D $ çš„é•¿åº¦ï¼ˆè¯æ•°ï¼‰ã€‚
- $ $ï¼šæ•´ä¸ªæ–‡æ¡£é›†åˆçš„å¹³å‡æ–‡æ¡£é•¿åº¦ã€‚ - $ b <span class="math inline">ï¼š<em>æ§</em><em>åˆ¶</em><em>æ–‡</em><em>æ¡£</em><em>é•¿</em><em>åº¦</em><em>å¯¹</em><em>å¾—</em><em>åˆ†</em><em>çš„</em><em>å½±</em><em>å“</em>ï¼ˆ</span>
b=1 $ æ—¶å®Œå…¨å½’ä¸€åŒ–ï¼Œ$ b=0 $ æ—¶å¿½ç•¥é•¿åº¦ï¼‰ã€‚ - <strong>å‚æ•°</strong>ï¼š - $
k_1 $ï¼šæ§åˆ¶è¯é¢‘é¥±å’Œçš„ç³»æ•°ï¼ˆé€šå¸¸ $ k_1 $ï¼Œé»˜è®¤ $ k_1 = 1.5 $ï¼‰ã€‚ - $ b
$ï¼šé»˜è®¤ $ b = 0.75 $ã€‚</p>
<p>è¿™ä¸ªå…¬å¼è™½ç„¶çœ‹èµ·æ¥æœ‰äº›å¤æ‚ï¼Œä½†å®ƒç²¾å¦™åœ°å¹³è¡¡äº†è¯é¢‘ã€è¯çš„ç¨€æœ‰åº¦ä»¥åŠæ–‡æ¡£é•¿åº¦è¿™å‡ ä¸ªæ ¸å¿ƒå› ç´ ï¼Œæ˜¯BM25ç®—æ³•æ•ˆæœå‡ºè‰²çš„å…³é”®ã€‚</p>
<h6 id="bm25å…¨æ–‡æœç´¢ä¸å€’æ’ç´¢å¼•å®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„">BM25ã€å…¨æ–‡æœç´¢ä¸å€’æ’ç´¢å¼•ï¼šå®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ</h6>
<p><strong>è¿™ä¸‰è€…æ˜¯æ„å»ºæœç´¢ç³»ç»Ÿçš„å…³é”®ç»„ä»¶ï¼š</strong></p>
<ul>
<li><p>å…¨æ–‡æœç´¢ (Full-Text
Search)ï¼šè¿™æ˜¯æˆ‘ä»¬å¸Œæœ›è¾¾æˆçš„ç›®æ ‡â€”â€”åœ¨å¤§é‡æ–‡æœ¬ä¸­æ‰¾åˆ°åŒ…å«ç‰¹å®šä¿¡æ¯çš„æ–‡æ¡£ã€‚</p></li>
<li><p>å€’æ’ç´¢å¼• (Inverted
Index)ï¼šè¿™æ˜¯å®ç°é«˜æ•ˆå…¨æ–‡æœç´¢çš„æ•°æ®ç»“æ„åŸºç¡€ã€‚å®ƒåƒä¸€æœ¬ä¹¦æœ«å°¾çš„è¯¦ç»†â€œå…³é”®è¯ç´¢å¼•â€ï¼Œè®°å½•äº†æ¯ä¸ªè¯å‡ºç°åœ¨å“ªäº›æ–‡æ¡£ä¸­ä»¥åŠç›¸å…³ä½ç½®ä¿¡æ¯ã€‚å½“ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡å€’æ’ç´¢å¼•å¿«é€Ÿå®šä½åˆ°åŒ…å«æŸ¥è¯¢è¯çš„å€™é€‰æ–‡æ¡£ã€‚</p></li>
<li><p>BM25ï¼šåœ¨é€šè¿‡å€’æ’ç´¢å¼•æ‰¾åˆ°å€™é€‰æ–‡æ¡£åï¼ŒBM25ç®—æ³•ç™»åœºï¼Œä¸ºæ¯ä¸ªæ–‡æ¡£è®¡ç®—ä¸€ä¸ªç›¸å…³æ€§å¾—åˆ†ï¼Œç„¶åæŒ‰åˆ†æ’åºï¼Œå°†æœ€ç›¸å…³çš„ç»“æœå‘ˆç°ç»™ç”¨æˆ·ã€‚</p></li>
</ul>
<p><strong>æŠŠå®ƒä»¬æ¯”ä½œåœ¨å›¾ä¹¦é¦†æ‰¾ç‰¹å®šä¸»é¢˜çš„ä¹¦ç±ï¼š</strong></p>
<ul>
<li>ä½ å‘Šè¯‰å›¾ä¹¦ç®¡ç†å‘˜ä½ è¦æ‰¾å…³äºâ€œå¤©ä½“ç‰©ç†å­¦â€çš„ä¹¦ï¼ˆç”¨æˆ·æŸ¥è¯¢ï¼‰ã€‚</li>
<li>ç®¡ç†å‘˜æŸ¥é˜…ä¸€ä¸ªæ€»å¡ç‰‡ç´¢å¼•ï¼ˆå€’æ’ç´¢å¼•ï¼‰ï¼Œè¿…é€Ÿå‘Šè¯‰ä½ å“ªäº›ä¹¦æ¶ï¼ˆæ–‡æ¡£IDï¼‰ä¸Šæœ‰åŒ…å«â€œå¤©ä½“ç‰©ç†å­¦â€è¿™ä¸ªè¯çš„ä¹¦ã€‚</li>
<li>ä½ èµ°åˆ°è¿™äº›ä¹¦æ¶ï¼Œå¿«é€Ÿç¿»é˜…è¿™äº›ä¹¦ï¼ˆBM25è¯„åˆ†è¿‡ç¨‹ï¼‰ï¼Œæ ¹æ®ç›®å½•ã€æ‘˜è¦å’ŒæåŠâ€œå¤©ä½“ç‰©ç†å­¦â€çš„é¢‘ç¹ç¨‹åº¦åŠé‡è¦æ€§ï¼Œåˆ¤æ–­å“ªå‡ æœ¬æœ€ç¬¦åˆä½ çš„éœ€æ±‚ï¼Œå¹¶æŠŠå®ƒä»¬æŒ‰ç›¸å…³æ€§é«˜ä½æ’å¥½ã€‚</li>
</ul>
<h4 id="dense-vector-knn-å‘é‡è¯­ä¹‰æ£€ç´¢">Dense Vector / kNN
å‘é‡è¯­ä¹‰æ£€ç´¢</h4>
<p>å‘é‡è¯­ä¹‰æ£€ç´¢ï¼ˆDense Vector / k-Nearest Neighborï¼Œç®€ç§°
kNNï¼‰æ˜¯ä¸€ç§<strong>åŸºäºé«˜ç»´ç¨ å¯†å‘é‡è¡¨ç¤ºçš„è¯­ä¹‰æ£€ç´¢æŠ€æœ¯</strong>ï¼Œä¸ä¼ ç»Ÿå…³é”®è¯å€’æ’ç´¢å¼•ä¸åŒï¼Œå®ƒé€šè¿‡<strong>è‡ªç„¶è¯­è¨€çš„ä¸Šä¸‹æ–‡å«ä¹‰</strong>è€Œéå­—é¢åŒ¹é…æ¥å¯»æ‰¾æœ€ç›¸å…³çš„æ–‡æ¡£æˆ–å®ä½“ã€‚</p>
<ol type="1">
<li><p><strong>Embedding</strong>ï¼šä½¿ç”¨é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆå¦‚
BERTã€Sentence-Transformersï¼‰æŠŠæ–‡æœ¬æ˜ å°„ä¸º<strong>å›ºå®šç»´åº¦çš„ç¨ å¯†å‘é‡</strong>ï¼ˆé€šå¸¸
128â€“1024 ç»´ï¼‰ã€‚</p></li>
<li><p><strong>kNN
æœç´¢</strong>ï¼šç»™å®šæŸ¥è¯¢å‘é‡ï¼Œ<strong>åœ¨å‘é‡ç©ºé—´ä¸­æ‰¾è·ç¦»æœ€è¿‘çš„ k
ä¸ªæ–‡æ¡£å‘é‡</strong>ã€‚è·ç¦»åº¦é‡å¸¸è§ï¼š</p>
<ul>
<li>ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosineï¼‰</li>
<li>å†…ç§¯ / dot-product</li>
<li>L2 æ¬§æ°è·ç¦»</li>
</ul></li>
</ol>
<h4 id="hybrid-retrieval-æ··åˆæ£€ç´¢">Hybrid Retrieval æ··åˆæ£€ç´¢</h4>
<p>æ—¢ç„¶ä¸åŒçš„æ£€ç´¢ç­–ç•¥å„æœ‰åƒç§‹ï¼ˆä¾‹å¦‚ï¼ŒBM25æ“…é•¿å…³é”®è¯ç²¾ç¡®åŒ¹é…ï¼ŒEmbeddingæ“…é•¿è¯­ä¹‰ç†è§£ï¼‰ï¼Œé‚£ä¹ˆå°†å®ƒä»¬ç»“åˆèµ·æ¥ï¼Œæ˜¯ä¸æ˜¯èƒ½è¾¾åˆ°â€œ1+1&gt;2â€çš„æ•ˆæœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¿™å°±æ˜¯æ··åˆæ£€ç´¢çš„æ ¸å¿ƒæ€æƒ³ã€‚</p>
<p>å¸¸è§åšæ³•ï¼šåŒæ—¶ä½¿ç”¨BM25ï¼ˆæˆ–å…¶ä»–ç¨€ç–æ£€ç´¢æ–¹æ³•ï¼‰å’Œä¸€ç§æˆ–å¤šç§Embeddingæ£€ç´¢æ–¹æ³•ï¼Œç„¶åå°†å®ƒä»¬å„è‡ªçš„æ£€ç´¢ç»“æœè¿›è¡Œèåˆæ’åºã€‚</p>
<p>èåˆç­–ç•¥ä¸¾ä¾‹ï¼š</p>
<p>RRF (Reciprocal Rank Fusion,
å€’æ•°æ’åºèåˆ)ï¼šä¸€ç§ç®€å•ä½†é²æ£’çš„èåˆæ–¹æ³•ã€‚å®ƒä¸å…³å¿ƒä¸åŒæ£€ç´¢ç³»ç»Ÿè¾“å‡ºçš„åŸå§‹å¾—åˆ†ï¼Œåªå…³å¿ƒæ¯ä¸ªæ–‡æ¡£åœ¨å„è‡ªç»“æœåˆ—è¡¨ä¸­çš„æ’åã€‚ä¸€ä¸ªæ–‡æ¡£
doc çš„RRFå¾—åˆ†è®¡ç®—å¦‚ä¸‹ï¼š <span class="math display"><em>S</em><em>c</em><em>o</em><em>r</em><em>e</em><sub><em>R</em></sub><em>R</em><em>F</em>(<em>d</em><em>o</em><em>c</em>)â€„=â€„<em>Î£</em><sub><em>s</em>â€„âˆˆâ€„<em>S</em><em>y</em><em>s</em><em>t</em><em>e</em><em>m</em><em>s</em></sub>(1/(<em>k</em>â€…+â€…<em>r</em><em>a</em><em>n</em><em>k</em><sub><em>s</em></sub>(<em>d</em><em>o</em><em>c</em>)))</span>
å…¶ä¸­ï¼š</p>
<ul>
<li>Systems æ˜¯æ‰€æœ‰å‚ä¸èåˆçš„æ£€ç´¢ç³»ç»Ÿçš„é›†åˆã€‚</li>
<li>rank_s(doc) æ˜¯æ–‡æ¡£ doc åœ¨æ£€ç´¢ç³»ç»Ÿ s
ç»™å‡ºçš„ç»“æœåˆ—è¡¨ä¸­çš„æ’åï¼ˆä¾‹å¦‚ï¼Œç¬¬ä¸€åæ˜¯1ï¼Œç¬¬äºŒåæ˜¯2ï¼‰ã€‚</li>
<li>k
æ˜¯ä¸€ä¸ªå°å¸¸æ•°ï¼ˆä¾‹å¦‚ï¼Œå¸¸è®¾ç½®ä¸º60ï¼‰ï¼Œç”¨äºå¹³æ»‘å¾—åˆ†ï¼Œé¿å…æ’åé åçš„æ–‡æ¡£å¾—åˆ†è¿‡å°æˆ–æ’åç¬¬ä¸€çš„æ–‡æ¡£å¾—åˆ†å æ¯”è¿‡é«˜ã€‚</li>
</ul>
<h4 id="reranker-é‡æ’åºå™¨">Reranker é‡æ’åºå™¨</h4>
<p>ç»è¿‡ä¸Šè¿°ä¸€ç§æˆ–å¤šç§æ£€ç´¢ç­–ç•¥çš„â€œç²—ç­›â€ï¼ˆå¬å›é˜¶æ®µï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«è¾ƒå¤šå€™é€‰æ–‡æ¡£çš„åˆ—è¡¨ï¼ˆæ¯”å¦‚å‡ ç™¾ä¸ªï¼‰ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡æœ€ç»ˆå–‚ç»™LLMçš„æ–‡æ¡£è´¨é‡ï¼ŒRerankerï¼ˆé‡æ’åºå™¨ï¼‰åº”è¿è€Œç”Ÿã€‚å®ƒç›¸å½“äºä¸€ä½â€œç²¾ç‚¼å¸ˆâ€æˆ–â€œè´¨é‡å“é‰´å®˜â€ï¼Œå¯¹åˆæ­¥å¬å›çš„ç»“æœè¿›è¡Œæ›´ç»†è‡´ã€æ›´ç²¾å‡†çš„äºŒæ¬¡æ’åºã€‚</p>
<ol type="1">
<li>å¬å› å€’æ’ / å‘é‡ / æ··åˆå…ˆç»™ <strong>Top-N</strong>ï¼ˆNâ‰ˆ100~1
kï¼‰ã€‚</li>
<li>æ‹¼ç‰¹å¾ æŠŠ <code>(query, doc)</code> æ‹¼æˆä¸€æ¡è¾“å…¥ï¼š
<code>[CLS] ç”¨æˆ·é—®é¢˜ [SEP] æ ‡é¢˜+æ­£æ–‡ [SEP]</code>ã€‚</li>
<li>æ‰“åˆ† æ‰”ç»™ Cross-Encoder æˆ– ColBERT â†’
è¾“å‡º<strong>ä¸€ä¸ªç›¸å…³æ€§åˆ†æ•°</strong>ã€‚</li>
<li>é‡æ’ æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½é‡æ–°æ’åºï¼Œåªç•™
<strong>Top-K</strong>ï¼ˆKâ‰ˆ10~20ï¼‰ã€‚</li>
<li>è¿”å› é‡æ’åçš„çŸ­åˆ—è¡¨äº¤ç»™å‰ç«¯æˆ– LLMï¼Œå®Œæˆä¸€æ¬¡â€œç²¾è¯»â€ã€‚</li>
</ol>
<h4 id="å‚è€ƒ">å‚è€ƒ</h4>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_59614665/article/details/149066780">å¤§æ¨¡å‹RAG
|
æ·±å…¥äº†è§£å‡ ç§ä¸»æµçš„æ£€ç´¢ç­–ç•¥ï¼ˆBM25ã€Embeddingã€æ··åˆæ£€ç´¢ã€Rerankerï¼‰-CSDNåšå®¢</a></p>
<h3 id="é¡¹ç›®å…³äºelasticsearchä»£ç é˜…è¯»è®°å½•">é¡¹ç›®å…³äºelasticsearchä»£ç é˜…è¯»è®°å½•</h3>
<p>é˜…è¯»elasticsearchä»£ç ç›¸å…³è®°å½•:</p>
<ol type="1">
<li><strong>embedding_model</strong>.select_embeddings_model:æ ¹æ®æŒ‡å®šçš„æ¨¡å‹åç§°åŠ è½½</li>
<li><strong>make_es_vector_store</strong>ï¼š
<ol type="1">
<li>docs_url =
pd.read_excel(â€˜docs_new.xlsxâ€™)ï¼Œä»excelåŠ è½½urlå¹¶è¿›è¡Œæ•°æ®å¤„ç†ï¼Œä¿å­˜ç­›é€‰åçš„ur</li>
<li>å®Œæˆæ–‡ä»¶åŠ è½½æµ‹è¯•ï¼šxizhang/retrival/docfile_test/test.pyï¼›</li>
<li>åˆå§‹åŒ–esï¼Œä½¿ç”¨elastic_search.load_es_indexåŠ è½½å­˜å‚¨ç´¢å¼•</li>
<li>å®Œæˆæµ‹è¯•elasticsearchè¿æ¥ä¸ç´¢å¼•æ„å»ºï¼ˆç´¢å¼•åzxj_testï¼‰ï¼š/aisys/repo_dev/xizhang/retrival/elasticsearch_test/test_es_connect.pyï¼Œ/aisys/repo_dev/xizhang/retrival/elasticsearch_test/test_add_es.py</li>
<li>é¡ºåºæ‰¹é‡å¤„ç†æ–‡ä»¶ï¼šå…±16000å¤šä»½ï¼Œæ¯åä»½ä¸ºä¸€æ‰¹è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨download_pdf.pyè¿›è¡Œæ–‡ä»¶ä¸‹è½½ï¼Œä½¿ç”¨ï¼Œä½¿ç”¨vector_base.rewrite_fileå¯¹æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œå¯ä»¥ä¿®æ”¹ä»£ç ï¼Œå¢åŠ å¯¹mineruå¤„ç†pdfçš„markdownæ–‡ä»¶çš„å¤„ç†ï¼Œè¿”å›Documentå¯¹è±¡åˆ—è¡¨ï¼›</li>
</ol></li>
<li><strong>elastic_search</strong></li>
</ol>
<p>é‡å†™äº†æ£€ç´¢ç­–ç•¥çš„å‡½æ•°ï¼ŒåŒ…æ‹¬BM25ï¼ŒKNNï¼Œæ··åˆæœç´¢</p>
<ol type="1">
<li><p>elastic_retrieveråˆ›å»ºElasticsearchæ£€ç´¢å™¨ï¼šæ ¹æ®æœç´¢ç±»å‹é€‰æ‹©å¯¹åº”çš„æŸ¥è¯¢å‡½æ•°ï¼Œåˆ›å»ºElasticsearchæ£€ç´¢å™¨ElasticsearchRetriever.from_es_params</p></li>
<li><p><strong>retrievers</strong></p>
<ol type="1">
<li>å®šä¹‰å‡½æ•°select_retrieverï¼Œæ ¹æ®æŒ‡å®šçš„åç§°é€‰æ‹©å¹¶è¿”å›ç›¸åº”çš„æ£€ç´¢å™¨ï¼Œç›®å‰åªæœ‰bm25</li>
</ol></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">å¼ ç†™æµš</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="æœ¬ç«™è®¿é—®æ•° fa fa-user æ¬¡"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="æœ¬ç«™æ€»è®¿é—®é‡ fa fa-eye æ¬¡"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="400" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
