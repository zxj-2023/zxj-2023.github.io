<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-bounce.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="zxj Blogs">
<meta property="og:type" content="website">
<meta property="og:title" content="Zhang XiJun">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="Zhang XiJun">
<meta property="og:description" content="zxj Blogs">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="å¼ ç†™æµš">
<meta property="article:tag" content="zxj">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zhang XiJun</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zhang XiJun</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">BLOGS</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="å¼ ç†™æµš"
      src="/images/zxjavatar.gif">
  <p class="site-author-name" itemprop="name">å¼ ç†™æµš</p>
  <div class="site-description" itemprop="description">zxj Blogs</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zxj-2023" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;zxj-2023" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://wpa.qq.com/msgrd?v=3&uin=2902065320&site=qq&menu=yes" title="QQ â†’ http:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;2902065320&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener me" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          é“¾æ¥
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://zxj-2023.github.io/" title="https:&#x2F;&#x2F;zxj-2023.github.io" rel="noopener" target="_blank">Zhang XiJun</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://theme-next.js.org/" title="https:&#x2F;&#x2F;theme-next.js.org" rel="noopener" target="_blank">NexT</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/02/%E5%AD%A6%E4%B9%A0/python%E7%9B%B8%E5%85%B3/python-uv%E5%8C%85%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/02/%E5%AD%A6%E4%B9%A0/python%E7%9B%B8%E5%85%B3/python-uv%E5%8C%85%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">python-uvåŒ…ç®¡ç†</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-02 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-02T00:00:00+08:00">2025-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-10-18 20:46:36" itemprop="dateModified" datetime="2025-10-18T20:46:36+08:00">2025-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ </span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/python%E7%9B%B8%E5%85%B3/" itemprop="url" rel="index"><span itemprop="name">pythonç›¸å…³</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä»€ä¹ˆæ˜¯uv">ä»€ä¹ˆæ˜¯uv</h3>
<p><code>uv</code> æ˜¯ç”± <strong>Astral</strong>
å›¢é˜Ÿå¼€å‘çš„ä¸€ä¸ª<strong>è¶…é«˜é€Ÿ Python åŒ…ç®¡ç†å™¨</strong>ï¼Œç”¨
<strong>Rust</strong> ç¼–å†™ï¼Œç›®æ ‡æ˜¯æ›¿ä»£
<code>pip</code>ã€<code>venv</code>ã€<code>pip-tools</code>ã€<code>poetry</code>
ç­‰å¤šä¸ªå·¥å…·ã€‚</p>
<h3 id="uvå¸¸ç”¨å‘½ä»¤">uvå¸¸ç”¨å‘½ä»¤</h3>
<p>uv init myproj åˆ›å»ºæ–°é¡¹ç›®</p>
<p>source .venv/bin/activateï¼ˆLinux/macOSï¼‰æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</p>
<p>uv add requests å®‰è£…ä¾èµ–å¹¶å†™å…¥ pyproject.toml</p>
<p>uv remove requests ç§»é™¤ä¾èµ–</p>
<p>uv sync åŒæ­¥ä¾èµ–åˆ°è™šæ‹Ÿç¯å¢ƒ</p>
<p>uv export å¯¼å‡º lock æ–‡ä»¶ä¸º requirements.txt ç­‰æ ¼å¼</p>
<p>uv build æ„å»ºæºç åŒ…å’Œ wheel</p>
<p>uv publish å‘å¸ƒåˆ° PyPI</p>
<h3 id="uvxæ˜¯ä»€ä¹ˆ">uvxæ˜¯ä»€ä¹ˆ</h3>
<p><strong><code>uvx</code></strong> æ˜¯ï¼š</p>
<blockquote>
<p><strong>uv tool run</strong>
çš„<strong>å¿«æ·åˆ«å</strong>ï¼ˆaliasï¼‰ï¼Œç”¨äº<strong>æ— éœ€å®‰è£…å³å¯è¿è¡Œ
Python åŒ…æä¾›çš„å‘½ä»¤è¡Œå·¥å…·</strong>ã€‚</p>
</blockquote>
<p><code>uvx</code> å°±åƒ Python ä¸–ç•Œçš„ <strong><code>npx</code></strong>
æˆ– <strong><code>pipx run</code></strong> â€”â€”
<strong>ä¸´æ—¶æ‹‰å–ã€æ„å»ºéš”ç¦»ç¯å¢ƒã€è¿è¡Œå·¥å…·ï¼Œç”¨å®Œå³èµ°ï¼Œä¸ç•™ç—•è¿¹</strong>ã€‚</p>
<h3 id="uvç®¡ç†å‘½ä»¤è¡Œå·¥å…·">uvç®¡ç†å‘½ä»¤è¡Œå·¥å…·</h3>
<p>ä½¿ç”¨<code>uv tool</code></p>
<ul>
<li><strong>ç”¨é€”</strong>ï¼šå®‰è£…ã€ç®¡ç†ã€è¿è¡Œ<strong>å…¨å±€å¯ç”¨çš„ Python
å‘½ä»¤è¡Œå·¥å…·</strong>ã€‚</li>
<li><strong>å®‰è£…ä½ç½®</strong>ï¼šé»˜è®¤å®‰è£…åˆ°
<code>~/.local/bin</code>ï¼ˆWindows:
<code>C:\Users\&lt;USER&gt;\.local\bin</code>ï¼‰ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv tool install pytest</span><br></pre></td></tr></table></figure>
<p>å®‰è£…åå¯ä»¥ç›´æ¥ä½¿ç”¨<code>pytest</code>è€Œä¸ç”¨<code>uv run pytest</code></p>
<h3 id="uv-syncå’Œuv-pip-install--e-.çš„åŒºåˆ«">uv syncå’Œuv pip install -e
.çš„åŒºåˆ«</h3>
<p>âœ… <code>uv pip install -e .</code></p>
<ul>
<li><strong>ä½œç”¨</strong>ï¼šå°†å½“å‰é¡¹ç›®ä»¥<strong>å¯ç¼–è¾‘æ¨¡å¼</strong>å®‰è£…åˆ°å½“å‰
Python ç¯å¢ƒã€‚</li>
<li><strong>è¡Œä¸º</strong>ï¼š
<ul>
<li>è¯»å– <code>pyproject.toml</code> ä¸­çš„ <code>[project]</code>
å…ƒæ•°æ®ã€‚</li>
<li>æ„å»ºå¹¶å®‰è£…ä½ çš„<strong>ä¸»åŒ…</strong>ï¼ˆå¦‚
<code>my_package</code>ï¼‰ï¼Œä½¿å…¶å¯è¢« <code>import</code>ã€‚</li>
<li><strong>ä¸ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–</strong>ï¼ˆé™¤éä½ æ˜¾å¼åŠ ä¸Š
<code>--deps</code>ï¼Œä½†é€šå¸¸ä¸è¿™ä¹ˆåšï¼‰ã€‚</li>
</ul></li>
<li><strong>å…¸å‹ç”¨é€”</strong>ï¼šå¼€å‘è‡ªå·±çš„åŒ…æ—¶ï¼Œè®©æœ¬åœ°ä»£ç å¯å¯¼å…¥ã€‚</li>
</ul>
<p>âœ… <code>uv sync</code></p>
<ul>
<li><strong>ä½œç”¨</strong>ï¼š<strong>æ ¹æ®é”å®šæ–‡ä»¶ï¼ˆå¦‚
<code>uv.lock</code>ï¼‰ç²¾ç¡®åŒæ­¥æ•´ä¸ªé¡¹ç›®çš„ä¾èµ–ç¯å¢ƒ</strong>ã€‚</li>
<li><strong>è¡Œä¸º</strong>ï¼š
<ul>
<li>è¯»å– <code>uv.lock</code>ï¼ˆç”± <code>uv lock</code> ç”Ÿæˆï¼‰æˆ–
<code>pyproject.toml</code>ã€‚</li>
<li>å®‰è£…<strong>æ‰€æœ‰ä¾èµ–é¡¹</strong>ï¼ˆåŒ…æ‹¬ç›´æ¥ä¾èµ–å’Œä¼ é€’ä¾èµ–ï¼‰åˆ°å½“å‰ç¯å¢ƒã€‚</li>
<li><strong>é»˜è®¤ä¹Ÿä¼šä»¥å¯ç¼–è¾‘æ¨¡å¼å®‰è£…å½“å‰é¡¹ç›®</strong>ï¼ˆå¦‚æœ
<code>pyproject.toml</code> ä¸­å®šä¹‰äº†é¡¹ç›®ï¼‰ã€‚</li>
<li>ç¡®ä¿ç¯å¢ƒçŠ¶æ€ä¸é”å®šæ–‡ä»¶<strong>å®Œå…¨ä¸€è‡´</strong>ï¼ˆç‰ˆæœ¬ã€å“ˆå¸Œã€æ¥æºç­‰ï¼‰ã€‚</li>
</ul></li>
<li><strong>å‰æ</strong>ï¼šé€šå¸¸éœ€è¦å…ˆè¿è¡Œ <code>uv lock</code> ç”Ÿæˆ
<code>uv.lock</code>ã€‚</li>
</ul>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ajJ7zPEa5/?spm_id_from=333.1387.upload.video_card.click&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ã€uvã€‘Pythonè¿„ä»Šæœ€å¥½çš„é¡¹ç›®ç®¡ç†+ç¯å¢ƒç®¡ç†å·¥å…·ï¼ˆå§ï¼Ÿï¼‰_å“”å“©å“”å“©_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV13WGHz8EEz?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ä»pipåˆ°uvï¼šä¸€å£æ°”æ¢³ç†ç°ä»£Pythoné¡¹ç›®ç®¡ç†å…¨æµç¨‹ï¼_å“”å“©å“”å“©_bilibili</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/langgraph%E5%AE%9E%E6%88%98mcp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/langgraph%E5%AE%9E%E6%88%98mcp/" class="post-title-link" itemprop="url">langgraphå®æˆ˜mcp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-01T00:00:00+08:00">2025-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-02 11:47:16" itemprop="dateModified" datetime="2025-08-02T11:47:16+08:00">2025-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install langchain-mcp-adapters</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨langgraphè°ƒç”¨mcp">ä½¿ç”¨langgraphè°ƒç”¨mcp</h3>
<p>è¦ç‚¹ä¸»è¦æ˜¯åˆ©ç”¨MultiServerMCPClientæ„å»ºæœåŠ¡ï¼Œè·å–tool</p>
<p>åˆ©ç”¨é¢„è®¾çš„create_react_agentæ„å»ºReActæ¶æ„çš„æ™ºèƒ½ä½“å¹¶è°ƒç”¨å·¥å…·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">import asyncio # éœ€è¦å¯¼å…¥ asyncio æ¥è¿è¡Œå¼‚æ­¥å‡½æ•°</span><br><span class="line"># ä»langchain_mcp_adapters.clientæ¨¡å—å¯¼å…¥MultiServerMCPClientç±»</span><br><span class="line"># ä»langgraph.prebuiltæ¨¡å—å¯¼å…¥create_react_agentå‡½æ•°</span><br><span class="line">from langchain_mcp_adapters.client import MultiServerMCPClient</span><br><span class="line">from langgraph.prebuilt import create_react_agent</span><br><span class="line"></span><br><span class="line"># å¯¼å…¥ LLM ç›¸å…³åº“</span><br><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line"></span><br><span class="line"># å°†ä¸»è¦é€»è¾‘å°è£…åœ¨ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ä¸­</span><br><span class="line">async def main():</span><br><span class="line">    # åˆ›å»ºMultiServerMCPClientå®ä¾‹ï¼Œé…ç½®ä¸¤ä¸ªä¸åŒçš„æœåŠ¡</span><br><span class="line">    client = MultiServerMCPClient(</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;math&quot;: &#123;  # æ•°å­¦è®¡ç®—æœåŠ¡</span><br><span class="line">                &quot;command&quot;: &quot;python&quot;,  # ä½¿ç”¨pythonå‘½ä»¤å¯åŠ¨</span><br><span class="line">                # æ›¿æ¢ä¸ºä½ çš„math_server.pyæ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span><br><span class="line">                &quot;args&quot;: [&quot;/workspace/langgraph-mcp/math_server.py&quot;],</span><br><span class="line">                &quot;transport&quot;: &quot;stdio&quot;,  # ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºä¼ è¾“</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;weather&quot;: &#123;  # å¤©æ°”æœåŠ¡</span><br><span class="line">                # ç¡®ä¿ä½ çš„å¤©æ°”æœåŠ¡å™¨åœ¨8000ç«¯å£è¿è¡Œ</span><br><span class="line">                # *** ç¡®ä¿è¿™ä¸ª URL æ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ ***</span><br><span class="line">                &quot;url&quot;: &quot;http://localhost:8000/mcp&quot;,</span><br><span class="line">                &quot;transport&quot;: &quot;streamable_http&quot;,  # ä½¿ç”¨å¯æµå¼HTTPä¼ è¾“</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    tools = []</span><br><span class="line">    try:</span><br><span class="line">        # åœ¨å¼‚æ­¥å‡½æ•°å†…éƒ¨æ­£ç¡®ä½¿ç”¨ await</span><br><span class="line">        tools = await client.get_tools()</span><br><span class="line">        print(f&quot;æˆåŠŸè·å–åˆ° &#123;len(tools)&#125; ä¸ªMCPå·¥å…·ã€‚&quot;)</span><br><span class="line">        for tool_item in tools:</span><br><span class="line">            print(f&quot;  - &#123;tool_item.name&#125;: &#123;tool_item.description&#125;&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;è·å–MCPå·¥å…·å¤±è´¥: &#123;e&#125;&quot;)</span><br><span class="line">        print(&quot;è¯·ç¡®ä¿MCPæœåŠ¡URLæœ‰æ•ˆä¸”å¯è®¿é—®ï¼Œæˆ–è€…æ‚¨å·²æ­£ç¡®é…ç½®äº†è®¤è¯ä¿¡æ¯ã€‚&quot;)</span><br><span class="line">        # åœ¨å‡½æ•°å†…éƒ¨ï¼Œå¦‚æœå‡ºé”™å¯ä»¥é€‰æ‹©è¿”å›æˆ–ç»§ç»­å¤„ç†</span><br><span class="line">        # return # è¿™é‡Œå¯ä»¥ returnï¼Œä½†ä¼šç»“æŸ main å‡½æ•°</span><br><span class="line"></span><br><span class="line">    if not tools:</span><br><span class="line">        print(&quot;æ²¡æœ‰è·å–åˆ°å·¥å…·ï¼Œæ— æ³•åˆ›å»ºä»£ç†ã€‚&quot;)</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºReActä»£ç†</span><br><span class="line">    llm = ChatOpenAI(</span><br><span class="line">        model=&quot;qwen3-235b-a22b-thinking-2507&quot;,</span><br><span class="line">        api_key=&quot;sk-a8ef27c47ea84224ac6eed6d4bba1bab&quot;,</span><br><span class="line">        base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot; # ä¿®æ­£äº†æœ«å°¾å¤šä½™çš„ç©ºæ ¼</span><br><span class="line">    )</span><br><span class="line">    agent = create_react_agent(llm, tools)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    # å¼‚æ­¥è°ƒç”¨ä»£ç†æ¥è§£å†³æ•°å­¦é—®é¢˜</span><br><span class="line">    # ç¡®ä¿åœ¨å¼‚æ­¥å‡½æ•°å†…éƒ¨ä½¿ç”¨ await</span><br><span class="line">    math_response = await agent.ainvoke(</span><br><span class="line">        &#123;&quot;messages&quot;: [&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;what&#x27;s (3 + 5) x 12?&quot;&#125;]&#125;</span><br><span class="line">    )</span><br><span class="line">    print(&quot;\n--- æ•°å­¦é—®é¢˜å›ç­” ---&quot;)</span><br><span class="line">    print(math_response[&quot;messages&quot;][-1].content) # æ‰“å°æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆLLMçš„å›ç­”ï¼‰</span><br><span class="line"></span><br><span class="line">    # å¼‚æ­¥è°ƒç”¨ä»£ç†æ¥æŸ¥è¯¢å¤©æ°”</span><br><span class="line">    weather_response = await agent.ainvoke(</span><br><span class="line">        &#123;&quot;messages&quot;: [&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;what is the weather in nyc?&quot;&#125;]&#125;</span><br><span class="line">    )</span><br><span class="line">    print(&quot;\n--- å¤©æ°”é—®é¢˜å›ç­” ---&quot;)</span><br><span class="line">    print(weather_response[&quot;messages&quot;][-1].content) # æ‰“å°æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆLLMçš„å›ç­”ï¼‰</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># --- è¿™æ˜¯è„šæœ¬çš„å…¥å£ç‚¹ ---</span><br><span class="line"># ä½¿ç”¨ asyncio.run() æ¥è¿è¡Œä½ çš„ä¸»å¼‚æ­¥å‡½æ•°</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    asyncio.run(main())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://github.langchain.ac.cn/langgraph/agents/mcp/">ä½¿ç”¨
MCP - LangChain æ¡†æ¶</a></p>
<h3 id="æ¡†æ¶æµç¨‹">æ¡†æ¶æµç¨‹</h3>
<figure>
<img src="/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/langgraph%E5%AE%9E%E6%88%98mcp/image-20250801164905578.png" alt="image-20250801164905578">
<figcaption aria-hidden="true">image-20250801164905578</figcaption>
</figure>
<p>âœ… ä¸‰ä¸ªè§’è‰²ï¼ˆç³»ç»Ÿç»„ä»¶ï¼‰</p>
<table>
<colgroup>
<col style="width: 28%">
<col style="width: 72%">
</colgroup>
<thead>
<tr>
<th>è§’è‰²</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Client</strong></td>
<td>å‰ç«¯æˆ–ç”¨æˆ·ç•Œé¢ï¼Œå‘èµ·è¯·æ±‚</td>
</tr>
<tr>
<td><strong>Auth Provider</strong></td>
<td>è®¤è¯æœåŠ¡ï¼ˆå¦‚ OAuthã€JWT æä¾›è€…ï¼‰ï¼Œè´Ÿè´£ç™»å½•å’Œç­¾å‘ token</td>
</tr>
<tr>
<td><strong>LangGraph Backend</strong></td>
<td>åº”ç”¨çš„åç«¯æœåŠ¡ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘</td>
</tr>
<tr>
<td><strong>Secret Store</strong></td>
<td>å­˜æ”¾ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ tokenã€å¯†é’¥ç­‰ï¼‰</td>
</tr>
<tr>
<td><strong>MCP Server</strong></td>
<td>åç«¯å·¥å…·æœåŠ¡ï¼Œæä¾›å…·ä½“çš„å·¥å…·æˆ–èµ„æºæ¥å£</td>
</tr>
</tbody>
</table>
<p>âœ… æµç¨‹è¯¦è§£ï¼ˆ12æ­¥ï¼‰</p>
<p>ğŸ” é˜¶æ®µä¸€ï¼šç”¨æˆ·ç™»å½• &amp; è·å– Tokenï¼ˆ1~6ï¼‰</p>
<ol type="1">
<li><p><strong>ç”¨æˆ·ç™»å½•</strong><br>
Client æäº¤ç”¨æˆ·åå’Œå¯†ç ç»™ Auth Providerã€‚</p></li>
<li><p><strong>è¿”å› Token</strong><br>
Auth Provider éªŒè¯æˆåŠŸåï¼Œè¿”å›ä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼ˆtokenï¼‰ã€‚</p></li>
<li><p><strong>æºå¸¦ Token è¯·æ±‚</strong><br>
Client å°† token é™„åŠ åœ¨è¯·æ±‚å¤´ä¸­ï¼Œå‘ç»™ LangGraph Backendã€‚</p></li>
<li><p><strong>éªŒè¯ Token</strong><br>
LangGraph Backend ä½¿ç”¨ <code>@auth.authenticate</code> ä¸­é—´ä»¶éªŒè¯ token
æ˜¯å¦æœ‰æ•ˆã€‚</p></li>
<li><p><strong>è·å–ç”¨æˆ·ä¿¡æ¯</strong><br>
éªŒè¯é€šè¿‡åï¼ŒLangGraph Backend ä» Auth Provider
æ‹‰å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ã€‚</p></li>
<li><p><strong>ç¡®è®¤æœ‰æ•ˆæ€§</strong><br>
åç«¯ç¡®è®¤ç”¨æˆ·ä¿¡æ¯æ— è¯¯ï¼Œæµç¨‹ç»§ç»­ã€‚</p></li>
</ol>
<p>ğŸ”‘ é˜¶æ®µäºŒï¼šè·å–ç”¨æˆ·æƒé™ Tokenï¼ˆ6a~6bï¼‰</p>
<p>6a. <strong>æ‹‰å–ç”¨æˆ·æƒé™ Token</strong><br>
LangGraph Backend ä» Secret Store è·å–è¯¥ç”¨æˆ·å¯¹åº”çš„æƒé™ tokenï¼ˆå¯èƒ½æ˜¯ MCP
æ‰€éœ€çš„è®¿é—®å‡­è¯ï¼‰ã€‚</p>
<p>6b. <strong>è¿”å›æƒé™ Token</strong><br>
Secret Store è¿”å›è¯¥ tokenã€‚</p>
<p>ğŸ› ï¸ é˜¶æ®µä¸‰ï¼šè°ƒç”¨å·¥å…· &amp; è¿”å›ç»“æœï¼ˆ7~12ï¼‰</p>
<ol start="7" type="1">
<li><p><strong>æƒé™æ§åˆ¶æ£€æŸ¥</strong><br>
LangGraph Backend ä½¿ç”¨ <code>@auth.on.*</code>
æƒé™æ§åˆ¶é€»è¾‘ï¼Œç¡®è®¤ç”¨æˆ·æ˜¯å¦æœ‰æƒè°ƒç”¨è¯¥å·¥å…·ã€‚</p></li>
<li><p><strong>æ„å»º MCP Client</strong><br>
åç«¯ç”¨ç”¨æˆ·çš„æƒé™ token æ„å»ºä¸€ä¸ª MCP å®¢æˆ·ç«¯ã€‚</p></li>
<li><p><strong>è°ƒç”¨ MCP å·¥å…·</strong><br>
MCP Client å‘èµ·è¯·æ±‚ï¼Œè°ƒç”¨æŸä¸ªå…·ä½“å·¥å…·ï¼Œæºå¸¦
tokenï¼ˆé€šå¸¸æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼‰ã€‚</p></li>
<li><p><strong>MCP éªŒè¯å¹¶æ‰§è¡Œ</strong><br>
MCP Server éªŒè¯ token æ˜¯å¦æœ‰æ•ˆï¼Œç¡®è®¤æ— è¯¯åæ‰§è¡Œå·¥å…·é€»è¾‘ã€‚</p></li>
<li><p><strong>å·¥å…·è¿”å›ç»“æœ</strong><br>
MCP Server è¿”å›å·¥å…·æ‰§è¡Œç»“æœæˆ–èµ„æºæ•°æ®ã€‚</p></li>
<li><p><strong>è¿”å›ç»™å‰ç«¯</strong><br>
LangGraph Backend å°†ç»“æœè¿”å›ç»™ Clientï¼Œå®Œæˆæ•´ä¸ªé“¾è·¯ã€‚</p></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/mcp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/mcp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">MCP æœåŠ¡ç«¯å®æˆ˜</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-01T00:00:00+08:00">2025-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-02 12:01:56" itemprop="dateModified" datetime="2025-08-02T12:01:56+08:00">2025-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="é…ç½®ç¯å¢ƒ">é…ç½®ç¯å¢ƒ</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Create a new directory for our project</span><br><span class="line">uv init weather</span><br><span class="line">cd weather</span><br><span class="line"></span><br><span class="line"># Create virtual environment and activate it</span><br><span class="line">uv venv</span><br><span class="line">source .venv/bin/activate</span><br><span class="line"></span><br><span class="line"># Install dependencies</span><br><span class="line">uv add &quot;mcp[cli]&quot; httpx</span><br><span class="line"></span><br><span class="line"># Create our server file</span><br><span class="line">touch weather.py</span><br></pre></td></tr></table></figure>
<h3 id="mcp-studioæ ·ä¾‹">mcp studioæ ·ä¾‹</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from mcp.server.fastmcp import FastMCP</span><br><span class="line"></span><br><span class="line">mcp = FastMCP(&quot;Math&quot;)</span><br><span class="line"></span><br><span class="line">@mcp.tool()</span><br><span class="line">def add(a: int, b: int) -&gt; int:</span><br><span class="line">    &quot;&quot;&quot;Add two numbers&quot;&quot;&quot;</span><br><span class="line">    return a + b</span><br><span class="line"></span><br><span class="line">@mcp.tool()</span><br><span class="line">def multiply(a: int, b: int) -&gt; int:</span><br><span class="line">    &quot;&quot;&quot;Multiply two numbers&quot;&quot;&quot;</span><br><span class="line">    return a * b</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    mcp.run(transport=&quot;stdio&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="mcp-streamable-http-æ ·ä¾‹">mcp streamable-http æ ·ä¾‹</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from mcp.server.fastmcp import FastMCP</span><br><span class="line"></span><br><span class="line">mcp = FastMCP(&quot;Weather&quot;)</span><br><span class="line"></span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_weather(location: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;Get weather for location.&quot;&quot;&quot;</span><br><span class="line">    return &quot;It&#x27;s always sunny in New York&quot;</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    mcp.run(transport=&quot;streamable-http&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>
<p>mcpå¸‚åœº<a target="_blank" rel="noopener" href="https://www.modelscope.cn/mcp">MCP å¹¿åœº Â·
é­”æ­ç¤¾åŒº</a></p>
<p><strong>ä½¿ç”¨ uvï¼ˆæ¨èï¼‰</strong></p>
<p>å½“ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://docs.astral.sh/uv/"><code>uv</code></a>
æ—¶ä¸éœ€è¦ç‰¹å®šçš„å®‰è£…æ­¥éª¤ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://docs.astral.sh/uv/guides/tools/"><code>uvx</code></a>
ç›´æ¥è¿è¡Œ <em>mcp-server-fetch</em>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;mcpServers&quot;: &#123;</span><br><span class="line">  &quot;fetch&quot;: &#123;</span><br><span class="line">    &quot;command&quot;: &quot;uvx&quot;,</span><br><span class="line">    &quot;args&quot;: [&quot;mcp-server-fetch&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä½¿ç”¨ PIP</strong></p>
<p>æˆ–è€…ï¼Œæ‚¨å¯ä»¥é€šè¿‡ pip å®‰è£… <code>mcp-server-fetch</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mcp-server-fetch</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;mcpServers&quot;: &#123;</span><br><span class="line">  &quot;fetch&quot;: &#123;</span><br><span class="line">    &quot;command&quot;: &quot;python&quot;,</span><br><span class="line">    &quot;args&quot;: [&quot;-m&quot;, &quot;mcp_server_fetch&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¿œç¨‹æ‰˜ç®¡</strong></p>
<figure>
<img src="/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/mcp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E6%88%98/image-20250802120145192.png" alt="image-20250802120145192">
<figcaption aria-hidden="true">image-20250802120145192</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;mcpServers&quot;: &#123;</span><br><span class="line">    &quot;fetch&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;sse&quot;,</span><br><span class="line">      &quot;url&quot;: &quot;https://mcp.api-inference.modelscope.net/991cf46/sse&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/quickstart/server#core-mcp-concepts">æ„å»º
MCP æœåŠ¡å™¨ - æ¨¡å‹ä¸Šä¸‹æ–‡åè®® â€” Build an MCP Server - Model Context
Protocol</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/mcp%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/mcp%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">MCP å®¢æˆ·ç«¯å®æˆ˜</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-01 00:00:00 / ä¿®æ”¹æ—¶é—´ï¼š17:03:38" itemprop="dateCreated datePublished" datetime="2025-08-01T00:00:00+08:00">2025-08-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="é…ç½®ç¯å¢ƒ">é…ç½®ç¯å¢ƒ</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºé¡¹ç›®ç›®å½•</span><br><span class="line">uv init mcp-client</span><br><span class="line">cd mcp-client</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span><br><span class="line">uv venv</span><br><span class="line"></span><br><span class="line"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span><br><span class="line"># åœ¨ Windows ä¸Š:</span><br><span class="line">.venv\Scripts\activate</span><br><span class="line"># åœ¨ Unix æˆ– MacOS ä¸Š:</span><br><span class="line">source .venv/bin/activate</span><br><span class="line"></span><br><span class="line"># å®‰è£…æ‰€éœ€åŒ…</span><br><span class="line">uv add mcp anthropic python-dotenv</span><br><span class="line">#ä½¿ç”¨é•œåƒæºå®‰è£…</span><br><span class="line">uv add mcp anthropic python-dotenv --index-url https://pypi.tuna.tsinghua.edu.cn/simple/</span><br><span class="line"></span><br><span class="line"># åˆ é™¤æ ·æ¿æ–‡ä»¶</span><br><span class="line"># åœ¨ Windows ä¸Š:</span><br><span class="line">del main.py</span><br><span class="line"># åœ¨ Unix æˆ– MacOS ä¸Š:</span><br><span class="line">rm main.py</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºæˆ‘ä»¬çš„ä¸»æ–‡ä»¶</span><br><span class="line">touch client.py</span><br></pre></td></tr></table></figure>
<h3 id="è®¾ç½®-api-å¯†é’¥">è®¾ç½® API å¯†é’¥</h3>
<p>åˆ›å»ºä¸€ä¸ª <code>.env</code> æ–‡ä»¶æ¥å­˜å‚¨å®ƒï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Create .env file</span><br><span class="line">touch .env</span><br></pre></td></tr></table></figure>
<p>å°†æ‚¨çš„å¯†é’¥æ·»åŠ åˆ° <code>.env</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ANTHROPIC_API_KEY=&lt;your key here&gt;</span><br></pre></td></tr></table></figure>
<p>å°† <code>.env</code> æ·»åŠ åˆ°æ‚¨çš„ <code>.gitignore</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;.env&quot; &gt;&gt; .gitignore</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å°† <code>.env</code> æ–‡ä»¶åæ·»åŠ åˆ° <code>.gitignore</code>
æ–‡ä»¶ä¸­ï¼Œè¿™æ · Git å°±ä¼šå¿½ç•¥ <code>.env</code>
æ–‡ä»¶ï¼Œä¸ä¼šå°†å…¶çº³å…¥ç‰ˆæœ¬æ§åˆ¶ã€‚</p>
</blockquote>
<h3 id="åˆ›å»ºå®¢æˆ·ç«¯">åˆ›å»ºå®¢æˆ·ç«¯</h3>
<h4 id="åŸºæœ¬å®¢æˆ·ç«¯ç»“æ„">åŸºæœ¬å®¢æˆ·ç«¯ç»“æ„</h4>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„å¯¼å…¥å¹¶åˆ›å»ºåŸºæœ¬çš„å®¢æˆ·ç«¯ç±»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import asyncio</span><br><span class="line">from typing import Optional</span><br><span class="line">from contextlib import AsyncExitStack</span><br><span class="line"></span><br><span class="line">from mcp import ClientSession, StdioServerParameters</span><br><span class="line">from mcp.client.stdio import stdio_client</span><br><span class="line"></span><br><span class="line">from anthropic import Anthropic</span><br><span class="line">from dotenv import load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()  # ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡</span><br><span class="line"></span><br><span class="line">class MCPClient:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        # åˆå§‹åŒ–ä¼šè¯å’Œå®¢æˆ·ç«¯å¯¹è±¡</span><br><span class="line">        self.session: Optional[ClientSession] = None  # MCPå®¢æˆ·ç«¯ä¼šè¯</span><br><span class="line">        self.exit_stack = AsyncExitStack()  # å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨å †æ ˆï¼Œç”¨äºèµ„æºæ¸…ç†</span><br><span class="line">        self.anthropic = Anthropic()  # Anthropic AI å®¢æˆ·ç«¯</span><br><span class="line">        </span><br><span class="line">    # åç»­æ–¹æ³•å°†åœ¨è¿™é‡Œå®šä¹‰</span><br></pre></td></tr></table></figure>
<h4 id="æœåŠ¡å™¨è¿æ¥ç®¡ç†">æœåŠ¡å™¨è¿æ¥ç®¡ç†</h4>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ç°è¿æ¥åˆ° MCP æœåŠ¡å™¨çš„åŠŸèƒ½ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">async def connect_to_server(self, server_script_path: str):</span><br><span class="line">    &quot;&quot;&quot;è¿æ¥åˆ°MCPæœåŠ¡å™¨</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">        server_script_path: æœåŠ¡å™¨è„šæœ¬è·¯å¾„ (.py æˆ– .js æ–‡ä»¶)</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦ä¸ºPythonæ–‡ä»¶</span><br><span class="line">    is_python = server_script_path.endswith(&#x27;.py&#x27;)</span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦ä¸ºJavaScriptæ–‡ä»¶</span><br><span class="line">    is_js = server_script_path.endswith(&#x27;.js&#x27;)</span><br><span class="line">    </span><br><span class="line">    # å¦‚æœä¸æ˜¯Pythonæˆ–JavaScriptæ–‡ä»¶ï¼Œåˆ™æŠ›å‡ºé”™è¯¯</span><br><span class="line">    if not (is_python or is_js):</span><br><span class="line">        raise ValueError(&quot;æœåŠ¡å™¨è„šæœ¬å¿…é¡»æ˜¯ .py æˆ– .js æ–‡ä»¶&quot;)</span><br><span class="line"></span><br><span class="line">    # æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šæ‰§è¡Œå‘½ä»¤</span><br><span class="line">    command = &quot;python&quot; if is_python else &quot;node&quot;</span><br><span class="line">    </span><br><span class="line">    # åˆ›å»ºæœåŠ¡å™¨å‚æ•°å¯¹è±¡</span><br><span class="line">    server_params = StdioServerParameters(</span><br><span class="line">        command=command,           # æ‰§è¡Œå‘½ä»¤</span><br><span class="line">        args=[server_script_path], # è„šæœ¬è·¯å¾„ä½œä¸ºå‚æ•°</span><br><span class="line">        env=None                   # ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨é»˜è®¤ç¯å¢ƒï¼‰</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # å»ºç«‹stdioå®¢æˆ·ç«¯è¿æ¥å¹¶å°†å…¶æ·»åŠ åˆ°å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­</span><br><span class="line">    stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))</span><br><span class="line">    self.stdio, self.write = stdio_transport</span><br><span class="line">    </span><br><span class="line">    # åˆ›å»ºå®¢æˆ·ç«¯ä¼šè¯å¹¶å°†å…¶æ·»åŠ åˆ°å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­</span><br><span class="line">    self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))</span><br><span class="line"></span><br><span class="line">    # åˆå§‹åŒ–ä¼šè¯</span><br><span class="line">    await self.session.initialize()</span><br><span class="line"></span><br><span class="line">    # åˆ—å‡ºå¯ç”¨çš„å·¥å…·</span><br><span class="line">    response = await self.session.list_tools()</span><br><span class="line">    tools = response.tools</span><br><span class="line">    </span><br><span class="line">    # æ‰“å°è¿æ¥çš„æœåŠ¡å™¨æä¾›çš„å·¥å…·åˆ—è¡¨</span><br><span class="line">    print(&quot;\nå·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå¯ç”¨å·¥å…·:&quot;, [tool.name for tool in tools])</span><br></pre></td></tr></table></figure>
<h4 id="æŸ¥è¯¢å¤„ç†é€»è¾‘">æŸ¥è¯¢å¤„ç†é€»è¾‘</h4>
<p>ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ å¤„ç†æŸ¥è¯¢å’Œè°ƒç”¨å·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">async def process_query(self, query: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;ä½¿ç”¨Claudeå’Œå¯ç”¨å·¥å…·å¤„ç†æŸ¥è¯¢&quot;&quot;&quot;</span><br><span class="line">    # æ„å»ºæ¶ˆæ¯åˆ—è¡¨</span><br><span class="line">    messages = [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot;: &quot;user&quot;,      # ç”¨æˆ·è§’è‰²</span><br><span class="line">            &quot;content&quot;: query     # ç”¨æˆ·æŸ¥è¯¢å†…å®¹</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    # è·å–å¯ç”¨å·¥å…·åˆ—è¡¨</span><br><span class="line">    response = await self.session.list_tools()</span><br><span class="line">    available_tools = [&#123;</span><br><span class="line">        &quot;name&quot;: tool.name,           # å·¥å…·åç§°</span><br><span class="line">        &quot;description&quot;: tool.description,  # å·¥å…·æè¿°</span><br><span class="line">        &quot;input_schema&quot;: tool.inputSchema  # å·¥å…·è¾“å…¥æ¨¡å¼</span><br><span class="line">    &#125; for tool in response.tools]</span><br><span class="line"></span><br><span class="line">    # åˆå§‹Claude APIè°ƒç”¨</span><br><span class="line">    response = self.anthropic.messages.create(</span><br><span class="line">        model=&quot;qwen3-235b-a22b&quot;,  # ä½¿ç”¨çš„æ¨¡å‹</span><br><span class="line">        max_tokens=1000,                     # æœ€å¤§è¿”å›ä»¤ç‰Œæ•°</span><br><span class="line">        messages=messages,                   # æ¶ˆæ¯å†å²</span><br><span class="line">        tools=available_tools               # å¯ç”¨å·¥å…·</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    # å¤„ç†å“åº”å¹¶å¤„ç†å·¥å…·è°ƒç”¨</span><br><span class="line">    final_text = []  # å­˜å‚¨æœ€ç»ˆæ–‡æœ¬ç»“æœ</span><br><span class="line"></span><br><span class="line">    assistant_message_content = []  # å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯å†…å®¹</span><br><span class="line">    for content in response.content:  # éå†å“åº”å†…å®¹</span><br><span class="line">        if content.type == &#x27;text&#x27;:  # å¦‚æœæ˜¯æ–‡æœ¬å†…å®¹</span><br><span class="line">            final_text.append(content.text)  # æ·»åŠ åˆ°æœ€ç»ˆç»“æœ</span><br><span class="line">            assistant_message_content.append(content)  # æ·»åŠ åˆ°åŠ©æ‰‹æ¶ˆæ¯</span><br><span class="line">        elif content.type == &#x27;tool_use&#x27;:  # å¦‚æœæ˜¯å·¥å…·è°ƒç”¨</span><br><span class="line">            tool_name = content.name    # å·¥å…·åç§°</span><br><span class="line">            tool_args = content.input   # å·¥å…·å‚æ•°</span><br><span class="line"></span><br><span class="line">            # æ‰§è¡Œå·¥å…·è°ƒç”¨</span><br><span class="line">            result = await self.session.call_tool(tool_name, tool_args)</span><br><span class="line">            final_text.append(f&quot;[è°ƒç”¨å·¥å…· &#123;tool_name&#125;ï¼Œå‚æ•° &#123;tool_args&#125;]&quot;)</span><br><span class="line"></span><br><span class="line">            assistant_message_content.append(content)</span><br><span class="line">            # æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯åˆ°å†å²</span><br><span class="line">            messages.append(&#123;</span><br><span class="line">                &quot;role&quot;: &quot;assistant&quot;,</span><br><span class="line">                &quot;content&quot;: assistant_message_content</span><br><span class="line">            &#125;)</span><br><span class="line">            # æ·»åŠ å·¥å…·æ‰§è¡Œç»“æœåˆ°å†å²</span><br><span class="line">            messages.append(&#123;</span><br><span class="line">                &quot;role&quot;: &quot;user&quot;,</span><br><span class="line">                &quot;content&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;tool_result&quot;,      # å·¥å…·ç»“æœç±»å‹</span><br><span class="line">                        &quot;tool_use_id&quot;: content.id,  # å·¥å…·ä½¿ç”¨ID</span><br><span class="line">                        &quot;content&quot;: result.content   # å·¥å…·æ‰§è¡Œç»“æœ</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            # è·å–Claudeçš„ä¸‹ä¸€ä¸ªå“åº”</span><br><span class="line">            response = self.anthropic.messages.create(</span><br><span class="line">                model=&quot;qwen3-235b-a22b&quot;,</span><br><span class="line">                max_tokens=1000,</span><br><span class="line">                messages=messages,</span><br><span class="line">                tools=available_tools</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            # æ·»åŠ å“åº”æ–‡æœ¬åˆ°æœ€ç»ˆç»“æœ</span><br><span class="line">            final_text.append(response.content[0].text)</span><br><span class="line"></span><br><span class="line">    # è¿”å›è¿æ¥åçš„æœ€ç»ˆæ–‡æœ¬ç»“æœ</span><br><span class="line">    return &quot;\n&quot;.join(final_text)</span><br></pre></td></tr></table></figure>
<h4 id="äº¤äº’å¼èŠå¤©ç•Œé¢">äº¤äº’å¼èŠå¤©ç•Œé¢</h4>
<p>ç°åœ¨æˆ‘ä»¬å°†æ·»åŠ èŠå¤©å¾ªç¯å’Œæ¸…ç†åŠŸèƒ½ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">async def chat_loop(self):</span><br><span class="line">    &quot;&quot;&quot;è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯&quot;&quot;&quot;</span><br><span class="line">    print(&quot;\nMCPå®¢æˆ·ç«¯å·²å¯åŠ¨!&quot;)</span><br><span class="line">    print(&quot;è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–è¾“å…¥&#x27;quit&#x27;é€€å‡ºã€‚&quot;)</span><br><span class="line"></span><br><span class="line">    while True:  # æ— é™å¾ªç¯ï¼ŒæŒç»­æ¥æ”¶ç”¨æˆ·è¾“å…¥</span><br><span class="line">        try:</span><br><span class="line">            query = input(&quot;\né—®é¢˜: &quot;).strip()  # è·å–ç”¨æˆ·è¾“å…¥å¹¶å»é™¤é¦–å°¾ç©ºæ ¼</span><br><span class="line"></span><br><span class="line">            if query.lower() == &#x27;quit&#x27;:  # å¦‚æœç”¨æˆ·è¾“å…¥&#x27;quit&#x27;ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰</span><br><span class="line">                break  # é€€å‡ºå¾ªç¯</span><br><span class="line"></span><br><span class="line">            # å¤„ç†ç”¨æˆ·æŸ¥è¯¢å¹¶è·å–å“åº”</span><br><span class="line">            response = await self.process_query(query)</span><br><span class="line">            print(&quot;\n&quot; + response)  # æ‰“å°AIå“åº”ç»“æœ</span><br><span class="line"></span><br><span class="line">        except Exception as e:  # æ•è·æ‰€æœ‰å¼‚å¸¸</span><br><span class="line">            print(f&quot;\né”™è¯¯: &#123;str(e)&#125;&quot;)  # æ‰“å°é”™è¯¯ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">async def cleanup(self):</span><br><span class="line">    &quot;&quot;&quot;æ¸…ç†èµ„æº&quot;&quot;&quot;</span><br><span class="line">    await self.exit_stack.aclose()  # å¼‚æ­¥å…³é—­æ‰€æœ‰åœ¨exit_stackä¸­ç®¡ç†çš„èµ„æº</span><br></pre></td></tr></table></figure>
<h4 id="ä¸»å…¥å£ç‚¹">ä¸»å…¥å£ç‚¹</h4>
<p>æœ€åï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸»è¦çš„æ‰§è¡Œé€»è¾‘ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">async def main():</span><br><span class="line">    # æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°æ•°é‡ï¼Œå¦‚æœå°‘äº2ä¸ªåˆ™æ˜¾ç¤ºä½¿ç”¨è¯´æ˜</span><br><span class="line">    if len(sys.argv) &lt; 2:</span><br><span class="line">        print(&quot;ç”¨æ³•: python client.py &lt;æœåŠ¡å™¨è„šæœ¬è·¯å¾„&gt;&quot;)</span><br><span class="line">        sys.exit(1)  # é€€å‡ºç¨‹åºï¼Œè¿”å›é”™è¯¯ç 1</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºMCPå®¢æˆ·ç«¯å®ä¾‹</span><br><span class="line">    client = MCPClient()</span><br><span class="line">    try:</span><br><span class="line">        # è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œsys.argv[1]æ˜¯ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼ˆæœåŠ¡å™¨è„šæœ¬è·¯å¾„ï¼‰</span><br><span class="line">        await client.connect_to_server(sys.argv[1])</span><br><span class="line">        # å¯åŠ¨äº¤äº’å¼èŠå¤©å¾ªç¯</span><br><span class="line">        await client.chat_loop()</span><br><span class="line">    finally:</span><br><span class="line">        # ç¡®ä¿ç¨‹åºç»“æŸæ—¶æ¸…ç†èµ„æº</span><br><span class="line">        await client.cleanup()</span><br><span class="line"></span><br><span class="line"># ç¨‹åºå…¥å£ç‚¹</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    import sys  # å¯¼å…¥sysæ¨¡å—ç”¨äºå¤„ç†å‘½ä»¤è¡Œå‚æ•°</span><br><span class="line">    # è¿è¡Œå¼‚æ­¥ä¸»å‡½æ•°</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/08/01/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/mcp%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E6%88%98/QQ20250801-164738.png" alt="QQ20250801-164738">
<figcaption aria-hidden="true">QQ20250801-164738</figcaption>
</figure>
<h3 id="è¿è¡Œå®¢æˆ·ç«¯">è¿è¡Œå®¢æˆ·ç«¯</h3>
<p>è¦ä½¿æ‚¨çš„å®¢æˆ·ç«¯ä¸ä»»ä½• MCP æœåŠ¡å™¨è¿è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uv run client.py path/to/server.py # python server</span><br><span class="line">uv run client.py path/to/build/index.js # node server</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯å°†ï¼š</p>
<ol type="1">
<li>è¿æ¥åˆ°æŒ‡å®šæœåŠ¡å™¨</li>
<li>åˆ—å‡ºå¯ç”¨å·¥å…·</li>
<li>å¼€å§‹ä¸€ä¸ªäº¤äº’å¼èŠå¤©ä¼šè¯ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­ï¼š
<ul>
<li>è¾“å…¥æŸ¥è¯¢</li>
<li>æŸ¥çœ‹å·¥å…·æ‰§è¡Œæƒ…å†µ</li>
<li>ä» Claude è·å–å“åº”</li>
</ul></li>
</ol>
<h3 id="è¿ä½œæµç¨‹">è¿ä½œæµç¨‹</h3>
<p>å½“ä½ æäº¤æŸ¥è¯¢æ—¶ï¼š</p>
<ol type="1">
<li>å®¢æˆ·ç«¯ä»æœåŠ¡å™¨è·å–å¯ç”¨å·¥å…·åˆ—è¡¨</li>
<li>ä½ çš„æŸ¥è¯¢è¿åŒå·¥å…·æè¿°ä¸€èµ·å‘é€ç»™ Claude</li>
<li>Claude å†³å®šä½¿ç”¨å“ªäº›å·¥å…·ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</li>
<li>å®¢æˆ·ç«¯é€šè¿‡æœåŠ¡å™¨æ‰§è¡Œä»»ä½•è¯·æ±‚çš„å·¥å…·è°ƒç”¨</li>
<li>ç»“æœä¼šå‘é€å› Claude</li>
<li>Claude æä¾›è‡ªç„¶è¯­è¨€å“åº”</li>
<li>å“åº”æ˜¾ç¤ºç»™æ‚¨</li>
</ol>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/quickstart/client#main-entry-point">Build
an MCP Client - Model Context Protocol</a></p>
<h3 id="é€‚é…openaiç‰ˆæœ¬">é€‚é…openaiç‰ˆæœ¬</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">import asyncio</span><br><span class="line">import json</span><br><span class="line">import sys</span><br><span class="line">from typing import Optional</span><br><span class="line">from contextlib import AsyncExitStack</span><br><span class="line"></span><br><span class="line">from mcp import ClientSession, StdioServerParameters</span><br><span class="line">from mcp.client.stdio import stdio_client</span><br><span class="line"></span><br><span class="line">from openai import OpenAI</span><br><span class="line">from dotenv import load_dotenv</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">load_dotenv()  # ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡</span><br><span class="line"></span><br><span class="line">class MCPClient:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        # åˆå§‹åŒ–ä¼šè¯å’Œå®¢æˆ·ç«¯å¯¹è±¡</span><br><span class="line">        self.session: Optional[ClientSession] = None  # MCPå®¢æˆ·ç«¯ä¼šè¯</span><br><span class="line">        self.exit_stack = AsyncExitStack()  # å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨å †æ ˆï¼Œç”¨äºèµ„æºæ¸…ç†</span><br><span class="line">        self.anthropic = OpenAI(</span><br><span class="line">            api_key=os.getenv(&quot;DASHSCOPE_API_KEY&quot;),</span><br><span class="line">            base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><br><span class="line">        )  # ä½¿ç”¨OpenAIå…¼å®¹æ¨¡å¼è¿æ¥é€šä¹‰åƒé—®</span><br><span class="line">        </span><br><span class="line">    async def connect_to_server(self, server_script_path: str):</span><br><span class="line">        &quot;&quot;&quot;è¿æ¥åˆ°MCPæœåŠ¡å™¨</span><br><span class="line">        </span><br><span class="line">        Args:</span><br><span class="line">            server_script_path (str): æœåŠ¡å™¨è„šæœ¬è·¯å¾„ï¼Œæ”¯æŒ.pyæˆ–.jsæ–‡ä»¶</span><br><span class="line">        </span><br><span class="line">        Raises:</span><br><span class="line">            ValueError: å½“è„šæœ¬æ–‡ä»¶ä¸æ˜¯.pyæˆ–.jsæ ¼å¼æ—¶æŠ›å‡º</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # æ£€æŸ¥æ˜¯å¦ä¸ºPythonæ–‡ä»¶</span><br><span class="line">        is_python = server_script_path.endswith(&#x27;.py&#x27;)</span><br><span class="line">        # æ£€æŸ¥æ˜¯å¦ä¸ºJavaScriptæ–‡ä»¶</span><br><span class="line">        is_js = server_script_path.endswith(&#x27;.js&#x27;)</span><br><span class="line">        </span><br><span class="line">        # å¦‚æœä¸æ˜¯Pythonæˆ–JavaScriptæ–‡ä»¶ï¼Œåˆ™æŠ›å‡ºé”™è¯¯</span><br><span class="line">        if not (is_python or is_js):</span><br><span class="line">            raise ValueError(&quot;æœåŠ¡å™¨è„šæœ¬å¿…é¡»æ˜¯ .py æˆ– .js æ–‡ä»¶&quot;)</span><br><span class="line"></span><br><span class="line">        # æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šæ‰§è¡Œå‘½ä»¤</span><br><span class="line">        command = &quot;python&quot; if is_python else &quot;node&quot;</span><br><span class="line">        </span><br><span class="line">        # åˆ›å»ºæœåŠ¡å™¨å‚æ•°å¯¹è±¡</span><br><span class="line">        server_params = StdioServerParameters(</span><br><span class="line">            command=command,           # æ‰§è¡Œå‘½ä»¤</span><br><span class="line">            args=[server_script_path], # è„šæœ¬è·¯å¾„ä½œä¸ºå‚æ•°</span><br><span class="line">            env=None                   # ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨é»˜è®¤ç¯å¢ƒï¼‰</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        # å»ºç«‹stdioå®¢æˆ·ç«¯è¿æ¥å¹¶å°†å…¶æ·»åŠ åˆ°å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­</span><br><span class="line">        stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))</span><br><span class="line">        self.stdio, self.write = stdio_transport</span><br><span class="line">        </span><br><span class="line">        # åˆ›å»ºå®¢æˆ·ç«¯ä¼šè¯å¹¶å°†å…¶æ·»åŠ åˆ°å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­</span><br><span class="line">        self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))</span><br><span class="line"></span><br><span class="line">        # åˆå§‹åŒ–ä¼šè¯</span><br><span class="line">        await self.session.initialize()</span><br><span class="line"></span><br><span class="line">        # åˆ—å‡ºå¯ç”¨çš„å·¥å…·</span><br><span class="line">        response = await self.session.list_tools()</span><br><span class="line">        tools = response.tools</span><br><span class="line">        </span><br><span class="line">        # æ‰“å°è¿æ¥çš„æœåŠ¡å™¨æä¾›çš„å·¥å…·åˆ—è¡¨</span><br><span class="line">        print(&quot;\nå·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå¯ç”¨å·¥å…·:&quot;, [tool.name for tool in tools])</span><br><span class="line"></span><br><span class="line">    async def process_query(self, query: str) -&gt; str:</span><br><span class="line">        &quot;&quot;&quot;ä½¿ç”¨Qwenå’Œå¯ç”¨å·¥å…·å¤„ç†æŸ¥è¯¢&quot;&quot;&quot;</span><br><span class="line">        # æ„å»ºæ¶ˆæ¯åˆ—è¡¨</span><br><span class="line">        messages = [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;role&quot;: &quot;user&quot;,</span><br><span class="line">                &quot;content&quot;: query</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        # è·å–å¯ç”¨å·¥å…·åˆ—è¡¨å¹¶è½¬æ¢ä¸ºOpenAIæ ¼å¼</span><br><span class="line">        response = await self.session.list_tools()</span><br><span class="line">        available_tools = []</span><br><span class="line">        for tool in response.tools:</span><br><span class="line">            schema = tool.inputSchema</span><br><span class="line">            if isinstance(schema, str):</span><br><span class="line">                schema = json.loads(schema)</span><br><span class="line">            if isinstance(schema, dict) and &quot;properties&quot; in schema:</span><br><span class="line">                schema = &#123;&quot;type&quot;: &quot;object&quot;, **schema&#125;</span><br><span class="line"></span><br><span class="line">            available_tools.append(&#123;</span><br><span class="line">                &quot;type&quot;: &quot;function&quot;,</span><br><span class="line">                &quot;function&quot;: &#123;</span><br><span class="line">                    &quot;name&quot;: tool.name,</span><br><span class="line">                    &quot;description&quot;: tool.description,</span><br><span class="line">                    &quot;parameters&quot;: schema</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        # ç¬¬ä¸€æ¬¡è°ƒç”¨æ¨¡å‹</span><br><span class="line">        response = self.anthropic.chat.completions.create(</span><br><span class="line">            model=&quot;qwen3-235b-a22b&quot;,</span><br><span class="line">            max_tokens=1000,</span><br><span class="line">            messages=messages,</span><br><span class="line">            tools=available_tools,</span><br><span class="line">            extra_body=&#123;&quot;enable_thinking&quot;: False&#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        final_text = []</span><br><span class="line">        message = response.choices[0].message</span><br><span class="line"></span><br><span class="line">        # å¤„ç†æ–‡æœ¬å†…å®¹</span><br><span class="line">        if message.content:</span><br><span class="line">            final_text.append(message.content)</span><br><span class="line"></span><br><span class="line">        # å¤„ç†å·¥å…·è°ƒç”¨</span><br><span class="line">        if message.tool_calls:</span><br><span class="line">            for tool_call in message.tool_calls:</span><br><span class="line">                tool_name = tool_call.function.name</span><br><span class="line">                tool_args = json.loads(tool_call.function.arguments)</span><br><span class="line">                </span><br><span class="line">                # æ‰§è¡Œå·¥å…·è°ƒç”¨</span><br><span class="line">                result = await self.session.call_tool(tool_name, tool_args)</span><br><span class="line">                final_text.append(f&quot;[è°ƒç”¨å·¥å…· &#123;tool_name&#125;ï¼Œå‚æ•° &#123;tool_args&#125;]&quot;)</span><br><span class="line">                </span><br><span class="line">                # å¤„ç†å·¥å…·ç»“æœ</span><br><span class="line">                tool_result_content = &quot;&quot;</span><br><span class="line">                if result.content:</span><br><span class="line">                    for item in result.content:</span><br><span class="line">                        if hasattr(item, &#x27;type&#x27;) and item.type == &#x27;text&#x27;:</span><br><span class="line">                            tool_result_content += item.text</span><br><span class="line">                        else:</span><br><span class="line">                            tool_result_content += str(item)</span><br><span class="line"></span><br><span class="line">                # æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯åˆ°å†å²</span><br><span class="line">                messages.append(&#123;</span><br><span class="line">                    &quot;role&quot;: &quot;assistant&quot;,</span><br><span class="line">                    &quot;content&quot;: None,</span><br><span class="line">                    &quot;tool_calls&quot;: [tool_call]</span><br><span class="line">                &#125;)</span><br><span class="line">                </span><br><span class="line">                # æ·»åŠ å·¥å…·æ‰§è¡Œç»“æœåˆ°å†å²</span><br><span class="line">                messages.append(&#123;</span><br><span class="line">                    &quot;role&quot;: &quot;tool&quot;,</span><br><span class="line">                    &quot;tool_call_id&quot;: tool_call.id,</span><br><span class="line">                    &quot;content&quot;: tool_result_content</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                # å†æ¬¡è°ƒç”¨æ¨¡å‹</span><br><span class="line">                response = self.anthropic.chat.completions.create(</span><br><span class="line">                    model=&quot;qwen3-235b-a22b&quot;,</span><br><span class="line">                    max_tokens=1000,</span><br><span class="line">                    messages=messages,</span><br><span class="line">                    tools=available_tools,</span><br><span class="line">                    extra_body=&#123;&quot;enable_thinking&quot;: False&#125;</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                # å¤„ç†æœ€ç»ˆå“åº”</span><br><span class="line">                if response.choices and response.choices[0].message.content:</span><br><span class="line">                    final_text.append(response.choices[0].message.content)</span><br><span class="line"></span><br><span class="line">        return &quot;\n&quot;.join(final_text)</span><br><span class="line"></span><br><span class="line">    async def chat_loop(self):</span><br><span class="line">        &quot;&quot;&quot;è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯&quot;&quot;&quot;</span><br><span class="line">        print(&quot;\nMCPå®¢æˆ·ç«¯å·²å¯åŠ¨!&quot;)</span><br><span class="line">        print(&quot;è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–è¾“å…¥&#x27;quit&#x27;é€€å‡ºã€‚&quot;)</span><br><span class="line"></span><br><span class="line">        while True:  # æ— é™å¾ªç¯ï¼ŒæŒç»­æ¥æ”¶ç”¨æˆ·è¾“å…¥</span><br><span class="line">            try:</span><br><span class="line">                query = input(&quot;\né—®é¢˜: &quot;).strip()  # è·å–ç”¨æˆ·è¾“å…¥å¹¶å»é™¤é¦–å°¾ç©ºæ ¼</span><br><span class="line"></span><br><span class="line">                if query.lower() == &#x27;quit&#x27;:  # å¦‚æœç”¨æˆ·è¾“å…¥&#x27;quit&#x27;ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰</span><br><span class="line">                    break  # é€€å‡ºå¾ªç¯</span><br><span class="line"></span><br><span class="line">                # å¤„ç†ç”¨æˆ·æŸ¥è¯¢å¹¶è·å–å“åº”</span><br><span class="line">                response = await self.process_query(query)</span><br><span class="line">                print(&quot;\n&quot; + response)  # æ‰“å°AIå“åº”ç»“æœ</span><br><span class="line"></span><br><span class="line">            except Exception as e:  # æ•è·æ‰€æœ‰å¼‚å¸¸</span><br><span class="line">                print(f&quot;\né”™è¯¯: &#123;str(e)&#125;&quot;)  # æ‰“å°é”™è¯¯ä¿¡æ¯</span><br><span class="line">                import traceback</span><br><span class="line">                traceback.print_exc()  # æ‰“å°è¯¦ç»†é”™è¯¯ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">    async def cleanup(self):</span><br><span class="line">        &quot;&quot;&quot;æ¸…ç†èµ„æº&quot;&quot;&quot;</span><br><span class="line">        await self.exit_stack.aclose()  # å¼‚æ­¥å…³é—­æ‰€æœ‰åœ¨exit_stackä¸­ç®¡ç†çš„èµ„æº</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    # æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°æ•°é‡ï¼Œå¦‚æœå°‘äº2ä¸ªåˆ™æ˜¾ç¤ºä½¿ç”¨è¯´æ˜</span><br><span class="line">    if len(sys.argv) &lt; 2:</span><br><span class="line">        print(&quot;ç”¨æ³•: python client.py &lt;æœåŠ¡å™¨è„šæœ¬è·¯å¾„&gt;&quot;)</span><br><span class="line">        sys.exit(1)  # é€€å‡ºç¨‹åºï¼Œè¿”å›é”™è¯¯ç 1</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºMCPå®¢æˆ·ç«¯å®ä¾‹</span><br><span class="line">    client = MCPClient()</span><br><span class="line">    try:</span><br><span class="line">        # è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œsys.argv[1]æ˜¯ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼ˆæœåŠ¡å™¨è„šæœ¬è·¯å¾„ï¼‰</span><br><span class="line">        await client.connect_to_server(sys.argv[1])</span><br><span class="line">        # å¯åŠ¨äº¤äº’å¼èŠå¤©å¾ªç¯</span><br><span class="line">        await client.chat_loop()</span><br><span class="line">    finally:</span><br><span class="line">        # ç¡®ä¿ç¨‹åºç»“æŸæ—¶æ¸…ç†èµ„æº</span><br><span class="line">        await client.cleanup()</span><br><span class="line"></span><br><span class="line"># ç¨‹åºå…¥å£ç‚¹</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    # è¿è¡Œå¼‚æ­¥ä¸»å‡½æ•°</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>
<h3 id="openaiå’Œclaudeåœ¨å·¥å…·è°ƒç”¨çš„å·®å¼‚">openaiå’Œclaudeåœ¨å·¥å…·è°ƒç”¨çš„å·®å¼‚</h3>
<ol type="1">
<li><strong>å·¥å…·æ ¼å¼è½¬æ¢ä¿®å¤</strong></li>
</ol>
<p><strong>é—®é¢˜</strong>ï¼šMCPå·¥å…·æ ¼å¼ä¸OpenAI APIä¸å…¼å®¹
<strong>ä¿®å¤</strong>ï¼š <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸé”™è¯¯æ ¼å¼</span></span><br><span class="line">available_tools = [&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: tool.name,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: tool.description,</span><br><span class="line">    <span class="string">&quot;input_schema&quot;</span>: tool.inputSchema</span><br><span class="line">&#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®å¤åæ ¼å¼ï¼ˆç¬¦åˆOpenAIè§„èŒƒï¼‰</span></span><br><span class="line">available_tools = [&#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">    <span class="string">&quot;function&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: tool.name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: tool.description,</span><br><span class="line">        <span class="string">&quot;parameters&quot;</span>: schema  <span class="comment"># æ­£ç¡®çš„JSON Schemaæ ¼å¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure></p>
<ol start="2" type="1">
<li><strong>APIå“åº”å¤„ç†ä¿®å¤</strong></li>
</ol>
<p><strong>é—®é¢˜</strong>ï¼šé”™è¯¯è®¿é—®äº†OpenAIå“åº”å¯¹è±¡çš„å±æ€§
<strong>ä¿®å¤</strong>ï¼š <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸé”™è¯¯ä»£ç </span></span><br><span class="line"><span class="keyword">for</span> content <span class="keyword">in</span> response.content:  <span class="comment"># âŒ responseæ²¡æœ‰contentå±æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®å¤åä»£ç </span></span><br><span class="line">message = response.choices[<span class="number">0</span>].message  <span class="comment"># âœ… æ­£ç¡®çš„è®¿é—®è·¯å¾„</span></span><br><span class="line"><span class="keyword">if</span> message.content:</span><br><span class="line">    final_text.append(message.content)</span><br><span class="line"><span class="keyword">if</span> message.tool_calls:</span><br><span class="line">    <span class="keyword">for</span> tool_call <span class="keyword">in</span> message.tool_calls:</span><br><span class="line">        <span class="comment"># å¤„ç†å·¥å…·è°ƒç”¨</span></span><br></pre></td></tr></table></figure></p>
<ol start="3" type="1">
<li><strong>å·¥å…·è°ƒç”¨ç»“æœå¤„ç†ä¿®å¤</strong></li>
</ol>
<p><strong>é—®é¢˜</strong>ï¼šé”™è¯¯å¤„ç†MCPå·¥å…·è°ƒç”¨è¿”å›çš„ç»“æœç»“æ„
<strong>ä¿®å¤</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸé”™è¯¯ä»£ç </span></span><br><span class="line"><span class="string">&quot;content&quot;</span>: result.content  <span class="comment"># âŒ å¯èƒ½åŒ…å«å¤æ‚å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®å¤åä»£ç </span></span><br><span class="line">tool_result_content = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> result.content:</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> result.content:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(item, <span class="string">&#x27;type&#x27;</span>) <span class="keyword">and</span> item.<span class="built_in">type</span> == <span class="string">&#x27;text&#x27;</span>:</span><br><span class="line">            tool_result_content += item.text</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tool_result_content += <span class="built_in">str</span>(item)</span><br></pre></td></tr></table></figure>
<ol start="4" type="1">
<li><strong>æ¶ˆæ¯å†å²æ„å»ºä¿®å¤</strong></li>
</ol>
<p><strong>é—®é¢˜</strong>ï¼šå·¥å…·è°ƒç”¨åæ¶ˆæ¯å†å²æ ¼å¼ä¸æ­£ç¡®
<strong>ä¿®å¤</strong>ï¼š <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­£ç¡®çš„æ¶ˆæ¯å†å²æ ¼å¼</span></span><br><span class="line">messages.append(&#123;</span><br><span class="line">    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">    <span class="string">&quot;content&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&quot;tool_calls&quot;</span>: [tool_call]</span><br><span class="line">&#125;)</span><br><span class="line">messages.append(&#123;</span><br><span class="line">    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tool_call_id&quot;</span>: tool_call.<span class="built_in">id</span>,</span><br><span class="line">    <span class="string">&quot;content&quot;</span>: tool_result_content</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<ol start="5" type="1">
<li><strong>JSON Schemaå…¼å®¹æ€§å¤„ç†</strong></li>
</ol>
<p><strong>é—®é¢˜</strong>ï¼šMCPè¿”å›çš„schemaå¯èƒ½ç¼ºå°‘å¿…è¦çš„æ ¹ç±»å‹å®šä¹‰
<strong>ä¿®å¤</strong>ï¼š <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">schema = tool.inputSchema</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(schema, <span class="built_in">str</span>):</span><br><span class="line">    schema = json.loads(schema)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(schema, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&quot;properties&quot;</span> <span class="keyword">in</span> schema:</span><br><span class="line">    schema = &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>, **schema&#125;  <span class="comment"># ç¡®ä¿æœ‰æ ¹ç±»å‹</span></span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/31/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/%E5%82%A8%E5%AD%98%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93Chroma/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/31/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/%E5%82%A8%E5%AD%98%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93Chroma/" class="post-title-link" itemprop="url">å‚¨å­˜å‘é‡æ•°æ®åº“Chroma</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-31 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-31T00:00:00+08:00">2025-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-19 17:16:04" itemprop="dateModified" datetime="2025-08-19T17:16:04+08:00">2025-08-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/agent%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">agentå®æˆ˜</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="chromaæ˜¯ä»€ä¹ˆ">Chromaæ˜¯ä»€ä¹ˆ</h3>
<p>Chromaï¼ˆé€šå¸¸æŒ‡ <strong>ChromaDB</strong>ï¼‰æ˜¯ä¸€æ¬¾ <strong>å¼€æºã€AI
åŸç”Ÿçš„å‘é‡æ•°æ®åº“</strong>ï¼Œä¸“ä¸ºå­˜å‚¨å’Œæ£€ç´¢ <strong>é«˜ç»´åµŒå…¥å‘é‡</strong>
è€Œè®¾è®¡ï¼Œç›®æ ‡æ˜¯è®©å¼€å‘è€… <strong>5 åˆ†é’Ÿå†…åœ¨æœ¬åœ°è·‘èµ·ä¸€ä¸ªè¯­ä¹‰æœç´¢æˆ– RAG
ç³»ç»Ÿ</strong>ã€‚</p>
<p><strong>æç®€å®‰è£…</strong>ï¼š<code>pip install chromadb</code></p>
<p><strong>åŒè¿è¡Œæ¨¡å¼</strong>ï¼š</p>
<ul>
<li><strong>å†…å­˜æ¨¡å¼</strong>ï¼šè°ƒè¯•/åŸå‹éšæ„é‡å¯ï¼›</li>
<li><strong>æŒä¹…åŒ–æ¨¡å¼</strong>ï¼šæŒ‡å®š <code>persist_directory</code>
å³å¯è½ç›˜ï¼Œç”Ÿäº§ä¹Ÿä¸æ€•ä¸¢æ•°æ®ã€‚</li>
</ul>
<p><strong>HNSW ç´¢å¼•</strong>ï¼šç™¾ä¸‡çº§å‘é‡ä¹Ÿèƒ½ <strong>æ¯«ç§’çº§</strong>
å“åº”ã€‚</p>
<h3 id="ä½¿ç”¨chromaå­˜å‚¨">ä½¿ç”¨chromaå­˜å‚¨</h3>
<h4 id="æ–‡æ¡£åˆ†å—">æ–‡æ¡£åˆ†å—</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from langchain.document_loaders import PyPDFLoader</span><br><span class="line">from langchain.text_splitter import RecursiveCharacterTextSplitter</span><br><span class="line"></span><br><span class="line">loader = PyPDFLoader(&quot;input/å¥åº·æ¡£æ¡ˆ.pdf&quot;)</span><br><span class="line">docs = loader.load()</span><br><span class="line">#é€’å½’åˆ†å—</span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter(chunk_siz</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰embeddingæ¨¡å‹ä¸chroma">å®šä¹‰embeddingæ¨¡å‹ä¸chroma</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from langchain.vectorstores import Chroma</span><br><span class="line">from langchain_openai import OpenAIEmbeddings</span><br><span class="line">embedding = OpenAIEmbeddings(</span><br><span class="line">api_key=&quot;sk-&quot;, </span><br><span class="line">base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;,</span><br><span class="line">model=&quot;text-embedding-v4&quot;,</span><br><span class="line">check_embedding_ctx_length = False,</span><br><span class="line">dimensions=1536</span><br><span class="line">)</span><br><span class="line"># ä½¿ç”¨ Chroma å‘é‡æ•°æ®åº“å­˜å‚¨æ–‡æ¡£ chunks</span><br><span class="line">vectorstore = Chroma.from_documents(</span><br><span class="line">    documents=chunks,           # è¦å­˜å‚¨çš„æ–‡æ¡£chunksåˆ—è¡¨ï¼ˆå·²å¤„ç†å¥½çš„æ–‡æœ¬ç‰‡æ®µï¼‰</span><br><span class="line">    embedding=embedding,        </span><br><span class="line">    persist_directory=&quot;chromaDB&quot;,  # å‘é‡æ•°æ®åº“çš„æŒä¹…åŒ–å­˜å‚¨ç›®å½•è·¯å¾„</span><br><span class="line">    collection_name=&quot;demo001&quot;   # é›†åˆåç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„æ–‡æ¡£é›†åˆ</span><br><span class="line">)</span><br><span class="line">vectorstore.persist()</span><br></pre></td></tr></table></figure>
<h4 id="æ£€ç´¢">æ£€ç´¢</h4>
<p>è¿™é‡Œé‡‡å–ç›´æ¥æ£€ç´¢è¿›è¡Œæµ‹è¯•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">results = vectorstore.similarity_search(</span><br><span class="line">    &quot;å¼ ä¸‰ä¹çš„åŸºæœ¬ä¿¡æ¯æ˜¯ä»€ä¹ˆ&quot;,</span><br><span class="line">    k=2,</span><br><span class="line">    collection_name=&quot;demo001&quot;  # æŒ‡å®šæ£€ç´¢çš„é›†åˆ</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="é‡æ–°åŠ è½½">é‡æ–°åŠ è½½</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># é‡æ–°åŠ è½½å·²å­˜åœ¨çš„ Chroma æ•°æ®åº“</span><br><span class="line">vectorstore = Chroma(</span><br><span class="line">    persist_directory=&quot;./chroma_db&quot;,</span><br><span class="line">    embedding_function=embedding</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">retriever = vectorstore.as_retriever()</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/vectorstores/chroma/#add-items-to-vector-store">Chroma
| ğŸ¦œï¸ğŸ”— LangChain â€” Chroma | ğŸ¦œï¸ğŸ”— LangChain</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/Plan-and-Execute%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/Plan-and-Execute%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Plan-and-Executeæ¨¡å¼</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-27 10:01:58" itemprop="dateModified" datetime="2025-08-27T10:01:58+08:00">2025-08-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/agent%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">agentå®æˆ˜</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä»€ä¹ˆæ˜¯plan-and-executeæ¨¡å¼">ä»€ä¹ˆæ˜¯Plan-and-Executeæ¨¡å¼</h3>
<p>Plan-and-Executeæ¶æ„æµç¨‹ï¼šå…ˆæŒ‡å®šè®¡åˆ’ï¼Œåäº¤ç»™æ‰§è¡Œagentï¼Œæ‰§è¡Œåäº¤ç»™replanèŠ‚ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°è®¡åˆ’ï¼Œè‹¥è¦æ›´æ–°è®¡åˆ’è¿”å›è¿”å›æ›´æ–°åçš„æœºä¼šï¼Œå¦åˆ™è¿”å›responseï¼Œç„¶åè·¯ç”±åˆ¤æ–­æ˜¯æ‰§è¡Œagentè¿˜æ˜¯response</p>
<p>ä¸ReActæ¨¡å¼ä¸åŒçš„æ˜¯ï¼ŒReActåªåšä¸€æ¬¡è§„åˆ’ï¼Œè€ŒPlan-and-Executeæ¨¡å¼æ ¸å¿ƒæ€æƒ³æ˜¯é¦–å…ˆåˆ¶å®šä¸€ä¸ªå¤šæ­¥éª¤è®¡åˆ’ï¼Œç„¶åé€é¡¹æ‰§è¡Œè¯¥è®¡åˆ’ã€‚å®Œæˆç‰¹å®šä»»åŠ¡åï¼Œå¯ä»¥é‡æ–°å®¡è§†è®¡åˆ’å¹¶è¿›è¡Œé€‚å½“ä¿®æ”¹ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œç”¨æˆ·åœ¨é—®ä¸€ä¸ªé—®é¢˜åï¼Œagentäº§ç”Ÿä¸€ä»½ä»»åŠ¡æ¸…å•ï¼Œé€‰å–ç¬¬ä¸€ä»½ä»»åŠ¡å¼€å§‹æ‰§è¡Œï¼Œæ‰§è¡Œåçš„ç»“æœç»“åˆä»»åŠ¡æ¸…å•ï¼Œæ‰§è¡Œreplanï¼Œç»“åˆæ–°çš„ä¿¡æ¯ï¼Œæ›´æ”¹ä»»åŠ¡æ¸…å•çš„å†…å®¹ï¼Œè®©åç»­å¤§æ¨¡å‹æ›´å¥½åœ°æ‰§è¡Œï¼Œå¹¶å»é™¤å·²ç»å®Œæˆçš„ä»»åŠ¡</p>
<p>å®é™…ç”Ÿäº§ä¸­ï¼Œåº”è¯¥åœ¨plannerä¹‹å‰å†è¿›è¡Œä¸€æ¬¡åˆ¤æ–­ï¼Œå¦‚æœé—®é¢˜è¿‡äºç®€å•ï¼Œä¸éœ€è¦è¿›è¡ŒPlan-and-Executeæ¨¡å¼</p>
<h3 id="å®æˆ˜">å®æˆ˜</h3>
<h4 id="å®‰è£…åŒ…">å®‰è£…åŒ…</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --quiet -U langgraph langchain-community langchain-openai tavily-python</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰ç½‘ç»œæœç´¢å·¥å…·ä¸æ‰§è¡Œagent">å®šä¹‰ç½‘ç»œæœç´¢å·¥å…·ä¸æ‰§è¡Œagent</h4>
<p>åœ¨äº§ç”Ÿplanåï¼Œè¦æœ‰ä¸€ä¸ªagentå¯¹ä»»åŠ¡æ¸…å•è¿›è¡Œæ‰§è¡Œï¼Œè¿™é‡Œä»¥ä¸€ä¸ªReActçš„ç½‘ç»œæœç´¢agentä¸ºä¾‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#å®šä¹‰å·¥å…·</span><br><span class="line">from langchain_tavily import TavilySearch</span><br><span class="line">tools = [TavilySearch(max_results=3)]</span><br><span class="line"></span><br><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line"></span><br><span class="line">from langgraph.prebuilt import create_react_agent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    model=&quot;qwen3-235b-a22b-thinking-2507&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;,</span><br><span class="line">    base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><br><span class="line">)</span><br><span class="line">prompt = &quot;You are a helpful assistant.&quot;</span><br><span class="line">agent_executor = create_react_agent(llm, tools, prompt=prompt)</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•åŠŸèƒ½</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent_executor.invoke(&#123;&quot;messages&quot;: [(&quot;user&quot;, &quot;ä»Šå¤©æ˜¯å‡ æœˆå‡ æ—¥&quot;)]&#125;)</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰æ‰§è¡ŒèŠ‚ç‚¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from typing import Literal</span><br><span class="line">from langgraph.graph import END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def execute_step(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;æ‰§è¡Œè®¡åˆ’ä¸­çš„æ­¥éª¤&quot;&quot;&quot;</span><br><span class="line">    plan = state[&quot;plan&quot;]</span><br><span class="line">    # å°†è®¡åˆ’æ ¼å¼åŒ–ä¸ºå¸¦ç¼–å·çš„å­—ç¬¦ä¸²</span><br><span class="line">    plan_str = &quot;\n&quot;.join(f&quot;&#123;i + 1&#125;. &#123;step&#125;&quot; for i, step in enumerate(plan))</span><br><span class="line">    task = plan[0]  # è·å–ç¬¬ä¸€ä¸ªå¾…æ‰§è¡Œçš„ä»»åŠ¡</span><br><span class="line">    task_formatted = f&quot;&quot;&quot;å¯¹äºä»¥ä¸‹è®¡åˆ’:</span><br><span class="line">&#123;plan_str&#125;\n\nä½ è¢«åˆ†é…æ‰§è¡Œç¬¬ &#123;1&#125; æ­¥, &#123;task&#125;ã€‚&quot;&quot;&quot;</span><br><span class="line">    # è°ƒç”¨ä»£ç†æ‰§è¡Œå™¨æ¥æ‰§è¡Œä»»åŠ¡</span><br><span class="line">    agent_response = await agent_executor.ainvoke(</span><br><span class="line">        &#123;&quot;messages&quot;: [(&quot;user&quot;, task_formatted)]&#125;</span><br><span class="line">    )</span><br><span class="line">    # è¿”å›æ‰§è¡Œç»“æœï¼Œæ·»åŠ åˆ°å†å²æ­¥éª¤ä¸­</span><br><span class="line">    return &#123;</span><br><span class="line">        &quot;past_steps&quot;: [(task, agent_response[&quot;messages&quot;][-1].content)],</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>create_react_agent æ˜¯ LangGraph æä¾›çš„ä¸€ä¸ªé¢„æ„å»ºå‡½æ•°ï¼Œä½äº
langgraph.prebuilt æ¨¡å—ä¸­ï¼Œç”¨äºå¿«é€Ÿåˆ›å»ºä¸€ä¸ªåŸºäº ReActï¼ˆReasoning +
Actingï¼‰æ¶æ„çš„æ™ºèƒ½ä»£ç†ã€‚</p>
</blockquote>
<blockquote>
<p>langgraphé¢„è®¾çš„å…¶ä»–å¸¸ç”¨ç»„ä»¶å¦‚ä¸‹</p>
<p><strong>ToolNode</strong></p>
<p>åŠŸèƒ½ï¼šæŠŠ LangChain å·¥å…·ï¼ˆBaseToolï¼‰å°è£…æˆä¸€ä¸ªå›¾èŠ‚ç‚¹ï¼Œè´Ÿè´£ï¼š</p>
<ul>
<li><p>æ¥æ”¶ LLM ç”Ÿæˆçš„å·¥å…·è°ƒç”¨è¯·æ±‚</p></li>
<li><p>çœŸæ­£æ‰§è¡Œå·¥å…·</p></li>
<li><p>æŠŠç»“æœè¿”å›ç»™å›¾</p></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.prebuilt import ToolNode</span><br><span class="line"></span><br><span class="line">tool_node = ToolNode(tools=[search, calculator])</span><br></pre></td></tr></table></figure>
<p><strong>tools_condition</strong></p>
<p>åŠŸèƒ½ï¼šåˆ¤æ–­ LLM æ˜¯å¦è¦ç»§ç»­è°ƒç”¨å·¥å…·çš„â€œè·¯ç”±å‡½æ•°â€ã€‚</p>
<p>åœ¨ ReAct å›¾é‡Œé€šå¸¸æ”¾åœ¨èŠ‚ç‚¹ä¹‹é—´çš„ æ¡ä»¶è¾¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.prebuilt import tools_condition</span><br><span class="line"></span><br><span class="line">graph.add_conditional_edges(&quot;agent&quot;, tools_condition, &#123;</span><br><span class="line"></span><br><span class="line">  &quot;tools&quot;: &quot;tool_node&quot;,    # éœ€è¦å·¥å…· â†’ å» ToolNode</span><br><span class="line"></span><br><span class="line">  &quot;**__end__**&quot;: END       # ä¸éœ€è¦ â†’ ç»“æŸ</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="å®šä¹‰çŠ¶æ€">å®šä¹‰çŠ¶æ€</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import operator</span><br><span class="line">from typing import Annotated, List, Tuple</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class PlanExecute(TypedDict):</span><br><span class="line">    input: str</span><br><span class="line">    plan: List[str]</span><br><span class="line">    past_steps: Annotated[List[Tuple], operator.add]</span><br><span class="line">    response: str</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from pydantic import BaseModel, Field</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Plan(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;æœªæ¥è¦éµå¾ªçš„è®¡åˆ’&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    steps: List[str] = Field(</span><br><span class="line">        description=&quot;éœ€è¦éµå¾ªçš„ä¸åŒæ­¥éª¤ï¼Œåº”è¯¥æŒ‰æ’åºé¡ºåºæ’åˆ—&quot;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰æ¨¡å‹">å®šä¹‰æ¨¡å‹</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from langchain_community.chat_models import ChatTongyi</span><br><span class="line">model=ChatTongyi(</span><br><span class="line"> model=&quot;qwen-plus-2025-07-14&quot;,</span><br><span class="line"> api_key=&quot;sk-&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰åˆå§‹è®¡åˆ’èŠ‚ç‚¹">å®šä¹‰åˆå§‹è®¡åˆ’èŠ‚ç‚¹</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.prompts import ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">planner_prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (</span><br><span class="line">            &quot;system&quot;,</span><br><span class="line">            &quot;&quot;&quot;å¯¹äºç»™å®šçš„ç›®æ ‡ï¼Œåˆ¶å®šä¸€ä¸ªç®€å•çš„é€æ­¥è®¡åˆ’ã€‚\</span><br><span class="line">è¿™ä¸ªè®¡åˆ’åº”è¯¥åŒ…å«ç‹¬ç«‹çš„ä»»åŠ¡ï¼Œå¦‚æœæ­£ç¡®æ‰§è¡Œè¿™äº›ä»»åŠ¡å°†å¾—åˆ°æ­£ç¡®çš„ç­”æ¡ˆã€‚ä¸è¦æ·»åŠ ä»»ä½•å¤šä½™çš„æ­¥éª¤ã€‚\</span><br><span class="line">æœ€åä¸€æ­¥çš„ç»“æœåº”è¯¥æ˜¯æœ€ç»ˆç­”æ¡ˆã€‚ç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½åŒ…å«æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯â€”â€”ä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤ã€‚&quot;&quot;&quot;,</span><br><span class="line">        ),</span><br><span class="line">        (&quot;placeholder&quot;, &quot;&#123;messages&#125;&quot;),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">planner = planner_prompt | model.with_structured_output(Plan)</span><br><span class="line"></span><br><span class="line">async def plan_step(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;åˆ¶å®šåˆå§‹è®¡åˆ’æ­¥éª¤&quot;&quot;&quot;</span><br><span class="line">    # ä½¿ç”¨è§„åˆ’å™¨ä¸ºç”¨æˆ·è¾“å…¥åˆ¶å®šè®¡åˆ’</span><br><span class="line">    plan = await planner.ainvoke(&#123;&quot;messages&quot;: [(&quot;user&quot;, state[&quot;input&quot;])]&#125;)</span><br><span class="line">    </span><br><span class="line">    return &#123;&quot;plan&quot;: plan.steps&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰å†è®¡åˆ’èŠ‚ç‚¹">å®šä¹‰å†è®¡åˆ’èŠ‚ç‚¹</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">from typing import Union</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Response(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å¯¹ç”¨æˆ·çš„å“åº”&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    response: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Act(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;è¦æ‰§è¡Œçš„åŠ¨ä½œ&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    action: Union[Response, Plan] = Field(</span><br><span class="line">        description=&quot;è¦æ‰§è¡Œçš„åŠ¨ä½œã€‚å¦‚æœä½ æƒ³å“åº”ç”¨æˆ·ï¼Œä½¿ç”¨ Responseã€‚&quot;</span><br><span class="line">        &quot;å¦‚æœä½ éœ€è¦è¿›ä¸€æ­¥ä½¿ç”¨å·¥å…·æ¥è·å–ç­”æ¡ˆï¼Œä½¿ç”¨ Planã€‚&quot;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">replanner_prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    &quot;&quot;&quot;å¯¹äºç»™å®šçš„ç›®æ ‡ï¼Œåˆ¶å®šä¸€ä¸ªç®€å•çš„é€æ­¥è®¡åˆ’ã€‚\</span><br><span class="line">è¿™ä¸ª    è®¡åˆ’åº”è¯¥åŒ…å«ç‹¬ç«‹çš„ä»»åŠ¡ï¼Œå¦‚æœæ­£ç¡®æ‰§è¡Œè¿™äº›ä»»åŠ¡å°†å¾—åˆ°æ­£ç¡®çš„ç­”æ¡ˆã€‚ä¸è¦æ·»åŠ ä»»ä½•å¤šä½™çš„æ­¥éª¤ã€‚\</span><br><span class="line">æœ€åä¸€æ­¥çš„ç»“æœåº”è¯¥æ˜¯æœ€ç»ˆç­”æ¡ˆã€‚ç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½åŒ…å«æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯â€”â€”ä¸è¦è·³è¿‡ä»»ä½•æ­¥éª¤ã€‚</span><br><span class="line"></span><br><span class="line">ä½ çš„ç›®æ ‡æ˜¯ï¼š</span><br><span class="line">&#123;input&#125;</span><br><span class="line"></span><br><span class="line">ä½ çš„åŸå§‹è®¡åˆ’æ˜¯ï¼š</span><br><span class="line">&#123;plan&#125;</span><br><span class="line"></span><br><span class="line">ä½ ç›®å‰å·²ç»å®Œæˆäº†ä»¥ä¸‹æ­¥éª¤ï¼š</span><br><span class="line">&#123;past_steps&#125;</span><br><span class="line"></span><br><span class="line">ç›¸åº”åœ°æ›´æ–°ä½ çš„è®¡åˆ’ã€‚å¦‚æœä¸éœ€è¦æ›´å¤šæ­¥éª¤å¹¶ä¸”å¯ä»¥è¿”å›ç»™ç”¨æˆ·ï¼Œåˆ™ç›´æ¥å“åº”ã€‚å¦åˆ™ï¼Œå¡«å†™è®¡åˆ’ã€‚åªæ·»åŠ ä»éœ€è¦å®Œæˆçš„æ­¥éª¤åˆ°è®¡åˆ’ä¸­ã€‚ä¸è¦å°†å·²ç»å®Œæˆçš„æ­¥éª¤ä½œä¸ºè®¡åˆ’çš„ä¸€éƒ¨åˆ†è¿”å›ã€‚&quot;&quot;&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">replanner = replanner_prompt | model.with_structured_output(Act)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">async def replan_step(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;é‡æ–°è§„åˆ’æ­¥éª¤&quot;&quot;&quot;</span><br><span class="line">    # ä½¿ç”¨é‡æ–°è§„åˆ’å™¨æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°è®¡åˆ’</span><br><span class="line">    output = await replanner.ainvoke(state)</span><br><span class="line">    if isinstance(output.action, Response):</span><br><span class="line">        # å¦‚æœåŠ¨ä½œæ˜¯å“åº”ï¼Œè¿”å›æœ€ç»ˆå“åº”</span><br><span class="line">        return &#123;&quot;response&quot;: output.action.response&#125;</span><br><span class="line">    else:</span><br><span class="line">        # å¦‚æœåŠ¨ä½œæ˜¯è®¡åˆ’ï¼Œè¿”å›æ–°çš„è®¡åˆ’æ­¥éª¤</span><br><span class="line">        return &#123;&quot;plan&quot;: output.action.steps&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰è·¯ç”±">å®šä¹‰è·¯ç”±</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def should_end(state: PlanExecute):</span><br><span class="line">    &quot;&quot;&quot;åˆ¤æ–­æ˜¯å¦ç»“æŸæ‰§è¡Œæµç¨‹&quot;&quot;&quot;</span><br><span class="line">    if &quot;response&quot; in state and state[&quot;response&quot;]:</span><br><span class="line">        # å¦‚æœå­˜åœ¨å“åº”å†…å®¹ï¼Œç»“æŸæµç¨‹</span><br><span class="line">        return END</span><br><span class="line">    else:</span><br><span class="line">        # å¦åˆ™ç»§ç»­æ‰§è¡Œä»£ç†æ­¥éª¤</span><br><span class="line">        return &quot;agent&quot;</span><br></pre></td></tr></table></figure>
<h4 id="ç¼–è¯‘å›¾">ç¼–è¯‘å›¾</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.graph import StateGraph, START</span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºå†…å­˜æ£€æŸ¥ç‚¹ä¿å­˜å™¨</span><br><span class="line">memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºå·¥ä½œæµå›¾ï¼Œä½¿ç”¨ PlanExecute çŠ¶æ€ç±»å‹</span><br><span class="line">workflow = StateGraph(PlanExecute)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ è®¡åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_node(&quot;planner&quot;, plan_step)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ æ‰§è¡Œæ­¥éª¤èŠ‚ç‚¹</span><br><span class="line">workflow.add_node(&quot;agent&quot;, execute_step)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ é‡æ–°è§„åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_node(&quot;replan&quot;, replan_step)</span><br><span class="line"></span><br><span class="line"># ä»å¼€å§‹èŠ‚ç‚¹è¿æ¥åˆ°è®¡åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_edge(START, &quot;planner&quot;)</span><br><span class="line"></span><br><span class="line"># ä»è®¡åˆ’èŠ‚ç‚¹è¿æ¥åˆ°ä»£ç†æ‰§è¡ŒèŠ‚ç‚¹</span><br><span class="line">workflow.add_edge(&quot;planner&quot;, &quot;agent&quot;)</span><br><span class="line"></span><br><span class="line"># ä»ä»£ç†æ‰§è¡ŒèŠ‚ç‚¹è¿æ¥åˆ°é‡æ–°è§„åˆ’èŠ‚ç‚¹</span><br><span class="line">workflow.add_edge(&quot;agent&quot;, &quot;replan&quot;)</span><br><span class="line"></span><br><span class="line"># æ·»åŠ æ¡ä»¶è¾¹ - ä»é‡æ–°è§„åˆ’èŠ‚ç‚¹æ ¹æ®æ¡ä»¶å†³å®šä¸‹ä¸€æ­¥</span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    &quot;replan&quot;,</span><br><span class="line">    # ä¼ å…¥å†³å®šä¸‹ä¸€ä¸ªè°ƒç”¨èŠ‚ç‚¹çš„å‡½æ•°</span><br><span class="line">    should_end,</span><br><span class="line">    [&quot;agent&quot;, END],  # å¯èƒ½çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼šä»£ç†èŠ‚ç‚¹æˆ–ç»“æŸ</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># æœ€åï¼Œç¼–è¯‘å·¥ä½œæµå¹¶æ·»åŠ æ£€æŸ¥ç‚¹åŠŸèƒ½ï¼</span><br><span class="line"># è¿™å°†å…¶ç¼–è¯‘ä¸º LangChain Runnableï¼Œ</span><br><span class="line"># æ„å‘³ç€ä½ å¯ä»¥åƒä½¿ç”¨å…¶ä»–ä»»ä½• runnable ä¸€æ ·ä½¿ç”¨å®ƒ</span><br><span class="line">app = workflow.compile(checkpointer=memory)</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/Plan-and-Execute%E6%A8%A1%E5%BC%8F/image-20250729092408872.png" alt="image-20250729092408872">
<figcaption aria-hidden="true">image-20250729092408872</figcaption>
</figure>
<h4 id="è°ƒç”¨">è°ƒç”¨</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># é…ç½®é€’å½’é™åˆ¶ï¼Œé˜²æ­¢æ— é™å¾ªç¯</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;</span><br><span class="line">        &quot;thread_id&quot;: &quot;1&quot;,  # å¿…éœ€ï¼šçº¿ç¨‹ID</span><br><span class="line">    &#125;,&quot;recursion_limit&quot;: 50&#125;</span><br><span class="line"></span><br><span class="line"># è¾“å…¥é—®é¢˜ï¼š2024å¹´æ¾³å¤§åˆ©äºšç½‘çƒå…¬å¼€èµ›ç”·å•å† å†›çš„å®¶ä¹¡æ˜¯å“ªé‡Œï¼Ÿ</span><br><span class="line">inputs = &#123;&quot;input&quot;: &quot;2024å¹´æ¾³å¤§åˆ©äºšç½‘çƒå…¬å¼€èµ›ç”·å•å† å†›çš„å®¶ä¹¡æ˜¯å“ªé‡Œï¼Ÿ&quot;&#125;</span><br><span class="line"></span><br><span class="line"># å¼‚æ­¥æµå¼æ‰§è¡Œåº”ç”¨</span><br><span class="line">async for event in app.astream(inputs, config=config):</span><br><span class="line">    # éå†æ¯ä¸ªäº‹ä»¶</span><br><span class="line">    for k, v in event.items():</span><br><span class="line">        # æ’é™¤ç»“æŸæ ‡è®°ï¼Œæ‰“å°å…¶ä»–æ‰€æœ‰äº‹ä»¶å†…å®¹</span><br><span class="line">        if k != &quot;__end__&quot;:</span><br><span class="line">            print(v)</span><br></pre></td></tr></table></figure>
<h3 id="èµ„æº">èµ„æº</h3>
<p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/tutorials/plan-and-execute/plan-and-execute/">è®¡åˆ’ä¸æ‰§è¡Œ
â€” Plan-and-Execute</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/pgsql%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/agent%E5%AE%9E%E6%88%98/pgsql%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96/" class="post-title-link" itemprop="url">pgsqlå®ç°æŒä¹…åŒ–</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-06 15:00:36" itemprop="dateModified" datetime="2025-08-06T15:00:36+08:00">2025-08-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/agent%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">agentå®æˆ˜</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€">å‰è¨€</h3>
<p>å¸¸ä½¿ç”¨pgsqlä¸redisé…åˆlanggraphçš„checkpointä¸storeè¿›è¡ŒæŒä¹…åŒ–å‚¨å­˜ï¼Œå®Œæˆé•¿æœŸè®°å¿†ä¸çŸ­æœŸè®°å¿†çš„å®ç°</p>
<h3 id="pgsqlå®ç°æŒä¹…åŒ–">pgsqlå®ç°æŒä¹…åŒ–</h3>
<h4 id="ä»€ä¹ˆæ˜¯pgsql">ä»€ä¹ˆæ˜¯pgsql</h4>
<p>PostgreSQLï¼ˆå¸¸ç®€ç§°pgsqlæˆ–Postgresï¼‰æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¼€æºå¯¹è±¡-å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆORDBMSï¼‰ï¼Œä»¥å…¶ç¨³å®šæ€§ã€æ‰©å±•æ€§å’Œç¬¦åˆSQLæ ‡å‡†è‘—ç§°ã€‚</p>
<h4 id="dockeræ‹‰å–">dockeræ‹‰å–</h4>
<p>docker-compose</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  postgres:</span><br><span class="line">    image: postgres:15        # æŒ‡å®šå…·ä½“ç‰ˆæœ¬</span><br><span class="line">    container_name: postgres_db</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_USER: postgres</span><br><span class="line">      POSTGRES_PASSWORD: postgres</span><br><span class="line">      POSTGRES_DB: postgres</span><br><span class="line">      TZ: Asia/Shanghai       # è®¾ç½®æ—¶åŒº</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5432:5432&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - pgdata:/var/lib/postgresql/data</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:             # å¥åº·æ£€æŸ¥</span><br><span class="line">      test: [&quot;CMD&quot;, &quot;pg_isready&quot;, &quot;-U&quot;, &quot;nange&quot;]</span><br><span class="line">      interval: 10s</span><br><span class="line">      timeout: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">    command: [&quot;postgres&quot;, &quot;-c&quot;, &quot;max_connections=200&quot;]  # è‡ªå®šä¹‰é…ç½®</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  pgdata:</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Docker Compose</strong> æ˜¯ä¸€ä¸ª <strong>å®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨
Docker åº”ç”¨</strong> çš„ <strong>å£°æ˜å¼å·¥å…·</strong>ã€‚ å®ƒé€šè¿‡ä¸€ä¸ª
<strong>YAML æ–‡ä»¶ï¼ˆé€šå¸¸å« <code>docker-compose.yml</code>ï¼‰</strong>
æè¿°æ•´ä¸ªåº”ç”¨çš„æœåŠ¡ã€ç½‘ç»œã€å­˜å‚¨ç­‰é…ç½®ï¼Œç„¶åç”¨ä¸€æ¡å‘½ä»¤å³å¯
<strong>å¯åŠ¨/åœæ­¢/ç®¡ç†</strong> æ‰€æœ‰å®¹å™¨ï¼Œæ— éœ€æ‰‹åŠ¨é€ä¸ª
<code>docker run</code>ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ‹‰å–å¹¶è¿è¡Œ</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<h4 id="åœ¨pgsqslå®‰è£…ä¾èµ–">åœ¨pgsqslå®‰è£…ä¾èµ–</h4>
<p>å› ä¸ºLangGraphçš„PostgresStoreéœ€è¦ä½¿ç”¨åˆ°pgvectorï¼Œå› æ­¤éœ€è¦åœ¨å®¹å™¨ä¸­æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼Œç›´æ¥ä½¿ç”¨Docker
Desktopè½¯ä»¶ä¸­è¿›è¡Œæ“ä½œ</p>
<blockquote>
<ul>
<li>ä¸ºä»€ä¹ˆéœ€è¦ <code>pgvector</code>ï¼Ÿ</li>
<li><code>PostgresStore</code> æ”¯æŒå°†
<strong>å‘é‡åµŒå…¥ï¼ˆembeddingï¼‰</strong> å­˜å‚¨åœ¨ PostgreSQL
ä¸­ï¼Œå¹¶åŸºäºå®ƒä»¬è¿›è¡Œ <strong>è¯­ä¹‰æœç´¢</strong>ã€‚</li>
<li>è¯¥åŠŸèƒ½ä¾èµ– <code>pgvector</code> æ‰©å±•æä¾›çš„ <code>vector</code>
ç±»å‹å’Œç´¢å¼•æœºåˆ¶ï¼ˆå¦‚ HNSWï¼‰ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å®‰è£…ä¾èµ–           </span><br><span class="line">apt update    #åˆ·æ–°æœ¬åœ°è½¯ä»¶åŒ…ç´¢å¼•           </span><br><span class="line">apt install -y git build-essential postgresql-server-dev-15                          </span><br></pre></td></tr></table></figure>
<blockquote>
<p>apt install -y git build-essential postgresql-server-dev-15ä¸€æ¬¡æ€§å®‰è£…
3 ç±»ä¾èµ–ã€‚</p>
<ul>
<li><code>git</code> â€”â€” ç”¨æ¥å…‹éš† pgvector æºç ã€‚</li>
<li><code>build-essential</code> â€”â€” Debian/Ubuntu
çš„â€œç¼–è¯‘å·¥å…·é“¾â€å…ƒåŒ…ï¼ŒåŒ…å« gccã€make ç­‰ã€‚</li>
<li><code>postgresql-server-dev-15</code> â€”â€” ä¸å½“å‰ Postgres
<strong>ä¸»ç‰ˆæœ¬ä¸€è‡´</strong> çš„å¼€å‘å¤´æ–‡ä»¶å’Œ <code>pg_config</code>ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ç¼–è¯‘å¹¶å®‰è£… pgvector      </span><br><span class="line">#æŠŠ pgvector çš„ v0.7.0 ç¨³å®šç‰ˆ æºç å…‹éš†åˆ°æœ¬åœ°ç›®å½• ./pgvectorã€‚</span><br><span class="line">git clone --branch v0.7.0 https://github.com/pgvector/pgvector.git                </span><br><span class="line">cd pgvector  </span><br><span class="line">#è°ƒç”¨ Makefile æ ¹æ®å½“å‰æ“ä½œç³»ç»Ÿ + PostgreSQL ç‰ˆæœ¬ç¼–è¯‘å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ.so å…±äº«åº“ï¼‰ã€‚</span><br><span class="line">make          </span><br><span class="line">#æŠŠåˆšåˆšç¼–å¥½çš„ .so æ–‡ä»¶å’Œ .sql/.control æ–‡ä»¶å¤åˆ¶åˆ° PostgreSQL çš„æ‰©å±•ç›®å½•</span><br><span class="line">make install                </span><br><span class="line">éªŒè¯å®‰è£…ï¼Œæ£€æŸ¥æ‰©å±•æ–‡ä»¶æ˜¯å¦å®‰è£…æˆåŠŸ                    </span><br><span class="line">ls -l /usr/share/postgresql/15/extension/vector* </span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/pgvector/pgvector">pgvector/pgvector:
Open-source vector similarity search for Postgres</a></p>
<p>æ¥ä¸‹æ¥ï¼Œè‹¥è¦åœ¨è„šæœ¬ä¸­è¿›è¡Œä½¿ç”¨ï¼Œé¦–å…ˆåœ¨ç³»ç»Ÿç¯å¢ƒä¸­éœ€è¦å®‰è£…PostgreSQL
çš„å¼€å‘åº“ï¼ˆlibpqï¼‰ï¼Œå› ä¸º psycopg éœ€è¦å®ƒæ¥ç¼–è¯‘æˆ–è¿è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install libpq-dev postgresql-server-dev-all</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>psycopgï¼ˆPython æ“ä½œ PostgreSQL çš„åº“ï¼‰</strong> åœ¨
<strong>Linux/macOS</strong> ä¸Šè¿è¡Œæ—¶ï¼Œåº•å±‚ä¾èµ–äº <strong>PostgreSQL çš„
C è¯­è¨€å¼€å‘åº“ libpq</strong>ã€‚ å¦‚æœç³»ç»Ÿé‡Œ <strong>æ²¡æœ‰
libpq</strong>ï¼Œpsycopg ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§é—®é¢˜ï¼š</p>
<ol type="1">
<li><p><strong>ç¼–è¯‘å®‰è£…å¤±è´¥</strong>ï¼ˆæºç /æ—§ç‰ˆæœ¬ï¼‰ å½“
<code>pip install psycopg2</code> éœ€è¦ç°åœºç¼–è¯‘æ—¶ï¼Œä¼šæ‰¾ä¸åˆ°å¤´æ–‡ä»¶
<code>libpq-fe.h</code> æˆ–åŠ¨æ€åº“ <code>libpq.so</code>ï¼Œå¯¼è‡´æŠ¥é”™ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: libpq-fe.h: No such file or directory</span><br></pre></td></tr></table></figure></li>
<li><p><strong>è¿è¡Œæ—¶å´©æºƒ</strong> å³ä½¿é€šè¿‡é¢„ç¼–è¯‘çš„ wheel
åŒ…å®‰è£…æˆåŠŸï¼Œè¿è¡Œæ—¶ä¹Ÿå¯èƒ½æç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImportError: libpq.so.5: cannot open shared object file</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<p>æœ€åï¼Œå†å®‰è£…ç›¸å…³ä¾èµ–åŒ…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install langgraph-checkpoint-postgres                    </span><br><span class="line">pip install psycopg psycopg-pool </span><br></pre></td></tr></table></figure>
<p>psycopgå®˜æ–¹ PostgreSQL é©±åŠ¨ï¼Œåœ¨ <code>psycopg</code>
ä¹‹ä¸Šå†åŒ…ä¸€å±‚â€œ<strong>è¿æ¥æ± </strong>â€ï¼Œè®©å¹¶å‘è®¿é—®æ›´å¿«ã€æ›´ç¨³å®šã€‚</p>
<h4 id="è¿æ¥pgsql">è¿æ¥pgsql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.store.postgres import PostgresStore</span><br><span class="line">from langgraph.checkpoint.postgres import PostgresSaver</span><br><span class="line">from psycopg_pool import ConnectionPool</span><br><span class="line"># 1) è¿æ¥å­—ç¬¦ä¸²ï¼ˆURI è¯­æ³•ï¼‰</span><br><span class="line">DB_URI = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line">#   åè®®://      ç”¨æˆ·   : å¯†ç    @ ä¸»æœº:ç«¯å£ / æ•°æ®åº“å  ? é¢å¤–å‚æ•°</span><br><span class="line"></span><br><span class="line"># 2) è¿æ¥çº§å‚æ•°</span><br><span class="line">connection_kwargs = &#123;</span><br><span class="line">    &quot;autocommit&quot;: True,     # æ¯æ¡ SQL æ‰§è¡Œå®Œç«‹å³æäº¤ï¼Œæ— éœ€æ‰‹åŠ¨ commit</span><br><span class="line">    &quot;prepare_threshold&quot;: 0, # ç¦ç”¨æœåŠ¡å™¨ç«¯ prepared statementï¼Œå¯å‡å°‘ä¸€æ¬¡å¾€è¿”</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 3) åˆ›å»ºæ± </span><br><span class="line">connection_pool = ConnectionPool(</span><br><span class="line">    conninfo=DB_URI,</span><br><span class="line">    max_size=20,            # æœ€å¤š 20 æ¡ç‰©ç†è¿æ¥</span><br><span class="line">    kwargs=connection_kwargs,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 4) æ˜¾å¼æ‰“å¼€æ± ï¼ˆpsycopg 3 çš„ ConnectionPool é»˜è®¤æ‡’å¯åŠ¨ï¼Œè°ƒ open() ä¼šç«‹å³å»º min_size æ¡è¿æ¥ï¼‰</span><br><span class="line">connection_pool.open()</span><br><span class="line">print(&quot;æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ&quot;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ­£å¸¸æƒ…å†µæ¯æ¬¡ SQL éƒ½æ–°å»ºä¸€æ¡ TCP è¿æ¥ã€åš SSL
æ¡æ‰‹ã€éªŒè¯å¯†ç ã€åˆ†é…å†…å­˜ï¼Œå¦‚æœä¸å¤ç”¨è¿æ¥ï¼Œè¿™äº›åŠ¨ä½œå°±è¦
<strong>æ¯æ¬¡éƒ½é‡æ–°æ¥ä¸€é</strong>ï¼Œ<strong>æˆæœ¬éå¸¸é«˜</strong>ã€‚</p>
<p>è¿æ¥æ± ï¼ˆConnection Poolï¼‰æ˜¯ä¸€ç§
<strong>æ•°æ®åº“è®¿é—®å±‚èµ„æºç®¡ç†ç»„ä»¶</strong>ï¼Œå…¶æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨
<strong>é«˜å¹¶å‘ã€çŸ­äº‹åŠ¡</strong> åœºæ™¯ä¸‹ï¼Œé€šè¿‡
<strong>å¤ç”¨å·²å»ºç«‹çš„æ•°æ®åº“ç‰©ç†è¿æ¥</strong>
æ¥é™ä½ç³»ç»Ÿæ•´ä½“å»¶è¿Ÿã€å‡å°‘èµ„æºæ¶ˆè€—ï¼Œå¹¶é˜²æ­¢æ•°æ®åº“å› ç¬æ—¶è¿æ¥é£æš´è€Œå´©æºƒã€‚</p>
</blockquote>
<h4 id="åˆå§‹åŒ–pgsql">åˆå§‹åŒ–pgsql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># åˆå§‹åŒ–PostgresStore</span><br><span class="line">in_postgres_store = PostgresStore(</span><br><span class="line">    pool,</span><br><span class="line">    index=&#123;</span><br><span class="line">        &quot;dims&quot;: 1536,</span><br><span class="line">        &quot;embed&quot;: embedding</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">in_postgres_store.setup()</span><br><span class="line"></span><br><span class="line">#åˆå§‹åŒ–checkpoint</span><br><span class="line"># ä½¿ç”¨ä¼ å…¥çš„è¿æ¥æ± åˆ›å»º PostgresSaver</span><br><span class="line">checkpointer = PostgresSaver(pool)</span><br><span class="line">checkpointer.setup()</span><br><span class="line"></span><br><span class="line">#æœ€åç¼–è¯‘æ—¶æ·»åŠ </span><br><span class="line">graph_builder.compile(checkpointer=checkpointer, store=in_postgres_store)</span><br></pre></td></tr></table></figure>
<p><code>in_postgres_store.setup()</code> çš„è§’è‰²ä¸€å¥è¯å°±èƒ½è¯´æ¸…ï¼š</p>
<blockquote>
<p><strong>æŠŠæ•°æ®åº“é‡Œæ‰€æœ‰ä¸ºäº†è®©å‘é‡å­˜å‚¨æ­£å¸¸å·¥ä½œçš„â€œä¸€æ¬¡æ€§åŸºå»ºâ€å…¨éƒ¨å»ºå¥½</strong>â€”â€”åªå»ºä¸€æ¬¡ï¼Œåé¢å†è·‘å°±ä¸ä¼šé‡å¤æ‰§è¡Œã€‚</p>
</blockquote>
<p>å…·ä½“è€Œè¨€ï¼Œå®ƒé€šå¸¸å¹²ä¸‹é¢ä¸‰ä»¶äº‹ï¼š1.<strong>å»ºè¡¨ /
å»ºæ‰©å±•</strong>ï¼›2.<strong>å»ºå‘é‡ç´¢å¼•</strong>ï¼›3.<strong>å…ƒæ•°æ®åˆå§‹åŒ–</strong></p>
<h4 id="fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†">fastapiå®ç°ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># å®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°lifespanï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªFastAPIåº”ç”¨å®ä¾‹appä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªå‡½æ•°å°†ç®¡ç†åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¯åŠ¨å’Œå…³é—­æ—¶çš„æ“ä½œ</span><br><span class="line"># å‡½æ•°åœ¨åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¦‚åŠ è½½ä¸Šä¸‹æ–‡æ•°æ®ã€ä»¥åŠåˆå§‹åŒ–é—®é¢˜ç”Ÿæˆå™¨</span><br><span class="line"># å‡½æ•°åœ¨åº”ç”¨å…³é—­æ—¶æ‰§è¡Œä¸€äº›æ¸…ç†æ“ä½œ</span><br><span class="line"># @asynccontextmanager è£…é¥°å™¨ç”¨äºåˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒå…è®¸ä½ åœ¨ yield ä¹‹å‰å’Œä¹‹åæ‰§è¡Œç‰¹å®šçš„ä»£ç å—ï¼Œåˆ†åˆ«è¡¨ç¤ºå¯åŠ¨å’Œå…³é—­æ—¶çš„æ“ä½œ</span><br><span class="line">@asynccontextmanager</span><br><span class="line">async def lifespan(app: FastAPI):</span><br><span class="line">    # å¯åŠ¨æ—¶æ‰§è¡Œ</span><br><span class="line">    # ç”³æ˜å¼•ç”¨å…¨å±€å˜é‡ï¼Œåœ¨å‡½æ•°ä¸­è¢«åˆå§‹åŒ–ï¼Œå¹¶åœ¨æ•´ä¸ªåº”ç”¨ä¸­ä½¿ç”¨</span><br><span class="line">    global graph, connection_pool</span><br><span class="line">    # å¯åŠ¨æ—¶æ‰§è¡Œ</span><br><span class="line">    try:</span><br><span class="line">        logger.info(&quot;æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹ã€å®šä¹‰ Graph...&quot;)</span><br><span class="line">        # åˆå§‹åŒ– LLM</span><br><span class="line">        llm, embedding = get_llm(llm_type)</span><br><span class="line">        # åˆ›å»ºæ•°æ®åº“è¿æ¥æ± </span><br><span class="line">        DB_URI = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line">        connection_kwargs = &#123;</span><br><span class="line">            &quot;autocommit&quot;: True,</span><br><span class="line">            &quot;prepare_threshold&quot;: 0,</span><br><span class="line">        &#125;</span><br><span class="line">        connection_pool = ConnectionPool(</span><br><span class="line">            conninfo=DB_URI,</span><br><span class="line">            max_size=20,</span><br><span class="line">            kwargs=connection_kwargs,</span><br><span class="line">        )</span><br><span class="line">        connection_pool.open()  # æ˜¾å¼æ‰“å¼€è¿æ¥æ± </span><br><span class="line">        logger.info(&quot;æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ&quot;)</span><br><span class="line">        # çŸ­æœŸè®°å¿† åˆå§‹åŒ–checkpointer</span><br><span class="line">        checkpointer = PostgresSaver(connection_pool)</span><br><span class="line">        checkpointer.setup()</span><br><span class="line">        # é•¿æœŸè®°å¿† åˆå§‹åŒ–PostgresStore</span><br><span class="line">        in_postgres_store = PostgresStore(</span><br><span class="line">            connection_pool,</span><br><span class="line">            index=&#123;</span><br><span class="line">                &quot;dims&quot;: 1536,</span><br><span class="line">                &quot;embed&quot;: embedding</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        in_postgres_store.setup()</span><br><span class="line">        # å®šä¹‰ Graph</span><br><span class="line">        graph = create_graph(llm, checkpointer, in_postgres_store )</span><br><span class="line">        # ä¿å­˜ Graph å¯è§†åŒ–å›¾</span><br><span class="line">        save_graph_visualization(graph)</span><br><span class="line">        logger.info(&quot;åˆå§‹åŒ–å®Œæˆ&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        logger.error(f&quot;åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™: &#123;str(e)&#125;&quot;)</span><br><span class="line">        raise</span><br><span class="line"></span><br><span class="line">    yield  # åº”ç”¨è¿è¡ŒæœŸé—´</span><br><span class="line"></span><br><span class="line">    # å…³é—­æ—¶æ‰§è¡Œ</span><br><span class="line">    logger.info(&quot;æ­£åœ¨å…³é—­...&quot;)</span><br><span class="line">    if connection_pool:</span><br><span class="line">        connection_pool.close()  # å…³é—­è¿æ¥æ± </span><br><span class="line">        logger.info(&quot;æ•°æ®åº“è¿æ¥æ± å·²å…³é—­&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># lifespanå‚æ•°ç”¨äºåœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹å’Œç»“æŸæ—¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æˆ–æ¸…ç†å·¥ä½œ</span><br><span class="line">app = FastAPI(lifespan=lifespan)</span><br></pre></td></tr></table></figure>
<h3 id="pgsqlçš„å­˜å‚¨ç»“æ„">pgsqlçš„å­˜å‚¨ç»“æ„</h3>
<h4 id="ä¸€checkpoints-ç³»åˆ—">ä¸€ã€Checkpoints ç³»åˆ—</h4>
<blockquote>
<p>ä½œç”¨ï¼šè®© <strong>LangGraph Runtime</strong> èƒ½åœ¨
<strong>åˆ†å¸ƒå¼/é•¿æµç¨‹</strong> åœºæ™¯ä¸‹
<strong>æ–­ç‚¹ç»­è·‘ã€é‡æ”¾ã€å¹¶å‘æ§åˆ¶</strong>ã€‚</p>
</blockquote>
<table>
<colgroup>
<col style="width: 15%">
<col style="width: 31%">
<col style="width: 37%">
<col style="width: 16%">
</colgroup>
<thead>
<tr>
<th>è¡¨å</th>
<th>å­˜ä»€ä¹ˆ</th>
<th>å…¸å‹å­—æ®µï¼ˆç¤ºæ„ï¼‰</th>
<th>ä½•æ—¶å†™å…¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>checkpoints</strong></td>
<td>æ¯ä¸ªã€Œå›¾å®ä¾‹ã€çš„ <strong>æœ€æ–°å¿«ç…§</strong>ï¼ˆstate çš„å®Œæ•´
JSONBï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_ns</code>,
<code>checkpoint_id</code>, <code>parent_checkpoint_id</code>,
<code>state</code>, <code>created_at</code></td>
<td>æ¯æ¬¡èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸåè¦†ç›–æ›´æ–°</td>
</tr>
<tr>
<td><strong>checkpoint_blobs</strong></td>
<td>checkpoints é‡Œ <strong>å¤§å­—æ®µçš„æ‹†åˆ†</strong>ï¼ˆé¿å…è¡Œè¿‡å¤§ï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_ns</code>,
<code>channel</code>, <code>type</code>, <code>blob</code></td>
<td>å½“ state è¿‡å¤§ï¼Œè‡ªåŠ¨æ‹†åˆ†</td>
</tr>
<tr>
<td><strong>checkpoint_migrations</strong></td>
<td>è®°å½• <strong>schema ç‰ˆæœ¬/è¿ç§»è„šæœ¬</strong></td>
<td><code>version</code>, <code>name</code>,
<code>applied_at</code></td>
<td>åªåœ¨ <code>setup()</code> æ—¶å†™ä¸€æ¬¡</td>
</tr>
<tr>
<td><strong>checkpoint_writes</strong></td>
<td><strong>å†™æ”¾å¤§æ—¥å¿—</strong>ï¼ˆæ¯ä¸ªèŠ‚ç‚¹å†™ state çš„å¢é‡ diffï¼‰</td>
<td><code>thread_id</code>, <code>checkpoint_id</code>,
<code>task_id</code>, <code>idx</code>, <code>channel</code>,
<code>type</code>, <code>value</code></td>
<td>æ¯æ¬¡èŠ‚ç‚¹å®Œæˆæ—¶è¿½åŠ </td>
</tr>
</tbody>
</table>
<blockquote>
<p>å…³ç³»ï¼š<br>
<code>checkpoints</code> = æœ€æ–°å®Œæ•´å¿«ç…§<br>
<code>checkpoint_writes</code> = æ‰€æœ‰å¢é‡å†å²ï¼ˆç”¨äºé‡æ”¾/å®¡è®¡ï¼‰<br>
<code>checkpoint_blobs</code> = checkpoints é‡Œè¶…å¤§å‹ value çš„åˆ‡ç‰‡</p>
</blockquote>
<h4 id="äºŒstore-ç³»åˆ—">äºŒã€Store ç³»åˆ—</h4>
<blockquote>
<p>ä½œç”¨ï¼šç»™ <strong>ä¸šåŠ¡ä»£ç ï¼ˆå¼€å‘è€…ï¼‰</strong> æä¾› <strong>æŒä¹…åŒ– KV /
å‘é‡å­˜å‚¨</strong>ï¼Œä¸å›¾è¿è¡ŒçŠ¶æ€æ— å…³ã€‚</p>
</blockquote>
<table>
<colgroup>
<col style="width: 12%">
<col style="width: 27%">
<col style="width: 34%">
<col style="width: 25%">
</colgroup>
<thead>
<tr>
<th>è¡¨å</th>
<th>å­˜ä»€ä¹ˆ</th>
<th>å…¸å‹å­—æ®µï¼ˆç¤ºæ„ï¼‰</th>
<th>ä½•æ—¶å†™å…¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>store</strong></td>
<td><strong>ä»»æ„ KV æ–‡æ¡£</strong>ï¼ˆLangChain Document â†’ JSONBï¼‰</td>
<td><code>uuid</code>, <code>namespace</code>, <code>key</code>,
<code>value</code>, <code>created_at</code>,
<code>updated_at</code></td>
<td>ä½ è°ƒç”¨ <code>store.amput</code> / <code>amset</code> ç­‰ API</td>
</tr>
<tr>
<td><strong>store_migrations</strong></td>
<td>åŒ checkpoint_migrationsï¼Œè®°å½• store schema ç‰ˆæœ¬</td>
<td><code>version</code>, <code>name</code>,
<code>applied_at</code></td>
<td>åªåœ¨ç¬¬ä¸€æ¬¡ <code>setup()</code></td>
</tr>
<tr>
<td><strong>store_vectors</strong></td>
<td><strong>å‘é‡ç´¢å¼•è¡¨</strong>ï¼ˆembedding â†’ vector ç±»å‹ï¼‰</td>
<td><code>uuid</code>, <code>collection_id</code>,
<code>embedding</code>, <code>document</code>,
<code>metadata</code></td>
<td>ä½ è°ƒç”¨ <code>add_documents(..., embeddings=...)</code></td>
</tr>
<tr>
<td><strong>vector_migrations</strong></td>
<td>è®°å½• pgvector æ‰©å±•åŠç´¢å¼•è¿ç§»ç‰ˆæœ¬</td>
<td><code>version</code>, <code>applied_at</code></td>
<td><code>setup()</code> æ—¶è‹¥ç¬¬ä¸€æ¬¡è£… pgvector</td>
</tr>
</tbody>
</table>
<h4 id="ä¸‰è°ƒç”¨é“¾è„‘å›¾">ä¸‰ã€è°ƒç”¨é“¾è„‘å›¾</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ LangGraph    â”‚ è¿è¡Œå›¾å®ä¾‹</span><br><span class="line">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">     â”‚1. å†™ checkpoints</span><br><span class="line">     â”‚2. å†™ checkpoint_writes</span><br><span class="line">     â”‚3. æ‹†å¤§å­—æ®µåˆ° checkpoint_blobs</span><br><span class="line">     â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ ä¸šåŠ¡ä»£ç      â”‚ è¯»å†™ KV/å‘é‡</span><br><span class="line">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">     â”‚1. å†™ store</span><br><span class="line">     â”‚2. å†™ store_vectors</span><br><span class="line">     â–¼</span><br><span class="line"> PostgreSQL (pgsql)</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨linuxå®‰è£…postgresql">åœ¨linuxå®‰è£…postgresql</h3>
<h4 id="æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬">æŸ¥çœ‹linuxå‘è¡Œç‰ˆæœ¬</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹å‘è¡Œç‰ˆåç§°å’Œç‰ˆæœ¬</span><br><span class="line">cat /etc/os-release</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PRETTY_NAME=&quot;Ubuntu 24.04.2 LTS&quot;</span><br><span class="line">NAME=&quot;Ubuntu&quot;</span><br><span class="line">VERSION_ID=&quot;24.04&quot;</span><br><span class="line">VERSION=&quot;24.04.2 LTS (Noble Numbat)&quot;</span><br><span class="line">VERSION_CODENAME=noble</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">HOME_URL=&quot;https://www.ubuntu.com/&quot;</span><br><span class="line">SUPPORT_URL=&quot;https://help.ubuntu.com/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;</span><br><span class="line">PRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span><br><span class="line">UBUNTU_CODENAME=noble</span><br><span class="line">LOGO=ubuntu-logo</span><br></pre></td></tr></table></figure>
<h4 id="å®‰è£…postgresql">å®‰è£…postgresql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•</span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"># å®‰è£… PostgreSQL å’Œå¸¸ç”¨æ‰©å±•</span><br><span class="line">sudo apt install -y postgresql postgresql-contrib</span><br><span class="line"></span><br><span class="line"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span><br><span class="line">#Linux å®¹å™¨/å­ç³»ç»Ÿï¼ˆ Dockerã€WSL æˆ– LXCï¼‰æ²¡æœ‰ä½¿ç”¨ systemd ï¼Œå› æ­¤ systemctl æ— æ³•å·¥ä½œ</span><br><span class="line">sudo systemctl status postgresql</span><br><span class="line"></span><br><span class="line">#ç¡®è®¤ PostgreSQL å·²å®‰è£…</span><br><span class="line">which psql            # åº”è¯¥è¾“å‡º /usr/bin/psql</span><br><span class="line">pg_ctl --version      # æ˜¾ç¤ºç‰ˆæœ¬å·å³å·²å®‰è£…</span><br></pre></td></tr></table></figure>
<ul>
<li><code>postgresql</code> æ˜¯ä¸»ç¨‹åº</li>
<li><code>postgresql-contrib</code> æä¾›é¢å¤–æ‰©å±•ï¼ˆå¦‚
<code>uuid-ossp</code>ã€<code>pgcrypto</code> ç­‰ï¼‰</li>
</ul>
<blockquote>
<p>systemctlä¸€èˆ¬ç”¨äºæœåŠ¡å™¨ä¸Šï¼Œå®Œæ•´çš„linuxç³»ç»Ÿä¸Š</p>
<p>Linux å®¹å™¨/å­ç³»ç»Ÿï¼ˆ Dockerã€WSL æˆ– LXCï¼‰ä½¿ç”¨ service</p>
</blockquote>
<h4 id="pgsqlå¸¸ç”¨æŒ‡ä»¤">pgsqlå¸¸ç”¨æŒ‡ä»¤</h4>
<p>å¯åŠ¨pgsqlæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql start</span><br></pre></td></tr></table></figure>
<p>åœæ­¢pgsqlæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql stop</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹çŠ¶æ€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql status</span><br></pre></td></tr></table></figure>
<p>è¿æ¥PostgreSQL é»˜è®¤çš„ç³»ç»Ÿç”¨æˆ·ï¼Œå¯ä»¥æ‰§è¡Œpgsqlçš„ç›¸å…³æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>psql</strong>ä¸ºPostgreSQL
çš„ç»ˆç«¯å®¢æˆ·ç«¯ï¼Œé»˜è®¤ä¼šè¿æ¥ä¸å½“å‰æ“ä½œç³»ç»Ÿç”¨æˆ·ååŒåçš„æ•°æ®åº“ç”¨æˆ·å’Œæ•°æ®åº“ã€‚</p>
<p><strong>postgres</strong>ä¸ºPostgreSQL
è‡ªå¸¦çš„ç³»ç»Ÿæ•°æ®åº“ï¼Œ<code>postgres</code> é»˜è®¤
<strong>æ•°æ®åº“å¯†ç ä¸ºç©º</strong>ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œè®¾ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- è®¾ç½®postgresç”¨æˆ·å¯†ç </span><br><span class="line">ALTER USER postgres PASSWORD &#x27;postgres&#x27;;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>æ•°æ®åº“å…³äºuserçš„ä½œç”¨</p>
<p>æ•°æ®åº“é‡Œçš„â€œç”¨æˆ·â€æ˜¯ PostgreSQL
<strong>å†…éƒ¨ç”¨æ¥åšâ€œè®¿é—®æ§åˆ¶â€çš„ä¸€æŠŠé’¥åŒ™</strong>ã€‚ä¸€å¥è¯ï¼š<strong>â€œè°èƒ½è¿å“ªä¸ªåº“ã€è°èƒ½è¯»å“ªå¼ è¡¨ã€è°èƒ½æ”¹å“ªäº›è¡Œâ€â€”â€”å…¨é è¿™äº›æ•°æ®åº“ç”¨æˆ·ï¼ˆè§’è‰²ï¼‰æ¥åˆ¤å®šã€‚</strong></p>
<table>
<colgroup>
<col style="width: 32%">
<col style="width: 67%">
</colgroup>
<thead>
<tr>
<th>ä½œç”¨</th>
<th>ä¸¾ä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. è®¤è¯</strong>ï¼ˆAuthenticationï¼‰</td>
<td>å‘Šè¯‰ PostgreSQL â€œæˆ‘è¿åº“æ—¶æä¾›çš„ç”¨æˆ·å+å¯†ç æ˜¯å¦åˆæ³•â€ã€‚</td>
</tr>
<tr>
<td><strong>2. æˆæƒ</strong>ï¼ˆAuthorizationï¼‰</td>
<td>å†³å®š
â€œè¿™ä¸ªç”¨æˆ·è¿è¿›æ¥åï¼Œå¯¹å“ªäº›åº“ã€å“ªäº›è¡¨ã€å“ªäº›è¡Œæœ‰ä½•ç§æƒé™ï¼ˆSELECT/INSERT/UPDATE/DELETEâ€¦ï¼‰â€ã€‚</td>
</tr>
<tr>
<td><strong>3. èµ„æºéš”ç¦»</strong>ï¼ˆIsolationï¼‰</td>
<td>ä¸åŒä¸šåŠ¡/å›¢é˜Ÿç”¨ä¸åŒç”¨æˆ·ï¼Œæ–¹ä¾¿å®¡è®¡ã€é™æµã€å›æ”¶æƒé™ï¼Œäº’ä¸å¹²æ‰°ã€‚</td>
</tr>
</tbody>
</table>
<p>pgsqlé€šç”¨ URL æ¨¡æ¿</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgresql://&lt;ç”¨æˆ·å&gt;:&lt;å¯†ç &gt;@127.0.0.1:5432/&lt;æ•°æ®åº“å&gt;[?å‚æ•°=å€¼&amp;...]</span><br></pre></td></tr></table></figure>
<h4 id="è¿æ¥pgsql-1">è¿æ¥pgsql</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># åŸºäºæ•°æ®åº“æŒä¹…åŒ–å­˜å‚¨çš„short-term</span><br><span class="line">db_uri = &quot;postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable&quot;</span><br><span class="line"></span><br><span class="line"># short-termçŸ­æœŸè®°å¿† å®ä¾‹åŒ–PostgresSaverå¯¹è±¡ å¹¶åˆå§‹åŒ–checkpointer</span><br><span class="line"># long-termé•¿æœŸè®°å¿† å®ä¾‹åŒ–PostgresStoreå¯¹è±¡ å¹¶åˆå§‹åŒ–store</span><br><span class="line">async with (</span><br><span class="line">    AsyncPostgresSaver.from_conn_string(db_uri) as checkpointer,</span><br><span class="line">    AsyncPostgresStore.from_conn_string(db_uri) as store</span><br><span class="line"></span><br><span class="line">):</span><br><span class="line">    await store.setup()</span><br><span class="line">    await checkpointer.setup()</span><br></pre></td></tr></table></figure>
<h3 id="æ›´æ¢apté•œåƒæº">æ›´æ¢apté•œåƒæº</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/apt/sources.list &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free</span><br><span class="line">deb http://mirrors.aliyun.com/debian-security bookworm-security main contrib non-free</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">apt update</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7470702616906645540">postgresqlå‘é‡æ‰©å±•pgvectorçš„å®‰è£…ä¸å…¥é—¨æœ¬æ–‡ç®€ç­”çš„ä»‹ç»äº†
rag çš„æ¶æ„ï¼Œå¼•ç”³å‡ºå‘é‡æ•°æ®åº“çš„ä½œç”¨ï¼Œä»‹ç»äº† - æ˜é‡‘</a></p>
<p>langchainæ”¯æŒå‘é‡å­˜å‚¨<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/vectorstores/">å‘é‡å­˜å‚¨
| ğŸ¦œï¸ğŸ”— LangChain â€” Vector stores | ğŸ¦œï¸ğŸ”— LangChain</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">Transformerå­¦ä¹ </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-28T00:00:00+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-12-20 19:20:00" itemprop="dateModified" datetime="2025-12-20T19:20:00+08:00">2025-12-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">å¤§æ¨¡å‹ç®—æ³•</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/transformer/" itemprop="url" rel="index"><span itemprop="name">transformer</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€">å‰è¨€</h3>
<p>æœ¬æ–‡åŸºäº<a target="_blank" rel="noopener" href="https://github.com/Hoper-J/AI-Guide-and-Demos-zh_CN/blob/master/PaperNotes/Transformer%20è®ºæ–‡ç²¾è¯».md#å‰è¨€">AI-Guide-and-Demos-zh_CN/PaperNotes/Transformer
è®ºæ–‡ç²¾è¯».md at master Â· Hoper-J/AI-Guide-and-Demos-zh_CN</a>ä¸<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1pu411o7BE/?spm_id_from=333.337.search-card.all.click&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">Transformerè®ºæ–‡é€æ®µç²¾è¯»ã€è®ºæ–‡ç²¾è¯»ã€‘_å“”å“©å“”å“©_bilibili</a>é˜…è¯»å­¦ä¹ </p>
<h3 id="transformerè´¡çŒ®">transformerè´¡çŒ®</h3>
<p>å®é™…åœ¨è¿™ä¸€é˜¶æ®µçš„å·¥ä½œä¸­ï¼Œ<strong>æ³¨æ„åŠ›æœºåˆ¶</strong>å°±å·²ç»åœ¨<strong>ç¼–ç å™¨-è§£ç å™¨æ¶æ„</strong>ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼ˆä¸
RNN ä¸€èµ·ä½¿ç”¨ï¼‰ï¼Œä½† Transformer
å½»åº•é¢ è¦†äº†é»˜è®¤é‡‡å–çš„é€»è¾‘ï¼š<strong>ç›´æ¥æ”¾å¼ƒ RNN
çš„é€’å½’ç»“æ„ï¼Œåªä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶æ¥ç¼–ç å’Œè§£ç åºåˆ—ä¿¡æ¯</strong>ã€‚</p>
<p>Transformer çš„ä¸»è¦è´¡çŒ®å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><strong>å–æ¶ˆé€’å½’ç»“æ„ï¼Œå®ç°å¹¶è¡Œè®¡ç®—</strong></p>
<p>é€šè¿‡é‡‡ç”¨<strong>è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰</strong>ï¼ŒTransformer
å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¾“å…¥åºåˆ—ï¼Œæå¤§æé«˜äº†è®¡ç®—çš„å¹¶è¡Œåº¦å’Œè®­ç»ƒé€Ÿåº¦ã€‚</p></li>
<li><p><strong>å¼•å…¥ä½ç½®ç¼–ç ï¼ˆPositional Encodingï¼‰å¹¶ç»“åˆ Attention
æœºåˆ¶å·§å¦™åœ°æ•æ‰ä½ç½®ä¿¡æ¯</strong></p>
<p>åœ¨ä¸ä¾èµ– RNN
ç»“æ„çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä½ç½®ç¼–ç ä¸ºåºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ åµŒå…¥ä½ç½®ä¿¡æ¯ï¼Œä»è€Œä½¿æ¨¡å‹èƒ½å¤Ÿæ„ŸçŸ¥è¾“å…¥çš„é¡ºåºã€‚</p></li>
</ul>
<h3 id="transformeræ¶æ„">transformeræ¶æ„</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807135151542.png" alt="image-20250807135151542">
<figcaption aria-hidden="true">image-20250807135151542</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807145354145.png" alt="image-20250807145354145">
<figcaption aria-hidden="true">image-20250807145354145</figcaption>
</figure>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1MY41137AK?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ã€Transformeræ¨¡å‹ã€‘æ›¼å¦™åŠ¨ç”»è½»æ¾å­¦ï¼Œå½¢è±¡æ¯”å–»è´¼å¥½è®°_å“”å“©å“”å“©_bilibili</a></p>
<p>Transformer æ¨¡å‹åŸºäº<strong>ç¼–ç å™¨</strong>ï¼ˆå·¦ï¼‰-
<strong>è§£ç å™¨</strong>ï¼ˆå³ï¼‰æ¶æ„</p>
<p><strong>Transformerç¼–ç å™¨</strong>åŒæ ·ç”± <strong>N
ä¸ªå®Œå…¨ç›¸åŒçš„å±‚</strong>ï¼ˆåŸå§‹è®ºæ–‡ä¸­
N=6ï¼‰å †å è€Œæˆï¼Œæ¯å±‚åªæœ‰ä¸¤ä¸ªå­å±‚ï¼Œè€Œè§£ç å™¨æœ‰ä¸‰ä¸ªã€‚</p>
<ol type="1">
<li>å¤šå¤´è‡ªæ³¨æ„åŠ›ï¼ˆMulti-Head Self-Attentionï¼‰
è®©è¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®éƒ½èƒ½å…³æ³¨åºåˆ—å†…æ‰€æœ‰ä½ç½®ï¼Œç›´æ¥å»ºæ¨¡å…¨å±€ä¾èµ–ã€‚</li>
<li>å‰é¦ˆå…¨è¿æ¥ç½‘ç»œï¼ˆPosition-wise Feed-Forward Networkï¼‰
å¯¹æ¯ä¸ªä½ç½®ç‹¬ç«‹åœ°åšä¸€æ¬¡ä¸¤å±‚çš„å…¨è¿æ¥å˜æ¢ï¼ˆé€šå¸¸å…ˆå‡ç»´å†é™ç»´ï¼‰ã€‚</li>
</ol>
<p>åŒæ ·ï¼Œæ¯ä¸ªå­å±‚åéƒ½æœ‰</p>
<ul>
<li>æ®‹å·®è¿æ¥ï¼ˆResidual Connectionï¼‰</li>
<li>å±‚å½’ä¸€åŒ–ï¼ˆLayer Normalizationï¼‰</li>
</ul>
<p>å¦å¤–ï¼Œç¼–ç å™¨åœ¨è¾“å…¥ç«¯è¿˜ä¼šç”¨åˆ°</p>
<ul>
<li>ä½ç½®ç¼–ç ï¼ˆPositional
Encodingï¼‰â€”â€”ç»™æ¨¡å‹æä¾›åºåˆ—ä½ç½®ä¿¡æ¯ï¼Œå› ä¸ºæ³¨æ„åŠ›æœ¬èº«ä¸åŒ…å«é¡ºåºä¿¡æ¯ã€‚</li>
</ul>
<p><strong>Transformerè§£ç å™¨</strong>ç”±å¤šä¸ªç›¸åŒçš„å±‚å †å è€Œæˆï¼Œæ¯ä¸€å±‚åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒå­å±‚ï¼š</p>
<ol type="1">
<li><strong>æ©è”½å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶</strong>ï¼ˆMasked Multi-Head Attentionï¼‰
ç”¨äºå¤„ç†ç›®æ ‡åºåˆ—ï¼Œé€šè¿‡æ©ç é˜²æ­¢å½“å‰ä½ç½®å…³æ³¨æœªæ¥ä½ç½®ï¼Œç¡®ä¿ç”Ÿæˆè¿‡ç¨‹çš„è‡ªå›å½’ç‰¹æ€§ã€‚</li>
<li><strong>ç¼–ç å™¨-è§£ç å™¨æ³¨æ„åŠ›æœºåˆ¶</strong>ï¼ˆEncoder-Decoder
Attentionï¼‰
ä½¿è§£ç å™¨èƒ½å¤Ÿå…³æ³¨ç¼–ç å™¨è¾“å‡ºçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå»ºç«‹è¾“å…¥ä¸è¾“å‡ºåºåˆ—ä¹‹é—´çš„å…³è”ã€‚</li>
<li><strong>å‰é¦ˆç¥ç»ç½‘ç»œ</strong>ï¼ˆFeed-Forward Neural Networkï¼‰
å¯¹æ³¨æ„åŠ›æœºåˆ¶çš„è¾“å‡ºè¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œå¢å¼ºæ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚</li>
</ol>
<p>æ­¤å¤–ï¼Œæ¯ä¸ªå­å±‚åå‡åŒ…å«<strong>æ®‹å·®è¿æ¥</strong>ï¼ˆResidual
Connectionï¼‰å’Œ<strong>å±‚å½’ä¸€åŒ–</strong>ï¼ˆLayer
Normalizationï¼‰ï¼Œä»¥ç¨³å®šè®­ç»ƒè¿‡ç¨‹å¹¶åŠ é€Ÿæ”¶æ•›ã€‚æœ€ç»ˆï¼Œè§£ç å™¨çš„è¾“å‡ºé€šè¿‡çº¿æ€§å±‚å’ŒSoftmaxå±‚æ˜ å°„ä¸ºè¯æ±‡è¡¨ä¸Šçš„æ¦‚ç‡åˆ†å¸ƒã€‚</p>
<h3 id="åµŒå…¥embeddings">åµŒå…¥ï¼ˆEmbeddingsï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808103256344.png" alt="image-20250808103256344">
<figcaption aria-hidden="true">image-20250808103256344</figcaption>
</figure>
<p>åœ¨ Transformer æ¨¡å‹ä¸­ï¼Œ<strong>åµŒå…¥å±‚</strong>ï¼ˆEmbedding Layerï¼‰
æ˜¯å¤„ç†è¾“å…¥å’Œè¾“å‡ºæ•°æ®çš„å…³é”®æ­¥éª¤ï¼Œå› ä¸ºæ¨¡å‹å®é™…æ“ä½œçš„æ˜¯<strong>å¼ é‡</strong>ï¼ˆtensorï¼‰ï¼Œè€Œé<strong>å­—ç¬¦ä¸²</strong>ï¼ˆstringï¼‰ã€‚åœ¨å°†è¾“å…¥æ–‡æœ¬ä¼ é€’ç»™æ¨¡å‹ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦è¿›è¡Œ<strong>åˆ†è¯</strong>ï¼ˆtokenizationï¼‰ï¼Œå³å°†æ–‡æœ¬æ‹†è§£ä¸ºå¤šä¸ª
<strong>token</strong>ï¼Œéšåè¿™äº› token ä¼šè¢«æ˜ å°„ä¸ºå¯¹åº”çš„ <strong>token
ID</strong>ï¼Œä»è€Œè½¬æ¢ä¸ºæ¨¡å‹å¯ç†è§£çš„æ•°å€¼å½¢å¼ã€‚æ­¤æ—¶ï¼Œæ•°æ®çš„å½¢çŠ¶ä¸º
<code>(seq_len,)</code>ï¼Œå…¶ä¸­ <code>seq_len</code>
è¡¨ç¤ºè¾“å…¥åºåˆ—çš„é•¿åº¦ã€‚</p>
<p>ç›®çš„ï¼šä¸ºäº†è®©æ¨¡å‹æ•æ‰åˆ° token èƒŒåå¤æ‚çš„è¯­ä¹‰ï¼ˆSemantic
meaningï¼‰å…³ç³»ï¼Œæˆ‘ä»¬éœ€è¦å°†ç¦»æ•£çš„ token ID
æ˜ å°„åˆ°ä¸€ä¸ªé«˜ç»´çš„è¿ç»­å‘é‡ç©ºé—´ï¼ˆContinuous, denseï¼‰ã€‚è¿™æ„å‘³ç€æ¯ä¸ª token ID
ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ª<strong>åµŒå…¥å‘é‡</strong>ï¼ˆembedding
vectorï¼‰ï¼ŒæœŸæœ›é€šè¿‡è¿™ç§æ–¹å¼è®©è¯­ä¹‰ç›¸è¿‘çš„è¯æ±‡åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»æ›´è¿‘ï¼Œä½¿æ¨¡å‹èƒ½æ›´å¥½åœ°æ•æ‰è¯æ±‡ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>æµç¨‹ï¼šï¼ˆå‰é¢è¦è¿›è¡Œåˆ†è¯ï¼Œåé¢è¦è¿›è¡Œä½ç½®ç¼–ç ï¼‰</p>
<p>åˆå§‹åŒ–ä¸€ä¸ªå¯å­¦ä¹ çš„çŸ©é˜µ <code>E âˆˆ â„^(|V| Ã— d_model)</code>
<code>|V|</code> = è¯è¡¨å¤§å°ï¼ˆæ¯”å¦‚ 32 kã€50 kï¼‰ï¼Œ<code>d_model</code> =
512/768/1024â€¦</p>
<p>æŠŠ token id ä½œä¸ºè¡Œå·ï¼Œç›´æ¥å–å¯¹åº”è¡Œï¼š <code>x_i = E[token_id_i]</code>
å¾—åˆ° <code>[batch, seq_len, d_model]</code> çš„æµ®ç‚¹å¼ é‡ã€‚</p>
<h3 id="ä½ç½®ç¼–ç positional-encoding">ä½ç½®ç¼–ç ï¼ˆPositional
Encodingï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808103418150.png" alt="image-20250808103418150">
<figcaption aria-hidden="true">image-20250808103418150</figcaption>
</figure>
<p>Transformer
çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰æ˜¯<strong>ä½ç½®æ— å…³ï¼ˆposition-agnosticï¼‰</strong>çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œæ¨¡å‹æ— æ³•åŒºåˆ†â€œæˆ‘çˆ±ä½ â€å’Œâ€œä½ çˆ±æˆ‘â€è¿™ä¸¤ä¸ªå¥å­çš„å·®å¼‚ï¼Œå› ä¸ºè‡ªæ³¨æ„åŠ›æœºåˆ¶åªå…³æ³¨
token ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œè€Œä¸è€ƒè™‘å®ƒä»¬åœ¨åºåˆ—ä¸­çš„é¡ºåºã€‚</p>
<p>ä¸ºäº†è®©æ¨¡å‹æ„ŸçŸ¥åˆ° token çš„ä½ç½®ä¿¡æ¯ï¼ŒTransformer
å¼•å…¥äº†<strong>ä½ç½®ç¼–ç </strong>ã€‚</p>
<p>åœ¨åŸå§‹è®ºæ–‡ä¸­ï¼ŒTransformer ä½¿ç”¨çš„æ˜¯å›ºå®šä½ç½®ç¼–ç ï¼ˆPositional
Encodingï¼‰ï¼Œå…¶å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math display">$$
\begin{aligned}
PE_{(pos, 2i)} &amp;=
\sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right), \\
PE_{(pos, 2i+1)} &amp;=
\cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right).
\end{aligned}
$$</span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="math inline"><em>p</em><em>o</em><em>s</em></span>
è¡¨ç¤ºä½ç½®ç´¢å¼•ï¼ˆPositionï¼‰ã€‚</li>
<li><span class="math inline"><em>i</em></span> è¡¨ç¤ºç»´åº¦ç´¢å¼•ã€‚</li>
<li><span class="math inline"><em>d</em><sub>model</sub></span>
æ˜¯åµŒå…¥å‘é‡çš„ç»´åº¦ã€‚</li>
</ul>
<p>æµç¨‹ï¼šè¾“å…¥çš„æ˜¯ä¸€ä¸ª<strong>æ•´æ•°ç´¢å¼•</strong>ï¼ˆä½ç½®åºå·
0,1,2,â€¦ï¼‰ã€‚ä½ç½®ç¼–ç æ¨¡å—å…ˆæŠŠè¿™äº›æ•´æ•°æ˜ å°„æˆä¸è¯å‘é‡åŒç»´åº¦çš„å‘é‡ï¼ˆä¾‹å¦‚ 512
ç»´ï¼‰ï¼Œå†æŠŠç»“æœåŠ åˆ°è¯å‘é‡ä¸Šã€‚</p>
<h3 id="linearä¸softmax">linearä¸Softmax</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808111823715.png" alt="image-20250808111823715">
<figcaption aria-hidden="true">image-20250808111823715</figcaption>
</figure>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1i5koBtEUU?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ä»Linearåˆ°MLP
AIæ¨¡å‹çš„æ•°å­¦æœ¬è´¨ã€Transformerç»“æ„æ‹†è§£ã€‘_å“”å“©å“”å“©_bilibili</a></p>
<p>åœ¨ Transformer æ¨¡å‹ä¸­ï¼Œ<strong>Softmax</strong>
å‡½æ•°ä¸ä»…åœ¨è®¡ç®—<strong>æ³¨æ„åŠ›æƒé‡</strong>æ—¶ç”¨åˆ°ï¼Œåœ¨é¢„æµ‹é˜¶æ®µçš„è¾“å‡ºå¤„ç†ç¯èŠ‚ä¹Ÿä¼šç”¨åˆ°ï¼Œå› ä¸ºé¢„æµ‹
token çš„è¿‡ç¨‹å¯ä»¥çœ‹æˆæ˜¯<strong>å¤šåˆ†ç±»é—®é¢˜</strong>ã€‚</p>
<p><strong>Softmax</strong>
å‡½æ•°æ˜¯ä¸€ç§å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œèƒ½å¤Ÿå°†ä»»æ„å®æ•°å‘é‡è½¬æ¢ä¸º<strong>æ¦‚ç‡åˆ†å¸ƒ</strong>ï¼Œç¡®ä¿æ¯ä¸ªå…ƒç´ çš„å–å€¼èŒƒå›´åœ¨
[0, 1] ä¹‹é—´ï¼Œå¹¶ä¸”æ‰€æœ‰å…ƒç´ çš„å’Œä¸º 1ã€‚å…¶æ•°å­¦å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><span class="math display">$$
\text{Softmax}(x_i) = \frac{e^{x_i}}{\sum_{j} e^{x_j}}
$$</span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="math inline"><em>x</em><sub><em>i</em></sub></span>
è¡¨ç¤ºè¾“å…¥å‘é‡ä¸­çš„ç¬¬ <span class="math inline"><em>i</em></span>
ä¸ªå…ƒç´ ã€‚</li>
<li><span class="math inline">Softmax(<em>x</em><sub><em>i</em></sub>)</span>
è¡¨ç¤ºè¾“å…¥ <span class="math inline"><em>x</em><sub><em>i</em></sub></span>
è½¬æ¢åçš„æ¦‚ç‡ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥æŠŠ Softmax
çœ‹ä½œä¸€ç§<strong>å½’ä¸€åŒ–çš„æŒ‡æ•°å˜æ¢</strong>ã€‚ç›¸æ¯”äºç®€å•çš„æ¯”ä¾‹å½’ä¸€åŒ– <span class="math inline">$\frac{x_i}{\sum_j x_j}$</span>, <strong>Softmax
é€šè¿‡æŒ‡æ•°å˜æ¢æ”¾å¤§æ•°å€¼é—´çš„å·®å¼‚ï¼Œè®©è¾ƒå¤§çš„å€¼å¯¹åº”æ›´é«˜çš„æ¦‚ç‡ï¼ŒåŒæ—¶é¿å…äº†è´Ÿå€¼å’Œæ•°å€¼è¿‡å°çš„é—®é¢˜ï¼Œè®©æ¨¡å‹èšç„¦äºæƒé‡æœ€é«˜çš„ä½ç½®</strong>ï¼ŒåŒæ—¶ä¿ç•™å…¨å±€ä¿¡æ¯ï¼ˆä½æƒé‡ä»éé›¶ï¼‰ã€‚</p>
<h3 id="æ³¨æ„åŠ›æœºåˆ¶">æ³¨æ„åŠ›æœºåˆ¶</h3>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1xS4y1k7tn?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ã€Attention
æ³¨æ„åŠ›æœºåˆ¶ã€‘æ¿€æƒ…å‘Šç™½transformerã€Bertã€GNNçš„ç²¾é«“_å“”å“©å“”å“©_bilibili</a></p>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808135811744.png" alt="image-20250808135811744">
<figcaption aria-hidden="true">image-20250808135811744</figcaption>
</figure>
<h4 id="ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶scaled-dot-product-attention"><strong>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled
Dot-Product Attentionï¼‰</strong></h4>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808140834132.png" alt="image-20250808140834132">
<figcaption aria-hidden="true">image-20250808140834132</figcaption>
</figure>
<p>Transformer çš„æ ¸å¿ƒæ˜¯<strong>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Head
Attentionï¼‰</strong>ï¼Œå®ƒèƒ½å¤Ÿæ•æ‰è¾“å…¥åºåˆ—ä¸­ä¸åŒä½ç½®ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶ä»å¤šä¸ªè§’åº¦å¯¹ä¿¡æ¯è¿›è¡Œå»ºæ¨¡ã€‚æ¨¡å—å°†è‡ªåº•å‘ä¸Šçš„è¿›è¡Œè®²è§£ï¼šåœ¨æ·±å…¥ç†è§£æ³¨æ„åŠ›æœºåˆ¶å‰ï¼Œé¦–å…ˆéœ€è¦ç†è§£è®ºæ–‡ä½¿ç”¨çš„<strong>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled
Dot-Product Attentionï¼‰</strong>ã€‚</p>
<p>ç»™å®šæŸ¥è¯¢çŸ©é˜µ <span class="math inline"><em>Q</em></span>ã€é”®çŸ©é˜µ
<span class="math inline"><em>K</em></span> å’Œå€¼çŸ©é˜µ <span class="math inline"><em>V</em></span>,
å…¶æ³¨æ„åŠ›è¾“å‡ºçš„æ•°å­¦è¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math display">$$
\text{Attention}(Q, K, V) = \text{Softmax}\left(\frac{Q
K^\top}{\sqrt{d_k}}\right) V
$$</span></p>
<ul>
<li><strong><span class="math inline"><em>Q</em></span>ï¼ˆQueryï¼‰</strong>:
ç”¨äºæŸ¥è¯¢çš„å‘é‡çŸ©é˜µã€‚</li>
<li><strong><span class="math inline"><em>K</em></span>ï¼ˆKeyï¼‰</strong>:
è¡¨ç¤ºé”®çš„å‘é‡çŸ©é˜µï¼Œç”¨äºä¸æŸ¥è¯¢åŒ¹é…ã€‚</li>
<li><strong><span class="math inline"><em>V</em></span>ï¼ˆValueï¼‰</strong>:
å€¼çŸ©é˜µï¼Œæ³¨æ„åŠ›æƒé‡æœ€ç»ˆä¼šä½œç”¨åœ¨è¯¥çŸ©é˜µä¸Šã€‚</li>
<li><strong><span class="math inline"><em>d</em><sub><em>k</em></sub></span></strong>:
é”®æˆ–æŸ¥è¯¢å‘é‡çš„ç»´åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç†è§£ Qã€Kã€V
çš„å…³é”®åœ¨äºä»£ç ï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯é€šè¿‡çº¿æ€§å˜æ¢ä»è¾“å…¥åºåˆ—ç”Ÿæˆçš„</p>
</blockquote>
<p>å…¬å¼è§£é‡Š</p>
<ol type="1">
<li><p><strong>ç‚¹ç§¯è®¡ç®—ï¼ˆDot Produceï¼‰</strong></p>
<p>å°†æŸ¥è¯¢çŸ©é˜µ <span class="math inline"><em>Q</em></span> ä¸é”®çŸ©é˜µçš„è½¬ç½®
<span class="math inline"><em>K</em><sup>âŠ¤</sup></span>
åšç‚¹ç§¯ï¼Œè®¡ç®—æ¯ä¸ªæŸ¥è¯¢å‘é‡ä¸æ‰€æœ‰é”®å‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼š</p>
<p><span class="math inline">$`\text{Scores} = Q K^\top`$</span></p>
<ul>
<li><strong>æ¯ä¸€è¡Œ</strong>è¡¨ç¤ºæŸä¸ªæŸ¥è¯¢ä¸æ‰€æœ‰é”®ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼ˆåŒ¹é…åˆ†æ•°ï¼‰ã€‚</li>
<li><strong>æ¯ä¸€åˆ—</strong>è¡¨ç¤ºæŸä¸ªé”®ä¸æ‰€æœ‰æŸ¥è¯¢ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼ˆåŒ¹é…åˆ†æ•°ï¼‰ã€‚</li>
</ul></li>
<li><p><strong>ç¼©æ”¾ï¼ˆScalingï¼‰</strong></p>
<p>å½“ <span class="math inline"><em>d</em><sub><em>k</em></sub></span>
è¾ƒå¤§æ—¶ï¼Œç‚¹ç§¯çš„æ•°å€¼å¯èƒ½ä¼šè¿‡å¤§ï¼Œå¯¼è‡´ Softmax è¿‡åçš„æ¢¯åº¦å˜å¾—æå°ï¼Œå› æ­¤é™¤ä»¥
<span class="math inline">$\sqrt{d_k}$</span>
ç¼©æ”¾ç‚¹ç§¯ç»“æœçš„æ•°å€¼èŒƒå›´ï¼š</p>
<p><span class="math inline">$`\text{Scaled Scores} = \frac{Q
K^\top}{\sqrt{d_k}}`$</span></p>
<p>ç¼©æ”¾åï¼ˆScaled Dot-Productï¼‰ä¹Ÿç§°ä¸ºæ³¨æ„åŠ›åˆ†æ•°ï¼ˆ<strong>attention
scores</strong>ï¼‰ã€‚</p></li>
<li><p><strong>Softmax å½’ä¸€åŒ–</strong></p>
<p>ä½¿ç”¨ Softmax å‡½æ•°å°†ç¼©æ”¾åçš„åˆ†æ•°è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼š</p>
<p><span class="math inline">$`\text{Attention Weights} =
\text{Softmax}\left(\frac{Q K^\top}{\sqrt{d_k}}\right)`$</span></p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šSoftmax
æ˜¯åœ¨æ¯ä¸€è¡Œä¸Šè¿›è¡Œçš„ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªæŸ¥è¯¢çš„åŒ¹é…åˆ†æ•°å°†å½’ä¸€åŒ–ä¸ºæ¦‚ç‡ï¼Œæ€»å’Œä¸º
1ã€‚</p>
</blockquote></li>
<li><p><strong>åŠ æƒæ±‚å’Œï¼ˆWeighted Sumï¼‰</strong></p>
<p>æœ€åï¼Œä½¿ç”¨å½’ä¸€åŒ–åçš„æ³¨æ„åŠ›æƒé‡å¯¹å€¼çŸ©é˜µ <span class="math inline"><em>V</em></span>
è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æ¯ä¸ªæŸ¥è¯¢ä½ç½®çš„æœ€ç»ˆè¾“å‡ºï¼š <span class="math inline">$`\text{Output} = \text{Attention Weights} \times
V`$</span></p></li>
</ol>
<h3 id="å•å¤´æ³¨æ„åŠ›æœºåˆ¶single-head-attention">å•å¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆSingle-Head
Attentionï¼‰</h3>
<p>å°†è¾“å…¥åºåˆ—ï¼ˆInputsï¼‰é€šè¿‡çº¿æ€§å˜æ¢ç”Ÿæˆ<strong>æŸ¥è¯¢çŸ©é˜µ</strong>ï¼ˆQuery,
Qï¼‰ã€<strong>é”®çŸ©é˜µ</strong>ï¼ˆKey, Kï¼‰å’Œ<strong>å€¼çŸ©é˜µ</strong>ï¼ˆValue,
Vï¼‰ï¼Œéšåæ‰§è¡Œ<strong>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›</strong>ï¼ˆScaled Dot-Product
Attentionï¼‰ã€‚</p>
<h4 id="æ©ç æ³¨æ„åŠ›æœºåˆ¶masked-attention">æ©ç æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMasked
Attentionï¼‰</h4>
<p>å¦‚æœä½¿ç”¨ mask æ©ç›–å°†è¦é¢„æµ‹çš„è¯æ±‡ï¼Œé‚£ä¹ˆ Attention å°±å»¶ä¼¸ä¸º Masked
Attention</p>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>mask</code>
çŸ©é˜µç”¨äºæŒ‡å®šå“ªäº›ä½ç½®åº”è¯¥è¢«é®è”½ï¼ˆå³å¡«å……ä¸º
-âˆï¼‰ï¼Œä»è€Œä¿è¯è¿™äº›ä½ç½®çš„æ³¨æ„åŠ›æƒé‡åœ¨ softmax
è¾“å‡ºä¸­æ¥è¿‘äºé›¶ã€‚æ³¨æ„ï¼Œæ©ç æœºåˆ¶å¹¶ä¸æ˜¯ç›´æ¥åœ¨æˆªæ–­è¾“å…¥åºåˆ—ï¼Œä¹Ÿä¸æ˜¯åœ¨ç®—åˆ†æ•°çš„æ—¶å€™å°±æ’é™¤ä¸åº”è¯¥çœ‹åˆ°çš„ä½ç½®ï¼Œå› ä¸ºçœ‹åˆ°ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œä¸ä¼šå½±å“ä¸å…¶ä»–ä½ç½®çš„åˆ†æ•°ï¼Œæ‰€ä»¥åœ¨ä¼ å…¥
Softmaxï¼ˆè®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼‰ä¹‹å‰æ’é™¤å°±å¯ä»¥äº†ã€‚</p>
<p>å¦å¤–ï¼Œæ ¹æ®è¾“å…¥æ•°æ®çš„æ¥æºï¼Œè¿˜å¯ä»¥å°†æ³¨æ„åŠ›åˆ†ä¸º<strong>è‡ªæ³¨æ„åŠ›ï¼ˆSelf-Attentionï¼‰å’Œäº¤å‰æ³¨æ„åŠ›ï¼ˆCross-Attention)</strong>ã€‚</p>
<h4 id="è‡ªæ³¨æ„åŠ›æœºåˆ¶self-attention">è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-attentionï¼‰</h4>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808142109091.png" alt="image-20250808142109091">
<figcaption aria-hidden="true">image-20250808142109091</figcaption>
</figure>
<p>Transformer
æ¨¡å‹æ¶æ„ä½¿ç”¨åˆ°äº†ä¸‰ä¸ªçœ‹èµ·æ¥ä¸åŒçš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œæˆ‘ä»¬ç»§ç»­å¿½è§†å…±æœ‰çš„
Multi-Headã€‚è§‚å¯Ÿè¾“å…¥ï¼Œçº¿æ¡ä¸€åˆ†ä¸ºä¸‰ä¼ å…¥ Attention
æ¨¡å—ï¼Œè¿™æ„å‘³ç€æŸ¥è¯¢ï¼ˆqueryï¼‰ã€é”®ï¼ˆkeyï¼‰å’Œå€¼ï¼ˆvalueï¼‰å®é™…ä¸Šéƒ½æ¥è‡ª<strong>åŒä¸€è¾“å…¥åºåˆ—
<span class="math inline"><strong>X</strong></span></strong>ï¼Œæ•°å­¦è¡¨è¾¾å¦‚ä¸‹ï¼š</p>
<p><span class="math display"><em>Q</em>â€„=â€„<em>X</em><em>W</em><sup><em>Q</em></sup>,â€Šâ€<em>K</em>â€„=â€„<em>X</em><em>W</em><sup><em>K</em></sup>,â€Šâ€<em>V</em>â€„=â€„<em>X</em><em>W</em><sup><em>V</em></sup></span></p>
<ul>
<li><strong><span class="math inline"><em>W</em><sup><em>Q</em></sup>,â€†<em>W</em><sup><em>K</em></sup>,â€†<em>W</em><sup><em>V</em></sup></span></strong>ï¼šå¯è®­ç»ƒçš„çº¿æ€§å˜æ¢æƒé‡ï¼Œå®é™…ä¸Šå°±æ˜¯ç®€å•çš„çº¿æ€§å±‚</li>
</ul>
<h4 id="äº¤å‰æ³¨æ„åŠ›æœºåˆ¶cross-attention">äº¤å‰æ³¨æ„åŠ›æœºåˆ¶ï¼ˆCross-Attentionï¼‰</h4>
<p>åœ¨ Transformer è§£ç å™¨ä¸­ï¼Œé™¤äº†è‡ªæ³¨æ„åŠ›å¤–ï¼Œè¿˜ä½¿ç”¨äº†
<strong>äº¤å‰æ³¨æ„åŠ›ï¼ˆCross-Attentionï¼‰</strong>ã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè§£ç å™¨ï¼ˆå³ï¼‰åœ¨è‡ªåº•å‘ä¸Šçš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå…ˆæ‰§è¡Œè‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œç„¶åé€šè¿‡äº¤å‰æ³¨æ„åŠ›ä»ç¼–ç å™¨çš„è¾“å‡ºä¸­è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808142428374.png" alt="image-20250808142428374">
<figcaption aria-hidden="true">image-20250808142428374</figcaption>
</figure>
<p>æ•°å­¦è¡¨è¾¾å¦‚ä¸‹ï¼š</p>
<p><span class="math display"><em>Q</em>â€„=â€„<em>X</em><sub>decoder</sub><em>W</em><sup><em>Q</em></sup>,â€Šâ€<em>K</em>â€„=â€„<em>X</em><sub>encoder</sub><em>W</em><sup><em>K</em></sup>,â€Šâ€<em>V</em>â€„=â€„<em>X</em><sub>encoder</sub><em>W</em><sup><em>V</em></sup></span></p>
<h4 id="å¯¹æ¯”å­¦ä¹ ">å¯¹æ¯”å­¦ä¹ </h4>
<p><strong>Masked Attention</strong>ã€<strong>Self-Attention</strong> å’Œ
<strong>Cross-Attention</strong>
çš„æœ¬è´¨æ˜¯ä¸€è‡´çš„ï¼Œè¿™ä¸€ç‚¹ä»ä»£ç è°ƒç”¨å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸‰è€…çš„åŒºåˆ«åœ¨äºæœªæ¥æ©ç çš„ä½¿ç”¨å’Œè¾“å…¥æ•°æ®çš„æ¥æºï¼š</p>
<ul>
<li><p><strong>Masked
Attention</strong>ï¼šç”¨äºè§£ç è¿‡ç¨‹ï¼Œé€šè¿‡æ©ç å±è”½æœªæ¥çš„æ—¶é—´æ­¥ï¼Œç¡®ä¿æ¨¡å‹åªèƒ½åŸºäºå·²ç”Ÿæˆçš„éƒ¨åˆ†è¿›è¡Œé¢„æµ‹ï¼Œè®ºæ–‡ä¸­è§£ç å™¨éƒ¨åˆ†çš„ç¬¬ä¸€ä¸ª
Attention ä½¿ç”¨çš„æ˜¯ Masked Self-Attentionã€‚</p></li>
<li><p><strong>Self-Attention</strong>ï¼šæŸ¥è¯¢ã€é”®å’Œå€¼çŸ©é˜µæ¥è‡ªåŒä¸€è¾“å…¥åºåˆ—ï¼Œæ¨¡å‹é€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶å­¦ä¹ è¾“å…¥åºåˆ—çš„å…¨å±€ä¾èµ–å…³ç³»ã€‚</p></li>
<li><p><strong>Cross-Attention</strong>ï¼šæŸ¥è¯¢çŸ©é˜µæ¥è‡ªè§£ç å™¨çš„è¾“å…¥ï¼Œè€Œé”®å’Œå€¼çŸ©é˜µæ¥è‡ªç¼–ç å™¨çš„è¾“å‡ºï¼Œè§£ç å™¨çš„ç¬¬äºŒä¸ª
Attention æ¨¡å—å°±æ˜¯
Cross-Attentionï¼Œç”¨äºä»ç¼–ç å™¨è¾“å‡ºä¸­è·å–ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<ul>
<li><p>ä»¥<strong>æœºå™¨ç¿»è¯‘</strong>ä¸­çš„<strong>ä¸­è¯‘è‹±ä»»åŠ¡</strong>ä¸ºä¾‹ï¼šå¯¹äºä¸­æ–‡å¥å­â€œ<strong>ä¸­å›½çš„é¦–éƒ½æ˜¯åŒ—äº¬</strong>â€ï¼Œå‡è®¾æ¨¡å‹å·²ç»ç”Ÿæˆäº†éƒ¨åˆ†è¯‘æ–‡â€œThe
capital of China isâ€ï¼Œæ­¤æ—¶éœ€è¦é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€‚</p>
<p>åœ¨è¿™ä¸€é˜¶æ®µï¼Œ<strong>è§£ç å™¨ä¸­çš„äº¤å‰æ³¨æ„åŠ›æœºåˆ¶</strong>ä¼šä½¿ç”¨<strong>å½“å‰å·²ç”Ÿæˆçš„è¯‘æ–‡â€œThe
capital of China
isâ€çš„ç¼–ç è¡¨ç¤ºä½œä¸ºæŸ¥è¯¢</strong>ï¼Œå¹¶å°†<strong>ç¼–ç å™¨å¯¹è¾“å…¥å¥å­â€œä¸­å›½çš„é¦–éƒ½æ˜¯åŒ—äº¬â€ç¼–ç è¡¨ç¤º</strong>ä½œä¸º<strong>é”®</strong>å’Œ<strong>å€¼</strong>ï¼Œé€šè¿‡è®¡ç®—<strong>æŸ¥è¯¢ä¸é”®ä¹‹é—´çš„åŒ¹é…ç¨‹åº¦</strong>ï¼Œç”Ÿæˆç›¸åº”çš„æ³¨æ„åŠ›æƒé‡ï¼Œä»¥æ­¤ä»å€¼ä¸­æå–ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŸºäºè¿™äº›ä¿¡æ¯ç”Ÿæˆä¸‹ä¸€ä¸ªå¯èƒ½çš„å•è¯ï¼ˆtokenï¼‰ï¼Œæ¯”å¦‚ï¼šâ€œBeijingâ€ã€‚</p></li>
</ul></li>
</ul>
<h3 id="å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶multi-head-attention">å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Head
Attentionï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808143810965.png" alt="image-20250808143810965">
<figcaption aria-hidden="true">image-20250808143810965</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808143822630.png" alt="image-20250808143822630">
<figcaption aria-hidden="true">image-20250808143822630</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808143845681.png" alt="image-20250808143845681">
<figcaption aria-hidden="true">image-20250808143845681</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808145725202.png" alt="image-20250808145725202">
<figcaption aria-hidden="true">image-20250808145725202</figcaption>
</figure>
<p>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å°±æ˜¯å­˜åœ¨å¤šä¸ªä¸åŒçš„æƒé‡çŸ©é˜µï¼Œå½¢æˆå¤šä¸ªçŸ©é˜µZï¼Œå†æŠŠå®ƒä»¬
<strong>æŒ‰æœ€åä¸€ç»´ï¼ˆhiddenï¼‰æ‹¼æ¥ï¼ˆconcatï¼‰â†’ åšä¸€æ¬¡çº¿æ€§å˜æ¢</strong>
å¾—åˆ°æœ€ç»ˆè¾“å‡ºã€‚</p>
<blockquote>
<p>çº¿æ€§bianâ€™hæŠŠæ‹¼æ¥åçš„å¤šå¤´ç»“æœ <code>Z_concat</code>ï¼ˆå½¢çŠ¶
batchÃ—seqÃ—d_modelï¼‰é‡æ–°<strong>çº¿æ€§æ˜ å°„</strong>å›ä¸è¾“å…¥ç›¸åŒçš„ç»´åº¦ï¼ŒåŒæ—¶è®©ç½‘ç»œå¯ä»¥<strong>å­¦ä¹ å¦‚ä½•èåˆä¸åŒå¤´çš„ä¿¡æ¯</strong>ã€‚</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1MY41137AK?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">ã€Transformeræ¨¡å‹ã€‘æ›¼å¦™åŠ¨ç”»è½»æ¾å­¦ï¼Œå½¢è±¡æ¯”å–»è´¼å¥½è®°_å“”å“©å“”å“©_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1HsTyz8ECC?spm_id_from=333.788.player.switch&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">TransformeråŸç†åŠæ¶æ„ï¼šå¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶_å“”å“©å“”å“©_bilibili</a></p>
<h3 id="æ®‹å·®è¿æ¥residual-connectionå’Œå±‚å½’ä¸€åŒ–layer-normalization-layernorm">æ®‹å·®è¿æ¥ï¼ˆResidual
Connectionï¼‰å’Œå±‚å½’ä¸€åŒ–ï¼ˆLayer Normalization, LayerNormï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808150313758.png" alt="image-20250808150313758">
<figcaption aria-hidden="true">image-20250808150313758</figcaption>
</figure>
<p>åœ¨ Transformer æ¶æ„ä¸­ï¼Œ<strong>æ®‹å·®è¿æ¥</strong>ï¼ˆResidual
Connectionï¼‰ä¸<strong>å±‚å½’ä¸€åŒ–</strong>ï¼ˆLayerNormï¼‰ç»“åˆä½¿ç”¨ï¼Œç»Ÿç§°ä¸º
<strong>Add &amp; Norm</strong> æ“ä½œã€‚</p>
<h4 id="addæ®‹å·®è¿æ¥residual-connection">Addï¼ˆæ®‹å·®è¿æ¥ï¼ŒResidual
Connectionï¼‰</h4>
<p>æ®‹å·®è¿æ¥æ˜¯ä¸€ç§è·³è·ƒè¿æ¥ï¼ˆSkip
Connectionï¼‰ï¼Œå®ƒå°†å±‚çš„è¾“å…¥ç›´æ¥åŠ åˆ°è¾“å‡ºä¸Šï¼ˆè§‚å¯Ÿæ¶æ„å›¾ä¸­çš„ç®­å¤´ï¼‰ï¼Œå¯¹åº”çš„å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math display">Outputâ€„=â€„SubLayer(<em>x</em>)â€…+â€…<em>x</em></span></p>
<p>è¿™ç§è¿æ¥æ–¹å¼æœ‰æ•ˆç¼“è§£äº†<strong>æ·±å±‚ç¥ç»ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±</strong>é—®é¢˜ã€‚</p>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250808151004667.png" alt="image-20250808151004667">
<figcaption aria-hidden="true">image-20250808151004667</figcaption>
</figure>
<p>åœ¨transformä¸­ï¼Œå°±æ˜¯è¾“å…¥çš„çŸ©é˜µxåŠ ä¸Šç»è¿‡æ³¨æ„åŠ›æœºåˆ¶è®¡ç®—å‡ºæ¥çš„zçŸ©é˜µ</p>
<h4 id="normå±‚å½’ä¸€åŒ–layer-normalization">Normï¼ˆå±‚å½’ä¸€åŒ–ï¼ŒLayer
Normalizationï¼‰</h4>
<p><strong>å±‚å½’ä¸€åŒ–</strong>ï¼ˆLayerNormï¼‰æ˜¯ä¸€ç§å½’ä¸€åŒ–æŠ€æœ¯ï¼Œç”¨äºæå‡è®­ç»ƒçš„ç¨³å®šæ€§å’Œæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p>
<p>å‡è®¾è¾“å…¥å‘é‡ä¸º <span class="math inline"><em>x</em>â€„=â€„(<em>x</em><sub>1</sub>,â€†<em>x</em><sub>2</sub>,â€†â€¦,â€†<em>x</em><sub><em>d</em></sub>)</span>,
LayerNorm çš„è®¡ç®—æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><p><strong>è®¡ç®—å‡å€¼å’Œæ–¹å·®</strong>ï¼š å¯¹è¾“å…¥çš„æ‰€æœ‰ç‰¹å¾æ±‚å‡å€¼ <span class="math inline"><em>Î¼</em></span> å’Œæ–¹å·® <span class="math inline"><em>Ïƒ</em><sup>2</sup></span>ï¼š</p>
<p><span class="math inline">$`
\mu = \frac{1}{d} \sum_{j=1}^{d} x_j, \quad
\sigma^2 = \frac{1}{d} \sum_{j=1}^{d} (x_j - \mu)^2
`$</span></p></li>
<li><p><strong>å½’ä¸€åŒ–å…¬å¼</strong>ï¼š å°†è¾“å…¥ç‰¹å¾ <span class="math inline"><em>xÌ‚</em><sub><em>i</em></sub></span>
è¿›è¡Œå½’ä¸€åŒ–ï¼š</p>
<p><span class="math inline">$`
\hat{x}_i = \frac{x_i - \mu}{\sqrt{\sigma^2 + \epsilon}}
`$</span></p>
<p>å…¶ä¸­, <span class="math inline"><em>Ïµ</em></span>
æ˜¯ä¸€ä¸ªå¾ˆå°çš„å¸¸æ•°ï¼ˆæ¯”å¦‚ 1e-9ï¼‰ï¼Œç”¨äºé˜²æ­¢é™¤ä»¥é›¶çš„æƒ…å†µã€‚</p></li>
<li><p><strong>å¼•å…¥å¯å­¦ä¹ å‚æ•°</strong>ï¼š å½’ä¸€åŒ–åçš„è¾“å‡ºä¹˜ä»¥ <span class="math inline"><em>Î³</em></span> å¹¶åŠ ä¸Š <span class="math inline"><em>Î²</em></span>, å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><span class="math inline">$`
\text{Output} = \gamma \hat{x} + \beta
`$</span></p>
<p>å…¶ä¸­ <span class="math inline"><em>Î³</em></span> å’Œ <span class="math inline"><em>Î²</em></span>
æ˜¯å¯å­¦ä¹ çš„å‚æ•°ï¼Œç”¨äºè¿›ä¸€æ­¥è°ƒæ•´å½’ä¸€åŒ–åçš„è¾“å‡ºã€‚</p></li>
</ol>
<h3 id="å‰é¦ˆç¥ç»ç½‘ç»œ-position-wise-feed-forward-networksffn">å‰é¦ˆç¥ç»ç½‘ç»œ
Position-wise Feed-Forward Networksï¼ˆFFNï¼‰</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20251220191959727.png" alt="image-20251220191959727">
<figcaption aria-hidden="true">image-20251220191959727</figcaption>
</figure>
<p>åœ¨ Transformer ä¸­ï¼Œå‰é¦ˆç½‘ç»œå±‚ï¼ˆFeed-Forward
Networkï¼ŒFFNï¼‰çš„ä½œç”¨å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€å¥è¯ï¼š
<strong>â€œå¯¹æ¯ä¸ªä½ç½®çš„å‘é‡è¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œå¢åŠ æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚â€</strong></p>
<p>åœ¨ç¼–ç å™¨-è§£ç å™¨æ¶æ„ä¸­ï¼Œå¦ä¸€ä¸ªçœ‹èµ·æ¥â€œå¤§ä¸€ç‚¹â€çš„æ¨¡å—å°±æ˜¯ Feed
Forwardï¼Œå®ƒåœ¨æ¯ä¸ªä½ç½® <span class="math inline"><em>i</em></span>
ä¸Šçš„è®¡ç®—å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p>
<p><span class="math display">FFN(<em>x</em><sub><em>i</em></sub>)â€„=â€„max(0,â€†<em>x</em><sub><em>i</em></sub><em>W</em><sub>1</sub>â€…+â€…<em>b</em><sub>1</sub>)<em>W</em><sub>2</sub>â€…+â€…<em>b</em><sub>2</sub></span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="math inline"><em>x</em><sub><em>i</em></sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>model</sub></sup></span>
è¡¨ç¤ºç¬¬ <span class="math inline"><em>i</em></span>
ä¸ªä½ç½®çš„è¾“å…¥å‘é‡ã€‚</li>
<li><span class="math inline"><em>W</em><sub>1</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>model</sub>â€…Ã—â€…<em>d</em><sub>ff</sub></sup></span>
å’Œ <span class="math inline"><em>W</em><sub>2</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>ff</sub>â€…Ã—â€…<em>d</em><sub>model</sub></sup></span>
æ˜¯ä¸¤ä¸ªçº¿æ€§å˜æ¢çš„æƒé‡çŸ©é˜µã€‚</li>
<li><span class="math inline"><em>b</em><sub>1</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>ff</sub></sup></span>
å’Œ <span class="math inline"><em>b</em><sub>2</sub>â€„âˆˆâ€„â„<sup><em>d</em><sub>model</sub></sup></span>
æ˜¯å¯¹åº”çš„åç½®å‘é‡ã€‚</li>
<li><span class="math inline">max(0,â€†â‹…)</span> æ˜¯ <strong>ReLU
æ¿€æ´»å‡½æ•°</strong>ï¼Œç”¨äºå¼•å…¥éçº¿æ€§ã€‚</li>
</ul>
<h3 id="å¤§æ¨¡å‹å‘å±•æ ‘">å¤§æ¨¡å‹å‘å±•æ ‘</h3>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807171237889.png" alt="image-20250807171237889">
<figcaption aria-hidden="true">image-20250807171237889</figcaption>
</figure>
<figure>
<img src="/2025/07/28/%E5%AD%A6%E4%B9%A0/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AE%97%E6%B3%95/Transformer%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/image-20250807173520481.png" alt="image-20250807173520481">
<figcaption aria-hidden="true">image-20250807173520481</figcaption>
</figure>
<h3 id="é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹">é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹</h3>
<p>é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼ˆPLMï¼‰æ˜¯ä¸€ç§é€šè¿‡å¤§é‡æ–‡æœ¬æ•°æ®è¿›è¡Œæ— ç›‘ç£æˆ–å¼±ç›‘ç£è®­ç»ƒçš„è¯­è¨€æ¨¡å‹ï¼Œç›®çš„æ˜¯å­¦ä¹ è¯­è¨€çš„é€šç”¨è¡¨ç¤ºï¼ˆå³è¯­è¨€çš„æ¨¡å¼ã€è¯­æ³•ã€è¯­ä¹‰ç­‰ï¼‰ã€‚è¿™äº›æ¨¡å‹é€šå¸¸åœ¨å¤§è§„æ¨¡æ–‡æœ¬æ•°æ®ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œç„¶åå¯ä»¥è¢«å¾®è°ƒï¼ˆFine
- tuningï¼‰ä»¥é€‚åº”å„ç§ä¸‹æ¸¸ä»»åŠ¡ï¼Œå¦‚æ–‡æœ¬åˆ†ç±»ã€é—®ç­”ã€å‘½åå®ä½“è¯†åˆ«ç­‰ã€‚</p>
<p>é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨å¤§é‡çš„æ— æ ‡æ³¨æ–‡æœ¬æ•°æ®æ¥å­¦ä¹ è¯­è¨€çš„é€šç”¨ç‰¹å¾ï¼Œä»è€Œä¸ºå„ç§è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡æä¾›å¼ºå¤§çš„è¯­è¨€ç†è§£èƒ½åŠ›ã€‚é¢„è®­ç»ƒæ¨¡å‹å¯ä»¥æ˜¾è‘—æé«˜ä»»åŠ¡çš„æ€§èƒ½ï¼Œå‡å°‘å¯¹æ ‡æ³¨æ•°æ®çš„ä¾èµ–ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¿«é€Ÿé€‚åº”æ–°çš„ä»»åŠ¡ã€‚</p>
<h4 id="bertæ¨¡å‹encoder-only-plm">BERTæ¨¡å‹ï¼ˆEncoder-only PLMï¼‰</h4>
<p>é’ˆå¯¹ Encoderã€Decoder çš„ç‰¹ç‚¹ï¼Œå¼•å…¥ ELMo
çš„é¢„è®­ç»ƒæ€è·¯ï¼Œå¼€å§‹å‡ºç°ä¸åŒçš„ã€å¯¹ Transformer
è¿›è¡Œä¼˜åŒ–çš„æ€è·¯ã€‚ä¾‹å¦‚ï¼Œ<strong>Google ä»…é€‰æ‹©äº† Encoder
å±‚</strong>ï¼Œé€šè¿‡å°† Encoder
å±‚è¿›è¡Œå †å ï¼Œå†æå‡ºä¸åŒçš„é¢„è®­ç»ƒä»»åŠ¡-æ©ç è¯­è¨€æ¨¡å‹ï¼ˆMasked Language
Modelï¼ŒMLMï¼‰ï¼Œæ‰“é€ äº†ä¸€ç»Ÿè‡ªç„¶è¯­è¨€ç†è§£ï¼ˆNatural Language
Understandingï¼ŒNLUï¼‰ä»»åŠ¡çš„ä»£è¡¨æ¨¡å‹â€”â€”<strong>BERT</strong>ã€‚</p>
<p>BERTï¼Œå…¨åä¸º Bidirectional Encoder Representations from
Transformersï¼Œæ˜¯ç”± Google å›¢é˜Ÿåœ¨
2018å¹´å‘å¸ƒçš„é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ã€‚è¯¥æ¨¡å‹å‘å¸ƒäºè®ºæ–‡ã€ŠBERT: Pre-training of Deep
Bidirectional Transformers for Language Understandingã€‹ï¼Œå®ç°äº†åŒ…æ‹¬
GLUEã€MultiNLI ç­‰ä¸ƒä¸ªè‡ªç„¶è¯­è¨€å¤„ç†è¯„æµ‹ä»»åŠ¡çš„æœ€ä¼˜æ€§èƒ½ï¼ˆState Of The
Artï¼ŒSOTAï¼‰ï¼Œå ªç§°é‡Œç¨‹ç¢‘å¼çš„æˆæœã€‚</p>
<h4 id="t5encoder-decoder-plm">T5ï¼ˆEncoder-Decoder PLMï¼‰</h4>
<p>BERT ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ MLM
ä»»åŠ¡å’Œä¸‹æ¸¸ä»»åŠ¡å¾®è°ƒçš„ä¸ä¸€è‡´æ€§ï¼Œä»¥åŠæ— æ³•å¤„ç†è¶…è¿‡æ¨¡å‹è®­ç»ƒé•¿åº¦çš„è¾“å…¥ç­‰é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œç ”ç©¶è€…ä»¬æå‡ºäº†
<strong>Encoder-Decoder æ¨¡å‹</strong>ï¼Œé€šè¿‡å¼•å…¥ Decoder
éƒ¨åˆ†æ¥è§£å†³è¿™äº›é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿä¸º NLP é¢†åŸŸå¸¦æ¥äº†æ–°çš„æ€è·¯å’Œæ–¹æ³•ã€‚</p>
<p><strong>T5ï¼ˆText-To-Text Transfer Transformerï¼‰æ˜¯ç”± Google
æå‡ºçš„ä¸€ç§é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹</strong>ï¼Œé€šè¿‡å°†æ‰€æœ‰ NLP
ä»»åŠ¡ç»Ÿä¸€è¡¨ç¤ºä¸ºæ–‡æœ¬åˆ°æ–‡æœ¬çš„è½¬æ¢é—®é¢˜ï¼Œå¤§å¤§ç®€åŒ–äº†æ¨¡å‹è®¾è®¡å’Œä»»åŠ¡å¤„ç†ã€‚T5
åŸºäº Transformer
æ¶æ„ï¼ŒåŒ…å«ç¼–ç å™¨å’Œè§£ç å™¨ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä½¿ç”¨è‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œå¤šå¤´æ³¨æ„åŠ›æ•æ‰å…¨å±€ä¾èµ–å…³ç³»ï¼Œåˆ©ç”¨ç›¸å¯¹ä½ç½®ç¼–ç å¤„ç†é•¿åºåˆ—ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œå¹¶åœ¨æ¯å±‚ä¸­åŒ…å«å‰é¦ˆç¥ç»ç½‘ç»œè¿›ä¸€æ­¥å¤„ç†ç‰¹å¾ã€‚</p>
<h4 id="llamaæ¨¡å‹decoder-only-plm">LLamaæ¨¡å‹ï¼ˆDecoder-Only PLMï¼‰</h4>
<p>LLaMAæ¨¡å‹æ˜¯ç”±Metaï¼ˆå‰Facebookï¼‰å¼€å‘çš„ä¸€ç³»åˆ—å¤§å‹é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ã€‚ä»LLaMA-1åˆ°LLaMA-3ï¼ŒLLaMAç³»åˆ—æ¨¡å‹å±•ç¤ºäº†å¤§è§„æ¨¡é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„æ¼”è¿›åŠå…¶åœ¨å®é™…åº”ç”¨ä¸­çš„æ˜¾è‘—æ½œåŠ›ã€‚</p>
<h4 id="gptæ¨¡å‹decoder-only-plm">GPTæ¨¡å‹ï¼ˆDecoder-Only PLMï¼‰</h4>
<p>GPTï¼Œå³ Generative Pre-Training Language Modelï¼Œæ˜¯ç”± OpenAI å›¢é˜Ÿäº
2018å¹´å‘å¸ƒçš„é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ã€‚è™½ç„¶å­¦ç•Œæ™®éè®¤å¯ BERT
ä½œä¸ºé¢„è®­ç»ƒè¯­è¨€æ¨¡å‹æ—¶ä»£çš„ä»£è¡¨ï¼Œä½†é¦–å…ˆæ˜ç¡®æå‡º<strong>é¢„è®­ç»ƒ-å¾®è°ƒæ€æƒ³çš„æ¨¡å‹</strong>å…¶å®æ˜¯
GPTã€‚</p>
<p>GPT
æå‡ºäº†é€šç”¨é¢„è®­ç»ƒçš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯åœ¨æµ·é‡æ— ç›‘ç£è¯­æ–™ä¸Šé¢„è®­ç»ƒï¼Œè¿›è€Œåœ¨æ¯ä¸ªç‰¹å®šä»»åŠ¡ä¸Šè¿›è¡Œå¾®è°ƒï¼Œä»è€Œå®ç°è¿™äº›ä»»åŠ¡çš„å·¨å¤§æ”¶ç›Šã€‚è™½ç„¶åœ¨å‘å¸ƒä¹‹åˆï¼Œç”±äºæ€§èƒ½ç•¥è¾“äºä¸ä¹…åå‘å¸ƒçš„
BERTï¼Œæ²¡èƒ½å–å¾—è½°åŠ¨æ€§æˆæœï¼Œä¹Ÿæ²¡èƒ½è®© GPT æ‰€ä½¿ç”¨çš„ <strong>Decoder-Only
æ¶æ„</strong>æˆä¸ºå­¦ç•Œç ”ç©¶çš„ä¸»æµï¼Œä½† OpenAI
å›¢é˜Ÿåšå®šåœ°é€‰æ‹©äº†ä¸æ–­æ‰©å¤§é¢„è®­ç»ƒæ•°æ®ã€å¢åŠ æ¨¡å‹å‚æ•°ï¼Œåœ¨ GPT
æ¶æ„ä¸Šä¸æ–­ä¼˜åŒ–ï¼Œæœ€ç»ˆåœ¨ 2020å¹´å‘å¸ƒçš„ GPT-3 æˆå°±äº† LLM æ—¶ä»£çš„åŸºç¡€ï¼Œå¹¶ä»¥
GPT-3 ä¸ºåŸºåº§æ¨¡å‹çš„ ChatGPT æˆåŠŸæ‰“å¼€æ–°æ—¶ä»£çš„å¤§é—¨ï¼Œæˆä¸º LLM
æ—¶ä»£çš„æœ€å¼ºç«äº‰è€…ä¹Ÿæ˜¯ç›®å‰çš„æœ€å¤§èµ¢å®¶ã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://transformers.run/">Hello! Â·
Transformerså¿«é€Ÿå…¥é—¨</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/jsksxs360/How-to-use-Transformers">jsksxs360/How-to-use-Transformers:
Transformers åº“å¿«é€Ÿå…¥é—¨æ•™ç¨‹</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Hoper-J/AI-Guide-and-Demos-zh_CN">Hoper-J/AI-Guide-and-Demos-zh_CN:
è¿™æ˜¯ä¸€ä»½å…¥é—¨AI/LLMå¤§æ¨¡å‹çš„é€æ­¥æŒ‡å—ï¼ŒåŒ…å«æ•™ç¨‹å’Œæ¼”ç¤ºä»£ç ï¼Œå¸¦ä½ ä»APIèµ°è¿›æœ¬åœ°å¤§æ¨¡å‹éƒ¨ç½²å’Œå¾®è°ƒï¼Œä»£ç æ–‡ä»¶ä¼šæä¾›Kaggleæˆ–Colabåœ¨çº¿ç‰ˆæœ¬ï¼Œå³ä¾¿æ²¡æœ‰æ˜¾å¡ä¹Ÿå¯ä»¥è¿›è¡Œå­¦ä¹ ã€‚é¡¹ç›®ä¸­è¿˜å¼€è®¾äº†ä¸€ä¸ªå°å‹çš„ä»£ç æ¸¸ä¹åœºğŸ¡ï¼Œä½ å¯ä»¥å°è¯•åœ¨é‡Œé¢å®éªŒä¸€äº›æœ‰æ„æ€çš„AIè„šæœ¬ã€‚åŒæ—¶ï¼ŒåŒ…å«æå®æ¯…
(HUNG-YI LEEï¼‰2024ç”Ÿæˆå¼äººå·¥æ™ºèƒ½å¯¼è®ºè¯¾ç¨‹çš„å®Œæ•´ä¸­æ–‡é•œåƒä½œä¸šã€‚</a></p>
<p><a target="_blank" rel="noopener" href="https://datawhalechina.github.io/happy-llm/#/">Happy-LLM</a></p>
<p><a target="_blank" rel="noopener" href="https://gengzhige.ai/video.html">æ¢—ç›´å“¥</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1RBdTYxENw/?spm_id_from=333.788.videopod.sections&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">90%äººä¸çŸ¥é“çš„LLMé»‘ç§‘æŠ€ï¼šæ‹†è§£Transformerå¦‚ä½•åƒé€å…¨ç½‘çŸ¥è¯†ï¼_å“”å“©å“”å“©_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1k6yWBEEmH/?spm_id_from=333.1387.homepage.video_card.click&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">Transformerå¦‚ä½•æˆä¸ºAIæ¨¡å‹çš„åœ°åŸº_å“”å“©å“”å“©_bilibili</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/27/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/27/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">MCP å­¦ä¹ ç¬”è®°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-27 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-27T00:00:00+08:00">2025-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-15 09:25:54" itemprop="dateModified" datetime="2025-08-15T09:25:54+08:00">2025-08-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mcp/" itemprop="url" rel="index"><span itemprop="name">mcp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ä»€ä¹ˆæ˜¯-mcp">ä»€ä¹ˆæ˜¯ MCPï¼Ÿ</h3>
<ul>
<li><strong>å…¨ç§°</strong>ï¼šModel Context Protocol</li>
<li><strong>ä½œç”¨</strong>ï¼šè®© AI åŠ©æ‰‹ï¼ˆå¦‚ Claudeã€Cline
ç­‰ï¼‰åœ¨å¯¹è¯è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼ˆToolï¼‰å®Œæˆå¤æ‚ä»»åŠ¡ï¼ˆè¯»å†™æ–‡ä»¶ã€æŸ¥è¯¢æ•°æ®åº“ã€è°ƒç”¨
API ç­‰ï¼‰ã€‚</li>
<li><strong>ç»„æˆ</strong>ï¼š
<ol type="1">
<li><strong>MCP Host</strong>ï¼ˆå®¿ä¸»ï¼Œå¦‚ Clineã€Claude Desktopï¼‰</li>
<li><strong>MCP Server</strong>ï¼ˆæä¾› Tool çš„åå°æœåŠ¡ï¼‰</li>
<li><strong>Tool</strong>ï¼ˆå…·ä½“åŠŸèƒ½å•å…ƒï¼Œå¦‚ <code>read_file</code>,
<code>exec_command</code> ç­‰ï¼‰</li>
</ol></li>
</ul>
<h3 id="æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°">æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°</h3>
<ul>
<li><strong>MCP Server</strong>
<ul>
<li>ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œæä¾› 1-N ä¸ª Toolã€‚</li>
<li>å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ç¼–å†™ï¼Œåªè¦æš´éœ²æ ‡å‡† MCP æ¥å£ã€‚</li>
</ul></li>
<li><strong>Tool</strong>
<ul>
<li>æœ€å°æ‰§è¡Œå•å…ƒï¼Œå¿…é¡»åŒ…å«ï¼š
<ul>
<li>nameï¼ˆå”¯ä¸€ï¼‰</li>
<li>descriptionï¼ˆè®© LLM ç†è§£ä½•æ—¶è°ƒç”¨ï¼‰</li>
<li>input schemaï¼ˆå‚æ•°ç»“æ„ï¼ŒJSON Schemaï¼‰</li>
</ul></li>
</ul></li>
<li><strong>äº¤äº’æµç¨‹ï¼ˆé‡ç‚¹ï¼‰</strong>
<ul>
<li>åœ¨å¯åŠ¨mcp serveræ—¶ï¼Œserverå°†toolä¿¡æ¯ä¼ é€ç»™host</li>
<li>ç”¨æˆ·åœ¨ Host è¾“å…¥è‡ªç„¶è¯­è¨€éœ€æ±‚ã€‚</li>
<li>Host å°†éœ€æ±‚ + å¯ç”¨ Tool åˆ—è¡¨å‘ç»™ LLMã€‚</li>
<li>LLM åˆ¤æ–­è°ƒç”¨å“ªä¸ª Toolï¼Œå¹¶å¡«å……å‚æ•°ã€‚</li>
<li>Host é€šè¿‡ MCP åè®®å‘å¯¹åº” Server å‘é€è¯·æ±‚ã€‚</li>
<li>Server æ‰§è¡Œ Tool å¹¶è¿”å›ç»“æœã€‚</li>
<li>Host å°†ç»“æœåˆå¹¶ä¸Šä¸‹æ–‡ï¼Œç»§ç»­å¯¹è¯ã€‚</li>
</ul></li>
</ul>
<h3 id="mcpå’Œfuction-callingçš„åŒºåˆ«">mcpå’Œfuction callingçš„åŒºåˆ«</h3>
<table>
<colgroup>
<col style="width: 7%">
<col style="width: 46%">
<col style="width: 46%">
</colgroup>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>Function Callingï¼ˆFCï¼‰</th>
<th>MCPï¼ˆModel Context Protocolï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœ¬è´¨</td>
<td><strong>èƒ½åŠ›</strong> â€”â€”
æŸä¸ªå¤§æ¨¡å‹åŸç”Ÿå°±å¸¦çš„ä¸€ç§ã€Œè°ƒç”¨å‡½æ•°ã€åŠŸèƒ½</td>
<td><strong>åè®®</strong> â€”â€” å®šä¹‰ AI
ä¸å¤–éƒ¨ä¸–ç•Œå¦‚ä½•é•¿æœŸã€æ ‡å‡†ã€å¯å¤ç”¨åœ°äº¤äº’</td>
</tr>
<tr>
<td>å·¥ä½œæ–¹å¼</td>
<td>æ¨¡å‹åœ¨ä¸€æ¬¡æ¨ç†é‡Œ<strong>ä¸»åŠ¨</strong>å†³å®šè¦è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œå¹¶åå‡ºç»“æ„åŒ–å‚æ•°</td>
<td>é€šè¿‡ã€Œå®¢æˆ·ç«¯-æœåŠ¡å™¨ã€æ¶æ„ï¼Œç”± MCP Server
<strong>è¢«åŠ¨</strong>ç­‰å¾…æ¨¡å‹æˆ– Agent çš„è¯·æ±‚</td>
</tr>
<tr>
<td>æ˜¯å¦æ ‡å‡†åŒ–</td>
<td>å¦ã€‚OpenAIã€Anthropicã€ç™¾åº¦ç­‰å„å®¶æ¥å£æ ¼å¼ä¸åŒ</td>
<td>æ˜¯ã€‚ç»Ÿä¸€ JSON-RPC 2.0 åè®®ï¼Œè·¨æ¨¡å‹é€šç”¨</td>
</tr>
<tr>
<td>ä¸Šä¸‹æ–‡ç®¡ç†</td>
<td>å•æ¬¡è°ƒç”¨ï¼Œæ— çŠ¶æ€ï¼›å¤æ‚å¤šè½®ä»»åŠ¡éœ€è‡ªå·±ç»´æŠ¤</td>
<td>åè®®å±‚é¢æ”¯æŒä¼šè¯ã€çŠ¶æ€ã€é•¿é“¾è·¯ä»»åŠ¡</td>
</tr>
<tr>
<td>å¤ç”¨/å…±äº«</td>
<td>å‡½æ•°ä»£ç å¾€å¾€ç´§è€¦åˆåœ¨é¡¹ç›®é‡Œï¼Œæ¢æ¨¡å‹å°±å¾—é‡å†™</td>
<td>ä¸€æ¬¡å†™æˆ MCP Serverï¼Œå¯è¢«ä»»ä½•æ”¯æŒ MCP çš„æ¨¡å‹/IDE/Agent ç›´æ¥æ’ç”¨</td>
</tr>
</tbody>
</table>
<p>ä¸€å¥è¯æ€»ç»“ï¼š <strong>Function Calling
æ˜¯ã€ŒæŸä¸ªæ¨¡å‹è‡ªå¸¦çš„å¿«æ·æŒ‡ä»¤ã€ï¼ŒMCP
æ˜¯ã€Œè®©ä»»ä½•æ¨¡å‹éƒ½èƒ½ç»Ÿä¸€æ’æ‹”å·¥å…·çš„å·¥ä¸šæ ‡å‡†ã€ã€‚</strong> äºŒè€…å¹¶éäº’æ–¥â€”â€”MCP
çš„å®ç°é‡Œä»ç„¶å¯ä»¥ç”¨ Function Calling
å»è§¦å‘å…·ä½“å‡½æ•°ï¼Œä½†å®ƒæŠŠã€Œæ€ä¹ˆæè¿°å·¥å…·ã€æ€ä¹ˆå‘ç°å·¥å…·ã€æ€ä¹ˆä¿æŒä¼šè¯ã€è¿™äº›äº‹éƒ½æ ‡å‡†åŒ–äº†ï¼Œä»è€Œè§£å†³äº†
FC å¸¦æ¥çš„ç¢ç‰‡åŒ–ã€éš¾ç»´æŠ¤ã€éš¾å…±äº«çš„é—®é¢˜ ã€‚</p>
<h3 id="å®‰è£…mcp">å®‰è£…mcp</h3>
<p>åœ¨mcp serverå¸‚åœºæŸ¥æ‰¾è‡ªå·±æƒ³ç”¨çš„mcpæœåŠ¡ï¼Œå¦‚<a target="_blank" rel="noopener" href="https://mcp.so/server/fetch/modelcontextprotocol?tab=content">Fetch
MCP Server</a></p>
<p>å¤åˆ¶mcpé…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;mcpServers&quot;: &#123;</span><br><span class="line">    &quot;fetch&quot;: &#123;</span><br><span class="line">      &quot;command&quot;: &quot;uvx&quot;,</span><br><span class="line">      &quot;args&quot;: [</span><br><span class="line">        &quot;mcp-server-fetch&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨mcp host ä¸­å®‰è£…ï¼Œå¦‚trae</p>
<p>hostä¼šè‡ªåŠ¨å®Œæˆå¯¹mcpçš„é…ç½®</p>
<h3 id="åˆ›å»ºä¸€ä¸ªmcp-server">åˆ›å»ºä¸€ä¸ªmcp server</h3>
<p>åˆå§‹åŒ–é¡¹ç›®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uv init weather</span><br><span class="line"></span><br><span class="line">uv sync</span><br><span class="line"></span><br><span class="line">source .venv/bin/activate </span><br><span class="line"></span><br><span class="line">#æ·»åŠ ä¾èµ–</span><br><span class="line">uv add &quot;mcp[cli]&quot; httpx</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºweather.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å…¥ç±»å‹æç¤ºæ¨¡å—ï¼Œç”¨äºç±»å‹æ³¨è§£</span><br><span class="line">from typing import Any</span><br><span class="line"></span><br><span class="line"># å¯¼å…¥httpxåº“ï¼Œç”¨äºå‘é€HTTPè¯·æ±‚</span><br><span class="line">import httpx</span><br><span class="line"></span><br><span class="line"># ä»mcp.server.fastmcpæ¨¡å—å¯¼å…¥FastMCPç±»</span><br><span class="line"># FastMCPæ˜¯ä¸€ä¸ªå¿«é€Ÿæ„å»ºMCPï¼ˆModel Control Protocolï¼‰æœåŠ¡å™¨çš„æ¡†æ¶</span><br><span class="line">from mcp.server.fastmcp import FastMCP</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºFastMCPå®ä¾‹ï¼Œå‘½åä¸º&quot;weather&quot;ï¼Œæ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºERRORï¼ˆåªæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼‰</span><br><span class="line">mcp = FastMCP(&quot;weather&quot;, log_level=&quot;ERROR&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># å¸¸é‡å®šä¹‰</span><br><span class="line"># NWSï¼ˆNational Weather Serviceï¼‰APIçš„åŸºç¡€URL</span><br><span class="line">NWS_API_BASE = &quot;https://api.weather.gov&quot;</span><br><span class="line"># ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†åº”ç”¨ç¨‹åº</span><br><span class="line">USER_AGENT = &quot;weather-app/1.0&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def make_nws_request(url: str) -&gt; dict[str, Any] | None:</span><br><span class="line">    &quot;&quot;&quot;å‘NWS APIå‘èµ·è¯·æ±‚å¹¶å¤„ç†é”™è¯¯ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        url: è¦è¯·æ±‚çš„API URL</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æˆåŠŸæ—¶è¿”å›è§£æåçš„JSONæ•°æ®å­—å…¸ï¼Œå¤±è´¥æ—¶è¿”å›None</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # è®¾ç½®è¯·æ±‚å¤´ä¿¡æ¯</span><br><span class="line">    headers = &#123;</span><br><span class="line">        &quot;User-Agent&quot;: USER_AGENT,           # ç”¨æˆ·ä»£ç†æ ‡è¯†</span><br><span class="line">        &quot;Accept&quot;: &quot;application/geo+json&quot;    # æ¥å—çš„æ•°æ®æ ¼å¼</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # åˆ›å»ºå¼‚æ­¥HTTPå®¢æˆ·ç«¯</span><br><span class="line">    async with httpx.AsyncClient() as client:</span><br><span class="line">        try:</span><br><span class="line">            # å‘èµ·GETè¯·æ±‚ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’</span><br><span class="line">            response = await client.get(url, headers=headers, timeout=30.0)</span><br><span class="line">            # å¦‚æœå“åº”çŠ¶æ€ç ä¸æ˜¯2xxï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            # è¿”å›è§£æåçš„JSONæ•°æ®</span><br><span class="line">            return response.json()</span><br><span class="line">        except Exception:</span><br><span class="line">            # æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œè¿”å›Noneè¡¨ç¤ºè¯·æ±‚å¤±è´¥</span><br><span class="line">            return None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def format_alert(feature: dict) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;å°†è­¦æŠ¥æ•°æ®æ ¼å¼åŒ–ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        feature: åŒ…å«è­¦æŠ¥ä¿¡æ¯çš„å­—å…¸</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„è­¦æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # è·å–è­¦æŠ¥å±æ€§</span><br><span class="line">    props = feature[&quot;properties&quot;]</span><br><span class="line">    # æ ¼å¼åŒ–è­¦æŠ¥ä¿¡æ¯ï¼Œä½¿ç”¨getæ–¹æ³•æä¾›é»˜è®¤å€¼é˜²æ­¢é”®ä¸å­˜åœ¨</span><br><span class="line">    return f&quot;&quot;&quot;</span><br><span class="line">äº‹ä»¶: &#123;props.get(&#x27;event&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">åŒºåŸŸ: &#123;props.get(&#x27;areaDesc&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">ä¸¥é‡ç¨‹åº¦: &#123;props.get(&#x27;severity&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;</span><br><span class="line">æè¿°: &#123;props.get(&#x27;description&#x27;, &#x27;æ— æè¿°ä¿¡æ¯&#x27;)&#125;</span><br><span class="line">æŒ‡ç¤º: &#123;props.get(&#x27;instruction&#x27;, &#x27;æ— å…·ä½“æŒ‡ç¤º&#x27;)&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨@mcp.tool()è£…é¥°å™¨å°†å‡½æ•°æ³¨å†Œä¸ºMCPå·¥å…·</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_alerts(state: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šç¾å›½å·çš„å¤©æ°”è­¦æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        state: ä¸¤ä¸ªå­—æ¯çš„ç¾å›½å·ä»£ç ï¼ˆä¾‹å¦‚ï¼šCA, NYï¼‰</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„è­¦æŠ¥ä¿¡æ¯å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # æ„å»ºè·å–å·è­¦æŠ¥çš„URL</span><br><span class="line">    url = f&quot;&#123;NWS_API_BASE&#125;/alerts/active/area/&#123;state&#125;&quot;</span><br><span class="line">    # å‘èµ·APIè¯·æ±‚è·å–æ•°æ®</span><br><span class="line">    data = await make_nws_request(url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ</span><br><span class="line">    if not data or &quot;features&quot; not in data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è­¦æŠ¥æˆ–æœªæ‰¾åˆ°è­¦æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥æ˜¯å¦æœ‰è­¦æŠ¥</span><br><span class="line">    if not data[&quot;features&quot;]:</span><br><span class="line">        return &quot;è¯¥å·æ— æ´»åŠ¨è­¦æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # æ ¼å¼åŒ–æ‰€æœ‰è­¦æŠ¥</span><br><span class="line">    alerts = [format_alert(feature) for feature in data[&quot;features&quot;]]</span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰è­¦æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(alerts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># æ³¨å†Œä¸ºMCPå·¥å…·çš„å¤©æ°”é¢„æŠ¥å‡½æ•°</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_forecast(latitude: float, longitude: float) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”é¢„æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        latitude: ä½ç½®çš„çº¬åº¦</span><br><span class="line">        longitude: ä½ç½®çš„ç»åº¦</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„å¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # é¦–å…ˆè·å–é¢„æŠ¥ç½‘æ ¼ç«¯ç‚¹</span><br><span class="line">    points_url = f&quot;&#123;NWS_API_BASE&#125;/points/&#123;latitude&#125;,&#123;longitude&#125;&quot;</span><br><span class="line">    points_data = await make_nws_request(points_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥ç‚¹æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not points_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–æ­¤ä½ç½®çš„é¢„æŠ¥æ•°æ®ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # ä»ç‚¹å“åº”ä¸­è·å–é¢„æŠ¥URL</span><br><span class="line">    forecast_url = points_data[&quot;properties&quot;][&quot;forecast&quot;]</span><br><span class="line">    forecast_data = await make_nws_request(forecast_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥é¢„æŠ¥æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not forecast_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è¯¦ç»†é¢„æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # å°†æ—¶é—´æ®µæ ¼å¼åŒ–ä¸ºå¯è¯»çš„é¢„æŠ¥</span><br><span class="line">    periods = forecast_data[&quot;properties&quot;][&quot;periods&quot;]</span><br><span class="line">    forecasts = []</span><br><span class="line">    # åªæ˜¾ç¤ºæ¥ä¸‹æ¥çš„5ä¸ªæ—¶é—´æ®µ</span><br><span class="line">    for period in periods[:5]:</span><br><span class="line">        forecast = f&quot;&quot;&quot;</span><br><span class="line">&#123;period[&#x27;name&#x27;]&#125;:</span><br><span class="line">æ¸©åº¦: &#123;period[&#x27;temperature&#x27;]&#125;Â°&#123;period[&#x27;temperatureUnit&#x27;]&#125;</span><br><span class="line">é£åŠ›: &#123;period[&#x27;windSpeed&#x27;]&#125; &#123;period[&#x27;windDirection&#x27;]&#125;</span><br><span class="line">é¢„æŠ¥: &#123;period[&#x27;detailedForecast&#x27;]&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        forecasts.append(forecast)</span><br><span class="line"></span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰é¢„æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(forecasts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ç¨‹åºå…¥å£ç‚¹</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    # åˆå§‹åŒ–å¹¶è¿è¡ŒæœåŠ¡å™¨ï¼Œä½¿ç”¨stdioä¼ è¾“æ–¹å¼</span><br><span class="line">    mcp.run(transport=&#x27;stdio&#x27;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><span class="citation" data-cites="mcp.tool">@mcp.tool</span>()å¯ä»¥å°†å‡½æ•°å†…çš„å­—ç¬¦ä¸²ï¼Œå‚æ•°ç±»å‹ç­‰ä¿¡æ¯ä¼ ç»™å¤§æ¨¡å‹ï¼Œä»¥ä¾›å¤§æ¨¡å‹å†³å®šä½•æ—¶è°ƒç”¨è¿™ä¸ªtool</p>
<p>mcp.run(transport=â€˜stdioâ€™)è¯´æ˜mcp
serverå’Œhostçš„ä¼ è¾“æ–¹å¼æ˜¯è¾“å…¥å’Œè¾“å‡º</p>
</blockquote>
<p>mcp server é…ç½®ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;weather&quot;: &#123;</span><br><span class="line">    &quot;disabled&quot;: false,</span><br><span class="line">    &quot;timeout&quot;: 60,</span><br><span class="line">    &quot;command&quot;: &quot;uv&quot;,</span><br><span class="line">    &quot;args&quot;: [</span><br><span class="line">      &quot;--directory&quot;,</span><br><span class="line">      &quot;/Users/joeygreen/PycharmProjects/weather&quot;,</span><br><span class="line">      &quot;run&quot;,</span><br><span class="line">      &quot;weather.py&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;transportType&quot;: &quot;stdio&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>â€œdisabledâ€: falseè¡¨ç¤ºè¯¥æœåŠ¡æ˜¯å¦è¢«ç¦ç”¨ã€‚<code>false</code>
è¡¨ç¤ºè¯¥æœåŠ¡æ˜¯å¯ç”¨çŠ¶æ€ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p>â€œtimeoutâ€: 60è®¾ç½®è¯¥æœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚</p>
<p>â€œcommandâ€: â€œuvâ€æŒ‡å®šæ‰§è¡Œè¯¥æœåŠ¡æ—¶ä½¿ç”¨çš„å‘½ä»¤ã€‚</p>
<p>â€œargsâ€å‡ºäº†æ‰§è¡Œ <code>command</code> æ—¶éœ€è¦ä¼ é€’çš„å‚æ•°ã€‚</p>
<p>â€œtransportTypeâ€: â€œstdioâ€æŒ‡å®šæœåŠ¡çš„é€šä¿¡æ–¹å¼ã€‚<code>stdio</code>
è¡¨ç¤ºæ ‡å‡†è¾“å…¥è¾“å‡ºæµï¼ˆStandard Input Outputï¼‰ï¼Œé€šå¸¸ç”¨äºè¿›ç¨‹é—´é€šä¿¡ã€‚</p>
</blockquote>
<h3 id="è§£æmcp-serverä¸hostçš„é€šä¿¡">è§£æmcp serverä¸hostçš„é€šä¿¡</h3>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727154739013.png" alt="image-20250727154739013">
<figcaption aria-hidden="true">image-20250727154739013</figcaption>
</figure>
<p>è¾“å…¥ä¸ºhostå¯¹serverå‘é€ï¼Œè¾“å‡ºä¸ºserverå¯¹hostå‘é€ï¼Œä»¥ä¸‹å°†åˆ—ä¸¾å‡ ä¸ªé‡è¦çš„è¯´æ˜</p>
<p>è¾“å…¥ä¸­ï¼š<code>method</code>å­—æ®µä¸ºhostå‘Šè¯‰serveræ¥ä¸‹æ¥è¦å¹²ä»€ä¹ˆï¼Œå¦‚<strong>åˆå§‹åŒ–
(Initialization)</strong>ï¼Œ<strong>é€šçŸ¥å·²åˆå§‹åŒ–
(Notification)</strong>ï¼Œ<strong>æŸ¥è¯¢å¯ç”¨å·¥å…· (Listing
Tools)</strong>ï¼Œ<strong>è°ƒç”¨å·¥å…· (Calling a Tool)</strong></p>
<p><code>protocolVersion</code>è¯´æ˜äº†mcpä½¿ç”¨çš„åè®®ç‰ˆæœ¬</p>
<p>ä»¥ä¸‹è§serverè¿”å›çš„toolä¿¡æ¯ï¼Œå…¶ä¸­çš„ä¸€ä¸ªå‚æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;get_forecast&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;Get weather forecast for a location.\n\nArgs:\n    latitude: Latitude of the location\n    longitude: Longitude of the location\n&quot;,</span><br><span class="line">    &quot;inputSchema&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;latitude&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &quot;Latitude&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;number&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;longitude&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &quot;Longitude&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;number&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;required&quot;: [</span><br><span class="line">            &quot;latitude&quot;,</span><br><span class="line">            &quot;longitude&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;title&quot;: &quot;get_forecastArguments&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;object&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å’Œå®šä¹‰çš„å‡½æ•°å¯¹æ¯”å­¦ä¹ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># æ³¨å†Œä¸ºMCPå·¥å…·çš„å¤©æ°”é¢„æŠ¥å‡½æ•°</span><br><span class="line">@mcp.tool()</span><br><span class="line">async def get_forecast(latitude: float, longitude: float) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”é¢„æŠ¥ã€‚</span><br><span class="line">    </span><br><span class="line">    Args:</span><br><span class="line">        latitude: ä½ç½®çš„çº¬åº¦</span><br><span class="line">        longitude: ä½ç½®çš„ç»åº¦</span><br><span class="line">        </span><br><span class="line">    Returns:</span><br><span class="line">        æ ¼å¼åŒ–åçš„å¤©æ°”é¢„æŠ¥å­—ç¬¦ä¸²</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    # é¦–å…ˆè·å–é¢„æŠ¥ç½‘æ ¼ç«¯ç‚¹</span><br><span class="line">    points_url = f&quot;&#123;NWS_API_BASE&#125;/points/&#123;latitude&#125;,&#123;longitude&#125;&quot;</span><br><span class="line">    points_data = await make_nws_request(points_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥ç‚¹æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not points_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–æ­¤ä½ç½®çš„é¢„æŠ¥æ•°æ®ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # ä»ç‚¹å“åº”ä¸­è·å–é¢„æŠ¥URL</span><br><span class="line">    forecast_url = points_data[&quot;properties&quot;][&quot;forecast&quot;]</span><br><span class="line">    forecast_data = await make_nws_request(forecast_url)</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥é¢„æŠ¥æ•°æ®æ˜¯å¦è·å–æˆåŠŸ</span><br><span class="line">    if not forecast_data:</span><br><span class="line">        return &quot;æ— æ³•è·å–è¯¦ç»†é¢„æŠ¥ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # å°†æ—¶é—´æ®µæ ¼å¼åŒ–ä¸ºå¯è¯»çš„é¢„æŠ¥</span><br><span class="line">    periods = forecast_data[&quot;properties&quot;][&quot;periods&quot;]</span><br><span class="line">    forecasts = []</span><br><span class="line">    # åªæ˜¾ç¤ºæ¥ä¸‹æ¥çš„5ä¸ªæ—¶é—´æ®µ</span><br><span class="line">    for period in periods[:5]:</span><br><span class="line">        forecast = f&quot;&quot;&quot;</span><br><span class="line">&#123;period[&#x27;name&#x27;]&#125;:</span><br><span class="line">æ¸©åº¦: &#123;period[&#x27;temperature&#x27;]&#125;Â°&#123;period[&#x27;temperatureUnit&#x27;]&#125;</span><br><span class="line">é£åŠ›: &#123;period[&#x27;windSpeed&#x27;]&#125; &#123;period[&#x27;windDirection&#x27;]&#125;</span><br><span class="line">é¢„æŠ¥: &#123;period[&#x27;detailedForecast&#x27;]&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        forecasts.append(forecast)</span><br><span class="line"></span><br><span class="line">    # ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰é¢„æŠ¥</span><br><span class="line">    return &quot;\n---\n&quot;.join(forecasts)</span><br></pre></td></tr></table></figure>
<p><code>description</code>å†…å®¹å³ä¸ºæˆ‘ä»¬åœ¨å®šä¹‰è¿™ä¸ªtoolçš„æ—¶å€™å†™çš„<strong>æ–‡æ¡£å­—ç¬¦ä¸²</strong>ï¼ˆDocumentation
Stringï¼‰ï¼Œé€šå¸¸ç®€ç§°ä¸º <strong>docstring</strong></p>
<p><code>inputSchema</code> æ˜¯åœ¨MCPï¼ˆModel Control
Protocolï¼‰ä¸­ç”¨æ¥<strong>æè¿°å·¥å…·ï¼ˆtoolï¼‰æ‰€éœ€å‚æ•°çš„ç»“æ„å’Œç±»å‹çš„è§„èŒƒ</strong>ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªJSON
Schemaã€‚</p>
<blockquote>
<p>JSON Schema æ˜¯ä¸€ä¸ªç”¨äº<strong>æè¿°å’ŒéªŒè¯ JSON
æ•°æ®ç»“æ„çš„è§„èŒƒ</strong>ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸º JSON
æ•°æ®çš„â€œè“å›¾â€æˆ–â€œæ¨¡æ¿â€ã€‚</p>
</blockquote>
<p><code>required</code>æŒ‡æ˜å“ªäº›å‚æ•°æ˜¯å¿…éœ€çš„ï¼Œå“ªäº›æ˜¯å¯é€‰çš„ã€‚</p>
<h3 id="ç†è§£mcpçš„æœ¬è´¨">ç†è§£mcpçš„æœ¬è´¨</h3>
<p>ä»¥ä¸Šå†…å®¹çš†æ˜¯serverä¸hostç›´æ¥çš„äº¤äº’ï¼Œæœ¬è´¨ä¸Šå¯ä»¥ç†è§£æˆhostå¯¹serveræä¾›çš„å·¥å…·è¿›è¡Œæ³¨å†Œä¸ä½¿ç”¨ã€‚è¿™å…¶ä¸­å¹¶ä¸æ¶‰åŠåˆ°hostä¸å¤§æ¨¡å‹çš„äº¤äº’ï¼Œä¹Ÿå°±æ˜¯å¤§æ¨¡å‹æ˜¯å¦‚ä½•ä½¿ç”¨hostæä¾›çš„ä¿¡æ¯ã€‚å®é™…ä¸Šä¸åŒçš„mcp
hostä¸æ¨¡å‹çš„äº¤äº’åè®®ä¹Ÿä¸åŒï¼Œå¦‚clineä½¿ç”¨çš„æ˜¯xmlæ ¼å¼ï¼›cherry
studioä½¿ç”¨çš„åˆ™æ˜¯fuction calling</p>
<p>å†çœ‹mcpçš„å…¨ç§°Model Context
Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œä¹Ÿå°±æ˜¯mcpå¢åŠ æ¨¡å‹çš„æ‰©å±•æ€§ï¼Œä½¿ä»–å¯ä»¥è·å–æ›´å¤šä¿¡æ¯ï¼Œè€Œserverå°±æ˜¯ä¸ºæ¨¡å‹æä¾›æ›´å¤šä¿¡æ¯çš„å·¥å…·</p>
<h3 id="mcp-hostä¸æ¨¡å‹çš„äº¤äº’">mcp hostä¸æ¨¡å‹çš„äº¤äº’</h3>
<p>ä½¿ç”¨ä¸­è½¬æœåŠ¡å™¨æˆªè·æ—¥å¿—</p>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727163811531-1753605912284-1.png" alt="image-20250727163811531">
<figcaption aria-hidden="true">image-20250727163811531</figcaption>
</figure>
<p>ä»¥ä¸‹ä¸ºclineå‘é€ç»™æ¨¡å‹çš„è¯·æ±‚</p>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727164527797.png" alt="image-20250727164527797">
<figcaption aria-hidden="true">image-20250727164527797</figcaption>
</figure>
<p><code>messages</code>åŒ…å«äº†ç³»ç»Ÿæç¤ºè¯ä¸ç”¨æˆ·è¾“å…¥</p>
<p>å…ˆæ¥çœ‹ç³»ç»Ÿæç¤ºè¯ï¼Œclineæä¾›çš„æç¤ºè¯åŒ…æ‹¬å·¥å…·ä½¿ç”¨æ ¼å¼ï¼Œå·¥å…·ä¿¡æ¯ï¼Œå·¥å…·ä½¿ç”¨æ–¹æ³•ç­‰ã€‚è¿™é‡Œé‡ç‚¹è¯´ä¸€ä¸‹ï¼Œclineçš„å·¥å…·ä½¿ç”¨æ ¼å¼xml</p>
<p>ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;tool_name&gt;</span><br><span class="line">&lt;parameter1_name&gt;value1&lt;/parameter1_name&gt;</span><br><span class="line">&lt;parameter2_name&gt;value2&lt;/parameter2_name&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/tool_name&gt;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;read_file&gt;</span><br><span class="line">src/main.js</span><br><span class="line">&lt;/read_file&gt;</span><br></pre></td></tr></table></figure>
<p>å†ä¸¾ä¸ªä¾‹å­</p>
<p>use_mcp_tool æè¿°ï¼šè¯·æ±‚ä½¿ç”¨ç”±è¿æ¥çš„ MCP æœåŠ¡å™¨æä¾›çš„å·¥å…·ã€‚æ¯ä¸ª MCP
æœåŠ¡å™¨å¯ä»¥æä¾›å…·æœ‰ä¸åŒåŠŸèƒ½çš„å¤šä¸ªå·¥å…·ã€‚å·¥å…·æœ‰å®šä¹‰çš„è¾“å…¥æ¨¡å¼ï¼Œç”¨äºæŒ‡å®šå¿…éœ€å’Œå¯é€‰å‚æ•°ã€‚
å‚æ•°ï¼š</p>
<p>server_name: (å¿…éœ€) æä¾›è¯¥å·¥å…·çš„ MCP æœåŠ¡å™¨çš„åç§° tool_name: (å¿…éœ€)
è¦æ‰§è¡Œçš„å·¥å…·çš„åç§° arguments: (å¿…éœ€) ä¸€ä¸ª JSON
å¯¹è±¡ï¼ŒåŒ…å«å·¥å…·çš„è¾“å…¥å‚æ•°ï¼Œéµå¾ªå·¥å…·çš„è¾“å…¥æ¨¡å¼ ç”¨æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;use_mcp_tool&gt;</span><br><span class="line">&lt;server_name&gt;æœåŠ¡å™¨åç§°åœ¨æ­¤&lt;/server_name&gt;</span><br><span class="line">&lt;tool_name&gt;å·¥å…·åç§°åœ¨æ­¤&lt;/tool_name&gt;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;param1&quot;: &quot;value1&quot;,</span><br><span class="line">&quot;param2&quot;: &quot;value2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/use_mcp_tool&gt;</span><br></pre></td></tr></table></figure>
<p>æ¨¡å‹è¿”å›å“åº”å¦‚ä¸‹</p>
<figure>
<img src="/2025/07/27/%E5%AD%A6%E4%B9%A0/ai%E7%9B%B8%E5%85%B3/mcp%E5%AD%A6%E4%B9%A0/MCP%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20250727174504506.png" alt="image-20250727174504506">
<figcaption aria-hidden="true">image-20250727174504506</figcaption>
</figure>
<p>sseè¿æ¥ï¼Œæµå¼è¾“å‡º</p>
<blockquote>
<p>SSE æ˜¯ä¸€ç§<strong>åŸºäºæ ‡å‡†
HTTP</strong>ã€<strong>åªå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å•å‘æ¨é€æ–‡æœ¬æµ</strong>çš„å®æ—¶é€šä¿¡æŠ€æœ¯ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œè‡ªåŠ¨é‡è¿ï¼Œå¸¸ç”¨äº<strong>AI
æµå¼å›ç­”</strong>ã€<strong>å®æ—¶æ—¥å¿—</strong>ã€<strong>è‚¡ä»·/ç›‘æ§æ¨é€</strong>ç­‰åœºæ™¯ã€‚</p>
<p>å³å®¢æˆ·ç«¯å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè¿ç»­æ¥å—å¤šæ¬¡å“åº”ç›´åˆ°ç»“æŸ</p>
</blockquote>
<h3 id="mcpçš„ä¸‰ç§ä¼ è¾“åè®®">mcpçš„ä¸‰ç§ä¼ è¾“åè®®</h3>
<table>
<colgroup>
<col style="width: 16%">
<col style="width: 29%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 19%">
</colgroup>
<thead>
<tr>
<th>åè®®åç§°</th>
<th>é€šä¿¡æ–¹å¼</th>
<th>é€‚ç”¨åœºæ™¯</th>
<th>ä¼˜åŠ¿</th>
<th>å±€é™</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Stdio</strong>ï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰</td>
<td>ä½¿ç”¨è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰å’Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰è¿›è¡Œæœ¬åœ°é€šä¿¡ï¼ŒåŸºäº
JSON-RPC 2.0 æ ¼å¼</td>
<td>æœ¬åœ°å¼€å‘ã€è°ƒè¯•ã€IDEæ’ä»¶ã€å‘½ä»¤è¡Œå·¥å…·</td>
<td>ç®€å•æ˜“å®ç°ã€è·¨å¹³å°ã€ä½å»¶è¿Ÿ</td>
<td>ä»…æ”¯æŒæœ¬åœ°é€šä¿¡ï¼Œæ— æ³•è·¨ç½‘ç»œï¼Œä½å¹¶å‘</td>
</tr>
<tr>
<td><strong>SSE</strong>ï¼ˆServer-Sent Eventsï¼‰</td>
<td>å®¢æˆ·ç«¯é€šè¿‡ HTTP POST å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨é€šè¿‡ SSE å•å‘æ¨é€æµå¼å“åº”</td>
<td>å®æ—¶ç›‘æ§ã€æ–°é—»æ¨é€ã€è¿œç¨‹æœåŠ¡è°ƒç”¨</td>
<td>åŸºäº HTTPï¼Œæµè§ˆå™¨å‹å¥½ï¼Œæ”¯æŒæµå¼æ•°æ®</td>
<td>ä»…æ”¯æŒå•å‘é€šä¿¡ï¼ŒMCPå®˜æ–¹å·²æ ‡è®°ä¸ºâ€œå³å°†åºŸå¼ƒâ€</td>
</tr>
<tr>
<td><strong>Streamable HTTP</strong>ï¼ˆæ–°å‹æµå¼HTTPï¼‰</td>
<td>æ”¯æŒåŒå‘æµå¼é€šä¿¡çš„ç°ä»£ HTTP åè®®ï¼Œæ›¿ä»£ SSEï¼Œæ”¯æŒä¼šè¯æ¢å¤ã€OAuth
è®¤è¯ç­‰</td>
<td>åˆ†å¸ƒå¼ç³»ç»Ÿã€é«˜å¹¶å‘ã€åŒå‘å®æ—¶äº¤äº’</td>
<td>åŒå‘é€šä¿¡ã€é«˜æ€§èƒ½ã€ä¼ä¸šçº§å®‰å…¨æœºåˆ¶</td>
<td>å®ç°è¾ƒå¤æ‚ï¼Œç”Ÿæ€ä»åœ¨å‘å±•ä¸­</td>
</tr>
</tbody>
</table>
<h3 id="react">ReAct</h3>
<p>ReAct
æ˜¯ä¸€ç§ç”¨äºå¢å¼ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æ¨ç†å’Œè¡ŒåŠ¨èƒ½åŠ›çš„æŠ€æœ¯æ¡†æ¶ï¼Œå®ƒé€šè¿‡ç»“åˆâ€œæ¨ç†â€ï¼ˆReasoningï¼‰å’Œâ€œè¡ŒåŠ¨â€ï¼ˆActingï¼‰æ¥æå‡æ¨¡å‹å¤„ç†å¤æ‚ä»»åŠ¡çš„èƒ½åŠ›ã€‚</p>
<p>å…¶å·¥ä½œæµç¨‹é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol type="1">
<li><strong>æ€è€ƒï¼ˆReasoningï¼‰</strong>ï¼šæ¨¡å‹å¯¹å½“å‰é—®é¢˜è¿›è¡Œåˆ†æï¼Œæ€è€ƒä¸‹ä¸€æ­¥éœ€è¦é‡‡å–çš„è¡ŒåŠ¨ã€‚</li>
<li><strong>è¡ŒåŠ¨ï¼ˆActingï¼‰</strong>ï¼šæ¨¡å‹å†³å®šè°ƒç”¨å“ªäº›å·¥å…·æˆ–å‡½æ•°ï¼Œå¹¶æä¾›å¿…è¦çš„å‚æ•°ã€‚</li>
<li><strong>è§‚å¯Ÿï¼ˆObservationï¼‰</strong>ï¼šå·¥å…·æ‰§è¡Œåè¿”å›ç»“æœï¼Œæ¨¡å‹å¯¹ç»“æœè¿›è¡Œè§‚å¯Ÿã€‚</li>
<li><strong>å“åº”ï¼ˆResponseï¼‰</strong>ï¼šæ ¹æ®è§‚å¯Ÿç»“æœï¼Œæ¨¡å‹ç”Ÿæˆæœ€ç»ˆçš„ç”¨æˆ·å“åº”ã€‚</li>
</ol>
<p>å®é™…åº”ç”¨ä¸Šå°±æ˜¯å‘Šè¯‰å¤§æ¨¡å‹ç”¨ReActè¿™ç§æ¨¡å¼æ¥æ€è€ƒ</p>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1uronYREWR?spm_id_from=333.788.player.switch&amp;vd_source=bacf29bd4bb51f2ecf08a1ac7c7d8f11">MCPç»ˆææŒ‡å—
- ä»åŸç†åˆ°å®æˆ˜ï¼Œå¸¦ä½ æ·±å…¥æŒæ¡MCPï¼ˆåŸºç¡€ç¯‡ï¼‰_å“”å“©å“”å“©_bilibili</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zxjavatar.gif">
      <meta itemprop="name" content="å¼ ç†™æµš">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhang XiJun">
      <meta itemprop="description" content="zxj Blogs">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Zhang XiJun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/" class="post-title-link" itemprop="url">LangGraphå­¦ä¹ â€”â€”agentâ€”â€”ä¸‹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-22 00:00:00" itemprop="dateCreated datePublished" datetime="2025-07-22T00:00:00+08:00">2025-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-13 09:25:38" itemprop="dateModified" datetime="2025-08-13T09:25:38+08:00">2025-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">aiæ¡†æ¶</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ai%E6%A1%86%E6%9E%B6/langgraph/" itemprop="url" rel="index"><span itemprop="name">langgraph</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="å‰è¨€">å‰è¨€</h3>
<p>æœ¬æ•™ç¨‹ä¸ºlangchainå®˜æ–¹æ•™ç¨‹çš„å­¦ä¹ è®°å½•</p>
<p><a target="_blank" rel="noopener" href="https://academy.langchain.com/enrollments">academy.langchain.com/enrollments</a></p>
<p>ä»£ç è§<a target="_blank" rel="noopener" href="https://github.com/zxj-2023/learn-rag-langchain">[learn-rag-langchain/academy-langgraph
at main Â·
zxj-2023/learn-rag-langchain](https://github.com/zxj-2023/learn-rag-langchain/tree/main/academy-langgraph)</a></p>
<h3 id="module-4">module-4</h3>
<h4 id="parallel-node-execution-å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ"><strong>Parallel node
execution</strong> <strong>å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ</strong></h4>
<h5 id="waiting-for-nodes-to-finish-ç­‰å¾…èŠ‚ç‚¹å®Œæˆ"><strong>Waiting for
nodes to finish</strong> <strong>ç­‰å¾…èŠ‚ç‚¹å®Œæˆ</strong></h5>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œè·¯å¾„çš„æ­¥éª¤æ¯”å¦ä¸€ä¸ªå¤šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"># Initialize each node with node_secret </span><br><span class="line">builder.add_node(&quot;a&quot;, ReturnNodeValue(&quot;I&#x27;m A&quot;))</span><br><span class="line">builder.add_node(&quot;b&quot;, ReturnNodeValue(&quot;I&#x27;m B&quot;))</span><br><span class="line">builder.add_node(&quot;b2&quot;, ReturnNodeValue(&quot;I&#x27;m B2&quot;))</span><br><span class="line">builder.add_node(&quot;c&quot;, ReturnNodeValue(&quot;I&#x27;m C&quot;))</span><br><span class="line">builder.add_node(&quot;d&quot;, ReturnNodeValue(&quot;I&#x27;m D&quot;))</span><br><span class="line"></span><br><span class="line"># Flow</span><br><span class="line">builder.add_edge(START, &quot;a&quot;)</span><br><span class="line">builder.add_edge(&quot;a&quot;, &quot;b&quot;)</span><br><span class="line">builder.add_edge(&quot;a&quot;, &quot;c&quot;)</span><br><span class="line">builder.add_edge(&quot;b&quot;, &quot;b2&quot;)</span><br><span class="line">builder.add_edge([&quot;b2&quot;, &quot;c&quot;], &quot;d&quot;)</span><br><span class="line">builder.add_edge(&quot;d&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250722143802652.png" alt="image-20250722143802652">
<figcaption aria-hidden="true">image-20250722143802652</figcaption>
</figure>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>b</code>ã€<code>b2</code> å’Œ <code>c</code>
éƒ½æ˜¯åŒä¸€ä¸ªæ­¥éª¤çš„ä¸€éƒ¨åˆ†ã€‚å›¾å½¢å°†åœ¨è¿›å…¥ <code>d</code>
æ­¥éª¤ä¹‹å‰ç­‰å¾…æ‰€æœ‰è¿™äº›æ“ä½œå®Œæˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(&#123;&quot;state&quot;: []&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Adding I&#x27;m A to []</span><br><span class="line">Adding I&#x27;m B to [&quot;I&#x27;m A&quot;]</span><br><span class="line">Adding I&#x27;m C to [&quot;I&#x27;m A&quot;]</span><br><span class="line">Adding I&#x27;m B2 to [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;]</span><br><span class="line">Adding I&#x27;m D to [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m B2&quot;]</span><br><span class="line">&#123;&#x27;state&#x27;: [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m B2&quot;, &quot;I&#x27;m D&quot;]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="setting-the-order-of-state-updates-è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº"><strong>Setting
the order of state updates</strong>
<strong>è®¾ç½®çŠ¶æ€æ›´æ–°çš„é¡ºåº</strong></h5>
<p>ç„¶è€Œï¼Œåœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬æ— æ³•å¯¹çŠ¶æ€æ›´æ–°çš„é¡ºåºè¿›è¡Œå…·ä½“æ§åˆ¶ï¼ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯åŸºäºå›¾æ‹“æ‰‘ç»“æ„ç”±
LangGraph ç¡®å®šçš„ç¡®å®šæ€§é¡ºåºï¼Œè¯¥é¡ºåºä¸º
<strong><em>*æˆ‘ä»¬æ— æ³•æ§åˆ¶*</em></strong>ã€‚</p>
<p>ä¸Šé¢ï¼Œæˆ‘ä»¬çœ‹åˆ° <code>c</code> è¢«æ·»åŠ åœ¨ <code>b2</code> ä¹‹å‰</p>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ reducer
æ¥å®šåˆ¶æ­¤åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œå¯¹çŠ¶æ€æ›´æ–°è¿›è¡Œæ’åºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def sorting_reducer(left, right):</span><br><span class="line">    &quot;&quot;&quot; åˆå¹¶å¹¶æ’åºåˆ—è¡¨ä¸­çš„å€¼&quot;&quot;&quot;</span><br><span class="line">    # å¦‚æœ left ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºåˆ—è¡¨</span><br><span class="line">    if not isinstance(left, list):</span><br><span class="line">        left = [left]</span><br><span class="line"></span><br><span class="line">    # å¦‚æœ right ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºåˆ—è¡¨</span><br><span class="line">    if not isinstance(right, list):</span><br><span class="line">        right = [right]</span><br><span class="line">    </span><br><span class="line">    # åˆå¹¶ left å’Œ right åˆ—è¡¨ï¼Œç„¶åå‡åºæ’åº</span><br><span class="line">    return sorted(left + right, reverse=False)</span><br><span class="line">class State(TypedDict):</span><br><span class="line">    # sorting_reducer å‡½æ•°å°†å¯¹ state ä¸­çš„å€¼è¿›è¡Œæ’åº</span><br><span class="line">    state: Annotated[list, sorting_reducer]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graph.invoke(&#123;&quot;state&quot;: []&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;state&#x27;: [&quot;I&#x27;m A&quot;, &quot;I&#x27;m B&quot;, &quot;I&#x27;m B2&quot;, &quot;I&#x27;m C&quot;, &quot;I&#x27;m D&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œreducer å¯¹æ›´æ–°çš„çŠ¶æ€å€¼è¿›è¡Œæ’åºï¼<code>sorting_reducer</code>
ç¤ºä¾‹å¯¹æ‰€æœ‰å€¼è¿›è¡Œå…¨å±€æ’åºã€‚æˆ‘ä»¬è¿˜å¯ä»¥ï¼š</p>
<ol type="1">
<li>åœ¨å¹¶è¡Œæ­¥éª¤æœŸé—´å°†è¾“å‡ºå†™å…¥çŠ¶æ€ä¸­çš„å•ç‹¬å­—æ®µ<br>
</li>
<li>åœ¨å¹¶è¡Œæ­¥éª¤ä¹‹åä½¿ç”¨â€œæ±‡â€èŠ‚ç‚¹æ¥åˆå¹¶å’Œæ’åºè¿™äº›è¾“å‡º<br>
</li>
<li>åˆå¹¶åæ¸…é™¤ä¸´æ—¶å­—æ®µ</li>
</ol>
<p>è¯·å‚é˜… <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/how-tos/branching/#stable-sorting">docs</a>
ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p>
<h5 id="working-with-llms-ä½¿ç”¨-llms"><strong>Working with LLMs</strong>
<strong>ä½¿ç”¨ LLMs</strong></h5>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç°å®ä¸­çš„ä¾‹å­ï¼æˆ‘ä»¬å¸Œæœ›ä»ä¸¤ä¸ªå¤–éƒ¨æ¥æºï¼ˆWikipedia
å’Œ Web-Searchï¼‰æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶è®© LLM å›ç­”ä¸€ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">from langchain_core.messages import HumanMessage, SystemMessage</span><br><span class="line"></span><br><span class="line">from langchain_community.document_loaders import WikipediaLoader</span><br><span class="line">from langchain_community.tools import TavilySearchResults</span><br><span class="line"></span><br><span class="line">def search_web(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç½‘ç»œæœç´¢ä¸­æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æœç´¢</span><br><span class="line">    tavily_search = TavilySearchResults(max_results=3)</span><br><span class="line">    search_docs = tavily_search.invoke(state[&#x27;question&#x27;])</span><br><span class="line"></span><br><span class="line">     # å°†å¤šä¸ªæœç´¢æ–‡æ¡£è½¬æ¢æˆäº†ä¸€ä¸ªç»Ÿä¸€æ ¼å¼çš„é•¿æ–‡æœ¬ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½æœ‰è‡ªå·±çš„å…ƒæ•°æ®ï¼ˆå¦‚URLï¼‰ï¼Œå¹¶ä¸”æ–‡æ¡£ä¹‹é—´æœ‰æ˜ç¡®çš„åˆ†éš”ï¼Œä¾¿äºåç»­å¤„ç†æˆ–å±•ç¤ºã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    - è¿™æ˜¯ä¸€ä¸ª åˆ—è¡¨æ¨å¯¼å¼ (list comprehension) ï¼Œå®ƒä¼šéå† search_docs åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼ˆè¿™é‡Œæˆ‘ä»¬ç§°ä¹‹ä¸º doc ï¼‰ã€‚</span><br><span class="line">    - search_docs é‡Œçš„æ¯ä¸ª doc åº”è¯¥æ˜¯ä¸€ä¸ªåŒ…å« &#x27;url&#x27; å’Œ &#x27;content&#x27; é”®çš„å­—å…¸ã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">        [</span><br><span class="line">            f&#x27;&lt;Document href=&quot;&#123;doc[&quot;url&quot;]&#125;&quot;&gt;\n&#123;doc[&quot;content&quot;]&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">            for doc in search_docs</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line"></span><br><span class="line">def search_wikipedia(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ä»ç»´åŸºç™¾ç§‘ä¸­æ£€ç´¢æ–‡æ¡£ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # æœç´¢</span><br><span class="line">    search_docs = WikipediaLoader(query=state[&#x27;question&#x27;], </span><br><span class="line">                                  load_max_docs=2).load()</span><br><span class="line"></span><br><span class="line">     # æ ¼å¼åŒ–</span><br><span class="line">    formatted_search_docs = &quot;\n\n---\n\n&quot;.join(</span><br><span class="line">        [</span><br><span class="line">            f&#x27;&lt;Document source=&quot;&#123;doc.metadata[&quot;source&quot;]&#125;&quot; page=&quot;&#123;doc.metadata.get(&quot;page&quot;, &quot;&quot;)&#125;&quot;&gt;\n&#123;doc.page_content&#125;\n&lt;/Document&gt;&#x27;</span><br><span class="line">            for doc in search_docs</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;context&quot;: [formatted_search_docs]&#125; </span><br><span class="line"></span><br><span class="line">def generate_answer(state):</span><br><span class="line">    </span><br><span class="line">    &quot;&quot;&quot; ç”¨äºå›ç­”é—®é¢˜çš„èŠ‚ç‚¹ &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # è·å–çŠ¶æ€</span><br><span class="line">    context = state[&quot;context&quot;]</span><br><span class="line">    question = state[&quot;question&quot;]</span><br><span class="line"></span><br><span class="line">    # æ¨¡æ¿</span><br><span class="line">    answer_template = &quot;&quot;&quot;ä½¿ç”¨ä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ &#123;question&#125;: &#123;context&#125;&quot;&quot;&quot;</span><br><span class="line">    answer_instructions = answer_template.format(question=question, </span><br><span class="line">                                                       context=context)    </span><br><span class="line">    </span><br><span class="line">    # å›ç­”</span><br><span class="line">    answer = llm.invoke([SystemMessage(content=answer_instructions)]+[HumanMessage(content=f&quot;å›ç­”é—®é¢˜ã€‚&quot;)])</span><br><span class="line">      </span><br><span class="line">    # å°†å…¶é™„åŠ åˆ°çŠ¶æ€</span><br><span class="line">    return &#123;&quot;answer&quot;: answer&#125;</span><br><span class="line"></span><br><span class="line"># æ·»åŠ èŠ‚ç‚¹</span><br><span class="line">builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–æ¯ä¸ªèŠ‚ç‚¹</span><br><span class="line">builder.add_node(&quot;search_web&quot;,search_web)</span><br><span class="line">builder.add_node(&quot;search_wikipedia&quot;, search_wikipedia)</span><br><span class="line">builder.add_node(&quot;generate_answer&quot;, generate_answer)</span><br><span class="line"></span><br><span class="line"># æµç¨‹</span><br><span class="line">builder.add_edge(START, &quot;search_wikipedia&quot;)</span><br><span class="line">builder.add_edge(START, &quot;search_web&quot;)</span><br><span class="line">builder.add_edge(&quot;search_wikipedia&quot;, &quot;generate_answer&quot;)</span><br><span class="line">builder.add_edge(&quot;search_web&quot;, &quot;generate_answer&quot;)</span><br><span class="line">builder.add_edge(&quot;generate_answer&quot;, END)</span><br><span class="line">graph = builder.compile()</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250722153534867.png" alt="image-20250722153534867">
<figcaption aria-hidden="true">image-20250722153534867</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = graph.invoke(&#123;&quot;question&quot;: &quot;è‹±ä¼Ÿè¾¾2025å¹´ç¬¬ä¸€å­£åº¦è´¢æŠ¥è¡¨ç°å¦‚ä½•&quot;&#125;)</span><br><span class="line">result[&#x27;answer&#x27;].content</span><br></pre></td></tr></table></figure>
<h4 id="sub-graphs-å­å›¾"><strong>Sub-graphs</strong> å­å›¾</h4>
<p>å­å›¾å…è®¸ä½ åœ¨å›¾è¡¨çš„ä¸åŒéƒ¨åˆ†åˆ›å»ºå’Œç®¡ç†ä¸åŒçš„çŠ¶æ€ã€‚è¿™åœ¨å¤šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­å°¤å…¶æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨æ¯ä¸ªæ™ºèƒ½ä½“éƒ½æœ‰å„è‡ªçŠ¶æ€çš„æ™ºèƒ½ä½“å›¢é˜Ÿä¸­ã€‚</p>
<p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<ul>
<li>æˆ‘æœ‰ä¸€ä¸ªç³»ç»Ÿï¼Œå®ƒæ¥æ”¶æ—¥å¿—ã€‚</li>
<li>è¯¥ç³»ç»Ÿé€šè¿‡ä¸åŒçš„ä»£ç†æ‰§è¡Œä¸¤ä¸ªç‹¬ç«‹çš„å­ä»»åŠ¡ï¼ˆæ€»ç»“æ—¥å¿—ï¼ŒæŸ¥æ‰¾æ•…éšœæ¨¡å¼ï¼‰ã€‚</li>
<li>æˆ‘å¸Œæœ›åœ¨ä¸¤ä¸ªä¸åŒçš„å­å›¾ä¸­æ‰§è¡Œè¿™ä¸¤ä¸ªæ“ä½œã€‚</li>
</ul>
<p>æœ€é‡è¦çš„æ˜¯è¦ç†è§£å›¾è¡¨æ˜¯å¦‚ä½•ä¼ è¾¾ä¿¡æ¯çš„ï¼</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œé€šä¿¡æ˜¯ <strong><em>*é€šè¿‡é‡å å¯†é’¥*</em></strong>
å®ç°çš„ï¼š</p>
<ul>
<li>å­å›¾å¯ä»¥è®¿é—®çˆ¶å›¾ä¸­çš„ <code>docs</code>ï¼ˆæ–‡æ¡£ï¼‰ã€‚</li>
<li>çˆ¶å›¾å¯ä»¥ä»å­å›¾ä¸­è®¿é—® <code>summary</code>ï¼ˆæ‘˜è¦ï¼‰å’Œ
<code>failure_report</code>ï¼ˆæ•…éšœæŠ¥å‘Šï¼‰ã€‚</li>
</ul>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/66dbb1abf89f2d847ee6f1ff_sub-graph1.png" alt="subgraph.png">
<figcaption aria-hidden="true">subgraph.png</figcaption>
</figure>
<ol type="1">
<li><strong>Logs (Traces)</strong>:
<ul>
<li>è¿™æ˜¯ç³»ç»Ÿçš„è¾“å…¥ï¼Œè¡¨ç¤ºä¸€ç³»åˆ—çš„æ—¥å¿—è®°å½•ã€‚</li>
</ul></li>
<li><strong>Entry Graph</strong>:
<ul>
<li>è¿™æ˜¯ç³»ç»Ÿçš„å…¥å£å›¾ï¼Œå®ƒåŒ…å«äº†æ€»ä½“çŠ¶æ€ï¼ˆOverall Stateï¼‰ï¼Œå…¶ä¸­åŒ…å«ï¼š
<ul>
<li><code>docs</code>ï¼šæ–‡æ¡£æˆ–æ—¥å¿—æ•°æ®ã€‚</li>
<li><code>summary report</code>ï¼šæ‘˜è¦æŠ¥å‘Šï¼Œè¿™æ˜¯ç³»ç»Ÿæ‰§è¡Œæ‘˜è¦ä»»åŠ¡åç”Ÿæˆçš„ã€‚</li>
<li><code>failure report</code>ï¼šæ•…éšœæŠ¥å‘Šï¼Œè¿™æ˜¯ç³»ç»Ÿæ‰§è¡Œæ•…éšœåˆ†æä»»åŠ¡åç”Ÿæˆçš„ã€‚</li>
</ul></li>
</ul></li>
<li><strong>Call sub-graphs</strong>:
<ul>
<li>è¿™æ˜¯ä»å…¥å£å›¾è°ƒç”¨ä¸¤ä¸ªå­å›¾çš„è¿‡ç¨‹ï¼Œåˆ†åˆ«ç”¨äºæ‰§è¡Œæ‘˜è¦å’Œæ•…éšœåˆ†æä»»åŠ¡ã€‚</li>
</ul></li>
<li><strong>Summarization</strong>:
<ul>
<li>è¿™ä¸ªå­å›¾è´Ÿè´£ç”Ÿæˆæ—¥å¿—çš„æ‘˜è¦ã€‚å®ƒçš„çŠ¶æ€ï¼ˆSummary Stateï¼‰åŒ…å«ï¼š
<ul>
<li><code>docs</code>ï¼šä¸å…¥å£å›¾å…±äº«çš„æ–‡æ¡£æ•°æ®ã€‚</li>
<li><code>summary</code>ï¼šæ‘˜è¦å†…å®¹ã€‚</li>
<li><code>summary report</code>ï¼šæ‘˜è¦æŠ¥å‘Šï¼Œè¿™æ˜¯æ‘˜è¦ä»»åŠ¡å®Œæˆåç”Ÿæˆçš„ã€‚</li>
</ul></li>
</ul></li>
<li><strong>Failure Analysis</strong>:
<ul>
<li>è¿™ä¸ªå­å›¾è´Ÿè´£åˆ†ææ—¥å¿—ä¸­çš„æ•…éšœæ¨¡å¼ã€‚å®ƒçš„çŠ¶æ€ï¼ˆFailure Analysis
Stateï¼‰åŒ…å«ï¼š
<ul>
<li><code>docs</code>ï¼šä¸å…¥å£å›¾å…±äº«çš„æ–‡æ¡£æ•°æ®ã€‚</li>
<li><code>failures</code>ï¼šæ•…éšœæ¨¡å¼ã€‚</li>
<li><code>failure report</code>ï¼šæ•…éšœæŠ¥å‘Šï¼Œè¿™æ˜¯æ•…éšœåˆ†æä»»åŠ¡å®Œæˆåç”Ÿæˆçš„ã€‚</li>
</ul></li>
</ul></li>
<li><strong>Finish</strong>:
<ul>
<li>è¿™æ˜¯æµç¨‹çš„ç»“æŸç‚¹ï¼Œè¡¨ç¤ºä¸¤ä¸ªå­å›¾çš„ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œå¹¶ä¸”ç”Ÿæˆäº†æ‘˜è¦æŠ¥å‘Šå’Œæ•…éšœæŠ¥å‘Šã€‚</li>
</ul></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from operator import add</span><br><span class="line">from typing_extensions import TypedDict</span><br><span class="line">from typing import List, Optional, Annotated</span><br><span class="line"></span><br><span class="line">#logsç»“æ„</span><br><span class="line">class Log(TypedDict):</span><br><span class="line">    id: str</span><br><span class="line">    question: str</span><br><span class="line">    docs: Optional[List]</span><br><span class="line">    answer: str</span><br><span class="line">    grade: Optional[int]</span><br><span class="line">    grader: Optional[str]</span><br><span class="line">    feedback: Optional[str]</span><br></pre></td></tr></table></figure>
<h5 id="sub-graphs"><strong>Sub graphs</strong></h5>
<p>è¿™é‡Œæ˜¯å¤±è´¥åˆ†æå­å›¾ï¼Œå®ƒä½¿ç”¨äº† <code>FailureAnalysisState</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line">from langgraph.graph import StateGraph, START, END</span><br><span class="line"></span><br><span class="line"># æ•…éšœåˆ†æå­å›¾</span><br><span class="line">class FailureAnalysisState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;ç”¨äºæ•…éšœåˆ†æçš„çŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs: List[Log] # æ¸…ç†åçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    failures: List[Log]     # åŒ…å«æ•…éšœçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    fa_summary: str         # æ•…éšœåˆ†ææ‘˜è¦</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class FailureAnalysisOutputState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;æ•…éšœåˆ†æçš„è¾“å‡ºçŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    fa_summary: str         # æ•…éšœåˆ†ææ‘˜è¦</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">def get_failures(state):</span><br><span class="line">    &quot;&quot;&quot;è·å–åŒ…å«æ•…éšœçš„æ—¥å¿—&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs = state[&quot;cleaned_logs&quot;]</span><br><span class="line">    # ä»æ¸…ç†åçš„æ—¥å¿—ä¸­ç­›é€‰å‡ºåŒ…å« &quot;grade&quot; é”®çš„æ—¥å¿—ï¼Œè¿™äº›è¢«è§†ä¸ºæ•…éšœ</span><br><span class="line">    failures = [log for log in cleaned_logs if &quot;grade&quot; in log]</span><br><span class="line">    return &#123;&quot;failures&quot;: failures&#125;</span><br><span class="line"></span><br><span class="line">def generate_summary(state):</span><br><span class="line">    &quot;&quot;&quot;ç”Ÿæˆæ•…éšœæ‘˜è¦&quot;&quot;&quot;</span><br><span class="line">    failures = state[&quot;failures&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šfa_summary = summary_generation(qs_summary)</span><br><span class="line">    fa_summary = &quot;Chroma æ–‡æ¡£çš„æ£€ç´¢è´¨é‡ä¸ä½³ã€‚&quot;</span><br><span class="line">    # ä¸ºæ¯ä¸ªæ•…éšœæ—¥å¿—ç”Ÿæˆä¸€ä¸ªå¤„ç†è¿‡çš„æ—¥å¿—æ ‡è¯†ç¬¦</span><br><span class="line">    return &#123;&quot;fa_summary&quot;: fa_summary, &quot;processed_logs&quot;: [f&quot;failure-analysis-on-log-&#123;failure[&#x27;id&#x27;]&#125;&quot; for failure in failures]&#125;</span><br><span class="line"></span><br><span class="line">fa_builder = StateGraph(state_schema=FailureAnalysisState,output_schema=FailureAnalysisOutputState)</span><br><span class="line">fa_builder.add_node(&quot;get_failures&quot;, get_failures)</span><br><span class="line">fa_builder.add_node(&quot;generate_summary&quot;, generate_summary)</span><br><span class="line">fa_builder.add_edge(START, &quot;get_failures&quot;)</span><br><span class="line">fa_builder.add_edge(&quot;get_failures&quot;, &quot;generate_summary&quot;)</span><br><span class="line">fa_builder.add_edge(&quot;generate_summary&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = fa_builder.compile()</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723094949158.png" alt="image-20250723094949158">
<figcaption aria-hidden="true">image-20250723094949158</figcaption>
</figure>
<p>è¿™é‡Œæ˜¯é—®é¢˜æ€»ç»“å­å›¾ï¼Œå®ƒä½¿ç”¨äº†
<code>QuestionSummarizationState</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># æ‘˜è¦ç”Ÿæˆå­å›¾</span><br><span class="line">class QuestionSummarizationState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;ç”¨äºé—®é¢˜æ‘˜è¦çš„çŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs: List[Log] # æ¸…ç†åçš„æ—¥å¿—åˆ—è¡¨</span><br><span class="line">    qs_summary: str         # é—®é¢˜æ‘˜è¦</span><br><span class="line">    report: str             # ä»æ‘˜è¦ç”Ÿæˆçš„æŠ¥å‘Š</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class QuestionSummarizationOutputState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;é—®é¢˜æ‘˜è¦çš„è¾“å‡ºçŠ¶æ€ã€‚&quot;&quot;&quot;</span><br><span class="line">    report: str             # æœ€ç»ˆæŠ¥å‘Š</span><br><span class="line">    processed_logs: List[str] # å·²å¤„ç†çš„æ—¥å¿—æ ‡è¯†ç¬¦åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">def generate_summary(state):</span><br><span class="line">    &quot;&quot;&quot;ä»æ—¥å¿—ç”Ÿæˆæ‘˜è¦ã€‚&quot;&quot;&quot;</span><br><span class="line">    cleaned_logs = state[&quot;cleaned_logs&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šsummary = summarize(generate_summary)</span><br><span class="line">    summary = &quot;é—®é¢˜é›†ä¸­åœ¨ ChatOllama å’Œ Chroma å‘é‡å­˜å‚¨çš„ä½¿ç”¨ä¸Šã€‚&quot;</span><br><span class="line">    # è¿”å›æ‘˜è¦ä»¥åŠå·²å¤„ç†çš„æ—¥å¿—ID</span><br><span class="line">    return &#123;&quot;qs_summary&quot;: summary, &quot;processed_logs&quot;: [f&quot;summary-on-log-&#123;log[&#x27;id&#x27;]&#125;&quot; for log in cleaned_logs]&#125;</span><br><span class="line"></span><br><span class="line">def send_to_slack(state):</span><br><span class="line">    &quot;&quot;&quot;æ¨¡æ‹Ÿå‘é€æŠ¥å‘Šã€‚&quot;&quot;&quot;</span><br><span class="line">    qs_summary = state[&quot;qs_summary&quot;]</span><br><span class="line">    # æ·»åŠ åŠŸèƒ½ï¼šreport = report_generation(qs_summary)</span><br><span class="line">    report = &quot;foo bar baz&quot;</span><br><span class="line">    return &#123;&quot;report&quot;: report&#125;</span><br><span class="line"></span><br><span class="line">qs_builder = StateGraph(QuestionSummarizationState,output_schema=QuestionSummarizationOutputState)</span><br><span class="line">qs_builder.add_node(&quot;generate_summary&quot;, generate_summary)</span><br><span class="line">qs_builder.add_node(&quot;send_to_slack&quot;, send_to_slack)</span><br><span class="line">qs_builder.add_edge(START, &quot;generate_summary&quot;)</span><br><span class="line">qs_builder.add_edge(&quot;generate_summary&quot;, &quot;send_to_slack&quot;)</span><br><span class="line">qs_builder.add_edge(&quot;send_to_slack&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = qs_builder.compile()</span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723100648199.png" alt="image-20250723100648199">
<figcaption aria-hidden="true">image-20250723100648199</figcaption>
</figure>
<h5 id="adding-sub-graphs-to-our-parent-graph-å‘çˆ¶å›¾æ·»åŠ å­å›¾"><strong>Adding
sub graphs to our parent graph </strong>
<strong>å‘çˆ¶å›¾æ·»åŠ å­å›¾</strong></h5>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ã€‚æˆ‘ä»¬ä½¿ç”¨
<code>EntryGraphState</code>
åˆ›å»ºçˆ¶å›¾ã€‚å¹¶ä¸”æˆ‘ä»¬å°†æˆ‘ä»¬çš„å­å›¾æ·»åŠ ä¸ºèŠ‚ç‚¹ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å…¥å£å›¾</span><br><span class="line">class EntryGraphState(TypedDict):</span><br><span class="line">    # åŸå§‹æ—¥å¿—æ•°æ®åˆ—è¡¨</span><br><span class="line">    raw_logs: List[Log]</span><br><span class="line">    # ç»è¿‡æ¸…æ´—å¤„ç†åçš„æ—¥å¿—æ•°æ®åˆ—è¡¨</span><br><span class="line">    cleaned_logs: List[Log]</span><br><span class="line">    fa_summary: str # è¿™åªä¼šåœ¨æ•…éšœåˆ†æå­å›¾ä¸­ç”Ÿæˆ</span><br><span class="line">    report: str # è¿™åªä¼šåœ¨é—®é¢˜æ‘˜è¦å­å›¾ä¸­ç”Ÿæˆ</span><br><span class="line">    processed_logs:  Annotated[List[int], add] # è·Ÿè¸ªå“ªäº›æ—¥å¿—å·²ç»è¢«å¤„ç†è¿‡ ï¼Œå°¤å…¶æ˜¯åœ¨å­å›¾ä¹‹é—´å…±äº«çŠ¶æ€æ—¶ã€‚</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def clean_logs(state):</span><br><span class="line">    # è·å–æ—¥å¿—</span><br><span class="line">    raw_logs = state[&quot;raw_logs&quot;]</span><br><span class="line">    # æ•°æ®æ¸…æ´— raw_logs -&gt; docs</span><br><span class="line">    cleaned_logs = raw_logs</span><br><span class="line">    return &#123;&quot;cleaned_logs&quot;: cleaned_logs&#125;</span><br><span class="line"></span><br><span class="line">entry_builder = StateGraph(EntryGraphState)</span><br><span class="line">entry_builder.add_node(&quot;clean_logs&quot;, clean_logs)</span><br><span class="line">#æ·»åŠ å­å›¾</span><br><span class="line">entry_builder.add_node(&quot;question_summarization&quot;, qs_builder.compile())</span><br><span class="line">entry_builder.add_node(&quot;failure_analysis&quot;, fa_builder.compile())</span><br><span class="line"></span><br><span class="line">entry_builder.add_edge(START, &quot;clean_logs&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;clean_logs&quot;, &quot;failure_analysis&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;clean_logs&quot;, &quot;question_summarization&quot;)</span><br><span class="line">entry_builder.add_edge(&quot;failure_analysis&quot;, END)</span><br><span class="line">entry_builder.add_edge(&quot;question_summarization&quot;, END)</span><br><span class="line"></span><br><span class="line">graph = entry_builder.compile()</span><br><span class="line"></span><br><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line"># å°† xray è®¾ç½®ä¸º 1 å°†æ˜¾ç¤ºåµŒå¥—å›¾çš„å†…éƒ¨ç»“æ„</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723102913524.png" alt="image-20250723102913524">
<figcaption aria-hidden="true">image-20250723102913524</figcaption>
</figure>
<h4 id="map-reduce"><strong>Map-reduce</strong></h4>
<p>LangGraph é‡Œçš„ <strong>Map-Reduce</strong>
æ˜¯ä¸€ç§<strong>å¹¶è¡Œå¤„ç†æ¨¡å¼</strong>ï¼Œç”¨äºå°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼ˆMapï¼‰ï¼Œå†æ±‡æ€»ç»“æœï¼ˆReduceï¼‰ã€‚è¿™æ˜¯
LangGraph
ä¸­å¤„ç†<strong>æ‰¹é‡æ•°æ®æˆ–å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ</strong>çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚</p>
<p>è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå°†å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol type="1">
<li><strong>æ˜ å°„ï¼ˆMapï¼‰</strong> â€”â€” æ ¹æ®ä¸»é¢˜ç”Ÿæˆä¸€ç»„ç¬‘è¯ã€‚<br>
</li>
<li><strong>å½’çº¦ï¼ˆReduceï¼‰</strong> â€”â€” ä»è¿™ç»„ç¬‘è¯ä¸­æŒ‘å‡ºæœ€æ£’çš„ä¸€æ¡ã€‚</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from langchain_openai import ChatOpenAI</span><br><span class="line"></span><br><span class="line"># Prompts we will use</span><br><span class="line">subjects_prompt = &quot;&quot;&quot;ç”Ÿæˆä¸€ä¸ªåŒ…å«3ä¸ªå­ä¸»é¢˜çš„åˆ—è¡¨ï¼Œè¿™äº›å­ä¸»é¢˜éƒ½ä¸ä»¥ä¸‹æ€»ä½“ä¸»é¢˜ç›¸å…³ï¼š&#123;topic&#125;ã€‚&quot;&quot;&quot;</span><br><span class="line">joke_prompt = &quot;&quot;&quot;ç”Ÿæˆä¸€ä¸ªå…³äº&#123;subject&#125;çš„ç¬‘è¯&quot;&quot;&quot;</span><br><span class="line">best_joke_prompt = &quot;&quot;&quot;ä¸‹é¢æ˜¯å…³äº&#123;topic&#125;çš„ä¸€å †ç¬‘è¯ã€‚é€‰æ‹©æœ€å¥½çš„ä¸€ä¸ªï¼è¿”å›æœ€å¥½ç¬‘è¯çš„IDï¼Œç¬¬ä¸€ä¸ªç¬‘è¯çš„IDä»0å¼€å§‹ã€‚ç¬‘è¯ï¼š\n\n  &#123;jokes&#125;&quot;&quot;&quot;</span><br><span class="line"># LLM</span><br><span class="line">model = ChatOpenAI(</span><br><span class="line">    model=&quot;qwen-plus-2025-04-28&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;,</span><br><span class="line">    base_url=&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h5 id="parallelizing-joke-generation-å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ"><strong>Parallelizing
joke generation</strong> <strong>å¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆ</strong></h5>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰å›¾çš„å…¥å£ç‚¹ï¼Œå®ƒå°†ï¼š</p>
<ul>
<li>æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„ä¸»é¢˜<br>
</li>
<li>åŸºäºè¯¥ä¸»é¢˜ç”Ÿæˆè‹¥å¹²â€œç¬‘è¯å­ä¸»é¢˜â€<br>
</li>
<li>å°†æ¯ä¸ªå­ä¸»é¢˜å‘é€åˆ°ä¸Šé¢å®šä¹‰çš„ç¬‘è¯ç”ŸæˆèŠ‚ç‚¹</li>
</ul>
<p>æˆ‘ä»¬çš„çŠ¶æ€æœ‰ä¸€ä¸ª <code>jokes</code>
é”®ï¼Œå®ƒå°†ç´¯ç§¯æ¥è‡ªå¹¶è¡ŒåŒ–ç¬‘è¯ç”Ÿæˆçš„ç¬‘è¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Subjects(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰ä¸€ä¸ªPydanticæ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºä¸»é¢˜åˆ—è¡¨ã€‚&quot;&quot;&quot;</span><br><span class="line">    subjects: list[str] # ä¸»é¢˜å­—ç¬¦ä¸²åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">class BestJoke(BaseModel):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰ä¸€ä¸ªPydanticæ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºæœ€ä½³ç¬‘è¯çš„IDã€‚&quot;&quot;&quot;</span><br><span class="line">    id: int # æœ€ä½³ç¬‘è¯çš„ç´¢å¼•ID</span><br><span class="line">    </span><br><span class="line">class OverallState(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;å®šä¹‰æ•´ä¸ªå›¾çš„æ€»ä½“çŠ¶æ€ï¼Œä½¿ç”¨TypedDictä»¥ä¾¿äºç±»å‹æç¤ºå’ŒçŠ¶æ€ç®¡ç†ã€‚&quot;&quot;&quot;</span><br><span class="line">    topic: str # å½“å‰è®¨è®ºçš„ä¸»é¢˜</span><br><span class="line">    subjects: list # ç”Ÿæˆçš„å­ä¸»é¢˜åˆ—è¡¨</span><br><span class="line">    jokes: Annotated[list, operator.add] # ç¬‘è¯åˆ—è¡¨ï¼Œä½¿ç”¨operator.addè¡¨ç¤ºåˆ—è¡¨å†…å®¹ä¼šç´¯åŠ è€Œä¸æ˜¯è¦†ç›–</span><br><span class="line">    best_selected_joke: str # æœ€ç»ˆé€‰å‡ºçš„æœ€ä½³ç¬‘è¯</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆç¬‘è¯çš„ä¸»é¢˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#ç”¨äºç”Ÿæˆä¸»é¢˜</span><br><span class="line">def generate_topics(state: OverallState):</span><br><span class="line">    #ä½¿ç”¨ Python çš„ format() æ–¹æ³•æ¥æ„å»ºä¸€ä¸ªæç¤ºå­—ç¬¦ä¸²ï¼ˆ prompt ï¼‰</span><br><span class="line">    prompt = subjects_prompt.format(topic=state[&quot;topic&quot;])</span><br><span class="line">    #.with_structured_output(Subjects) å®ƒæŒ‡ç¤ºæ¨¡å‹å°è¯•å°†å…¶è¾“å‡ºæ ¼å¼åŒ–ä¸º Subjects ç±»</span><br><span class="line">    response = model.with_structured_output(Subjects).invoke(prompt)</span><br><span class="line">    return &#123;&quot;subjects&quot;: response.subjects&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯å¦™å¤„ï¼šæˆ‘ä»¬åˆ©ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/low_level/#send"><code>Send</code></a>
ä¸ºæ¯ä¸ªä¸»é¢˜å¹¶è¡Œç”Ÿæˆç¬‘è¯ã€‚</p>
<p>éå¸¸å®ç”¨ï¼æ— è®ºä¸»é¢˜æ•°é‡å¤šå°‘ï¼Œå®ƒéƒ½èƒ½è‡ªåŠ¨å¹¶è¡Œå¤„ç†ã€‚</p>
<ul>
<li><code>generate_joke</code>ï¼šå›¾ä¸­èŠ‚ç‚¹çš„åå­—<br>
</li>
<li><code>&#123;"subject": s&#125;</code>ï¼šè¦ä¼ é€’çš„çŠ¶æ€</li>
</ul>
<p><code>Send</code> å…è®¸ä½ å‘ <code>generate_joke</code>
èŠ‚ç‚¹å‘é€<strong>ä»»æ„</strong>ç»“æ„çš„çŠ¶æ€ï¼Œæ— éœ€ä¸
<code>OverallState</code> å¯¹é½ã€‚<br>
åœ¨è¿™é‡Œï¼Œ<code>generate_joke</code> ä½¿ç”¨è‡ªå·±çš„å†…éƒ¨çŠ¶æ€ï¼Œæˆ‘ä»¬é€šè¿‡
<code>Send</code> æŒ‰éœ€å¡«å……å³å¯ã€‚</p>
<blockquote>
<p>åœ¨ LangGraph é‡Œï¼Œ<code>Send</code>
æ˜¯ä¸€ä¸ª<strong>â€œåŠ¨æ€æ´¾å‘å™¨â€</strong>ï¼šå®ƒè®©ä½ <strong>åœ¨è¿è¡Œæ—¶</strong>å†³å®šâ€œè¦æŠŠå“ªä¸ªèŠ‚ç‚¹è¿è¡Œå¤šå°‘æ¬¡ã€æ¯æ¬¡ç»™å®ƒä»€ä¹ˆæ•°æ®â€ï¼Œå¹¶è‡ªåŠ¨å¹¶è¡Œæ‰§è¡Œã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from langgraph.types import Send</span><br><span class="line">def continue_to_jokes(state: OverallState):</span><br><span class="line">    # è¯¥å‡½æ•°æ ¹æ®å½“å‰çŠ¶æ€ä¸­çš„ä¸»é¢˜åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªä¸»é¢˜ç”Ÿæˆä¸€ä¸ª Send å¯¹è±¡ã€‚</span><br><span class="line">    # æ¯ä¸ª Send å¯¹è±¡éƒ½æŒ‡ç¤ºå›¾å°†æ•°æ®å‘é€åˆ°åä¸º &quot;generate_joke&quot; çš„èŠ‚ç‚¹ï¼Œ</span><br><span class="line">    # å¹¶å°†å½“å‰ä¸»é¢˜ä½œä¸º &quot;subject&quot; å‚æ•°ä¼ é€’ï¼Œä»è€Œå®ç°å¹¶è¡Œç”Ÿæˆç¬‘è¯ã€‚</span><br><span class="line">    return [Send(&quot;generate_joke&quot;, &#123;&quot;subject&quot;: s&#125;) for s in state[&quot;subjects&quot;]]</span><br></pre></td></tr></table></figure>
<h5 id="joke-generation-map-ç¬‘è¯ç”Ÿæˆ"><strong>Joke generation
(map)</strong> <strong>ç¬‘è¯ç”Ÿæˆ</strong></h5>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹æ¥ç”Ÿæˆç¬‘è¯ï¼Œå‘½åä¸º
<code>generate_joke</code>ï¼</p>
<p>ç”Ÿæˆçš„ç¬‘è¯ä¼šè¢«å†™å›åˆ° <code>OverallState</code> ä¸­çš„
<code>jokes</code> å­—æ®µã€‚ è¯¥å­—æ®µé…æœ‰
reducerï¼Œèƒ½å¤Ÿè‡ªåŠ¨æŠŠå¤šæ¬¡å†™å…¥çš„åˆ—è¡¨åˆå¹¶æˆä¸€ä¸ªå¤§åˆ—è¡¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># å®šä¹‰ JokeStateï¼Œç”¨äºè¡¨ç¤ºç”Ÿæˆç¬‘è¯ä»»åŠ¡çš„è¾“å…¥çŠ¶æ€ã€‚</span><br><span class="line">class JokeState(TypedDict):</span><br><span class="line">    subject: str#ç¬‘è¯çš„ä¸»é¢˜</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ Joke æ¨¡å‹ï¼Œç”¨äºè¡¨ç¤ºæ¨¡å‹ç”Ÿæˆçš„ç¬‘è¯çš„ç»“æ„ã€‚</span><br><span class="line">class Joke(BaseModel):</span><br><span class="line">    joke: str#ç¬‘è¯çš„æ–‡æœ¬å†…å®¹</span><br><span class="line"></span><br><span class="line"># å®šä¹‰ç”Ÿæˆç¬‘è¯çš„å‡½æ•°ã€‚</span><br><span class="line">def generate_joke(state: JokeState):</span><br><span class="line">    # æ ¹æ® joke_prompt æ¨¡æ¿å’Œå½“å‰çŠ¶æ€ä¸­çš„ä¸»é¢˜æ ¼å¼åŒ–æç¤ºã€‚</span><br><span class="line">    prompt = joke_prompt.format(subject=state[&quot;subject&quot;])</span><br><span class="line">    # è°ƒç”¨è¯­è¨€æ¨¡å‹ï¼Œå¹¶æŒ‡å®šè¾“å‡ºåº”ç»“æ„åŒ–ä¸º Joke ç±»å‹ã€‚</span><br><span class="line">    response = model.with_structured_output(Joke).invoke(prompt)</span><br><span class="line">    # è¿”å›ä¸€ä¸ªåŒ…å«ç”Ÿæˆçš„ç¬‘è¯çš„å­—å…¸ï¼Œé”®ä¸º &quot;jokes&quot;ã€‚</span><br><span class="line">    return &#123;&quot;jokes&quot;: [response.joke]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="best-joke-selection-reduce-æœ€ä½³ç¬‘è¯é€‰æ‹©"><strong>Best joke
selection (reduce)</strong> <strong>æœ€ä½³ç¬‘è¯é€‰æ‹©</strong></h5>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ·»åŠ é€»è¾‘æ¥æŒ‘é€‰æœ€å¥½çš„ç¬‘è¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def best_joke(state: OverallState):</span><br><span class="line">    # å°†çŠ¶æ€ä¸­æ‰€æœ‰ç¬‘è¯åˆ—è¡¨è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªç¬‘è¯ä¹‹é—´ç”¨ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš”</span><br><span class="line">    jokes = &quot;\n\n&quot;.join(state[&quot;jokes&quot;])</span><br><span class="line">    # ä½¿ç”¨ä¸»é¢˜å’Œæ‰€æœ‰ç¬‘è¯æ ¼å¼åŒ–æœ€ä½³ç¬‘è¯æç¤ºè¯­</span><br><span class="line">    prompt = best_joke_prompt.format(topic=state[&quot;topic&quot;], jokes=jokes)</span><br><span class="line">    # è°ƒç”¨æ¨¡å‹ï¼ŒæœŸæœ›å…¶è¾“å‡ºç¬¦åˆ BestJoke ç»“æ„ï¼ˆåŒ…å«æœ€ä½³ç¬‘è¯çš„IDï¼‰</span><br><span class="line">    response = model.with_structured_output(BestJoke).invoke(prompt)</span><br><span class="line">    # æ ¹æ®æ¨¡å‹è¿”å›çš„IDï¼Œä»ç¬‘è¯åˆ—è¡¨ä¸­é€‰æ‹©æœ€ä½³ç¬‘è¯ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨çŠ¶æ€çš„ best_selected_joke å­—æ®µä¸­</span><br><span class="line">    return &#123;&quot;best_selected_joke&quot;: state[&quot;jokes&quot;][response.id]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="compile-ç¼–è¯‘"><strong>Compile</strong> ç¼–è¯‘</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image</span><br><span class="line">from langgraph.graph import END, StateGraph, START</span><br><span class="line"></span><br><span class="line"># æ„å»ºå›¾ï¼šå°†æ‰€æœ‰ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·æ„å»ºæˆ‘ä»¬çš„æµç¨‹å›¾</span><br><span class="line">graph = StateGraph(OverallState)</span><br><span class="line"></span><br><span class="line">graph.add_node(&quot;generate_topics&quot;, generate_topics)</span><br><span class="line">graph.add_node(&quot;generate_joke&quot;, generate_joke)</span><br><span class="line">graph.add_node(&quot;best_joke&quot;, best_joke)</span><br><span class="line"></span><br><span class="line">graph.add_edge(START, &quot;generate_topics&quot;)</span><br><span class="line"># æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ç»§ç»­ç”Ÿæˆç¬‘è¯</span><br><span class="line">graph.add_conditional_edges(&quot;generate_topics&quot;, continue_to_jokes, [&quot;generate_joke&quot;])</span><br><span class="line"># ç”Ÿæˆç¬‘è¯åæ‰§è¡Œé€‰æ‹©æœ€ä½³ç¬‘è¯</span><br><span class="line">graph.add_edge(&quot;generate_joke&quot;, &quot;best_joke&quot;)</span><br><span class="line"># é€‰æ‹©æœ€ä½³ç¬‘è¯åæµç¨‹ç»“æŸ</span><br><span class="line">graph.add_edge(&quot;best_joke&quot;, END)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = graph.compile()</span><br><span class="line">Image(app.get_graph().draw_mermaid_png())</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250723112736244.png" alt="image-20250723112736244">
<figcaption aria-hidden="true">image-20250723112736244</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for s in app.stream(&#123;&quot;topic&quot;: &quot;æ—¥æœ¬å¹¿å²›åŸå­å¼¹&quot;&#125;):</span><br><span class="line">    print(s)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;generate_topics&#x27;: &#123;&#x27;subjects&#x27;: [&#x27;åŸå­å¼¹æŠ•æ”¾çš„å†å²èƒŒæ™¯ä¸å†³ç­–è¿‡ç¨‹&#x27;, &#x27;å¹¿å²›åŸçˆ†å¯¹åŸå¸‚ä¸å±…æ°‘çš„å½±å“&#x27;, &#x27;æˆ˜åå’Œå¹³è¿åŠ¨ä¸æ ¸è£å†›å€¡è®®&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&#x27;ä¸ºä»€ä¹ˆå¹¿å²›çš„é‡å»ºè®¡åˆ’ä»ä¸æ‹…å¿ƒäº¤é€šå µå¡ï¼Ÿå› ä¸ºæ¯ä¸ªäººéƒ½ä¹ æƒ¯äº†â€˜ç¬é—´æ¶ˆå¤±â€™ï¼ï¼ˆæ³¨ï¼šæ­¤ç¬‘è¯ä¸ºè™šæ„åˆ›ä½œï¼Œæ—¨åœ¨ä»¥å¹½é»˜æ–¹å¼å¼•å‘æ€è€ƒï¼Œå¹¶éå¯¹å†å²äº‹ä»¶çš„ä¸å°Šé‡ï¼‰&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&#x27;æˆ˜åå’Œå¹³è¿åŠ¨çš„äººå¼€ä¼šè®¨è®ºæ ¸è£å†›ï¼Œä¸€ä¸ªäººç«™èµ·æ¥è¯´ï¼šâ€˜æˆ‘ä»¬å¿…é¡»å½»åº•é”€æ¯æ‰€æœ‰æ ¸æ­¦å™¨ï¼â€™ å¦ä¸€ä¸ªäººçŠ¹è±«åœ°ä¸¾æ‰‹ï¼šâ€˜é‚£â€¦â€¦æˆ‘ä»¬ä¿ç•™ä¸€ä¸ªå§ï¼Œå°±ä¸€ä¸ªï¼Œè—åœ¨å†°ç®±åé¢ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚â€™&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#x27;generate_joke&#x27;: &#123;&#x27;jokes&#x27;: [&quot;æœé²é—¨å®£å¸ƒè¦ç»“æŸæˆ˜äº‰ï¼Œé¡¾é—®é—®æ˜¯å¦è¦ä½¿ç”¨åŸå­å¼¹ã€‚ç½—æ–¯ç¦çš„æ£ºææ¿çªç„¶éœ‡åŠ¨äº†ä¸€ä¸‹ï¼Œä¸˜å‰å°”çš„é›ªèŒ„æ‰åœ¨äº†åœ°ä¸Šï¼Œæ–¯å¤§æ—åˆ™é»˜é»˜æ‹¿èµ·äº†ç”µè¯ï¼š&#x27;åŒå¿—ï¼Œæˆ‘ä»¬çš„è®¡åˆ’å¯èƒ½éœ€è¦å†æ¨è¿Ÿä¸€ä¸‹ã€‚&#x27;&quot;]&#125;&#125;</span><br><span class="line">&#123;&#x27;best_joke&#x27;: &#123;&#x27;best_selected_joke&#x27;: &#x27;ä¸ºä»€ä¹ˆå¹¿å²›çš„é‡å»ºè®¡åˆ’ä»ä¸æ‹…å¿ƒäº¤é€šå µå¡ï¼Ÿå› ä¸ºæ¯ä¸ªäººéƒ½ä¹ æƒ¯äº†â€˜ç¬é—´æ¶ˆå¤±â€™ï¼ï¼ˆæ³¨ï¼šæ­¤ç¬‘è¯ä¸ºè™šæ„åˆ›ä½œï¼Œæ—¨åœ¨ä»¥å¹½é»˜æ–¹å¼å¼•å‘æ€è€ƒï¼Œå¹¶éå¯¹å†å²äº‹ä»¶çš„ä¸å°Šé‡ï¼‰&#x27;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Research Assistant</strong> <strong>ç ”ç©¶åŠ©ç†</strong></p>
<p>è§å¦ä¸€ç¯‡æ–‡ç« </p>
<h3 id="module-5">module-5</h3>
<h4 id="chatbot-with-memory-å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with Memory</strong> <strong>å¸¦æœ‰è®°å¿†åŠŸèƒ½çš„èŠå¤©æœºå™¨äºº</strong></h4>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ä»‹ç» <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Memory Store</a> ä½œä¸ºä¸€ç§ä¿å­˜å’Œæ£€ç´¢é•¿æœŸè®°å¿†çš„æ–¹æ³•ã€‚</p>
<blockquote>
<p>LangGraph Memory Store æ˜¯ <strong>LangGraph
æä¾›çš„é•¿æœŸè®°å¿†å­˜å‚¨æ¥å£</strong>ï¼Œç”¨äºåœ¨
<strong>ä¸åŒå¯¹è¯çº¿ç¨‹ä¹‹é—´</strong> æŒä¹…åŒ–ä¿å­˜å’Œæ£€ç´¢ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<table>
<colgroup>
<col style="width: 38%">
<col style="width: 61%">
</colgroup>
<thead>
<tr>
<th>åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>BaseStore</strong></td>
<td>æŠ½è±¡æ¥å£ï¼Œå®šä¹‰äº† <code>put/get/search/delete</code> ç­‰æ“ä½œæ–¹æ³•</td>
</tr>
<tr>
<td><strong>InMemoryStore</strong></td>
<td>å†…å­˜å®ç°ï¼Œé€‚åˆåŸå‹éªŒè¯</td>
</tr>
<tr>
<td><strong>RedisStore / AsyncRedisStore</strong></td>
<td>ç”Ÿäº§çº§å®ç°ï¼Œæ”¯æŒå‘é‡æœç´¢ã€å…ƒæ•°æ®è¿‡æ»¤å’Œå‘½åç©ºé—´ç®¡ç†</td>
</tr>
</tbody>
</table>
</blockquote>
<p>æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªä½¿ç”¨
<code>short-term (within-threadä»…å½“å‰å¯¹è¯çº¿ç¨‹)</code> å’Œ
<code>long-term (across-threadè·¨æ‰€æœ‰å¯¹è¯çº¿ç¨‹    )</code>
å†…å­˜çš„èŠå¤©æœºå™¨äººã€‚</p>
<p>æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨é•¿æœŸ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#semantic-memory">semantic
memory<strong>ï¼ˆè¯­ä¹‰è®°å¿†ï¼‰</strong></a>ï¼Œå®ƒå°†åŒ…å«å…³äºç”¨æˆ·çš„äº‹å®ä¿¡æ¯ã€‚è¿™äº›é•¿æœŸè®°å¿†å°†è¢«ç”¨äºåˆ›å»ºä¸€ä¸ªä¸ªæ€§åŒ–çš„èŠå¤©æœºå™¨äººï¼Œå®ƒå¯ä»¥è®°ä½æœ‰å…³ç”¨æˆ·çš„äº‹å®ã€‚</p>
<p>å®ƒå°†èŠ‚çœå†…å­˜ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#writing-memories">â€œin
the hot pathâ€</a>ï¼Œå½“ç”¨æˆ·ä¸ä¹‹èŠå¤©æ—¶ã€‚</p>
<blockquote>
<p><strong>â€œin the hot pathâ€</strong>
æŒ‡çš„æ˜¯ï¼š<strong>åœ¨å¯¹è¯æˆ–ä»»åŠ¡æ‰§è¡Œçš„</strong>ä¸»æµç¨‹ä¸­<strong>ï¼ˆå³ç”¨æˆ·è¾“å…¥åç«‹å³ã€åŒæ­¥åœ°ï¼‰</strong>ä¸»åŠ¨è°ƒç”¨å·¥å…·æˆ–å†™å…¥è®°å¿†ï¼Œä½¿ä¿¡æ¯<strong>å®æ—¶ç”Ÿæ•ˆ</strong>å¹¶å¯ç”¨äºä¸‹ä¸€æ­¥å†³ç­–ã€‚</p>
</blockquote>
<h5 id="introduction-to-the-langgraph-store-langgraph-å­˜å‚¨ç®€ä»‹"><strong>Introduction
to the LangGraph Store</strong> <strong>LangGraph å­˜å‚¨ç®€ä»‹</strong></h5>
<p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Memory Store</a> æä¾›äº†ä¸€ç§åœ¨ LangGraph ä¸­ <strong>è·¨çº¿ç¨‹</strong>
å­˜å‚¨å’Œæ£€ç´¢ä¿¡æ¯çš„æ–¹å¼ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºæŒä¹…åŒ– <code>key-value</code> å­˜å‚¨çš„
<a target="_blank" rel="noopener" href="https://blog.langchain.dev/launching-long-term-memory-support-in-langgraph/">å¼€æºåŸºç±»</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">from langgraph.store.memory import InMemoryStore</span><br><span class="line">in_memory_store = InMemoryStore()</span><br></pre></td></tr></table></figure>
<p>åœ¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">Store</a>
ä¸­å­˜å‚¨å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œè®°å¿†ï¼‰æ—¶ï¼Œæˆ‘ä»¬æä¾›ï¼š</p>
<p>- å¯¹è±¡çš„ <code>namespace</code>ï¼ˆç±»ä¼¼äºç›®å½•çš„å…ƒç»„ï¼‰</p>
<p>- å¯¹è±¡çš„ <code>key</code>ï¼ˆç±»ä¼¼äºæ–‡ä»¶åï¼‰</p>
<p>- å¯¹è±¡çš„ <code>value</code>ï¼ˆç±»ä¼¼äºæ–‡ä»¶å†…å®¹ï¼‰</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.put">put</a>
æ–¹æ³•é€šè¿‡ <code>namespace</code> å’Œ <code>key</code>
å°†å¯¹è±¡ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250725155616205-1753430177489-3.png" alt="image-20250725155616205">
<figcaption aria-hidden="true">image-20250725155616205</figcaption>
</figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†è®¾ç½®å‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;  # ç”¨æˆ·ID</span><br><span class="line">namespace_for_memory = (user_id, &quot;memories&quot;)  # è®°å¿†å‘½åç©ºé—´</span><br><span class="line"></span><br><span class="line"># ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„é”®å€¼</span><br><span class="line">key = str(uuid.uuid4())  # ä½¿ç”¨UUIDåˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸ºé”®</span><br><span class="line"></span><br><span class="line"># å€¼éœ€è¦æ˜¯ä¸€ä¸ªå­—å…¸æ ¼å¼</span><br><span class="line">value = &#123;&quot;food_preference&quot;: &quot;æˆ‘å–œæ¬¢æŠ«è¨&quot;&#125;  # å­˜å‚¨çš„é£Ÿç‰©åå¥½ä¿¡æ¯</span><br><span class="line"></span><br><span class="line"># ä¿å­˜è®°å¿†</span><br><span class="line">in_memory_store.put(namespace_for_memory, key, value)  # å°†è®°å¿†å­˜å‚¨åˆ°å†…å­˜ä¸­</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.search">search</a>
é€šè¿‡ <code>namespace</code> ä»å­˜å‚¨ä¸­æ£€ç´¢å¯¹è±¡ã€‚è¿™å°†è¿”å›ä¸€ä¸ªåˆ—è¡¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">memories = in_memory_store.search(namespace_for_memory)</span><br><span class="line">type(memories)</span><br><span class="line"></span><br><span class="line"># Metatdata </span><br><span class="line">memories[0].dict()</span><br><span class="line"></span><br><span class="line"># The key, value</span><br><span class="line">print(memories[0].key, memories[0].value)</span><br><span class="line">9e65de8a-f404-4974-b509-0df0566d8fb5 &#123;&#x27;food_preference&#x27;: &#x27;æˆ‘å–œæ¬¢æŠ«è¨&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.get">get</a>
é€šè¿‡ <code>namespace</code> å’Œ <code>key</code> æ£€ç´¢å¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Get the memory by namespace and key</span><br><span class="line">memory = in_memory_store.get(namespace_for_memory, key)</span><br><span class="line">memory.dict()</span><br></pre></td></tr></table></figure>
<h5 id="chatbot-with-long-term-memory-å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with long-term memory</strong>
<strong>å…·æœ‰é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº</strong></h5>
<p>æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œ<a target="_blank" rel="noopener" href="https://docs.google.com/presentation/d/181mvjlgsnxudQI6S3ritg9sooNyu4AcLLFH1UK0kIuk/edit#slide=id.g30eb3c8cf10_0_156">æœ‰ä¸¤ç§è®°å¿†çš„æ–¹å¼</a>:</p>
<ol type="1">
<li><code>Short-term (within-thread) memory</code>:
èŠå¤©æœºå™¨äººå¯ä»¥ä¿ç•™ä¼šè¯å†å²è®°å½•å’Œ/æˆ–å…è®¸åœ¨èŠå¤©ä¼šè¯ä¸­è¿›è¡Œä¸­æ–­ã€‚<br>
</li>
<li><code>Long-term (cross-thread) memory</code>:
èŠå¤©æœºå™¨äººå¯ä»¥è®°ä½ç‰¹å®šç”¨æˆ·åœ¨æ‰€æœ‰èŠå¤©ä¼šè¯ä¸­çš„ä¿¡æ¯
<strong>è·¨ä¼šè¯</strong>ã€‚</li>
</ol>
<p>å¯¹äº <code>short-term memory</code>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/persistence/#checkpointer-libraries">checkpointer</a>ã€‚</p>
<ul>
<li>ä»–ä»¬åœ¨æ¯ä¸€æ­¥éƒ½å°†å›¾çŠ¶æ€å†™å…¥çº¿ç¨‹ä¸­ã€‚</li>
<li>ä»–ä»¬åœ¨è¯¥çº¿ç¨‹ä¸­æŒä¹…åŒ–ä¿å­˜èŠå¤©å†å²è®°å½•ã€‚</li>
<li>ä»–ä»¬å…è®¸å›¾åœ¨è¯¥çº¿ç¨‹ä¸­çš„ä»»ä½•æ­¥éª¤è¢«ä¸­æ–­å’Œ/æˆ–æ¢å¤ã€‚</li>
</ul>
<p>å¯¹äº <code>long-term memory</code>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸Šé¢ä»‹ç»çš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Store</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.graph import StateGraph, MessagesState, START, END</span><br><span class="line">from langgraph.store.base import BaseStore</span><br><span class="line"></span><br><span class="line">from langchain_core.messages import HumanMessage, SystemMessage</span><br><span class="line">from langchain_core.runnables.config import RunnableConfig</span><br><span class="line"></span><br><span class="line"># èŠå¤©æœºå™¨äººæŒ‡ä»¤</span><br><span class="line">MODEL_SYSTEM_MESSAGE = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰è®°å¿†åŠŸèƒ½çš„æœ‰ç”¨åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæä¾›å…³äºç”¨æˆ·çš„ä¿¡æ¯ã€‚</span><br><span class="line">å¦‚æœä½ æœ‰è¿™ä¸ªç”¨æˆ·çš„è®°å¿†ï¼Œè¯·ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯è®°å¿†å†…å®¹ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># æ ¹æ®èŠå¤©å†å²å’Œä»»ä½•ç°æœ‰è®°å¿†åˆ›å»ºæ–°è®°å¿†</span><br><span class="line">CREATE_MEMORY_INSTRUCTION = &quot;&quot;&quot;&quot;ä½ æ­£åœ¨æ”¶é›†ç”¨æˆ·ä¿¡æ¯ä»¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line"></span><br><span class="line">å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š</span><br><span class="line">&#123;memory&#125;</span><br><span class="line"></span><br><span class="line">æŒ‡ä»¤ï¼š</span><br><span class="line">1. ä»”ç»†æŸ¥çœ‹ä¸‹é¢çš„èŠå¤©å†å²</span><br><span class="line">2. è¯†åˆ«æœ‰å…³ç”¨æˆ·çš„æ–°ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</span><br><span class="line">   - ä¸ªäººè¯¦æƒ…ï¼ˆå§“åã€ä½ç½®ï¼‰</span><br><span class="line">   - åå¥½ï¼ˆå–œæ¬¢ã€ä¸å–œæ¬¢ï¼‰</span><br><span class="line">   - å…´è¶£å’Œçˆ±å¥½</span><br><span class="line">   - è¿‡å»çš„ç»å†</span><br><span class="line">   - ç›®æ ‡æˆ–æœªæ¥è®¡åˆ’</span><br><span class="line">3. å°†ä»»ä½•æ–°ä¿¡æ¯ä¸ç°æœ‰è®°å¿†åˆå¹¶</span><br><span class="line">4. å°†è®°å¿†æ ¼å¼åŒ–ä¸ºæ¸…æ™°çš„é¡¹ç›®ç¬¦å·åˆ—è¡¨</span><br><span class="line">5. å¦‚æœæ–°ä¿¡æ¯ä¸ç°æœ‰è®°å¿†å†²çªï¼Œè¯·ä¿ç•™æœ€æ–°ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">è®°ä½ï¼šåªåŒ…æ‹¬ç”¨æˆ·ç›´æ¥é™ˆè¿°çš„äº‹å®ä¿¡æ¯ã€‚ä¸è¦åšå‡è®¾æˆ–æ¨æ–­ã€‚</span><br><span class="line"></span><br><span class="line">åŸºäºä»¥ä¸‹èŠå¤©å†å²ï¼Œè¯·æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼š&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;ä»å­˜å‚¨ä¸­åŠ è½½è®°å¿†å¹¶ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å›å¤ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line">    existing_memory = store.get(namespace, key)</span><br><span class="line"></span><br><span class="line">    # å¦‚æœå­˜åœ¨åˆ™æå–å®é™…çš„è®°å¿†å†…å®¹å¹¶æ·»åŠ å‰ç¼€</span><br><span class="line">    if existing_memory:</span><br><span class="line">        # å€¼æ˜¯ä¸€ä¸ªå¸¦æœ‰memoryé”®çš„å­—å…¸</span><br><span class="line">        existing_memory_content = existing_memory.value.get(&#x27;memory&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        existing_memory_content = &quot;æœªæ‰¾åˆ°ç°æœ‰è®°å¿†ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=existing_memory_content)</span><br><span class="line">    </span><br><span class="line">    # ä½¿ç”¨è®°å¿†ä»¥åŠèŠå¤©å†å²è¿›è¡Œå›å¤</span><br><span class="line">    response = model.invoke([SystemMessage(content=system_msg)]+state[&quot;messages&quot;])</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;messages&quot;: response&#125;</span><br><span class="line"></span><br><span class="line">def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;åæ€èŠå¤©å†å²å¹¶å°†è®°å¿†ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢ç°æœ‰è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">        </span><br><span class="line">    # æå–è®°å¿†</span><br><span class="line">    if existing_memory:</span><br><span class="line">        existing_memory_content = existing_memory.value.get(&#x27;memory&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        existing_memory_content = &quot;æœªæ‰¾åˆ°ç°æœ‰è®°å¿†ã€‚&quot;</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=existing_memory_content)</span><br><span class="line">    new_memory = model.invoke([SystemMessage(content=system_msg)]+state[&#x27;messages&#x27;])</span><br><span class="line"></span><br><span class="line">    # è¦†ç›–å­˜å‚¨ä¸­çš„ç°æœ‰è®°å¿†</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line"></span><br><span class="line">    # å°†å€¼å†™å…¥ä¸ºå¸¦æœ‰memoryé”®çš„å­—å…¸</span><br><span class="line">    store.put(namespace, key, &#123;&quot;memory&quot;: new_memory.content&#125;)</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å›¾</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;call_model&quot;, call_model)</span><br><span class="line">builder.add_node(&quot;write_memory&quot;, write_memory)</span><br><span class="line">builder.add_edge(START, &quot;call_model&quot;)</span><br><span class="line">builder.add_edge(&quot;call_model&quot;, &quot;write_memory&quot;)</span><br><span class="line">builder.add_edge(&quot;write_memory&quot;, END)</span><br><span class="line"></span><br><span class="line"># ç”¨äºè·¨çº¿ç¨‹çš„é•¿æœŸè®°å¿†å­˜å‚¨</span><br><span class="line">across_thread_memory = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ç”¨äºçº¿ç¨‹å†…çš„çŸ­æœŸè®°å¿†æ£€æŸ¥ç‚¹</span><br><span class="line">within_thread_memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ£€æŸ¥ç‚¹å™¨å’Œå­˜å‚¨ç¼–è¯‘å›¾</span><br><span class="line">graph = builder.compile(checkpointer=within_thread_memory, store=across_thread_memory)</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤ºå›¾</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250725161106319.png" alt="image-20250725161106319">
<figcaption aria-hidden="true">image-20250725161106319</figcaption>
</figure>
<p>èŠå¤©å†å²å°†é€šè¿‡æ£€æŸ¥ç‚¹å·¥å…·ä¿å­˜åˆ°çŸ­æœŸè®°å¿†ä¸­ã€‚èŠå¤©æœºå™¨äººå°†å›é¡¾èŠå¤©å†å²ã€‚ç„¶åï¼Œå®ƒå°†åˆ›å»ºå¹¶ä¿å­˜ä¸€ä¸ªè®°å¿†åˆ°
<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Store</a>ã€‚æ­¤å†…å­˜å¯åœ¨æœªæ¥çš„èŠå¤©ä¼šè¯ä¸­è®¿é—®ï¼Œä»¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å“åº”ã€‚</p>
<p>å½“æˆ‘ä»¬ä¸èŠå¤©æœºå™¨äººäº¤äº’æ—¶ï¼Œæˆ‘ä»¬æä¾›ä¸¤æ ·ä¸œè¥¿ï¼š</p>
<ol type="1">
<li><code>Short-term (within-thread) memory</code>:
ä¸€ä¸ªç”¨äºæŒä¹…åŒ–èŠå¤©å†å²çš„ <code>thread ID</code>ã€‚<br>
</li>
<li><code>Long-term (cross-thread) memory</code>:
ä¸€ä¸ªç”¨äºå°†é•¿æœŸè®°å¿†å‘½åç©ºé—´åˆ°ç”¨æˆ·çš„ <code>user ID</code>ã€‚</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›çº¿ç¨‹IDç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†</span><br><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿† </span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lance&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br><span class="line">    </span><br><span class="line">================================[1m Human Message [0m=================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lance</span><br><span class="line">==================================[1m Ai Message [0m==================================</span><br><span class="line"></span><br><span class="line">ä½ å¥½ï¼ŒLanceï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼ŸğŸ˜Š</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ <code>MemorySaver</code>
æ£€æŸ¥ç‚¹æ¥ç®¡ç†çº¿ç¨‹å†…å†…å­˜ã€‚è¿™ä¼šå°†èŠå¤©å†å²ä¿å­˜åˆ°çº¿ç¨‹ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¿å­˜åˆ°çº¿ç¨‹çš„èŠå¤©å†å²è®°å½•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">thread = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line">state = graph.get_state(thread).values</span><br><span class="line">for m in state[&quot;messages&quot;]: </span><br><span class="line">    m.pretty_print()</span><br></pre></td></tr></table></figure>
<p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å­˜å‚¨åº“ç¼–è¯‘äº†è¯¥å›¾ï¼š<code>across_thread_memory = InMemoryStore()</code>å¹¶ä¸”ï¼Œæˆ‘ä»¬å‘å›¾ä¸­æ·»åŠ äº†ä¸€ä¸ªèŠ‚ç‚¹
(<code>write_memory</code>)ï¼Œè¯¥èŠ‚ç‚¹åæ˜ äº†èŠå¤©å†å²å¹¶ä¿å­˜äº†ä¸€æ®µè®°å¿†åˆ°å­˜å‚¨ä¸­ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å†…å­˜æ˜¯å¦å·²ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†è®¾ç½®å‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">existing_memory = across_thread_memory.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">existing_memory.dict()</span><br><span class="line"></span><br><span class="line">&#123;&#x27;namespace&#x27;: [&#x27;memory&#x27;, &#x27;1&#x27;],</span><br><span class="line"> &#x27;key&#x27;: &#x27;user_memory&#x27;,</span><br><span class="line"> &#x27;value&#x27;: &#123;&#x27;memory&#x27;: &#x27;- å§“åï¼šLance  \n- ä½ç½®ï¼šæ—§é‡‘å±±  \n- å…´è¶£å’Œçˆ±å¥½ï¼šéª‘è‡ªè¡Œè½¦  \n- å–œæ¬¢çš„æ´»åŠ¨ï¼šåœ¨æ—§é‡‘å±±éª‘è¡Œï¼Œå¯èƒ½åŒ…æ‹¬é‡‘é—¨å¤§æ¡¥å’Œæ»¨æµ·åŒºè·¯çº¿&#x27;&#125;,</span><br><span class="line"> &#x27;created_at&#x27;: &#x27;2025-07-25T08:12:35.877160+00:00&#x27;,</span><br><span class="line"> &#x27;updated_at&#x27;: &#x27;2025-07-25T08:12:35.877161+00:00&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥
<strong>ç›¸åŒçš„ç”¨æˆ·ID</strong>å¯åŠ¨ä¸€ä¸ª<strong>æ–°çº¿ç¨‹</strong>ã€‚æˆ‘ä»¬åº”è¯¥çœ‹åˆ°èŠå¤©æœºå™¨äººè®°ä½äº†ç”¨æˆ·çš„ä¸ªäººèµ„æ–™ï¼Œå¹¶å°†å…¶ç”¨äºä¸ªæ€§åŒ–å“åº”ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºè·¨çº¿ç¨‹è®°å¿†ä»¥åŠä¸€ä¸ªæ–°çš„çº¿ç¨‹ID</span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;2&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼ä½ æ¨èæˆ‘å»å“ªé‡Œéª‘è‡ªè¡Œè½¦ï¼Ÿ&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<h4 id="chatbot-with-profile-schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with Profile Schema</strong>
<strong>å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h4>
<p>æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººå°†è®°å¿†ä¿å­˜ä¸ºå­—ç¬¦ä¸²ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›è®°å¿†å…·æœ‰ç»“æ„åŒ–æ ¼å¼ã€‚ä¾‹å¦‚ï¼Œè®°å¿†å¯ä»¥æ˜¯<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">å•ä¸ªã€æŒç»­æ›´æ–°çš„æ¨¡å¼</a>ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™æ˜¯ä¸€ä¸ªå•ä¸€çš„ç”¨æˆ·æ¡£æ¡ˆã€‚</p>
<p>æˆ‘ä»¬å°†æ‰©å±•æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººï¼Œå°†è¯­ä¹‰è®°å¿†ä¿å­˜åˆ°å•ä¸ª<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">ç”¨æˆ·æ¡£æ¡ˆ</a>ä¸­ã€‚æˆ‘ä»¬è¿˜å°†ä»‹ç»ä¸€ä¸ªåº“
<a target="_blank" rel="noopener" href="https://github.com/hinthornw/trustcall">Trustcall</a>ï¼Œç”¨äºä½¿ç”¨æ–°ä¿¡æ¯æ›´æ–°æ­¤æ¨¡å¼ã€‚</p>
<h5 id="defining-a-user-profile-schema-å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼"><strong>Defining
a user profile schema</strong>
<strong>å®šä¹‰ç”¨æˆ·é…ç½®æ–‡ä»¶æ¨¡å¼</strong></h5>
<p>Python æœ‰è®¸å¤šä¸åŒç±»å‹çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#schema-definition">structured
data</a>ï¼Œä¾‹å¦‚ TypedDictã€å­—å…¸ã€JSON å’Œ <a target="_blank" rel="noopener" href="https://docs.pydantic.dev/latest/">Pydantic</a>ã€‚</p>
<p>è®©æˆ‘ä»¬å…ˆä½¿ç”¨ TypedDict æ¥å®šä¹‰ä¸€ä¸ªç”¨æˆ·èµ„æ–™æ¨¡å¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from typing import TypedDict, List</span><br><span class="line"></span><br><span class="line">class UserProfile(TypedDict):</span><br><span class="line">    &quot;&quot;&quot;å¸¦æœ‰ç±»å‹å­—æ®µçš„ç”¨æˆ·æ¡£æ¡ˆæ¨¡å¼&quot;&quot;&quot;</span><br><span class="line">    user_name: str  # ç”¨æˆ·çš„é¦–é€‰åç§°</span><br><span class="line">    interests: List[str]  # ç”¨æˆ·å…´è¶£åˆ—è¡¨</span><br></pre></td></tr></table></figure>
<h5 id="saving-a-schema-to-the-store-å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­"><strong>Saving
a schema to the store</strong> <strong>å°†æ¨¡å¼ä¿å­˜åˆ°å­˜å‚¨ä¸­</strong></h5>
<p><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore">LangGraph
Store</a> æ¥å—ä»»ä½• Python å­—å…¸ä½œä¸º <code>value</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># TypedDict å®ä¾‹</span><br><span class="line">user_profile: UserProfile = &#123;</span><br><span class="line">    &quot;user_name&quot;: &quot;Lance&quot;,  # ç”¨æˆ·å</span><br><span class="line">    &quot;interests&quot;: [&quot;éª‘è¡Œ&quot;, &quot;ç§‘æŠ€&quot;, &quot;å’–å•¡&quot;]  # å…´è¶£çˆ±å¥½</span><br><span class="line">&#125;</span><br><span class="line">user_profile</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.put">put</a>
æ–¹æ³•å°† TypedDict ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">from langgraph.store.memory import InMemoryStore</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–å†…å­˜å­˜å‚¨</span><br><span class="line">in_memory_store = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ä¸ºè¦ä¿å­˜çš„è®°å¿†åˆ›å»ºå‘½åç©ºé—´</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace_for_memory = (user_id, &quot;memory&quot;)</span><br><span class="line"></span><br><span class="line"># å°†è®°å¿†ä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ°å‘½åç©ºé—´ä¸­</span><br><span class="line">key = &quot;user_profile&quot;</span><br><span class="line">value = user_profile</span><br><span class="line">in_memory_store.put(namespace_for_memory, key, value)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.search">search</a>
æŒ‰å‘½åç©ºé—´ä»å­˜å‚¨ä¸­æ£€ç´¢å¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for m in in_memory_store.search(namespace_for_memory):</span><br><span class="line">    print(m.dict())</span><br><span class="line">    </span><br><span class="line">&#123;&#x27;namespace&#x27;: [&#x27;1&#x27;, &#x27;memory&#x27;], &#x27;key&#x27;: &#x27;user_profile&#x27;, &#x27;value&#x27;: &#123;&#x27;user_name&#x27;: &#x27;Lance&#x27;, &#x27;interests&#x27;: [&#x27;éª‘è¡Œ&#x27;, &#x27;ç§‘æŠ€&#x27;, &#x27;å’–å•¡&#x27;]&#125;, &#x27;created_at&#x27;: &#x27;2025-07-25T08:58:06.031770+00:00&#x27;, &#x27;updated_at&#x27;: &#x27;2025-07-25T08:58:06.031775+00:00&#x27;, &#x27;score&#x27;: None&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore.get">get</a>
é€šè¿‡å‘½åç©ºé—´å’Œé”®æ¥æ£€ç´¢ç‰¹å®šå¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">profile = in_memory_store.get(namespace_for_memory, &quot;user_profile&quot;)</span><br><span class="line">profile.value</span><br><span class="line"></span><br><span class="line">&#123;&#x27;user_name&#x27;: &#x27;Lance&#x27;, &#x27;interests&#x27;: [&#x27;éª‘è¡Œ&#x27;, &#x27;ç§‘æŠ€&#x27;, &#x27;å’–å•¡&#x27;]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="chatbot-with-profile-schema-å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº-1"><strong>Chatbot
with profile schema</strong>
<strong>å¸¦æœ‰é…ç½®æ–‡ä»¶æ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h5>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•ä¸ºè®°å¿†æŒ‡å®šä¸€ä¸ªæ¨¡å¼ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¦‚ä½•æ ¹æ®è¿™ä¸ªç‰¹å®šçš„æ¨¡å¼
<strong>åˆ›å»º</strong> è®°å¿†ï¼Ÿ</p>
<p>åœ¨æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººä¸­ï¼Œæˆ‘ä»¬ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/memory/#profile">æƒ³è¦ä»ä¸€ä¸ªèŠå¤©é‡Œåˆ›å»ºè®°å¿†</a>.è¿™å°±æ˜¯
<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#recommended-usage">structured
outputsæ ¼å¼åŒ–è¾“å‡º</a> æ¦‚å¿µæœ‰ç”¨çš„åœ°æ–¹ã€‚</p>
<p>LangChain çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/chat_models/">chat
model</a> æ¥å£æœ‰ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/#recommended-usage">PROTECTED<span class="math inline">11</span></a>
æ–¹æ³•ç”¨äºå¼ºåˆ¶ç»“æ„åŒ–è¾“å‡ºã€‚è¿™åœ¨æˆ‘ä»¬éœ€è¦ç¡®ä¿è¾“å‡ºç¬¦åˆæŸä¸ªæ¨¡å¼æ—¶éå¸¸æœ‰ç”¨ï¼Œè€Œä¸”å®ƒä¼šä¸ºæˆ‘ä»¬è§£æè¾“å‡ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å°†æ¨¡å¼ç»‘å®šåˆ°æ¨¡å‹</span><br><span class="line">model_with_structure = model.with_structured_output(UserProfile)</span><br><span class="line"></span><br><span class="line"># è°ƒç”¨æ¨¡å‹ç”Ÿæˆç¬¦åˆæ¨¡å¼çš„ç»“æ„åŒ–è¾“å‡º</span><br><span class="line">structured_output = model_with_structure.invoke([HumanMessage(&quot;æˆ‘çš„åå­—æ˜¯Lanceï¼Œæˆ‘å–œæ¬¢éª‘è‡ªè¡Œè½¦ã€‚&quot;)])</span><br><span class="line">structured_output</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Structured outputsï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰
æŒ‡è®©å¤§æ¨¡å‹<strong>ä¸å†â€œéšæ„è¯´äººè¯â€</strong>ï¼Œè€Œæ˜¯<strong>æŒ‰ä½ äº‹å…ˆå®šä¹‰å¥½çš„æ ¼å¼ï¼ˆJSON
/ è¡¨æ ¼ / æšä¸¾ /
åµŒå¥—å¯¹è±¡ç­‰ï¼‰ç²¾ç¡®è¿”å›æ•°æ®</strong>ã€‚ç›¸å½“äºç»™æ¨¡å‹å¥—äº†ä¸€ä¸ªâ€œæ¨¡å…·â€ï¼Œä¿è¯è¾“å‡ºå¯ç›´æ¥è¢«ä»£ç è§£æã€å…¥åº“æˆ–ä¼ ç»™ä¸‹æ¸¸ç³»ç»Ÿï¼Œé¿å…å†ç”¨æ­£åˆ™ã€å­—ç¬¦ä¸²æ‹¼æ¥å»â€œçŒœâ€ç»“æœã€‚</p>
<p>ä½¿ç”¨å®˜æ–¹çš„å¤§æ¨¡å‹ç»„ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from langchain_community.chat_models import ChatTongyi</span><br><span class="line">model=ChatTongyi(</span><br><span class="line">    model=&quot;qwen-plus-2025-07-14&quot;,</span><br><span class="line">    api_key=&quot;sk-&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨èŠå¤©æœºå™¨äººä¸­ä½¿ç”¨å®ƒã€‚è¿™åªéœ€è¦å¯¹
<code>write_memory</code> å‡½æ•°è¿›è¡Œè½»å¾®ä¿®æ”¹ã€‚æˆ‘ä»¬ä½¿ç”¨
<code>model_with_structure</code>ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæ¥ç”Ÿæˆä¸€ä¸ªä¸æˆ‘ä»¬æ¨¡å¼åŒ¹é…çš„é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">from IPython.display import Image, display</span><br><span class="line"></span><br><span class="line">from langgraph.checkpoint.memory import MemorySaver</span><br><span class="line">from langgraph.graph import StateGraph, MessagesState, START, END</span><br><span class="line">from langgraph.store.base import BaseStore</span><br><span class="line"></span><br><span class="line">from langchain_core.messages import HumanMessage, SystemMessage, AIMessage</span><br><span class="line">from langchain_core.runnables.config import RunnableConfig</span><br><span class="line"></span><br><span class="line"># èŠå¤©æœºå™¨äººæŒ‡ä»¤</span><br><span class="line">MODEL_SYSTEM_MESSAGE = &quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰è®°å¿†åŠŸèƒ½çš„ helpful åŠ©æ‰‹ï¼Œå¯ä»¥æä¾›å…³äºç”¨æˆ·çš„ä¿¡æ¯ã€‚</span><br><span class="line">å¦‚æœä½ æœ‰è¿™ä¸ªç”¨æˆ·çš„è®°å¿†ï¼Œè¯·ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–ä½ çš„å›å¤ã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯è®°å¿†å†…å®¹ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># æ ¹æ®èŠå¤©å†å²å’Œä»»ä½•ç°æœ‰è®°å¿†åˆ›å»ºæ–°è®°å¿†</span><br><span class="line">CREATE_MEMORY_INSTRUCTION = &quot;&quot;&quot;æ ¹æ®ç”¨æˆ·çš„èŠå¤©å†å²åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆè®°å¿†ã€‚</span><br><span class="line">è¿™å°†è¢«ä¿å­˜ä¸ºé•¿æœŸè®°å¿†ã€‚å¦‚æœå­˜åœ¨ç°æœ‰è®°å¿†ï¼Œåªéœ€æ›´æ–°å®ƒã€‚</span><br><span class="line">ä»¥ä¸‹æ˜¯ç°æœ‰è®°å¿†ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ï¼š&#123;memory&#125;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;ä»å­˜å‚¨ä¸­åŠ è½½è®°å¿†å¹¶ä½¿ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å›å¤ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line"></span><br><span class="line">    # ä¸ºç³»ç»Ÿæç¤ºæ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    if existing_memory and existing_memory.value:</span><br><span class="line">        memory_dict = existing_memory.value</span><br><span class="line">        formatted_memory = (</span><br><span class="line">            f&quot;å§“å: &#123;memory_dict.get(&#x27;user_name&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;\n&quot;</span><br><span class="line">            f&quot;å…´è¶£: &#123;&#x27;, &#x27;.join(memory_dict.get(&#x27;interests&#x27;, []))&#125;&quot;</span><br><span class="line">        )</span><br><span class="line">    else:</span><br><span class="line">        formatted_memory = None</span><br><span class="line"></span><br><span class="line">    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=formatted_memory)</span><br><span class="line"></span><br><span class="line">    # ä½¿ç”¨è®°å¿†ä»¥åŠèŠå¤©å†å²æ¥å›å¤</span><br><span class="line">    response = model.invoke([SystemMessage(content=system_msg)]+state[&quot;messages&quot;])</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;messages&quot;: response&#125;</span><br><span class="line"></span><br><span class="line">def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):</span><br><span class="line"></span><br><span class="line">    &quot;&quot;&quot;åæ€èŠå¤©å†å²å¹¶å°†è®°å¿†ä¿å­˜åˆ°å­˜å‚¨ä¸­ã€‚&quot;&quot;&quot;</span><br><span class="line">    </span><br><span class="line">    # ä»é…ç½®ä¸­è·å–ç”¨æˆ·ID</span><br><span class="line">    user_id = config[&quot;configurable&quot;][&quot;user_id&quot;]</span><br><span class="line"></span><br><span class="line">    # ä»å­˜å‚¨ä¸­æ£€ç´¢ç°æœ‰è®°å¿†</span><br><span class="line">    namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">    existing_memory = store.get(namespace, &quot;user_memory&quot;)</span><br><span class="line"></span><br><span class="line">    # ä¸ºç³»ç»Ÿæç¤ºæ ¼å¼åŒ–è®°å¿†</span><br><span class="line">    if existing_memory and existing_memory.value:</span><br><span class="line">        memory_dict = existing_memory.value</span><br><span class="line">        formatted_memory = (</span><br><span class="line">            f&quot;å§“å: &#123;memory_dict.get(&#x27;user_name&#x27;, &#x27;æœªçŸ¥&#x27;)&#125;\n&quot;</span><br><span class="line">            f&quot;å…´è¶£: &#123;&#x27;, &#x27;.join(memory_dict.get(&#x27;interests&#x27;, []))&#125;&quot;</span><br><span class="line">        )</span><br><span class="line">    else:</span><br><span class="line">        formatted_memory = None</span><br><span class="line">        </span><br><span class="line">    # åœ¨æŒ‡ä»¤ä¸­æ ¼å¼åŒ–ç°æœ‰è®°å¿†</span><br><span class="line">    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=formatted_memory)</span><br><span class="line"></span><br><span class="line">    # è°ƒç”¨æ¨¡å‹ç”Ÿæˆç¬¦åˆæ¨¡å¼çš„ç»“æ„åŒ–è¾“å‡º</span><br><span class="line">    new_memory = model_with_structure.invoke([SystemMessage(content=system_msg)]+state[&#x27;messages&#x27;])</span><br><span class="line"></span><br><span class="line">    # è¦†ç›–ç°æœ‰çš„ç”¨æˆ·æ¡£æ¡ˆè®°å¿†</span><br><span class="line">    key = &quot;user_memory&quot;</span><br><span class="line">    store.put(namespace, key, new_memory)</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å›¾</span><br><span class="line">builder = StateGraph(MessagesState)</span><br><span class="line">builder.add_node(&quot;call_model&quot;, call_model)</span><br><span class="line">builder.add_node(&quot;write_memory&quot;, write_memory)</span><br><span class="line">builder.add_edge(START, &quot;call_model&quot;)</span><br><span class="line">builder.add_edge(&quot;call_model&quot;, &quot;write_memory&quot;)</span><br><span class="line">builder.add_edge(&quot;write_memory&quot;, END)</span><br><span class="line"></span><br><span class="line"># ç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿†çš„å­˜å‚¨</span><br><span class="line">across_thread_memory = InMemoryStore()</span><br><span class="line"></span><br><span class="line"># ç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†çš„æ£€æŸ¥ç‚¹</span><br><span class="line">within_thread_memory = MemorySaver()</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ£€æŸ¥ç‚¹å’Œå­˜å‚¨ç¼–è¯‘å›¾</span><br><span class="line">graph = builder.compile(checkpointer=within_thread_memory, store=across_thread_memory)</span><br><span class="line"></span><br><span class="line"># æ˜¾ç¤º</span><br><span class="line">display(Image(graph.get_graph(xray=1).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2025/07/22/%E5%AD%A6%E4%B9%A0/ai%E6%A1%86%E6%9E%B6/langgraph-agent%E4%B8%8B/image-20250726103516996.png" alt="image-20250726103516996">
<figcaption aria-hidden="true">image-20250726103516996</figcaption>
</figure>
<p>è°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># æˆ‘ä»¬æä¾›çº¿ç¨‹IDç”¨äºçŸ­æœŸï¼ˆçº¿ç¨‹å†…ï¼‰è®°å¿†</span><br><span class="line"># æˆ‘ä»¬æä¾›ç”¨æˆ·IDç”¨äºé•¿æœŸï¼ˆè·¨çº¿ç¨‹ï¼‰è®°å¿† </span><br><span class="line">config = &#123;&quot;configurable&quot;: &#123;&quot;thread_id&quot;: &quot;1&quot;, &quot;user_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line"># ç”¨æˆ·è¾“å…¥ </span><br><span class="line">input_messages = [HumanMessage(content=&quot;ä½ å¥½ï¼Œæˆ‘çš„åå­—æ˜¯Lanceï¼Œæˆ‘å–œæ¬¢åœ¨æ—§é‡‘å±±éª‘è‡ªè¡Œè½¦å’Œåœ¨é¢åŒ…åº—åƒé¥­ã€‚&quot;)]</span><br><span class="line"></span><br><span class="line"># è¿è¡Œå›¾</span><br><span class="line">for chunk in graph.stream(&#123;&quot;messages&quot;: input_messages&#125;, config, stream_mode=&quot;values&quot;):</span><br><span class="line">    chunk[&quot;messages&quot;][-1].pretty_print()</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è®°å¿†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Namespace for the memory to save</span><br><span class="line">user_id = &quot;1&quot;</span><br><span class="line">namespace = (&quot;memory&quot;, user_id)</span><br><span class="line">existing_memory = across_thread_memory.get(namespace, &quot;user_memory&quot;)</span><br><span class="line">existing_memory.value</span><br></pre></td></tr></table></figure>
<h5 id="trustcall-for-creating-and-updating-profile-schemas-trustcall-ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼"><strong>Trustcall
for creating and updating profile schemas</strong> <strong>Trustcall
ç”¨äºåˆ›å»ºå’Œæ›´æ–°é…ç½®æ–‡ä»¶æ¨¡å¼</strong></h5>
<p>Trustcall æ˜¯ä¸€ä¸ªç”± LangChain å›¢é˜Ÿå¼€å‘çš„å¼€æº Python
åº“ï¼Œæ—¨åœ¨<strong>è§£å†³å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœ¨ç”Ÿæˆæˆ–ä¿®æ”¹å¤æ‚ JSON
æ•°æ®ç»“æ„æ—¶æ•ˆç‡ä½ã€æ˜“å‡ºé”™çš„é—®é¢˜</strong>ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>create_extractor</code>ï¼Œä¼ å…¥æ¨¡å‹ä»¥åŠæˆ‘ä»¬çš„æ¨¡å¼ä½œä¸º <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/tools/">tool</a>ã€‚ä½¿ç”¨
TrustCall æ—¶ï¼Œå¯ä»¥ä»¥å¤šç§æ–¹å¼æä¾›æ¨¡å¼ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ª JSON å¯¹è±¡ / Python å­—å…¸æˆ– Pydantic
æ¨¡å‹ã€‚åœ¨åº•å±‚ï¼ŒTrustCall ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/tool_calling/">tool
calling</a> ä»è¾“å…¥çš„ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/messages/">messages</a>
åˆ—è¡¨ä¸­ç”Ÿæˆ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/">structured
output</a>ã€‚ä¸ºäº†å¼ºåˆ¶ Trustcall ç”Ÿæˆ <a target="_blank" rel="noopener" href="https://python.langchain.com/docs/concepts/structured_outputs/">structured
output</a>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>tool_choice</code> å‚æ•°ä¸­åŒ…å«æ¨¡å¼åç§°ã€‚</p>
<p>æˆ‘ä»…åšäº†è§£äº†ï¼Œæ„Ÿè§‰ç”¨å¤„ä¸å¤šï¼Œç”¨ç»“æœåŒ–è¾“å‡ºå°±èƒ½è¾¾åˆ°æ•ˆæœ</p>
<h4 id="chatbot-with-collection-schema-å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº"><strong>Chatbot
with Collection Schema</strong>
<strong>å¸¦é›†åˆæ¨¡å¼çš„èŠå¤©æœºå™¨äºº</strong></h4>
<p><strong>â€œcollectionâ€</strong>
æŒ‡çš„æ˜¯ä¸€ç§<strong>å°†è¯­ä¹‰è®°å¿†ç»„ç»‡ä¸ºå¤šä¸ªç‹¬ç«‹æ–‡æ¡£ï¼ˆobjectsï¼‰çš„å­˜å‚¨æ–¹å¼</strong>ï¼Œè€Œä¸æ˜¯æŠŠæ‰€æœ‰ä¿¡æ¯éƒ½å¡è¿›ä¸€ä¸ªå·¨å¤§çš„â€œç”¨æˆ·æ¡£æ¡ˆâ€ï¼ˆsingle
profileï¼‰é‡Œã€‚</p>
<p>å‡è®¾ä½ åœ¨åšä¸€ä¸ª AI åŠ©æ‰‹ï¼Œç”¨æˆ·è¯´ï¼š</p>
<blockquote>
<p>â€œæˆ‘ä¸‹å‘¨è¦å»ä¸œäº¬å‡ºå·®ï¼Œä½åœ¨æ¶©è°·åŒºçš„ Sakura Hotelã€‚â€ â€œæˆ‘æœ‹å‹ Ken
ä¹Ÿè¦æ¥ï¼Œä»–å–œæ¬¢åƒæ‹‰é¢ã€‚â€</p>
</blockquote>
<p>å¦‚æœç”¨ <strong>collection</strong>ï¼Œä½ ä¼šå­˜æˆä¸¤æ¡è®°å¿†ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trip&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tokyo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-08-04&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hotel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sakura Hotel, Shibuya&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;friend&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ken&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;food_preference&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ramen&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>æ¯æ¡è®°å¿†éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹æ–‡æ¡£ï¼Œåç»­ä½ å¯ä»¥ï¼š</p>
<ul>
<li>æœç´¢â€œtripâ€ç±»å‹çš„è®°å¿†ï¼Œæ‰¾åˆ°ç”¨æˆ·çš„å‡ºå·®å®‰æ’ï¼›</li>
<li>æœç´¢â€œfriendâ€ç±»å‹çš„è®°å¿†ï¼Œæ‰¾åˆ° Ken çš„åå¥½ï¼›</li>
<li>æ›´æ–° Ken
çš„ä¿¡æ¯æ—¶ï¼Œ<strong>åªæ”¹ä¸€æ¡è®°å½•</strong>ï¼Œä¸ä¼šå½±å“å…¶å®ƒè®°å¿†ã€‚</li>
</ul>
<h4 id="memory-agent-å†…å­˜ä»£ç†"><strong>Memory Agent</strong>
<strong>å†…å­˜ä»£ç†</strong></h4>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†æŠŠå­¦åˆ°çš„å†…å®¹æ•´åˆèµ·æ¥ï¼Œæ„å»ºä¸€ä¸ªå…·æœ‰é•¿æœŸè®°å¿†çš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/agentic_concepts/">agent</a>ã€‚</p>
<p>æˆ‘ä»¬çš„ä»£ç† <code>task_mAIstro</code> å°†å¸®åŠ©æˆ‘ä»¬ç®¡ç†å¾…åŠäº‹é¡¹åˆ—è¡¨ï¼</p>
<p>æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„èŠå¤©æœºå™¨äºº <strong>å§‹ç»ˆ</strong>
ä¼šåæ€å¯¹è¯å¹¶ä¿å­˜è®°å¿†ã€‚<code>task_mAIstro</code> å°†å†³å®š
<strong>ä½•æ—¶</strong> ä¿å­˜è®°å¿†ï¼ˆå¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­çš„é¡¹ç›®ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„èŠå¤©æœºå™¨äººå§‹ç»ˆä¿å­˜ä¸€ç§ç±»å‹çš„è®°å¿†ï¼Œå³ä¸ªäººèµ„æ–™æˆ–é›†åˆã€‚<code>task_mAIstro</code>
å¯ä»¥å†³å®šå°†æ•°æ®ä¿å­˜åˆ°ç”¨æˆ·ä¸ªäººèµ„æ–™æˆ– ToDo äº‹é¡¹é›†åˆä¸­ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>task_mAIstro</code>
è¿˜å°†ç®¡ç†ç¨‹åºæ€§è®°å¿†ã€‚è¿™å…è®¸ç”¨æˆ·æ›´æ–°åˆ›å»ºToDoé¡¹çš„åå¥½è®¾ç½®ã€‚</p>
<h5 id="creating-an-agent-åˆ›å»ºä¸€ä¸ªä»£ç†"><strong>Creating an
agent</strong> <strong>åˆ›å»ºä¸€ä¸ªä»£ç†</strong></h5>
<p>æœ‰è®¸å¤šä¸åŒçš„ <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/high_level/">agent</a>
æ¶æ„å¯ä¾›é€‰æ‹©ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„å†…å®¹ï¼Œä¸€ä¸ª <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/concepts/agentic_concepts/#react-implementation">ReAct</a>
ä»£ç†ã€‚è¿™ä¸ªä»£ç†å°†æˆä¸ºåˆ›å»ºå’Œç®¡ç†å¾…åŠäº‹é¡¹åˆ—è¡¨çš„å¾—åŠ›åŠ©æ‰‹ã€‚</p>
<p>æ­¤ä»£ç†å¯ä»¥å†³å®šæ›´æ–°ä¸‰ç§ç±»å‹çš„é•¿æœŸè®°å¿†ï¼š</p>
<ol type="a">
<li><p>åˆ›å»ºæˆ–æ›´æ–°å…·æœ‰æ™®é€šç”¨æˆ·ä¿¡æ¯çš„ç”¨æˆ· <code>profile</code></p></li>
<li><p>åœ¨ToDoåˆ—è¡¨ä¸­æ·»åŠ æˆ–æ›´æ–°é¡¹ç›® <code>collection</code></p></li>
<li><p>æ›´æ–°å…¶è‡ªèº«çš„ <code>instructions</code>
ä»¥äº†è§£å¦‚ä½•æ›´æ–°å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­çš„é¡¹ç›®</p></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from typing import TypedDict, Literal</span><br><span class="line"></span><br><span class="line"># æ›´æ–°è®°å¿†å·¥å…·</span><br><span class="line">class UpdateMemory(TypedDict):</span><br><span class="line">    &quot;&quot;&quot; å†³å®šæ›´æ–°å“ªç§è®°å¿†ç±»å‹ &quot;&quot;&quot;</span><br><span class="line">    update_type: Literal[&#x27;user&#x27;, &#x27;todo&#x27;, &#x27;instructions&#x27;]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>'user'</code>ï¼šç”¨æˆ·ç›¸å…³ä¿¡æ¯</li>
<li><code>'todo'</code>ï¼šå¾…åŠäº‹é¡¹</li>
<li><code>'instructions'</code>ï¼šæŒ‡ä»¤ä¿¡æ¯</li>
</ul>
</blockquote>
<h5 id="graph-definition-å›¾å®šä¹‰"><strong>Graph definition</strong>
<strong>å›¾å®šä¹‰</strong></h5>
<p>æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªç®€å•çš„è·¯ç”±å™¨
<code>route_message</code>ï¼Œå®ƒé€šè¿‡äºŒå…ƒå†³ç­–æ¥èŠ‚çœå†…å­˜ã€‚</p>
<h3 id="module-6">module-6</h3>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">å¼ ç†™æµš</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="æœ¬ç«™è®¿é—®æ•° fa fa-user æ¬¡"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="æœ¬ç«™æ€»è®¿é—®é‡ fa fa-eye æ¬¡"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="400" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
